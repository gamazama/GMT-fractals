var ti=Object.defineProperty;var ai=(a,t,o)=>t in a?ti(a,t,{enumerable:!0,configurable:!0,writable:!0,value:o}):a[t]=o;var Z=(a,t,o)=>ai(a,typeof t!="symbol"?t+"":t,o);import{j as e,r as v,R as At,u as _t,a as Bt,c as oi,C as ri}from"./three-fiber-CFaGaXMo.js";import{a as Pr,r as wt,O as ni,H as ua,b as ii}from"./three-drei-BaAI2j4V.js";import{c as Se,k as We,d as ie,Q as Be,l as Ze,E as qe,m as ft,H as Mo,F as Wt,f as at,n as Ue,o as ct,p as Nt,S as bt,q as jt,r as Tt,O as Pt,s as $e,t as Rr,u as zr,v as st,w as qt,x as io,y as Ft,G as Jt,z as Co,I as ko,P as Fr,i as si,R as Ea,J as jo,U as so,g as To,M as La,j as Ir,K as li,X as ci,Y as Po,Z as di,_ as ui}from"./three-CN57-urJ.js";import{S as Ro,B as zo,W as fi,M as pi,O as hi,E as mi,a as gi,c as xi}from"./mediabunny-C3QPZaT0.js";import{p as Fo}from"./pako-DwGzBETv.js";import{H as Ht,P as Ut,R as yi,u as bi,a as vi,b as wi,c as Si,d as Mi,B as Ci,C as ki,M as ji}from"./reactflow-CXVFXFYF.js";(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))r(n);new MutationObserver(n=>{for(const i of n)if(i.type==="childList")for(const s of i.addedNodes)s.tagName==="LINK"&&s.rel==="modulepreload"&&r(s)}).observe(document,{childList:!0,subtree:!0});function o(n){const i={};return n.integrity&&(i.integrity=n.integrity),n.referrerPolicy&&(i.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?i.credentials="include":n.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function r(n){if(n.ep)return;n.ep=!0;const i=o(n);fetch(n.href,i)}})();const Ti=a=>(t,o,r)=>{const n=r.subscribe;return r.subscribe=(s,l,d)=>{let c=s;if(l){const f=(d==null?void 0:d.equalityFn)||Object.is;let u=s(r.getState());c=p=>{const h=s(p);if(!f(u,h)){const g=u;l(u=h,g)}},d!=null&&d.fireImmediately&&l(u,u)}return n(c)},a(t,o,r)},Er=Ti,Fe={UNIFORM:"uniform",CONFIG:"config",GRADIENT:"gradient",RESET_ACCUM:"reset_accum",OFFSET_SHIFT:"offset_shift",OFFSET_SET:"offset_set",CAMERA_ABSORB:"camera_absorb",CAMERA_SNAP:"camera_snap",CAMERA_TELEPORT:"camera_teleport",SHADER_CODE:"shader_code",IS_COMPILING:"is_compiling",COMPILE_TIME:"compile_time",BUCKET_STATUS:"bucket_status",TRACK_FOCUS:"track_focus"};class Pi{constructor(){Z(this,"listeners",{})}on(t,o){return this.listeners[t]||(this.listeners[t]=[]),this.listeners[t].push(o),()=>this.off(t,o)}off(t,o){this.listeners[t]&&(this.listeners[t]=this.listeners[t].filter(r=>r!==o))}emit(t,o){this.listeners[t]&&this.listeners[t].forEach(r=>r(o))}}const le=new Pi,ce={Time:"uTime",FrameCount:"uFrameCount",Resolution:"uResolution",SceneOffsetHigh:"uSceneOffsetHigh",SceneOffsetLow:"uSceneOffsetLow",CameraPosition:"uCameraPosition",CamBasisX:"uCamBasisX",CamBasisY:"uCamBasisY",CamForward:"uCamForward",CamType:"uCamType",RegionMin:"uRegionMin",RegionMax:"uRegionMax",LightCount:"uLightCount",LightType:"uLightType",LightPos:"uLightPos",LightDir:"uLightDir",LightColor:"uLightColor",LightIntensity:"uLightIntensity",LightShadows:"uLightShadows",LightFalloff:"uLightFalloff",LightFalloffType:"uLightFalloffType",HistoryTexture:"uHistoryTexture",BlendFactor:"uBlendFactor",ExtraSeed:"uExtraSeed",Jitter:"uJitter",BlueNoiseTexture:"uBlueNoiseTexture",BlueNoiseResolution:"uBlueNoiseResolution",ModularParams:"uModularParams",EnvMapTexture:"uEnvMapTexture",EnvRotationMatrix:"uEnvRotationMatrix",HistogramLayer:"uHistogramLayer",PreRotMatrix:"uPreRotMatrix",InternalScale:"uInternalScale"},Io=a=>{if(typeof window>"u")return!1;const t=new URLSearchParams(window.location.search);return t.has(a)&&t.get(a)!=="false"&&t.get(a)!=="0"},Ri={Formula:{id:"Formula",location:"right",order:0,isCore:!0,isOpen:!0},Graph:{id:"Graph",location:"right",order:1,isCore:!0,isOpen:!1},Scene:{id:"Scene",location:"right",order:2,isCore:!0,isOpen:!1},Shader:{id:"Shader",location:"right",order:3,isCore:!0,isOpen:!1},Gradient:{id:"Gradient",location:"right",order:4,isCore:!0,isOpen:!1},Quality:{id:"Quality",location:"right",order:5,isCore:!0,isOpen:!1},Light:{id:"Light",location:"right",order:6,isCore:!1,isOpen:!1},Audio:{id:"Audio",location:"right",order:7,isCore:!1,isOpen:!1},Drawing:{id:"Drawing",location:"right",order:8,isCore:!1,isOpen:!1},Sonification:{id:"Sonification",location:"right",order:9,isCore:!1,isOpen:!1}},zi=(a,t)=>({showLightGizmo:!0,isGizmoDragging:!1,interactionMode:"none",histogramData:null,histogramAutoUpdate:!0,histogramTrigger:0,histogramLayer:0,histogramActiveCount:0,sceneHistogramData:null,sceneHistogramTrigger:0,sceneHistogramActiveCount:0,draggedLightIndex:null,autoCompile:!1,isUserInteracting:!1,advancedMode:!1,showHints:!0,debugMobileLayout:!1,invertY:!1,resolutionMode:"Full",fixedResolution:[800,600],isBroadcastMode:Io("clean")||Io("broadcast"),lockSceneOnSwitch:!1,exportIncludeScene:!1,isTimelineHovered:!1,tabSwitchCount:0,helpWindow:{visible:!1,activeTopicId:null},contextMenu:{visible:!1,x:0,y:0,items:[],targetHelpIds:[]},compositionOverlay:"none",compositionOverlaySettings:{opacity:.5,lineThickness:1,showCenterMark:!1,showSafeAreas:!1,color:"#FFFFFF",gridDivisionsX:4,gridDivisionsY:4,spiralRotation:0,spiralPositionX:.5,spiralPositionY:.5,spiralScale:1,spiralRatio:1.618033988749895},panels:Ri,leftDockSize:320,rightDockSize:360,isLeftDockCollapsed:!0,isRightDockCollapsed:!1,draggingPanelId:null,dragSnapshot:null,activeLeftTab:null,activeRightTab:"Formula",setShowLightGizmo:o=>a({showLightGizmo:o}),setGizmoDragging:o=>a({isGizmoDragging:o}),setInteractionMode:o=>a({interactionMode:o}),setHistogramData:o=>a({histogramData:o}),setHistogramAutoUpdate:o=>a({histogramAutoUpdate:o}),refreshHistogram:()=>a(o=>({histogramTrigger:o.histogramTrigger+1})),registerHistogram:()=>a(o=>({histogramActiveCount:o.histogramActiveCount+1})),unregisterHistogram:()=>a(o=>({histogramActiveCount:Math.max(0,o.histogramActiveCount-1)})),setHistogramLayer:o=>{t().histogramLayer!==o&&(a({histogramLayer:o}),le.emit("uniform",{key:ce.HistogramLayer,value:o}),a(r=>({histogramTrigger:r.histogramTrigger+1})))},setSceneHistogramData:o=>a({sceneHistogramData:o}),refreshSceneHistogram:()=>a(o=>({sceneHistogramTrigger:o.sceneHistogramTrigger+1})),registerSceneHistogram:()=>a(o=>({sceneHistogramActiveCount:o.sceneHistogramActiveCount+1})),unregisterSceneHistogram:()=>a(o=>({sceneHistogramActiveCount:Math.max(0,o.sceneHistogramActiveCount-1)})),setDraggedLight:o=>a({draggedLightIndex:o}),setAutoCompile:o=>a({autoCompile:o}),setAdvancedMode:o=>a({advancedMode:o}),setShowHints:o=>a({showHints:o}),setDebugMobileLayout:o=>a({debugMobileLayout:o}),setInvertY:o=>a({invertY:o}),setResolutionMode:o=>{a({resolutionMode:o}),le.emit("reset_accum",void 0)},setFixedResolution:(o,r)=>{a({fixedResolution:[o,r]}),le.emit("reset_accum",void 0)},setLockSceneOnSwitch:o=>a({lockSceneOnSwitch:o}),setExportIncludeScene:o=>a({exportIncludeScene:o}),setIsTimelineHovered:o=>a({isTimelineHovered:o}),incrementTabSwitchCount:()=>a(o=>({tabSwitchCount:o.tabSwitchCount+1})),setIsBroadcastMode:o=>a({isBroadcastMode:o}),openHelp:o=>a(r=>({helpWindow:{visible:!0,activeTopicId:o||r.helpWindow.activeTopicId},contextMenu:{...r.contextMenu,visible:!1}})),closeHelp:()=>a({helpWindow:{visible:!1,activeTopicId:null}}),openContextMenu:(o,r,n,i)=>a({contextMenu:{visible:!0,x:o,y:r,items:n,targetHelpIds:i||[]}}),closeContextMenu:()=>a(o=>({contextMenu:{...o.contextMenu,visible:!1}})),movePanel:(o,r,n)=>a(i=>{var g,M;const s={...i.panels};s[o]||(s[o]={id:o,location:r,order:0,isCore:!1,isOpen:!0});const l=!0;let d=n;d===void 0&&(d=Object.values(s).filter(y=>y.location===r).length),(r==="left"||r==="right")&&Object.values(s).forEach(m=>{m.location===r&&m.id!==o&&(m.isOpen=!1)});let c=s[o].floatPos;r==="float"&&!c&&(c={x:window.innerWidth/2-150,y:window.innerHeight/2-200}),s[o]={...s[o],location:r,order:d,isOpen:l,floatPos:c};const f=r==="left"?o:((g=Object.values(s).find(m=>m.location==="left"&&m.isOpen))==null?void 0:g.id)||null,u=r==="right"?o:((M=Object.values(s).find(m=>m.location==="right"&&m.isOpen))==null?void 0:M.id)||null,p=r==="left"?!1:i.isLeftDockCollapsed,h=r==="right"?!1:i.isRightDockCollapsed;return{panels:s,activeLeftTab:f,activeRightTab:u,isLeftDockCollapsed:p,isRightDockCollapsed:h}}),reorderPanel:(o,r)=>a(n=>{const i={...n.panels},s=i[o],l=i[r];if(!s||!l)return{};s.location!==l.location&&(s.location=l.location,s.isOpen=!1);const d=l.location,c=Object.values(i).filter(h=>h.location===d).sort((h,g)=>h.order-g.order),f=c.findIndex(h=>h.id===o),u=c.findIndex(h=>h.id===r);if(f===-1||u===-1)return{};const[p]=c.splice(f,1);return c.splice(u,0,p),c.forEach((h,g)=>{i[h.id]={...i[h.id],order:g}}),{panels:i}}),togglePanel:(o,r)=>a(n=>{var f,u;const i={...n.panels};if(!i[o])return{};const s=i[o],l=r!==void 0?r:!s.isOpen;if(s.location==="float")s.isOpen=l;else if(l){if(Object.values(i).forEach(p=>{p.location===s.location&&p.id!==o&&(p.isOpen=!1)}),s.isOpen=!0,s.location==="left")return{panels:i,activeLeftTab:o,isLeftDockCollapsed:!1};if(s.location==="right")return{panels:i,activeRightTab:o,isRightDockCollapsed:!1}}else s.isOpen=!1;const d=((f=Object.values(i).find(p=>p.location==="left"&&p.isOpen))==null?void 0:f.id)||null,c=((u=Object.values(i).find(p=>p.location==="right"&&p.isOpen))==null?void 0:u.id)||null;return{panels:i,activeLeftTab:d,activeRightTab:c}}),setDockSize:(o,r)=>a({[o==="left"?"leftDockSize":"rightDockSize"]:r}),setDockCollapsed:(o,r)=>a({[o==="left"?"isLeftDockCollapsed":"isRightDockCollapsed"]:r}),setFloatPosition:(o,r,n)=>a(i=>({panels:{...i.panels,[o]:{...i.panels[o],floatPos:{x:r,y:n}}}})),setFloatSize:(o,r,n)=>a(i=>({panels:{...i.panels,[o]:{...i.panels[o],floatSize:{width:r,height:n}}}})),startPanelDrag:o=>a(r=>({draggingPanelId:o,dragSnapshot:JSON.parse(JSON.stringify(r.panels))})),endPanelDrag:()=>a({draggingPanelId:null,dragSnapshot:null}),cancelPanelDrag:()=>a(o=>o.dragSnapshot?{panels:o.dragSnapshot,draggingPanelId:null,dragSnapshot:null}:{draggingPanelId:null}),setActiveTab:o=>t().togglePanel(o,!0),floatTab:o=>t().movePanel(o,"float"),dockTab:o=>t().movePanel(o,"right"),setCompositionOverlay:o=>a({compositionOverlay:o}),setCompositionOverlaySettings:o=>a(r=>({compositionOverlaySettings:{...r.compositionOverlaySettings,...o}}))}),Fi=()=>typeof window>"u"?!1:window.matchMedia&&window.matchMedia("(pointer: coarse)").matches||window.innerWidth<768,Ii=(a,t)=>({dpr:Fi()?1:Math.min(typeof window<"u"&&window.devicePixelRatio||1,2),aaLevel:1,msaaSamples:1,aaMode:"Always",accumulation:!0,previewMode:!1,renderMode:"Direct",isPaused:!1,sampleCap:256,isExporting:!1,renderRegion:null,isBucketRendering:!1,bucketSize:128,bucketUpscale:1,convergenceThreshold:.1,samplesPerBucket:64,setDpr:o=>{a({dpr:o}),le.emit("reset_accum",void 0)},setAALevel:o=>{a({aaLevel:o});const{aaMode:r}=t();(r==="Always"||r==="Auto")&&a({dpr:o}),le.emit("reset_accum",void 0)},setMSAASamples:o=>{a({msaaSamples:o});const{aaMode:r}=t();r==="Always"||r==="Auto"?le.emit("config",{msaaSamples:o}):le.emit("config",{msaaSamples:1}),le.emit("reset_accum",void 0)},setAAMode:o=>{a({aaMode:o});const{aaLevel:r,msaaSamples:n}=t();o==="Off"?(a({dpr:1}),le.emit("config",{msaaSamples:1})):(a({dpr:r}),le.emit("config",{msaaSamples:n})),le.emit("reset_accum",void 0)},setAccumulation:o=>{a({accumulation:o}),le.emit("reset_accum",void 0)},setPreviewMode:o=>{a({previewMode:o}),le.emit("config",{previewMode:o})},setRenderMode:o=>{a({renderMode:o});const r=o==="PathTracing"?1:0,n=t().setLighting;n&&n({renderMode:r})},setIsPaused:o=>a({isPaused:o}),setSampleCap:o=>a({sampleCap:o}),setRenderRegion:o=>{a({renderRegion:o});const r=o?new Se(o.minX,o.minY):new Se(0,0),n=o?new Se(o.maxX,o.maxY):new Se(1,1);le.emit("uniform",{key:ce.RegionMin,value:r}),le.emit("uniform",{key:ce.RegionMax,value:n}),le.emit("reset_accum",void 0)},setIsBucketRendering:o=>{a({isBucketRendering:o})},setBucketSize:o=>a({bucketSize:o}),setBucketUpscale:o=>a({bucketUpscale:o}),setConvergenceThreshold:o=>a({convergenceThreshold:o}),setSamplesPerBucket:o=>a({samplesPerBucket:o}),setIsExporting:o=>a({isExporting:o})});class Ae{constructor(t={x:0,y:0,z:0,xL:0,yL:0,zL:0}){Z(this,"offset");Z(this,"_rotMatrix",new We);Z(this,"_camRight",new ie);Z(this,"_camUp",new ie);Z(this,"_camForward",new ie);Z(this,"_visualVector",new ie);Z(this,"_quatInverse",new Be);Z(this,"_relativePos",new ie);Z(this,"smoothedPos",new ie);Z(this,"smoothedQuat",new Be);Z(this,"smoothedFov",60);Z(this,"prevOffsetState");Z(this,"isLocked",!1);Z(this,"isFirstFrame",!0);this.offset={...t},this.prevOffsetState={...t}}get state(){return{...this.offset}}set state(t){this.offset={...t},Ae.normalize(this.offset)}static split(t){const o=Math.fround(t),r=t-o;return{high:o,low:r}}static normalize(t){if(Math.abs(t.xL)>.5){const r=Math.floor(t.xL+.5);t.x+=r,t.xL-=r}if(Math.abs(t.yL)>.5){const r=Math.floor(t.yL+.5);t.y+=r,t.yL-=r}if(Math.abs(t.zL)>.5){const r=Math.floor(t.zL+.5);t.z+=r,t.zL-=r}}setFromUnified(t,o,r){const n=Ae.split(t),i=Ae.split(o),s=Ae.split(r);this.offset.x=n.high,this.offset.xL=n.low,this.offset.y=i.high,this.offset.yL=i.low,this.offset.z=s.high,this.offset.zL=s.low,Ae.normalize(this.offset)}move(t,o,r){this.offset.xL+=t,this.offset.yL+=o,this.offset.zL+=r,Ae.normalize(this.offset)}absorbCamera(t){this.offset.xL+=t.x,this.offset.yL+=t.y,this.offset.zL+=t.z,Ae.normalize(this.offset)}resetSmoothing(){this.isFirstFrame=!0,this.prevOffsetState={...this.offset},this.isLocked=!1}updateSmoothing(t,o,r,n,i,s){if(!s&&!i&&!this.isFirstFrame){this.smoothedPos.copy(t.position),this.smoothedQuat.copy(t.quaternion),this.smoothedFov=o,this.prevOffsetState={...this.offset},this.isLocked=!0;return}if(this.isFirstFrame||i){this.smoothedPos.copy(t.position),this.smoothedQuat.copy(t.quaternion),this.smoothedFov=o,this.prevOffsetState={...this.offset},this.isFirstFrame=!1,this.isLocked=!1;return}const l=this.offset,d=this.prevOffsetState;if(d.x!==l.x||d.y!==l.y||d.z!==l.z||d.xL!==l.xL||d.yL!==l.yL||d.zL!==l.zL){const c=d.x-l.x+(d.xL-l.xL),f=d.y-l.y+(d.yL-l.yL),u=d.z-l.z+(d.zL-l.zL);if(Math.abs(c)>10||Math.abs(f)>10||Math.abs(u)>10){this.resetSmoothing(),this.smoothedPos.copy(t.position),this.smoothedQuat.copy(t.quaternion);return}this.smoothedPos.x+=c,this.smoothedPos.y+=f,this.smoothedPos.z+=u,this.prevOffsetState={...l}}if(n)this.smoothedPos.copy(t.position),this.smoothedQuat.copy(t.quaternion),this.smoothedFov=o,this.prevOffsetState={...this.offset};else{const c=this.smoothedPos.distanceToSquared(t.position),f=this.smoothedQuat.angleTo(t.quaternion);if(this.isLocked?(c>1e-18||f>1e-9)&&(this.isLocked=!1):c<1e-21&&f<1e-11&&(this.isLocked=!0),this.isLocked)this.smoothedPos.copy(t.position),this.smoothedQuat.copy(t.quaternion),this.smoothedFov=o;else{const u=1-Math.exp(-40*r);this.smoothedPos.lerp(t.position,u),this.smoothedQuat.slerp(t.quaternion,u),this.smoothedFov+=(o-this.smoothedFov)*u}}}getUnifiedCameraState(t,o){const r={...this.offset};return r.xL+=t.position.x,r.yL+=t.position.y,r.zL+=t.position.z,Ae.normalize(r),{position:{x:0,y:0,z:0},rotation:{x:t.quaternion.x,y:t.quaternion.y,z:t.quaternion.z,w:t.quaternion.w},sceneOffset:r,targetDistance:o>0?o:3.5}}applyCameraState(t,o){if(o.sceneOffset){const c={...o.sceneOffset};c.xL+=o.position.x,c.yL+=o.position.y,c.zL+=o.position.z,this.state=c}const r=o.rotation,n=r.x??r._x??0,i=r.y??r._y??0,s=r.z??r._z??0,l=r.w??r._w??1;t.position.set(0,0,0),t.quaternion.set(n,i,s,l).normalize();const d=new ie(0,1,0).applyQuaternion(t.quaternion);t.up.copy(d),t.updateMatrixWorld(),this.resetSmoothing(),this.smoothedPos.set(0,0,0),this.smoothedQuat.copy(t.quaternion)}updateShaderUniforms(t,o,r){const n=this.offset.x+this.offset.xL+t.x,i=this.offset.y+this.offset.yL+t.y,s=this.offset.z+this.offset.zL+t.z,l=Math.fround(n),d=Math.fround(i),c=Math.fround(s);o.set(l,d,c),r.set(n-l,i-d,s-c)}updateCameraBasis(t,o,r){const n=t;this._rotMatrix.makeRotationFromQuaternion(n.quaternion);const i=this._rotMatrix.elements;this._camRight.set(i[0],i[1],i[2]),this._camUp.set(i[4],i[5],i[6]),this._camForward.set(-i[8],-i[9],-i[10]);let s=1,l=1;r&&r.isOrtho?(l=r.orthoScale/2,s=l*n.aspect):(l=Math.tan(Ze.degToRad(n.fov)*.5),s=l*n.aspect),o[ce.CamBasisX].value.copy(this._camRight).multiplyScalar(s),o[ce.CamBasisY].value.copy(this._camUp).multiplyScalar(l),o[ce.CamForward].value.copy(this._camForward),o[ce.CameraPosition].value.set(0,0,0)}getLightShaderVector(t,o,r,n){const i=this.offset;o?(this._relativePos.set(t.x,t.y,t.z).applyQuaternion(r.quaternion),n.copy(this._relativePos)):n.set(t.x-(i.x+i.xL)-r.position.x,t.y-(i.y+i.yL)-r.position.y,t.z-(i.z+i.zL)-r.position.z)}resolveRealWorldPosition(t,o,r){const n=this.offset;return o?(this._visualVector.set(t.x,t.y,t.z).applyQuaternion(r.quaternion),{x:r.position.x+this._visualVector.x+(n.x+n.xL),y:r.position.y+this._visualVector.y+(n.y+n.yL),z:r.position.z+this._visualVector.z+(n.z+n.zL)}):(this._visualVector.set(t.x-(n.x+n.xL)-r.position.x,t.y-(n.y+n.yL)-r.position.y,t.z-(n.z+n.zL)-r.position.z),this._quatInverse.copy(r.quaternion).invert(),this._visualVector.applyQuaternion(this._quatInverse),{x:this._visualVector.x,y:this._visualVector.y,z:this._visualVector.z})}resolveRealWorldRotation(t,o,r){const n=new ie(0,0,-1).applyEuler(new qe(t.x,t.y,t.z,"YXZ"));o?n.applyQuaternion(r.quaternion):n.applyQuaternion(r.quaternion.clone().invert());const i=new Be().setFromUnitVectors(new ie(0,0,-1),n),s=new qe().setFromQuaternion(i,"YXZ");return{x:s.x,y:s.y,z:s.z}}}const ea=`
precision highp float;
out vec2 vUv;
void main() {
  vUv = position.xy * 0.5 + 0.5; // Map -1..1 to 0..1
  gl_Position = vec4(position, 1.0);
}
`,Ei=`
precision mediump float;
varying vec2 vUv;
uniform sampler2D tA;
uniform sampler2D tB;
uniform vec2 uBoundsMin;
uniform vec2 uBoundsMax;

void main() {
    // Remap UV to the specific region we are measuring
    vec2 uv = mix(uBoundsMin, uBoundsMax, vUv);
    
    vec3 a = texture2D(tA, uv).rgb;
    vec3 b = texture2D(tB, uv).rgb;
    
    // Calculate max component difference (L-inf norm) for brightness change
    vec3 diff = abs(a - b);
    float maxDiff = max(diff.r, max(diff.g, diff.b));
    
    gl_FragColor = vec4(maxDiff, 0.0, 0.0, 1.0);
}
`;class Ni{constructor(){Z(this,"mrtTargetA",null);Z(this,"mrtTargetB",null);Z(this,"writeIndex",0);Z(this,"frameCount",0);Z(this,"accumulationCount",0);Z(this,"sampleCap",0);Z(this,"lastCompleteDuration",0);Z(this,"startTime",0);Z(this,"convergenceTarget",null);Z(this,"convergenceMaterial",null);Z(this,"convergenceBuffer",null);Z(this,"convergenceScene",null);Z(this,"convergenceCamera",null);Z(this,"isHolding",!1);Z(this,"_qualityState",null);Z(this,"_accumulationEnabled",!0);Z(this,"_halfFloatBuffer",null)}updateQuality(t){var n;const o=(n=this._qualityState)==null?void 0:n.bufferPrecision,r=t.bufferPrecision;this._qualityState=t,this.mrtTargetA&&o!==r&&this.resize(this.mrtTargetA.width,this.mrtTargetA.height)}setAccumulationEnabled(t){this._accumulationEnabled=t,t||this.resetAccumulation()}getPreviousColorTexture(){const t=this.writeIndex===0?this.mrtTargetB:this.mrtTargetA;return(t==null?void 0:t.texture)||null}getPreviousRenderTarget(){return this.writeIndex===0?this.mrtTargetB:this.mrtTargetA}halfToFloat(t){const o=(t&32768)>>15,r=(t&31744)>>10,n=t&1023;if(r===0){if(n===0)return o?-0:0;const i=Math.clz32(n)-21;return(o?-1:1)*(n<<i)*Math.pow(2,-24)}return r===31?n?NaN:o?-1/0:1/0:(o?-1:1)*Math.pow(2,r-15)*(1+n/1024)}readPixels(t,o,r,n,i,s){var c;if(!this.mrtTargetA||!this.mrtTargetB)return!1;const l=this.getPreviousRenderTarget();if(!l)return!1;s.fill(0);const d=(((c=this._qualityState)==null?void 0:c.bufferPrecision)??0)>.5;try{if(d){const f=n*i;(!this._halfFloatBuffer||this._halfFloatBuffer.length!==f*4)&&(this._halfFloatBuffer=new Uint16Array(f*4)),t.readRenderTargetPixels(l,o,r,n,i,this._halfFloatBuffer);for(let u=0;u<f*4;u++)s[u]=this.halfToFloat(this._halfFloatBuffer[u])}else t.readRenderTargetPixels(l,o,r,n,i,s);return!0}catch(f){return console.warn("Pixel readback failed:",f),!1}}initTargets(t,o){var s;const n=(((s=this._qualityState)==null?void 0:s.bufferPrecision)??0)>.5?Mo:Wt,i={minFilter:Ue,magFilter:Ue,stencilBuffer:!1,depthBuffer:!1,generateMipmaps:!1,format:at,type:n};this.mrtTargetA=new ft(t,o,i),this.mrtTargetB=new ft(t,o,i),this.initConvergenceTools(n),this.resetAccumulation()}initConvergenceTools(t){if(!this.convergenceTarget){this.convergenceTarget=new ft(64,64,{minFilter:ct,magFilter:ct,format:at,type:t,depthBuffer:!1,stencilBuffer:!1,generateMipmaps:!1}),this.convergenceBuffer=new Float32Array(64*64*4),this.convergenceMaterial=new Nt({vertexShader:ea,fragmentShader:Ei,uniforms:{tA:{value:null},tB:{value:null},uBoundsMin:{value:new Se(0,0)},uBoundsMax:{value:new Se(1,1)}},depthTest:!1,depthWrite:!1}),this.convergenceScene=new bt;const o=new jt(new Tt(2,2),this.convergenceMaterial);o.frustumCulled=!1,this.convergenceScene.add(o),this.convergenceCamera=new Pt(-1,1,1,-1,0,1)}this.resetAccumulation()}resize(t,o){var s,l,d;const r=(((s=this._qualityState)==null?void 0:s.bufferPrecision)??0)>.5,n=(l=this.mrtTargetA)==null?void 0:l.texture.type,i=r?Mo:Wt;(!this.mrtTargetA||this.mrtTargetA.width!==t||this.mrtTargetA.height!==o||n!==i)&&(this.mrtTargetA&&(this.mrtTargetA.dispose(),(d=this.mrtTargetB)==null||d.dispose()),this.initTargets(t,o))}setSampleCap(t){this.sampleCap=t,t>0&&this.accumulationCount>t&&this.resetAccumulation()}resetAccumulation(){this.accumulationCount=0,this.lastCompleteDuration=0,this.isHolding=!1}clearTargets(){if(!B.renderer)return;const t=B.renderer.getRenderTarget();this.mrtTargetA&&(B.renderer.setRenderTarget(this.mrtTargetA),B.renderer.clear()),this.mrtTargetB&&(B.renderer.setRenderTarget(this.mrtTargetB),B.renderer.clear()),B.renderer.setRenderTarget(t)}setHold(t){this.isHolding=t}getCurrentFrameDuration(){return this.accumulationCount===0?0:this.sampleCap>0&&this.accumulationCount>=this.sampleCap&&this.lastCompleteDuration>0?this.lastCompleteDuration:performance.now()-this.startTime}getOutputTexture(){if(!this.mrtTargetA)return null;const t=this.writeIndex===0?this.mrtTargetB:this.mrtTargetA;return(t==null?void 0:t.texture)||null}measureConvergence(t,o=new Se(0,0),r=new Se(1,1)){if(!this.mrtTargetA||!this.mrtTargetB||!this.convergenceTarget||!this.convergenceMaterial||!this.convergenceScene||!this.convergenceCamera||!this.convergenceBuffer||this.accumulationCount<=1)return 1;this.convergenceMaterial.uniforms.tA.value=this.mrtTargetA.texture,this.convergenceMaterial.uniforms.tB.value=this.mrtTargetB.texture,this.convergenceMaterial.uniforms.uBoundsMin.value.copy(o),this.convergenceMaterial.uniforms.uBoundsMax.value.copy(r);const n=t.getRenderTarget();t.setRenderTarget(this.convergenceTarget),t.render(this.convergenceScene,this.convergenceCamera),t.readRenderTargetPixels(this.convergenceTarget,0,0,64,64,this.convergenceBuffer),t.setRenderTarget(n);let i=0;for(let s=0;s<this.convergenceBuffer.length;s+=4){const l=this.convergenceBuffer[s];l>i&&(i=l)}return i}render(t){if(!this.mrtTargetA||!this.mrtTargetB||this.isHolding||this.sampleCap>0&&this.accumulationCount>=this.sampleCap)return;this.accumulationCount===0&&(this.startTime=performance.now()),this._accumulationEnabled?this.accumulationCount===0?this.accumulationCount=1:this.accumulationCount++:this.accumulationCount=1;const r=1/this.accumulationCount,n=this.writeIndex===0?this.mrtTargetA:this.mrtTargetB,i=this.writeIndex===0?this.mrtTargetB:this.mrtTargetA;B.mainUniforms[ce.BlendFactor].value=r,B.mainUniforms[ce.HistoryTexture].value=i.texture,B.mainUniforms[ce.ExtraSeed].value=Math.random()*100;const s=t.getRenderTarget();t.setRenderTarget(n),t.render(B.mainScene,B.mainCamera),t.setRenderTarget(s),this.writeIndex=1-this.writeIndex,this.frameCount++,this.sampleCap>0&&this.accumulationCount===this.sampleCap&&(this.lastCompleteDuration=performance.now()-this.startTime)}}class Di{constructor(){Z(this,"features",new Map)}register(t){this.features.set(t.id,t)}get(t){return this.features.get(t)}getAll(){return Array.from(this.features.values())}getTabs(){return Array.from(this.features.values()).filter(t=>t.tabConfig).map(t=>({id:t.id,...t.tabConfig})).sort((t,o)=>t.order-o.order)}getViewportOverlays(){return Array.from(this.features.values()).filter(t=>t.viewportConfig).map(t=>({id:t.id,...t.viewportConfig}))}getMenuFeatures(){return Array.from(this.features.values()).filter(t=>t.menuConfig).map(t=>({id:t.id,...t.menuConfig}))}getExtraMenuItems(){const t=[];return this.features.forEach(o=>{o.menuItems&&o.menuItems.forEach(r=>t.push({...r,featureId:o.id}))}),t}getEngineFeatures(){return Array.from(this.features.values()).filter(t=>!!t.engineConfig)}getDictionary(){const t={formula:"f",cameraPos:"cp",cameraRot:"cr",sceneOffset:"so",targetDistance:"td",animations:"an",sequence:"sq",features:{_alias:"p",children:{}}};return this.features.forEach(o=>{const r=o.shortId||o.id,n={};Object.entries(o.params).forEach(([i,s])=>{s.shortId&&(n[i]=s.shortId)}),t.features.children[o.id]={_alias:r,children:n}}),t}getUniformDefinitions(){const t=[];return this.features.forEach(o=>{Object.values(o.params).forEach(r=>{if(r.uniform){let n=r.type,i=r.default;n==="color"&&(n="vec3"),n==="boolean"&&(n="float",i=i?1:0),(n==="image"||n==="gradient")&&(n="sampler2D",i=null),t.push({name:r.uniform,type:n,default:i})}}),o.extraUniforms&&t.push(...o.extraUniforms)}),t}}const ve=new Di,Li=`
    if (uGlowIntensity > 0.0001) {
        float sharpness = max(1.0, uGlowSharpness);
        // Boost factor for visibility.
        float gFactor = exp(-sharpness * max(h.x, 0.0)) * uFudgeFactor * 0.4;
        
        #ifdef GLOW_FAST
            // Fast Mode: Accumulate scalar intensity only
            accAlpha += gFactor;
        #else
            // Quality Mode: Accumulate full vector color
            if (gFactor > 1.0e-6) {
                vec3 p_fractal_glow = applyPrecisionOffset(p + uCameraPosition, uSceneOffsetLow, uSceneOffsetHigh);
                accColor += getGlowColor(p_fractal_glow, h) * gFactor;
            }
        #endif
    }

    // Volumetric Fog
    if (uFogDensity > 0.0001) {
        float stepVal = max(h.x, 0.0001);
        // Corrected density factor: Reduced from 0.05 to 0.0005 (100x reduction)
        accDensity += (1.0 / (stepVal * 5.0 + 0.1)) * uFogDensity * uFudgeFactor * 0.0005;
    }
`,Ai=`
    #ifdef GLOW_FAST
        if (accAlpha > 0.0001) {
            vec3 p_fractal_res = applyPrecisionOffset(p + uCameraPosition, uSceneOffsetLow, uSceneOffsetHigh);
            // Tint the accumulated intensity by the color at the hit point
            vec3 glowCol = getGlowColor(p_fractal_res, h);
            
            // Prevent blowout
            accColor += glowCol * min(accAlpha, 100.0);
            
            // Clear alpha
            accAlpha = 0.0;
        }
    #endif
`,_i={id:"atmosphere",shortId:"at",name:"Atmosphere",category:"Rendering",engineConfig:{toggleParam:"glowEnabled",mode:"compile",label:"Volumetric Glow",groupFilter:"engine_settings"},params:{glowEnabled:{type:"boolean",default:!0,label:"Enable Glow",shortId:"ge",group:"main",hidden:!0,noReset:!0,onUpdate:"compile"},glowQuality:{type:"float",default:0,label:"Glow Algo",shortId:"gq",group:"engine_settings",options:[{label:"Accurate (Vector)",value:0},{label:"Fast (Scalar)",value:1}],description:"Vector accumulates color per-step. Scalar accumulates intensity only (faster).",onUpdate:"compile",noReset:!0},fogIntensity:{type:"float",default:0,label:"Fog Intensity",shortId:"fi",uniform:"uFogIntensity",min:0,max:1,step:.01,group:"fog"},fogNear:{type:"float",default:0,label:"Fog Start",shortId:"fn",uniform:"uFogNear",min:0,max:10,step:.1,scale:"square",group:"fog",parentId:"fogIntensity",condition:{gt:0}},fogFar:{type:"float",default:5,label:"Fog End",shortId:"ff",uniform:"uFogFar",min:0,max:10,step:.1,scale:"square",group:"fog",parentId:"fogIntensity",condition:{gt:0}},fogColor:{type:"color",default:new $e(0,0,0),label:"Fog Color",shortId:"fc",uniform:"uFogColor",group:"fog",parentId:"fogIntensity",condition:{gt:0}},fogDensity:{type:"float",default:0,label:"Volumetric Density",shortId:"fd",uniform:"uFogDensity",min:0,max:2,step:.01,group:"fog",parentId:"fogIntensity",condition:{gt:0}},glowIntensity:{type:"float",default:0,label:"Glow Strength",shortId:"gi",uniform:"uGlowIntensity",min:0,max:5,step:.01,scale:"log",group:"glow",condition:{param:"glowEnabled",bool:!0}},glowSharpness:{type:"float",default:50,label:"Tightness",shortId:"gs",uniform:"uGlowSharpness",min:1,max:1e3,step:1,scale:"log",group:"glow",parentId:"glowIntensity",condition:[{gt:0},{param:"glowEnabled",bool:!0}]},glowMode:{type:"boolean",default:!0,label:"Glow Source",shortId:"gm",uniform:"uGlowMode",group:"glow",parentId:"glowIntensity",condition:[{gt:0},{param:"glowEnabled",bool:!0}],options:[{label:"Surface",value:!1},{label:"Color",value:!0}]},glowColor:{type:"color",default:new $e(1,1,1),label:"Glow Color",shortId:"gl",uniform:"uGlowColor",group:"glow",parentId:"glowMode",condition:[{bool:!0},{param:"glowEnabled",bool:!0}]}},inject:(a,t,o)=>{if(o!=="Main")return;const r=t.atmosphere;r&&r.glowEnabled&&(r.glowQuality>.5&&a.addDefine("GLOW_FAST","1"),a.addVolumeLogic(Li,Ai))}},Bi=`
// ------------------------------------------------------------------
// DROSTE EFFECT (ESCHER MATH)
// Ported faithfully from Tom Beddard's Pixel Bender script
// ------------------------------------------------------------------

#define DROSTE_PI 3.141592653
#define DROSTE_TWOPI 6.283185307

// Complex Math Helpers
vec2 cAdd(vec2 a, vec2 b) { return vec2(a.x + b.x, a.y + b.y); }
vec2 cMult(vec2 a, vec2 b) { return vec2(a.x*b.x - a.y*b.y, a.x*b.y + a.y*b.x); }
vec2 cDiv(vec2 a, vec2 b) { float d = dot(b,b); return vec2(dot(a,b), a.y*b.x - a.x*b.y) / d; }
vec2 cExp(vec2 z) { return vec2(exp(z.x) * cos(z.y), exp(z.x) * sin(z.y)); }
vec2 cLog(vec2 z) { return vec2(log(length(z)), atan(z.y, z.x)); }

// Extended Math (Renamed to avoid GLSL built-in collisions)
float d_sinh(float x) { return (exp(x) - exp(-x)) * 0.5; }
float d_cosh(float x) { return (exp(x) + exp(-x)) * 0.5; }

vec2 cSin(vec2 z) { return vec2(sin(z.x) * d_cosh(z.y), cos(z.x) * d_sinh(z.y)); }
vec2 cCos(vec2 z) { return vec2(cos(z.x) * d_cosh(z.y), -sin(z.x) * d_sinh(z.y)); }

vec2 cTan(vec2 z) {
    float r = 2.0 * z.x;
    float i = 2.0 * z.y;
    float div = cos(r) + d_cosh(i);
    // Prevent division by zero
    if (abs(div) < 1.0e-9) div = 1.0e-9;
    return vec2(sin(r)/div, d_sinh(i)/div);
}

// Complex Power: z^p
vec2 cPower(vec2 z, float p) {
    float r = length(z);
    // Avoid log(0) issues
    if (r < 1.0e-9) return vec2(0.0);
    float a = atan(z.y, z.x);
    float newR = pow(r, p);
    float newA = a * p;
    return vec2(newR * cos(newA), newR * sin(newA));
}

// Returns vec3: .xy = UV, .z = Mask (1.0 = valid, 0.0 = invalid/transparent)
vec3 applyDroste(
    vec2 uv, 
    vec2 center, 
    float r1, float r2, 
    float period, float strands, 
    float zoom, float rot, 
    bool twist, float tilingMode,
    float rotateSpin,
    bool hyperDroste,
    float fractalPoints,
    bool autoPeriodicity,
    bool strandMirror,
    float rotatePolar
) {
    // 1. Shift & Normalize
    // We expect UV in 0..1 range. Center in -1..1 range (percentage)
    vec2 z = uv - 0.5 - (center * 0.01);
    
    // Adjust aspect ratio to square the calculation space
    float aspect = uResolution.x / uResolution.y;
    z.x *= aspect;
    
    // Scale radii to percentage (0.1 - 100 range from UI)
    float R1 = max(0.0001, r1 * 0.01);
    float R2 = max(R1 * 1.001, r2 * 0.01);
    
    float P2 = strands;
    float P1 = period;

    // --- AUTO PERIODICITY LOGIC ---
    // Matches Pixel Bender: p1 = p2/2.0 * (1.0 + sqrt(1.0 - pow(log(r2/r1)/PI, 2.0)))
    if (autoPeriodicity) {
        float logRatio = log(R2/R1);
        float ratioOverPi = logRatio / DROSTE_PI;
        float term = 1.0 - (ratioOverPi * ratioOverPi);
        
        if (term >= 0.0) {
            P1 = (P2 / 2.0) * (1.0 + sqrt(term));
        }
    }
    
    if (abs(P1) < 0.001) P1 = 0.001;
    
    // --- PRE-TRANSFORM DISTORTIONS ---
    
    // Hyper Droste (Complex Sine)
    if (hyperDroste) {
        z = cSin(z);
    }
    
    // Fractal Points (Complex Power + Tan)
    if (fractalPoints > 0.0) {
        z = cPower(z, fractalPoints);
        z = cTan(cMult(z, vec2(2.0, 0.0)));
    }
    
    // --- POLAR ROTATION ---
    // Ported from Pixel Bender: Stereo-graphic projection rotation
    if (abs(rotatePolar) > 0.001) {
        float theta = radians(rotatePolar);
        float cT = cos(theta);
        float sT = sin(theta);
        
        float x2 = z.x * z.x;
        float y2 = z.y * z.y;
        
        float div = (1.0 + x2 + y2 + ((1.0 - x2 - y2) * cT) - (2.0 * z.x * sT)) / 2.0;
        
        // Prevent div by zero
        if (abs(div) < 1.0e-9) div = 1.0e-9;
        
        float numX = z.x * cT + ((1.0 - x2 - y2) * sT / 2.0);
        
        // Complex division: (numX + i*y) / (div + 0i) = numX/div + i*y/div
        z.x = numX / div;
        z.y = z.y / div;
    }
    
    // Rotate Spin (Image Rotation independent of Spiral)
    // Matches Pixel Bender: z *= imageSpin
    if (abs(rotateSpin) > 0.001) {
        float rads = radians(rotateSpin);
        float s = sin(rads);
        float c = cos(rads);
        z = vec2(z.x*c - z.y*s, z.x*s + z.y*c);
    }

    // 2. Pre-Twist Transform
    if (twist) {
         // Apply Zoom & Rotation in log space effectively
         float angle = radians(rot);
         float scale = exp(zoom * 0.1); 
         // Manual rotation matrix
         float c = cos(angle); float s = sin(angle);
         z = vec2(z.x*c - z.y*s, z.x*s + z.y*c) / scale;
         
         // To Log-Polar
         z = cLog(cDiv(z, vec2(R1, 0.0)));
    } else {
        // Cartesian Log mapping for untwisted (Rectangular Projection)
        // Map Y to Angle [-PI, PI]
        z.y *= DROSTE_TWOPI; 
        
        // Map X to Log Radius
        float logWidth = log(R2/R1);
        z.x = z.x * logWidth; 
        
        // Align center
        z.x += logWidth * 0.5;

        // Linear Zoom/Rot application
        z.x -= zoom * 0.1;
        z.y += radians(rot);
    }
    
    // 3. Droste Conformal Map
    float logR = log(R2/R1);
    float angle = atan((P2/P1) * (logR / DROSTE_TWOPI));
    
    float f = cos(angle);
    vec2 beta = cMult(vec2(f, 0.0), cExp(vec2(0.0, angle)));
    
    // Transform Z
    z = cDiv(cMult(vec2(P1, 0.0), z), beta);
    
    // Inverse Log (Exp) to get back to Cartesian
    z = cMult(vec2(R1, 0.0), cExp(z));
    
    // 4. Infinite Tiling (The "Spiral into Infinity")
    float mode = floor(tilingMode + 0.1);
    
    bool doLoop = (mode < 1.5);
    bool doMirror = (abs(mode - 1.0) < 0.1);
    bool flipped = false;
    
    // Calculate Tile Rotation Angle
    float tileAngle = -DROSTE_TWOPI * P1;
    if (P2 > 0.0) tileAngle = -tileAngle;
    
    // Mirror Strand Logic: Divide rotation by number of strands
    // Matches Ref: if (strandMirror) angle /= p2;
    if (strandMirror && abs(P2) > 0.001) {
        tileAngle /= P2;
    }

    if (doLoop) {
        // Ratio determines the scaling and rotation per level
        vec2 ratio = cMult(vec2(R2/R1, 0.0), cExp(vec2(0.0, tileAngle)));
        vec2 ratioInv = cDiv(vec2(1.0, 0.0), ratio);

        float mag = length(z);
        
        // Iteratively scale until within bounds [R1, R2]
        // This simulates the "while" loop in the reference, but GLSL prefers fixed loops
        for(int i=0; i<12; i++) {
            if (mag >= R1 && mag <= R2) break;
            
            if (mag < R1) {
                z = cMult(z, ratio); // Grow
                mag = length(z);
                flipped = !flipped;
            } else if (mag > R2) {
                z = cMult(z, ratioInv); // Shrink
                mag = length(z);
                flipped = !flipped;
            }
        }
    }
    
    if (doMirror && flipped) {
        float r2 = dot(z, z);
        if(r2 > 1.0e-9) {
            z *= (R1 * R2) / r2;
        }
    }

    // 5. Map back to UV
    z.x /= aspect;
    z += 0.5 + (center * 0.01);
    
    float mask = 1.0;
    
    // 6. Apply Final Tiling Mode (Edge Handling)
    if (mode < 0.5) {
        // 0: Repeat
        z = fract(z);
    } else if (mode < 1.5) {
        // 1: Mirror (Standard edge mirroring)
        z.x = 1.0 - abs(mod(z.x, 2.0) - 1.0);
        z.y = 1.0 - abs(mod(z.y, 2.0) - 1.0);
    } else if (mode < 2.5) {
        // 2: Clamp
        z = clamp(z, 0.0, 1.0);
    } else {
        // 3: Transparent
        if (z.x < 0.0 || z.x > 1.0 || z.y < 0.0 || z.y > 1.0) {
            mask = 0.0;
        }
    }
    
    return vec3(z, mask);
}
`,Oi={id:"droste",shortId:"dr",name:"Droste Effect",category:"Effects",params:{active:{type:"boolean",default:!1,label:"Enable Droste",shortId:"ac",uniform:"uDrosteActive",group:"main",noReset:!0},tiling:{type:"float",default:1,label:"Tiling Mode",shortId:"tm",uniform:"uDrosteTiling",group:"geometry",noReset:!0,condition:{param:"active",bool:!0},options:[{label:"Repeat",value:0},{label:"Mirror",value:1},{label:"Clamp",value:2},{label:"Transparent",value:3}]},center:{type:"vec2",default:new Se(0,0),label:"Center Shift",shortId:"cs",uniform:"uDrosteCenter",min:-100,max:100,step:.1,group:"geometry",condition:{param:"active",bool:!0},noReset:!0},radiusInside:{type:"float",default:5,label:"Inner Rad",shortId:"r1",uniform:"uDrosteR1",min:.1,max:100,step:.1,group:"geometry",layout:"half",condition:{param:"active",bool:!0},noReset:!0},radiusOutside:{type:"float",default:100,label:"Outer Rad",shortId:"r2",uniform:"uDrosteR2",min:1,max:200,step:.1,group:"geometry",layout:"half",condition:{param:"active",bool:!0},noReset:!0},periodicity:{type:"float",default:2,label:"Periodicity",shortId:"p1",uniform:"uDrostePeriodicity",min:-10,max:10,step:.1,group:"structure",condition:[{param:"active",bool:!0},{param:"autoPeriodicity",bool:!1}],noReset:!0},strands:{type:"float",default:2,label:"Strands",shortId:"p2",uniform:"uDrosteStrands",min:-12,max:12,step:1,group:"structure",condition:{param:"active",bool:!0},noReset:!0},autoPeriodicity:{type:"boolean",default:!1,label:"Auto Period",shortId:"ap",uniform:"uDrosteAuto",group:"structure",condition:{param:"active",bool:!0},noReset:!0},strandMirror:{type:"boolean",default:!1,label:"Mirror Strand",shortId:"sm",uniform:"uDrosteMirror",group:"structure",condition:{param:"active",bool:!0},noReset:!0},zoom:{type:"float",default:0,label:"Zoom",shortId:"zm",uniform:"uDrosteZoom",min:-10,max:10,step:.1,group:"transform",condition:{param:"active",bool:!0},noReset:!0},rotate:{type:"float",default:0,label:"Spiral Rotate",shortId:"ro",uniform:"uDrosteRotate",min:-360,max:360,step:1,group:"transform",condition:{param:"active",bool:!0},noReset:!0},rotateSpin:{type:"float",default:0,label:"Image Spin",shortId:"sp",uniform:"uDrosteSpin",min:-360,max:360,step:1,group:"transform",condition:{param:"active",bool:!0},noReset:!0},rotatePolar:{type:"float",default:0,label:"Polar Rotate",shortId:"pr",uniform:"uDrostePolar",min:-360,max:360,step:1,group:"transform",condition:{param:"active",bool:!0},noReset:!0},twist:{type:"boolean",default:!0,label:"Twist (Conformal)",shortId:"tw",uniform:"uDrosteTwist",group:"transform",condition:{param:"active",bool:!0},noReset:!0},hyperDroste:{type:"boolean",default:!1,label:"Hyper Droste",shortId:"hd",uniform:"uDrosteHyper",group:"transform",condition:{param:"active",bool:!0},noReset:!0},fractalPoints:{type:"float",default:1,label:"Fractal Points",shortId:"fp",uniform:"uDrosteFractal",min:0,max:10,step:1,group:"transform",condition:[{param:"active",bool:!0},{param:"hyperDroste",bool:!0}],noReset:!0}},shader:{functions:Bi,mainUV:`
            if (uDrosteActive > 0.5) {
                vec3 res = applyDroste(
                    sampleUV, 
                    uDrosteCenter, 
                    uDrosteR1, 
                    uDrosteR2, 
                    uDrostePeriodicity, 
                    uDrosteStrands, 
                    uDrosteZoom, 
                    uDrosteRotate, 
                    uDrosteTwist > 0.5,
                    uDrosteTiling,
                    uDrosteSpin,
                    uDrosteHyper > 0.5,
                    (uDrosteHyper > 0.5 ? uDrosteFractal : 0.0),
                    uDrosteAuto > 0.5,
                    uDrosteMirror > 0.5,
                    uDrostePolar
                );
                sampleUV = res.xy;
                mask = res.z;
            }
        `}},$i=`
// ------------------------------------------------------------------
// ENVIRONMENT MAP
// ------------------------------------------------------------------

vec3 GetEnvMap(vec3 dir, float roughness) {
    // 1. Apply Rotation (CPU Optimized: uEnvRotationMatrix)
    if (abs(uEnvRotation) > 0.001) {
        dir.xz = uEnvRotationMatrix * dir.xz;
    }

    vec3 col; // Result variable

    if (uEnvSource > 0.5) {
        // Path 1: Gradient Texture
        float t = dir.y * 0.5 + 0.5;
        col = texture2D(uEnvGradient, vec2(t, 0.5)).rgb;
    } 
    else if (uUseEnvMap > 0.5) {
        // Path 2: EnvMap Texture (Flattened else-if for compiler safety)
        vec2 uv = vec2(atan(dir.z, dir.x) * 0.1591549 + 0.5, 1.0 - acos(dir.y) * 0.3183098);
        float bias = roughness * 6.0; 
        col = texture2D(uEnvMapTexture, uv, bias).rgb;
        
        // Apply Color Profile (Linear/ACES)
        col = applyTextureProfile(col, uEnvMapColorSpace);
    } 
    else {
        // Path 3: Procedural Sky (Explicit Else block)
        float y = dir.y * 0.5 + 0.5;
        vec3 skyBase = mix(vec3(0.02, 0.02, 0.05), vec3(0.15, 0.15, 0.25), y);
        vec3 sky = mix(skyBase, vec3(0.1), roughness * 0.5); 
        
        float specPower = mix(100.0, 0.5, roughness * roughness); 
        float rimPower = mix(10.0, 1.0, roughness);
        
        vec3 sunDir = normalize(vec3(1.0, 4.0, 2.0));
        float sunDot = max(0.0, dot(dir, sunDir));
        float light = pow(sunDot, specPower);
        
        vec3 rimDir = normalize(vec3(-1.0, 1.0, -1.0));
        float rimDot = max(0.0, dot(dir, rimDir));
        float rim = pow(rimDot, rimPower) * 0.5;
        
        float brightness = mix(1.0, 0.3, roughness);
        col = sky + vec3(1.0) * light * 0.8 * brightness + vec3(0.8, 0.9, 1.0) * rim * brightness;
    }

    return col;
}
`,Hi=`
    roughness = clamp(uRoughness, 0.02, 1.0);
    vec3 emitSource = albedo; 
    if (abs(uEmissionMode - 1.0) < 0.1) emitSource = col1;
    else if (abs(uEmissionMode - 2.0) < 0.1) emitSource = col2;
    else if (abs(uEmissionMode - 3.0) < 0.1) {
        float n01 = noiseVal * 0.5 + 0.5;
        emitSource = uLayer3Color * n01;
    }
    else if (abs(uEmissionMode - 4.0) < 0.1) emitSource = uEmissionColor; 
    emission = emitSource * uEmission * 1.5;
`,Ui=`
    // EnvStrength scaling for Direct Render Mode
    #ifdef RENDER_MODE_PATHTRACING
        #define uEnvStrength uEnvStrengthSlider
    #else
        #define uEnvStrength (uEnvStrengthSlider * 0.33)
    #endif
`,Gi={id:"materials",shortId:"m",name:"Material",category:"Rendering",tabConfig:{label:"Shader",componentId:"panel-shading",order:40},params:{diffuse:{type:"float",default:1,label:"Diffuse (Color)",shortId:"di",uniform:"uDiffuse",min:0,max:2,step:.01,group:"surface"},reflection:{type:"float",default:0,label:"Metallic",shortId:"re",uniform:"uReflection",min:0,max:1,step:.01,group:"surface"},specular:{type:"float",default:.3,label:"Reflectivity",shortId:"sp",uniform:"uSpecular",min:0,max:2,step:.01,group:"surface"},roughness:{type:"float",default:.5,label:"Roughness",shortId:"ro",uniform:"uRoughness",scale:"log",min:.01,max:1,step:.01,group:"surface"},rim:{type:"float",default:0,label:"Rim Light",shortId:"ri",uniform:"uRim",min:0,max:10,step:.01,scale:"log",group:"surface"},rimExponent:{type:"float",default:4,label:"Rim Sharpness",shortId:"rx",uniform:"uRimExponent",min:1,max:16,step:.1,group:"surface",parentId:"rim",condition:{gt:0}},envStrength:{type:"float",default:0,label:"Environment Light",shortId:"es",uniform:"uEnvStrengthSlider",min:0,max:5,step:.01,group:"env"},envBackgroundStrength:{type:"float",default:0,label:"BG Visibility",shortId:"eb",uniform:"uEnvBackgroundStrength",min:0,max:2,step:.01,group:"env",condition:{gt:0,param:"envStrength"}},envSource:{type:"float",default:1,label:"Source",shortId:"eo",uniform:"uEnvSource",group:"env",condition:{gt:0,param:"envStrength"},options:[{label:"Sky Image",value:0},{label:"Gradient",value:1}]},envMapData:{type:"image",default:null,label:"Upload Texture",shortId:"et",group:"env",parentId:"envSource",condition:{eq:0},uniform:"uEnvMapTexture",textureSettings:{mapping:zr,minFilter:Rr,generateMipmaps:!0},linkedParams:{colorSpace:"envMapColorSpace"}},envMapColorSpace:{type:"float",default:0,label:"Env Profile",shortId:"ec",uniform:"uEnvMapColorSpace",group:"env",hidden:!0},useEnvMap:{type:"boolean",default:!1,label:"Use Env Map",shortId:"eu",uniform:"uUseEnvMap",hidden:!0,group:"env"},envRotation:{type:"float",default:0,label:"Rotation",shortId:"er",uniform:"uEnvRotation",min:0,max:6.28,step:.01,group:"env",condition:[{param:"envStrength",gt:0},{param:"envSource",eq:0}]},envGradientStops:{type:"gradient",default:[{id:"sky",position:0,color:"#000000",bias:.5,interpolation:"smooth"},{id:"hor",position:.5,color:"#223344",bias:.5,interpolation:"smooth"},{id:"zen",position:1,color:"#88ccff",bias:.5,interpolation:"smooth"}],label:"Sky Gradient",shortId:"eg",uniform:"uEnvGradient",group:"env",parentId:"envSource",condition:{eq:1}},emission:{type:"float",default:0,label:"Self-illumination",shortId:"em",uniform:"uEmission",min:0,max:5,step:.001,scale:"square",group:"emission"},emissionMode:{type:"float",default:0,label:"Emission Source",shortId:"ec",uniform:"uEmissionMode",min:0,max:4,step:1,group:"emission",parentId:"emission",condition:{gt:1e-4},options:[{label:"Full Surface",value:0},{label:"Layer 1",value:1},{label:"Layer 2",value:2},{label:"Layer 3",value:3},{label:"Solid Color",value:4}]},emissionColor:{type:"color",default:new $e(1,1,1),label:"Solid Color",shortId:"el",uniform:"uEmissionColor",group:"emission",parentId:"emissionMode",condition:{eq:4}},ptEmissionMult:{type:"float",default:1,label:"Illumination Power",shortId:"ep",uniform:"uPTEmissionMult",min:0,max:10,step:.1,group:"emission",parentId:"emission",condition:[{gt:1e-4},{param:"$renderMode",eq:"PathTracing"}]}},inject:a=>{a.addHeader(Ui),a.addMaterialLogic(Hi),a.addFunction($i)}},Wi={id:"colorGrading",shortId:"cg",name:"Color Grading",category:"Post Process",customUI:[{componentId:"scene-histogram",group:"grading",condition:{param:"active",bool:!0}}],params:{active:{type:"boolean",default:!1,label:"Color Correction",shortId:"ac",uniform:"uGradingActive",group:"grading",noReset:!0},saturation:{type:"float",default:1,label:"Saturation",shortId:"sa",uniform:"uSaturation",min:0,max:2,step:.01,group:"grading",parentId:"active",condition:{bool:!0},noReset:!0},levelsMin:{type:"float",default:0,label:"Black Point",shortId:"ln",uniform:"uLevelsMin",min:0,max:1,step:.01,group:"grading",parentId:"active",condition:{bool:!0},noReset:!0,hidden:!0},levelsMax:{type:"float",default:1,label:"White Point",shortId:"lx",uniform:"uLevelsMax",min:0,max:2,step:.01,group:"grading",parentId:"active",condition:{bool:!0},noReset:!0,hidden:!0},levelsGamma:{type:"float",default:1,label:"Gamma",shortId:"lg",uniform:"uLevelsGamma",min:.1,max:3,step:.01,group:"grading",parentId:"active",condition:{bool:!0},noReset:!0,hidden:!0}},shader:{functions:`
            vec3 applyColorGrading(vec3 col) {
                col = max(vec3(0.0), col - uLevelsMin);
                col /= max(0.0001, uLevelsMax - uLevelsMin);
                if (abs(uLevelsGamma - 1.0) > 0.001) {
                    col = pow(max(vec3(0.0), col), vec3(1.0 / uLevelsGamma));
                }
                float luma = dot(col, vec3(0.2126, 0.7152, 0.0722));
                col = mix(vec3(luma), col, uSaturation);
                return col;
            }
        `,main:`
            if (uGradingActive > 0.5) {
                col = applyColorGrading(col);
            }
        `}},qi={id:"texturing",shortId:"tx",name:"Texture",category:"Coloring",params:{active:{type:"boolean",default:!1,label:"Use Texture",shortId:"ac",uniform:"uUseTexture",group:"main",hidden:!0},layer1Data:{type:"image",default:null,label:"Select Image",shortId:"id",group:"main",uniform:"uTexture",textureSettings:{wrapS:st,wrapT:st,minFilter:Ue,magFilter:Ue},linkedParams:{colorSpace:"colorSpace"}},colorSpace:{type:"float",default:0,label:"Color Profile",shortId:"cs",uniform:"uTextureColorSpace",group:"main",hidden:!0},mapU:{type:"float",default:6,label:"U",shortId:"mu",uniform:"uTextureModeU",group:"mapping",layout:"half",options:[{label:"Orbit Trap",value:0},{label:"Iterations",value:1},{label:"Radial",value:2},{label:"Z-Depth",value:3},{label:"Angle",value:4},{label:"Normal",value:5},{label:"Decomposition",value:6},{label:"Raw Iterations",value:7},{label:"Potential (Log-Log)",value:8},{label:"Green's Flow",value:9}]},mapV:{type:"float",default:1,label:"V",shortId:"mv",uniform:"uTextureModeV",group:"mapping",layout:"half",options:[{label:"Orbit Trap",value:0},{label:"Iterations",value:1},{label:"Radial",value:2},{label:"Z-Depth",value:3},{label:"Angle",value:4},{label:"Normal",value:5},{label:"Decomposition",value:6},{label:"Raw Iterations",value:7},{label:"Potential (Log-Log)",value:8},{label:"Green's Flow",value:9}]},scaleX:{type:"float",default:1,label:"Scale U",shortId:"su",min:.1,max:500,step:.1,scale:"log",group:"transform",layout:"half"},scaleY:{type:"float",default:1,label:"Scale V",shortId:"sv",min:.1,max:500,step:.1,scale:"log",group:"transform",layout:"half"},textureScale:{type:"vec2",default:new Se(1,1),label:"Texture Scale",uniform:"uTextureScale",composeFrom:["scaleX","scaleY"],hidden:!0},offset:{type:"vec2",default:new Se(0,0),label:"Texture Offset",shortId:"of",uniform:"uTextureOffset",min:-2,max:2,step:.01,group:"transform"}},shader:{}},Nr=[{value:0,label:"Orbit Trap",description:"Colors based on how close the orbit came to the origin or geometric traps.",glsl:"v = log(max(1.0e-5, result.y)) * -0.2;"},{value:1,label:"Iterations",description:"Smooth gradients based on how long it took to escape. The classic look.",glsl:`
            // Standard Iterations
            v = result.z;
            
            // HYBRID FIX: For SDF fractals (Menger, Amazing Box) that don't "escape",
            // the iteration count is constant (1.0). This looks flat.
            // If we hit max iterations (approx 1.0), mix in Orbit Trap (y) to provide texture.
            if (v > 0.99) {
                float trap = log(max(1.0e-5, result.y)) * -0.2;
                // Modulate the 1.0 base with the trap value
                v = 0.95 + 0.05 * sin(trap * 10.0);
            }
        `},{value:2,label:"Radial",description:"Distance from the center of the world.",glsl:"v = length(p) * 0.2;"},{value:3,label:"Z-Depth",description:"Height map based on Z coordinate. Good for landscapes.",glsl:"v = p.z * 0.2;"},{value:4,label:"Angle",description:"Polar angle around the Z axis. Creates spirals.",glsl:"v = atan(p.y, p.x) * 0.15915 + 0.5;"},{value:5,label:"Normal",description:"Based on surface slope (Up/Down).",glsl:"v = dot(n, vec3(0.0, 1.0, 0.0)) * 0.5 + 0.5;"},{value:6,label:"Decomposition",description:"Analytic angle decomposition. Creates grid/chip patterns.",glsl:`
            // Removed aggressive zero-clamping that broke some metric modes
            v = result.w;
        `},{value:7,label:"Raw Iterations",description:"Stepped bands showing exact iteration counts.",glsl:"v = floor(result.z * float(uIterations)) / float(uIterations);"},{value:8,label:"Potential (Log-Log)",description:"Electric potential. Creates smooth bands near the set boundary.",glsl:`
            // Uses result.y (Trap) as magnitude holder if available
            // Optimized for R > 1.0
            float r = max(result.y, 1.0001); 
            v = log2(log2(r));
        `},{value:9,label:"Flow (Angle + Iter)",description:"Combines Decomposition (Angle) and Iterations to create spirals and grids.",glsl:`
            // Result.w = Decomposition (Angle 0-1)
            // Result.z = Smoothed Iterations (Count 0-N)
            // Adding them creates a diagonal slope in the mapping space.
            // When wrapped by the gradient, this creates spirals.
            v = result.w + result.z;
        `}],Xi=()=>{let a=`
    float getMappingValue(float mode, vec3 p, vec4 result, vec3 n, float repeatScale) {
        float v = 0.0;
        
        // Mode Selection Ladder
    `;return Nr.forEach((t,o)=>{const r=o===0,n=`if (mode < ${t.value}.5)`,i=`
        ${r?n:"else "+n} {
            // ${t.label}
            ${t.glsl}
        }`;a+=i}),a+=`
        // Fallback
        else {
            v = result.z;
        }

        // Safety Clamp
        if (v < -1.0e10 || v > 1.0e10) return 0.0;
        return v;
    }
    `,a},Eo=Nr.map(a=>({label:a.label,value:a.value})),Yi={id:"coloring",shortId:"cl",name:"Coloring",category:"Visuals",tabConfig:{label:"Gradient",componentId:"panel-gradients",order:50},customUI:[{componentId:"coloring-histogram",group:"layer1_hist",props:{layer:1}},{componentId:"coloring-histogram",group:"layer2_hist",props:{layer:2}}],params:{gradient:{type:"gradient",default:[{id:"2",position:1,color:"#ffffff",bias:.5,interpolation:"linear"}],label:"Gradient",shortId:"g1",uniform:"uGradientTexture",group:"layer1_grad"},mode:{type:"float",default:0,label:"Mapping",shortId:"m1",uniform:"uColorMode",group:"layer1_top",options:Eo},scale:{type:"float",default:1,label:"Scale",shortId:"s1",uniform:"uColorScale",group:"layer1_hist",hidden:!0},offset:{type:"float",default:0,label:"Offset",shortId:"o1",uniform:"uColorOffset",group:"layer1_hist",hidden:!0},repeats:{type:"float",default:1,label:"Repeats",shortId:"r1",min:.1,max:100,step:.1,group:"layer1_hist",hidden:!0},phase:{type:"float",default:0,label:"Phase",shortId:"p1",min:-1,max:1,step:.01,group:"layer1_hist",hidden:!0},bias:{type:"float",default:1,label:"Gamma",shortId:"b1",uniform:"uGradientBias",min:.1,max:10,step:.01,group:"layer1_hist",hidden:!0},twist:{type:"float",default:0,label:"Twist",shortId:"w1",uniform:"uColorTwist",min:-5,max:5,step:.1,group:"layer1_bottom"},escape:{type:"float",default:4,label:"Escape Radius",shortId:"e1",uniform:"uEscapeThresh",min:1,max:1e3,step:.1,scale:"log",group:"layer1_bottom",condition:{or:[{param:"mode",eq:6},{param:"mode",eq:8},{param:"mode",eq:9},{param:"mode2",eq:6},{param:"mode2",eq:8},{param:"mode2",eq:9},{and:[{param:"$texturing.active",bool:!0},{or:[{param:"$texturing.mapU",eq:6},{param:"$texturing.mapU",eq:8},{param:"$texturing.mapU",eq:9},{param:"$texturing.mapV",eq:6},{param:"$texturing.mapV",eq:8},{param:"$texturing.mapV",eq:9}]}]}]}},gradient2:{type:"gradient",default:[{id:"1",position:0,color:"#000000"},{id:"2",position:1,color:"#ffffff"}],label:"Gradient 2",shortId:"g2",uniform:"uGradientTexture2",group:"layer2_grad"},mode2:{type:"float",default:4,label:"Mapping",shortId:"m2",uniform:"uColorMode2",group:"layer2_top",options:Eo},scale2:{type:"float",default:1,label:"Scale 2",shortId:"s2",uniform:"uColorScale2",group:"layer2_hist",hidden:!0},offset2:{type:"float",default:0,label:"Offset 2",shortId:"o2",uniform:"uColorOffset2",group:"layer2_hist",hidden:!0},repeats2:{type:"float",default:1,label:"Repeats",shortId:"r2",min:.1,max:100,step:.1,group:"layer2_hist",hidden:!0},phase2:{type:"float",default:0,label:"Phase",shortId:"p2",min:-1,max:1,step:.01,group:"layer2_hist",hidden:!0},bias2:{type:"float",default:1,label:"Gamma",shortId:"b2",uniform:"uGradientBias2",min:.1,max:10,step:.01,group:"layer2_hist",hidden:!0},twist2:{type:"float",default:0,label:"Twist",shortId:"w2",uniform:"uColorTwist2",min:-5,max:5,step:.1,group:"layer2_bottom"},blendMode:{type:"float",default:0,label:"Blend Mode",shortId:"bm",uniform:"uBlendMode",group:"layer2_bottom",options:[{label:"Mix",value:0},{label:"Add",value:1},{label:"Multiply",value:2},{label:"Overlay",value:3},{label:"Screen",value:4},{label:"Bump (Normal)",value:6}]},blendOpacity:{type:"float",default:0,label:"Blend Amount",shortId:"bo",uniform:"uBlendOpacity",min:0,max:1,step:.01,group:"layer2_bottom"},layer3Color:{type:"color",default:new $e(1,1,1),label:"Noise Color",shortId:"n3c",uniform:"uLayer3Color",group:"noise",layout:"embedded"},layer3Scale:{type:"float",default:2,label:"Noise Scale",shortId:"n3s",uniform:"uLayer3Scale",min:.1,max:2e3,step:.1,scale:"log",group:"noise"},layer3Strength:{type:"float",default:0,label:"Mix Strength",shortId:"n3a",uniform:"uLayer3Strength",min:0,max:1,step:.01,group:"noise"},layer3Bump:{type:"float",default:0,label:"Bump",shortId:"n3b",uniform:"uLayer3Bump",min:-1,max:1,step:.01,group:"noise"},layer3Turbulence:{type:"float",default:0,label:"Turbulence",shortId:"n3t",uniform:"uLayer3Turbulence",min:0,max:2,step:.01,group:"noise"}},inject:(a,t,o)=>{o==="Main"||o==="Histogram"?a.addFunction(Xi()):a.addFunction(`
                float getMappingValue(float mode, vec3 p, vec4 result, vec3 n, float repeatScale) { return 0.0; }
            `)}},Vi=`
void formula_Hybrid(inout vec4 z, inout float dr, inout float trap, vec4 c) {
    vec3 z3 = z.xyz;
    boxFold(z3, dr, uHybridFoldLimit); 
    sphereFold(z3, dr, uHybridMinR, uHybridFixedR);
    z3 *= uHybridScale;
    if (uHybridAddC > 0.5) z3 += c.xyz;
    z.xyz = z3;
    dr = dr * abs(uHybridScale) + 1.0;
    trap = min(trap, getLength(z3));
}
`,Zi={id:"geometry",shortId:"g",name:"Geometry",category:"Formulas",customUI:[{componentId:"interaction-picker",group:"julia",condition:{param:"juliaMode",bool:!0},props:{targetMode:"picking_julia",label:"Pick Coordinate",activeLabel:"Cancel Picking",helpText:"Click any point on the fractal surface to set Julia coordinates.",variant:"primary"}}],engineConfig:{toggleParam:"applyTransformLogic",mode:"compile",label:"Geometry Modifiers",groupFilter:"engine_settings"},params:{applyTransformLogic:{type:"boolean",default:!0,label:"Geometry Engine",shortId:"gt",group:"main",description:"Master switch for geometry modifiers (Julia, Rotation, Hybrid).",noReset:!0,hidden:!0},preRotMaster:{type:"boolean",default:!0,label:"Enable Rotation",shortId:"rm",group:"engine_settings",ui:"checkbox",description:"Compiles rotation matrix logic. Disable for speed.",onUpdate:"compile",noReset:!0},hybridComplex:{type:"boolean",default:!1,label:"Advanced Hybrid",shortId:"hx",uniform:"uHybridComplex",group:"engine_settings",ui:"checkbox",description:"Enables interleaved folding (Box -> Fractal -> Box). Slow compile.",onUpdate:"compile",noReset:!0},burningEnabled:{type:"boolean",default:!1,label:"Burning Mode",shortId:"bm",group:"transform",description:'Applies absolute value to coordinates every iteration. Creates "Burning Ship" variations.',uniform:"uBurningEnabled"},hybridMode:{type:"boolean",default:!1,label:"Hybrid (Box Mode)",shortId:"hm",uniform:"uHybrid",group:"hybrid"},hybridIter:{type:"float",default:2,label:"Iterations",shortId:"hi",uniform:"uHybridIter",min:0,max:10,step:1,group:"hybrid",condition:{param:"hybridMode",bool:!0}},hybridFoldLimit:{type:"float",default:1,label:"Fold Limit",shortId:"hl",uniform:"uHybridFoldLimit",min:.1,max:2,step:.01,group:"hybrid",condition:{param:"hybridMode",bool:!0}},hybridScale:{type:"float",default:2,label:"Scale",shortId:"hs",uniform:"uHybridScale",min:1,max:3,step:.01,group:"hybrid",condition:{param:"hybridMode",bool:!0}},hybridMinR:{type:"float",default:.5,label:"Min Radius",shortId:"hn",uniform:"uHybridMinR",min:0,max:1.5,step:.01,group:"hybrid",condition:{param:"hybridMode",bool:!0}},hybridFixedR:{type:"float",default:1,label:"Fixed Radius",shortId:"hf",uniform:"uHybridFixedR",min:.1,max:3,step:.01,group:"hybrid",condition:{param:"hybridMode",bool:!0}},hybridAddC:{type:"boolean",default:!1,label:"Add Constant",shortId:"hc",uniform:"uHybridAddC",group:"hybrid",condition:{param:"hybridMode",bool:!0}},hybridProtect:{type:"boolean",default:!0,label:"Protect Axis",shortId:"hp",uniform:"uHybridProtect",group:"hybrid",condition:[{param:"hybridComplex",bool:!0},{param:"hybridMode",bool:!0}]},hybridSwap:{type:"boolean",default:!1,label:"Swap Order",shortId:"hw",uniform:"uHybridSwap",group:"hybrid",condition:[{param:"hybridComplex",bool:!0},{param:"hybridMode",bool:!0}]},hybridSkip:{type:"int",default:1,label:"Hybrid Interval",shortId:"hk",uniform:"uHybridSkip",min:1,max:8,step:1,group:"hybrid",condition:[{param:"hybridComplex",bool:!0},{param:"hybridMode",bool:!0}]},preRotEnabled:{type:"boolean",default:!1,label:"Local Rotation",shortId:"re",uniform:"uPreRotEnabled",group:"transform",condition:{param:"preRotMaster",bool:!0}},preRotY:{type:"float",default:0,label:"Spin Y",shortId:"ry",min:-Math.PI,max:Math.PI,step:.01,scale:"pi",group:"transform",parentId:"preRotEnabled",condition:{bool:!0}},preRotX:{type:"float",default:0,label:"Spin X",shortId:"rx",min:-Math.PI,max:Math.PI,step:.01,scale:"pi",group:"transform",parentId:"preRotEnabled",condition:{bool:!0}},preRotZ:{type:"float",default:0,label:"Spin Z",shortId:"rz",min:-Math.PI,max:Math.PI,step:.01,scale:"pi",group:"transform",parentId:"preRotEnabled",condition:{bool:!0}},preRot:{type:"vec3",default:new ie(0,0,0),label:"Pre Rotation",composeFrom:["preRotX","preRotY","preRotZ"],hidden:!0},juliaMode:{type:"boolean",default:!1,label:"Julia Mode",shortId:"jm",uniform:"uJuliaMode",group:"julia"},juliaX:{type:"float",default:0,label:"Julia X",shortId:"jx",min:-2,max:2,step:.01,group:"julia_params",condition:{param:"juliaMode",bool:!0}},juliaY:{type:"float",default:0,label:"Julia Y",shortId:"jy",min:-2,max:2,step:.01,group:"julia_params",condition:{param:"juliaMode",bool:!0}},juliaZ:{type:"float",default:0,label:"Julia Z",shortId:"jz",min:-2,max:2,step:.01,group:"julia_params",condition:{param:"juliaMode",bool:!0}},julia:{type:"vec3",default:new ie(0,0,0),label:"Julia Vector",uniform:"uJulia",composeFrom:["juliaX","juliaY","juliaZ"],hidden:!0}},inject:(a,t)=>{const o=t.geometry;if((o?o.applyTransformLogic:!0)===!1){a.addFunction("void formula_Hybrid(inout vec4 z, inout float dr, inout float trap, vec4 c) {}");return}const n=o?o.preRotMaster!==!1:!0;a.setRotation(n),a.addFunction(Vi);let i="",s="";t.formula!=="MandelTerrain"&&(s+="if (uBurningEnabled > 0.5) z.xyz = abs(z.xyz);"),o&&o.hybridComplex?s+=`
             if (uHybrid > 0.5) {
                int startI = (uHybridSwap > 0.5) ? 1 : 0;
                int skip = int(uHybridSkip);
                if (skip < 1) skip = 1; 
                
                if (i >= startI) {
                    int rel_i = i - startI;
                    
                    if ((rel_i % skip) == 0 && (rel_i / skip) < int(uHybridIter)) {
                        
                        if (uHybridProtect > 0.5 && rotated) {
                            unapplyLocalRotation(z.xyz);
                            rotated = false;
                        }
                        
                        formula_Hybrid(z, dr, trap, c);
                        skipMainFormula = true;
                    }
                }
             }
             `:i=`
            if (uHybrid > 0.5) {
                int hLim = int(uHybridIter);
                for(int i=0; i<16; i++) {
                    if (i >= hLim) break;
                    formula_Hybrid(z, dr, trap, c);
                }
            }
            `,a.addHybrid("",i,s)}},Ki={id:"quality",shortId:"q",name:"Quality",category:"Rendering",tabConfig:{label:"Quality",componentId:"panel-quality",order:60},engineConfig:{toggleParam:"engineQuality",mode:"compile",label:"Loop Limits & Precision",groupFilter:"engine_settings"},params:{engineQuality:{type:"boolean",default:!0,label:"Quality Core",shortId:"qc",group:"main",noReset:!0,hidden:!0},compilerHardCap:{type:"int",default:500,label:"Hard Loop Cap",shortId:"hc",min:64,max:2e3,step:1,group:"engine_settings",ui:"numeric",description:"Compile-time safety limit. Ray loop will never exceed this.",onUpdate:"compile",noReset:!0},precisionMode:{type:"float",default:0,label:"Ray Precision",shortId:"pm",group:"engine_settings",options:[{label:"High (Desktop)",value:0},{label:"Standard (Mobile)",value:1}],description:"Sets the minimum epsilon (ray hit distance). Standard prevents GPU hangs on mobile.",onUpdate:"compile",noReset:!0},bufferPrecision:{type:"float",default:0,label:"Texture Buffer",shortId:"bp",group:"engine_settings",options:[{label:"Float32 (HDR)",value:0},{label:"HalfFloat16",value:1}],description:"Controls render target bit-depth. 16-bit is faster and required on some mobile GPUs.",onUpdate:"compile",noReset:!0},maxSteps:{type:"int",default:300,label:"Max Ray Steps",shortId:"ms",uniform:"uMaxSteps",min:32,max:2e3,step:1,group:"kernel",description:"Runtime limit. Rays stop after this many steps. Artistic tool for limiting depth.",isAdvanced:!0},distanceMetric:{type:"float",default:0,label:"Distance Metric",shortId:"dm",uniform:"uDistanceMetric",group:"kernel",options:[{label:"Euclidean (Sphere)",value:0},{label:"Chebyshev (Box)",value:1},{label:"Manhattan (Diamond)",value:2},{label:"Minkowski 4 (Rounded)",value:3}],description:'The shape of "distance". Changes the aesthetic of the fractal surface.'},estimator:{type:"float",default:0,label:"Estimator",shortId:"es",group:"kernel",options:[{label:"Analytic (Log)",value:0},{label:"Linear (Unit 1.0)",value:1},{label:"Linear (Offset 2.0)",value:4},{label:"Pseudo (Raw)",value:2},{label:"Dampened",value:3}],description:"Algorithm for calculating distance. Log=Smooth, Linear=Sharp/IFS, Pseudo=Artifact Fix.",onUpdate:"compile",noReset:!0,isAdvanced:!0},fudgeFactor:{type:"float",default:1,label:"Slice Optimization",shortId:"ff",uniform:"uFudgeFactor",min:.01,max:1,step:.01,group:"kernel",description:"Multiplies step size. Lower = Higher quality but slower. Set to < 0.2 for deep zooms.",format:a=>a.toFixed(2)},stepRelaxation:{type:"float",default:0,label:"Step Relaxation",shortId:"sr",uniform:"uStepRelaxation",min:0,max:1,step:.01,group:"kernel",description:"Dynamic Step Size. 0 = Fixed Fudge. 1 = Variable (Fudge near surface, 1.0 in void). Saves steps.",isAdvanced:!0},refinementSteps:{type:"int",default:0,label:"Edge Polish",shortId:"rf",uniform:"uRefinementSteps",min:0,max:5,step:1,group:"kernel",description:"Extra micro-steps after hitting surface. Fixes slicing/banding artifacts.",isAdvanced:!0},detail:{type:"float",default:1,label:"Ray detail",shortId:"rd",uniform:"uDetail",min:.1,max:10,step:.1,group:"kernel"},pixelThreshold:{type:"float",default:.5,label:"Pixel threshold",shortId:"pt",uniform:"uPixelThreshold",min:.1,max:2,step:.1,group:"kernel"},overstepTolerance:{type:"float",default:0,label:"Overstep Fix",shortId:"ot",uniform:"uOverstepTolerance",min:0,max:5,step:.1,group:"kernel",description:"Recovers details missed by the raymarcher. 0=Off. Higher values fix more holes but may create noise.",isAdvanced:!0},dynamicScaling:{type:"boolean",default:!1,label:"Adaptive Resolution",shortId:"ds",group:"performance",noReset:!0},interactionDownsample:{type:"float",default:2,label:"Move Quality",shortId:"id",min:1,max:4,step:.5,group:"performance",condition:{param:"dynamicScaling",bool:!0},format:a=>`1/${a}x`,noReset:!0},physicsProbeMode:{type:"float",default:0,label:"Distance Probe",shortId:"dp",group:"performance",isAdvanced:!0,options:[{label:"GPU Probe",value:0},{label:"Manual",value:2}],description:"GPU Probe: Reads distance from render target. Manual: Fixed value for orbit control.",noReset:!0},manualDistance:{type:"float",default:10,label:"Manual Distance",shortId:"md",min:.1,max:1e3,step:.1,group:"performance",isAdvanced:!0,description:"Manual distance value. Used for orbit control calculations.",format:a=>a.toFixed(1),noReset:!0}},inject:(a,t)=>{const o=t.quality,r=(o==null?void 0:o.compilerHardCap)||500;a.addDefine("MAX_HARD_ITERATIONS",Math.floor(r).toString())}};class Qi{constructor(){Z(this,"definitions",new Map)}register(t){this.definitions.set(t.id,t)}registerAlias(t,o){const r=this.definitions.get(o);r?this.definitions.set(t,r):console.warn(`FractalRegistry: Cannot register alias '${t}' for unknown target '${o}'`)}get(t){return this.definitions.get(t)}getAll(){return Array.from(new Set(this.definitions.values()))}getIds(){return Array.from(this.definitions.keys())}}const Le=new Qi,dt=220,Dr=24,Ji=32,No=24,ta=24,aa=50,es=0,ts=14,ka=64,He=8,as={BITRATE_MULTIPLIER:1e6},oa=[{label:"MP4 (H.264) - Universal",container:"mp4",codec:"avc",ext:"mp4",mime:"video/mp4"},{label:"MP4 (H.265/HEVC) - High Quality",container:"mp4",codec:"hevc",ext:"mp4",mime:"video/mp4"},{label:"MP4 (AV1) - Best Compression",container:"mp4",codec:"av1",ext:"mp4",mime:"video/mp4"},{label:"WebM (VP9) - Web Standard",container:"webm",codec:"vp9",ext:"webm",mime:"video/webm"}];class os{constructor(){Z(this,"nodes",new Map)}register(t){this.nodes.set(t.id,t)}get(t){return this.nodes.get(t)}getAll(){return Array.from(this.nodes.values())}getGrouped(){const t={};return this.nodes.forEach(o=>{t[o.category]||(t[o.category]=[]),t[o.category].push(o.id)}),t}}const Ie=new os;Ie.register({id:"Note",label:"Comment / Note",category:"Utils",description:"A text block for leaving comments. Ignored by renderer.",inputs:[],glsl:a=>""});Ie.register({id:"AddConstant",label:"Add C (Julia/Pixel)",category:"Utils",description:"Adds the Julia Constant (or Pixel Coordinate) to the position. Essential for Mandelbrot/Julia hybrids.",inputs:[{id:"scale",label:"Strength",min:0,max:2,step:.01,default:1}],glsl:a=>`${a.indent}${a.varName}_p += c.xyz * ${a.getParam("scale")};`});Ie.register({id:"Scale",label:"Scale (Mult)",category:"Transforms",description:"Simple multiplication. Warning: For fractals, use IFS Scale to keep centered.",inputs:[{id:"scale",label:"Scale",min:.1,max:5,step:.01,default:2,hardMin:.001}],glsl:a=>`
${a.indent}${a.varName}_p *= ${a.getParam("scale")};
${a.indent}${a.varName}_dr *= abs(${a.getParam("scale")});
`});Ie.register({id:"IFSScale",label:"IFS Scale (Homothety)",category:"Transforms",description:"Scales space while shifting to maintain a center. Critical for Menger/Sierpinski.",inputs:[{id:"scale",label:"Scale",min:1,max:5,step:.01,default:2},{id:"offset",label:"Offset",min:0,max:5,step:.01,default:1}],glsl:a=>`
${a.indent}{
${a.indent}    float scale = ${a.getParam("scale")};
${a.indent}    float off = ${a.getParam("offset")};
${a.indent}    ${a.varName}_p = ${a.varName}_p * scale - vec3(off * (scale - 1.0));
${a.indent}    ${a.varName}_dr *= abs(scale);
${a.indent}}
`});Ie.register({id:"Rotate",label:"Rotate",category:"Transforms",description:"Rotates space around X, Y, Z axes.",inputs:[{id:"x",label:"Rot X",min:-180,max:180,step:1,default:0},{id:"y",label:"Rot Y",min:-180,max:180,step:1,default:0},{id:"z",label:"Rot Z",min:-180,max:180,step:1,default:0}],glsl:a=>`
${a.indent}{
${a.indent}    vec3 rot = vec3(radians(${a.getParam("x")}), radians(${a.getParam("y")}), radians(${a.getParam("z")}));
${a.indent}    if(abs(rot.x)>0.001) { float s=sin(rot.x); float c=cos(rot.x); mat2 m=mat2(c,-s,s,c); ${a.varName}_p.yz = m*${a.varName}_p.yz; }
${a.indent}    if(abs(rot.y)>0.001) { float s=sin(rot.y); float c=cos(rot.y); mat2 m=mat2(c,-s,s,c); ${a.varName}_p.xz = m*${a.varName}_p.xz; }
${a.indent}    if(abs(rot.z)>0.001) { float s=sin(rot.z); float c=cos(rot.z); mat2 m=mat2(c,-s,s,c); ${a.varName}_p.xy = m*${a.varName}_p.xy; }
${a.indent}}
`});Ie.register({id:"Translate",label:"Translate",category:"Transforms",description:"Linear shift of coordinates.",inputs:[{id:"x",label:"X",min:-5,max:5,step:.01,default:0},{id:"y",label:"Y",min:-5,max:5,step:.01,default:0},{id:"z",label:"Z",min:-5,max:5,step:.01,default:0}],glsl:a=>`
${a.indent}${a.varName}_p += vec3(${a.getParam("x")}, ${a.getParam("y")}, ${a.getParam("z")});
`});Ie.register({id:"Mod",label:"Modulo (Repeat)",category:"Transforms",description:"Tiles space infinitely in a grid.",inputs:[{id:"x",label:"X Period",min:0,max:10,step:.1,default:0},{id:"y",label:"Y Period",min:0,max:10,step:.1,default:0},{id:"z",label:"Z Period",min:0,max:10,step:.1,default:0}],glsl:a=>`
${a.indent}{
${a.indent}    vec3 per = vec3(${a.getParam("x")}, ${a.getParam("y")}, ${a.getParam("z")});
${a.indent}    if(abs(per.x)>0.001) ${a.varName}_p.x = mod(${a.varName}_p.x + 0.5*per.x, per.x) - 0.5*per.x;
${a.indent}    if(abs(per.y)>0.001) ${a.varName}_p.y = mod(${a.varName}_p.y + 0.5*per.y, per.y) - 0.5*per.y;
${a.indent}    if(abs(per.z)>0.001) ${a.varName}_p.z = mod(${a.varName}_p.z + 0.5*per.z, per.z) - 0.5*per.z;
${a.indent}}
`});Ie.register({id:"AmazingFold",label:"Amazing Fold",category:"Folds",description:"The core folding logic of the Amazing Box (Box + Sphere fold). Does not scale or add C.",inputs:[{id:"limit",label:"Box Limit",min:.1,max:3,step:.01,default:1},{id:"minR",label:"Min Radius",min:0,max:2,step:.01,default:.5},{id:"fixedR",label:"Fixed Radius",min:0,max:3,step:.01,default:1}],glsl:a=>`
${a.indent}boxFold(${a.varName}_p, ${a.varName}_dr, ${a.getParam("limit")});
${a.indent}sphereFold(${a.varName}_p, ${a.varName}_dr, ${a.getParam("minR")}, ${a.getParam("fixedR")});
`});Ie.register({id:"Abs",label:"Abs (Mirror)",category:"Folds",description:"Absolute value fold on all axes. Creates cubic symmetries.",inputs:[],glsl:a=>`${a.indent}${a.varName}_p = abs(${a.varName}_p);`});Ie.register({id:"BoxFold",label:"Box Fold",category:"Folds",description:"Clamps space inside a box limit. The core of the Mandelbox.",inputs:[{id:"limit",label:"Limit",min:.1,max:3,step:.01,default:1,hardMin:.001}],glsl:a=>`${a.indent}boxFold(${a.varName}_p, ${a.varName}_dr, ${a.getParam("limit")});`});Ie.register({id:"SphereFold",label:"Sphere Fold",category:"Folds",description:"Inverts space inside a sphere. Creates spherical voids.",inputs:[{id:"minR",label:"Min Radius",min:0,max:2,step:.01,default:.5},{id:"fixedR",label:"Fixed Radius",min:0,max:3,step:.01,default:1}],glsl:a=>`${a.indent}sphereFold(${a.varName}_p, ${a.varName}_dr, ${a.getParam("minR")}, ${a.getParam("fixedR")});`});Ie.register({id:"PlaneFold",label:"Plane Fold",category:"Folds",description:"Reflects space across a plane defined by a Normal and Distance.",inputs:[{id:"x",label:"Normal X",min:-1,max:1,step:.01,default:0},{id:"y",label:"Normal Y",min:-1,max:1,step:.01,default:1},{id:"z",label:"Normal Z",min:-1,max:1,step:.01,default:0},{id:"d",label:"Offset",min:-2,max:2,step:.01,default:0}],glsl:a=>`
${a.indent}{
${a.indent}    vec3 n = normalize(vec3(${a.getParam("x")}, ${a.getParam("y")}, ${a.getParam("z")}));
${a.indent}    ${a.varName}_p -= 2.0 * min(0.0, dot(${a.varName}_p, n) - ${a.getParam("d")}) * n;
${a.indent}}
`});Ie.register({id:"MengerFold",label:"Menger Fold",category:"Folds",description:"Permutes coordinates (sorts xyz). Essential for Menger Sponges.",inputs:[],glsl:a=>`
${a.indent}if(${a.varName}_p.x < ${a.varName}_p.y) ${a.varName}_p.xy = ${a.varName}_p.yx;
${a.indent}if(${a.varName}_p.x < ${a.varName}_p.z) ${a.varName}_p.xz = ${a.varName}_p.zx;
${a.indent}if(${a.varName}_p.y < ${a.varName}_p.z) ${a.varName}_p.yz = ${a.varName}_p.zy;
`});Ie.register({id:"SierpinskiFold",label:"Sierpinski Fold",category:"Folds",description:"Diagonal folding for Tetrahedral fractals (MixPinski).",inputs:[],glsl:a=>`
${a.indent}if(${a.varName}_p.x + ${a.varName}_p.y < 0.0) ${a.varName}_p.xy = -${a.varName}_p.yx;
${a.indent}if(${a.varName}_p.x + ${a.varName}_p.z < 0.0) ${a.varName}_p.xz = -${a.varName}_p.zx;
${a.indent}if(${a.varName}_p.y + ${a.varName}_p.z < 0.0) ${a.varName}_p.yz = -${a.varName}_p.zy;
`});Ie.register({id:"Mandelbulb",label:"Mandelbulb",category:"Fractals",description:"The standard Power function. Includes phase shifts.",inputs:[{id:"power",label:"Power",min:1,max:16,step:.1,default:8},{id:"phaseX",label:"Phi Phase",min:-3.14,max:3.14,step:.01,default:0},{id:"phaseY",label:"Theta Phase",min:-3.14,max:3.14,step:.01,default:0},{id:"twist",label:"Z Twist",min:-2,max:2,step:.01,default:0}],glsl:a=>`
${a.indent}{
${a.indent}    vec3 p = ${a.varName}_p;
${a.indent}    float r = length(p);
${a.indent}    float power = ${a.getParam("power")};
${a.indent}    ${a.varName}_dr = pow(max(r, 1e-5), power - 1.0) * power * ${a.varName}_dr + 1.0;
${a.indent}    float theta = acos(clamp(p.z / r, -1.0, 1.0));
${a.indent}    float phi = atan(p.y, p.x);
${a.indent}    theta = theta * power + ${a.getParam("phaseX")};
${a.indent}    phi = phi * power + ${a.getParam("phaseY")};
${a.indent}    float zr = pow(r, power);
${a.indent}    p = zr * vec3(sin(theta)*cos(phi), sin(phi)*sin(theta), cos(theta));
${a.indent}    float tw = ${a.getParam("twist")};
${a.indent}    if(abs(tw) > 0.001) { float ang = p.z * tw; float s = sin(ang); float c = cos(ang); p.xy = mat2(c,-s,s,c) * p.xy; }
${a.indent}    ${a.varName}_p = p;
${a.indent}}
`});Ie.register({id:"Sphere",label:"Sphere",category:"Primitives",description:"SDF Sphere.",inputs:[{id:"r",label:"Radius",min:.1,max:5,step:.01,default:1}],glsl:a=>`${a.indent}${a.varName}_d = length(${a.varName}_p) - ${a.getParam("r")};`});Ie.register({id:"Box",label:"Box",category:"Primitives",description:"SDF Box.",inputs:[{id:"x",label:"Size X",min:.1,max:5,step:.01,default:1},{id:"y",label:"Size Y",min:.1,max:5,step:.01,default:1},{id:"z",label:"Size Z",min:.1,max:5,step:.01,default:1}],glsl:a=>`
${a.indent}{
${a.indent}    vec3 b = vec3(${a.getParam("x")}, ${a.getParam("y")}, ${a.getParam("z")});
${a.indent}    vec3 d = abs(${a.varName}_p) - b;
${a.indent}    ${a.varName}_d = length(max(d, 0.0)) + min(max(d.x, max(d.y, d.z)), 0.0);
${a.indent}}
`});Ie.register({id:"Twist",label:"Twist (Z)",category:"Distortion",description:"Twists space along the Z-axis.",inputs:[{id:"amount",label:"Amount",min:-5,max:5,step:.01,default:1}],glsl:a=>`
${a.indent}{
${a.indent}    float c_tw = cos(${a.getParam("amount")} * ${a.varName}_p.z);
${a.indent}    float s_tw = sin(${a.getParam("amount")} * ${a.varName}_p.z);
${a.indent}    mat2 m_tw = mat2(c_tw, -s_tw, s_tw, c_tw);
${a.indent}    ${a.varName}_p.xy = m_tw * ${a.varName}_p.xy;
${a.indent}}
`});Ie.register({id:"Bend",label:"Bend (Y)",category:"Distortion",description:"Bends space along the Y-axis.",inputs:[{id:"amount",label:"Amount",min:-2,max:2,step:.01,default:.5}],glsl:a=>`
${a.indent}{
${a.indent}    float c_bn = cos(${a.getParam("amount")} * ${a.varName}_p.y);
${a.indent}    float s_bn = sin(${a.getParam("amount")} * ${a.varName}_p.y);
${a.indent}    mat2 m_bn = mat2(c_bn, -s_bn, s_bn, c_bn);
${a.indent}    ${a.varName}_p.xz = m_bn * ${a.varName}_p.xz;
${a.indent}}
`});Ie.register({id:"SineWave",label:"Sine Wave",category:"Distortion",description:"Adds a sinusoidal ripple to the position.",inputs:[{id:"freq",label:"Frequency",min:.1,max:10,step:.1,default:2},{id:"amp",label:"Amplitude",min:0,max:1,step:.01,default:.1}],glsl:a=>`
${a.indent}${a.varName}_p += sin(${a.varName}_p.yzx * ${a.getParam("freq")}) * ${a.getParam("amp")};
`});Ie.register({id:"Union",label:"Union",category:"Combiners (CSG)",description:"Combines two shapes (min).",inputs:[],glsl:a=>`
${a.indent}bool winA = ${a.varName}_d < ${a.in2}_d;
${a.indent}${a.varName}_d = winA ? ${a.varName}_d : ${a.in2}_d;
${a.indent}${a.varName}_p = winA ? ${a.varName}_p : ${a.in2}_p;
${a.indent}${a.varName}_dr = winA ? ${a.varName}_dr : ${a.in2}_dr;
`});Ie.register({id:"Subtract",label:"Subtract",category:"Combiners (CSG)",description:"Carves B out of A.",inputs:[],glsl:a=>`
${a.indent}float negB = -${a.in2}_d;
${a.indent}bool winA = ${a.varName}_d > negB; 
${a.indent}${a.varName}_d = winA ? ${a.varName}_d : negB;
${a.indent}${a.varName}_p = winA ? ${a.varName}_p : ${a.in2}_p;
${a.indent}${a.varName}_dr = winA ? ${a.varName}_dr : ${a.in2}_dr;
`});Ie.register({id:"Intersect",label:"Intersect",category:"Combiners (CSG)",description:"Area where A and B overlap.",inputs:[],glsl:a=>`
${a.indent}bool winA = ${a.varName}_d > ${a.in2}_d;
${a.indent}${a.varName}_d = winA ? ${a.varName}_d : ${a.in2}_d;
${a.indent}${a.varName}_p = winA ? ${a.varName}_p : ${a.in2}_p;
${a.indent}${a.varName}_dr = winA ? ${a.varName}_dr : ${a.in2}_dr;
`});Ie.register({id:"SmoothUnion",label:"Smooth Union",category:"Combiners (CSG)",description:"Merges shapes organically.",inputs:[{id:"k",label:"Smoothness",min:.01,max:2,step:.01,default:.5}],glsl:a=>`
${a.indent}float h = clamp(0.5 + 0.5 * (${a.in2}_d - ${a.varName}_d) / ${a.getParam("k")}, 0.0, 1.0);
${a.indent}${a.varName}_d = mix(${a.in2}_d, ${a.varName}_d, h) - ${a.getParam("k")} * h * (1.0 - h);
${a.indent}${a.varName}_p = mix(${a.in2}_p, ${a.varName}_p, h);
${a.indent}${a.varName}_dr = mix(${a.in2}_dr, ${a.varName}_dr, h);
`});Ie.register({id:"Mix",label:"Mix (Lerp)",category:"Combiners (CSG)",description:"Linear interpolation between shapes.",inputs:[{id:"factor",label:"Factor",min:0,max:1,step:.01,default:.5}],glsl:a=>`
${a.indent}${a.varName}_d = mix(${a.varName}_d, ${a.in2}_d, ${a.getParam("factor")});
${a.indent}${a.varName}_p = mix(${a.varName}_p, ${a.in2}_p, ${a.getParam("factor")});
${a.indent}${a.varName}_dr = mix(${a.varName}_dr, ${a.in2}_dr, ${a.getParam("factor")});
`});Ie.register({id:"Custom",label:"Custom (Legacy)",category:"Utils",description:"Legacy node.",inputs:[],glsl:a=>""});const rs=(a,t)=>{const o=new Set,r=["root-end"],n=new Set;for(;r.length>0;){const u=r.pop();if(n.has(u))continue;n.add(u),u!=="root-end"&&u!=="root-start"&&o.add(u),t.filter(h=>h.target===u).forEach(h=>r.push(h.source))}const i=a.filter(u=>o.has(u.id));if(!i||i.length===0)return`
        void formula_Modular(inout vec4 z, inout float dr, inout float trap, inout float distOverride, vec4 c, int i) {
            z.xyz += c.xyz;
            float r = length(z.xyz);
            trap = min(trap, r);
        }
        `;let s=`
    // --- Graph Init ---
    vec3 v_start_p = z.xyz;
    float v_start_d = 1000.0;
    float v_start_dr = dr; 
    
    vec3 v_curr_p = v_start_p;
    float v_curr_d = v_start_d;
    float v_curr_dr = v_start_dr;
    `;const l=new Map;l.set("root-start","v_start");let d=0;i.forEach((u,p)=>{const g=`v_${u.id.replace(/[^a-zA-Z0-9]/g,"")}`;l.set(u.id,g);const M=t.filter(k=>k.target===u.id),m=M.find(k=>!k.targetHandle||k.targetHandle==="a"),y=M.find(k=>k.targetHandle==="b"),x=m&&l.get(m.source)||"v_start",C=y&&l.get(y.source)||"v_start";if(s+=`    // Node: ${u.type} (${u.id})
`,s+=`    vec3 ${g}_p = ${x}_p;
`,s+=`    float ${g}_d = ${x}_d;
`,s+=`    float ${g}_dr = ${x}_dr;
`,u.enabled){const k=Ie.get(u.type);if(k){const S=u.condition&&u.condition.active;let b="    ";if(S){const j=Math.round(Math.max(1,u.condition.mod)),T=Math.round(u.condition.rem);s+=`    if ( (i - (i/${j})*${j}) == ${T} ) {
`,b="        "}const w=j=>u.bindings&&u.bindings[j]?`u${u.bindings[j]}`:d<ka?`uModularParams[${d++}]`:"0.0";s+=k.glsl({varName:g,in1:x,in2:C,getParam:w,indent:b}),S&&(s+=`    }
`)}}s+=`
`});const c=t.find(u=>u.target==="root-end");let f="v_start";return c&&c.source!=="root-start"&&(f=l.get(c.source)||"v_start"),s+=`
    z.xyz = ${f}_p;
    dr = ${f}_dr;
    
    float final_d = ${f}_d;
    if (final_d < 999.0 && final_d > -1.0) {
        distOverride = final_d;
    }
    
    trap = min(trap, length(z.xyz));
    `,`
void formula_Modular(inout vec4 z, inout float dr, inout float trap, inout float distOverride, vec4 c, int i) {
${s}
}
`},ns=(a,t)=>{t.fill(0);let o=0;const r=n=>{o<ka&&(t[o++]=n)};a.forEach(n=>{if(!n.enabled)return;const i=Ie.get(n.type);i&&i.inputs.forEach(s=>{if(!(n.bindings&&n.bindings[s.id])){const l=n.params[s.id]??s.default;r(l)}})})},is=a=>{let t="d = 0.5 * log(max(r, 1.0e-5)) * r / dr_safe;";return a<.5?t=`
        float logR2 = log2(m2);
        d = 0.17328679 * logR2 * r / dr_safe;
        `:a<1.5?t="d = (r - 1.0) / dr_safe;":a<2.5?t="d = r / dr_safe;":a<3.5?t=`
        float logR2 = log2(m2);
        d = 0.34657359 * logR2 * r / (dr_safe + 8.0);
        `:t="d = (r - 2.0) / dr_safe;",`
        vec2 getDist(float r, float dr, float iter, vec4 z) {
            float m2 = r * r;
            if (m2 < 1.0e-20) return vec2(0.0, iter);
            
            // Log Smoothing Calculation (Shared)
            // Guarded: Only calculate log smoothing if we have actually escaped (> 1.0)
            float smoothIter = iter;
            if (m2 > 1.0) {
                float threshLog = log2(max(uEscapeThresh, 1.1));
                smoothIter = iter + 1.0 - log2(log2(m2) / threshLog);
            }
            
            float d = 0.0;
            float dr_safe = max(abs(dr), 1.0e-20);
            
            ${t}
            
            return vec2(d, smoothIter);
        }`},ss={id:"coreMath",shortId:"cm",name:"Formula Math",category:"Formulas",tabConfig:{label:"Formula",componentId:"panel-formula",order:10},extraUniforms:[{name:ce.ModularParams,type:"float",arraySize:ka,default:new Float32Array(ka)}],params:{iterations:{type:"float",default:16,label:"Iterations",shortId:"it",uniform:"uIterations",min:1,max:500,step:1,group:"main"},paramA:{type:"float",default:8,label:"Param A",shortId:"pa",uniform:"uParamA",min:-10,max:10,step:.001,group:"params"},paramB:{type:"float",default:0,label:"Param B",shortId:"pb",uniform:"uParamB",min:-10,max:10,step:.001,group:"params"},paramC:{type:"float",default:0,label:"Param C",shortId:"pc",uniform:"uParamC",min:-10,max:10,step:.001,group:"params"},paramD:{type:"float",default:0,label:"Param D",shortId:"pd",uniform:"uParamD",min:-10,max:10,step:.001,group:"params"},paramE:{type:"float",default:0,label:"Param E",shortId:"pe",uniform:"uParamE",min:-10,max:10,step:.001,group:"params"},paramF:{type:"float",default:0,label:"Param F",shortId:"pf",uniform:"uParamF",min:-10,max:10,step:.001,group:"params"}},inject:(a,t)=>{var f;const o=t.formula,r=t.quality;o==="Modular"?(a.addDefine("FORMULA_ID",ts.toString()),a.addDefine("PIPELINE_REV",(t.pipelineRevision||0).toString())):a.addDefine("FORMULA_ID",es.toString()),["JuliaMorph","MandelTerrain"].includes(o)&&a.addDefine("SKIP_PRE_BAILOUT","1");const n=Le.get(o);let i="",s="",l="";const d=(r==null?void 0:r.estimator)||0;let c=is(d);if(o==="Modular"){const u=rs(t.pipeline||[],((f=t.graph)==null?void 0:f.edges)||[]);i+=u+`
`,s="formula_Modular(z, dr, trap, distOverride, c, i);"}else n&&(i+=n.shader.function+`
`,s=n.shader.loopBody,l=n.shader.loopInit||"",n.shader.getDist&&(c=`vec2 getDist(float r, float dr, float iter, vec4 z) { ${n.shader.getDist} }`));a.addFunction(i),a.setFormula(s,l,c)}},ls=(a,t)=>{if(!a)return`
        float GetSoftShadow(vec3 ro, vec3 rd, float k, float lightDist, float noise) { return 1.0; }
        float GetHardShadow(vec3 ro, vec3 rd, float lightDist) { return 1.0; }
        `;const o=256,r=t<1.5?`
        float t = 0.05;       
        float fudge = 1.0;
    `:`
        float t = 0.0;
        float fudge = uFudgeFactor; 
    `,n=t<1.5?`
            if(h < 0.005) return 0.0;
            res = min(res, k * h / t);
            t += max(h, 0.05); 
    `:`
            float thresh = max(1.0e-6, t * 0.0005); 
            if(h < thresh) return 0.0; 
            res = min(res, k * h / max(t, 1.0e-5));
            t += h * fudge;
    `;return`
// ------------------------------------------------------------------
// SHADOWS
// ------------------------------------------------------------------

// Classic Robust Soft Shadows
// Optimized: Noise is passed in to avoid texture fetch inside light loop
float GetSoftShadow(vec3 ro, vec3 rd, float k, float lightDist, float noise) {
    if (uShadowIntensity < 0.001) return 1.0;

    float res = 1.0;
    
    ${r}
    
    // Jitter starting position to break banding
    t += noise * 0.01;
    
    int limit = uShadowSteps;

    // Compiler Safety: Use constant max, break on dynamic uniform
    for(int i = 0; i < ${o}; i++) {
        if (i >= limit) break;

        // OPTIMIZATION: Use DE_Dist for geometry-only check
        float h = DE_Dist(ro + rd * t);
        ${n}
        if(t > lightDist) break;
    }
    return clamp(res, 0.0, 1.0); 
}

// Physically Accurate Hard Shadows (Used for Stochastic Area Lights)
float GetHardShadow(vec3 ro, vec3 rd, float lightDist) {
    #if defined(DISABLE_SHADOWS) && DISABLE_SHADOWS == 1
        return 1.0;
    #endif

    float t = 0.0; 
    float fudge = uFudgeFactor;
    int limit = uShadowSteps;
    
    for(int i = 0; i < ${o}; i++) {
        if (i >= limit) break;

        // OPTIMIZATION: Use DE_Dist for geometry-only check
        float h = DE_Dist(ro + rd * t);
        
        // Adaptive Epsilon:
        float thresh = max(1.0e-6, t * 0.0002);
        
        if(h < thresh) return 0.0; 
        
        t += h * fudge;
        
        if(t > lightDist) return 1.0;
    }
    
    return 1.0;
}
`},cs=`
// ------------------------------------------------------------------
// PBR HELPERS
// ------------------------------------------------------------------

// Simplified PBR Integration (Cook-Torrance / Blinn-Phong Hybrid)
// Returns the accumulated radiance from all direct lights.
vec3 calculatePBRContribution(vec3 p, vec3 n, vec3 v, vec3 albedo, float roughness, float metallic, float stochasticSeed, bool calcShadows) {
    // F0: Surface reflection at 0 degrees.
    // Dielectric: 0.04 (Linear). Metal: Albedo.
    vec3 F0 = mix(vec3(0.04), albedo, metallic);
    
    vec3 Lo = vec3(0.0);
    
    // Pixel size estimate for shadow bias
    float pixelSizeScale = length(uCamBasisY) / uResolution.y * 2.0 / uInternalScale;
    
    // Bias: Push start point away from surface
    float biasAmount = uShadowBias + pixelSizeScale * 2.0;
    vec3 shadowRo = p + n * biasAmount;

    // Stochastic Shadows: Allow them even when moving
    bool useStochasticShadows = (uPTStochasticShadows > 0.5);
    
    // COMPILER OPTIMIZATION: Prevent unrolling of light loop
    int lightCount = uLightCount;
    
    #ifndef MAX_LIGHTS
    #define MAX_LIGHTS 8
    #endif

    for (int i = 0; i < MAX_LIGHTS; i++) {
        if (i >= lightCount) break;
        
        float intensity = uLightIntensity[i];
        if (intensity < 0.01) continue;
        
        float type = uLightType[i]; // 0=Point, 1=Directional
        bool isDirectional = type > 0.5;
        
        vec3 lVec;
        float distToLight;
        
        if (isDirectional) {
             lVec = -uLightDir[i]; // Light comes from source
             distToLight = 10000.0; // Infinite
        } else {
             lVec = uLightPos[i] - p;
             distToLight = length(lVec);
             if (distToLight < 0.0001) continue; // Singularity check
        }

        // Optimization: Reuse distance for normalization if point light
        vec3 l = isDirectional ? normalize(lVec) : lVec / distToLight;
        
        vec3 h = normalize(l + v);
        
        float NdotL = max(0.0, dot(n, l));
        
        // BACKFACE CULLING
        if (NdotL <= 0.0) continue; 

        float HdotV = max(0.0, dot(h, v));
        float NdotH = max(0.0, dot(n, h));
        
        float shadow = 1.0;
        if (calcShadows && uShadows > 0.5 && uLightShadows[i] > 0.5) {
            float s = 1.0;
            
            if (useStochasticShadows) {
                 // --- VOGEL DISK SAMPLING (GOLDEN RATIO) ---
                 float samplingSeed = fract(stochasticSeed + float(i) * 1.618);
                 
                 vec3 w = l;
                 vec3 helperUp = abs(w.y) > 0.9 ? vec3(1.0, 0.0, 0.0) : vec3(0.0, 1.0, 0.0);
                 vec3 u = normalize(cross(w, helperUp));
                 vec3 v = cross(w, u);
                 
                 float r_jitter = sqrt(samplingSeed);
                 float theta = samplingSeed * 6.283185 * 1.618033;
                 
                 // Radius scaling
                 float spread = 2.0 / max(uShadowSoftness, 0.1); 
                 
                 vec3 offset = (u * cos(theta) + v * sin(theta)) * r_jitter * spread;
                 
                 // Apply jitter to direction
                 vec3 jitteredLDir = normalize(l + offset);
                 float jitteredDist = distToLight;
                 
                 // For Point lights, offset affects origin, not just angle
                 if (!isDirectional) {
                      vec3 jitteredTarget = uLightPos[i] + offset * distToLight; // Approximate sphere
                      vec3 jVec = jitteredTarget - p;
                      jitteredDist = length(jVec);
                      jitteredLDir = jVec / jitteredDist;
                 }
                 
                 s = GetHardShadow(shadowRo, jitteredLDir, jitteredDist);
            } else {
                 // Standard SDF Soft Shadows
                 s = GetSoftShadow(shadowRo, l, uShadowSoftness, distToLight, stochasticSeed);
            }
            shadow = mix(1.0, s, uShadowIntensity);
        }
        
        // Attenuation
        float att = 1.0;
        if (!isDirectional && uLightFalloff[i] > 0.001) {
            float k = uLightFalloff[i];
            if (uLightFalloffType[i] < 0.5) att = 1.0 / (1.0 + k * distToLight * distToLight);
            else att = 1.0 / (1.0 + k * distToLight);
        }
        
        // Specular (Blinn-Phong adapted for PBR look)
        vec3 F = F0 + (1.0 - F0) * pow(1.0 - HdotV, 5.0);
        float specPower = 2.0 / (max(roughness * roughness, 0.0001)) - 2.0;
        float spec = pow(NdotH, max(0.001, specPower)) * (specPower + 8.0) / (8.0 * 3.14159);
        
        // Energy Conservation
        vec3 kS = F;
        vec3 kD = vec3(1.0) - kS;
        
        // CORRECTION: Enforce physical metallic properties
        // Metals absorb refracted light (no diffuse).
        kD *= (1.0 - metallic);
        
        vec3 radiance = uLightColor[i] * intensity * att * shadow;
        
        // Combine Diffuse + Specular
        Lo += (kD * albedo * uDiffuse / 3.14159 + kS * spec * uSpecular) * radiance * NdotL;
    }
    
    return Lo;
}
`,ds=a=>`
// ------------------------------------------------------------------
// DIRECT LIGHTING INTEGRATOR (Multi-Bounce)
// ------------------------------------------------------------------
vec3 calculateShading(vec3 ro, vec3 rd, float d, vec4 result, float stochasticSeed) {
    vec3 p_ray = ro + rd * d;
    vec3 p_fractal = p_ray + uCameraPosition + uSceneOffsetLow + uSceneOffsetHigh;
    
    vec3 albedo, n, emission;
    float roughness;
    
    // 1. Primary Surface
    getSurfaceMaterial(p_ray, p_fractal, result, d, albedo, n, emission, roughness, true);
    
    vec3 v = normalize(-rd);
    
    // 2. Direct Light (Primary)
    vec3 directLighting = calculatePBRContribution(p_ray, n, v, albedo, roughness, uReflection, stochasticSeed, true);
    
    // 3. Ambient Occlusion (Primary)
    float ao = GetAO(p_ray, n, stochasticSeed);
    
    // 4. Fresnel & Reflection Setup
    vec3 F0 = mix(vec3(0.04), albedo, uReflection);
    float NdotV = max(0.0, dot(n, v));
    vec3 F = F0 + (max(vec3(1.0 - roughness), F0) - F0) * pow(1.0 - NdotV, 5.0);
    
    // 5. Reflection (Single Bounce - Flattened Loop)
    vec3 reflectionLighting = vec3(0.0);
    vec3 ambient = vec3(0.0);
    
    #ifdef REFLECTIONS_ENABLED
        vec3 currRo = p_ray + n * 0.01;
        vec3 currRd = reflect(-v, n);
        
        // Jitter first bounce based on roughness using Blue Noise
        bool isMoving = uBlendFactor >= 0.99;
        if (roughness > 0.05 && !isMoving) {
             // Sample blue noise texture. Use Blue/Alpha channels to decorrelate from Red/Green used elsewhere.
             vec4 blueNoise = getBlueNoise4(gl_FragCoord.xy);
             vec3 randomVec = vec3(blueNoise.b, blueNoise.a, blueNoise.r) * 2.0 - 1.0;
             
             if (dot(randomVec, randomVec) > 0.001) {
                 vec3 jittered = normalize(currRd + normalize(randomVec) * (roughness * 0.8));
                 if (dot(jittered, n) > 0.05) currRd = jittered;
             }
        }
        
        vec3 currentThroughput = F * uSpecular;
        
        if (roughness <= uReflRoughnessCutoff && dot(currentThroughput, currentThroughput) >= 0.01) {
            
            // Single Bounce Trace - No loops, just straight logic
            vec4 refHit = traceReflectionRay(currRo, currRd);
            
            if (refHit.x > 0.0) {
                // HIT
                float hitD = refHit.x;
                vec3 p_next = currRo + currRd * hitD;
                vec3 p_next_fractal = p_next + uCameraPosition + uSceneOffsetLow + uSceneOffsetHigh;
                
                vec3 r_albedo, r_n, r_emission;
                float r_rough;
                
                getSurfaceMaterial(p_next, p_next_fractal, vec4(0.0, refHit.yzw), hitD, r_albedo, r_n, r_emission, r_rough, false);
                
                vec3 hitColor = r_emission;
                hitColor += calculatePBRContribution(p_next, r_n, -currRd, r_albedo, r_rough, 0.0, stochasticSeed + 0.1, false);

                if (uFogFar < 1000.0) {
                    vec3 fogCol = InverseACESFilm(uFogColor);
                    float fogFactor = smoothstep(uFogNear, uFogFar, hitD);
                    hitColor = mix(hitColor, fogCol, fogFactor);
                }

                reflectionLighting += hitColor * currentThroughput;
                
            } else {
                // MISS -> Environment
                vec3 env = GetEnvMap(currRd, roughness) * uEnvStrength;
                
                if (uFogFar < 1000.0) {
                     vec3 fogCol = InverseACESFilm(uFogColor);
                     env = mix(env, fogCol, 0.8);
                }
                
                reflectionLighting += env * currentThroughput;
            }
        } else {
            // Roughness Fallback
            vec3 env = GetEnvMap(currRd, roughness) * uEnvStrength;
            if (uFogFar < 1000.0) env = mix(env, InverseACESFilm(uFogColor), 0.8);
            reflectionLighting += env * currentThroughput;
        }

        // Mix with Simple Env for softness
        vec3 simpleEnv = GetEnvMap(reflect(-v, n), roughness) * uEnvStrength;
        if (uFogFar < 1000.0) simpleEnv = mix(simpleEnv, InverseACESFilm(uFogColor), 0.8);
        
        reflectionLighting = mix(simpleEnv, reflectionLighting, uReflStrength);

    #else
        // Fallback: Simple Environment Map (Compilation branch optimization)
        vec3 envColor = GetEnvMap(reflect(-v, n), roughness) * uEnvStrength;
        reflectionLighting = envColor * F * uSpecular;
    #endif

    // 6. Rim
    float fresnelTerm = pow(1.0 - NdotV, uRimExponent);
    vec3 rimColor = vec3(0.5, 0.7, 1.0) * fresnelTerm * uRim;
    
    // 7. Ambient IBL
    if (uEnvStrength > 0.001) {
        vec3 envIrradiance = GetEnvMap(n, 1.0); 
        vec3 kD = (vec3(1.0) - F) * (1.0 - uReflection);
        ambient = kD * albedo * envIrradiance * uEnvStrength * uDiffuse;
    }

    // 8. Compose
    vec3 finalColor = directLighting + reflectionLighting + rimColor + emission + ambient;
    
    finalColor *= ao;
    
    return finalColor;
}
`,us=a=>`
// ------------------------------------------------------------------
// MONTE CARLO PBR PATH TRACER
// ------------------------------------------------------------------

float luminance(vec3 c) {
    return dot(c, vec3(0.2126, 0.7152, 0.0722));
}

vec3 cosineSampleHemisphere(vec3 n, vec2 seedVec) {
    float r = fract(seedVec.x * 1.61803398875); 
    float angle = seedVec.y * 6.283185; 
    vec2 p = vec2(sqrt(r) * cos(angle), sqrt(r) * sin(angle));
    vec3 u = normalize(cross(abs(n.z) < 0.999 ? vec3(0,0,1) : vec3(1,0,0), n));
    vec3 v = cross(n, u);
    float rz = sqrt(max(0.0, 1.0 - dot(p, p)));
    return normalize(u * p.x + v * p.y + n * rz);
}

vec3 importanceSampleGGX(vec3 n, float roughness, vec2 seedVec) {
    vec2 xi = vec2(
        fract(seedVec.x * 1.61803398875),
        fract(seedVec.y * 1.61803398875 + 0.5)
    );
    float a = roughness * roughness;
    float phi = 2.0 * 3.14159 * xi.x;
    float cosTheta = sqrt((1.0 - xi.y) / (1.0 + (a*a - 1.0) * xi.y));
    float sinTheta = sqrt(max(0.0, 1.0 - cosTheta*cosTheta));
    vec3 h = vec3(cos(phi) * sinTheta, sin(phi) * sinTheta, cosTheta);
    vec3 up = abs(n.z) < 0.999 ? vec3(0,0,1) : vec3(1,0,0);
    vec3 tangent = normalize(cross(up, n));
    vec3 bitangent = cross(n, tangent);
    return normalize(tangent * h.x + bitangent * h.y + n * h.z);
}

vec3 calculatePathTracedColor(vec3 ro, vec3 rd, float d_init, vec4 result_init, float seed) {
    vec3 radiance = vec3(0.0);
    vec3 throughput = vec3(1.0);
    vec3 currentRo = ro;
    vec3 currentRd = rd;
    float d = d_init;
    vec4 result = result_init;
    bool hit = true;
    int maxBounces = uPTBounces;
    float pixelSizeScale = length(uCamBasisY) / uResolution.y * 2.0 / uInternalScale;
    
    for (int bounce = 0; bounce < 8; bounce++) {
        if (bounce >= ${a?"2":"maxBounces"}) break;
        
        vec2 bounceOffset = vec2(float(bounce) * 17.123, float(bounce) * 23.456);
        vec4 blueNoise = getBlueNoise4(gl_FragCoord.xy + bounceOffset);

        if (!hit) {
            float skyIntensity = (bounce == 0) ? uEnvBackgroundStrength : uEnvStrength;
            vec3 env = GetEnvMap(currentRd, 0.0);
            if (bounce == 0) {
                float fogFactor = smoothstep(uFogNear, uFogFar, 100.0);
                vec3 safeFog = InverseACESFilm(uFogColor);
                vec3 sky = mix(env * skyIntensity, safeFog, fogFactor * 0.5);
                radiance += sky * throughput;
            } else {
                radiance += env * skyIntensity * throughput;
            }
            break;
        }
        
        vec3 p_ray = currentRo + currentRd * d;
        vec3 p_fractal = p_ray + uCameraPosition + uSceneOffsetLow + uSceneOffsetHigh;
        vec3 albedo, n, emission;
        float roughness;
        getSurfaceMaterial(p_ray, p_fractal, result, d, albedo, n, emission, roughness, bounce == 0);
        
        float ao = 1.0;
        if (uAOIntensity > 0.01 && bounce == 0) {
            ao = GetAO(p_ray, n, seed + float(bounce) * 13.37);
        }
        
        if (uRim > 0.01) {
            float NdotV_rim = max(0.0, dot(n, -currentRd));
            float rimFactor = pow(1.0 - NdotV_rim, uRimExponent) * uRim;
            emission += vec3(0.5, 0.7, 1.0) * rimFactor; 
        }

        roughness = max(roughness, 0.04);
        float emissionMult = (bounce == 0) ? 1.0 : uPTEmissionMult;
        radiance += (emission * ao * emissionMult) * throughput;
        
        // --- NEXT EVENT ESTIMATION ---
        {
            int activeCount = 0;
            int activeIndices[3];
            if (uLightIntensity[0] > 0.01) activeIndices[activeCount++] = 0;
            if (uLightIntensity[1] > 0.01) activeIndices[activeCount++] = 1;
            if (uLightIntensity[2] > 0.01) activeIndices[activeCount++] = 2;
            
            if (activeCount > 0) {
                float lightSeed = blueNoise.r;
                int pick = clamp(int(lightSeed * float(activeCount)), 0, activeCount - 1);
                int lightIdx = activeIndices[pick];
                
                float type = uLightType[lightIdx];
                bool isDirectional = type > 0.5;

                float distFromFractalOrigin = length(p_fractal);
                float floatLimit = max(1.0e-20, distFromFractalOrigin * 5.0e-7);
                float visualLimit = pixelSizeScale * d * (1.0 / uDetail);
                float biasEps = max(floatLimit, visualLimit);
                vec3 shadowRo = p_ray + n * (biasEps * 2.0 + uShadowBias);
                
                vec3 lVec;
                float distToLight;
                if (isDirectional) {
                     lVec = -uLightDir[lightIdx];
                     distToLight = 10000.0;
                } else {
                     lVec = uLightPos[lightIdx] - p_ray;
                     distToLight = length(lVec);
                }
                
                vec3 lDir = isDirectional ? normalize(lVec) : lVec / max(1.0e-5, distToLight);
                
                float shadow = 1.0;
                if (uShadows > 0.5 && uLightShadows[lightIdx] > 0.5) {
                    ${a?`
        shadow = GetSoftShadow(shadowRo, lDir, uShadowSoftness, distToLight, blueNoise.r);
    `:`
        if (uPTStochasticShadows > 0.5) {
            // Use blue noise for shadow jitter to ensure good distribution
            vec2 jitter = blueNoise.gb; // Use green and blue channels for decorrelation
            vec3 w = lDir;
            vec3 u = normalize(cross(w, abs(w.y) > 0.9 ? vec3(1,0,0) : vec3(0,1,0)));
            vec3 v = cross(w, u);
            
            // Softness acts as spread. For Directional: Angle. For Point: Size.
            float spread = 2.0 / max(uShadowSoftness, 0.1);
            
            float r = sqrt(jitter.x) * spread;
            float theta = jitter.y * 6.283185;
            
            vec3 offsetDir = u * cos(theta) * r + v * sin(theta) * r;
            vec3 shadowDir = normalize(lDir + offsetDir);
            float shadowDist = distToLight;
            
            if (!isDirectional) {
                 // For point lights, we jitter the target position
                 // Approximate sphere radius = spread * distance
                 float radius = spread * distToLight;
                 vec3 jitterOffset = (u * cos(theta) + v * sin(theta)) * sqrt(jitter.x) * radius;
                 vec3 targetPos = uLightPos[lightIdx] + jitterOffset;
                 vec3 tVec = targetPos - p_ray;
                 shadowDist = length(tVec);
                 shadowDir = tVec / max(1.0e-5, shadowDist);
            }
            
            shadow = GetHardShadow(shadowRo, shadowDir, shadowDist);
        } else {
            shadow = GetSoftShadow(shadowRo, lDir, uShadowSoftness, distToLight, blueNoise.r);
        }
    `}
                    shadow = mix(1.0, shadow, uShadowIntensity);
                }
                
                if (shadow > 0.01) {
                    vec3 v = -currentRd;
                    vec3 h = normalize(lDir + v);
                    float ndotl = max(0.0, dot(n, lDir));
                    float hdotv = max(0.0, dot(h, v));
                    float ndoth = max(0.0, dot(n, h));
                    
                    float att = 1.0;
                    if (!isDirectional && uLightFalloff[lightIdx] > 0.001) {
                        if (uLightFalloffType[lightIdx] < 0.5) att = 1.0 / (1.0 + uLightFalloff[lightIdx] * distToLight * distToLight);
                        else att = 1.0 / (1.0 + uLightFalloff[lightIdx] * distToLight);
                    }
                    
                    vec3 F0 = mix(vec3(0.04) * uSpecular, albedo, uReflection);
                    vec3 F = F0 + (1.0 - F0) * pow(1.0 - hdotv, 5.0);
                    float specPower = 2.0 / (roughness * roughness) - 2.0;
                    float spec = pow(ndoth, max(0.001, specPower)) * (specPower + 8.0) / (8.0 * 3.14159);
                    
                    vec3 kS = F;
                    vec3 kD = (vec3(1.0) - kS) * (1.0 - uReflection);
                    
                    float pdf = float(activeCount); 
                    vec3 lightCol = (kD * albedo * uDiffuse + kS * spec) * uLightColor[lightIdx] * uLightIntensity[lightIdx];
                    radiance += lightCol * ndotl * shadow * att * ao * pdf * throughput;
                }
            }
        } // End NEE
        
        float NdotV = max(0.0, dot(n, -currentRd));
        vec3 F0 = mix(vec3(0.04) * uSpecular, albedo, uReflection);
        vec3 F = F0 + (1.0 - F0) * pow(1.0 - NdotV, 5.0);
        vec3 kS = F;
        vec3 kD = (vec3(1.0) - kS) * (1.0 - uReflection);
        vec3 weightSpec = kS;
        vec3 weightDiff = kD * albedo * uDiffuse; 
        float lumSpec = luminance(weightSpec);
        float lumDiff = luminance(weightDiff);
        float probSpec = lumSpec / max(0.0001, lumSpec + lumDiff);
        float smoothness = 1.0 - roughness; 
        probSpec = mix(probSpec, 1.0, smoothness * 0.4);
        probSpec = clamp(probSpec, 0.05, 0.95);
        float randType = fract(blueNoise.a * 1.618);
        vec2 dirSeed = blueNoise.gb;

        if (randType < probSpec) {
            vec3 H = importanceSampleGGX(n, roughness, dirSeed);
            currentRd = reflect(currentRd, H);
            throughput *= F / probSpec;
            if (dot(currentRd, n) < 0.0) currentRd = cosineSampleHemisphere(n, dirSeed); 
        } else {
            currentRd = cosineSampleHemisphere(n, dirSeed);
            throughput *= (weightDiff * ao) / (1.0 - probSpec);
        }
        
        throughput *= uPTGIStrength;
        float floatLimit = max(1.0e-20, length(p_fractal) * 5.0e-7);
        float visualLimit = pixelSizeScale * d * (1.0 / uDetail);
        float biasEps = max(floatLimit, visualLimit);
        currentRo = p_ray + n * (biasEps * 2.0); 
        float volumetric = 0.0;
        vec3 dummyGlow = vec3(0.0);
        hit = traceScene(currentRo, currentRd, d, result, dummyGlow, seed + float(bounce), volumetric);
        
        if (uFogDensity > 0.001) {
             vec3 fogCol = InverseACESFilm(uFogColor);
             float trans = exp(-volumetric * 2.0);
             radiance += fogCol * (1.0 - trans) * throughput;
             throughput *= trans;
        }
        
        if (bounce > 2) {
            float maxThroughput = max(throughput.r, max(throughput.g, throughput.b));
            if (maxThroughput < 0.05) { 
                if (randType > maxThroughput * 10.0) break;
                throughput /= (maxThroughput * 10.0);
            }
        }
        throughput = min(throughput, vec3(4.0)); 
    }
    return radiance;
}
`,Dt=(a,t)=>!a||!a.lights||t>=a.lights.length?{type:"Point",position:{x:0,y:0,z:0},rotation:{x:0,y:0,z:0},color:"#ffffff",intensity:0,falloff:0,falloffType:"Quadratic",fixed:!1,visible:!1,castShadow:!0}:a.lights[t],fs=[{type:"Point",position:{x:-2,y:1,z:2},rotation:{x:0,y:0,z:0},color:"#ffffff",intensity:1.5,falloff:0,falloffType:"Quadratic",fixed:!1,visible:!0,castShadow:!0},{type:"Point",position:{x:2,y:-1,z:1},rotation:{x:0,y:0,z:0},color:"#ff8800",intensity:.5,falloff:0,falloffType:"Quadratic",fixed:!1,visible:!1,castShadow:!0},{type:"Point",position:{x:0,y:-5,z:2},rotation:{x:0,y:0,z:0},color:"#0088ff",intensity:.25,falloff:0,falloffType:"Quadratic",fixed:!0,visible:!1,castShadow:!0}],ps={id:"lighting",shortId:"l",name:"Lighting",category:"Rendering",tabConfig:{label:"Light",componentId:"panel-light",order:30,condition:{param:"$advancedMode",bool:!0}},viewportConfig:{componentId:"overlay-lighting",renderOrder:50,type:"dom"},engineConfig:{toggleParam:"advancedLighting",mode:"compile",label:"Lighting Engine",groupFilter:"engine_settings"},extraUniforms:[{name:ce.LightCount,type:"int",default:0},{name:ce.LightType,type:"float",arraySize:He,default:new Float32Array(He).fill(0)},{name:ce.LightPos,type:"vec3",arraySize:He,default:new Array(He).fill(new ie)},{name:ce.LightDir,type:"vec3",arraySize:He,default:new Array(He).fill(new ie(0,-1,0))},{name:ce.LightColor,type:"vec3",arraySize:He,default:new Array(He).fill(new $e(1,1,1))},{name:ce.LightIntensity,type:"float",arraySize:He,default:new Float32Array(He).fill(0)},{name:ce.LightShadows,type:"float",arraySize:He,default:new Float32Array(He).fill(0)},{name:ce.LightFalloff,type:"float",arraySize:He,default:new Float32Array(He).fill(0)},{name:ce.LightFalloffType,type:"float",arraySize:He,default:new Float32Array(He).fill(0)}],params:{advancedLighting:{type:"boolean",default:!0,label:"Light Engine",shortId:"le",group:"main",noReset:!0,hidden:!0,description:"Master switch for lighting logic. Disabling provides stubs only."},ptEnabled:{type:"boolean",default:!0,label:"Path Tracing Core",shortId:"pe",group:"engine_settings",ui:"checkbox",description:"Compiles the Path Tracing module. Disable to reduce shader size.",onUpdate:"compile",noReset:!0},renderMode:{type:"float",default:0,label:"Active Mode",shortId:"rm",group:"engine_settings",parentId:"ptEnabled",options:[{label:"Direct (Fast)",value:0},{label:"Path Tracing (GI)",value:1}],description:"Switches between fast direct lighting and physically based Global Illumination.",onUpdate:"compile",noReset:!0},ptBounces:{type:"int",default:3,label:"Max Bounces",shortId:"pb",uniform:"uPTBounces",min:1,max:8,step:1,group:"engine_settings",parentId:"ptEnabled",ui:"numeric",description:"Recursion depth. Higher = Brighter interiors, Slower render."},ptGIStrength:{type:"float",default:1,label:"GI Strength",shortId:"pg",uniform:"uPTGIStrength",min:0,max:5,step:.01,group:"engine_settings",parentId:"ptEnabled",description:"Artistic boost for bounced light intensity."},shadowsCompile:{type:"boolean",default:!0,label:"Shadow Engine",shortId:"sc",group:"engine_settings",ui:"checkbox",noReset:!0,onUpdate:"compile",description:"Compiles the shadow raymarching loop. Disable to save code size."},shadowAlgorithm:{type:"float",default:0,label:"Algorithm",shortId:"sa",group:"engine_settings",parentId:"shadowsCompile",options:[{label:"Robust",value:0},{label:"Fast (Lite)",value:1}],onUpdate:"compile",noReset:!0},ptStochasticShadows:{type:"boolean",default:!1,label:"Area Lights (Stochastic)",shortId:"ps",uniform:"uPTStochasticShadows",group:"engine_settings",parentId:"shadowsCompile",ui:"checkbox",description:"Treats lights as physical spheres. Creates realistic penumbras. Requires Accumulation."},shadows:{type:"boolean",default:!0,label:"Enable",shortId:"sh",group:"main",uniform:"uShadows",ui:"checkbox",condition:{param:"shadowsCompile",bool:!0}},shadowIntensity:{type:"float",default:1,label:"Opacity",shortId:"si",uniform:"uShadowIntensity",min:0,max:1,step:.01,group:"shadows",condition:{bool:!0}},shadowSoftness:{type:"float",default:16,label:"Softness",shortId:"ss",uniform:"uShadowSoftness",min:2,max:2e3,step:1,group:"shadows",scale:"log",condition:{bool:!0}},shadowSteps:{type:"int",default:128,label:"Steps",shortId:"st",min:16,max:512,step:16,group:"shadows",condition:{bool:!0},uniform:"uShadowSteps",ui:"numeric",description:"Quality vs Performance."},shadowBias:{type:"float",default:.002,label:"Bias",shortId:"sb",uniform:"uShadowBias",min:0,max:1,step:1e-6,group:"shadows",scale:"log",condition:{bool:!0},description:"Prevents surface acne."},lights:{type:"complex",default:fs,label:"Light List",shortId:"ll",group:"data",hidden:!0,noReset:!0}},inject:(a,t,o)=>{if(o!=="Main"){a.addPostDEFunction(`
             float GetSoftShadow(vec3 ro, vec3 rd, float k, float lightDist, float noise) { return 1.0; }
             float GetHardShadow(vec3 ro, vec3 rd, float lightDist) { return 1.0; }
             vec3 calculateShading(vec3 ro, vec3 rd, float d, vec4 result, float stochasticSeed) { return vec3(0.0); }
             vec3 calculatePathTracedColor(vec3 ro, vec3 rd, float d_init, vec4 result_init, float seed) { return vec3(0.0); }
             `);return}a.addDefine("MAX_LIGHTS",He.toString());const r=t.lighting;if(r&&r.advancedLighting===!1){a.addPostDEFunction(`
             float GetSoftShadow(vec3 ro, vec3 rd, float k, float lightDist) { return 1.0; }
             float GetHardShadow(vec3 ro, vec3 rd, float lightDist) { return 1.0; }
             vec3 calculateShading(vec3 ro, vec3 rd, float d, vec4 result, float stochasticSeed) { return vec3(0.0); }
             vec3 calculatePathTracedColor(vec3 ro, vec3 rd, float d_init, vec4 result_init, float seed) { return vec3(0.0); }
             `);return}const n=(r==null?void 0:r.shadowsCompile)!==!1,i=(r==null?void 0:r.shadowAlgorithm)===1?1:2;a.addPostDEFunction(ls(n,i)),!n&&!(r!=null&&r.shadows)?a.addDefine("DISABLE_SHADOWS","1"):a.addDefine("SHADOW_QUALITY","2"),(r==null?void 0:r.ptEnabled)!==!1&&a.addDefine("PT_ENABLED","1");const s=t.renderMode==="PathTracing"||(r==null?void 0:r.renderMode)===1,l=t.quality,d=(l==null?void 0:l.precisionMode)===1;s?(a.setRenderMode("PathTracing"),a.addDefine("RENDER_MODE_PATHTRACING","1"),a.addIntegrator(us(d))):(a.setRenderMode("Direct"),a.addIntegrator(cs),a.addIntegrator(ds()))},actions:{updateLight:(a,t)=>{const{index:o,params:r}=t;if(!a.lights||o>=a.lights.length)return{};const n=[...a.lights];return n[o]={...n[o],...r},{lights:n}},addLight:a=>{if(a.lights.length>=He)return{};const t={type:"Point",position:{x:0,y:0,z:2},rotation:{x:0,y:0,z:0},color:"#ffffff",intensity:1,falloff:0,falloffType:"Quadratic",fixed:!1,visible:!0,castShadow:!0};return{lights:[...a.lights,t]}},removeLight:(a,t)=>{if(t<0||t>=a.lights.length)return{};const o=[...a.lights];return o.splice(t,1),{lights:o}}}},hs={id:"optics",shortId:"o",name:"Camera Optics",category:"Scene",tabConfig:{label:"Scene",componentId:"panel-scene",order:20},customUI:[{componentId:"optics-controls",group:"dof"}],params:{camType:{type:"float",default:0,label:"Projection",shortId:"ct",uniform:"uCamType",group:"projection",options:[{label:"Perspective",value:0},{label:"Orthographic",value:1},{label:"360 Skybox",value:2}]},camFov:{type:"float",default:60,label:"Field of View",shortId:"fv",min:10,max:150,step:1,group:"projection",hidden:!0,condition:{param:"camType",eq:0}},orthoScale:{type:"float",default:2,label:"Ortho Scale",shortId:"os",min:.1,max:10,step:.1,scale:"log",group:"projection",condition:{param:"camType",eq:1}},dofStrength:{type:"float",default:0,label:"Camera Blur",shortId:"ds",uniform:"uDOFStrength",min:0,max:1,step:1e-4,scale:"log",group:"dof",format:a=>a===0?"0.0 (off)":Math.abs(a)<.001?a.toFixed(5):Math.abs(a)<10?a.toFixed(4):a.toFixed(2)},dofFocus:{type:"float",default:10,label:"Focus Distance",shortId:"df",uniform:"uDOFFocus",min:1e-6,max:1e4,step:1e-6,scale:"log",group:"dof",parentId:"dofStrength",condition:{gt:0}}}},ms={id:"navigation",shortId:"n",name:"Navigation",category:"Scene",customUI:[{componentId:"navigation-controls",group:"controls"}],params:{flySpeed:{type:"float",default:.5,label:"Fly Speed %",shortId:"fs",min:.001,max:1,step:.001,group:"movement",format:a=>`${(a*100).toFixed(1)}%`},autoSlow:{type:"boolean",default:!0,label:"Auto-slow on collision",shortId:"as",group:"movement"}}},gs={id:"audio",shortId:"au",name:"Audio",category:"Audio",tabConfig:{label:"Audio",componentId:"panel-audio",order:70,condition:{param:"isEnabled",bool:!0}},menuConfig:{label:"Audio Modulation",toggleParam:"isEnabled"},params:{isEnabled:{type:"boolean",default:!1,label:"Enable Audio Engine",shortId:"en",group:"system",noReset:!0},smoothing:{type:"float",default:.8,label:"FFT Smoothing",shortId:"sm",group:"system",noReset:!0,min:0,max:.99,step:.01},threshold:{type:"float",default:.1,label:"Gate Threshold",shortId:"gt",group:"hidden",hidden:!0,noReset:!0},agcEnabled:{type:"boolean",default:!1,label:"AGC",shortId:"ag",group:"hidden",hidden:!0,noReset:!0},attack:{type:"float",default:.1,label:"Global Attack",shortId:"ga",group:"hidden",hidden:!0,noReset:!0},decay:{type:"float",default:.3,label:"Global Decay",shortId:"gd",group:"hidden",hidden:!0,noReset:!0},highPass:{type:"float",default:20,label:"High Pass",shortId:"hp",group:"hidden",hidden:!0,noReset:!0},lowPass:{type:"float",default:2e4,label:"Low Pass",shortId:"lp",group:"hidden",hidden:!0,noReset:!0},gain:{type:"float",default:1,label:"Global Gain",shortId:"gn",group:"hidden",hidden:!0,noReset:!0}},shader:{uniforms:""}},xs={id:"drawing",shortId:"dr",name:"Drawing Tools",category:"Tools",tabConfig:{label:"Drawing",componentId:"panel-drawing",order:80,condition:{param:"enabled",bool:!0}},viewportConfig:{componentId:"overlay-drawing",type:"scene"},menuConfig:{label:"Drawing Tools",toggleParam:"enabled"},interactionConfig:{blockCamera:!0,activeParam:"active"},params:{enabled:{type:"boolean",default:!1,label:"Show Tab",shortId:"en",group:"system",hidden:!0,noReset:!0},active:{type:"boolean",default:!1,label:"Enable Tool",shortId:"ac",group:"main",noReset:!0,hidden:!0},activeTool:{type:"float",default:0,label:"Tool Type",shortId:"tt",group:"main",noReset:!0,hidden:!0},originMode:{type:"float",default:1,label:"Origin Plane",shortId:"om",group:"settings",noReset:!0,options:[{label:"Global Zero",value:0},{label:"Surface (Probe)",value:1}],description:"Where the drawing plane starts."},color:{type:"color",default:new $e("#00ffff"),label:"Line Color",shortId:"cl",group:"settings",noReset:!0},lineWidth:{type:"float",default:1,label:"Line Width",shortId:"lw",min:1,max:10,step:1,group:"settings",noReset:!0,hidden:!0},showLabels:{type:"boolean",default:!0,label:"Show Measurements",shortId:"sl",group:"settings",noReset:!0},showAxes:{type:"boolean",default:!1,label:"Show Axis Ruler",shortId:"ax",group:"settings",noReset:!0,description:"Displays a reference grid at the drawing origin."},shapes:{type:"complex",default:[],label:"Shapes",shortId:"sh",group:"data",hidden:!0,noReset:!0},refreshTrigger:{type:"float",default:0,label:"Refresh Trigger",group:"system",hidden:!0,noReset:!0}},state:{activeTool:"rect"},actions:{addDrawnShape:(a,t)=>({shapes:[...a.shapes||[],t]}),removeDrawnShape:(a,t)=>({shapes:(a.shapes||[]).filter(o=>o.id!==t)}),updateDrawnShape:(a,t)=>({shapes:(a.shapes||[]).map(o=>o.id===t.id?{...o,...t.updates}:o)}),clearDrawnShapes:a=>({shapes:[]})},shader:{}},ys="useandom-26T198340PX75pxJACKVERYMINDBUSHWOLF_GQZbfghjklqvwyzrict";let tt=(a=21)=>{let t="",o=crypto.getRandomValues(new Uint8Array(a|=0));for(;a--;)t+=ys[o[a]&63];return t};const Do=["#ef4444","#f97316","#f59e0b","#84cc16","#22c55e","#06b6d4","#3b82f6","#8b5cf6","#d946ef","#f43f5e"],bs={id:"modulation",shortId:"mod",name:"Modulation",category:"System",state:{rules:[],selectedRuleId:null},actions:{addModulation:(a,t)=>{const o=Do[a.rules.length%Do.length],r={id:tt(),target:t.target,source:t.source||"audio",enabled:!0,color:o,freqStart:0,freqEnd:.2,thresholdMin:.1,thresholdMax:1,attack:.1,decay:.3,smoothing:0,gain:1,offset:0};return{rules:[...a.rules,r],selectedRuleId:r.id}},removeModulation:(a,t)=>({rules:a.rules.filter(o=>o.id!==t),selectedRuleId:a.selectedRuleId===t?null:a.selectedRuleId}),updateModulation:(a,t)=>({rules:a.rules.map(o=>o.id===t.id?{...o,...t.update}:o)}),selectModulation:(a,t)=>({selectedRuleId:t})},params:{rules:{type:"complex",default:[],label:"Rules",shortId:"rl",group:"data",hidden:!0,noReset:!0},selectedRuleId:{type:"complex",default:null,label:"Selection",shortId:"sr",group:"data",hidden:!0,noReset:!0}}},vs={id:"webcam",shortId:"wc",name:"Webcam Overlay",category:"Tools",viewportConfig:{componentId:"overlay-webcam",type:"dom"},menuConfig:{label:"Webcam Overlay",toggleParam:"isEnabled",advancedOnly:!0},params:{isEnabled:{type:"boolean",default:!1,label:"Enabled",shortId:"en",group:"system",noReset:!0},opacity:{type:"float",default:1,label:"Opacity",shortId:"op",min:0,max:3,step:.05,group:"visual",noReset:!0},posX:{type:"float",default:20,label:"Position X",shortId:"px",min:0,max:2e3,step:1,group:"transform",noReset:!0,hidden:!0},posY:{type:"float",default:80,label:"Position Y",shortId:"py",min:0,max:2e3,step:1,group:"transform",noReset:!0,hidden:!0},width:{type:"float",default:320,label:"Width",shortId:"w",min:50,max:1200,step:1,group:"transform",noReset:!0,hidden:!0},height:{type:"float",default:240,label:"Height",shortId:"h",min:50,max:1200,step:1,group:"transform",noReset:!0,hidden:!0},cropL:{type:"float",default:0,label:"Crop Left",shortId:"cl",min:0,max:.45,step:.01,group:"crop",noReset:!0,hidden:!0},cropR:{type:"float",default:0,label:"Crop Right",shortId:"cr",min:0,max:.45,step:.01,group:"crop",noReset:!0,hidden:!0},cropT:{type:"float",default:0,label:"Crop Top",shortId:"ct",min:0,max:.45,step:.01,group:"crop",noReset:!0,hidden:!0},cropB:{type:"float",default:0,label:"Crop Bottom",shortId:"cb",min:0,max:.45,step:.01,group:"crop",noReset:!0,hidden:!0},blendMode:{type:"float",default:0,label:"Blend Mode",shortId:"bm",group:"visual",noReset:!0,options:[{label:"Normal",value:0},{label:"Screen",value:1},{label:"Overlay",value:2},{label:"Lighten",value:3},{label:"Difference",value:4}]},crtMode:{type:"boolean",default:!1,label:"CRT Scanlines",shortId:"sc",group:"visual",noReset:!0},tilt:{type:"float",default:0,label:"3D Tilt",shortId:"tl",min:-45,max:45,step:1,group:"transform",noReset:!0},fontSize:{type:"float",default:12,label:"Overlay Font Size",shortId:"fs",min:8,max:32,step:1,group:"visual",noReset:!0}}},ws={id:"debugTools",shortId:"dt",name:"Debug Tools",category:"System",viewportConfig:{componentId:"overlay-debug-tools",type:"dom",renderOrder:100},menuItems:[{label:"GLSL Debugger",toggleParam:"shaderDebuggerOpen",icon:"Code",advancedOnly:!0},{label:"State Debugger",toggleParam:"stateDebuggerOpen",icon:"Info",advancedOnly:!0}],params:{shaderDebuggerOpen:{type:"boolean",default:!1,label:"GLSL Debugger",shortId:"sd",group:"tools",noReset:!0},stateDebuggerOpen:{type:"boolean",default:!1,label:"State Debugger",shortId:"st",group:"tools",noReset:!0}}},Lt={fastest:{lighting:{shadows:!1,shadowsCompile:!1,ptEnabled:!1},ao:{aoEnabled:!1,aoStochasticCp:!1},geometry:{hybridComplex:!1,preRotMaster:!1,preRotEnabled:!1},reflections:{enabled:!1},quality:{precisionMode:1,bufferPrecision:1,compilerHardCap:128},atmosphere:{glowEnabled:!1}},lite:{lighting:{shadows:!0,shadowAlgorithm:1,shadowSteps:16,ptStochasticShadows:!1,shadowSoftness:16,ptEnabled:!1},ao:{aoEnabled:!0,aoSamples:2,aoStochasticCp:!1,aoMode:!1,aoMaxSamples:16},geometry:{hybridComplex:!1,preRotMaster:!1,preRotEnabled:!1},reflections:{enabled:!1},quality:{precisionMode:1,bufferPrecision:1},atmosphere:{glowQuality:1}},balanced:{lighting:{shadows:!0,shadowAlgorithm:0,shadowSoftness:16,ptStochasticShadows:!1,shadowSteps:128},ao:{aoEnabled:!0,aoSamples:5,aoStochasticCp:!0,aoMode:!0,aoMaxSamples:32},geometry:{hybridComplex:!1,preRotMaster:!0,preRotEnabled:!0},reflections:{enabled:!0,steps:32,bounces:1},quality:{precisionMode:0,bufferPrecision:0},atmosphere:{glowQuality:0}},ultra:{lighting:{shadows:!0,shadowAlgorithm:0,shadowSoftness:64,ptStochasticShadows:!0,shadowSteps:256},ao:{aoEnabled:!0,aoSamples:8,aoStochasticCp:!0,aoMode:!0,aoMaxSamples:64},reflections:{enabled:!0,steps:64,bounces:2},geometry:{hybridComplex:!0,preRotMaster:!0,preRotEnabled:!0},quality:{precisionMode:0,bufferPrecision:0},atmosphere:{glowQuality:0}}},lo=a=>{for(const[t,o]of Object.entries(Lt)){let r=!0;for(const[n,i]of Object.entries(o)){const s=a[n];if(!s){r=!1;break}for(const[l,d]of Object.entries(i)){const c=s[l];if(typeof d=="number"&&typeof c=="number"){if(Math.abs(d-c)>.001){r=!1;break}}else if(d!==c){r=!1;break}}if(!r)break}if(r)return t}return"custom"},Ss={id:"engineSettings",shortId:"eng",name:"Engine Config",category:"System",tabConfig:{label:"Engine",componentId:"panel-engine",order:5,condition:{param:"showEngineTab",bool:!0}},params:{showEngineTab:{type:"boolean",default:!1,label:"Show Engine Tab",shortId:"se",group:"system",noReset:!0,hidden:!0}},actions:{applyPreset:(a,t)=>{const{mode:o,actions:r}=t,n=Lt[o];return n?(Object.entries(n).forEach(([i,s])=>{const l=`set${i.charAt(0).toUpperCase()+i.slice(1)}`,d=r[l];typeof d=="function"&&d(s)}),{}):{}}}},Ms=(a,t,o=32)=>{if(!a)return`
        float GetAO(vec3 p, vec3 n, float seed) { return 1.0; }
        `;let r="";return t&&(r=`
        vec3 getCosHemisphereDir(vec3 n, vec2 seedVec) {
            // Use provided vector (Blue Noise Green/Alpha) instead of calculating hash
            vec2 r = seedVec;
            
            float sign = n.z >= 0.0 ? 1.0 : -1.0;
            float a = -1.0 / (sign + n.z);
            float b = n.x * n.y * a;
            vec3 tangent = vec3(1.0 + sign * n.x * n.x * a, sign * b, -sign * n.x);
            vec3 bitangent = vec3(b, sign + n.y * n.y * a, -n.y);
            
            float ra = sqrt(r.y);
            float rx = ra * cos(6.2831 * r.x);
            float ry = ra * sin(6.2831 * r.x);
            float rz = sqrt(1.0 - r.y);
            return normalize(rx * tangent + ry * bitangent + rz * n);
        }`),`
// ------------------------------------------------------------------
// AMBIENT OCCLUSION (Modular Feature)
// ------------------------------------------------------------------

${r}

float GetAO(vec3 p_ray, vec3 n, float seed) {
    if (uAOIntensity < 0.001) return 1.0;

    float occ = 0.0;
    float weight = 1.0;
    float spread = max(uAOSpread, 0.001);
    
    bool isMoving = uBlendFactor >= 0.99;
    bool isStochastic = uAOMode > 0.5;
    
    // Sample Blue Noise Texture
    vec4 blueNoise = getBlueNoise4(gl_FragCoord.xy);
    
    // Green channel for standard jitter
    float jitter = blueNoise.g;
    
    #if defined(RENDER_MODE_PATHTRACING)
        jitter = fract(seed * 13.5 + blueNoise.g);
    #endif

    vec3 dir = n;
    bool useRandomDir = isStochastic;
    
    #if !defined(RENDER_MODE_PATHTRACING)
        if (isMoving) useRandomDir = false;
    #endif

    #if ${t?1:0}
        if (useRandomDir) {
            // Use Green and Alpha channels for 2D direction sampling
            dir = getCosHemisphereDir(n, blueNoise.ga);
        } else if (isStochastic) {
            dir = normalize(mix(n, getCosHemisphereDir(n, vec2(0.123, 0.456)), 0.5));
        }
    #endif
    
    vec3 p_bias = p_ray;
    float totalWeight = 0.0;
    int limit = uAOSamples;

    // Use dynamic limit injected from DDFS
    for(int i = 0; i < ${o}; i++) {
        if (i >= limit) break;

        float h = (0.1 + 0.5 * float(i) / 4.0) * spread;
        h += (jitter * 0.1) * spread; 
        
        vec3 aopos = p_bias + dir * h;
        
        // OPTIMIZATION: Use DE_Dist for geometry-only check
        float d = DE_Dist(aopos);
        
        if (d < h) {
            float diff = h - d;
            occ += diff * weight;
        }
        
        totalWeight += h * weight;
        weight *= 0.8; 
    }
    
    occ /= (totalWeight + 0.0001);
    
    return clamp(1.0 - (occ * uAOIntensity * 2.5), 0.0, 1.0);
}
`},Cs={id:"ao",shortId:"ao",name:"Ambient Occlusion",category:"Lighting",engineConfig:{toggleParam:"aoEnabled",mode:"compile",label:"Ambient Occlusion",groupFilter:"engine_settings"},params:{aoIntensity:{type:"float",default:.2,label:"Ambient Occlusion",shortId:"ai",uniform:"uAOIntensity",min:0,max:5,step:.001,scale:"log",group:"shading",condition:{param:"aoEnabled",bool:!0}},aoSpread:{type:"float",default:.5,label:"Spread",shortId:"as",uniform:"uAOSpread",scale:"log",min:.01,max:2,step:.01,group:"shading",parentId:"aoIntensity",condition:[{param:"aoEnabled",bool:!0},{param:"aoIntensity",gt:0}]},aoSamples:{type:"int",default:5,label:"Samples",shortId:"ap",min:2,max:32,step:1,group:"shading",uniform:"uAOSamples",ui:"numeric",parentId:"aoIntensity",description:"Iterations per pixel. Runtime controlled.",condition:[{param:"aoEnabled",bool:!0},{param:"aoIntensity",gt:0}]},aoMode:{type:"boolean",default:!0,label:"Stochastic Mode",shortId:"am",uniform:"uAOMode",group:"shading",parentId:"aoIntensity",condition:[{param:"aoEnabled",bool:!0},{param:"aoIntensity",gt:0},{param:"aoStochasticCp",bool:!0}],description:"Switches between Fixed and Stochastic sampling at runtime."},aoMaxSamples:{type:"int",default:32,label:"Max Samples (Hard Cap)",shortId:"amx",min:16,max:256,step:16,group:"engine_settings",ui:"numeric",description:"Compile-time limit. Increasing this allows higher runtime samples but compiles slower.",onUpdate:"compile",noReset:!0,condition:[{param:"aoEnabled",bool:!0}]},aoStochasticCp:{type:"boolean",default:!0,label:"Load Stochastic Sampling",shortId:"sc",group:"engine_settings",ui:"checkbox",description:"Compiles High-Quality noise logic into the shader.",onUpdate:"compile",noReset:!0},aoEnabled:{type:"boolean",default:!0,label:"Enable AO",shortId:"ae",group:"main",hidden:!0,noReset:!0,onUpdate:"compile"}},inject:(a,t,o)=>{if(o!=="Main"){a.addPostDEFunction("float GetAO(vec3 p, vec3 n, float seed) { return 1.0; }");return}const r=t.ao,n=(r==null?void 0:r.aoEnabled)!==!1,i=(r==null?void 0:r.aoStochasticCp)!==!1,s=(r==null?void 0:r.aoMaxSamples)||32;a.addPostDEFunction(Ms(n,i,s))}},ks=()=>`
// ------------------------------------------------------------------
// REFLECTIONS (Forge Kernel)
// ------------------------------------------------------------------

// Lightweight Raymarcher for Reflection Bounce
vec4 traceReflectionRay(vec3 ro, vec3 rd) {
    float t = 0.01; // Start offset
    
    // Dynamic loop
    int limit = uReflSteps;

    for(int i=0; i<256; i++) {
        if (i >= limit) break;
        
        // OPTIMIZATION: Use Geometry-only estimator for marching
        // This skips Orbit Traps, Decomposition, and Color Smoothing logic
        float d = DE_Dist(ro + rd * t);
        
        if(d < 0.002 * t) {
            // HIT
            // Now we calculate the heavy Orbit Traps ONCE at the impact point
            vec4 fullRes = DE(ro + rd * t);
            return vec4(t, fullRes.yzw);
        }
        t += d;
        if(t > MAX_DIST) break;
    }
    return vec4(-1.0); // MISS
}
    `,js={id:"reflections",shortId:"rf",name:"Reflections",category:"Rendering",engineConfig:{toggleParam:"enabled",mode:"compile",label:"Reflection Tracing",groupFilter:"engine_settings"},params:{mixStrength:{type:"float",default:1,label:"Raymarch Mix",shortId:"rm",uniform:"uReflStrength",min:0,max:1,step:.01,group:"engine_settings",condition:{param:"enabled",bool:!0},description:"Blends between Raymarched Reflections (1.0) and Environment Map (0.0)."},roughnessThreshold:{type:"float",default:.5,label:"Roughness Cutoff",shortId:"rc",uniform:"uReflRoughnessCutoff",min:0,max:1,step:.01,group:"engine_settings",condition:{param:"enabled",bool:!0},description:"Surfaces rougher than this will skip raymarching to save performance."},bounces:{type:"int",default:1,label:"Max Bounces",shortId:"rb",min:1,max:3,step:1,group:"engine_settings",uniform:"uReflBounces",ui:"numeric",description:"Maximum recursion depth. Clamped to 3. Default 1 for performance.",noReset:!0,onUpdate:"compile"},steps:{type:"int",default:64,label:"Trace Steps",shortId:"rs",min:16,max:128,step:8,group:"engine_settings",uniform:"uReflSteps",ui:"numeric",description:"Precision of the reflection ray.",noReset:!0},enabled:{type:"boolean",default:!0,label:"Enable Reflections",shortId:"re",group:"main",hidden:!0,noReset:!0,onUpdate:"compile"}},inject:(a,t,o)=>{if(o!=="Main")return;const r=t.reflections;if((r==null?void 0:r.enabled)!==!1){a.addDefine("REFLECTIONS_ENABLED","1"),a.addPostDEFunction(ks());const n=Math.max(1,Math.min(3,r.bounces??1));a.addDefine("MAX_REFL_BOUNCES",n.toString())}}},Ts=`
// --- WATER PLANE LOGIC ---

// Helper: Multi-octave wave function
float getWaterHeight(vec3 p, float t, float freq, float strength) {
    if (strength <= 0.001) return 0.0;
    
    float h = 0.0;
    vec3 q = p * freq;
    
    // Layer 1: Rolling Swell (Sine based for mass)
    float wave1 = sin(q.x * 1.0 + t) * cos(q.z * 0.8 + t * 0.8);
    h += wave1 * 0.5;
    
    // Layer 2: Organic Surface (Simplex Noise)
    // Moving opposing direction for turbulence
    vec3 nP = q * 2.5 + vec3(t * 0.5, 0.0, -t * 0.5);
    float noise = snoise(nP);
    h += noise * 0.3;
    
    // Layer 3: Fine Choppiness
    vec3 nP2 = q * 6.0 + vec3(-t, 0.0, t * 0.2);
    h += snoise(nP2) * 0.1;

    return h * strength;
}

// Returns distance to water. 
// Uses Lipschitz bound (0.6) to prevent overstepping on steep waves, 
// ensuring shadows and AO resolve correctly.
float mapWater(vec3 p) {
    if (uWaterActive < 0.5) return 1e10;
    
    float level = uWaterHeight;
    float disp = 0.0;
    
    // Only calculate noise close to the plane to save performance
    // Bounding box check: if |y - level| > max_wave_height, return simple plane
    float distPlane = p.y - level;
    
    if (uWaterWaveStrength > 0.001) {
        // Optimization: If far away, treat as flat plane
        if (abs(distPlane) < uWaterWaveStrength * 2.0) {
            float t = uTime * uWaterWaveSpeed;
            disp = getWaterHeight(p, t, uWaterWaveFreq, uWaterWaveStrength);
        }
    }
    
    // SDF = Vertical distance - Displacement
    // Multiply by 0.6 to stabilize raymarching against the steep gradients of the waves
    return (distPlane - disp) * 0.6;
}

// Override material if water is hit
void applyWaterMaterial(inout vec3 albedo, inout float roughness, inout vec3 normal, vec3 p) {
    if (uWaterActive > 0.5) {
        
        // 1. Recalculate Normal via Finite Difference
        // This ensures the reflection/specular matches the wave geometry perfectly
        if (uWaterWaveStrength > 0.001) {
             float t = uTime * uWaterWaveSpeed;
             float eps = 0.05; // Sampling delta
             
             // Sample height at 3 points
             float h0 = getWaterHeight(p, t, uWaterWaveFreq, uWaterWaveStrength);
             float hx = getWaterHeight(p + vec3(eps, 0.0, 0.0), t, uWaterWaveFreq, uWaterWaveStrength);
             float hz = getWaterHeight(p + vec3(0.0, 0.0, eps), t, uWaterWaveFreq, uWaterWaveStrength);
             
             // Construct tangent vectors
             vec3 v1 = vec3(eps, hx - h0, 0.0);
             vec3 v2 = vec3(0.0, hz - h0, eps);
             
             // N = v2 x v1 (Cross product for Up-facing normal)
             normal = normalize(cross(v2, v1));
        } else {
             normal = vec3(0.0, 1.0, 0.0);
        }
        
        // 2. Physics Material
        albedo = uWaterColor;
        roughness = uWaterRoughness;
        
        // 3. Fake Depth Absorption (Fresnel darken)
        // Darken albedo when looking straight down (deep water)
        // Lighten at grazing angles
        float viewAngle = max(0.0, dot(normal, normalize(uCameraPosition - p)));
        albedo *= mix(0.4, 1.0, 1.0 - viewAngle);
    }
}
`,Ps=`
float mapWater(vec3 p) { return 1e10; }
void applyWaterMaterial(inout vec3 albedo, inout float roughness, inout vec3 normal, vec3 p) {}
`,Rs={id:"waterPlane",shortId:"wp",name:"Water Plane",category:"Scene",engineConfig:{toggleParam:"waterEnabled",mode:"compile",label:"Water Plane",groupFilter:"engine_settings"},params:{waterEnabled:{type:"boolean",default:!1,label:"Enable Water",shortId:"we",group:"engine_settings",onUpdate:"compile",noReset:!0,hidden:!0},active:{type:"boolean",default:!0,label:"Visible",shortId:"on",uniform:"uWaterActive",group:"main",condition:{param:"waterEnabled",bool:!0},noReset:!0},height:{type:"float",default:-2,label:"Height (Y)",shortId:"ht",uniform:"uWaterHeight",min:-10,max:10,step:.01,group:"geometry",condition:{param:"active",bool:!0}},color:{type:"color",default:new $e("#001133"),label:"Water Color",shortId:"cl",uniform:"uWaterColor",group:"material",condition:{param:"active",bool:!0}},roughness:{type:"float",default:.02,label:"Roughness",shortId:"ro",uniform:"uWaterRoughness",min:0,max:1,step:.01,group:"material",condition:{param:"active",bool:!0}},waveStrength:{type:"float",default:.1,label:"Wave Height",shortId:"ws",uniform:"uWaterWaveStrength",min:0,max:1.5,step:.001,group:"waves",condition:{param:"active",bool:!0}},waveSpeed:{type:"float",default:1,label:"Wave Speed",shortId:"wv",uniform:"uWaterWaveSpeed",min:0,max:5,step:.1,group:"waves",condition:[{param:"active",bool:!0},{param:"waveStrength",gt:0}]},waveFrequency:{type:"float",default:1.5,label:"Wave Freq",shortId:"wf",uniform:"uWaterWaveFreq",min:.1,max:10,step:.1,group:"waves",condition:[{param:"active",bool:!0},{param:"waveStrength",gt:0}]}},inject:(a,t,o)=>{const r=t.waterPlane;r&&r.waterEnabled&&o==="Main"?(a.addDefine("WATER_ENABLED","1"),a.addFunction(Ts)):a.addFunction(Ps)}},zs={id:"sonification",shortId:"sn",name:"Sonification",category:"Audio",tabConfig:{label:"Sonification",componentId:"panel-sonification",order:75,condition:{param:"isEnabled",bool:!0}},menuConfig:{label:"FHBT Sonification",toggleParam:"isEnabled"},viewportConfig:{componentId:"probe-sonification",type:"scene"},params:{isEnabled:{type:"boolean",default:!1,label:"Enable Sonification",shortId:"en",group:"system",noReset:!0,onUpdate:"compile"},active:{type:"boolean",default:!0,label:"Active",shortId:"ac",group:"controls",noReset:!0},baseFrequency:{type:"float",default:220,label:"Base Freq (Hz)",shortId:"bf",min:55,max:880,step:1,group:"controls",noReset:!0},masterGain:{type:"float",default:.5,label:"Volume",shortId:"mg",min:0,max:1,step:.01,group:"controls",noReset:!0},scanArea:{type:"float",default:.1,label:"Focus Area",shortId:"sa",min:.01,max:1,step:.01,group:"controls",noReset:!0,description:"Width of the scan beam. Low = Center Probe, High = Full Screen Avg."},harmonics:{type:"boolean",default:!0,label:"Harmonics",shortId:"hm",group:"controls",noReset:!0,hidden:!0},lastDimension:{type:"float",default:0,label:"Dimension",group:"data",hidden:!0,noReset:!0}},inject:(a,t,o)=>{const r=t.sonification;r&&r.isEnabled&&o==="Physics"&&a.setPhysicsRayGen(`
                // FHBT Probe Logic: 3-Arm Logarithmic Spiral Sampling
                // Row 0, 1, 2 correspond to 3 different spiral arms.
                
                float armIndex = floor(vUv.y * 3.0);
                float phaseOffset = armIndex * 2.094395; // 2 * PI / 3
                
                float t = vUv.x;
                float rotations = 3.0; 
                
                // Exponential growth: r = (exp(k*t) - 1) / (exp(k) - 1)
                // This concentrates samples near the center and expands rapidly at the edges
                float k = 3.0; 
                float radius = (exp(k * t) - 1.0) / (exp(k) - 1.0);
                
                float theta = (t * rotations * 6.28318) + phaseOffset;

                vec2 spiralOffset = vec2(cos(theta), sin(theta)) * radius;

                // uCamBasisX/Y are scaled by FOV in FHBTProbe.tsx
                vec3 rd = normalize(uCamForward + spiralOffset.x * uCamBasisX + spiralOffset.y * uCamBasisY);
            `)}},Fs={id:"cameraManager",name:"Camera Manager",category:"Scene",tabConfig:{label:"Camera Manager",componentId:"panel-cameramanager",order:999,condition:{bool:!0}},params:{}},Is=()=>{ve.register(ss),ve.register(Zi),ve.register(ps),ve.register(Cs),ve.register(js),ve.register(_i),ve.register(Gi),ve.register(Rs),ve.register(Yi),ve.register(qi),ve.register(Ki),ve.register(Oi),ve.register(Wi),ve.register(hs),ve.register(ms),ve.register(Fs),ve.register(gs),ve.register(zs),ve.register(xs),ve.register(bs),ve.register(vs),ve.register(ws),ve.register(Ss)};Is();const Lr=[{name:ce.Time,type:"float",default:0},{name:ce.FrameCount,type:"int",default:0},{name:ce.Resolution,type:"vec2",default:new Se(100,100)},{name:ce.SceneOffsetHigh,type:"vec3",default:new ie},{name:ce.SceneOffsetLow,type:"vec3",default:new ie},{name:ce.CameraPosition,type:"vec3",default:new ie},{name:ce.CamBasisX,type:"vec3",default:new ie},{name:ce.CamBasisY,type:"vec3",default:new ie},{name:ce.CamForward,type:"vec3",default:new ie},{name:ce.RegionMin,type:"vec2",default:new Se(0,0)},{name:ce.RegionMax,type:"vec2",default:new Se(1,1)},{name:ce.HistoryTexture,type:"sampler2D",default:null},{name:ce.BlendFactor,type:"float",default:1},{name:ce.ExtraSeed,type:"float",default:0},{name:ce.Jitter,type:"vec2",default:new Se(0,0)},{name:ce.BlueNoiseTexture,type:"sampler2D",default:null},{name:ce.BlueNoiseResolution,type:"vec2",default:new Se(128,128)},{name:ce.HistogramLayer,type:"int",default:0},{name:ce.InternalScale,type:"float",default:1},{name:ce.PreRotMatrix,type:"mat3",default:new qt},{name:ce.EnvRotationMatrix,type:"mat2",default:[1,0,0,1]}],Es=ve.getUniformDefinitions(),Ns=new Set(Lr.map(a=>a.name)),Ds=Es.filter(a=>!Ns.has(a.name)),co=[...Lr,...Ds];co.reduce((a,t)=>(a[t.name]=t.default,a),{});const Ls=()=>{const a={};return co.forEach(t=>{let o=t.default;o&&typeof o=="object"&&(o.clone?o=o.clone():Array.isArray(o)?o=o.map(r=>r.clone?r.clone():r):o instanceof Float32Array&&(o=new Float32Array(o))),a[t.name]={value:o}}),a},As=()=>{let a=`precision highp float;
precision highp int;

`;return co.forEach(t=>{t.arraySize?a+=`uniform ${t.type} ${t.name}[${t.arraySize}];
`:a+=`uniform ${t.type} ${t.name};
`}),a+=`
in vec2 vUv;
`,a},_s=As(),Bs=a=>`
// Constants
#define MAX_DIST 10000.0
#define BOUNDING_RADIUS 400.0 
const float phi = 1.61803398875;

// --- RANDOM FUNCTIONS (Moved from random.ts to ensure scope availability) ---
float ign_noise(vec2 uv) {
    vec3 magic = vec3(0.06711056, 0.00583715, 52.9829189);
    return fract(magic.z * fract(dot(uv, magic.xy)));
}

float hash21(vec2 p) {
    vec3 p3  = fract(vec3(p.xyx) * .1031);
    p3 += dot(p3, p3.yzx + 33.33);
    return fract((p3.x + p3.y) * p3.z);
}

// --- PRECISION MATH HELPER ---
// Reconstructs the absolute fractal space position from the split-precision context.
// p_fractal = (ctx.pos + ctx.originLow) + ctx.originHigh
vec3 applyPrecisionOffset(vec3 localPos, vec3 low, vec3 high) {
    return (localPos + low) + high;
}

vec4 textureLod0(sampler2D tex, vec2 uv) {
    #if __VERSION__ >= 300
        return textureLod(tex, uv, 0.0);
    #else
        #ifdef GL_EXT_shader_texture_lod
            return texture2DLodEXT(tex, uv, 0.0);
        #else
            return texture2D(tex, uv, -16.0); 
        #endif
    #endif
    return vec4(0.0);
}

float getLength(vec3 p) {
    float m = uDistanceMetric;
    if (m < 0.5) return length(p);
    if (m < 1.5) return max(abs(p.x), max(abs(p.y), abs(p.z)));
    if (m < 2.5) return (abs(p.x) + abs(p.y) + abs(p.z)) * 0.57735;
    vec3 p2 = p*p; vec3 p4 = p2*p2;
    return pow(dot(p4, vec3(1.0)), 0.25);
}

vec3 mod289(vec3 x) { return x - floor(x * (1.0 / 289.0)) * 289.0; }
vec4 mod289(vec4 x) { return x - floor(x * (1.0 / 289.0)) * 289.0; }
vec4 permute(vec4 x) { return mod289(((x*34.0)+1.0)*x); }
vec4 taylorInvSqrt(vec4 r) { return 1.79284291400159 - 0.85373472095314 * r; }

float snoise(vec3 v) {
  const vec2  C = vec2(1.0/6.0, 1.0/3.0) ;
  const vec4  D = vec4(0.0, 0.5, 1.0, 2.0);
  vec3 i  = floor(v + dot(v, C.yyy) );
  vec3 x0 = v - i + dot(i, C.xxx) ;
  vec3 g = step(x0.yzx, x0.xyz);
  vec3 l = 1.0 - g;
  vec3 i1 = min( g.xyz, l.zxy );
  vec3 i2 = max( g.xyz, l.zxy );
  vec3 x1 = x0 - i1 + C.xxx;
  vec3 x2 = x0 - i2 + C.yyy;
  vec3 x3 = x0 - D.yyy;
  i = mod289(i); 
  vec4 p = permute( permute( permute( 
             i.z + vec4(0.0, i1.z, i2.z, 1.0 ))
           + i.y + vec4(0.0, i1.y, i2.y, 1.0 )) 
           + i.x + vec4(0.0, i1.x, i2.x, 1.0 ));
  float n_ = 0.142857142857; 
  vec3  ns = n_ * D.wyz - D.xzx;
  vec4 j = p - 49.0 * floor(p * ns.z * ns.z); 
  vec4 x_ = floor(j * ns.z);
  vec4 y_ = floor(j - 7.0 * x_ );   
  vec4 x = x_ *ns.x + ns.yyyy;
  vec4 y = y_ *ns.x + ns.yyyy;
  vec4 h = 1.0 - abs(x) - abs(y);
  vec4 b0 = vec4( x.xy, y.xy );
  vec4 b1 = vec4( x.zw, y.zw );
  vec4 s0 = floor(b0)*2.0 + 1.0;
  vec4 s1 = floor(b1)*2.0 + 1.0;
  vec4 sh = -step(h, vec4(0.0));
  vec4 a0 = b0.xzyw + s0.xzyw*sh.xxyy ;
  vec4 a1 = b1.xzyw + s1.xzyw*sh.zzww ;
  vec3 p0 = vec3(a0.xy,h.x);
  vec3 p1 = vec3(a0.zw,h.y);
  vec3 p2 = vec3(a1.xy,h.z);
  vec3 p3 = vec3(a1.zw,h.w);
  vec4 norm = taylorInvSqrt(vec4(dot(p0,p0), dot(p1,p1), dot(p2, p2), dot(p3,p3)));
  p0 *= norm.x; p1 *= norm.y; p2 *= norm.z; p3 *= norm.w;
  vec4 m = max(0.6 - vec4(dot(x0,x0), dot(x1,x1), dot(x2,x2), dot(x3,x3)), 0.0);
  m = m * m;
  return 42.0 * dot( m*m, vec4( dot(p0,x0), dot(p1,x1), dot(p2,x2), dot(p3,x3) ) );
}

vec3 InverseACESFilm(vec3 x) {
    float a = 2.51; float b = 0.03; float c = 2.43; float d = 0.59; float e = 0.14;
    vec3 y = clamp(x, 0.0, 0.99);
    vec3 A = c * y - a; vec3 B = d * y - b; vec3 C = e * y;
    vec3 D = sqrt(max(vec3(0.0), B*B - 4.0*A*C));
    return (-B - D) / (2.0 * A);
}

// Applies Color Profile to Texture Lookup
// 0=sRGB, 1=Linear, 2=ACES
vec3 applyTextureProfile(vec3 col, float mode) {
    if (mode < 0.5) {
        // 0: sRGB -> Linear
        return pow(max(col, vec3(0.0)), vec3(2.2));
    } 
    if (mode > 1.5) {
        // 2: ACES Inverse -> Linear
        return InverseACESFilm(col);
    }
    // 1: Linear (Pass-through)
    return col;
}

void sphereFold(inout vec3 z, inout float dz, float minR, float fixedR) {
    float r2 = dot(z,z); r2 = max(r2, 1.0e-9);
    float minR2 = max(minR * minR, 1.0e-9);
    float fixedR2 = max(fixedR * fixedR, 1.0e-9); 
    if (r2 < minR2) { float temp = (fixedR2 / minR2); z *= temp; dz *= temp; }
    else if (r2 < fixedR2) { float temp = (fixedR2 / r2); z *= temp; dz *= temp; }
}

void boxFold(inout vec3 z, inout float dz, float foldLimit) {
    z = clamp(z, -foldLimit, foldLimit) * 2.0 - z;
}

// Mandelbulb iteration helper
void DE_Bulb(inout vec3 z, inout float dr, inout float trap, float power) {
    float r = length(z);
    if (r > 1.0e-4) {
        dr = pow(r, power - 1.0) * power * dr + 1.0;
        float theta = acos(clamp(z.z / r, -1.0, 1.0));
        float phi = atan(z.y, z.x);
        theta *= power;
        phi *= power;
        float zr = pow(r, power);
        z = zr * vec3(sin(theta) * cos(phi), sin(phi) * sin(theta), cos(theta));
        trap = min(trap, r);
    } else {
        dr = 1.0;
    }
}

vec3 bulbPow(vec3 z, float power) {
    float r = length(z); if (r < 1.0e-4) return vec3(0.0);
    float r_safe = max(r, 1.0e-9);
    float theta = acos(clamp(z.z / r_safe, -1.0, 1.0));
    float phi = atan(z.y, z.x);
    float zr = pow(r, power); theta *= power; phi *= power;
    return zr * vec3(sin(theta) * cos(phi), sin(phi) * sin(theta), cos(theta));
}

vec4 quatSquare(vec4 q) {
    return vec4(q.x*q.x - q.y*q.y - q.z*q.z - q.w*q.w, 2.0*q.x*q.y, 2.0*q.x*q.z, 2.0*q.x*q.w);
}

vec4 tetraSquare(vec4 q) {
    return vec4(q.x*q.x - q.y*q.y - q.z*q.z + q.w*q.w, 2.0*(q.x*q.y - q.z*q.w), 2.0*(q.x*q.z - q.y*q.w), 2.0*(q.x*q.w + q.y*q.z));
}

vec2 intersectSphere(vec3 ro, vec3 rd, float r) {
    float b = dot(ro, rd); float c = dot(ro, ro) - r * r;
    float h = b * b - c; if (h < 0.0) return vec2(1.0, 0.0);
    h = sqrt(h); return vec2(-b - h, -b + h);
}

void dodecaFold(inout vec3 z) {
    vec3 n = normalize(vec3(phi, 1.0, 0.0));
    z -= 2.0 * min(0.0, dot(z, n)) * n;
    vec3 n2 = normalize(vec3(1.0, 0.0, phi));
    z -= 2.0 * min(0.0, dot(z, n2)) * n2;
}

${a?`
    // Kernel Capability: Local Rotation
    // CPU Optimized: Pre-calculated Matrix (mat3) to avoid 6x sin/cos per iteration
    // uniform mat3 uPreRotMatrix; // Defined in UNIFORMS chunk

    void applyLocalRotation(inout vec3 p) {
        if (uPreRotEnabled > 0.5) {
            // p' = M * p
            p = uPreRotMatrix * p;
        }
    }

    void unapplyLocalRotation(inout vec3 p) {
        if (uPreRotEnabled > 0.5) {
            // Inverse of a rotation matrix is its Transpose
            p = transpose(uPreRotMatrix) * p;
        }
    }
    `:`
    // Kernel Optimization: No Rotation Code
    void applyLocalRotation(inout vec3 p) {}
    void unapplyLocalRotation(inout vec3 p) {}
    `}

`,Os=(a,t="",o,r="",n="",i="")=>`
${o}

// --- CORE ESTIMATOR (Coloring & Geometry) ---
// Returns: vec4(distance, trap_distance, iteration_count, decomposition_angle)
vec4 map(vec3 p) {
    // 1. Apply Precision Offset
    vec3 p_fractal = applyPrecisionOffset(p, uSceneOffsetLow, uSceneOffsetHigh);
    
    vec4 z = vec4(p_fractal, uParamB); 
    vec4 c = mix(z, vec4(uJulia, uParamA), step(0.5, uJuliaMode));
    
    float dr = 1.0;
    float trap = 1e10;
    
    float iter = 0.0; 
    float smoothIter = 0.0;
    
    float decomp = 0.0;
    float lastLength = 0.0;
    bool decompCaptured = false;
    
    bool rotated = false; 

    #if defined(FORMULA_ID) && FORMULA_ID == 14
        float distOverride = 1e10; 
    #endif
    
    ${t}
    ${n}

    if (uHybridProtect > 0.5 && uPreRotEnabled > 0.5) {
         applyLocalRotation(z.xyz);
         rotated = true;
    }
    
    bool escaped = false;
    float bailout = max(100.0, uEscapeThresh + 100.0);
    
    for (int i = 0; i < MAX_HARD_ITERATIONS; i++) {
        if (i >= int(uIterations)) break;

        iter = float(i);
        bool skipMainFormula = false;
        
        ${i}
        
        if (!skipMainFormula) {
            if (uHybridProtect < 0.5) {
                 applyLocalRotation(z.xyz);
            } else if (!rotated) {
                 applyLocalRotation(z.xyz);
                 rotated = true;
            }

            float d_metric = getLength(z.xyz);
            float r2_check = d_metric * d_metric;

            if (!decompCaptured && r2_check > uEscapeThresh) {
                decomp = atan(z.y, z.x) * 0.15915494 + 0.5; 
                lastLength = d_metric; 
                decompCaptured = true;
            }
            
            // --- OPTIMIZATION: EARLY BAILOUT ---
            // Check if point has escaped BEFORE running expensive math (pow/sin/cos).
            // Some formulas (JuliaMorph) opt-out of this via define.
            #ifndef SKIP_PRE_BAILOUT
            if (r2_check > bailout) {
                escaped = true;
                break;
            }
            #endif
            
            ${a}
        }
        
        float d_metric = getLength(z.xyz);
        float r2 = d_metric * d_metric;
        
        if (!decompCaptured && r2 > uEscapeThresh) {
            decomp = atan(z.y, z.x) * 0.15915494 + 0.5; 
            lastLength = d_metric;
            decompCaptured = true;
        }
        
        if (dr > 1.0e10 || r2 > bailout) {
            escaped = true;
            break;
        }
        
        #if defined(FORMULA_ID) && FORMULA_ID == 14
        if (distOverride < 999.0) { escaped = true; break; }
        #endif
    }
    
    float r = getLength(z.xyz);
    float safeDr = max(abs(dr), 1.0e-10);
    
    if (!decompCaptured) {
        decomp = atan(z.y, z.x) * 0.15915494 + 0.5;
        lastLength = r;
    }
    
    vec2 distRes = getDist(r, safeDr, iter, z);
    
    float finalD = distRes.x;
    smoothIter = distRes.y;
    
    #if defined(FORMULA_ID) && FORMULA_ID == 14
        if (distOverride < 999.0) { finalD = distOverride; smoothIter = iter; }
    #endif
    
    bool useLLI = (abs(uColorMode - 8.0) < 0.1) || (abs(uColorMode2 - 8.0) < 0.1);
    if (uUseTexture > 0.5) {
        if (abs(uTextureModeU - 8.0) < 0.1) useLLI = true;
        if (abs(uTextureModeV - 8.0) < 0.1) useLLI = true;
    }
    float outTrap = useLLI ? lastLength : trap;
    
    // --- HOOK: Water Plane ---
    // Wrapped in ifdef to ensure it is optimized out if feature disabled
    #ifdef WATER_ENABLED
    float dWater = mapWater(p_fractal);
    if (dWater < finalD) {
        finalD = dWater;
        // Signal Water material via magic decomp value
        // Note: Features should ideally modify a dedicated material ID channel, 
        // but packing into W is the current architecture.
        decomp = 12345.0; 
        smoothIter = 0.0;
        outTrap = 0.0;
    }
    #endif

    return vec4(finalD, outTrap, smoothIter / max(1.0, uIterations), decomp);
}

// --- OPTIMIZED GEOMETRY-ONLY ESTIMATOR ---
// Strips out all Orbit Trap, Coloring, Decomposition, and Smoothing logic.
// Used for Shadows, AO, and Normals.
float mapDist(vec3 p) {
    vec3 p_fractal = applyPrecisionOffset(p, uSceneOffsetLow, uSceneOffsetHigh);
    
    vec4 z = vec4(p_fractal, uParamB); 
    vec4 c = mix(z, vec4(uJulia, uParamA), step(0.5, uJuliaMode));
    
    float dr = 1.0;
    // We still need 'trap' for formula signatures, but the compiler will DCE it since we don't return it.
    float trap = 1e10; 
    
    // Add missing iter definition for compatibility with loopInit chunks that might expect it
    float iter = 0.0;
    
    bool rotated = false;
    
    #if defined(FORMULA_ID) && FORMULA_ID == 14
        float distOverride = 1e10; 
    #endif
    
    ${t}
    ${n}

    if (uHybridProtect > 0.5 && uPreRotEnabled > 0.5) {
         applyLocalRotation(z.xyz);
         rotated = true;
    }
    
    float bailout = max(100.0, uEscapeThresh + 100.0);
    
    // Geometry Loop
    for (int i = 0; i < MAX_HARD_ITERATIONS; i++) {
        if (i >= int(uIterations)) break;

        bool skipMainFormula = false;
        
        ${i}
        
        if (!skipMainFormula) {
            if (uHybridProtect < 0.5) {
                 applyLocalRotation(z.xyz);
            } else if (!rotated) {
                 applyLocalRotation(z.xyz);
                 rotated = true;
            }

            #ifndef SKIP_PRE_BAILOUT
            if (dot(z.xyz, z.xyz) > bailout) break;
            #endif
            
            ${a}
        }
        
        if (dr > 1.0e10 || dot(z.xyz, z.xyz) > bailout) break;
        
        #if defined(FORMULA_ID) && FORMULA_ID == 14
        if (distOverride < 999.0) break;
        #endif
    }
    
    float r = getLength(z.xyz);
    float safeDr = max(abs(dr), 1.0e-10);
    
    // We use 0.0 for iter because smooth iteration isn't needed for pure distance
    vec2 distRes = getDist(r, safeDr, 0.0, z);
    
    float finalD = distRes.x;
    
    #if defined(FORMULA_ID) && FORMULA_ID == 14
        if (distOverride < 999.0) finalD = distOverride;
    #endif
    
    // --- HOOK: Water Plane ---
    #ifdef WATER_ENABLED
    float dWater = mapWater(p_fractal);
    if (dWater < finalD) {
        finalD = dWater;
    }
    #endif

    return finalD;
}

// Wrapper for Coloring
vec4 DE(vec3 p_ray) {
    return map(p_ray + uCameraPosition);
}

// Wrapper for Geometry (Shadows/AO/Normals)
float DE_Dist(vec3 p_ray) {
    return mapDist(p_ray + uCameraPosition);
}`,$s=(a="")=>`
// ------------------------------------------------------------------
// SHARED SURFACE EVALUATION
// ------------------------------------------------------------------

vec3 GetNormal(vec3 p_ray, float eps) {
    // High Quality: Tetrahedron Normal (4 taps)
    // OPTIMIZATION: Use DE_Dist
    vec2 k = vec2(1.0, -1.0);
    vec3 n = k.xyy * DE_Dist(p_ray + k.xyy * eps) + 
             k.yyx * DE_Dist(p_ray + k.yyx * eps) + 
             k.yxy * DE_Dist(p_ray + k.yxy * eps) + 
             k.xxx * DE_Dist(p_ray + k.xxx * eps);
    
    if (dot(n, n) < 1.0e-20) return vec3(0.0, 1.0, 0.0);
    
    return normalize(n);
}

vec3 GetFastNormal(vec3 p, float eps) {
    // Low Quality: Forward Difference (3 taps)
    // Optimization: Uses DE_Dist
    // We assume distance at p is ~0.0 (Surface)
    vec2 e = vec2(eps, 0.0);
    
    float dx = DE_Dist(p + e.xyy);
    float dy = DE_Dist(p + e.yxy);
    float dz = DE_Dist(p + e.yyx);
    
    vec3 n = vec3(dx, dy, dz);
    
    if (dot(n, n) < 1.0e-20) return vec3(0.0, 1.0, 0.0);
    
    return normalize(n);
}

// Evaluate surface properties (Albedo, Normal, Roughness, Emission)
// Used by both Direct Lighting and Path Tracer
void getSurfaceMaterial(vec3 p_ray_in, vec3 p_fractal_in, vec4 result, float d, out vec3 albedo, out vec3 n, out vec3 emission, out float roughness, bool highQuality) {
    // Initialize outputs to satisfy strict compilers (X4000)
    albedo = vec3(0.0);
    n = vec3(0.0, 1.0, 0.0);
    emission = vec3(0.0);
    roughness = 0.5;

    float distFromFractalOrigin = length(p_fractal_in);
    float pixelSizeScale = length(uCamBasisY) / uResolution.y * 2.0 / uInternalScale;
    
    // Matches trace.ts precision floor
    float floatLimit = max(1.0e-20, distFromFractalOrigin * 5.0e-7);
    
    float visualLimit = pixelSizeScale * d * (1.0 / uDetail);
    
    float eps = max(floatLimit, visualLimit);

    // Alias inputs (No Retreat/Modification)
    vec3 p_ray = p_ray_in;
    vec3 p_fractal = p_fractal_in;
    
    // --- ADAPTIVE NORMAL ESTIMATION ---
    
    if (highQuality) {
        n = GetNormal(p_ray, eps);
    } else {
        // Boost epsilon slightly for fast normals to avoid noise
        // FIX: Removed invalid 'd' argument. FastNormal calculates relative to 0.0 surface.
        n = GetFastNormal(p_ray, eps * 1.5);
    }
    
    // --- Layer 3: Procedural Noise & Bump Mapping ---
    // Calculate if needed for Surface OR Emission (Mode 3)
    float noiseVal = 0.0;
    vec3 noiseP = p_fractal * uLayer3Scale;
    bool useL3 = (uLayer3Strength > 0.0 || abs(uLayer3Bump) > 0.0 || abs(uEmissionMode - 3.0) < 0.1);
    
    if (useL3) {
        noiseVal = getLayer3Noise(noiseP);
        
        if (abs(uLayer3Bump) > 0.001) {
            vec2 e = vec2(0.01, 0.0);
            float nx = getLayer3Noise(noiseP + e.xyy) - noiseVal;
            float ny = getLayer3Noise(noiseP + e.yxy) - noiseVal;
            float nz = getLayer3Noise(noiseP + e.yyx) - noiseVal;
            vec3 grad = vec3(nx, ny, nz);
            
            // Only apply detailed bump mapping on high quality rays (primary hit)
            // Skip bump on bounces to save perf and reduce shimmering
            if (highQuality) {
                n = normalize(n - grad * uLayer3Bump * 10.0);
            }
        }
    }

    // --- Coloring Calculation ---
    vec3 col1 = vec3(0.0);
    
    // Layer 1 (Always calculated as base)
    if (uUseTexture > 0.5) {
        col1 = getTextureColor(p_fractal, n, result);
    } else {
        float val1 = getMappingValue(uColorMode, p_fractal, result, n, uColorScale);
        float twistAngle = 0.0;
        if (abs(uColorTwist) > 0.001) {
            twistAngle = atan(p_fractal.y, p_fractal.x) * 0.15915;
        }
        float t1Raw = val1 * uColorScale + uColorOffset + (distFromFractalOrigin + twistAngle) * uColorTwist;
        float t1 = pow(abs(fract(mod(t1Raw, 1.0))), uGradientBias);
        col1 = textureLod0(uGradientTexture, vec2(t1, 0.5)).rgb;
    }

    // Layer 2
    // Calculate if needed for Surface Blending OR Emission (Mode 2)
    vec3 col2 = vec3(0.0);
    bool useL2 = (uBlendOpacity > 0.01 || uBlendMode > 5.5 || abs(uEmissionMode - 2.0) < 0.1);

    if (useL2) { 
        float val2 = getMappingValue(uColorMode2, p_fractal, result, n, uColorScale2);
        
        float twistAngle2 = 0.0;
        if (abs(uColorTwist2) > 0.001) {
            twistAngle2 = atan(p_fractal.y, p_fractal.x) * 0.15915;
        }
        
        float t2Raw = val2 * uColorScale2 + uColorOffset2 + (distFromFractalOrigin + twistAngle2) * uColorTwist2;
        float t2 = pow(abs(fract(mod(t2Raw, 1.0))), uGradientBias2);
        
        col2 = textureLod0(uGradientTexture2, vec2(t2, 0.5)).rgb;
    }

    // --- Compose Albedo ---
    albedo = col1;

    // Apply Layer 2 Blend (Only if opacity > 0 or Bump mode)
    if (uBlendOpacity > 0.01 || uBlendMode > 5.5) {
        if (uBlendMode > 5.5) {
             vec3 bumpVec = (col2 - 0.5) * 2.0;
             // Apply layer blend bump
             if (highQuality) {
                n = normalize(n + bumpVec * uBlendOpacity);
             }
        } else {
             albedo = blendColors(albedo, col2, uBlendOpacity, uBlendMode);
        }
    }
    
    // Apply Layer 3 Blend (Only if strength > 0)
    if (uLayer3Strength > 0.001) {
        float n01 = noiseVal * 0.5 + 0.5;
        albedo = mix(albedo, uLayer3Color, n01 * uLayer3Strength);
    }
    
    // --- FEATURE INJECTION: MATERIAL PROPERTIES ---
    // Inject Emission, Roughness, and other surface logic here.
    ${a}
    
    // --- HOOK: Water Plane Material ---
    // Overrides albedo/normal/roughness if water ID is detected
    // Safe to call even if water disabled (stub will be empty)
    if (abs(result.w - 12345.0) < 0.1) {
        applyWaterMaterial(albedo, roughness, n, p_fractal);
        emission = vec3(0.0);
    }
}`,Hs=a=>{let t="";return a?t=`
        // Path Tracer Mode (Compiled)
        col = calculatePathTracedColor(ro, rd, d, result, stochasticSeed);
        `:t=`
        // Direct Lighting Mode (Compiled)
        col = calculateShading(ro, rd, d, result, stochasticSeed);
        `,`
// ------------------------------------------------------------------
// MAIN RENDER LOOP
// ------------------------------------------------------------------

// Output Layout for GLSL 3.00 ES - single color output
layout(location = 0) out vec4 pc_fragColor;

// Safety to prevent NaNs/Infs from poisoning the accumulation buffer
vec3 sanitizeColor(vec3 col) {
    // Optimization: Replaced complex branching with hardware clamps.
    // Clamp to [0, 200.0] to handle fireflies/NaNs gracefully without conditional logic.
    // vec3(200.0) is generous enough for HDR bloom, but low enough to stop Inf accumulation.
    return min(max(col, vec3(0.0)), vec3(200.0));
}

vec3 renderPixel(vec2 uvCoord, float seedOffset, out float outDepth) {
    vec3 ro = vec3(0.0);
    vec3 rd = vec3(0.0, 0.0, 1.0);
    float stochasticSeed = 0.0;
    
    getCameraRay(uvCoord, uExtraSeed + seedOffset, ro, rd, stochasticSeed);
    
    // Background Logic (Direct Mode Miss)
    vec3 bgCol = vec3(0.0);
    vec3 safeFog = InverseACESFilm(uFogColor);
    
    if (uEnvBackgroundStrength > 0.001) {
        vec3 env = GetEnvMap(rd, 0.0) * uEnvBackgroundStrength; 
        bgCol = mix(env, safeFog, clamp(uFogIntensity, 0.0, 1.0));
    } else {
        // If Background Visibility is 0, we just show fog color (usually black)
        // We mix with a tiny bit of fog color based on Y to prevent total pitch black banding
        bgCol = mix(safeFog + vec3(0.01), safeFog, abs(rd.y));
    }
    
    vec3 col = bgCol;
    float d = 0.0;
    vec4 result = vec4(0.0);
    
    vec3 glow = vec3(0.0);
    float volumetric = 0.0;
    
    // Primary Ray Trace
    bool hit = traceScene(ro, rd, d, result, glow, stochasticSeed, volumetric);
    
    if (hit) {
        ${t}
    } else {
        d = 1000.0;
    }
    
    col = applyPostProcessing(col, d, glow, volumetric);
    outDepth = d;  // Output depth for physics probe
    return col;
}

void main() {
    vec4 history = texture(uHistoryTexture, vUv); // texture() in GLSL 3

    // --- Region Check ---
    if (vUv.x < uRegionMin.x || vUv.y < uRegionMin.y || vUv.x > uRegionMax.x || vUv.y > uRegionMax.y) {
        pc_fragColor = history;
        return;
    }

    // --- Normal rendering for all pixels ---
    float depth;
    vec3 col = renderPixel(vUv, 0.0, depth);
    col = sanitizeColor(col);
    vec3 safeHistory = history.rgb;
    
    vec3 finalCol = mix(safeHistory, col, uBlendFactor);
    
    // Store depth in alpha channel - physics probe reads center pixel from previous frame
    pc_fragColor = vec4(finalCol, depth);
}
`},Lo=a=>`
// ------------------------------------------------------------------
// STAGE 1: RAY GENERATION
// Handles Camera Basis and Depth of Field
// ------------------------------------------------------------------
void getCameraRay(vec2 uvCoord, float seed, out vec3 ro, out vec3 rd, out float stochasticSeed) {
    vec2 uv = uvCoord * 2.0 - 1.0;
    
    // Store original UV for stable noise lookup (before jitter)
    vec2 uvOriginal = uv;
    
    // --- TAA JITTER (Calculated on CPU) ---
    // Jitter behavior:
    // - During navigation (blendFactor >= 0.99): NO jitter (stable view)
    // - During accumulation (blendFactor < 0.99): Jitter applied for TAA anti-aliasing
    // isMoving = true means camera is moving (navigation), false means accumulating
    bool isMoving = uBlendFactor >= 0.99;
    if (!isMoving && uResolution.x > 0.5) {
        vec2 pixelSize = 2.0 / uResolution;
        uv += uJitter * pixelSize * 0.5;
    }

    stochasticSeed = 0.5; // Default safe value
    
    // Cache blending factor locally to help compiler optimization
    float blendFactor = uBlendFactor;
    
    // --- STOCHASTIC SEED GENERATION ---
    bool needNoise = false;
    
    ${a==="PathTracing"?"needNoise = true;":`
        // Always apply DOF noise for blur preview - even during navigation
        if (uDOFStrength > 0.00001) needNoise = true;
        if (!isMoving) needNoise = true;  // Other effects need noise when stationary
        if (uPTStochasticShadows > 0.5) needNoise = true;
        `}
    
    // Use Blue Noise Red Channel as base seed
    // Use stable noise during navigation, animated during accumulation for better convergence
    if (needNoise) {
        vec2 noiseCoord = uvOriginal * 0.5 + 0.5; // Convert from NDC [-1,1] to [0,1]
        stochasticSeed = isMoving ? getStableBlueNoise4(noiseCoord * uResolution).r
                                 : getBlueNoise4(noiseCoord * uResolution).r;
    }
    
    vec3 forward = uCamForward;
    vec3 right = uCamBasisX;
    vec3 up = uCamBasisY;
    
    // --- PROJECTION SWITCH ---
    if (uCamType > 1.5) {
        // EQUIRECTANGULAR (360 SKYBOX)
        float lambda = uv.x * 3.1415926535; 
        float phi = uv.y * 1.5707963268;
        float cPhi = cos(phi);
        vec3 localRd = vec3(
            sin(lambda) * cPhi,
            sin(phi),
            -cos(lambda) * cPhi
        );
        vec3 r = normalize(right);
        vec3 u = normalize(up);
        vec3 f = normalize(forward);
        mat3 rot = mat3(r, u, -f);
        rd = r * localRd.x + u * localRd.y + f * -localRd.z;
        ro = vec3(0.0);
        // Fallthrough to DOF logic allowed
    } else if (uCamType > 0.5) {
        // ORTHOGRAPHIC
        rd = normalize(forward);
        ro = uv.x * right + uv.y * up;
    } else {
        // PERSPECTIVE
        rd = normalize(forward + uv.x * right + uv.y * up);
        ro = vec3(0.0);
    }

    // --- DEPTH OF FIELD ---
    // DOF noise behavior:
    // - During navigation (isMoving): Stable per-pixel noise for blur preview
    // - During accumulation: Animated noise for Monte Carlo convergence
    if (uDOFStrength > 0.00001) {
        vec3 focalPoint = ro + rd * uDOFFocus;
        
        // Use stable blue noise during navigation, animated during accumulation
        vec2 noiseCoord = uvOriginal * 0.5 + 0.5; // Convert from NDC [-1,1] to [0,1]
        vec4 blue = isMoving ? getStableBlueNoise4(noiseCoord * uResolution) 
                             : getBlueNoise4(noiseCoord * uResolution);
        
        float r = sqrt(blue.r);
        float theta = blue.g * 6.283185;
        
        // Polygonal Bokeh Shape (Hexagon)
        float blades = 6.0; 
        float pi = 3.14159265;
        float segment = 2.0 * pi / blades;
        float localTheta = mod(theta, segment) - (segment * 0.5);
        float polyRadius = cos(pi / blades) / cos(localTheta);
        r *= polyRadius;
        
        theta += 0.26; // Rotation offset
        
        vec2 offset = vec2(cos(theta), sin(theta)) * r * uDOFStrength;
        offset.y *= 1.3; // Anamorphic squash
        
        vec3 lensOffset = normalize(right) * offset.x + normalize(up) * offset.y; 
        ro += lensOffset;
        
        // Recalculate ray direction to converge at focal point
        // Works for both Perspective and Orthographic (Tilt-Shift effect)
        rd = normalize(focalPoint - ro);
    }
}
`,Ao=(a,t,o=0,r=0,n="",i="")=>`
// ------------------------------------------------------------------
// STAGE 2: RAYMARCHING (Flattened & Optimized)
// ------------------------------------------------------------------

bool traceScene(vec3 ro, vec3 rd, out float d, out vec4 result, inout vec3 glow, float stochasticSeed, inout float volumetric) {
    d = 0.0;
    result = vec4(0.0);

    // 1. Bounding Sphere
    vec3 sphereCenter = -(uSceneOffsetHigh + uSceneOffsetLow);
    vec2 bounds = intersectSphere(ro - sphereCenter, rd, BOUNDING_RADIUS);
    if (bounds.x > bounds.y) return false;
    
    d = max(0.0, bounds.x);
    
    // 2. Flattened Accumulators
    vec3 accColor = vec3(0.0);
    float accDensity = 0.0;
    float accAlpha = 0.0; // Scalar glow accumulator for Fast Mode
    
    // 3. Loop Config
    // pixelSizeScale: world-space size of an output pixel (NOT affected by internal scale)
    // Internal scale affects ray detail, not pixel size calculations
    float pixelSizeScale = length(uCamBasisY) / uResolution.y * 2.0;
    int limit = int(uMaxSteps);
    float maxMarch = MAX_DIST;
    
    // Temporary Hit holder (distance, trap, iter, decomp)
    vec4 h = vec4(0.0);

    // --- CANDIDATE TRACKING (Overstep Recovery) ---
    // Tracks the closest the ray ever got to a surface, normalized by the required precision at that depth.
    float minCandidateRatio = 1.0e10; 
    float candidateD = -1.0;

    for (int i = 0; i < MAX_HARD_ITERATIONS; i++) {
        if (i >= limit) break;

        vec3 p = ro + rd * d;
        
        // A. Distance Estimation (Raw vec4 return)
        // Note: map() now adds uCameraPosition internally
        h = map(p + uCameraPosition);
        
        // B. Volumetric Effects (Inlined Code Block)
        // Uses: d, h, p, accColor, accDensity, accAlpha
        ${n}
        
        // C. Precision
        vec3 p_fractal_approx = p + uCameraPosition + uSceneOffsetLow + uSceneOffsetHigh;
        float distFromFractalOrigin = length(p_fractal_approx);
        
        ${o===1||a?`
        float floatPrecision = max(1.0e-5, distFromFractalOrigin * 1.0e-5);
    `:`
        float floatPrecision = max(1.0e-20, distFromFractalOrigin * 5.0e-7);
    `}
        
        // Dynamic Epsilon (Cone Tracing concept)
        // We relax the hit requirement as we get further away to prevent aliasing and stepping issues
        // Note: uDetail is divided by uInternalScale because at higher internal resolutions,
        // each output pixel covers more render pixels, so we need less precision per output pixel
        float effectiveDetail = uDetail / uInternalScale;
        float threshold = pixelSizeScale * d * (uPixelThreshold / effectiveDetail);
        float finalEps = max(threshold, floatPrecision);
        
        // D. Hit Detection
        if (h.x < finalEps) {
            
            // --- SURFACE REFINEMENT (Edge Polish) ---
            // If enabled, take a few extra tiny steps to settle exactly on the surface.
            // Helps significantly when uFudgeFactor is low but step count limited.
            int refine = uRefinementSteps;
            if (refine > 0) {
                float refineStep = h.x; 
                // We use a safe fraction to converge without overshooting
                float convergeFactor = uFudgeFactor * 0.8; 
                
                for(int j=0; j<5; j++) {
                    if (j >= refine) break;
                    d += refineStep * convergeFactor;
                    vec3 p_ref = ro + rd * d;
                    vec4 h_ref = map(p_ref + uCameraPosition);
                    
                    // If we went inside (negative or very small), or improvement is negligible, stop
                    if (h_ref.x < floatPrecision * 0.1) break;
                    
                    h = h_ref;
                    refineStep = h.x;
                }
            }

            // Apply Final Volumetric Resolve (Inlined)
            vec3 p_final = ro + rd * d; 
            vec3 p = p_final; // Alias for volumeFinalizeCode
            ${i}
            
            // Output
            glow = accColor;
            volumetric = accDensity;
            result = h; // h.x is dist, h.yzw is trap data
            return true;
        }

        // E. Candidate Tracking
        if (uOverstepTolerance > 0.0) {
            float ratio = h.x / finalEps;
            // Capture the 'closest miss'
            if (ratio < minCandidateRatio) {
                minCandidateRatio = ratio;
                candidateD = d;
            }
        }
        
        // F. Step Advance (Dynamic Step Relaxation)
        // If uStepRelaxation > 0, we interpolate between uFudgeFactor and 1.0 based on distance.
        // Far from surface = Fast. Close to surface = Precise.
        float currentFudge = uFudgeFactor;
        if (uStepRelaxation > 0.0) {
             // 1.0 / (1.0 + 10.0 * uStepRelaxation) scales the "closeness" sensitivity.
             // If h.x is large relative to eps, we can be aggressive.
             float safeZone = h.x / (finalEps * 10.0); // 10x epsilon buffer
             float relax = smoothstep(0.0, 1.0, safeZone);
             currentFudge = mix(uFudgeFactor, 1.0, relax * uStepRelaxation);
        }

        d += max(h.x, floatPrecision * 0.5) * currentFudge;
        
        if (d > maxMarch) break;
    }
    
    // --- RECOVERY CHECK ---
    // If we missed, but we tracked a candidate that was within 'uOverstepTolerance' multiples of the threshold,
    // we assume we tunneled through a detailed surface and snap back to it.
    if (uOverstepTolerance > 0.0 && candidateD > 0.0) {
        // Example: If tolerance is 2.0, we accept misses that were within 2x the epsilon.
        // E.g. We missed with ratio 1.5, which is < 1.0 (hit) + 2.0 (tol).
        if (minCandidateRatio <= (1.0 + uOverstepTolerance)) {
             d = candidateD;
             // Re-evaluate map at the candidate position to get correct Trap/Color data
             // We can't trust 'h' because it's from the last missed step at infinity
             vec3 p_cand = ro + rd * d;
             result = map(p_cand + uCameraPosition);
             result.x = 0.0; // Force hit
             
             // Finalize volume for the recovered path? 
             // Strictly speaking we should, but for visual consistency we use the accumulated values.
             
             vec3 p = p_cand; // Alias for injected code which expects 'p'
             
             ${i}
             glow = accColor;
             volumetric = accDensity;
             return true;
        }
    }
    
    // MISS: Resolve volume at infinity
    vec3 p_end = ro + rd * d;
    h = map(p_end + uCameraPosition);
    h.x = 1000.0; // Override dist
    
    // Run finalize on the miss state to color any accumulated glow
    vec3 p = p_end; // Alias for injected code
    ${i}
    
    glow = accColor;
    volumetric = accDensity;
    
    return false;
}
`,Aa=`
// ------------------------------------------------------------------
// COLORING & PATTERN GENERATION
// ------------------------------------------------------------------

// Forward Declaration for Linkage
vec3 getGlowColor(vec3 p_fractal, vec4 result);
float getMappingValue(float mode, vec3 p, vec4 result, vec3 n, float repeatScale);

// The 'getMappingValue' function is now injected dynamically by ColoringFeature.
// See features/coloring/MappingModes.ts for logic.

vec3 blendColors(vec3 c1, vec3 c2, float opacity, float mode) {
    vec3 col = c1;
    
    if (mode < 0.5) {
        col = mix(c1, c2, opacity); // Mix
    } else if (mode < 1.5) {
        col = c1 + c2 * opacity; // Add
    } else if (mode < 2.5) {
        col = c1 * mix(vec3(1.0), c2, opacity); // Multiply
    } else if (mode < 3.5) { 
        vec3 check = step(0.5, c1);
        vec3 res = mix(2.0 * c1 * c2, 1.0 - 2.0 * (1.0 - c1) * (1.0 - c2), check);
        col = mix(c1, res, opacity);
    } else {
        col = 1.0 - (1.0 - c1) * (1.0 - c2 * opacity);
    }
    
    return col;
}

float getLayer3Noise(vec3 p) {
    float n = 0.0;
    if (uLayer3Turbulence > 0.001) {
        vec3 warp = vec3(
            snoise(p),
            snoise(p + vec3(12.4, 3.2, 1.1)),
            snoise(p + vec3(7.8, 9.2, 4.3))
        );
        n = snoise(p + warp * uLayer3Turbulence);
    } else {
        n = snoise(p);
    }
    return n;
}

vec3 getTextureColor(vec3 p, vec3 n, vec4 result) {
    float u = getMappingValue(uTextureModeU, p, result, n, 1.0);
    float v = getMappingValue(uTextureModeV, p, result, n, 1.0);
    vec2 uv = vec2(u, v) * uTextureScale + uTextureOffset;
    
    vec3 col = textureLod0(uTexture, uv).rgb;
    return applyTextureProfile(col, uTextureColorSpace);
}

// Lightweight coloring for volumetric glow
vec3 getGlowColor(vec3 p_fractal, vec4 result) {
    if (uGlowIntensity < 0.0001) return vec3(0.0);
    
    vec3 color = vec3(0.0);
    if (uGlowMode > 0.5) {
        color = uGlowColor;
    } else {
        vec3 n = vec3(0.0, 1.0, 0.0); 
        float val1 = getMappingValue(uColorMode, p_fractal, result, n, uColorScale);
        float twistAngle = (abs(uColorTwist) > 0.001) ? atan(p_fractal.y, p_fractal.x) * 0.15915 : 0.0;
        
        float t1Raw = val1 * uColorScale + uColorOffset + (length(p_fractal) + twistAngle) * uColorTwist;
        float t1Wrapped = fract(t1Raw);
        if (t1Raw < 0.0) t1Wrapped = 1.0 - t1Wrapped;
        
        float t1 = pow(t1Wrapped, uGradientBias);
        color = textureLod0(uGradientTexture, vec2(t1, 0.5)).rgb;
    }
    return color;
}
`,Us=`
// ------------------------------------------------------------------
// POST PROCESSING (LINEAR ONLY)
// ------------------------------------------------------------------
vec3 applyPostProcessing(vec3 col, float d, vec3 glow, float volumetric) {
    float d_norm = d;
    // Scale smoothstep by intensity slider
    float fogFactor = smoothstep(uFogNear, uFogFar, d_norm) * uFogIntensity;
    
    // Inverse ACES on Fog Color to match UI selection after Tone Mapping
    vec3 fogColor = InverseACESFilm(uFogColor);
    
    // Volumetric Fog
    // 'volumetric' is the accumulated optical density along the ray
    if (uFogDensity > 0.0001) {
        // Clamp density for safety, though accumulated values can exceed 1
        // Multiply by uFogIntensity to allow fading out volume with the main slider
        float volAlpha = clamp(volumetric * uFogIntensity, 0.0, 1.0);
        col = mix(col, fogColor, volAlpha);
    }
    
    // Distance Fog (Mix)
    if (uEnvBackgroundStrength > 0.001) {
        // If "Background Visibility" is ON:
        // Only apply fog to GEOMETRY (d < MAX_DIST).
        // Leave the background (infinity) untouched so the EnvMap shows through.
        if (d < 990.0) {
            col = mix(col, fogColor, fogFactor);
        }
        // If d > 990.0 (Miss), we skip the mix, preserving the EnvMap in 'col'.
    } else {
        // Standard Mode: Everything fades to Fog Color
        col = mix(col, fogColor, fogFactor);
    }
    
    // Glow (Additive Bloom)
    if (uGlowIntensity > 0.0001) {
        col += glow * uGlowIntensity;
    }
    
    // Tone Mapping is handled in the Display Shader (MandelbulbScene.tsx)
    
    return col;
}
`,_a=`
// Uniforms are auto-generated by Schema

// Golden Ratio (Conjugate)
const float PHI = 1.61803398875;

vec4 getBlueNoise4(vec2 screenCoord) {
    vec2 res = max(uBlueNoiseResolution, vec2(64.0));
    
    // 1. Temporal Offset Calculation
    // Generate random offset for entire texture each frame
    float time = float(uFrameCount);
    vec2 temporalOffset = vec2(
        fract(time * PHI),
        fract(time * PHI * PHI)
    );
    
    // 2. Spatial Lookup with Temporal Offset
    vec2 uv = mod(screenCoord + temporalOffset * res, res) / res;
    
    // 3. Fetch Base Blue Noise
    vec4 blue = textureLod(uBlueNoiseTexture, uv, 0.0);
    
    // 4. Channel-Wise Temporal Animation
    // Apply different temporal offsets to each channel for decorrelation
    float frameOffset = float(uFrameCount) * PHI;
    float frameOffsetG = float(uFrameCount) * PHI * PHI;
    float frameOffsetB = float(uFrameCount) * PHI * PHI * PHI;
    float frameOffsetA = float(uFrameCount) * PHI * PHI * PHI * PHI;
    
    return vec4(
        fract(blue.r + frameOffset),
        fract(blue.g + frameOffsetG), 
        fract(blue.b + frameOffsetB),
        fract(blue.a + frameOffsetA)
    );
}

float getBlueNoise(vec2 screenCoord) {
    return getBlueNoise4(screenCoord).r;
}

// Stable blue noise for DOF - does not animate with frame count
// This prevents screen shake during navigation while still providing good distribution
vec4 getStableBlueNoise4(vec2 screenCoord) {
    vec2 res = max(uBlueNoiseResolution, vec2(64.0));
    vec2 uv = mod(screenCoord, res) / res;
    return textureLod(uBlueNoiseTexture, uv, 0.0);
}
`;class Gs{constructor(t){Z(this,"defines",new Map);Z(this,"uniforms",new Map);Z(this,"functions",[]);Z(this,"postDEFunctions",[]);Z(this,"integrators",[]);Z(this,"headers",[]);Z(this,"materialLogic",[]);Z(this,"volumeBody",[]);Z(this,"volumeFinalize",[]);Z(this,"hybridInit",[]);Z(this,"hybridPreLoop",[]);Z(this,"hybridInLoop",[]);Z(this,"formulaLoopBody","");Z(this,"formulaInit","");Z(this,"formulaDist","");Z(this,"useRotation",!0);Z(this,"renderMode","Direct");Z(this,"isLite",!1);Z(this,"precisionMode",0);Z(this,"physicsRayGen",`
    // Standard Linear Projection
    vec2 uv = vUv * 2.0 - 1.0;
    vec3 rd = normalize(uCamForward + uv.x * uCamBasisX + uv.y * uCamBasisY);
    `);this.variant=t}setRotation(t){this.useRotation=t}setRenderMode(t){this.renderMode=t}setQuality(t,o){this.isLite=t,this.precisionMode=o}setPhysicsRayGen(t){this.physicsRayGen=t}addDefine(t,o="1"){this.defines.set(t,o)}addUniform(t,o,r){this.uniforms.set(t,{type:o,arraySize:r})}addHeader(t){this.headers.push(t)}addFunction(t){this.functions.includes(t)||this.functions.push(t)}addPostDEFunction(t){this.postDEFunctions.includes(t)||this.postDEFunctions.push(t)}addIntegrator(t){this.integrators.includes(t)||this.integrators.push(t)}setFormula(t,o,r){this.formulaLoopBody=t,this.formulaInit=o,this.formulaDist=r}addHybrid(t,o,r){t&&this.hybridInit.push(t),o&&this.hybridPreLoop.push(o),r&&this.hybridInLoop.push(r)}addMaterialLogic(t){this.materialLogic.push(t)}addVolumeLogic(t,o){t&&this.volumeBody.push(t),o&&this.volumeFinalize.push(o)}buildDefinesString(){let t="";return this.defines.forEach((o,r)=>{t+=`#define ${r} ${o}
`}),t}buildUniformsString(){let t=_s+`
`;return this.uniforms.forEach((o,r)=>{o.arraySize?t+=`uniform ${o.type} ${r}[${o.arraySize}];
`:t+=`uniform ${o.type} ${r};
`}),t}buildFragment(){const t=this.buildDefinesString(),o=this.buildUniformsString(),r=this.headers.join(`
`),n=this.functions.join(`
`),i=this.postDEFunctions.join(`
`),s=this.integrators.join(`
`),l=Bs(this.useRotation),d=Os(this.formulaLoopBody,this.formulaInit,this.formulaDist,this.hybridInit.join(`
`),this.hybridPreLoop.join(`
`),this.hybridInLoop.join(`
`));if(this.variant==="Physics")return`
${t}
${o}
${l}
${_a}
${Aa} 
${r}
${n} // Formulas
${d}            // Distance Estimator


bool traceScene(vec3 ro, vec3 rd, out float d, out vec4 result) {
    d = 0.0;
    result = vec4(0.0);

    // 1. Bounding Sphere
    vec3 sphereCenter = -(uSceneOffsetHigh + uSceneOffsetLow);
    vec2 bounds = intersectSphere(ro - sphereCenter, rd, BOUNDING_RADIUS);
    if (bounds.x > bounds.y) return false;
    
    d = max(0.0, bounds.x);
    
    int limit = 100; // Reduced from uMaxSteps for faster probing
    float maxMarch = 100.0; // Reduced max distance
    
    vec4 h = vec4(0.0);

    for (int i = 0; i < MAX_HARD_ITERATIONS; i++) {
        if (i >= limit) break;

        vec3 p = ro + rd * d;
        h = map(p + uCameraPosition);
        
        // Simple hit detection (no refinement)
        float distFromFractalOrigin = length(p + uCameraPosition + uSceneOffsetLow + uSceneOffsetHigh);
        float floatPrecision = max(1.0e-5, distFromFractalOrigin * 1.0e-5);
        
        if (h.x < floatPrecision) {
            result = h;
            return true;
        }
        
        // Simple step advance (fixed step size)
        d += max(h.x, floatPrecision * 0.5) * 0.9;
        
        if (d > maxMarch) break;
    }
    
    return false;
}


layout(location = 0) out vec4 pc_fragColor;

void main() {
    // Generate Ray (Standard or Injected)
    ${this.physicsRayGen}
    
    vec3 ro = vec3(0.0);
    float d = 0.0;
    vec4 result = vec4(0.0);
    
    bool hit = traceScene(ro, rd, d, result);
    
    if (hit) {
        pc_fragColor = vec4(d, 0.0, 0.0, 1.0);
    } else {
        pc_fragColor = vec4(-1.0, 0.0, 0.0, 1.0);
    }
}
`;if(this.variant==="Histogram"){const h=Ao(!1,!1,this.precisionMode,0,"",""),g=Lo("Direct");return`
${t}
${o}
${l}
${_a}
${Aa} 
${r}
${n} // Formulas (Including getMappingValue)
${d}            // Distance Estimator
${i}

${h}
${g}

layout(location = 0) out vec4 pc_fragColor;

void main() {
    vec3 ro, rd;
    float stochasticSeed;
    getCameraRay(vUv, 0.0, ro, rd, stochasticSeed);
    
    vec3 glow = vec3(0.0);
    float volumetric = 0.0;
    float d = 0.0;
    vec4 result = vec4(0.0);
    
    bool hit = traceScene(ro, rd, d, result, glow, 0.0, volumetric);
    
    if (hit) {
        // Determine Mode/Scale based on active layer
        float mode = (uHistogramLayer > 0) ? uColorMode2 : uColorMode;
        float scale = (uHistogramLayer > 0) ? uColorScale2 : uColorScale;
        
        vec3 p = ro + rd * d;
        vec3 p_fractal = p + uCameraPosition + uSceneOffsetLow + uSceneOffsetHigh;
        
        // Dummy normal is sufficient for most mappings except 'Normal' mode
        // For performance, we skip normal calculation unless absolutely necessary,
        // but since Histogram is 128x128, a single normal tap is cheap.
        // Let's use Up vector as proxy for speed, or calculate real normal if quality needed.
        // For now, proxy is safe.
        vec3 n = vec3(0.0, 1.0, 0.0);
        
        float val = getMappingValue(mode, p_fractal, result, n, scale);
        
        pc_fragColor = vec4(val, 0.0, 0.0, 1.0);
    } else {
        pc_fragColor = vec4(-1.0, 0.0, 0.0, 1.0);
    }
}
`}const c=$s(this.materialLogic.join(`
`)),f=this.renderMode==="PathTracing",u=Ao(this.isLite,!0,this.precisionMode,0,this.volumeBody.join(`
`),this.volumeFinalize.join(`
`)),p=Hs(f);return`
${t}
${o}
${r}
${l}
${_a}
${Aa} 

// --- FORMULAS ---
${n}

// --- DISTANCE ESTIMATOR ---
${d}

// --- UTILS (Shadows, AO, Reflections, Env) ---
${i}

// --- MATERIAL EVAL ---
${c}

// --- RAY GENERATION ---
${Lo(this.renderMode)}

// --- TRACE SCENE ---
${u}

// --- INTEGRATORS (Lighting / PT) ---
${s}

// POST PROCESSING
${Us}
${p}
`}}class fa{static generateFragmentShader(t){return this.buildShader(t,"Main")}static generatePhysicsShader(t){return this.buildShader(t,"Physics")}static generateHistogramShader(t){return this.buildShader(t,"Histogram")}static buildShader(t,o){const r=new Gs(o),n=t.lighting,s=(n==null?void 0:n.ptEnabled)!==!1&&(t.renderMode==="PathTracing"||(n==null?void 0:n.renderMode)===1);r.setRenderMode(s?"PathTracing":"Direct");const l=t.quality||{};return r.setQuality(l.precisionMode===1,l.precisionMode??0),ve.getAll().forEach(c=>{var u;let f=!0;if((u=c.engineConfig)!=null&&u.toggleParam){const p=t[c.id];p&&p[c.engineConfig.toggleParam]===!1&&(f=!1)}if(c.inject)(c.id==="waterPlane"||f)&&c.inject(r,t,o);else if(c.shaderLibrary){const p=c.shaderLibrary;f?(p.defineTrigger&&r.addDefine(p.defineTrigger,"1"),r.addFunction(p.code),p.uniforms&&r.addHeader(p.uniforms)):p.stubs&&r.addFunction(p.stubs)}}),r.buildFragment()}}const ut=a=>{const t=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(a);return t?{r:parseInt(t[1],16),g:parseInt(t[2],16),b:parseInt(t[3],16)}:null},Gt=(a,t,o)=>(typeof a=="object"&&(t=a.g,o=a.b,a=a.r),"#"+((1<<24)+(Math.round(a)<<16)+(Math.round(t)<<8)+Math.round(o)).toString(16).slice(1).toUpperCase()),pa=({r:a,g:t,b:o})=>{a/=255,t/=255,o/=255;const r=Math.max(a,t,o),n=Math.min(a,t,o);let i=0,s=0,l=r;const d=r-n;if(s=r===0?0:d/r,r!==n){switch(r){case a:i=(t-o)/d+(t<o?6:0);break;case t:i=(o-a)/d+2;break;case o:i=(a-t)/d+4;break}i/=6}return{h:i*360,s:s*100,v:l*100}},ha=(a,t,o)=>{a/=360,t/=100,o/=100;let r=0,n=0,i=0;const s=Math.floor(a*6),l=a*6-s,d=o*(1-t),c=o*(1-l*t),f=o*(1-(1-l)*t);switch(s%6){case 0:r=o,n=f,i=d;break;case 1:r=c,n=o,i=d;break;case 2:r=d,n=o,i=f;break;case 3:r=d,n=c,i=o;break;case 4:r=f,n=d,i=o;break;case 5:r=o,n=d,i=c;break}return{r:r*255,g:n*255,b:i*255}},Ar=(a,t,o)=>({r:a.r+(t.r-a.r)*o,g:a.g+(t.g-a.g)*o,b:a.b+(t.b-a.b)*o}),Ws=(a,t)=>{if(Math.abs(t-.5)<.001)return a;const o=Math.max(.001,Math.min(.999,t)),r=Math.log(.5)/Math.log(o);return Math.pow(a,r)},ja=(a,t=1)=>{let o;if(!a)return"linear-gradient(90deg, #000 0%, #fff 100%)";if(Array.isArray(a))o=a;else if(a&&Array.isArray(a.stops))o=a.stops;else return"linear-gradient(90deg, #000 0%, #fff 100%)";if(!o||o.length===0)return"linear-gradient(90deg, #000 0%, #fff 100%)";const r=[...o].sort((i,s)=>i.position-s.position),n=[];for(let i=0;i<r.length;i++){const s=r[i];let l=Math.pow(s.position,1/t);if(l=Math.max(0,Math.min(1,l))*100,n.push(`${s.color} ${l.toFixed(2)}%`),i<r.length-1){const d=r[i+1],c=s.bias??.5;if((s.interpolation||"linear")==="step"){let u=Math.pow(d.position,1/t);u=Math.max(0,Math.min(1,u))*100,n.push(`${s.color} ${u.toFixed(2)}%`),n.push(`${d.color} ${u.toFixed(2)}%`)}else if(Math.abs(c-.5)>.001){const u=s.position+(d.position-s.position)*c;let p=Math.pow(u,1/t)*100;p=Math.max(0,Math.min(100,p)),n.push(`${p.toFixed(2)}%`)}}}return`linear-gradient(90deg, ${n.join(", ")})`},Ba=a=>Math.pow(a/255,2.2)*255,Oa=a=>{const t=a/255;if(t>=.99)return 255;const o=(Math.sqrt(-10127*t*t+13702*t+9)+59*t-3)/(502-486*t);return Math.max(0,o)*255},Ta=a=>{const o=new Uint8Array(1024);let r,n="srgb";if(Array.isArray(a))r=a;else if(a&&Array.isArray(a.stops))r=a.stops,n=a.colorSpace||"srgb";else return o;if(r.length===0){for(let l=0;l<256;l++){const d=Math.floor(l/255*255);o[l*4]=d,o[l*4+1]=d,o[l*4+2]=d,o[l*4+3]=255}return o}const i=[...r].sort((l,d)=>l.position-d.position),s=l=>{let d={r:0,g:0,b:0};if(l<=i[0].position)d=ut(i[0].color)||{r:0,g:0,b:0};else if(l>=i[i.length-1].position)d=ut(i[i.length-1].color)||{r:0,g:0,b:0};else for(let c=0;c<i.length-1;c++)if(l>=i[c].position&&l<=i[c+1].position){const f=i[c],u=i[c+1];let p=(l-f.position)/(u.position-f.position);const h=f.bias??.5;Math.abs(h-.5)>.001&&(p=Ws(p,h));const g=f.interpolation||"linear";g==="step"?p=p<.5?0:1:(g==="smooth"||g==="cubic")&&(p=p*p*(3-2*p));const M=ut(f.color)||{r:0,g:0,b:0},m=ut(u.color)||{r:0,g:0,b:0};d=Ar(M,m,p);break}return n==="linear"?{r:Ba(d.r),g:Ba(d.g),b:Ba(d.b)}:n==="aces_inverse"?{r:Oa(d.r),g:Oa(d.g),b:Oa(d.b)}:d};for(let l=0;l<256;l++){const d=l/255,c=s(d);o[l*4]=c.r,o[l*4+1]=c.g,o[l*4+2]=c.b,o[l*4+3]=255}return o},qs=a=>{const t=Math.max(1e3,Math.min(4e4,a))/100;let o,r,n;return t<=66?o=255:(o=t-60,o=329.698727446*Math.pow(o,-.1332047592),o=Math.max(0,Math.min(255,o))),t<=66?(r=t,r=99.4708025861*Math.log(r)-161.1195681661,r=Math.max(0,Math.min(255,r))):(r=t-60,r=288.1221695283*Math.pow(r,-.0755148492),r=Math.max(0,Math.min(255,r))),t>=66?n=255:t<=19?n=0:(n=t-10,n=138.5177312231*Math.log(n)-305.0447927307,n=Math.max(0,Math.min(255,n))),{r:Math.round(o),g:Math.round(r),b:Math.round(n)}},_o=a=>{const{r:t,g:o,b:r}=qs(a);return Gt(t,o,r)},Xs=()=>{let a="",t="",o="",r="";return ve.getAll().forEach(i=>{Object.values(i.params).forEach(s=>{if(s.uniform){let l="float";switch(s.type){case"float":case"int":case"boolean":l="float";break;case"vec2":l="vec2";break;case"vec3":case"color":l="vec3";break;case"vec4":l="vec4";break;case"image":case"gradient":l="sampler2D";break}a+=`uniform ${l} ${s.uniform};
`}}),i.shader&&(i.shader.main||i.shader.mainUV)&&(i.shader.uniforms&&(a+=i.shader.uniforms+`
`),i.shader.functions&&(t+=i.shader.functions+`
`),i.shader.mainUV&&(o+=`
    // Feature: ${i.name} (UV)
    ${i.shader.mainUV}
`),i.shader.main&&(r+=`
    // Feature: ${i.name} (Color)
    ${i.shader.main}
`))}),`
uniform sampler2D map;
uniform vec2 uResolution;
uniform float uEncodeOutput;

// --- DYNAMIC UNIFORMS ---
${a}

in vec2 vUv;
layout(location = 0) out vec4 pc_fragColor;

// --- DYNAMIC FUNCTIONS ---
${t}

// Narkowicz ACES Tone Mapping
vec3 ACESFilm(vec3 x) {
    float a = 2.51;
    float b = 0.03;
    float c = 2.43;
    float d = 0.59;
    float e = 0.14;
    return clamp((x*(a*x+b))/(x*(c*x+d)+e), 0.0, 1.0);
}

// Standard sRGB Transfer Function
vec3 linearToSRGB(vec3 color) {
    vec3 result;
    for(int i=0; i<3; i++) {
        float c = color[i];
        if (c <= 0.0031308) {
            result[i] = 12.92 * c;
        } else {
            result[i] = 1.055 * pow(c, 1.0/2.4) - 0.055;
        }
    }
    return result;
}

void main() {
    vec2 sampleUV = vUv;
    float mask = 1.0;
    
    // --- FEATURE INJECTION: UV MODIFICATION ---
    ${o}
    
    vec4 tex = texture(map, sampleUV);
    vec3 col = tex.rgb;
    
    col *= mask;
    
    // --- FEATURE INJECTION: COLOR MODIFICATION ---
    ${r}
    
    // 4. Tone Mapping
    col = ACESFilm(col);
    
    // 5. Output Encoding
    if (uEncodeOutput > 0.5) {
        col = linearToSRGB(col);
    }
    
    pc_fragColor = vec4(col, 1.0);
}
`},Ys=()=>{const a=new io;try{const t=a.load("blueNoise.png");return t.minFilter=ct,t.magFilter=ct,t.wrapS=st,t.wrapT=st,t.generateMipmaps=!1,console.log("Blue noise texture loaded from PNG"),t}catch(t){console.warn("Failed to load blue noise PNG, using procedural fallback:",t);const o=128,r=new Uint8Array(o*o*4);for(let i=0;i<o*o*4;i++)r[i]=Math.floor(Math.random()*255);const n=new Ft(r,o,o,at);return n.wrapS=st,n.wrapT=st,n.minFilter=ct,n.magFilter=ct,n.generateMipmaps=!1,n.needsUpdate=!0,n}},Bo=a=>{const t={};for(const o in a){const r=a[o].value;r instanceof Se?t[o]={value:r.clone()}:r instanceof ie?t[o]={value:r.clone()}:r instanceof $e?t[o]={value:r.clone()}:r instanceof Float32Array?t[o]={value:new Float32Array(r)}:Array.isArray(r)?t[o]={value:r.map(n=>n.clone?n.clone():n)}:t[o]={value:r}}return t},Oo=(a,t=0)=>{let o=3735928559^t,r=1103547991^t;for(let n=0,i;n<a.length;n++)i=a.charCodeAt(n),o=Math.imul(o^i,2654435761),r=Math.imul(r^i,1597334677);return o=Math.imul(o^o>>>16,2246822507)^Math.imul(r^r>>>13,3266489909),r=Math.imul(r^r>>>16,2246822507)^Math.imul(o^o>>>13,3266489909),4294967296*(2097151&r)+(o>>>0)};class Vs{constructor(t){Z(this,"materialDirect");Z(this,"materialPT");Z(this,"histogramMaterial");Z(this,"displayMaterial");Z(this,"exportMaterial");Z(this,"mainUniforms");Z(this,"histogramUniforms");Z(this,"lastGeneratedFrag","");Z(this,"activeDirectChecksum","");Z(this,"activePTChecksum","");Z(this,"currentMode","Direct");Z(this,"storedConfig",null);Z(this,"directDirty",!0);Z(this,"ptDirty",!0);const o=Ls(),r=Ys();o[ce.BlueNoiseTexture].value=r,this.mainUniforms=Bo(o),this.histogramUniforms=Bo(o),this.materialDirect=new Nt({vertexShader:ea,fragmentShader:"layout(location = 0) out vec4 pc_fragColor; void main() { pc_fragColor = vec4(0.0); }",uniforms:this.mainUniforms,depthWrite:!1,depthTest:!1,blending:Co,glslVersion:Jt}),this.materialPT=new Nt({vertexShader:ea,fragmentShader:"layout(location = 0) out vec4 pc_fragColor; void main() { pc_fragColor = vec4(0.0); }",uniforms:this.mainUniforms,depthWrite:!1,depthTest:!1,blending:Co,glslVersion:Jt}),this.histogramMaterial=new Nt({vertexShader:ea,fragmentShader:"layout(location = 0) out vec4 pc_fragColor; void main() { pc_fragColor = vec4(0.0); }",uniforms:this.histogramUniforms,glslVersion:Jt}),this.displayMaterial=this.createPostProcessMaterial(1),this.exportMaterial=this.createPostProcessMaterial(1),this.syncConfigUniforms(t);const n={...t,renderMode:"Direct",lighting:{...t.lighting||{},renderMode:0}};this.histogramMaterial.fragmentShader=fa.generateHistogramShader(n),this.histogramMaterial.needsUpdate=!0}get mainMaterial(){return this.currentMode==="PathTracing"?this.materialPT:this.materialDirect}getMaterial(t){return console.log("getMaterial called with mode:",t),console.log("directDirty:",this.directDirty),console.log("ptDirty:",this.ptDirty),console.log("Stack trace:",new Error().stack),this.currentMode=t,t==="Direct"&&this.directDirty&&this.storedConfig?this.compileDirect(this.storedConfig):t==="PathTracing"&&this.ptDirty&&this.storedConfig&&this.compilePT(this.storedConfig),t==="PathTracing"?this.materialPT:this.materialDirect}createPostProcessMaterial(t){const o={map:{value:null},uResolution:{value:new Se(1,1)},uEncodeOutput:{value:t}};for(const r in this.mainUniforms)o[r]||(o[r]=this.mainUniforms[r]);return new Nt({uniforms:o,vertexShader:ea,fragmentShader:Xs(),depthTest:!1,depthWrite:!1,glslVersion:Jt})}updatePostProcessUniforms(t){[this.displayMaterial,this.exportMaterial].forEach(o=>{this.mainUniforms.uResolution.value&&o.uniforms.uResolution.value.copy(this.mainUniforms.uResolution.value)})}getLastFrag(){return this.lastGeneratedFrag}updateConfig(t){this.storedConfig=t;const o=t.lighting;o&&o.renderMode!==void 0?this.currentMode=o.renderMode===1?"PathTracing":"Direct":this.currentMode=t.renderMode||"Direct";const r={...t,forceDepthOutput:!0};this.currentMode==="Direct"?(this.compileDirect(r),this.ptDirty=!0):(this.compilePT(r),this.directDirty=!0);const n={...t,renderMode:"Direct",lighting:{...t.lighting||{},renderMode:0}};this.histogramMaterial.fragmentShader=fa.generateHistogramShader(n),this.histogramMaterial.needsUpdate=!0,this.syncConfigUniforms(t)}compileDirect(t){const o={...t,renderMode:"Direct",lighting:{...t.lighting||{},renderMode:0}},r=fa.generateFragmentShader(o),n=Oo(r).toString(16);n!==this.activeDirectChecksum?(console.log("=== Shader Recompilation ==="),console.log("Previous checksum:",this.activeDirectChecksum),console.log("New checksum:",n),console.log("Shader length:",r.length),console.log("Stack trace:",new Error().stack),this.materialDirect.fragmentShader=r,this.materialDirect.needsUpdate=!0,this.activeDirectChecksum=n,console.log(`[Shader Generated] Direct | Hash: ${n.substring(0,8)} | Size: ${(r.length/1024).toFixed(1)}kb`),le.emit("shader_code",r)):console.log("=== Shader Unchanged ==="),this.lastGeneratedFrag=r,this.directDirty=!1}compilePT(t){const o={...t,renderMode:"PathTracing",lighting:{...t.lighting||{},renderMode:1}},r=fa.generateFragmentShader(o),n=Oo(r).toString(16);n!==this.activePTChecksum&&(this.materialPT.fragmentShader=r,this.materialPT.needsUpdate=!0,this.activePTChecksum=n,console.log(`[Shader Generated] PathTracing | Hash: ${n.substring(0,8)} | Size: ${(r.length/1024).toFixed(1)}kb`),le.emit("shader_code",r)),this.lastGeneratedFrag=r,this.ptDirty=!1}setUniform(t,o){var i,s;let r=o;if(typeof o=="boolean"&&(r=o?1:0),o&&o.isGradientBuffer){const l=(i=this.mainUniforms[t])==null?void 0:i.value;if(l instanceof Ft){const d=new Ft(o.buffer,256,1,at);d.minFilter=Ue,d.magFilter=Ue,d.wrapS=st,d.needsUpdate=!0,l.dispose(),r=d}else{const d=new Ft(o.buffer,256,1,at);d.minFilter=Ue,d.magFilter=Ue,d.wrapS=st,d.needsUpdate=!0,r=d}}else if(Array.isArray(o)&&o.length>0&&o[0].color){const l=Ta(o),d=(s=this.mainUniforms[t])==null?void 0:s.value;if(d instanceof Ft){const c=new Ft(l,256,1,at);c.minFilter=Ue,c.magFilter=Ue,c.wrapS=st,c.needsUpdate=!0,d.dispose(),r=c}else{const c=new Ft(l,256,1,at);c.minFilter=Ue,c.magFilter=Ue,c.wrapS=st,c.needsUpdate=!0,r=c}}[this.mainUniforms,this.histogramUniforms,this.displayMaterial.uniforms,this.exportMaterial.uniforms].forEach(l=>{if(!l[t])return;const d=l[t].value;if(r instanceof ko){d instanceof ko&&d!==r&&d.dispose(),l[t].value=r;return}if(d instanceof ie)o instanceof ie?d.copy(o):typeof o=="number"&&d.setScalar(o);else if(d instanceof Se)o instanceof Se&&d.copy(o);else if(d instanceof $e)o instanceof $e?d.copy(o):d.set(o);else if(d instanceof qt&&o instanceof qt)d.copy(o);else if(d instanceof We&&o instanceof We)d.copy(o);else if(Array.isArray(d)&&Array.isArray(o))for(let c=0;c<d.length;c++)o[c]!==void 0&&(d[c]instanceof ie||d[c]instanceof $e?d[c].copy(o[c]):d[c]=o[c]);else l[t].value=r})}loadTexture(t,o){if(!o){t==="color"&&this.setUniform("uUseTexture",0);return}new io().load(o,n=>{n.minFilter=Ue,n.magFilter=Ue,n.needsUpdate=!0,t==="color"?(n.wrapS=st,n.wrapT=st,this.setUniform("uTexture",n),this.setUniform("uUseTexture",1)):(n.mapping=zr,n.minFilter=Rr,n.generateMipmaps=!0,this.setUniform(ce.EnvMapTexture,n))})}setGradient(t,o){const r=Ta(t);let n="uGradientTexture";o===2&&(n="uGradientTexture2"),o===3&&(n="uEnvGradient"),this.setUniform(n,{isGradientBuffer:!0,buffer:r})}syncModularUniforms(t){const o=this.mainUniforms[ce.ModularParams].value;ns(t,o),this.histogramUniforms[ce.ModularParams].value.set(o)}syncConfigUniforms(t){ve.getAll().forEach(r=>{const n=t[r.id];n&&Object.entries(r.params).forEach(([i,s])=>{s.uniform&&n[i]!==void 0&&this.setUniform(s.uniform,n[i])})}),t.pipeline&&this.syncModularUniforms(t.pipeline)}}class Zs{constructor(t){Z(this,"mainScene");Z(this,"mainCamera");Z(this,"mainMesh");Z(this,"displayScene");Z(this,"displayMesh");Z(this,"activeCamera",null);Z(this,"fallbackCamera");this.mainScene=new bt,this.mainCamera=new Pt(-1,1,1,-1,0,1),this.mainMesh=new jt(new Tt(2,2),t.mainMaterial),this.mainMesh.frustumCulled=!1,this.mainScene.add(this.mainMesh),this.displayScene=new bt,this.displayMesh=new jt(new Tt(2,2),t.displayMaterial),this.displayMesh.frustumCulled=!1,this.displayScene.add(this.displayMesh),this.fallbackCamera=new Fr(60,1,.1,1e3),this.fallbackCamera.position.set(0,0,0)}setMaterial(t){this.mainMesh.material=t}registerCamera(t){this.activeCamera=t}getCamera(){return this.activeCamera||this.fallbackCamera}updateFallback(t,o,r,n){this.fallbackCamera.position.copy(t),this.fallbackCamera.quaternion.copy(o),this.fallbackCamera.fov=r,this.fallbackCamera.aspect=n,this.fallbackCamera.updateMatrixWorld()}}class Ks{constructor(t,o,r,n){Z(this,"materials");Z(this,"sceneCtrl");Z(this,"virtualSpace");Z(this,"pipeline");this.materials=t,this.sceneCtrl=o,this.virtualSpace=r,this.pipeline=n}getRay(t,o,r){const n=this.materials.mainUniforms.uCamType.value,i=r;if(n>1.5){const s=t*Math.PI,l=o*(Math.PI/2),d=Math.cos(l),c=new ie(Math.sin(s)*d,Math.sin(l),-Math.cos(s)*d);return c.applyQuaternion(i.quaternion),new si(i.position.clone(),c.normalize())}else{const s=new Ea;return s.setFromCamera(new Se(t,o),i),s.ray}}measureDistance(t,o,r,n){const i=r.domElement.width,s=r.domElement.height,l=Math.floor((t+1)*.5*i),d=Math.floor((1-(o+1)*.5)*s),f=Math.floor(3/2);let u=0,p=0;for(let h=-f;h<=f;h++)for(let g=-f;g<=f;g++){const M=l+h,m=d+g;if(M>=0&&M<i&&m>=0&&m<s){const y=new Float32Array(4);if(this.pipeline.readPixels(r,M,m,1,1,y)){const x=y[3];isFinite(x)&&x>0&&x<1e3&&(u+=x,p++)}}}return p>0?u/p:-1}pickWorldPosition(t,o,r,n){const i=this.measureDistance(t,o,r,n);if(i<=0||i>=1e3)return null;const s=this.getRay(t,o,n),l=new ie().copy(s.origin).add(s.direction.multiplyScalar(i)),d=this.virtualSpace.state,c=d.x+d.xL+l.x,f=d.y+d.yL+l.y,u=d.z+d.zL+l.z;return new ie(c,f,u)}}const _r=new Uint32Array(256);for(let a=0;a<256;a++){let t=a;for(let o=0;o<8;o++)t=t&1?3988292384^t>>>1:t>>>1;_r[a]=t}const Qs=a=>{let t=-1;for(let o=0;o<a.length;o++)t=t>>>8^_r[(t^a[o])&255];return(t^-1)>>>0},$o=a=>{const t=new Uint8Array(a.length);for(let o=0;o<a.length;o++)t[o]=a.charCodeAt(o);return t},Ca=a=>{let t="";for(let o=0;o<a.length;o++)t+=String.fromCharCode(a[o]);return t},Ho=(a,t,o)=>{a[t]=o>>>24&255,a[t+1]=o>>>16&255,a[t+2]=o>>>8&255,a[t+3]=o&255},Br=async(a,t,o)=>{const r=await a.arrayBuffer(),n=new Uint8Array(r);if(n[0]!==137||n[1]!==80||n[2]!==78||n[3]!==71)throw new Error("Not a valid PNG");const i=$o(t),s=$o(o),l=i.length+1+s.length,d=12+l,c=new Uint8Array(d);Ho(c,0,l),c[4]=116,c[5]=69,c[6]=88,c[7]=116,c.set(i,8),c[8+i.length]=0,c.set(s,8+i.length+1);const f=Qs(c.slice(4,d-4));Ho(c,d-4,f);let u=8;for(;u<n.length;){const h=n[u]<<24|n[u+1]<<16|n[u+2]<<8|n[u+3];if(Ca(n.slice(u+4,u+8))==="IEND")break;u+=12+h}const p=new Uint8Array(n.length+d);return p.set(n.slice(0,u),0),p.set(c,u),p.set(n.slice(u),u+d),new Blob([p],{type:"image/png"})},Or=async(a,t)=>{const o=await a.arrayBuffer(),r=new Uint8Array(o);if(r[0]!==137||r[1]!==80)return null;let n=8;for(;n<r.length;){const i=r[n]<<24|r[n+1]<<16|r[n+2]<<8|r[n+3],s=Ca(r.slice(n+4,n+8));if(s==="tEXt"){const l=r.slice(n+8,n+8+i);let d=-1;for(let c=0;c<l.length;c++)if(l[c]===0){d=c;break}if(d!==-1&&Ca(l.slice(0,d))===t)return Ca(l.slice(d+1))}if(s==="IEND")break;n+=12+i}return null},uo=(a,t,o,r)=>{const n=a.replace(/[^a-zA-Z0-9 \-_]/g,"").trim().replace(/\s+/g,"_")||"Untitled",i=`v${t}`,s=["GMT",n,i];return r&&s.push(r),`${s.join("_")}.${o}`};class Js{constructor(){Z(this,"isRunning",!1);Z(this,"isExporting",!1);Z(this,"buckets",[]);Z(this,"currentBucketIndex",0);Z(this,"bucketFrameCount",0);Z(this,"DEFAULT_MAX_FRAMES",1024);Z(this,"originalSize",new Se);Z(this,"activeUpscale",1);Z(this,"targetResolution",new Se);Z(this,"compositeTarget",null);Z(this,"compositeMaterial",null);Z(this,"compositeScene",null);Z(this,"compositeCamera",null);Z(this,"config",{bucketSize:128,bucketUpscale:1,convergenceThreshold:.1,accumulation:!0,samplesPerBucket:64});Z(this,"exportPreset",null);Z(this,"projectName","Fractal");Z(this,"projectVersion",0)}start(t,o,r){if(!B.renderer||this.isRunning)return;this.isExporting=t,this.config={...o},this.activeUpscale=o.bucketUpscale||1,r&&(this.exportPreset=r.preset,this.projectName=r.name,this.projectVersion=r.version),B.renderer.getSize(this.originalSize);const i=Math.floor(this.originalSize.x*this.activeUpscale),s=Math.floor(this.originalSize.y*this.activeUpscale);this.targetResolution.set(i,s),B.pipeline.resize(i,s),B.mainUniforms.uResolution.value.set(i,s),this.initCompositeBuffer(i,s),this.buckets=[];const l=o.bucketSize,d=Math.ceil(i/l),c=Math.ceil(s/l);for(let f=0;f<c;f++)for(let u=0;u<d;u++){const p=u*l/i,h=f*l/s,g=Math.min(1,(u+1)*l/i),M=Math.min(1,(f+1)*l/s);this.buckets.push({minX:p,minY:h,maxX:g,maxY:M})}this.currentBucketIndex=0,this.bucketFrameCount=0,this.isRunning=!0,this.clearCompositeBuffer(),this.applyCurrentBucket(),le.emit(Fe.BUCKET_STATUS,{isRendering:!0,progress:0,totalBuckets:this.buckets.length,currentBucket:0})}initCompositeBuffer(t,o){this.disposeCompositeBuffer(),this.compositeTarget=new ft(t,o,{minFilter:Ue,magFilter:Ue,format:at,type:Wt,stencilBuffer:!1,depthBuffer:!1}),this.compositeMaterial=new Nt({uniforms:{map:{value:null},bucketMin:{value:new Se(0,0)},bucketMax:{value:new Se(1,1)}},vertexShader:`
                varying vec2 vUv;
                void main() {
                    vUv = uv;
                    gl_Position = vec4(position, 1.0);
                }
            `,fragmentShader:`
                uniform sampler2D map;
                uniform vec2 bucketMin;
                uniform vec2 bucketMax;
                varying vec2 vUv;
                
                void main() {
                    // Only render within the bucket region
                    if (vUv.x < bucketMin.x || vUv.y < bucketMin.y || 
                        vUv.x > bucketMax.x || vUv.y > bucketMax.y) {
                        discard;
                    }
                    
                    // Sample from the bucket texture
                    vec4 color = texture2D(map, vUv);
                    gl_FragColor = color;
                }
            `,depthTest:!1,depthWrite:!1,transparent:!1}),this.compositeScene=new bt;const r=new jt(new Tt(2,2),this.compositeMaterial);r.frustumCulled=!1,this.compositeScene.add(r),this.compositeCamera=new Pt(-1,1,1,-1,0,1)}clearCompositeBuffer(){if(!this.compositeTarget||!B.renderer)return;const t=B.renderer.getRenderTarget();B.renderer.setRenderTarget(this.compositeTarget),B.renderer.clear(),B.renderer.setRenderTarget(t)}disposeCompositeBuffer(){this.compositeTarget&&(this.compositeTarget.dispose(),this.compositeTarget=null),this.compositeMaterial&&(this.compositeMaterial.dispose(),this.compositeMaterial=null),this.compositeScene=null,this.compositeCamera=null}stop(){this.isRunning&&this.cleanup()}cleanup(){this.isRunning=!1,this.isExporting=!1,this.exportPreset=null;const t=new Se(0,0),o=new Se(1,1);B.materials.setUniform(ce.RegionMin,t),B.materials.setUniform(ce.RegionMax,o),B.pipeline.resize(this.originalSize.x,this.originalSize.y),B.mainUniforms.uResolution.value.set(this.originalSize.x,this.originalSize.y),B.resetAccumulation(),this.disposeCompositeBuffer(),le.emit(Fe.BUCKET_STATUS,{isRendering:!1,progress:0})}applyCurrentBucket(){if(this.currentBucketIndex>=this.buckets.length){this.finish();return}const t=this.buckets[this.currentBucketIndex],o=new Se(t.minX,t.minY),r=new Se(t.maxX,t.maxY);B.materials.setUniform(ce.RegionMin,o),B.materials.setUniform(ce.RegionMax,r),B.pipeline.resetAccumulation(),this.bucketFrameCount=0}compositeCurrentBucket(){if(!this.compositeTarget||!this.compositeMaterial||!this.compositeScene||!this.compositeCamera||!B.renderer)return;const t=B.pipeline.getOutputTexture();if(!t)return;const o=this.buckets[this.currentBucketIndex];this.compositeMaterial.uniforms.map.value=t,this.compositeMaterial.uniforms.bucketMin.value.set(o.minX,o.minY),this.compositeMaterial.uniforms.bucketMax.value.set(o.maxX,o.maxY);const r=B.renderer.getRenderTarget(),n=new jo;B.renderer.getViewport(n),B.renderer.setRenderTarget(this.compositeTarget),B.renderer.setViewport(0,0,this.targetResolution.x,this.targetResolution.y),Math.floor(o.minX*this.targetResolution.x),Math.floor(o.minY*this.targetResolution.y),Math.ceil((o.maxX-o.minX)*this.targetResolution.x),Math.ceil((o.maxY-o.minY)*this.targetResolution.y),B.renderer.render(this.compositeScene,this.compositeCamera),B.renderer.setRenderTarget(r),B.renderer.setViewport(n)}finish(){this.isExporting?this.saveImage():B.pipeline.setHold(!0),this.cleanup()}saveImage(){if(!this.compositeTarget||!B.renderer)return;if(typeof document>"u"){console.warn("BucketRenderer: Cannot save image in Worker context (DOM missing).");return}const t=this.targetResolution.x,o=this.targetResolution.y,r=new ft(t,o,{minFilter:Ue,magFilter:Ue,format:at,type:so,stencilBuffer:!1,depthBuffer:!1}),n=B.materials.exportMaterial,i=B.materials.displayMaterial;n.uniforms.map.value=this.compositeTarget.texture,n.uniforms.uResolution.value.set(t,o),i.uniforms.uGradingActive&&(n.uniforms.uGradingActive.value=i.uniforms.uGradingActive.value),n.uniforms.uSaturation.value=i.uniforms.uSaturation.value,n.uniforms.uLevelsMin.value=i.uniforms.uLevelsMin.value,n.uniforms.uLevelsMax.value=i.uniforms.uLevelsMax.value,n.uniforms.uLevelsGamma.value=i.uniforms.uLevelsGamma.value,n.uniforms.uEncodeOutput.value=1;const s=B.renderer.getRenderTarget(),l=new jo;B.renderer.getViewport(l),B.renderer.setRenderTarget(r),B.renderer.setViewport(0,0,t,o),B.renderer.clear();const d=new bt,c=new Pt(-1,1,1,-1,0,1),f=new jt(new Tt(2,2),n);d.add(f),B.renderer.render(d,c);const u=new Uint8Array(t*o*4);B.renderer.readRenderTargetPixels(r,0,0,t,o,u),B.renderer.setRenderTarget(s),B.renderer.setViewport(l),r.dispose();const p=new Uint8ClampedArray(t*o*4),h=t*4;for(let m=0;m<o;m++){const y=m*h,x=(o-1-m)*h;p.set(u.subarray(y,y+h),x)}for(let m=3;m<p.length;m+=4)p[m]=255;const g=document.createElement("canvas");g.width=t,g.height=o;const M=g.getContext("2d");if(M){const m=new ImageData(p,t,o);M.putImageData(m,0,0);const y=this.exportPreset?JSON.stringify(this.exportPreset):"{}",x=uo(this.projectName,this.projectVersion,"png",`${t}x${o}`);g.toBlob(async C=>{if(C)try{const k=await Br(C,"FractalData",y),S=URL.createObjectURL(k),b=document.createElement("a");b.download=x,b.href=S,b.click(),URL.revokeObjectURL(S)}catch(k){console.error("Failed to inject metadata",k);const S=document.createElement("a");S.download=x,S.href=g.toDataURL("image/png"),S.click()}},"image/png")}}update(t,o){if(!this.isRunning)return;o&&(this.config.convergenceThreshold=o.convergenceThreshold,this.config.accumulation=o.accumulation,o.samplesPerBucket!==void 0&&(this.config.samplesPerBucket=o.samplesPerBucket));const r=B.mainUniforms.uResolution.value;(r.x!==this.targetResolution.x||r.y!==this.targetResolution.y)&&r.set(this.targetResolution.x,this.targetResolution.y);const n=Math.min(16,(this.config.samplesPerBucket||64)/4),i=this.config.samplesPerBucket||this.DEFAULT_MAX_FRAMES;if(this.bucketFrameCount<n){this.bucketFrameCount++;return}let s=!1;const l=this.buckets[this.currentBucketIndex],d=new Se(l.minX,l.minY),c=new Se(l.maxX,l.maxY),f=this.config.accumulation?B.pipeline.measureConvergence(t,d,c):1,u=this.config.convergenceThreshold/100;if(s=f<u||this.bucketFrameCount>=i,s){if(this.compositeCurrentBucket(),this.currentBucketIndex++,this.currentBucketIndex>=this.buckets.length){this.finish();return}this.applyCurrentBucket();const p=this.currentBucketIndex/this.buckets.length*100;le.emit(Fe.BUCKET_STATUS,{isRendering:!0,progress:p,totalBuckets:this.buckets.length,currentBucket:this.currentBucketIndex})}else this.bucketFrameCount++}getProgress(){return!this.isRunning||this.buckets.length===0?0:this.currentBucketIndex/this.buckets.length*100}getIsRunning(){return this.isRunning}}const It=new Js;class el{constructor(t,o,r){Z(this,"uniforms");Z(this,"virtualSpace");Z(this,"pipeline");Z(this,"rotMatrix",new We);Z(this,"camRight",new ie);Z(this,"camUp",new ie);Z(this,"camForward",new ie);Z(this,"lightQuat",new Be);Z(this,"lightEuler",new qe);Z(this,"lightDir",new ie);Z(this,"defaultForward",new ie(0,0,-1));Z(this,"preRotMatrixX",new We);Z(this,"preRotMatrixY",new We);Z(this,"preRotMatrixZ",new We);Z(this,"preRotMatrix4",new We);Z(this,"preRotMatrix3",new qt);Z(this,"lastWidth",-1);Z(this,"lastHeight",-1);Z(this,"lastIsGizmoInteracting",!1);this.uniforms=t,this.virtualSpace=o,this.pipeline=r}syncFrame(t,o,r,n,i,s,l,d){var j,T;const c=t;if(r&&!n.isExporting&&!n.isBucketRendering){let L=Math.floor(r.domElement.width),_=Math.floor(r.domElement.height);L<1&&(L=1),_<1&&(_=1);let R=L,z=_;if((n.isGizmoInteracting||n.isCameraInteracting)&&((j=n.quality)!=null&&j.dynamicScaling)){const $=Math.max(1,n.quality.interactionDownsample||2);R=Math.max(64,Math.floor(L/$)),z=Math.max(64,Math.floor(_/$))}const E=this.uniforms[ce.Resolution].value.x,N=this.uniforms[ce.Resolution].value.y;(E!==R||N!==z)&&(console.log(`[UniformManager] Resizing from ${E}x${N} to ${R}x${z}`),this.uniforms[ce.Resolution].value.set(R,z),this.pipeline.resize(R,z),this.pipeline.resetAccumulation(),d&&(d.displayMaterial.uniforms.uResolution.value.set(R,z),d.exportMaterial.uniforms.uResolution.value.set(R,z)),this.lastWidth=R,this.lastHeight=z);const P=L/_;Number.isFinite(P)&&Math.abs(c.aspect-P)>.001&&(c.aspect=P,c.updateProjectionMatrix())}if(this.uniforms[ce.BlueNoiseTexture].value){const L=this.uniforms[ce.BlueNoiseTexture].value;L.image&&this.uniforms[ce.BlueNoiseResolution].value.set(L.image.width||128,L.image.height||128)}const f=i?i.camType>.5:!1,u=i?i.orthoScale:2,p=l["camera.rotation.x"]||0,h=l["camera.rotation.y"]||0,g=l["camera.rotation.z"]||0;let M=c.quaternion;(p!==0||h!==0||g!==0)&&(this.lightEuler.set(p,h,g,"XYZ"),this.lightQuat.setFromEuler(this.lightEuler),M=c.quaternion.clone().multiply(this.lightQuat)),this.rotMatrix.makeRotationFromQuaternion(M);const m=this.rotMatrix.elements;this.camRight.set(m[0],m[1],m[2]),this.camUp.set(m[4],m[5],m[6]),this.camForward.set(-m[8],-m[9],-m[10]);let y=1,x=1;f?(x=u/2,y=x*c.aspect):(x=Math.tan(Ze.degToRad(c.fov)*.5),y=x*c.aspect),Number.isFinite(y)||(y=1),Number.isFinite(x)||(x=1),this.uniforms[ce.CamBasisX].value.copy(this.camRight).multiplyScalar(y),this.uniforms[ce.CamBasisY].value.copy(this.camUp).multiplyScalar(x),this.uniforms[ce.CamForward].value.copy(this.camForward),this.uniforms[ce.CameraPosition].value.set(0,0,0);const C=l["camera.unified.x"]||0,k=l["camera.unified.y"]||0,S=l["camera.unified.z"]||0,b=c.position.clone();b.x+=C,b.y+=k,b.z+=S,this.virtualSpace.updateShaderUniforms(b,this.uniforms[ce.SceneOffsetHigh].value,this.uniforms[ce.SceneOffsetLow].value),this.uniforms[ce.Time].value=((T=o.clock)==null?void 0:T.elapsedTime)||performance.now()/1e3;const w=this.uniforms.uEnvRotation;if(w){const L=w.value,_=Math.cos(L),R=Math.sin(L);this.uniforms[ce.EnvRotationMatrix].value=[_,R,-R,_]}if(s&&Array.isArray(s.lights)){const L=this.uniforms[ce.LightType].value,_=this.uniforms[ce.LightPos].value,R=this.uniforms[ce.LightDir].value,z=this.uniforms[ce.LightColor].value,E=this.uniforms[ce.LightIntensity].value,N=this.uniforms[ce.LightFalloff].value,P=this.uniforms[ce.LightFalloffType].value,$=this.uniforms[ce.LightShadows].value,O=Math.min(s.lights.length,He);this.uniforms[ce.LightCount].value=O;for(let X=0;X<O;X++){const W=s.lights[X],H=l[`lighting.light${X}_intensity`]||0,A=l[`lighting.light${X}_falloff`]||0,F=l[`lighting.light${X}_posX`]||0,I=l[`lighting.light${X}_posY`]||0,D=l[`lighting.light${X}_posZ`]||0,G=l[`lighting.light${X}_rotX`]||0,q=l[`lighting.light${X}_rotY`]||0,Q=l[`lighting.light${X}_rotZ`]||0;L[X]=W.type==="Directional"?1:0,E[X]=W.visible?Math.max(0,W.intensity+H):0,N[X]=Math.max(0,W.falloff+A),P[X]=W.falloffType==="Linear"?1:0,$[X]=W.castShadow?1:0,z[X].isColor&&z[X].set(W.color);const J={x:W.position.x+F,y:W.position.y+I,z:W.position.z+D};this.virtualSpace.getLightShaderVector(J,W.fixed,c,_[X]),this.lightEuler.set(W.rotation.x+G,W.rotation.y+q,W.rotation.z+Q,"YXZ"),this.lightQuat.setFromEuler(this.lightEuler),this.lightDir.copy(this.defaultForward).applyQuaternion(this.lightQuat),W.fixed&&this.lightDir.applyQuaternion(c.quaternion),R[X].copy(this.lightDir).normalize()}}try{const _=Y.getState().geometry;if(_&&_.preRotMaster&&_.preRotEnabled){const R=(_.preRotX??0)+(l["geometry.preRotX"]||0),z=(_.preRotY??0)+(l["geometry.preRotY"]||0),E=(_.preRotZ??0)+(l["geometry.preRotZ"]||0);this.preRotMatrixX.makeRotationX(R),this.preRotMatrixY.makeRotationY(z),this.preRotMatrixZ.makeRotationZ(E),this.preRotMatrix4.identity().multiply(this.preRotMatrixZ).multiply(this.preRotMatrixX).multiply(this.preRotMatrixY),this.preRotMatrix3.setFromMatrix4(this.preRotMatrix4);const N=this.uniforms[ce.PreRotMatrix];N&&N.value.copy(this.preRotMatrix3)}}catch{}}}class tl{constructor(t){Z(this,"config");Z(this,"uniformToPath",new Map);this.config={...t},this.buildUniformMap()}rebuildMap(){this.uniformToPath.clear(),this.buildUniformMap()}buildUniformMap(){ve.getAll().forEach(o=>{Object.entries(o.params).forEach(([r,n])=>{n.uniform&&this.uniformToPath.set(n.uniform,{featureId:o.id,paramId:r,isCompileTime:n.onUpdate==="compile"})})})}syncUniform(t,o){const r=this.uniformToPath.get(t);if(r){if(r.isCompileTime)return;const{featureId:n,paramId:i}=r;this.config[n]||(this.config[n]={}),this.config[n][i]=o}}areValuesEqual(t,o){if(t===o)return!0;if(t==null||o===null||o===void 0)return t===o;if(typeof t=="number"&&typeof o=="number")return Math.abs(t-o)<1e-6;if(typeof t=="object"&&typeof o=="object"){if(t.isColor&&o.isColor)return t.getHex()===o.getHex();if(t.isVector3&&o.isVector3)return Math.abs(t.x-o.x)<1e-6&&Math.abs(t.y-o.y)<1e-6&&Math.abs(t.z-o.z)<1e-6;if(t.isVector2&&o.isVector2)return Math.abs(t.x-o.x)<1e-6&&Math.abs(t.y-o.y)<1e-6;if(t.isVector3||o.isVector3){const r=t.isVector3?t:new ie(t.x,t.y,t.z),n=o.isVector3?o:new ie(o.x,o.y,o.z);return Math.abs(r.x-n.x)<1e-6&&Math.abs(r.y-n.y)<1e-6&&Math.abs(r.z-n.z)<1e-6}if(t.isVector2||o.isVector2){const r=t.isVector2?t:new Se(t.x,t.y),n=o.isVector2?o:new Se(o.x,o.y);return Math.abs(r.x-n.x)<1e-6&&Math.abs(r.y-n.y)<1e-6}if(t.isColor||o.isColor){const r=t.isColor?t:new $e(t),n=o.isColor?o:new $e(o);return r.getHex()===n.getHex()}if(Array.isArray(t)&&Array.isArray(o))return t.length!==o.length?!1:JSON.stringify(t)===JSON.stringify(o)}return!1}update(t,o){var l;t.quality&&t.quality.compilerHardCap!==void 0&&(t.compilerHardCap=t.quality.compilerHardCap),t.compilerHardCap===void 0&&(t.compilerHardCap=((l=o.quality)==null?void 0:l.compilerHardCap)||o.compilerHardCap||500),t.renderMode===void 0&&(t.renderMode=o.renderMode),t.isMobile===void 0&&(t.isMobile=o.isMobile);let r=!1,n=!1,i=!1;const s=ve.getAll();for(const d of s)if(t[d.id]){const c=t[d.id],f=this.config[d.id]||{};if(d.id==="lighting"&&c.renderMode!==void 0){const u=f.renderMode;this.areValuesEqual(c.renderMode,u)||(i=!0,this.config.renderMode=c.renderMode===1?"PathTracing":"Direct")}for(const u in c){const p=d.params[u];if(p&&p.onUpdate==="compile"){const h=c[u],g=f[u]!==void 0?f[u]:p.default;this.areValuesEqual(h,g)||(Object.keys(f).length>0&&console.log(`[ConfigManager] Rebuild triggered by ${d.id}.${u}:`,g,"->",h),r=!0)}}this.config[d.id]={...f,...c},n=!0}return t.formula&&t.formula!==this.config.formula&&(console.log(`[ConfigManager] Formula changed: ${this.config.formula} -> ${t.formula}`),this.config.formula=t.formula,r=!0),t.renderMode!==void 0&&t.renderMode!==this.config.renderMode&&(this.config.renderMode=t.renderMode,i=!0,this.config.lighting||(this.config.lighting={}),this.config.lighting.renderMode=t.renderMode==="PathTracing"?1:0),t.compilerHardCap!==void 0&&t.compilerHardCap!==this.config.compilerHardCap&&(this.config.compilerHardCap=t.compilerHardCap,r=!0),t.isMobile!==void 0&&t.isMobile!==this.config.isMobile&&(this.config.isMobile=t.isMobile,r=!0),t.graph&&(this.config.graph=t.graph),t.pipelineRevision!==void 0&&t.pipelineRevision!==this.config.pipelineRevision?(this.config.pipelineRevision=t.pipelineRevision,t.pipeline&&(this.config.pipeline=t.pipeline),this.config.formula==="Modular"&&(r=!0)):t.pipeline&&(this.config.pipeline=t.pipeline,n=!0),{rebuildNeeded:r,uniformUpdate:n,modeChanged:i}}}const $r={id:"Mandelbulb",name:"Mandelbulb",shortDescription:"The classic 3D extension of the Mandelbrot set. Features organic, broccoli-like recursive structures.",description:'The classic 3D extension of the Mandelbrot set. Features standard Power controls plus the "Radiolaria" mutation for skeletal/hollow effects.',shader:{function:`
        void formula_Mandelbulb(inout vec4 z, inout float dr, inout float trap, vec4 c) {
            vec3 z3 = z.xyz;
            float r = length(z3);
            
            // Standard derivative
            float power = uParamA;
            dr = pow(r, power - 1.0) * power * dr + 1.0;
            
            // Spherical exponentiation
            float theta = acos(clamp(z3.z / r, -1.0, 1.0));
            float phi = atan(z3.y, z3.x);
            
            // Apply Power & Phase Shifts
            theta = theta * power + uParamB; 
            phi = phi * power + uParamC;     
            
            float zr = pow(r, power);
            z3 = zr * vec3(sin(theta) * cos(phi), sin(phi) * sin(theta), cos(theta));
            
            // Optional Z-Twist (Param D)
            if (abs(uParamD) > 0.001) {
                float twist = z3.z * uParamD;
                float s = sin(twist);
                float c_ = cos(twist);
                z3.xy = mat2(c_, -s, s, c_) * z3.xy;
            }

            z3 += c.xyz;
            
            // --- RADIOLARIA MUTATION (Tom Beddard) ---
            // Applied AFTER iteration to affect the triplex structure, not the world bounding box.
            if (uParamE > 0.5) {
                float limit = uParamF;
                if (z3.y > limit) {
                    z3.y = limit;
                    // Removed trap override to allow gradients to form naturally on the cut surface
                }
            }
            
            z.xyz = z3;
            trap = min(trap, length(z3));
        }`,loopBody:"formula_Mandelbulb(z, dr, trap, c);"},parameters:[{label:"Power",id:"paramA",min:2,max:16,step:.001,default:8},{label:"Theta Phase",id:"paramB",min:-3.14,max:3.14,step:.01,default:0,scale:"pi"},{label:"Phi Phase",id:"paramC",min:-6.28,max:6.28,step:.01,default:0,scale:"pi"},{label:"Z Twist",id:"paramD",min:-2,max:2,step:.01,default:0},{label:"Radiolaria",id:"paramE",min:0,max:1,step:1,default:0},{label:"Radio Limit",id:"paramF",min:-2,max:2,step:.01,default:.5}],defaultPreset:{formula:"Mandelbulb",features:{coreMath:{iterations:16,paramA:8,paramB:0,paramC:0,paramD:0,paramE:0,paramF:.5},geometry:{hybridMode:!1,hybridIter:0,hybridScale:2,hybridMinR:.5,hybridFixedR:1,hybridFoldLimit:1,hybridSkip:1,hybridSwap:!1,juliaMode:!1,juliaX:0,juliaY:0,juliaZ:0},coloring:{mode:0,repeats:2,phase:0,scale:1,offset:0,bias:1,twist:0,escape:1.2,mode2:4,repeats2:7,phase2:0,blendMode:0,blendOpacity:0,twist2:0,layer3Color:"#ffffff",layer3Scale:20,layer3Strength:0,layer3Bump:0,layer3Turbulence:0,gradient:[{id:"2",position:1,color:"#FFFFFF",bias:.5,interpolation:"linear"}],gradient2:[{id:"1767363622003",position:0,color:"#FFFFFF",bias:.5,interpolation:"linear"},{id:"1",position:.5,color:"#000000",bias:.5,interpolation:"linear"},{id:"1767363615540",position:1,color:"#FFFFFF",bias:.5,interpolation:"linear"}]},texturing:{active:!1,scaleX:1,scaleY:1,offset:{x:0,y:0},mapU:6,mapV:1,layer1Data:null},atmosphere:{fogNear:0,fogFar:5,fogColor:"#000000",fogDensity:0,glowIntensity:0,glowSharpness:50,glowColor:"#ffffff",glowMode:!1},ao:{aoIntensity:.28,aoSpread:.5,aoMode:!1,aoEnabled:!0,aoSamples:5,aoStochasticCp:!0},materials:{reflection:.2,specular:1,roughness:.75,diffuse:1,envStrength:.3,rim:0,rimExponent:3,emission:0,emissionMode:0,emissionColor:"#ffffff",envMapVisible:!1,useEnvMap:!0,envSource:1,envGradientStops:[{id:"hor",position:0,color:"#223344",bias:.5,interpolation:"smooth"},{id:"zen",position:1,color:"#88ccff",bias:.5,interpolation:"smooth"}]},lighting:{shadows:!0,shadowSoftness:16,shadowIntensity:1,shadowBias:.001},quality:{detail:1,fudgeFactor:1,pixelThreshold:.2,maxSteps:300,distanceMetric:0,estimator:0},optics:{dofStrength:0,dofFocus:2},colorGrading:{saturation:1,levelsMin:0,levelsMax:1,levelsGamma:1}},cameraPos:{x:0,y:0,z:2.157},cameraRot:{x:0,y:0,z:0,w:1},sceneOffset:{x:0,y:0,z:1,xL:0,yL:0,zL:-.157},targetDistance:2.157,cameraMode:"Orbit",lights:[{type:"Point",position:{x:-.7,y:.37,z:1.4},rotation:{x:0,y:0,z:0},color:"#ffffff",intensity:3,falloff:.22,falloffType:"Quadratic",fixed:!1,visible:!0,castShadow:!0},{type:"Point",position:{x:.6,y:-.5,z:1.4},rotation:{x:0,y:0,z:0},color:"#ff8800",intensity:.5,falloff:0,falloffType:"Quadratic",fixed:!1,visible:!0,castShadow:!0},{type:"Point",position:{x:0,y:-5,z:2},rotation:{x:0,y:0,z:0},color:"#0088ff",intensity:.25,falloff:0,falloffType:"Quadratic",fixed:!0,visible:!0,castShadow:!1}],renderMode:"Direct",navigation:{flySpeed:.5,autoSlow:!0},animations:[],sequence:{durationFrames:300,fps:30,tracks:{}},duration:300}},Hr={id:"Mandelbar3D",name:"Mandelbar 3D",shortDescription:"The 3D Tricorn. Features heavy shelving and tri-corner symmetry.",description:'Also known as the "Tricorn" in 2D. Now with offset and twisting capabilities.',shader:{function:`
    void formula_Mandelbar3D(inout vec4 z, inout float dr, inout float trap, vec4 c, mat2 rotX, mat2 rotZ) {
        vec3 z3 = z.xyz;
        
        // Param F: Twist
        if (abs(uParamF) > 0.001) {
            float ang = z3.z * uParamF;
            float s = sin(ang); float co = cos(ang);
            z3.xy = mat2(co, -s, s, co) * z3.xy;
        }

        z3.yz = rotX * z3.yz;
        z3.xy = rotZ * z3.xy;
        
        float x = z3.x; float y = z3.y; float z_ = z3.z;
        z3.x = x*x - y*y - z_*z_;
        z3.y = 2.0 * x * y;
        z3.z = -2.0 * x * z_;
        
        float r = length(vec3(x,y,z_));
        dr = 2.0 * r * dr + 1.0;
        
        // Scale (A) and Offset (B, E)
        float scale = uParamA;
        z3 = z3 * scale + c.xyz;
        
        // Apply Offsets
        z3 += vec3(uParamB, 0.0, uParamE); 
        
        dr *= abs(scale);
        z.xyz = z3;
        trap = min(trap, dot(z3,z3));
    }`,loopInit:`
        float angC = uParamC;
        float sC = sin(angC), cC = cos(angC);
        mat2 rotX = mat2(cC, -sC, sC, cC);
        
        float angD = uParamD;
        float sD = sin(angD), cD = cos(angD);
        mat2 rotZ = mat2(cD, -sD, sD, cD);
        `,loopBody:"formula_Mandelbar3D(z, dr, trap, c, rotX, rotZ);"},parameters:[{label:"Scale",id:"paramA",min:.5,max:3,step:.001,default:1},{label:"Offset X",id:"paramB",min:-2,max:2,step:.001,default:0},{label:"Rot X",id:"paramC",min:0,max:6.28,step:.01,default:0,scale:"pi"},{label:"Rot Z",id:"paramD",min:0,max:6.28,step:.01,default:0,scale:"pi"},{label:"Offset Z",id:"paramE",min:-2,max:2,step:.001,default:0},{label:"Twist",id:"paramF",min:-2,max:2,step:.01,default:0}],defaultPreset:{formula:"Mandelbar3D",features:{coreMath:{iterations:26,paramA:1.303,paramB:.309,paramC:.56,paramD:0,paramE:0,paramF:0},coloring:{mode:6,repeats:1,phase:0,scale:1,offset:0,bias:1,twist:0,escape:4,mode2:5,repeats2:1,phase2:0,blendMode:2,blendOpacity:1,twist2:0,layer3Color:"#ffffff",layer3Scale:2,layer3Strength:0,layer3Bump:0,layer3Turbulence:0,gradient:[{id:"1766240207225_0",position:0,color:"#3d5941",bias:.5,interpolation:"linear"},{id:"1766240207225_1",position:.167,color:"#778868",bias:.5,interpolation:"linear"},{id:"1766240207225_2",position:.333,color:"#b5b991",bias:.5,interpolation:"linear"},{id:"1766240207225_3",position:.5,color:"#f6edbd",bias:.5,interpolation:"linear"},{id:"1766240207225_4",position:.667,color:"#edbb8a",bias:.5,interpolation:"linear"},{id:"1766240207225_5",position:.833,color:"#de8a5a",bias:.5,interpolation:"linear"},{id:"1766240207225_6",position:1,color:"#ca562c",bias:.5,interpolation:"linear"}],gradient2:[{id:"1",position:.61,color:"#FFFFFF"},{id:"2",position:.88,color:"#FF0505"}]},atmosphere:{fogNear:1e-4,fogFar:501,fogColor:"#000000",fogDensity:0,glowIntensity:1e-4,glowSharpness:1,glowColor:"#ffffff",glowMode:!1,aoIntensity:.37,aoSpread:.1},materials:{reflection:.35,specular:0,roughness:.38,diffuse:0,envStrength:0,rim:0,rimExponent:2,emission:2.59,emissionColor:"#ffffff",emissionMode:0},geometry:{juliaMode:!1,juliaX:.04,juliaY:-.12,juliaZ:-.24},lighting:{shadows:!0,shadowSoftness:78,shadowIntensity:1,shadowBias:0},quality:{detail:1.17,fudgeFactor:.7,pixelThreshold:.13,aaMode:"Auto",aaLevel:1}},cameraPos:{x:-.9750951483888902,y:.4967096298390524,z:-1.878572142465631},cameraRot:{x:-.35319547668295764,y:.8984954585062485,z:.19510512782513617,w:-.17289550425237224},sceneOffset:{x:0,y:0,z:0,xL:-.003768067067355675,yL:.19239495665458275,zL:-.5314800136479048},lights:[{type:"Point",position:{x:-.34,y:.2,z:1.76},rotation:{x:0,y:0,z:0},color:"#99A4FF",intensity:5,falloff:61.5,falloffType:"Quadratic",fixed:!1,visible:!1,castShadow:!0},{type:"Point",position:{x:.05,y:.075,z:-.1},rotation:{x:0,y:0,z:0},color:"#ff0000",intensity:.5,falloff:.5,falloffType:"Quadratic",fixed:!1,visible:!1,castShadow:!1},{type:"Point",position:{x:.25,y:.075,z:-.1},rotation:{x:0,y:0,z:0},color:"#0000ff",intensity:.5,falloff:.5,falloffType:"Quadratic",fixed:!1,visible:!1,castShadow:!1}]}},Ur={id:"Quaternion",name:"Quaternion",shortDescription:'A 3D slice of a 4D Julia set. Use the "Slice W" and Rotations to morph the object.',description:"A 4D Julia set projected into 3D. Now features 4D rotations to explore the hyperslice.",shader:{function:`
    void formula_Quaternion(inout vec4 z, inout float dr, inout float trap, vec4 c) {
        // 4D Rotation Injection
        // We rotate the 4D vector z before squaring.
        // Param C: XY, Param D: XZ, Param E: XW, Param F: YW
        
        float angXY = uParamC;
        if (abs(angXY) > 0.0) {
            float s = sin(angXY), c_ = cos(angXY);
            z.xy = mat2(c_, -s, s, c_) * z.xy;
        }
        
        float angXZ = uParamD;
        if (abs(angXZ) > 0.0) {
            float s = sin(angXZ), c_ = cos(angXZ);
            z.xz = mat2(c_, -s, s, c_) * z.xz;
        }
        
        float angXW = uParamE;
        if (abs(angXW) > 0.0) {
            float s = sin(angXW), c_ = cos(angXW);
            vec2 xw = vec2(z.x, z.w);
            xw = mat2(c_, -s, s, c_) * xw;
            z.x = xw.x; z.w = xw.y;
        }
        
        float angYW = uParamF;
        if (abs(angYW) > 0.0) {
            float s = sin(angYW), c_ = cos(angYW);
            vec2 yw = vec2(z.y, z.w);
            yw = mat2(c_, -s, s, c_) * yw;
            z.y = yw.x; z.w = yw.y;
        }

        // Chain Rule: Magnitude increases by 2*|z| + 1 (from +c)
        dr = 2.0 * length(z) * dr + 1.0;
        z = quatSquare(z) + c;
        trap = min(trap, dot(z,z));
    }`,loopBody:"formula_Quaternion(z, dr, trap, c);"},parameters:[{label:"Julia C (W)",id:"paramA",min:-1,max:1,step:.001,default:-.5},{label:"Slice W",id:"paramB",min:-1,max:1,step:.001,default:0},{label:"Rot XY",id:"paramC",min:0,max:6.28,step:.01,default:0,scale:"pi"},{label:"Rot XZ",id:"paramD",min:0,max:6.28,step:.01,default:0,scale:"pi"},{label:"Rot XW (4D)",id:"paramE",min:0,max:6.28,step:.01,default:0,scale:"pi"},{label:"Rot YW (4D)",id:"paramF",min:0,max:6.28,step:.01,default:0,scale:"pi"}],defaultPreset:{formula:"Quaternion",features:{coreMath:{iterations:20,paramA:-.252,paramB:-.222,paramC:-6.44,paramD:.29,paramE:-.21,paramF:.05},coloring:{mode:6,repeats:1,phase:.73,scale:1,offset:.73,bias:1,twist:0,escape:54.95,mode2:4,repeats2:1,phase2:0,blendMode:0,blendOpacity:0,twist2:0,layer3Color:"#ffffff",layer3Scale:2,layer3Strength:0,layer3Bump:0,layer3Turbulence:0,gradient:[{id:"1766241181174_0",position:0,color:"#DA9F1C",bias:.5,interpolation:"linear"},{id:"1766241181174_1",position:.167,color:"#FA752D",bias:.5,interpolation:"linear"},{id:"1766241181174_2",position:.333,color:"#F0483F",bias:.5,interpolation:"linear"},{id:"1766241181174_3",position:.5,color:"#E3264F",bias:.5,interpolation:"linear"},{id:"1766241181174_4",position:.667,color:"#DC266B",bias:.5,interpolation:"linear"},{id:"1766241181174_5",position:.833,color:"#b9257a",bias:.5,interpolation:"linear"},{id:"1766241181174_6",position:1,color:"#7c1d6f",bias:.5,interpolation:"linear"}],gradient2:[{id:"1",position:0,color:"#000000"},{id:"2",position:1,color:"#FFFFFF"}]},atmosphere:{fogNear:0,fogFar:100,fogColor:"#000000",fogDensity:0,glowIntensity:.23,glowSharpness:3.8,glowColor:"#ffffff",glowMode:!1,aoIntensity:0,aoSpread:2},materials:{reflection:.32,specular:.47,roughness:.5,diffuse:2,envStrength:0,rim:0,rimExponent:3.6,emission:1e-4,emissionColor:"#ffffff",emissionMode:0},geometry:{juliaMode:!0,juliaX:.65,juliaY:-.2,juliaZ:-1.2,hybridMode:!1,hybridIter:2,hybridScale:2,hybridMinR:.5,hybridFixedR:1,hybridFoldLimit:1},lighting:{shadows:!0,shadowSoftness:16,shadowIntensity:1,shadowBias:.002},quality:{detail:1,fudgeFactor:.8,pixelThreshold:.5,maxSteps:300,aaMode:"Always",aaLevel:1},optics:{dofStrength:0,dofFocus:10}},cameraPos:{x:-2.448955788675867,y:.7723538718365539,z:.32605384095213635},cameraRot:{x:-.1135398122615654,y:-.6512503200884421,z:-.09942502462227083,w:.7437045085887076},cameraFov:60,sceneOffset:{x:0,y:0,z:0,xL:-.5453734613707567,yL:.10050638429037613,zL:-.211008843702685},cameraMode:"Orbit",lights:[{type:"Point",position:{x:-2.0026065897203154,y:.7668302923678636,z:.21579993050482316},rotation:{x:0,y:0,z:0},color:"#ffffff",intensity:1,falloff:1,falloffType:"Quadratic",fixed:!1,visible:!0,castShadow:!0},{type:"Point",position:{x:.05,y:.075,z:-.1},rotation:{x:0,y:0,z:0},color:"#ff0000",intensity:.5,falloff:.5,falloffType:"Quadratic",fixed:!1,visible:!1,castShadow:!1},{type:"Point",position:{x:.25,y:.075,z:-.1},rotation:{x:0,y:0,z:0},color:"#0000ff",intensity:.5,falloff:.5,falloffType:"Quadratic",fixed:!1,visible:!1,castShadow:!1}],animations:[{id:"4yFFplV3QPo3KoNaGJwfX",enabled:!1,target:"coreMath.paramA",shape:"Sine",period:5,amplitude:1,baseValue:-.252,phase:0,smoothing:.5}]}},Gr={id:"AmazingBox",name:"Amazing Box",shortDescription:"Architectural fractal discovered by Tglad. Creates complex geometric lattices and Borg-like structures.",description:"Also known as the Mandelbox (Tglad). A folding fractal that creates complex, machine-like architectural structures.",shader:{function:`
    void formula_AmazingBox(inout vec4 z, inout float dr, inout float trap, vec4 c) {
        vec3 z3 = z.xyz;
        
        // Pre-Fold Rotation (Param E = Rot X, Param F = Rot Z)
        float angX = uParamE;
        float angZ = uParamF;
        if (abs(angX) > 0.001 || abs(angZ) > 0.001) {
             float sx = sin(angX), cx = cos(angX);
             float sz = sin(angZ), cz = cos(angZ);
             mat2 rotX = mat2(cx, -sx, sx, cx);
             mat2 rotZ = mat2(cz, -sz, sz, cz);
             z3.yz = rotX * z3.yz;
             z3.xy = rotZ * z3.xy;
        }

        boxFold(z3, dr, uParamC);
        sphereFold(z3, dr, uParamB, uParamD);
        z.xyz = z3 * uParamA + c.xyz;
        dr = dr * abs(uParamA) + 1.0;
        trap = min(trap, abs(z.x));
    }`,loopBody:"formula_AmazingBox(z, dr, trap, c);"},parameters:[{label:"Scale",id:"paramA",min:1,max:4,step:.001,default:2},{label:"Min Radius",id:"paramB",min:0,max:1.5,step:.001,default:.5},{label:"Folding Limit",id:"paramC",min:.1,max:2,step:.001,default:1},{label:"Fixed Radius",id:"paramD",min:.1,max:3,step:.001,default:1},{label:"Rot X (Pre)",id:"paramE",min:0,max:6.28,step:.01,default:0,scale:"pi"},{label:"Rot Z (Pre)",id:"paramF",min:0,max:6.28,step:.01,default:0,scale:"pi"}],defaultPreset:{formula:"AmazingBox",features:{coreMath:{iterations:21,paramA:2.566,paramB:1.026,paramC:1.445,paramD:1.637,paramE:3.14,paramF:1.57},geometry:{juliaMode:!1,juliaX:.35,juliaY:.25,juliaZ:.15},atmosphere:{fogIntensity:1,fogColor:"#6DBAB7",fogNear:.7921,fogFar:7.5076,fogDensity:0,glowIntensity:1e-4,glowSharpness:1,aoIntensity:.32,aoSpread:.2925,aoMode:!1},materials:{diffuse:1.13,reflection:0,specular:2,roughness:.2,rim:0,rimExponent:1,emission:1e-4,envStrength:0,envMapVisible:!1},coloring:{mode:3,scale:113.5,offset:-5.465,repeats:69.1,phase:.36,bias:1,escape:32.06,gradient:[{id:"0",position:0,color:"#d3f2a3"},{id:"1",position:.167,color:"#97e196"},{id:"2",position:.333,color:"#6cc08b"},{id:"3",position:.5,color:"#4c9b82"},{id:"4",position:.667,color:"#217a79"},{id:"5",position:.833,color:"#105965"},{id:"6",position:1,color:"#074050"}],mode2:8,repeats2:96.2,phase2:-2.898,blendMode:6,gradient2:[{id:"0",position:0,color:"#ffffff"},{id:"1",position:.293,color:"#000000"},{id:"2",position:.903,color:"#ffffff"}],layer3Scale:89,layer3Strength:0},lighting:{shadows:!0,shadowSoftness:2e3,shadowIntensity:1,shadowBias:.0029},quality:{fudgeFactor:.5,detail:2,pixelThreshold:.5,maxSteps:300,distanceMetric:1,estimator:1},optics:{camType:0,camFov:60,orthoScale:17.5}},cameraPos:{x:.95989,y:1.13902,z:1.1791},cameraRot:{x:-.235,y:.3667,z:.2665,w:.8598},sceneOffset:{x:1,y:1,z:3,xL:-.65997,yL:-.75248,zL:-.10163},targetDistance:1.9,cameraMode:"Orbit",lights:[{type:"Point",position:{x:-.774,y:.079,z:3.089},rotation:{x:0,y:0,z:0},color:"#FFFFFF",intensity:50,falloff:50,falloffType:"Quadratic",fixed:!1,visible:!0,castShadow:!0},{type:"Point",position:{x:.05,y:.075,z:-.1},rotation:{x:0,y:0,z:0},color:"#ff0000",intensity:.5,falloff:.5,falloffType:"Quadratic",fixed:!1,visible:!1,castShadow:!1},{type:"Point",position:{x:.25,y:.075,z:-.1},rotation:{x:0,y:0,z:0},color:"#0000ff",intensity:.5,falloff:.5,falloffType:"Quadratic",fixed:!1,visible:!1,castShadow:!1}],animations:[{id:"4yFFplV3QPo3KoNaGJwfX",enabled:!1,target:"coreMath.paramA",shape:"Sine",period:5,amplitude:1,baseValue:2.566,phase:0,smoothing:.5}]}},Wr={id:"MengerSponge",name:"Menger Sponge",shortDescription:"The classic cubic fractal. Creates infinite grids and tech-like structures.",description:'The canonical Menger Sponge (Level N). Set Scale to 3.0 and Offset to 1.0 for the classic mathematical shape. Use "Center Z" to toggle between a corner fractal and the full cube.',shader:{function:`
    void formula_MengerSponge(inout vec4 z, inout float dr, inout float trap, vec4 c) {
        vec3 z3 = z.xyz;
        
        // Rotation
        float angX = uParamC;
        float angZ = uParamD;
        if (abs(angX) > 0.001 || abs(angZ) > 0.001) {
             float sx = sin(angX), cx = cos(angX);
             float sz = sin(angZ), cz = cos(angZ);
             mat2 rotX = mat2(cx, -sx, sx, cx);
             mat2 rotZ = mat2(cz, -sz, sz, cz);
             z3.yz = rotX * z3.yz;
             z3.xy = rotZ * z3.xy;
        }

        z3 = abs(z3);
        if (z3.x < z3.y) z3.xy = z3.yx;
        if (z3.x < z3.z) z3.xz = z3.zx;
        if (z3.y < z3.z) z3.yz = z3.zy;
        
        float scale = (abs(uParamA - 1.0) < 0.001) ? 1.001 : uParamA;
        float offset = uParamB;
        
        // IFS Shift: offset * (scale - 1.0)
        float shift = offset * (scale - 1.0);
        
        z3 = z3 * scale - vec3(shift);
        
        // Param F: Center Z (The "Full Sponge" Correction)
        // If active, this conditional shift restores the full cubic symmetry
        if (uParamF > 0.5) {
            if (z3.z < -0.5 * shift) {
                z3.z += shift;
            }
        }
        
        // Param E: Manual Z Shift (Axis Shift)
        if (abs(uParamE) > 0.001) {
            z3.z += uParamE * scale;
        }

        if (uJuliaMode > 0.5) z3 += c.xyz * 0.1;
        dr = dr * abs(scale);
        z.xyz = z3;
        trap = min(trap, length(z3 - c.xyz));
    }`,loopBody:"formula_MengerSponge(z, dr, trap, c);"},parameters:[{label:"Scale",id:"paramA",min:1,max:4,step:.001,default:3},{label:"Offset",id:"paramB",min:0,max:2,step:.001,default:1},{label:"Rot X",id:"paramC",min:0,max:6.28,step:.01,default:0,scale:"pi"},{label:"Rot Z",id:"paramD",min:0,max:6.28,step:.01,default:0,scale:"pi"},{label:"Z Shift (Man)",id:"paramE",min:-1,max:1,step:.01,default:0},{label:"Center Z",id:"paramF",min:0,max:1,step:1,default:1}],defaultPreset:{version:1,name:"MengerSponge",formula:"MengerSponge",features:{coreMath:{iterations:10,paramA:3,paramB:1.013,paramC:.031415926535897934,paramD:0,paramE:.02,paramF:1},geometry:{applyTransformLogic:!0,preRotMaster:!0,hybridComplex:!1,burningEnabled:!1,hybridMode:!1,hybridIter:0,hybridFoldLimit:1,hybridScale:2,hybridMinR:.5,hybridFixedR:1,hybridAddC:!1,hybridProtect:!0,hybridSwap:!1,hybridSkip:1,preRotEnabled:!1,preRotY:0,preRotX:0,preRotZ:0,juliaMode:!1,juliaX:0,juliaY:0,juliaZ:0,preRot:{x:0,y:0,z:0},julia:{x:0,y:0,z:0}},lighting:{advancedLighting:!0,ptEnabled:!0,renderMode:0,ptBounces:3,ptGIStrength:1,shadowsCompile:!0,shadowAlgorithm:0,ptStochasticShadows:!1,shadows:!0,shadowSteps:128,shadowSoftness:2000.0000000000002,shadowIntensity:.8,shadowBias:.001,lights:[{type:"Point",position:{x:-.9689439564723806,y:1.464759551794367,z:1.3253877287915055},rotation:{x:0,y:0,z:0},color:"#ffffff",intensity:5,falloff:0,falloffType:"Linear",fixed:!1,visible:!0,castShadow:!0},{type:"Point",position:{x:-4,y:-2,z:1},rotation:{x:0,y:0,z:0},color:"#3344ff",intensity:.5,falloff:0,falloffType:"Linear",fixed:!1,visible:!1,castShadow:!1},{type:"Point",position:{x:2.068536018579901,y:1.017402618613485,z:2.7478079181187756},rotation:{x:0,y:0,z:0},color:"#ff3300",intensity:.3,falloff:0,falloffType:"Linear",fixed:!1,visible:!1,castShadow:!0}]},ao:{aoIntensity:.5,aoSpread:5,aoSamples:5,aoMode:!0,aoMaxSamples:32,aoStochasticCp:!0,aoEnabled:!0},reflections:{mixStrength:1,roughnessThreshold:.5,bounces:1,steps:64,enabled:!0},atmosphere:{glowEnabled:!0,glowQuality:0,fogIntensity:0,fogNear:2,fogFar:10,fogColor:"#000000",fogDensity:0,glowIntensity:0,glowSharpness:0,glowMode:!1,glowColor:"#ffffff"},materials:{diffuse:1,reflection:0,specular:.2,roughness:.8,rim:0,rimExponent:4,envStrength:0,envMapVisible:!1,envBackgroundStrength:1,envSource:1,envMapData:null,useEnvMap:!1,envRotation:0,envGradientStops:[],emission:0,emissionMode:0,emissionColor:"#ffffff",ptEmissionMult:1},waterPlane:{waterEnabled:!1,active:!0,height:-2,color:"#001133",roughness:.02,waveStrength:.1,waveSpeed:1,waveFrequency:1.5},coloring:{gradient:[{id:"1767569325432_0",position:0,color:"#3d5941",bias:.5,interpolation:"linear"},{id:"1767569325432_1",position:.167,color:"#778868",bias:.5,interpolation:"linear"},{id:"1767569325432_2",position:.333,color:"#b5b991",bias:.5,interpolation:"linear"},{id:"1767569325432_3",position:.5,color:"#f6edbd",bias:.5,interpolation:"linear"},{id:"1767569325432_4",position:.667,color:"#edbb8a",bias:.5,interpolation:"linear"},{id:"1767569325432_5",position:.833,color:"#de8a5a",bias:.5,interpolation:"linear"},{id:"1767569325432_6",position:1,color:"#ca562c",bias:.5,interpolation:"linear"}],mode:6,scale:3.0985303168818445,offset:-.19383131979877546,repeats:3.1,phase:-.19,bias:1,twist:0,escape:1.9,gradient2:[{id:"1",position:0,color:"#000000"},{id:"2",position:1,color:"#ffffff"}],mode2:5,scale2:1,offset2:0,repeats2:1,phase2:0,bias2:1,twist2:0,blendMode:0,blendOpacity:0,layer3Color:"#ffffff",layer3Scale:10,layer3Strength:0,layer3Bump:0,layer3Turbulence:0},texturing:{active:!1,layer1Data:null,mapU:6,mapV:1,scaleX:1,scaleY:1,offset:{x:0,y:0},textureScale:{x:1,y:1}},quality:{engineQuality:!0,compilerHardCap:500,precisionMode:0,bufferPrecision:0,maxSteps:200,distanceMetric:0,estimator:4,fudgeFactor:1,detail:1,pixelThreshold:.001,dynamicScaling:!1,interactionDownsample:2},droste:{active:!1,tiling:1,center:{x:0,y:0},radiusInside:5,radiusOutside:100,periodicity:2,strands:2,autoPeriodicity:!1,strandMirror:!1,zoom:0,rotate:0,rotateSpin:0,rotatePolar:0,twist:!0,hyperDroste:!1,fractalPoints:1},colorGrading:{active:!1,saturation:1,levelsMin:0,levelsMax:1,levelsGamma:1},optics:{camType:0,camFov:50,orthoScale:2,dofStrength:0,dofFocus:10},navigation:{flySpeed:.5,autoSlow:!0},audio:{threshold:.1,agcEnabled:!1,attack:.1,decay:.3,highPass:20,lowPass:2e4,gain:1},drawing:{activeTool:"rect",enabled:!1,active:!1,originMode:1,color:"#00ffff",lineWidth:1,showLabels:!0,showAxes:!1,shapes:[],refreshTrigger:0},modulation:{rules:[],selectedRuleId:null},webcam:{opacity:1,posX:20,posY:80,width:320,height:240,cropL:0,cropR:0,cropT:0,cropB:0,blendMode:0,crtMode:!1,tilt:0,fontSize:12},debugTools:{shaderDebuggerOpen:!1,stateDebuggerOpen:!1},engineSettings:{showEngineTab:!1}},cameraPos:{x:0,y:0,z:0},cameraRot:{x:-.3055326162805782,y:-.23752826799481133,z:-.07899585109054458,w:.9186891736613698},sceneOffset:{x:-1,y:2,z:3.119999885559082,xL:-.39253043132449095,yL:.18842446748702635,zL:-.2519678286475089},targetDistance:2.622157335281372,cameraMode:"Orbit",lights:[],renderMode:"Direct",quality:{aaMode:"Always",aaLevel:1,msaa:1,accumulation:!0},animations:[],sequence:{durationFrames:300,fps:30,tracks:{"camera.rotation.x":{id:"camera.rotation.x",type:"float",label:"Rotation X",keyframes:[{id:"KoW4EYIMgfLoxoT_r4KAE",frame:0,value:0,interpolation:"Bezier",autoTangent:!0,brokenTangents:!1,leftTangent:{x:-10,y:0},rightTangent:{x:10,y:0}}],hidden:!1},"camera.rotation.y":{id:"camera.rotation.y",type:"float",label:"Rotation Y",keyframes:[{id:"AT-wEJo4mdYoM0MvWd6xG",frame:0,value:0,interpolation:"Bezier",autoTangent:!0,brokenTangents:!1,leftTangent:{x:-10,y:0},rightTangent:{x:10,y:0}}],hidden:!1},"camera.rotation.z":{id:"camera.rotation.z",type:"float",label:"Rotation Z",keyframes:[{id:"uMhOFCTiQqjimzovOeNOw",frame:0,value:0,interpolation:"Bezier",autoTangent:!0,brokenTangents:!1,leftTangent:{x:-10,y:0},rightTangent:{x:10,y:0}}],hidden:!1},"camera.unified.x":{id:"camera.unified.x",type:"float",label:"Position X",keyframes:[{id:"KDJPK35MTTYqIT89SUPvF",frame:0,value:0,interpolation:"Bezier",autoTangent:!0,brokenTangents:!1,leftTangent:{x:-10,y:0},rightTangent:{x:10,y:0}}],hidden:!1},"camera.unified.y":{id:"camera.unified.y",type:"float",label:"Position Y",keyframes:[{id:"xB73KjtjCvr7BAEwPhM7y",frame:0,value:0,interpolation:"Bezier",autoTangent:!0,brokenTangents:!1,leftTangent:{x:-10,y:0},rightTangent:{x:10,y:0}}],hidden:!1},"camera.unified.z":{id:"camera.unified.z",type:"float",label:"Position Z",keyframes:[{id:"cmatJ34LXn2yxCaJEyqVz",frame:0,value:4.12,interpolation:"Bezier",autoTangent:!0,brokenTangents:!1,leftTangent:{x:-10,y:0},rightTangent:{x:10,y:0}}],hidden:!1}}},duration:300}},qr={id:"Kleinian",name:"Kleinian",shortDescription:"Inversion fractal. Resembles organic structures, coral, and sponge tissues.",description:"Based on Kleinian groups and inversion in a sphere. Creates intricate, bubbly, sponge-like structures.",shader:{function:`
    void formula_Kleinian(inout vec4 z, inout float dr, inout float trap, vec4 c) {
        vec3 z3 = z.xyz;
        float limit = uParamC;
        z3 = clamp(z3, -limit, limit) * 2.0 - z3;
        float r2 = max(dot(z3, z3), 1e-10);
        float k = max(uParamD / r2, 1.0);
        z3 *= k;
        dr *= k;
        
        // Apply Scale (A) and Offset (B)
        z3 = z3 * uParamA + vec3(uParamB, 0.0, 0.0) + c.xyz;
        dr = dr * abs(uParamA) + 1.0;
        
        z.xyz = z3;
        trap = min(trap, r2);
    }`,loopBody:"formula_Kleinian(z, dr, trap, c);"},parameters:[{label:"Scale",id:"paramA",min:1,max:2.5,step:.001,default:1.8},{label:"X Offset",id:"paramB",min:-1,max:1,step:.001,default:0},{label:"Fold Size",id:"paramC",min:0,max:2,step:.001,default:1},{label:"K Factor",id:"paramD",min:.5,max:2,step:.001,default:1.2}],defaultPreset:{formula:"Kleinian",features:{coreMath:{iterations:53,paramA:2.058,paramB:0,paramC:.907,paramD:.976,paramE:1,paramF:1},coloring:{mode:3,repeats:100,phase:0,scale:126.58,offset:67.08,bias:1,twist:0,escape:2,mode2:0,repeats2:100,phase2:0,blendMode:3,blendOpacity:1,twist2:0,layer3Color:"#ffffff",layer3Scale:89,layer3Strength:0,layer3Bump:.2,layer3Turbulence:0,gradient:[{id:"2",position:0,color:"#FFFFFF",bias:.5,interpolation:"linear"},{id:"1",position:.8275862068965517,color:"#3E3E3E",bias:.5,interpolation:"linear"},{id:"1767121500027",position:1,color:"#FFFFFF",bias:.5,interpolation:"linear"}],gradient2:[{id:"1",position:0,color:"#000000",bias:.5,interpolation:"linear"},{id:"2",position:1,color:"#ffffff",bias:.5,interpolation:"linear"}]},texturing:{active:!1,scaleX:1,scaleY:1,offset:{x:0,y:0},mapU:6,mapV:1,layer1Data:null},materials:{reflection:0,specular:0,roughness:.79,diffuse:2,envStrength:0,rim:0,rimExponent:1,emission:.148,emissionColor:"#ffffff",emissionMode:0,envMapVisible:!1,envSource:1,useEnvMap:!0,envRotation:0,envGradientStops:[{id:"1767120246151",position:0,color:"#88ccff",bias:.5,interpolation:"linear"},{id:"hor",position:.5,color:"#223344",bias:.5,interpolation:"smooth"},{id:"zen",position:.9454191033138402,color:"#88ccff",bias:.5,interpolation:"smooth"}]},atmosphere:{fogIntensity:1,fogNear:1e-4,fogFar:501,fogColor:"#5A81A3",fogDensity:0,glowIntensity:.035,glowSharpness:52,glowColor:"#ffffff",glowMode:!1,aoIntensity:.29,aoSpread:.1,aoMode:!1},lighting:{shadows:!0,shadowSoftness:82.64,shadowIntensity:1,shadowBias:.0014},quality:{detail:1,fudgeFactor:.8,pixelThreshold:.9,maxSteps:300,aaMode:"Auto",aaLevel:1,distanceMetric:1,estimator:4},geometry:{juliaMode:!1,juliaX:.5,juliaY:.5,juliaZ:.5,hybridMode:!1,hybridIter:2,hybridScale:2,hybridMinR:.5,hybridFixedR:1,hybridFoldLimit:1,hybridSkip:1},optics:{dofStrength:1e-4,dofFocus:.577}},cameraPos:{x:0,y:0,z:3.5},cameraRot:{x:0,y:0,z:.931234344584406,w:-.3644209042665525},cameraFov:80,sceneOffset:{x:0,y:0,z:0,xL:0,yL:0,zL:0},targetDistance:.965,cameraMode:"Fly",lights:[{type:"Point",position:{x:.06202062498807429,y:.022274010144572264,z:3.439439471330585},rotation:{x:0,y:0,z:0},color:"#8FA9FF",intensity:.4,falloff:.6760000000000002,falloffType:"Quadratic",fixed:!1,visible:!0,castShadow:!0},{type:"Point",position:{x:.00041247989335695644,y:-.00142172416335363,z:3.0187219870917428},rotation:{x:0,y:0,z:0},color:"#FFB333",intensity:5,falloff:142.88399999999996,falloffType:"Quadratic",fixed:!1,visible:!0,castShadow:!0},{type:"Point",position:{x:-.12319987256138526,y:-.0954216385692699,z:2.9890303407494763},rotation:{x:0,y:0,z:0},color:"#3636FF",intensity:.5,falloff:.5,falloffType:"Quadratic",fixed:!1,visible:!1,castShadow:!0}]}},Xr={id:"PseudoKleinian",name:"Pseudo Kleinian",shortDescription:'Kleinian variation with a "Magic Factor" that warps the inversion logic.',description:"A modification of the Kleinian group formula. Now supports linear shifting and twisting.",shader:{function:`
    void formula_PseudoKleinian(inout vec4 z, inout float dr, inout float trap, vec4 c) {
        vec3 q = z.xyz;
        
        // Param F: Twist
        if (abs(uParamF) > 0.001) {
            float ang = q.z * uParamF;
            float s = sin(ang); float co = cos(ang);
            q.xy = mat2(co, -s, s, co) * q.xy;
        }

        float boxLimitVal = uParamA;
        vec3 boxMin = vec3(-boxLimitVal);
        vec3 boxMax = vec3(boxLimitVal);
        q = 2.0 * clamp(q, boxMin, boxMax) - q;
        float lensq = max(dot(q, q), 1e-10);
        float magic = uParamD; 
        float factor = uParamC - magic; 
        float rp2 = lensq * factor;
        float k1 = max(uParamB / max(rp2, 1.0e-10), 1.0);
        q *= k1;
        dr *= k1;
        
        // Param E: Shift
        if (abs(uParamE) > 0.001) {
            q.z += uParamE;
        }
        
        z.xyz = q;
        trap = min(trap, lensq);
    }`,loopBody:"formula_PseudoKleinian(z, dr, trap, c);"},parameters:[{label:"Box Limit",id:"paramA",min:.1,max:2,step:.01,default:1},{label:"Size (C)",id:"paramB",min:.5,max:2.5,step:.001,default:1.354},{label:"Power",id:"paramC",min:1,max:2.5,step:.001,default:1.576},{label:"Magic Factor",id:"paramD",min:0,max:1.5,step:.001,default:.772},{label:"Z Shift",id:"paramE",min:-1,max:1,step:.001,default:0},{label:"Twist",id:"paramF",min:-2,max:2,step:.01,default:0}],defaultPreset:{formula:"PseudoKleinian",features:{atmosphere:{fogIntensity:.32,fogNear:1e-4,fogFar:45.212,fogColor:"#4db8cf",fogDensity:0,glowIntensity:0,glowSharpness:1,glowMode:!0,glowColor:"#9be0ff",aoIntensity:0,aoSpread:.158,aoMode:!1},droste:{active:!1,tiling:1,center:{x:0,y:0},radiusInside:5,radiusOutside:100,periodicity:2,strands:2,autoPeriodicity:!1,strandMirror:!1,zoom:0,rotate:0,rotateSpin:0,rotatePolar:0,twist:!0,hyperDroste:!1,fractalPoints:1},materials:{diffuse:1,reflection:0,specular:1.88,roughness:.26890569500292505,rim:0,rimExponent:2,envStrength:0,envMapVisible:!1,envBackgroundStrength:1,envSource:1,envMapData:null,useEnvMap:!0,envRotation:0,envGradientStops:[{id:"0",position:.03,color:"#130606"},{id:"1",position:.14,color:"#463434"},{id:"2",position:.41,color:"#824040"},{id:"3",position:.68,color:"#BCBCBC"},{id:"4",position:1,color:"#875656"}],emission:0,emissionMode:0,emissionColor:"#ffffff",ptEmissionMult:1},colorGrading:{active:!1,saturation:1,levelsMin:0,levelsMax:.71,levelsGamma:.91},texturing:{active:!1,layer1Data:null,mapU:6,mapV:1,scaleX:1,scaleY:1,offset:{x:0,y:0},textureScale:{x:1,y:1}},coloring:{gradient:[{id:"1766247241150_0",position:0,color:"#001133",bias:.5,interpolation:"linear"},{id:"1766247241150_1",position:.5,color:"#0066aa",bias:.5,interpolation:"linear"},{id:"1766247241150_2",position:1,color:"#00ffff",bias:.5,interpolation:"linear"}],mode:6,scale:1,offset:0,repeats:26.1,phase:0,bias:1,twist:0,escape:96.38,gradient2:[{id:"1766247257110_0",position:0,color:"#d3f2a3",bias:.5,interpolation:"linear"},{id:"1766247257110_1",position:.167,color:"#97e196",bias:.5,interpolation:"linear"},{id:"1766247257110_2",position:.333,color:"#6cc08b",bias:.5,interpolation:"linear"},{id:"1766247257110_3",position:.5,color:"#4c9b82",bias:.5,interpolation:"linear"},{id:"1766247257110_4",position:.667,color:"#217a79",bias:.5,interpolation:"linear"},{id:"1766247257110_5",position:.833,color:"#105965",bias:.5,interpolation:"linear"},{id:"1766247257110_6",position:1,color:"#074050",bias:.5,interpolation:"linear"}],mode2:0,scale2:1,offset2:0,repeats2:10,phase2:.69,bias2:1,twist2:0,blendMode:0,blendOpacity:.48,layer3Color:"#ffffff",layer3Scale:28.5,layer3Strength:0,layer3Bump:0,layer3Turbulence:0},geometry:{preRotEnabled:!1,preRotY:0,preRotX:0,preRotZ:0,juliaMode:!1,juliaX:.73,juliaY:2,juliaZ:-2,hybridMode:!1,hybridIter:2,hybridScale:2,hybridMinR:.5,hybridFixedR:1,hybridFoldLimit:1,hybridAddC:!1,hybridComplex:!1,hybridProtect:!0,hybridSkip:1,hybridSwap:!1,preRot:{x:0,y:0,z:0},julia:{x:0,y:0,z:0}},quality:{fudgeFactor:1,detail:.7,pixelThreshold:.3,maxSteps:300,distanceMetric:0,estimator:4},coreMath:{iterations:7,paramA:2,paramB:2.5,paramC:1.504,paramD:.801,paramE:.099,paramF:0},lighting:{shadows:!0,shadowSoftness:25.7,shadowIntensity:1,shadowBias:16e-6,ptBounces:3,ptGIStrength:1,ptStochasticShadows:!1,lights:[{position:{x:2.6782265868859914,y:2.519524178935847,z:1.9186106243635077},color:"#99A4FF",intensity:54.4644,falloff:.3,falloffType:"Quadratic",fixed:!1,visible:!0,castShadow:!0},{position:{x:.05,y:.075,z:-.1},color:"#ff0000",intensity:.5,falloff:.5,falloffType:"Quadratic",fixed:!1,visible:!1,castShadow:!1},{position:{x:.25,y:.075,z:-.1},color:"#0000ff",intensity:.5,falloff:.5,falloffType:"Quadratic",fixed:!1,visible:!1,castShadow:!1}]},optics:{camType:0,camFov:60,orthoScale:2,dofStrength:0,dofFocus:1.515},navigation:{flySpeed:.3799999999999999,autoSlow:!0},audio:{threshold:.1,agcEnabled:!1,attack:.1,decay:.3,highPass:20,lowPass:2e4,gain:1},drawing:{activeTool:"rect",enabled:!1,active:!1,originMode:1,color:"#00ffff",lineWidth:1,showLabels:!0,showAxes:!1,shapes:[],refreshTrigger:0},modulation:{rules:[],selectedRuleId:null},webcam:{opacity:1,posX:20,posY:80,width:320,height:240,cropL:0,cropR:0,cropT:0,cropB:0,blendMode:0,crtMode:!1,tilt:0,fontSize:12},debugTools:{shaderDebuggerOpen:!1,stateDebuggerOpen:!1}},cameraPos:{x:0,y:0,z:0},cameraRot:{x:.44958126500369255,y:.13735346204998755,z:.1977245142917942,w:.860183543825756},sceneOffset:{x:2.7794198989868164,y:-4.152594447135925,z:3.4243035316467285,xL:-.445830410046955,yL:.09840789755523893,zL:-.22267699480975622},targetDistance:5.005470454692841,cameraMode:"Orbit",lights:[],renderMode:"Direct",quality:{aaMode:"Always",aaLevel:2,msaa:1,accumulation:!0},animations:[{id:"4yFFplV3QPo3KoNaGJwfX",enabled:!1,target:"coreMath.paramA",shape:"Sine",period:5,amplitude:1,baseValue:1.71,phase:0,smoothing:.5}],sequence:{durationFrames:300,fps:30,tracks:{"camera.unified.x":{id:"camera.unified.x",type:"float",label:"Position X",keyframes:[{id:"4TTAqHRSNX_yNs7y94F0r",frame:0,value:3.7794198786970727,interpolation:"Bezier",autoTangent:!0,brokenTangents:!1,leftTangent:{x:-10,y:0},rightTangent:{x:10,y:0}}],hidden:!1},"camera.unified.y":{id:"camera.unified.y",type:"float",label:"Position Y",keyframes:[{id:"zAMQHlXx144VPd_al_Y9L",frame:0,value:-6.618905668658809,interpolation:"Bezier",autoTangent:!0,brokenTangents:!1,leftTangent:{x:-10,y:0},rightTangent:{x:10,y:0}}],hidden:!1},"camera.unified.z":{id:"camera.unified.z",type:"float",label:"Position Z",keyframes:[{id:"1LR1t6ODtEmkVVIa03sDE",frame:0,value:3.078714305139574,interpolation:"Bezier",autoTangent:!0,brokenTangents:!1,leftTangent:{x:-10,y:0},rightTangent:{x:10,y:0}}],hidden:!1},"camera.rotation.x":{id:"camera.rotation.x",type:"float",label:"Rotation X",keyframes:[{id:"kCoLqnvoBEVYvB2kegFKg",frame:0,value:1.3203186773803572,interpolation:"Bezier",autoTangent:!0,brokenTangents:!1,leftTangent:{x:-10,y:0},rightTangent:{x:10,y:0}}],hidden:!1},"camera.rotation.y":{id:"camera.rotation.y",type:"float",label:"Rotation Y",keyframes:[{id:"lTHtVHzDsBLjg5l5pXz8D",frame:0,value:.33161255787892263,interpolation:"Bezier",autoTangent:!0,brokenTangents:!1,leftTangent:{x:-10,y:0},rightTangent:{x:10,y:0}}],hidden:!1},"camera.rotation.z":{id:"camera.rotation.z",type:"float",label:"Rotation Z",keyframes:[{id:"0LIRS-UZivENQ7h_xsyNy",frame:0,value:0,interpolation:"Bezier",autoTangent:!0,brokenTangents:!1,leftTangent:{x:-10,y:0},rightTangent:{x:10,y:0}}],hidden:!1}}},duration:300}},Yr={id:"Dodecahedron",name:"Dodecahedron",shortDescription:"Folds space into the symmetry of a Dodecahedron (12 faces).",description:"A folding fractal based on the symmetry of a dodecahedron. Now with twist and shift.",shader:{function:`
    void formula_Dodecahedron(inout vec4 z, inout float dr, inout float trap, vec4 c) {
        vec3 z3 = z.xyz;
        
        // Param F: Twist
        if (abs(uParamF) > 0.001) {
            float ang = z3.z * uParamF;
            float s = sin(ang); float co = cos(ang);
            z3.xy = mat2(co, -s, s, co) * z3.xy;
        }

        float ang = uParamC;
        float s = sin(ang), c_ang = cos(ang);
        z3.xy = mat2(c_ang, -s, s, c_ang) * z3.xy;
        ang = uParamD;
        s = sin(ang); c_ang = cos(ang);
        z3.yz = mat2(c_ang, -s, s, c_ang) * z3.yz;
        float scale = uParamA;
        float offset = uParamB;
        z3 = abs(z3);
        if(z3.x < z3.y) z3.xy = z3.yx;
        if(z3.x < z3.z) z3.xz = z3.zx;
        if(z3.y < z3.z) z3.yz = z3.zy;
        dodecaFold(z3);
        dodecaFold(z3);
        
        // Param E: Shift
        vec3 shift = vec3(offset * (scale - 1.0));
        if (abs(uParamE) > 0.001) shift.z += uParamE;
        
        z3 = z3 * scale - shift;
        dr = dr * abs(scale);
        z.xyz = z3;
        trap = min(trap, length(z3));
    }`,loopBody:"formula_Dodecahedron(z, dr, trap, c);"},parameters:[{label:"Scale",id:"paramA",min:1,max:4,step:.001,default:2.5},{label:"Offset",id:"paramB",min:0,max:2,step:.001,default:1},{label:"Rot X",id:"paramC",min:0,max:6.28,step:.01,default:0,scale:"pi"},{label:"Rot Z",id:"paramD",min:0,max:6.28,step:.01,default:0,scale:"pi"},{label:"Z Shift",id:"paramE",min:-2,max:2,step:.01,default:0},{label:"Twist",id:"paramF",min:-2,max:2,step:.01,default:0}],defaultPreset:{formula:"Dodecahedron",features:{coreMath:{iterations:50,paramA:2.617,paramB:1.525,paramC:.251,paramD:.282,paramE:1.17,paramF:0},coloring:{mode:0,repeats:2.63,phase:.42,scale:2.63,offset:.42,bias:1,twist:0,escape:2,mode2:5,repeats2:1,phase2:0,blendMode:2,blendOpacity:1,twist2:0,layer3Color:"#ffffff",layer3Scale:89,layer3Strength:0,layer3Bump:0,layer3Turbulence:0,gradient:[{id:"0",position:0,color:"#331a00"},{id:"1",position:.5,color:"#cc8800"},{id:"2",position:1,color:"#ffeeaa"}],gradient2:[{id:"1",position:.61,color:"#FFFFFF"},{id:"2",position:.88,color:"#FF0505"}]},texturing:{active:!1,scaleX:4,scaleY:24,offset:{x:-.02,y:-.08},mapU:6,mapV:8,layer1Data:null},materials:{reflection:.4,specular:2,roughness:.51,diffuse:2,envStrength:0,rim:.03,rimExponent:4.5,emission:.009,emissionColor:"#ffffff",emissionMode:0,envMapVisible:!1,envSource:1,useEnvMap:!0,envRotation:0,envGradientStops:[{id:"0",position:.03,color:"#130606"},{id:"1",position:.14,color:"#463434"},{id:"2",position:.41,color:"#824040"},{id:"3",position:.68,color:"#BCBCBC"},{id:"4",position:1,color:"#875656"}]},atmosphere:{fogNear:1e-4,fogFar:501,fogColor:"#000000",fogDensity:0,glowIntensity:.005,glowSharpness:19,glowColor:"#ffffff",glowMode:!1,aoIntensity:0,aoSpread:.1},lighting:{shadows:!0,shadowSoftness:538,shadowIntensity:1,shadowBias:0},quality:{detail:2.4,fudgeFactor:.47,pixelThreshold:.5,maxSteps:300,aaMode:"Auto",aaLevel:1,estimator:4},colorGrading:{saturation:1,levelsMin:0,levelsMax:1,levelsGamma:1},geometry:{juliaMode:!1,juliaX:.04,juliaY:-.12,juliaZ:-.24,hybridMode:!1,hybridIter:2,hybridScale:2,hybridMinR:.5,hybridFixedR:1,hybridFoldLimit:1},optics:{dofStrength:0,dofFocus:1.515}},cameraPos:{x:0,y:0,z:0},cameraRot:{x:-.23397578924576956,y:.28304121464362475,z:.5229543398514255,w:.7691955273468777},cameraFov:60,sceneOffset:{x:2,y:3,z:4,xL:-.5556107642317095,yL:.3332098113554696,zL:-.042659161564751066},targetDistance:2.637,cameraMode:"Fly",lights:[{type:"Point",position:{x:-1.4194299271962965,y:-.6167022395401724,z:3.6185548096036646},rotation:{x:0,y:0,z:0},color:"#99A4FF",intensity:500,falloff:6.4,falloffType:"Quadratic",fixed:!1,visible:!0,castShadow:!0},{type:"Point",position:{x:.05,y:.075,z:-.1},rotation:{x:0,y:0,z:0},color:"#ff0000",intensity:.5,falloff:.5,falloffType:"Quadratic",fixed:!1,visible:!1,castShadow:!1},{type:"Point",position:{x:.25,y:.075,z:-.1},rotation:{x:0,y:0,z:0},color:"#0000ff",intensity:.5,falloff:.5,falloffType:"Quadratic",fixed:!1,visible:!1,castShadow:!1}],animations:[{id:"4yFFplV3QPo3KoNaGJwfX",enabled:!1,target:"coreMath.paramA",shape:"Sine",period:5,amplitude:1,baseValue:2.617,phase:0,smoothing:.5}]}},Vr={id:"Phoenix",name:"Phoenix",shortDescription:"Iterates based on previous value (z_n-1). Creates flowing, taffy-like distortions.",description:"A 3D generalization of the Phoenix Julia set. Now with Z-stretching and spatial twisting.",shader:{function:`
        void formula_Phoenix(inout vec4 z, inout float dr, inout float trap, vec4 c, inout vec4 z_prev, inout float dr_prev) {
            vec3 z3 = z.xyz;
            vec3 zp3 = z_prev.xyz;
            
            // Param E: Z Stretch/Scale
            if (abs(uParamE - 1.0) > 0.001) {
                z3.z *= uParamE;
                dr *= uParamE;
            }
            
            // Param F: Twist
            if (abs(uParamF) > 0.001) {
                float ang = z3.z * uParamF;
                float s = sin(ang); float co = cos(ang);
                z3.xy = mat2(co, -s, s, co) * z3.xy;
            }

            float power = uParamA;
            float kReal = uParamB;
            float kImag = uParamC;
            float hPower = uParamD;
            
            vec3 z_new_part = bulbPow(z3, power);
            
            vec3 z_prev_part;
            bool isLinearHistory = abs(hPower - 1.0) < 0.001;
            
            if (isLinearHistory) {
                z_prev_part = zp3;
            } else {
                z_prev_part = bulbPow(zp3, hPower);
            }
            
            vec3 historyTerm;
            historyTerm.x = z_prev_part.x * kReal - z_prev_part.y * kImag;
            historyTerm.y = z_prev_part.x * kImag + z_prev_part.y * kReal;
            historyTerm.z = z_prev_part.z * kReal;
            
            vec3 z_next = z_new_part + c.xyz + historyTerm;
            
            float r = length(z3);
            float rp = length(zp3);
            float safeR = max(r, 1.0e-5);
            float safeRp = max(rp, 1.0e-5);
            
            float dr_pow = power * pow(safeR, power - 1.0);
            
            float kMag = length(vec2(kReal, kImag));
            float dr_hist = kMag;
            
            if (!isLinearHistory) {
                 dr_hist *= hPower * pow(safeRp, hPower - 1.0);
            }
            
            float dc = (uJuliaMode > 0.5) ? 0.0 : 1.0;
            float dr_next = dr_pow * dr + dr_hist * dr_prev + dc;
            
            z_prev = vec4(z3, 0.0); 
            dr_prev = dr;
            
            z.xyz = z_next;
            dr = dr_next;
            
            trap = min(trap, dot(z, z));
        }`,loopBody:"formula_Phoenix(z, dr, trap, c, z_prev, dr_prev);",loopInit:`
        vec4 z_prev = vec4(0.0);
        float dr_prev = 0.0;
        `},parameters:[{label:"Power (p)",id:"paramA",min:1.5,max:12,step:.01,default:2},{label:"Distortion Real",id:"paramB",min:-1.5,max:1.5,step:.001,default:-.5},{label:"Distortion Imag",id:"paramC",min:-1.5,max:1.5,step:.001,default:0},{label:"History Exp",id:"paramD",min:0,max:3,step:.01,default:1},{label:"Z Stretch",id:"paramE",min:.1,max:3,step:.01,default:1},{label:"Twist",id:"paramF",min:-2,max:2,step:.01,default:0}],defaultPreset:{version:5,name:"Custom Preset",formula:"Phoenix",features:{atmosphere:{fogColor:"#1b1e24",fogNear:1e-4,fogFar:501.18723362727246,glowIntensity:1e-4,glowSharpness:825,glowMode:!1,glowColor:"#ffffff",aoIntensity:.37,aoSpread:.16407786639505306,aoMode:!1},droste:{active:!1,tiling:1,center:{x:0,y:0},radiusInside:5,radiusOutside:100,periodicity:2,strands:2,autoPeriodicity:!1,strandMirror:!1,zoom:0,rotate:0,rotateSpin:0,rotatePolar:0,twist:!0,hyperDroste:!1,fractalPoints:1},materials:{diffuse:.94,reflection:0,specular:.3,roughness:.4,rim:0,rimExponent:4,envStrength:0,envMapVisible:!1,envBackgroundStrength:1,envSource:1,useEnvMap:!1,envRotation:0,envGradientStops:[],emission:.5805252310662089,emissionMode:0,emissionColor:"#ffffff",ptEmissionMult:1},colorGrading:{saturation:1,levelsMin:0,levelsMax:1,levelsGamma:1},texturing:{active:!1,layer1Data:null,mapU:6,mapV:1,scaleX:1,scaleY:1,offset:{x:0,y:0}},coloring:{gradient:[{id:"1766223988966_0",position:0,color:"#5F4690",bias:.5,interpolation:"linear"},{id:"1766223988966_1",position:.091,color:"#1D6996",bias:.5,interpolation:"linear"},{id:"1766223988966_2",position:.182,color:"#38A6A5",bias:.5,interpolation:"linear"},{id:"1766223988966_3",position:.273,color:"#0F8554",bias:.5,interpolation:"linear"},{id:"1766223988966_4",position:.364,color:"#73AF48",bias:.5,interpolation:"linear"},{id:"1766223988966_5",position:.455,color:"#EDAD08",bias:.5,interpolation:"linear"},{id:"1766223988966_6",position:.545,color:"#E17C05",bias:.5,interpolation:"linear"},{id:"1766223988966_7",position:.636,color:"#CC503E",bias:.5,interpolation:"linear"},{id:"1766223988966_8",position:.727,color:"#94346E",bias:.5,interpolation:"linear"},{id:"1766223988966_9",position:.818,color:"#6F4070",bias:.5,interpolation:"linear"},{id:"1766223988966_10",position:.909,color:"#994E95",bias:.5,interpolation:"linear"},{id:"1766223988966_11",position:1,color:"#666666",bias:.5,interpolation:"linear"}],mode:0,scale:2.31040486583382,offset:.272461575792784,repeats:1,phase:0,bias:.9,twist:0,escape:4,gradient2:[{id:"1766224725875_0",position:0,color:"#5F4690",bias:.5,interpolation:"linear"},{id:"1766224725875_1",position:.091,color:"#1D6996",bias:.5,interpolation:"linear"},{id:"1766224725875_2",position:.182,color:"#38A6A5",bias:.5,interpolation:"linear"},{id:"1766224725875_3",position:.273,color:"#0F8554",bias:.5,interpolation:"linear"},{id:"1766224725875_4",position:.364,color:"#73AF48",bias:.5,interpolation:"linear"},{id:"1766224725875_5",position:.455,color:"#EDAD08",bias:.5,interpolation:"linear"},{id:"1766224725875_6",position:.545,color:"#E17C05",bias:.5,interpolation:"linear"},{id:"1766224725875_7",position:.636,color:"#CC503E",bias:.5,interpolation:"linear"},{id:"1766224725875_8",position:.727,color:"#94346E",bias:.5,interpolation:"linear"},{id:"1766224725875_9",position:.818,color:"#6F4070",bias:.5,interpolation:"linear"},{id:"1766224725875_10",position:.909,color:"#994E95",bias:.5,interpolation:"linear"},{id:"1766224725875_11",position:1,color:"#666666",bias:.5,interpolation:"linear"}],mode2:6,scale2:1,offset2:0,repeats2:1,phase2:0,bias2:1,twist2:0,blendMode:3,blendOpacity:1,layer3Color:"#ffffff",layer3Scale:245.44021169935067,layer3Strength:0,layer3Bump:.3,layer3Turbulence:.65},geometry:{juliaMode:!0,juliaX:.17,juliaY:.36,juliaZ:.06,hybridMode:!1,hybridIter:2,hybridScale:2,hybridMinR:.5,hybridFixedR:1,hybridFoldLimit:1,hybridSkip:1,hybridAddC:!1},quality:{fudgeFactor:.4,detail:1,pixelThreshold:.5,maxSteps:300},coreMath:{iterations:31,paramA:10.777,paramB:.503,paramC:.961,paramD:.87,paramE:1,paramF:0},lighting:{shadows:!0,shadowSoftness:102.8,shadowIntensity:1,shadowBias:.002,ptBounces:3,ptGIStrength:1,ptStochasticShadows:!1},optics:{camType:0,camFov:58,orthoScale:2,dofStrength:.0003512919517238997,dofFocus:.37963494658470154}},cameraPos:{x:.8764067264947826,y:-1.880624433031201,z:2.8187165504251803},cameraRot:{x:.08697694591956645,y:.2996017656166646,z:-.7151373197868851,w:.6255017240311274},sceneOffset:{x:.2456940859556198,y:1.1121561974287033,z:-2.6141974329948425,xL:-.8764067217464274,yL:.8806244298182395,zL:-.8187165546163797},targetDistance:.28698269091546535,cameraMode:"Orbit",lights:[{type:"Point",position:{x:.7545657194904971,y:.5311043420915486,z:-.026379577691362677},rotation:{x:0,y:0,z:0},color:"#ffffff",intensity:1.4,falloff:0,falloffType:"Quadratic",fixed:!1,visible:!0,castShadow:!0},{type:"Point",position:{x:.05,y:.075,z:-.1},rotation:{x:0,y:0,z:0},color:"#ff0000",intensity:.5,falloff:.5,falloffType:"Quadratic",fixed:!1,visible:!1,castShadow:!1},{type:"Point",position:{x:.25,y:.075,z:-.1},rotation:{x:0,y:0,z:0},color:"#0000ff",intensity:.5,falloff:.5,falloffType:"Quadratic",fixed:!1,visible:!1,castShadow:!1}],renderMode:"Direct",quality:{fudgeFactor:.4,detail:1,pixelThreshold:.5,maxSteps:300,aaMode:"Always",aaLevel:1,msaa:1,accumulation:!0},navigation:{flySpeed:.5,autoSlow:!0},animations:[],sequence:{durationFrames:300,fps:30,tracks:{}},duration:300}},Zr={id:"MixPinski",name:"MixPinski",shortDescription:'A hybrid of the Sierpinski tetrahedron with box folds. Creates "Greeble" textures.',description:"A variation of the Sierpinski Tetrahedron with added rotation and twist.",shader:{function:`
    void formula_MixPinski(inout vec4 z, inout float dr, inout float trap, vec4 c) {
        vec3 z3 = z.xyz;
        
        // Param F: Twist
        if (abs(uParamF) > 0.001) {
            float ang = z3.z * uParamF;
            float s = sin(ang); float co = cos(ang);
            z3.xy = mat2(co, -s, s, co) * z3.xy;
        }

        if (z3.x + z3.y < 0.0) z3.xy = -z3.yx;
        if (z3.x + z3.z < 0.0) z3.xz = -z3.zx;
        if (z3.y + z3.z < 0.0) z3.yz = -z3.zy;
        float scale = (abs(uParamA - 1.0) < 0.001) ? 1.001 : uParamA;
        z3 = z3 * scale - vec3(uParamB * (scale - 1.0));
        float ang = uParamC * 0.5;
        float si = sin(ang), co = cos(ang);
        mat2 rot = mat2(co, -si, si, co);
        z3.xy = rot * z3.xy;
        
        // Param D: Shift Z
        if (abs(uParamD) > 0.001) z3.z += uParamD;
        
        // Param E: Shift Y
        if (abs(uParamE) > 0.001) z3.y += uParamE;

        if (uJuliaMode > 0.5) z3 += c.xyz;
        dr = dr * abs(scale);
        z.xyz = z3;
        trap = min(trap, length(z3));
    }`,loopBody:"formula_MixPinski(z, dr, trap, c);"},parameters:[{label:"Scale",id:"paramA",min:1,max:4,step:.001,default:2},{label:"Offset",id:"paramB",min:0,max:2,step:.001,default:1},{label:"Rotation",id:"paramC",min:0,max:6.28,step:.01,default:0,scale:"pi"},{label:"Shift Z",id:"paramD",min:-2,max:2,step:.01,default:0},{label:"Shift Y",id:"paramE",min:-2,max:2,step:.01,default:0},{label:"Twist",id:"paramF",min:-2,max:2,step:.01,default:0}],defaultPreset:{formula:"MixPinski",features:{coreMath:{iterations:32,paramA:2,paramB:1,paramC:0,paramD:0,paramE:0,paramF:0},coloring:{mode:0,repeats:2.6,phase:.78,scale:2.595,offset:.785,bias:1,twist:0,escape:3.2,mode2:4,repeats2:1,phase2:0,blendMode:0,blendOpacity:0,twist2:0,layer3Color:"#ffffff",layer3Scale:89,layer3Strength:0,layer3Bump:.2,layer3Turbulence:0,gradient:[{id:"1766253802332_11",position:0,color:"#666666",bias:.5,interpolation:"linear"},{id:"1766253802332_10",position:.09099999999999997,color:"#994E95",bias:.5,interpolation:"linear"},{id:"1766253802332_9",position:.18200000000000005,color:"#6F4070",bias:.5,interpolation:"linear"},{id:"1766253802332_8",position:.273,color:"#94346E",bias:.5,interpolation:"linear"},{id:"1766253802332_7",position:.364,color:"#CC503E",bias:.5,interpolation:"linear"},{id:"1766253802332_6",position:.45499999999999996,color:"#E17C05",bias:.5,interpolation:"linear"},{id:"1766253802332_5",position:.5449999999999999,color:"#EDAD08",bias:.5,interpolation:"linear"},{id:"1766253802332_4",position:.636,color:"#73AF48",bias:.5,interpolation:"linear"},{id:"1766253802332_3",position:.727,color:"#0F8554",bias:.5,interpolation:"linear"},{id:"1766253802332_2",position:.8180000000000001,color:"#38A6A5",bias:.5,interpolation:"linear"},{id:"1766253802332_1",position:.909,color:"#1D6996",bias:.5,interpolation:"linear"},{id:"1766253802332_0",position:1,color:"#5F4690",bias:.5,interpolation:"linear"}],gradient2:[{id:"1",position:0,color:"#000000"},{id:"2",position:1,color:"#FFFFFF"}]},atmosphere:{fogNear:0,fogFar:100,fogColor:"#000000",fogDensity:0,glowIntensity:0,glowSharpness:200,glowColor:"#ffffff",glowMode:!1,aoIntensity:.2,aoSpread:.4},materials:{reflection:0,specular:0,roughness:.5,diffuse:1.5,envStrength:0,rim:0,rimExponent:4,emission:.3,emissionColor:"#ffffff",emissionMode:0},geometry:{juliaMode:!1,juliaX:0,juliaY:0,juliaZ:0,hybridMode:!1,hybridIter:2,hybridScale:2,hybridMinR:.5,hybridFixedR:1,hybridFoldLimit:1},lighting:{shadows:!0,shadowSoftness:16,shadowIntensity:1,shadowBias:.002},quality:{detail:1,fudgeFactor:1,pixelThreshold:.5,maxSteps:300,estimator:4},optics:{dofStrength:0,dofFocus:.38}},cameraPos:{x:-3.007814612603433,y:1.6549209197166999,z:3.0656971117007727},cameraRot:{x:-.16821916484218788,y:-.37237727913489405,z:-.07175513434637137,w:.9098838800961496},cameraFov:60,sceneOffset:{x:0,y:0,z:0,xL:.6573301623370098,yL:-.6573301623370098,zL:-.6573301623370111},cameraMode:"Orbit",lights:[{type:"Point",position:{x:.435,y:1.031,z:2.022},rotation:{x:0,y:0,z:0},color:"#ffffff",intensity:1.4,falloff:1,falloffType:"Quadratic",fixed:!1,visible:!0,castShadow:!0},{type:"Point",position:{x:.05,y:.075,z:-.1},rotation:{x:0,y:0,z:0},color:"#ff0000",intensity:.5,falloff:.5,falloffType:"Quadratic",fixed:!1,visible:!1,castShadow:!1},{type:"Point",position:{x:.25,y:.075,z:-.1},rotation:{x:0,y:0,z:0},color:"#0000ff",intensity:.5,falloff:.5,falloffType:"Quadratic",fixed:!1,visible:!1,castShadow:!1}]}},Kr={id:"AmazingSurf",name:"Amazing Surf",shortDescription:"Sinusoidal variation of the Amazing Box. Creates flowing, melted machinery.",description:"A variant of the Amazing Box that introduces sinusoidal waves. Now with Wave Twist and Vertical Shift.",shader:{function:`
    void formula_AmazingSurf(inout vec4 z, inout float dr, inout float trap, vec4 c) {
        vec3 z3 = z.xyz;
        float limit = 1.0;
        z3 = clamp(z3, -limit, limit) * 2.0 - z3;
        float r2 = max(dot(z3,z3), 1e-10);
        float mR2 = max(uParamB * uParamB, 1e-10);
        if (r2 < mR2) { z3 *= (1.0/mR2); dr *= (1.0/mR2); }
        else if (r2 < 1.0) { z3 *= (1.0/r2); dr *= (1.0/r2); }
        z3 = z3 * uParamA + c.xyz;
        
        // Param E: Wave Twist
        float twist = 0.0;
        if (abs(uParamE) > 0.001) twist = z3.z * uParamE;
        
        // Param F: Vertical Shift
        if (abs(uParamF) > 0.001) z3.y += uParamF;

        z3 += vec3(sin(z3.y * uParamC + twist), cos(z3.x * uParamC + twist), 0.0) * uParamD * 0.1;
        dr = dr * abs(uParamA) + 1.0;
        z.xyz = z3;
        trap = min(trap, abs(z3.z));
    }`,loopBody:"formula_AmazingSurf(z, dr, trap, c);"},parameters:[{label:"Scale",id:"paramA",min:1,max:5,step:.001,default:3},{label:"Min Radius",id:"paramB",min:0,max:1.5,step:.001,default:.8},{label:"Wave Freq",id:"paramC",min:0,max:10,step:.1,default:6},{label:"Wave Amp",id:"paramD",min:0,max:2,step:.01,default:.5},{label:"Wave Twist",id:"paramE",min:-5,max:5,step:.01,default:0,scale:"pi"},{label:"Vert Shift",id:"paramF",min:-2,max:2,step:.01,default:0}],defaultPreset:{formula:"AmazingSurf",features:{coreMath:{iterations:21,paramA:3.03,paramB:.47,paramC:1,paramD:1,paramE:0,paramF:0},coloring:{mode:6,repeats:1,phase:1.44,scale:1,offset:1.44,bias:1,twist:0,escape:100,mode2:4,repeats2:2284.7,phase2:2.4,blendMode:6,blendOpacity:0,twist2:0,layer3Color:"#ffffff",layer3Scale:89,layer3Strength:0,layer3Bump:0,layer3Turbulence:0,gradient:[{id:"1767122909918_0",position:0,color:"#DF7200",bias:.5,interpolation:"linear"},{id:"1767122909918_1",position:.5,color:"#cc8800",bias:.5,interpolation:"linear"},{id:"1767122909918_2",position:1,color:"#ffeeaa",bias:.5,interpolation:"linear"}],gradient2:[{id:"1",position:0,color:"#000000"},{id:"2",position:1,color:"#ffffff"}]},texturing:{active:!1,scaleX:1,scaleY:1,offset:{x:0,y:0},mapU:6,mapV:1,layer1Data:null},materials:{reflection:.44,specular:2,roughness:.51,diffuse:1.01,envStrength:0,rim:0,rimExponent:4,emission:0,emissionColor:"#ffffff",emissionMode:0,envMapVisible:!1,useEnvMap:!0,envSource:1,envRotation:0,envGradientStops:[{id:"1767120246151",position:0,color:"#88ccff",bias:.5,interpolation:"linear"},{id:"hor",position:.5,color:"#223344",bias:.5,interpolation:"smooth"},{id:"zen",position:.9454191033138402,color:"#88ccff",bias:.5,interpolation:"smooth"}]},atmosphere:{fogIntensity:1,fogNear:1e-4,fogFar:7.988,fogColor:"#362624",fogDensity:.2,glowIntensity:1e-4,glowSharpness:360,glowColor:"#ffffff",glowMode:!1,aoIntensity:.2,aoSpread:.147,aoMode:!1},lighting:{shadows:!0,shadowSoftness:128,shadowIntensity:.97,shadowBias:.11},quality:{detail:2,fudgeFactor:.45,pixelThreshold:.9,maxSteps:300,aaMode:"Auto",aaLevel:1,estimator:1},geometry:{juliaMode:!1,juliaX:.06,juliaY:-2,juliaZ:2,hybridMode:!1,hybridIter:2,hybridScale:2,hybridMinR:.5,hybridFixedR:1,hybridFoldLimit:1,hybridSkip:1},optics:{dofStrength:1e-4,dofFocus:.662}},cameraPos:{x:-.0012166192470455862,y:.34651714109424453,z:-.4225635099851341},cameraRot:{x:.0038108513963938193,y:.9416221382735623,z:.33664033788669406,w:-.002551280519921562},cameraFov:60,sceneOffset:{x:0,y:0,z:2,xL:.007764116549374419,yL:.17826292308257122,zL:.3614435950429179},targetDistance:.504,cameraMode:"Orbit",lights:[{type:"Point",position:{x:.06201624057047557,y:-.0404139584830392,z:-.6430434715537097},rotation:{x:0,y:0,z:0},color:"#FF9D7B",intensity:5,falloff:22,falloffType:"Quadratic",fixed:!0,visible:!0,castShadow:!0},{type:"Point",position:{x:.05,y:.075,z:-.1},rotation:{x:0,y:0,z:0},color:"#ff0000",intensity:.5,falloff:.5,falloffType:"Quadratic",fixed:!1,visible:!1,castShadow:!1},{type:"Point",position:{x:.25,y:.075,z:-.1},rotation:{x:0,y:0,z:0},color:"#0000ff",intensity:.5,falloff:.5,falloffType:"Quadratic",fixed:!1,visible:!1,castShadow:!1}]}},Qr={id:"AmazingSurface",name:"Amazing Surface",description:'A "Menger-Kleinian" hybrid. Uses 3-axis sorting (Menger) followed by a Box Fold and Sphere Inversion. Capable of creating non-orthogonal, organic machinery.',shader:{loopInit:`
            // Fix: Zero out W component to prevent uParamB (InvMax) from affecting magnitude check
            z.w = 0.0;

            // Apply Pre-Scale (Param E) once at the start
            // Loop Init always runs before the loop, so we don't need to check iter
            float preScale = (abs(uParamE) < 0.001) ? 1.0 : (1.0 / uParamE);
            z.xyz *= preScale;
            dr *= preScale;
        `,function:`
    void formula_AmazingSurface(inout vec4 z, inout float dr, inout float trap, vec4 c) {
        vec3 p = z.xyz;
        
        // Params
        float scale = uParamA;      // Fractal Scale (fractal_fold + 1)
        float invMax = uParamB;     // Inversion Clamp Max (3.0)
        float cSizeZ = uParamC;     // Box Size Z (1.3)
        float zOffset = uParamD;    // Translation Z (fractal_min_radius)
        
        vec3 cSize = vec3(1.0, 1.0, cSizeZ);
        vec3 offset = vec3(0.0, 0.0, -zOffset);
        
        if (uJuliaMode > 0.5) offset += uJulia;

        // 1. Menger-style Folding (Sort Axes)
        p = abs(p);
        if (p.x < p.y) p.xy = p.yx;
        if (p.x < p.z) p.xz = p.zx;
        if (p.y < p.z) p.yz = p.zy;
        
        // 2. Box Fold / Scale
        // formula: p = p * scale - csize * (scale - 1.0)
        p = p * scale - cSize * (scale - 1.0);
        
        // 3. Sphere Inversion
        float r2 = dot(p, p);
        float k = clamp(1.0 / r2, 1.0, invMax);
        p *= k;
        
        // 4. Translation
        p += offset;
        
        // 5. Derivative Update
        // Based on reference: de = de * k * scale
        // We use full chain rule approximation for stability
        dr = dr * abs(scale) * k + 1.0;
        
        z.xyz = p;
        trap = min(trap, length(p));
    }`,loopBody:"formula_AmazingSurface(z, dr, trap, c);",getDist:`
            // DE: (length(p) - Thickness) / dr
            // Use 'r' which comes from DE_MASTER (respects Distance Metric)
            float thickness = uParamF;
            return vec2((r - thickness) / dr, iter);
        `},parameters:[{label:"Scale",id:"paramA",min:1,max:4,step:.001,default:2.37},{label:"Inv Max",id:"paramB",min:1,max:5,step:.01,default:3},{label:"Box Size Z",id:"paramC",min:.1,max:3,step:.01,default:1.3},{label:"Trans Z",id:"paramD",min:-2,max:2,step:.001,default:.5},{label:"Pre-Scale",id:"paramE",min:.1,max:5,step:.01,default:1},{label:"Thickness",id:"paramF",min:0,max:10,step:.01,default:.4}],defaultPreset:{formula:"AmazingSurface",features:{atmosphere:{fogIntensity:0,fogNear:0,fogFar:5,fogColor:"#000000",fogDensity:0,glowIntensity:0,glowSharpness:200,glowMode:!1,glowColor:"#ffffff",aoIntensity:.2,aoSpread:.028079152787892275,aoMode:!1},droste:{active:!1,tiling:1,center:{x:0,y:0},radiusInside:5,radiusOutside:100,periodicity:2,strands:2,autoPeriodicity:!1,strandMirror:!1,zoom:0,rotate:0,rotateSpin:0,rotatePolar:0,twist:!0,hyperDroste:!1,fractalPoints:1},materials:{diffuse:1,reflection:0,specular:.3,roughness:.5,rim:0,rimExponent:4,envStrength:.125,envMapVisible:!0,envBackgroundStrength:.013878516332918171,envSource:1,envMapData:null,useEnvMap:!1,envRotation:0,envGradientStops:[{id:"sky",position:0,color:"#000000",bias:.5,interpolation:"smooth"},{id:"hor",position:.5,color:"#223344",bias:.5,interpolation:"smooth"},{id:"zen",position:1,color:"#88ccff",bias:.5,interpolation:"smooth"}],emission:0,emissionMode:0,emissionColor:"#ffffff",ptEmissionMult:1},colorGrading:{active:!1,saturation:1,levelsMin:0,levelsMax:1,levelsGamma:1},texturing:{active:!1,layer1Data:null,mapU:6,mapV:1,scaleX:1,scaleY:1,offset:{x:0,y:0},textureScale:{x:1,y:1}},coloring:{gradient:[{id:"2",position:.29337201676350744,color:"#FFFFFF",bias:.5,interpolation:"step"},{id:"1768067662570",position:.32743611518925475,color:"#4F8728",bias:.33333333333333326,interpolation:"step"},{id:"1768067659362",position:.4161607050126708,color:"#FFFFFF",bias:.5,interpolation:"step"},{id:"1768067719427",position:.5555850604494675,color:"#FF7D7D",bias:.5,interpolation:"step"},{id:"1768067722341",position:.6094535614136845,color:"#FFFFFF",bias:.5,interpolation:"linear"},{id:"1768067729100",position:.6876155711314749,color:"#FFB716",bias:.5,interpolation:"linear"},{id:"1768067900586",position:.7932402117621893,color:"#FFFFFF",bias:.5,interpolation:"linear"}],mode:0,scale:13.919207813258625,offset:.787073242086744,repeats:1.5,phase:0,bias:1,twist:0,escape:1.0069316688518042,gradient2:[{id:"1",position:0,color:"#000000"},{id:"2",position:1,color:"#ffffff"}],mode2:4,scale2:1,offset2:0,repeats2:1,phase2:0,bias2:1,twist2:0,blendMode:0,blendOpacity:0,layer3Color:"#ffffff",layer3Scale:2,layer3Strength:0,layer3Bump:0,layer3Turbulence:0},geometry:{preRotEnabled:!1,preRotY:0,preRotX:0,preRotZ:0,juliaMode:!1,juliaX:0,juliaY:0,juliaZ:0,hybridMode:!1,hybridIter:2,hybridScale:2,hybridMinR:.5,hybridFixedR:1,hybridFoldLimit:1,hybridAddC:!1,hybridComplex:!1,hybridProtect:!0,hybridSkip:1,hybridSwap:!1,preRot:{x:0,y:0,z:0},julia:{x:0,y:0,z:0}},quality:{fudgeFactor:.5,detail:2,pixelThreshold:.5,maxSteps:300,distanceMetric:1},coreMath:{iterations:12,paramA:1.866,paramB:1.63,paramC:.62,paramD:-.64,paramE:.97,paramF:1.4},lighting:{shadows:!0,shadowSoftness:12,shadowIntensity:1,shadowBias:1e-4,ptBounces:3,ptGIStrength:1,ptStochasticShadows:!1,light0_visible:!0,light0_fixed:!1,light0_castShadow:!0,light0_type:!1,light0_intensity:50,light0_falloff:50,light0_posX:-.34174133805446993,light0_posY:-1.233562063425787,light0_posZ:1.8137779830637029,light0_color:"#ffffff",light1_visible:!1,light1_fixed:!1,light1_castShadow:!1,light1_type:!1,light1_intensity:.5,light1_falloff:.5,light1_posX:.05,light1_posY:.075,light1_posZ:-.1,light1_color:"#ff0000",light2_visible:!1,light2_fixed:!1,light2_castShadow:!1,light2_type:!1,light2_intensity:.5,light2_falloff:.5,light2_posX:.25,light2_posY:.075,light2_posZ:-.1,light2_color:"#0000ff"},optics:{camType:0,camFov:60,orthoScale:2,dofStrength:0,dofFocus:10},navigation:{flySpeed:.5,autoSlow:!0},audio:{smoothing:.5,links:[],selectedLinkId:null,threshold:.1,agcEnabled:!1,attack:.1,decay:.3,highPass:20,lowPass:2e4,gain:1}},cameraPos:{x:0,y:0,z:0},cameraRot:{x:.4173748330716279,y:.023019150204605446,z:-.01057663171011426,w:.9083812538268042},sceneOffset:{x:0,y:-2,z:2,xL:.04868238113505319,yL:-.4245626359584309,zL:.3428044731107205},targetDistance:2.077035516500473,cameraMode:"Orbit",lights:[],renderMode:"Direct",quality:{aaMode:"Always",aaLevel:1,msaa:1,accumulation:!0},animations:[],sequence:{durationFrames:300,fps:30,tracks:{}},duration:300}},Jr={id:"BoxBulb",name:"Box Bulb",shortDescription:'Hybrid of Box Folds and Mandelbulb Power. Creates "Boxy Bulbs".',description:"A hybrid that combines box/sphere folding with the Mandelbulb power function. Now with rotation controls. (Formerly FoldingBrot)",shader:{function:`
    void formula_BoxBulb(inout vec4 z, inout float dr, inout float trap, vec4 c) {
        vec3 z3 = z.xyz;
        
        // Param E/F: Rotation
        float angX = uParamE;
        float angZ = uParamF;
        if (abs(angX) > 0.001 || abs(angZ) > 0.001) {
             float sx = sin(angX), cx = cos(angX);
             float sz = sin(angZ), cz = cos(angZ);
             mat2 rotX = mat2(cx, -sx, sx, cx);
             mat2 rotZ = mat2(cz, -sz, sz, cz);
             z3.yz = rotX * z3.yz;
             z3.xy = rotZ * z3.xy;
        }

        boxFold(z3, dr, 1.0); 
        sphereFold(z3, dr, uParamB, uParamD);
        float scale = uParamC;
        z3 *= scale;
        dr *= abs(scale);
        DE_Bulb(z3, dr, trap, uParamA); 
        z.xyz = z3 + c.xyz;
        trap = min(trap, length(z.xyz));
    }`,loopBody:"formula_BoxBulb(z, dr, trap, c);"},parameters:[{label:"Power",id:"paramA",min:1.5,max:16,step:.001,default:5},{label:"Min Radius",id:"paramB",min:0,max:1.5,step:.001,default:.5},{label:"Scale",id:"paramC",min:.5,max:2.5,step:.001,default:1},{label:"Fixed Radius",id:"paramD",min:.1,max:2.5,step:.001,default:1},{label:"Rot X",id:"paramE",min:0,max:6.28,step:.01,default:0,scale:"pi"},{label:"Rot Z",id:"paramF",min:0,max:6.28,step:.01,default:0,scale:"pi"}],defaultPreset:{formula:"BoxBulb",features:{coreMath:{iterations:16,paramA:5.8386,paramB:.321,paramC:.91,paramD:1.279,paramE:0,paramF:0},coloring:{mode:6,repeats:1,phase:2.62,scale:1,offset:2.62,bias:1,twist:0,escape:33.72,mode2:0,repeats2:100,phase2:2.4,blendMode:3,blendOpacity:1,twist2:0,layer3Color:"#ffffff",layer3Scale:89,layer3Strength:0,layer3Bump:.2,layer3Turbulence:0,gradient:[{id:"1766255418053_0",position:.0642570281124498,color:"#567C1A",bias:.5,interpolation:"linear"},{id:"1766255418053_1",position:.167,color:"#33A532",bias:.5,interpolation:"linear"},{id:"1766255418053_2",position:.333,color:"#18DA5F",bias:.5,interpolation:"linear"},{id:"1766255418053_3",position:.5,color:"#299B77",bias:.5,interpolation:"linear"},{id:"1766255418053_4",position:.667,color:"#217a79",bias:.5,interpolation:"linear"},{id:"1766258643816",position:.7469879518072289,color:"#4B0000",bias:.5,interpolation:"linear"},{id:"1766255418053_5",position:.833,color:"#105965",bias:.5,interpolation:"linear"},{id:"1766255418053_6",position:1,color:"#074050",bias:.5,interpolation:"linear"}],gradient2:[{id:"1",position:0,color:"#000000"},{id:"2",position:1,color:"#ffffff"}]},atmosphere:{fogNear:1e-4,fogFar:501,fogColor:"#132218",fogDensity:.14,glowIntensity:1e-4,glowSharpness:360,glowColor:"#ffffff",glowMode:!1,aoIntensity:0,aoSpread:.1},materials:{reflection:.4,specular:1.05,roughness:.25,diffuse:.21,envStrength:0,rim:0,rimExponent:4,emission:.01,emissionColor:"#ffffff",emissionMode:0},geometry:{juliaMode:!1,juliaX:.19,juliaY:-.93,juliaZ:-.41,hybridMode:!1,hybridIter:2,hybridScale:2,hybridMinR:.5,hybridFixedR:1,hybridFoldLimit:1},lighting:{shadows:!0,shadowSoftness:8,shadowIntensity:.98,shadowBias:.002},quality:{detail:2.4,fudgeFactor:.65,pixelThreshold:.9,maxSteps:300,aaMode:"Auto",aaLevel:1,estimator:4},optics:{dofStrength:0,dofFocus:1.368}},cameraPos:{x:.25378547286620784,y:.054246624931105866,z:1.9340201043333456},cameraRot:{x:-.013871509693272319,y:.0651855581354543,z:.0009062372749709499,w:.9977763291256213},cameraFov:81,sceneOffset:{x:0,y:0,z:0,xL:.06415813902081223,yL:.10257047639815663,zL:.48918654020794206},cameraMode:"Orbit",lights:[{type:"Point",position:{x:.3559846285676508,y:.08248395080524681,z:2.1100465907611543},rotation:{x:0,y:0,z:0},color:"#99A4FF",intensity:5,falloff:0,falloffType:"Quadratic",fixed:!1,visible:!0,castShadow:!0},{type:"Point",position:{x:.05,y:.075,z:-.1},rotation:{x:0,y:0,z:0},color:"#ff0000",intensity:.5,falloff:.5,falloffType:"Quadratic",fixed:!1,visible:!1,castShadow:!1},{type:"Point",position:{x:.25,y:.075,z:-.1},rotation:{x:0,y:0,z:0},color:"#0000ff",intensity:.5,falloff:.5,falloffType:"Quadratic",fixed:!1,visible:!1,castShadow:!1}],animations:[{id:"4yFFplV3QPo3KoNaGJwfX",enabled:!1,target:"coreMath.paramA",shape:"Sine",period:5,amplitude:1,baseValue:5.8386,phase:0,smoothing:.5}]}},en={id:"MengerAdvanced",name:"Menger Advanced",shortDescription:"Hybrid Menger Sponge with internal Box Folds and vertical scaling.",description:"An advanced variant of the Menger Sponge. It adds an Inner Box Fold (Param E) to generate machinery-like details inside the voids, and Z-Scale (Param F) for creating towering structures. (Formerly UberMenger)",shader:{function:`
    void formula_MengerAdvanced(inout vec4 z, inout float dr, inout float trap, vec4 c) {
        vec3 z3 = z.xyz;
        
        // 1. Rotation
        float angX = uParamC; float angZ = uParamD;
        float sx = sin(angX), cx = cos(angX);
        float sz = sin(angZ), cz = cos(angZ);
        mat2 rotX = mat2(cx, -sx, sx, cx);
        mat2 rotZ = mat2(cz, -sz, sz, cz);
        z3.yz = rotX * z3.yz;
        z3.xy = rotZ * z3.xy;

        // 2. Menger Sorting (The Sponge Logic)
        z3 = abs(z3);
        if (z3.x < z3.y) z3.xy = z3.yx;
        if (z3.x < z3.z) z3.xz = z3.zx;
        if (z3.y < z3.z) z3.yz = z3.zy;
        
        // 3. UBER FEATURE: Inner Box Fold (Param E)
        // Injects Mandelbox-like complexity inside the sponge voids
        if (uParamE > 0.0) {
            float limit = uParamE;
            z3 = clamp(z3, -limit, limit) * 2.0 - z3;
        }

        // 4. Scaling & IFS
        float scale = (abs(uParamA - 1.0) < 0.001) ? 1.001 : uParamA;
        float offset = uParamB;
        
        z3 = z3 * scale - vec3(offset * (scale - 1.0));
        
        // 5. UBER FEATURE: Z-Scale (Param F)
        // Calculate Adaptive Stretch based on alignment with the Z-Axis.
        float zScale = uParamF;
        float stretchFactor = 1.0;
        
        if (abs(zScale - 1.0) > 0.01) {
            if (zScale < 1.0) {
                 // Squashing: Conservative bound (1.0) prevents overstepping artifacts
                 stretchFactor = 1.0;
            } else {
                 // Stretching: Adaptive derivative optimization to skip empty space faster
                 // If the point is aligned with Z, it suffers full stretch.
                 // If it is perpendicular (X/Y), it suffers minimal stretch.
                 float alignment = abs(z3.z) / (length(z3) + 1.0e-9);
                 stretchFactor = mix(1.0, zScale, alignment);
            }
            z3.z *= zScale;
        }

        // Injection
        if (uJuliaMode > 0.5) z3 += c.xyz;
        
        // Derivative Update (Chain Rule)
        // We multiply by Scale, then by our Calculated Adaptive Stretch
        dr = dr * abs(scale) * stretchFactor;
        
        z.xyz = z3;
        trap = min(trap, length(z3));
    }`,loopBody:"formula_MengerAdvanced(z, dr, trap, c);"},parameters:[{label:"Scale",id:"paramA",min:.5,max:4,step:.001,default:3},{label:"Offset",id:"paramB",min:0,max:3,step:.001,default:1},{label:"Rot X",id:"paramC",min:0,max:6.28,step:.01,default:0,scale:"pi"},{label:"Rot Z",id:"paramD",min:0,max:6.28,step:.01,default:0,scale:"pi"},{label:"Inner Fold",id:"paramE",min:0,max:1.5,step:.01,default:.5},{label:"Z Scale",id:"paramF",min:.2,max:3,step:.01,default:1.5}],defaultPreset:{formula:"MengerAdvanced",features:{atmosphere:{fogIntensity:0,fogNear:2,fogFar:10,fogColor:"#000000",fogDensity:.1,glowIntensity:0,glowSharpness:10,glowMode:!1,glowColor:"#ffffff",aoIntensity:.2,aoSpread:.1,aoMode:!1},materials:{diffuse:.9,reflection:0,specular:.87,roughness:.34,rim:.13,rimExponent:16,envStrength:1,envMapVisible:!0,envBackgroundStrength:.1,envSource:1,useEnvMap:!0,envRotation:0,envGradientStops:[{id:"0",position:0,color:"#00C0BF",bias:.5,interpolation:"linear"},{id:"1",position:.167,color:"#16B178",bias:.5,interpolation:"linear"},{id:"2",position:.333,color:"#9ccb86",bias:.5,interpolation:"linear"},{id:"3",position:.5,color:"#e9e29c",bias:.5,interpolation:"linear"},{id:"4",position:.667,color:"#EEBB88",bias:.5,interpolation:"linear"},{id:"5",position:.833,color:"#E83513",bias:.5,interpolation:"linear"},{id:"6",position:1,color:"#CF0B1E",bias:.5,interpolation:"linear"}],emission:0,emissionMode:0,emissionColor:"#ffffff",ptEmissionMult:1},coloring:{gradient:[{id:"0",position:0,color:"#070611",bias:.5,interpolation:"linear"},{id:"1",position:.32,color:"#111320",bias:.5,interpolation:"linear"},{id:"2",position:.67,color:"#30306B",bias:.5,interpolation:"linear"},{id:"3",position:.68,color:"#EAAC85",bias:.5,interpolation:"linear"},{id:"4",position:.82,color:"#975F44",bias:.5,interpolation:"linear"},{id:"5",position:.97,color:"#170C05",bias:.5,interpolation:"linear"}],mode:0,scale:11.72,offset:1.93,repeats:1,phase:.64,bias:1,twist:0,escape:1.65,gradient2:[{id:"1",position:0,color:"#ffffff",bias:.5,interpolation:"linear"},{id:"2",position:.47,color:"#353535",bias:.5,interpolation:"linear"},{id:"3",position:1,color:"#ffffff",bias:.5,interpolation:"linear"}],mode2:0,scale2:32.05,offset2:3.76,repeats2:3.3,phase2:0,bias2:1,twist2:0,blendMode:0,blendOpacity:0,layer3Color:"#ffffff",layer3Scale:89,layer3Strength:0,layer3Bump:0,layer3Turbulence:0},geometry:{juliaMode:!1,juliaX:0,juliaY:0,juliaZ:0,hybridMode:!1,hybridIter:2,hybridScale:2,hybridMinR:.5,hybridFixedR:1,hybridFoldLimit:1,hybridAddC:!1,hybridComplex:!1,hybridProtect:!0,hybridSkip:1,hybridSwap:!1},quality:{fudgeFactor:1,detail:3,pixelThreshold:.5,maxSteps:300,distanceMetric:0,estimator:4},coreMath:{iterations:12,paramA:2.236,paramB:1,paramC:0,paramD:.88,paramE:.618,paramF:.442},lighting:{shadows:!0,shadowSoftness:16,shadowIntensity:.68,shadowBias:.001,ptBounces:3,ptGIStrength:1,ptStochasticShadows:!1,lights:[{type:"Point",position:{x:-.985,y:1.872,z:2.008},color:"#ffffff",intensity:9.18,falloff:0,falloffType:"Quadratic",fixed:!1,visible:!0,castShadow:!0},{type:"Point",position:{x:2,y:-1,z:1},color:"#ff8800",intensity:.5,falloff:0,falloffType:"Quadratic",fixed:!1,visible:!1,castShadow:!0},{type:"Point",position:{x:0,y:-5,z:2},color:"#0088ff",intensity:.25,falloff:0,falloffType:"Quadratic",fixed:!1,visible:!1,castShadow:!0}]},optics:{camType:0,camFov:60,orthoScale:2,dofStrength:0,dofFocus:10},navigation:{flySpeed:.5,autoSlow:!0}},cameraPos:{x:0,y:0,z:0},cameraRot:{x:-.045,y:-.453,z:.141,w:.879},sceneOffset:{x:-4,y:0,z:3,xL:.35,yL:-.27,zL:.18},targetDistance:2.98,cameraMode:"Orbit",renderMode:"Direct",animations:[],sequence:{durationFrames:300,fps:30,tracks:{}},duration:300}},tn={id:"Bristorbrot",name:"Bristorbrot",shortDescription:"Analytic hybrid. Mixes sharp edges with smooth bulbous forms.",description:"A hybrid formula that mixes folding and analytical functions.",shader:{function:`
    void formula_Bristorbrot(inout vec4 z, inout float dr, inout float trap, vec4 c, mat2 rotX, mat2 rotZ) {
        vec3 z3 = z.xyz;
        
        // Twist F
        if (abs(uParamF) > 0.001) {
            float ang = z3.z * uParamF;
            float s = sin(ang); float co = cos(ang);
            z3.xy = mat2(co, -s, s, co) * z3.xy;
        }

        z3.yz = rotX * z3.yz;
        z3.xy = rotZ * z3.xy;
        float x = z3.x; float y = z3.y; float z_ = z3.z;
        z3.x = x*x - y*y - z_*z_;
        z3.y = y * (2.0 * x - z_);
        z3.z = z_ * (2.0 * x + y);
        float r = length(vec3(x,y,z_));
        dr = 2.0 * r * dr + 1.0;
        z3 = z3 * uParamA + c.xyz;
        
        // Shift E (X)
        if (abs(uParamE) > 0.001) z3.x += uParamE;
        
        // Offset B (Y)
        if (abs(uParamB) > 0.001) z3.y += uParamB;

        dr *= abs(uParamA);
        z.xyz = z3;
        trap = min(trap, dot(z3,z3));
    }`,loopInit:`
        float angC = uParamC;
        float sC = sin(angC), cC = cos(angC);
        mat2 rotX = mat2(cC, -sC, sC, cC);
        
        float angD = uParamD;
        float sD = sin(angD), cD = cos(angD);
        mat2 rotZ = mat2(cD, -sD, sD, cD);
        `,loopBody:"formula_Bristorbrot(z, dr, trap, c, rotX, rotZ);"},parameters:[{label:"Scale",id:"paramA",min:.5,max:3,step:.001,default:1},{label:"Offset",id:"paramB",min:-2,max:2,step:.001,default:0},{label:"Rot X",id:"paramC",min:0,max:6.28,step:.01,default:0,scale:"pi"},{label:"Rot Z",id:"paramD",min:0,max:6.28,step:.01,default:0,scale:"pi"},{label:"Shift X",id:"paramE",min:-2,max:2,step:.01,default:0},{label:"Twist",id:"paramF",min:-2,max:2,step:.01,default:0}],defaultPreset:{formula:"Bristorbrot",features:{coreMath:{iterations:21,paramA:.738,paramB:0,paramC:0,paramD:1.2,paramE:.98,paramF:.97},coloring:{mode:1,repeats:24.4,phase:3.9,scale:24.415,offset:3.906,bias:1,twist:0,escape:4,mode2:5,repeats2:1,phase2:2.4,blendMode:0,blendOpacity:0,twist2:0,layer3Color:"#ffffff",layer3Scale:89,layer3Strength:0,layer3Bump:.2,layer3Turbulence:0,gradient:[{id:"0",position:0,color:"#ff0000"},{id:"1",position:.17,color:"#ffff00"},{id:"2",position:.33,color:"#00ff00"},{id:"3",position:.5,color:"#00ffff"},{id:"4",position:.67,color:"#000000"},{id:"5",position:.83,color:"#ff00ff"},{id:"6",position:1,color:"#ff0000"}],gradient2:[{id:"1",position:.61,color:"#FFFFFF"},{id:"2",position:.88,color:"#FF0505"}]},atmosphere:{fogNear:1e-4,fogFar:501,fogColor:"#000000",fogDensity:0,glowIntensity:.067,glowSharpness:480,glowColor:"#FF2323",glowMode:!0,aoIntensity:0,aoSpread:.22},materials:{reflection:.35,specular:0,roughness:.42,diffuse:1.02,envStrength:0,rim:.02,rimExponent:2.6,emission:.004,emissionColor:"#ffffff",emissionMode:0},geometry:{juliaMode:!0,juliaX:1.04,juliaY:.21,juliaZ:.81,hybridMode:!0,hybridIter:1,hybridScale:1,hybridMinR:.79,hybridFixedR:1.08,hybridFoldLimit:.87,hybridSwap:!1},lighting:{shadows:!0,shadowSoftness:2,shadowIntensity:.92,shadowBias:.015},quality:{detail:2.8,fudgeFactor:.6,pixelThreshold:.5,maxSteps:300,aaMode:"Auto",aaLevel:1},optics:{dofStrength:0,dofFocus:1.368}},cameraPos:{x:.19278471475118408,y:1.0849557120921942,z:5.1524976426487115},cameraRot:{x:-.10384525583017853,y:.016524988834210615,z:-.017944827094612474,w:.994294257635102},cameraFov:60,sceneOffset:{x:1,y:1,z:2,xL:-.17139723987914707,yL:-.09973834195017878,zL:-.12121507460186143},cameraMode:"Orbit",lights:[{type:"Point",position:{x:.16245054993746125,y:.326925950685747,z:-2.2309267197330493},rotation:{x:0,y:0,z:0},color:"#99A4FF",intensity:39.8,falloff:.6,falloffType:"Quadratic",fixed:!0,visible:!0,castShadow:!0},{type:"Point",position:{x:.05,y:.075,z:-.1},rotation:{x:0,y:0,z:0},color:"#ff0000",intensity:.5,falloff:.5,falloffType:"Quadratic",fixed:!1,visible:!1,castShadow:!1},{type:"Point",position:{x:.25,y:.075,z:-.1},rotation:{x:0,y:0,z:0},color:"#0000ff",intensity:.5,falloff:.5,falloffType:"Quadratic",fixed:!1,visible:!1,castShadow:!1}],animations:[{id:"4yFFplV3QPo3KoNaGJwfX",enabled:!1,target:"coreMath.paramA",shape:"Sine",period:5,amplitude:1,baseValue:.738,phase:0,smoothing:.5}]}},an={id:"MakinBrot",name:"Makin Brot",shortDescription:"Creates stacked, pagoda-like ornamental structures.",description:"A 3D fractal variant discovered by Makin. Now with extra shift and twist parameters.",shader:{function:`
    void formula_MakinBrot(inout vec4 z, inout float dr, inout float trap, vec4 c, mat2 rotX, mat2 rotZ) {
        vec3 z3 = z.xyz;
        
        // Twist F
        if (abs(uParamF) > 0.001) {
            float ang = z3.z * uParamF;
            float s = sin(ang); float co = cos(ang);
            z3.xy = mat2(co, -s, s, co) * z3.xy;
        }

        z3.yz = rotX * z3.yz;
        z3.xy = rotZ * z3.xy;
        float x = z3.x; float y = z3.y; float z_ = z3.z;
        z3.x = x*x - y*y - z_*z_;
        z3.y = 2.0 * x * y;
        z3.z = 2.0 * z_ * (x - y);
        float r = length(vec3(x,y,z_));
        dr = 2.0 * r * dr + 1.0;
        z3 = z3 * uParamA + c.xyz;
        
        // Shift E
        if (abs(uParamE) > 0.001) z3.y += uParamE;

        dr *= abs(uParamA);
        z.xyz = z3;
        trap = min(trap, dot(z3,z3));
    }`,loopInit:`
        float angC = uParamC;
        float sC = sin(angC), cC = cos(angC);
        mat2 rotX = mat2(cC, -sC, sC, cC);
        
        float angD = uParamD;
        float sD = sin(angD), cD = cos(angD);
        mat2 rotZ = mat2(cD, -sD, sD, cD);
        `,loopBody:"formula_MakinBrot(z, dr, trap, c, rotX, rotZ);"},parameters:[{label:"Scale",id:"paramA",min:.5,max:3,step:.001,default:1},{label:"Offset",id:"paramB",min:0,max:2,step:.001,default:0},{label:"Rot X",id:"paramC",min:0,max:6.28,step:.01,default:0,scale:"pi"},{label:"Rot Z",id:"paramD",min:0,max:6.28,step:.01,default:0,scale:"pi"},{label:"Shift Y",id:"paramE",min:-2,max:2,step:.01,default:0},{label:"Twist",id:"paramF",min:-2,max:2,step:.01,default:0}],defaultPreset:{formula:"MakinBrot",features:{coreMath:{iterations:24,paramA:1.455,paramB:0,paramC:0,paramD:0,paramE:0,paramF:0},coloring:{mode:1,repeats:1.3,phase:.2,scale:1.298,offset:.207,bias:1,twist:0,escape:2,mode2:5,repeats2:1,phase2:2.4,blendMode:0,blendOpacity:0,twist2:0,layer3Color:"#ffffff",layer3Scale:89,layer3Strength:0,layer3Bump:.2,layer3Turbulence:0,gradient:[{id:"0",position:0,color:"#ff0000"},{id:"1",position:.17,color:"#ffff00"},{id:"2",position:.33,color:"#00ff00"},{id:"3",position:.5,color:"#00ffff"},{id:"4",position:.67,color:"#000000"},{id:"5",position:.83,color:"#ff00ff"},{id:"6",position:1,color:"#ff0000"}],gradient2:[{id:"1",position:.61,color:"#FFFFFF"},{id:"2",position:.88,color:"#FF0505"}]},atmosphere:{fogNear:1e-4,fogFar:501,fogColor:"#000000",fogDensity:0,glowIntensity:.037,glowSharpness:47,glowColor:"#FF2323",glowMode:!1,aoIntensity:0,aoSpread:.1},materials:{reflection:.35,specular:0,roughness:.42,diffuse:1.41,envStrength:0,rim:.09,rimExponent:2,emission:.016,emissionColor:"#ffffff",emissionMode:0},geometry:{juliaMode:!1,juliaX:-.99,juliaY:.54,juliaZ:-.72,hybridMode:!1,hybridIter:2,hybridScale:2.13,hybridMinR:.72,hybridFixedR:1,hybridFoldLimit:.97},lighting:{shadows:!0,shadowSoftness:78,shadowIntensity:1,shadowBias:0},quality:{detail:6.3,fudgeFactor:.7,pixelThreshold:.1,maxSteps:300,aaMode:"Auto",aaLevel:1},optics:{dofStrength:0,dofFocus:1.368}},cameraPos:{x:-.8533969657887399,y:-.13446693672101487,z:1.154550164122028},cameraRot:{x:.04129519161407524,y:-.3129924386582225,z:.02381642440995219,w:.948558494991564},cameraFov:60,sceneOffset:{x:0,y:0,z:0,xL:-.8442073707354043,yL:-.15795817300110893,zL:.25127901307775025},cameraMode:"Orbit",lights:[{type:"Point",position:{x:-1.5227203148465231,y:-.10858858668233184,z:.5084783790561214},rotation:{x:0,y:0,z:0},color:"#99A4FF",intensity:5,falloff:61.5,falloffType:"Quadratic",fixed:!1,visible:!1,castShadow:!0},{type:"Point",position:{x:.05,y:.075,z:-.1},rotation:{x:0,y:0,z:0},color:"#ff0000",intensity:.5,falloff:.5,falloffType:"Quadratic",fixed:!1,visible:!1,castShadow:!1},{type:"Point",position:{x:.25,y:.075,z:-.1},rotation:{x:0,y:0,z:0},color:"#0000ff",intensity:.5,falloff:.5,falloffType:"Quadratic",fixed:!1,visible:!1,castShadow:!1}],animations:[{id:"4yFFplV3QPo3KoNaGJwfX",enabled:!1,target:"coreMath.paramA",shape:"Sine",period:5,amplitude:1,baseValue:1.455,phase:0,smoothing:.5}]}},on={id:"Tetrabrot",name:"Tetrabrot",shortDescription:"4D Pseudo-Quaternion set. Produces diamond-like geometric symmetries.",description:"A 4D Mandelbrot set visualization using a specific squaring function. Now with pre-rotation support.",shader:{function:`
    void formula_Tetrabrot(inout vec4 z, inout float dr, inout float trap, vec4 c) {
        
        // Rotations E and F
        float angE = uParamE;
        if (abs(angE) > 0.001) {
            float s = sin(angE); float co = cos(angE);
            z.xy = mat2(co, -s, s, co) * z.xy;
        }
        
        float angF = uParamF;
        if (abs(angF) > 0.001) {
            float s = sin(angF); float co = cos(angF);
            z.yz = mat2(co, -s, s, co) * z.yz;
        }

        // Fix: Chain rule +1.0
        dr = 2.0 * length(z) * dr + 1.0;
        z = tetraSquare(z) + c;
        trap = min(trap, dot(z,z));
    }`,loopBody:"formula_Tetrabrot(z, dr, trap, c);"},parameters:[{label:"Julia C (W)",id:"paramA",min:-1,max:1,step:.001,default:-.2},{label:"Slice W",id:"paramB",min:-1,max:1,step:.001,default:0},{label:"Rot Z",id:"paramE",min:0,max:6.28,step:.01,default:0,scale:"pi"},{label:"Rot X",id:"paramF",min:0,max:6.28,step:.01,default:0,scale:"pi"},null,null],defaultPreset:{formula:"Tetrabrot",features:{coreMath:{iterations:28,paramA:.186,paramB:0,paramC:0,paramD:0,paramE:0,paramF:0},coloring:{mode:5,repeats:1,phase:.87,scale:1,offset:.87,bias:1,twist:0,escape:4,mode2:5,repeats2:1,phase2:2.4,blendMode:0,blendOpacity:0,twist2:0,layer3Color:"#ffffff",layer3Scale:89,layer3Strength:0,layer3Bump:0,layer3Turbulence:0,gradient:[{id:"1766256604050_0",position:0,color:"#0A4CD3",bias:.5,interpolation:"linear"},{id:"1766256604050_1",position:.5,color:"#3E7FAA",bias:.5,interpolation:"linear"},{id:"1766256604050_2",position:1,color:"#62E9E9",bias:.5,interpolation:"linear"}],gradient2:[{id:"1",position:.61,color:"#FFFFFF"},{id:"2",position:.88,color:"#FF0505"}]},atmosphere:{fogNear:1e-4,fogFar:501,fogColor:"#000000",fogDensity:0,glowIntensity:1e-4,glowSharpness:47,glowColor:"#FF2323",glowMode:!1,aoIntensity:.4,aoSpread:.16},materials:{reflection:.35,specular:1.98,roughness:.11,diffuse:2,envStrength:0,rim:0,rimExponent:2,emission:.008,emissionColor:"#ffffff",emissionMode:0},geometry:{juliaMode:!1,juliaX:0,juliaY:0,juliaZ:0,hybridMode:!1,hybridIter:2,hybridScale:2,hybridMinR:.5,hybridFixedR:1,hybridFoldLimit:1},lighting:{shadows:!1,shadowSoftness:78,shadowIntensity:1,shadowBias:0},quality:{detail:1.1,fudgeFactor:.8,pixelThreshold:.5,maxSteps:300,aaMode:"Auto",aaLevel:1},optics:{dofStrength:0,dofFocus:1.368}},cameraPos:{x:.4920528506922438,y:-.07167206331378606,z:.4438830367018614},cameraRot:{x:-.2287674791967978,y:.3386642094524777,z:-.6145511225348657,w:.6747584097208478},cameraFov:60,sceneOffset:{x:0,y:0,z:0,xL:.43671384293273163,yL:-.013902955556870706,zL:.11442336133892608},cameraMode:"Orbit",lights:[{type:"Point",position:{x:.554923231509613,y:-.15190121945393503,z:-.030795909267397503},rotation:{x:0,y:0,z:0},color:"#FFFFFF",intensity:5,falloff:61.5,falloffType:"Quadratic",fixed:!1,visible:!0,castShadow:!0},{type:"Point",position:{x:.05,y:.075,z:-.1},rotation:{x:0,y:0,z:0},color:"#ff0000",intensity:.5,falloff:.5,falloffType:"Quadratic",fixed:!1,visible:!1,castShadow:!1},{type:"Point",position:{x:.25,y:.075,z:-.1},rotation:{x:0,y:0,z:0},color:"#0000ff",intensity:.5,falloff:.5,falloffType:"Quadratic",fixed:!1,visible:!1,castShadow:!1}]}},rn={id:"Buffalo",name:"Buffalo 3D",shortDescription:"Mandelbulb variation with absolute-value folds. Creates furry, plate-like textures.",description:"A variation of the Mandelbulb using Absolute Value folds. Uses a Menger-style fold to create structural complexity.",shader:{function:`
    void formula_Buffalo(inout vec4 z, inout float dr, inout float trap, vec4 c) {
        vec3 z3 = z.xyz;
        
        // 1. ABSOLUTE FOLD
        z3 = abs(z3);
        
        // 2. MENGER-STYLE SCALE & OFFSET
        // This cuts holes and flattens the geometry
        float scale = uParamB;
        float offset = 1.0;
        z3 = z3 * scale - vec3(offset * (scale - 1.0));
        dr *= abs(scale);

        // 3. ROTATION
        float angX = uParamC;
        float angZ = uParamD;
        if (abs(angX) > 0.0) {
            float s = sin(angX), c_ = cos(angX);
            z3.yz = mat2(c_, -s, s, c_) * z3.yz;
        }
        if (abs(angZ) > 0.0) {
            float s = sin(angZ), c_ = cos(angZ);
            z3.xy = mat2(c_, -s, s, c_) * z3.xy;
        }
        
        // 4. POWER
        float r = length(z3);
        if (r > 1.0e-4) {
            float power = uParamA;
            dr = pow(r, power - 1.0) * power * dr + 1.0;
            
            float theta = acos(clamp(z3.z / r, -1.0, 1.0));
            float phi = atan(z3.y, z3.x);
            
            float zr = pow(r, power);
            theta *= power;
            phi *= power;
            
            z3 = zr * vec3(sin(theta) * cos(phi), sin(phi) * sin(theta), cos(theta));
        } else {
            dr = 1.0; 
        }
        
        z3 += c.xyz;
        z.xyz = z3;
        trap = min(trap, r);
    }`,loopBody:"formula_Buffalo(z, dr, trap, c);"},parameters:[{label:"Power",id:"paramA",min:2,max:16,step:.001,default:8},{label:"Fold Scale",id:"paramB",min:1,max:3,step:.001,default:1.5},{label:"Rot X",id:"paramC",min:0,max:6.28,step:.01,default:0,scale:"pi"},{label:"Rot Z",id:"paramD",min:0,max:6.28,step:.01,default:0,scale:"pi"}],defaultPreset:{formula:"Buffalo",features:{coreMath:{iterations:22,paramA:2.911,paramB:1.358,paramC:1,paramD:1.27,paramE:1,paramF:1},coloring:{mode:0,repeats:3.58,phase:.7,scale:3.579,offset:.6958,bias:1,twist:0,escape:4,mode2:4,repeats2:1,phase2:0,blendMode:0,blendOpacity:0,twist2:0,layer3Color:"#aaccff",layer3Scale:10,layer3Strength:0,layer3Bump:0,layer3Turbulence:0,gradient:[{id:"1766251986254_0",position:0,color:"#330600",bias:.5,interpolation:"linear"},{id:"1766252034417",position:.13654618473895583,color:"#BC2900",bias:.5,interpolation:"linear"},{id:"1766251986254_1",position:.3,color:"#FFAE00",bias:.5,interpolation:"linear"},{id:"1766252020600",position:.5180722891566265,color:"#743C14",bias:.5,interpolation:"linear"},{id:"1766252024362",position:.6224899598393574,color:"#150B5F",bias:.5,interpolation:"linear"},{id:"1766251986254_2",position:.7,color:"#001F97",bias:.5,interpolation:"linear"},{id:"1766251986254_3",position:1,color:"#700303",bias:.5,interpolation:"linear"}],gradient2:[{id:"1",position:0,color:"#000000"},{id:"2",position:1,color:"#FFFFFF"}]},atmosphere:{fogNear:1.5,fogFar:6,fogColor:"#000510",fogDensity:0,glowIntensity:.035,glowSharpness:50,glowColor:"#ffffff",glowMode:!1,aoIntensity:0,aoSpread:.61},materials:{reflection:0,specular:.41,roughness:.59,diffuse:.07,envStrength:0,rim:0,rimExponent:4,emission:.001,emissionColor:"#ffffff",emissionMode:0},geometry:{juliaMode:!0,juliaX:.73,juliaY:-.34,juliaZ:.98,hybridMode:!1,hybridIter:2,hybridScale:1.18,hybridMinR:.5,hybridFixedR:1,hybridFoldLimit:1.15},lighting:{shadows:!0,shadowSoftness:58.7,shadowIntensity:1,shadowBias:17e-7},quality:{detail:1,fudgeFactor:1,pixelThreshold:.5,maxSteps:300,aaMode:"Always",aaLevel:1,estimator:0},optics:{dofStrength:0,dofFocus:.38}},cameraPos:{x:0,y:0,z:0},cameraRot:{x:-.6882525110443435,y:.6754105694956275,z:-.18538417957112108,w:.18910777249886715},cameraFov:60,sceneOffset:{x:-1,y:0,z:0,xL:.3765650773029154,yL:.001230038917818407,zL:.08497907239183068},cameraMode:"Fly",lights:[{type:"Point",position:{x:-1.2312987020450135,y:.08848406939920131,z:.14923449323142857},rotation:{x:0,y:0,z:0},color:"#ffffff",intensity:5,falloff:2.3040000000000003,falloffType:"Quadratic",fixed:!1,visible:!0,castShadow:!0},{type:"Point",position:{x:-2,y:-1,z:1},rotation:{x:0,y:0,z:0},color:"#0044aa",intensity:2,falloff:.8,falloffType:"Quadratic",fixed:!1,visible:!1,castShadow:!1},{type:"Point",position:{x:.06545550750209214,y:.6734234224352387,z:-2.486302326628615},rotation:{x:0,y:0,z:0},color:"#001133",intensity:.5,falloff:0,falloffType:"Linear",fixed:!0,visible:!1,castShadow:!1}]}},Za=[{id:"note-1",type:"Note",enabled:!0,params:{},text:`Infinite Repetition
The 'Mod' node tiles space. Here we repeat every 4.0 units on X and Y to create a forest of fractals.`},{id:"mod-1",type:"Mod",enabled:!0,params:{x:4,y:4,z:0}},{id:"note-2",type:"Note",enabled:!0,params:{},text:`Dynamic Rotation
This rotation is bound to 'ParamC' (Slider below). Try dragging it!`},{id:"rot-1",type:"Rotate",enabled:!0,params:{x:0,y:0,z:0},bindings:{z:"ParamC"}},{id:"bulb-1",type:"Mandelbulb",enabled:!0,params:{power:8}},{id:"add-c",type:"AddConstant",enabled:!0,params:{scale:1}}],nn={id:"Modular",name:"Modular Builder",shortDescription:"Construct custom fractal equations using a Node Graph.",description:"Construct your own fractal equation by chaining operations together. Combine folds, rotations, and logic via the Graph tab.",shader:{function:"",loopBody:"",getDist:""},parameters:[null,null,null,null],defaultPreset:{formula:"Modular",features:{coreMath:{iterations:16,paramA:8,paramB:0,paramC:0,paramD:0,paramE:0,paramF:0},lighting:{shadows:!0,shadowSoftness:16,shadowIntensity:1,shadowBias:.002}},pipeline:Za,cameraPos:{x:0,y:0,z:4},cameraRot:{x:0,y:0,z:0,w:1},sceneOffset:{x:0,y:0,z:0,xL:0,yL:0,zL:0}}},sn={id:"ArisBrot",name:"ArisBrot",shortDescription:"Dr. Aris's V2.0 Hybrid. Features Domain Warping, KIFS folds, and Bulb Power.",description:"Dr. Aris's V2.0 Hybrid. Now features a dedicated Power parameter alongside Reality Warp and Shear.",shader:{function:`
    void formula_ArisBrot(inout vec4 z, inout float dr, inout float trap, vec4 c) {
        vec3 z3 = z.xyz;
        
        // 1. DOMAIN WARPING (The "Reality Warp") - Param C
        // Twist space based on Z-depth.
        float warpStrength = uParamC;
        if (abs(warpStrength) > 0.001) {
            float angle = z3.z * warpStrength * 0.5 + uParamF; // Add Phase shift F
            float s = sin(angle);
            float c_ = cos(angle);
            z3.xy = mat2(c_, -s, s, c_) * z3.xy;
        }

        // 2. KALEIDOSCOPIC FOLD (The Crystal)
        // Fold space across diagonal planes
        z3 = abs(z3);
        if (z3.x < z3.y) z3.xy = z3.yx;
        if (z3.x < z3.z) z3.xz = z3.zx;
        if (z3.y < z3.z) z3.yz = z3.zy;
        
        // 3. SPHERICAL INVERSION (The Void) - Param D
        float r2 = dot(z3, z3);
        float minR = 0.5;
        float fixedR = max(uParamD, 0.1); 
        
        if (r2 < minR) {
            float factor = fixedR / minR;
            z3 *= factor;
            dr *= factor;
        } else if (r2 < fixedR) {
            float factor = fixedR / r2;
            z3 *= factor;
            dr *= factor;
        }

        // 4. SCALE & TRANSLATE - Param A
        float scale = uParamA;
        z3 = z3 * scale - vec3(uParamE * (scale - 1.0)); // Param E is Offset/Shear magnitude
        dr = dr * abs(scale) + 1.0;

        // 5. POWER BULB INJECTION - Param B (The "Power")
        // This makes it a true hybrid.
        float r = length(z3);
        if (r > 1.0e-4) {
            float power = uParamB;
            // Derivative chain rule
            dr = pow(r, power - 1.0) * power * dr + 1.0;
            
            float theta = acos(clamp(z3.z / r, -1.0, 1.0));
            float phi = atan(z3.y, z3.x);
            float zr = pow(r, power);
            
            theta *= power;
            phi *= power;
            
            z3 = zr * vec3(sin(theta) * cos(phi), sin(phi) * sin(theta), cos(theta));
        }

        // 6. INJECTION
        if (uJuliaMode > 0.5) {
            z3 += c.xyz;
        } else {
            z3 += c.xyz;
        }

        z.xyz = z3;
        
        // Trap: mix of geometric (box) and organic (sphere)
        trap = min(trap, min(length(z3), max(abs(z3.x), max(abs(z3.y), abs(z3.z)))));
    }`,loopBody:"formula_ArisBrot(z, dr, trap, c);"},parameters:[{label:"Scale (KIFS)",id:"paramA",min:1.5,max:4,step:.001,default:2.25},{label:"Power (Bulb)",id:"paramB",min:1,max:16,step:.01,default:2},{label:"Reality Warp",id:"paramC",min:-2,max:2,step:.001,default:.5},{label:"Void Radius",id:"paramD",min:.5,max:3,step:.001,default:1.45},{label:"Offset / Shear",id:"paramE",min:0,max:2,step:.001,default:.85},{label:"Warp Phase",id:"paramF",min:0,max:6.28,step:.01,default:0,scale:"pi"}],defaultPreset:{version:5,name:"Custom Preset",formula:"ArisBrot",features:{atmosphere:{fogColor:"#050510",fogNear:1e-4,fogFar:501.18723362727246,fogDensity:0,glowIntensity:.09945726218577258,glowSharpness:4,glowMode:!1,glowColor:"#ffffff",aoIntensity:0,aoSpread:.283706966406409,aoMode:!1},droste:{active:!1,tiling:1,center:{x:0,y:0},radiusInside:5,radiusOutside:100,periodicity:2,strands:2,autoPeriodicity:!1,strandMirror:!1,zoom:0,rotate:0,rotateSpin:0,rotatePolar:0,twist:!0,hyperDroste:!1,fractalPoints:1},materials:{diffuse:.99,reflection:.6,specular:1.2,roughness:.3,rim:0,rimExponent:3,envStrength:0,envMapVisible:!1,envBackgroundStrength:1,envSource:1,useEnvMap:!1,envRotation:0,envGradientStops:[],emission:.024378546022433615,emissionMode:0,emissionColor:"#ffffff",ptEmissionMult:1},colorGrading:{saturation:1,levelsMin:0,levelsMax:1,levelsGamma:1},texturing:{active:!1,layer1Data:null,mapU:6,mapV:1,scaleX:1,scaleY:1,offset:{x:0,y:0}},coloring:{gradient:[{id:"1",position:0,color:"#000000"},{id:"2",position:.2,color:"#220044"},{id:"3",position:.45,color:"#00ccff"},{id:"4",position:.6,color:"#ffffff"},{id:"5",position:.8,color:"#ff0088"},{id:"6",position:1,color:"#220044"}],mode:0,scale:2.0833333333333335,offset:0,repeats:2.5,phase:0,bias:1,twist:0,escape:2,gradient2:[{id:"1",position:0,color:"#000000"},{id:"2",position:1,color:"#ffffff"}],mode2:5,scale2:1,offset2:0,repeats2:1,phase2:.69,bias2:1,twist2:0,blendMode:3,blendOpacity:.3,layer3Color:"#ffffff",layer3Scale:15,layer3Strength:0,layer3Bump:0,layer3Turbulence:0},geometry:{juliaMode:!1,juliaX:-.37,juliaY:-.16,juliaZ:-.02,hybridMode:!1,hybridIter:2,hybridScale:1.14,hybridMinR:.5,hybridFixedR:1,hybridFoldLimit:1,hybridSkip:1,hybridAddC:!1},quality:{fudgeFactor:.8,detail:.8,pixelThreshold:.5,maxSteps:300,estimator:4},coreMath:{iterations:7,paramA:2,paramB:1.061,paramC:2,paramD:1.236,paramE:.618,paramF:0},lighting:{shadows:!0,shadowSoftness:24,shadowIntensity:.8,shadowBias:.001,ptBounces:3,ptGIStrength:1,ptStochasticShadows:!1},optics:{camType:0,camFov:60,orthoScale:2,dofStrength:0,dofFocus:2.8747377395629883}},cameraPos:{x:1.4388761158360055,y:1.4657884937852592,z:2.8339194792307407},cameraRot:{x:-.12087634947347892,y:.283801459206713,z:.36341975729641146,w:.8790743540205932},sceneOffset:{x:-1,y:0,z:1,xL:-.2357778754965203,yL:-.45934971767267063,zL:-.7101331675294089},targetDistance:2.6880587339401245,cameraMode:"Orbit",lights:[{type:"Point",position:{x:-.17107759854656118,y:.9929766175094275,z:1.7793549614211224},rotation:{x:0,y:0,z:0},color:"#ccffff",intensity:1.5,falloff:.5,falloffType:"Quadratic",fixed:!1,visible:!0,castShadow:!0},{type:"Point",position:{x:-3,y:0,z:-1},rotation:{x:0,y:0,z:0},color:"#ff00aa",intensity:2,falloff:.8,falloffType:"Quadratic",fixed:!1,visible:!1,castShadow:!1},{type:"Point",position:{x:0,y:-4,z:1},rotation:{x:0,y:0,z:0},color:"#0022aa",intensity:.8,falloff:.2,falloffType:"Linear",fixed:!0,visible:!0,castShadow:!1}],renderMode:"Direct",navigation:{flySpeed:.5,autoSlow:!0},animations:[{id:"4yFFplV3QPo3KoNaGJwfX",enabled:!1,target:"coreMath.paramA",shape:"Sine",period:5,amplitude:1,baseValue:2,phase:0,smoothing:.5,pulseWidth:.5}],sequence:{durationFrames:300,fps:30,tracks:{}},duration:300}},ln={id:"MandelTerrain",name:"MandelTerrain",shortDescription:'3D Heightmap of the Mandelbrot set. Creates alien landscapes and "Math Mountains".',description:"A 3D Heightmap of the Mandelbrot set. Iterations slider controls terrain detail.",shader:{function:`
    void formula_MandelTerrain(inout vec4 z, inout float dr, inout float trap, vec4 c) {
        vec2 p = z.xz;
        
        // --- Zoom Logic ---
        float zoomVal = uParamB; 
        float zoom = pow(2.0, zoomVal);
        vec2 center = vec2(uParamE, uParamF);
        
        // Map 3D pos to 2D Complex Plane
        vec2 mapPos = p * (2.0 / zoom) + center;
        
        // --- Julia / Mandelbrot Switch ---
        vec2 c2;
        vec2 z2;
        vec2 dz;
        
        bool isJulia = uJuliaMode > 0.5;
        
        if (isJulia) {
            // Julia Mode: C is constant, Z starts at pixel
            c2 = uJulia.xy;
            z2 = mapPos;
            dz = vec2(1.0, 0.0); // Derivative starts at 1
        } else {
            // Mandelbrot Mode: C is pixel, Z starts at 0
            c2 = mapPos;
            z2 = vec2(0.0);
            dz = vec2(0.0); // Derivative starts at 0
        }
        
        float m2 = 0.0;
        float trapDist = 1e20;
        
        // Accumulate trap height (Summation for smooth blending)
        float trapHeightAccum = 0.0;
        float runAtten = 1.0;
        
        // Fixed Attenuation Factor (User Preference)
        float attenDecay = 0.777;
        
        // COMPILER OPTIMIZATION: Use int loop with uLoopGuard
        int maxIter = int(uIterations);
        int limit = maxIter;
        
        float iter = 0.0;
        float smoothVal = 0.0;
        float dist = 0.0;
        bool escaped = false;

        // Local hard limit high enough for deep zooms but low enough to avoid compiler hangs
        const int MAX_FORMULA_ITER = 2000;

        for(int i=0; i<MAX_FORMULA_ITER; i++) {
            if (i > limit) break;

            // --- BURNING SHIP SUPPORT ---
            if (uBurningEnabled > 0.5) {
                 // FIX: Flip derivative to maintain DE continuity across axes
                 if (z2.x < 0.0) dz.x = -dz.x;
                 if (z2.y < 0.0) dz.y = -dz.y;
                 z2 = abs(z2);
            }

            // Derivative: dz = 2*z*dz (+ 1 if Mandelbrot)
            // (Chain rule for z^2 + c)
            float dzx = 2.0 * (z2.x * dz.x - z2.y * dz.y);
            float dzy = 2.0 * (z2.x * dz.y + z2.y * dz.x);
            
            if (!isJulia) {
                dzx += 1.0;
            }
            
            dz = vec2(dzx, dzy);

            // Z = Z^2 + C
            float x = (z2.x * z2.x - z2.y * z2.y) + c2.x;
            float y = (2.0 * z2.x * z2.y) + c2.y;
            z2 = vec2(x, y);
            
            m2 = dot(z2, z2);
            
            // Standard Trap Tracking (for coloring)
            trapDist = min(trapDist, m2);
            
            // --- Trap Height Accumulation ---
            // Sum contributions. 
            // Allow negative param D to work (abs check)
            if (abs(uParamD) > 0.001 && m2 < 0.25) {
                float distToOrigin = sqrt(m2);
                
                // Smooth shape (Metaball-like blending)
                float t = smoothstep(0.5, 0.0, distToOrigin);
                
                // Accumulate with attenuation
                trapHeightAccum += t * runAtten;
            }
            
            // Decay influence for deeper iterations
            runAtten *= attenDecay;
            
            // Use global Escape Threshold (usually squared radius)
            // Default escape is 4.0 (radius 2.0), but allowing it to grow helps decomposition
            if (m2 > uEscapeThresh) { 
                escaped = true;
                // Smooth Iteration Count
                // Renormalize based on log of threshold to keep bands consistent
                float threshLog = log2(uEscapeThresh); // usually 2.0 for 4.0
                smoothVal = float(i) + 1.0 - log2(log2(m2) / threshLog);
                
                // Analytical Distance Estimation
                float r = sqrt(m2);
                float dr_mag = length(dz);
                dist = 0.5 * log(m2) * r / dr_mag;
                
                // CRITICAL: Overwrite Trap with Magnitude ONLY for "Potential" Coloring Mode (8)
                // Otherwise preserve minTrap for Orbit Trap Mode (0)
                if (abs(uColorMode - 8.0) < 0.1 || abs(uColorMode2 - 8.0) < 0.1) {
                    trapDist = r; 
                }
                break;
            }
        }
        
        // --- Heightmap Calculation ---
        float h = 0.0;
        
        if (escaped) {
            // 1. Base Terrain (Param A)
            // 'dist' goes to 0.0 exactly at the boundary.
            // FIXED: Use sqrt(dist * zoom) instead of sqrt(dist) * zoom to keep height
            // proportional to feature width regardless of zoom level.
            // This prevents "spikes" from growing uncontrollably deep in the set.
            h += sqrt(dist * zoom) * uParamA;
            
            // 2. Layer 2 Driven Ripples (Param C) - Driven by Gradient Brightness
            if (abs(uParamC) > 0.001) {
                // Compute Decomposition Angle for Mapping
                float decomp = atan(z2.y, z2.x) * 0.15915 + 0.5;
                
                // Construct proxy result to feed coloring engine
                // Components: x=dist, y=trap, z=iter, w=decomp
                vec4 resProxy = vec4(0.0, trapDist, smoothVal, decomp);
                
                // Construct 3D pos proxy using the mapping position (consistent texture space)
                vec3 pProxy = vec3(mapPos.x, 0.0, mapPos.y);
                
                // Get Mapping Value from Layer 2 Mode (e.g. Angle, Trap, Iterations)
                float l2Val = getMappingValue(uColorMode2, pProxy, resProxy, vec3(0,1,0), uColorScale2);
                
                // Apply Twist 2 if active
                if (abs(uColorTwist2) > 0.001) {
                    float dOrig = length(pProxy);
                    l2Val += dOrig * uColorTwist2;
                }
                
                // Calculate Pattern Phase
                float t2Raw = l2Val * uColorScale2 + uColorOffset2;
                float t2 = fract(t2Raw);
                
                // Sample Gradient 2 for height (Whiteness = Height)
                // SAFE HELPER: Using textureLod0 via math.ts
                vec3 gCol = textureLod0(uGradientTexture2, vec2(t2, 0.5)).rgb;
                float brightness = dot(gCol, vec3(0.299, 0.587, 0.114));
                
                // Apply Displacement
                h += brightness * uParamC;
            }
        } else {
            // Inside the set (The Lake)
            h = 0.0; 
        }
        
        // 3. Orbit Trap Spikes (Param D)
        // Scaled by Zoom to maintain relative visual height
        // Supports negative values (depressions)
        if (abs(uParamD) > 0.001) {
            h += trapHeightAccum * uParamD * zoom * 0.03;
        }
        
        h = clamp(h, -50.0, 50.0);
        
        // SDF Calculation (y is Up)
        float d = (z.y - h) * 0.5;
        
        // --- Output ---
        
        // Encode Angle into Z so DE_MASTER can extract Decomposition
        float angle = 0.0;
        if (dot(z2, z2) > 1e-9) {
            angle = atan(z2.y, z2.x);
        }
        
        float mag = abs(d);
        z = vec4(mag * cos(angle), mag * sin(angle), 0.0, 0.0);
        
        // Final Trap Output: Either minTrap or Magnitude (if escaped)
        // Fix: Use sqrt of trapDist to normalize Orbit Trap coloring range
        trap = sqrt(trapDist);
        dr = smoothVal;
    }`,loopBody:"formula_MandelTerrain(z, dr, trap, c); break;",getDist:`
            // Standard return
            return vec2(r, dr);
        `},parameters:[{label:"Map Zoom",id:"paramB",min:0,max:16,step:.01,default:1},{label:"Pan X (Real)",id:"paramE",min:-2,max:.5,step:1e-4,default:0},{label:"Pan Y (Imagin)",id:"paramF",min:-1.25,max:1.25,step:1e-4,default:0},{label:"Height: Distance Estimator",id:"paramA",min:-5,max:5,step:.01,default:0},{label:"Height: Layer 2 Gradient",id:"paramC",min:-.2,max:.2,step:.001,default:0},{label:"Height: SmoothTrap",id:"paramD",min:-5,max:5,step:.01,default:0}],defaultPreset:{version:1,name:"MandelTerrain",formula:"MandelTerrain",features:{coreMath:{iterations:60,paramA:0,paramB:1,paramC:0,paramD:0,paramE:0,paramF:0},geometry:{applyTransformLogic:!0,preRotMaster:!0,hybridComplex:!1,burningEnabled:!1,hybridMode:!1,hybridIter:2,hybridFoldLimit:1,hybridScale:2,hybridMinR:.5,hybridFixedR:1,hybridAddC:!1,hybridProtect:!0,hybridSwap:!1,hybridSkip:1,preRotEnabled:!1,preRotY:0,preRotX:0,preRotZ:0,juliaMode:!1,juliaX:-.86,juliaY:-.22,juliaZ:0,preRot:{x:0,y:0,z:0},julia:{x:0,y:0,z:0}},lighting:{advancedLighting:!0,ptEnabled:!0,renderMode:0,ptBounces:3,ptGIStrength:1,shadowsCompile:!0,shadowAlgorithm:0,ptStochasticShadows:!1,shadows:!0,shadowSteps:128,shadowSoftness:19.5,shadowIntensity:1,shadowBias:1e-4,lights:[{position:{x:-.77,y:1.82,z:-.49},color:"#ffeedd",intensity:2,falloff:0,falloffType:"Quadratic",fixed:!1,visible:!0,castShadow:!0},{position:{x:-5,y:2,z:-5},color:"#4455aa",intensity:1,falloff:0,falloffType:"Quadratic",fixed:!0,visible:!1,castShadow:!1},{position:{x:0,y:5,z:-5},color:"#ffffff",intensity:.5,falloff:0,falloffType:"Quadratic",fixed:!0,visible:!1,castShadow:!1}]},ao:{aoIntensity:0,aoSpread:.11,aoSamples:5,aoMode:!0,aoMaxSamples:32,aoStochasticCp:!0,aoEnabled:!0},reflections:{mixStrength:1,roughnessThreshold:.5,bounces:1,steps:64,enabled:!0},atmosphere:{glowEnabled:!0,glowQuality:0,fogIntensity:0,fogNear:0,fogFar:30,fogColor:"#051020",fogDensity:.02,glowIntensity:0,glowSharpness:3.8,glowMode:!1,glowColor:"#ffffff"},materials:{diffuse:1,reflection:0,specular:0,roughness:.2,rim:0,rimExponent:3,envStrength:0,envMapVisible:!1,envBackgroundStrength:1,envSource:1,envMapData:null,useEnvMap:!0,envRotation:0,envGradientStops:[{id:"1",position:1,color:"#ffffff",bias:.5,interpolation:"linear"}],emission:.3,emissionMode:0,emissionColor:"#ffffff",ptEmissionMult:1},waterPlane:{waterEnabled:!1,active:!0,height:-2,color:"#001133",roughness:.02,waveStrength:.1,waveSpeed:1,waveFrequency:1.5},coloring:{gradient:[{id:"0",position:0,color:"#001133",bias:.5,interpolation:"linear"},{id:"1",position:.153,color:"#0063A5",bias:.5,interpolation:"linear"},{id:"2",position:.324,color:"#0093F5",bias:.749,interpolation:"linear"},{id:"3",position:.895,color:"#FFFFFF",bias:.5,interpolation:"linear"},{id:"4",position:.908,color:"#000000",bias:.5,interpolation:"linear"}],mode:7,scale:.2710027100271003,offset:-.007588075880758799,repeats:1,phase:-.2,bias:1,twist:0,escape:20,gradient2:[{id:"1",position:.077,color:"#000000",bias:.52,interpolation:"smooth"},{id:"2",position:.196,color:"#020202",bias:.83,interpolation:"smooth"},{id:"3",position:.857,color:"#000000",bias:.5,interpolation:"linear"},{id:"4",position:.925,color:"#797979",bias:.5,interpolation:"linear"}],mode2:0,scale2:.74,offset2:.55,repeats2:1,phase2:.43,bias2:1,twist2:0,blendMode:0,blendOpacity:0},texturing:{active:!1,layer1Data:null,mapU:6,mapV:1,scaleX:1,scaleY:1,offset:{x:0,y:0},textureScale:{x:1,y:1}},quality:{engineQuality:!0,compilerHardCap:500,precisionMode:0,bufferPrecision:0,maxSteps:300,distanceMetric:2,estimator:0,fudgeFactor:.35,detail:1.1,pixelThreshold:.5,dynamicScaling:!1,interactionDownsample:2},droste:{active:!1,tiling:1,center:{x:0,y:0},radiusInside:5,radiusOutside:100,periodicity:2,strands:2,autoPeriodicity:!1,strandMirror:!1,zoom:0,rotate:0,rotateSpin:0,rotatePolar:0,twist:!0,hyperDroste:!1,fractalPoints:1},colorGrading:{active:!1,saturation:1.5,levelsMin:0,levelsMax:.5,levelsGamma:.77},optics:{camType:0,camFov:60,orthoScale:2,dofStrength:0,dofFocus:10},navigation:{flySpeed:.5,autoSlow:!0},audio:{threshold:.1,agcEnabled:!1,attack:.1,decay:.3,highPass:20,lowPass:2e4,gain:1},drawing:{activeTool:"rect",enabled:!1,active:!1,originMode:1,color:"#00ffff",lineWidth:1,showLabels:!0,showAxes:!1,shapes:[],refreshTrigger:0},modulation:{rules:[],selectedRuleId:null},webcam:{opacity:1,posX:20,posY:80,width:320,height:240,cropL:0,cropR:0,cropT:0,cropB:0,blendMode:0,crtMode:!1,tilt:0,fontSize:12},debugTools:{shaderDebuggerOpen:!1,stateDebuggerOpen:!1},engineSettings:{showEngineTab:!1}},cameraPos:{x:0,y:0,z:0},cameraRot:{x:-.7071067811865476,y:0,z:0,w:.7071067811865475},sceneOffset:{x:-.082,y:3.17,z:-.38,xL:.082,yL:-.1700000000000009,zL:.3800000000000002},targetDistance:2.997344970703125,cameraMode:"Orbit",lights:[],renderMode:"Direct",quality:{aaMode:"Always",aaLevel:1,msaa:1,accumulation:!0},animations:[],sequence:{durationFrames:300,fps:30,tracks:{}},duration:300}},cn={id:"MarbleMarcher",name:"Marble Marcher",shortDescription:"The dynamic fractal from the game Marble Marcher. Fast rendering, geometric feel.",description:"The dynamic fractal from the game Marble Marcher. A specialized Menger Sponge IFS with rotation and shifting steps.",shader:{function:`
    void formula_MarbleMarcher(inout vec4 z, inout float dr, inout float trap, vec4 c) {
        vec3 z3 = z.xyz;
        
        // 1. Abs
        z3 = abs(z3);
        
        // 2. Rot Z (Param C)
        float ang1 = uParamC;
        if (abs(ang1) > 0.001) {
            float s1 = sin(ang1), c1 = cos(ang1);
            z3.xy = mat2(c1, s1, -s1, c1) * z3.xy;
        }
        
        // 3. Menger Fold
        // Equivalent to: if (x<y) swap; if (x<z) swap; if (y<z) swap;
        float a = min(z3.x - z3.y, 0.0); z3.x -= a; z3.y += a;
        a = min(z3.x - z3.z, 0.0); z3.x -= a; z3.z += a;
        a = min(z3.y - z3.z, 0.0); z3.y -= a; z3.z += a;
        
        // 4. Rot X (Param D)
        float ang2 = uParamD;
        if (abs(ang2) > 0.001) {
            float s2 = sin(ang2), c2 = cos(ang2);
            z3.yz = mat2(c2, s2, -s2, c2) * z3.yz;
        }
        
        // 5. Scale (Param A)
        float scale = uParamA;
        z3 *= scale;
        dr *= abs(scale); // Standard IFS scaling
        
        // 6. Shift (Params B, E, F)
        // Original game uses a single vec3 shift. We map params.
        vec3 shift = vec3(uParamB, uParamE, uParamF);
        z3 += shift;
        
        if (uJuliaMode > 0.5) z3 += c.xyz;

        z.xyz = z3;
        
        // Use a box trap for coloring to match geometric nature
        vec3 boxDist = abs(z3) - vec3(1.0);
        trap = min(trap, length(max(boxDist, 0.0)) + min(max(boxDist.x, max(boxDist.y, boxDist.z)), 0.0));
    }`,loopBody:"formula_MarbleMarcher(z, dr, trap, c);",getDist:`
            // The original used a hardcoded Box SDF: length(max(abs(z)-6.0, 0.0))
            // We now use 'r' which comes from DE_MASTER and respects the global Distance Metric.
            // NOTE: Select 'Chebyshev' in Quality settings for the classic look!
            float limit = 6.0;
            return vec2((r - limit) / dr, iter);
        `},parameters:[{label:"Scale",id:"paramA",min:1,max:4,step:.001,default:2},{label:"Shift X",id:"paramB",min:-5,max:5,step:.01,default:-2},{label:"Rot Z",id:"paramC",min:0,max:6.28,step:.01,default:0,scale:"pi"},{label:"Rot X",id:"paramD",min:0,max:6.28,step:.01,default:0,scale:"pi"},{label:"Shift Y",id:"paramE",min:-5,max:5,step:.01,default:-2},{label:"Shift Z",id:"paramF",min:-5,max:5,step:.01,default:-2}],defaultPreset:{formula:"MarbleMarcher",features:{coreMath:{iterations:21,paramA:1.89,paramB:-2.16,paramC:-.047,paramD:.025,paramE:-2.84,paramF:-2.47},coloring:{mode:6,repeats:2.5,phase:0,scale:1,offset:0,bias:1,twist:0,escape:16.18,mode2:6,repeats2:250,phase2:5,blendMode:2,blendOpacity:0,twist2:0,layer3Color:"#ffffff",layer3Scale:89,layer3Strength:0,layer3Bump:0,layer3Turbulence:0,gradient:[{id:"1766936009557_0",position:.0369,color:"#130606",bias:.5,interpolation:"linear"},{id:"1766936025161",position:.1409,color:"#463434",bias:.5,interpolation:"linear"},{id:"1766936020401",position:.4194,color:"#828282",bias:.5,interpolation:"linear"},{id:"1766936032564",position:.6879,color:"#BCBCBC",bias:.5,interpolation:"linear"},{id:"1766936039597",position:1,color:"#875656",bias:.5,interpolation:"linear"}],gradient2:[{id:"1",position:0,color:"#000000"},{id:"2",position:1,color:"#FFFFFF"}]},texturing:{active:!1,scaleX:4,scaleY:24,offset:{x:-.02,y:-.08},mapU:6,mapV:8,layer1Data:null},materials:{reflection:-.44,specular:0,roughness:.5,diffuse:.92,envStrength:0,rim:0,rimExponent:4,emission:.085,emissionColor:"#ffffff",emissionMode:1,envMapVisible:!1,envSource:1,useEnvMap:!0,envRotation:0,envGradientStops:[{id:"0",position:.03,color:"#130606"},{id:"1",position:.14,color:"#463434"},{id:"2",position:.41,color:"#824040"},{id:"3",position:.68,color:"#BCBCBC"},{id:"4",position:1,color:"#875656"}]},atmosphere:{fogNear:0,fogFar:100,fogColor:"#7E6861",fogDensity:0,glowIntensity:1e-4,glowSharpness:400,glowColor:"#ffffff",glowMode:!1,aoIntensity:.44,aoSpread:.28,aoMode:!1},geometry:{juliaMode:!1,juliaX:-2,juliaY:.86,juliaZ:-2,hybridMode:!1,hybridIter:2,hybridScale:2,hybridMinR:.5,hybridFixedR:1,hybridFoldLimit:1},lighting:{shadows:!0,shadowSoftness:16,shadowIntensity:1,shadowBias:7e-4},quality:{detail:1.1,fudgeFactor:.62,pixelThreshold:.5,maxSteps:300,distanceMetric:1},optics:{dofStrength:0,dofFocus:4.65}},cameraPos:{x:1.7472844097880647,y:-1.3734380139592728,z:2.8232426812200377},cameraRot:{x:.23927126357209905,y:.22332520402424524,z:.14464802218445671,w:.9337837358587185},cameraFov:75,sceneOffset:{x:2,y:-2,z:2,xL:-.25680194984918847,yL:.6967983054660813,zL:.44809374764147025},targetDistance:.5,cameraMode:"Orbit",lights:[{type:"Point",position:{x:.936,y:-2.75,z:6.21},rotation:{x:0,y:0,z:0},color:"#ffffff",intensity:8,falloff:.67,falloffType:"Linear",fixed:!1,visible:!0,castShadow:!0},{type:"Point",position:{x:-5,y:-2,z:2},rotation:{x:0,y:0,z:0},color:"#ff8800",intensity:1,falloff:0,falloffType:"Linear",fixed:!1,visible:!1,castShadow:!1},{type:"Point",position:{x:0,y:0,z:-5},rotation:{x:0,y:0,z:0},color:"#0044ff",intensity:1,falloff:0,falloffType:"Linear",fixed:!1,visible:!1,castShadow:!1}],animations:[{id:"2JfG4QE8x4GkvGQU5DKqx",enabled:!1,target:"coreMath.paramA",shape:"Sine",period:5,amplitude:1,baseValue:1.89,phase:0,smoothing:.5}]}},dn={id:"JuliaMorph",name:"Julia Morph (Stack)",shortDescription:'Constructs 3D volumes by stacking 2D Julia sets. Perfect for topographic or sliced "MRI" effects.',description:"Constructs a 3D object by stacking 2D Julia sets along the Z-axis. Use the Julia Panel to set the Start shape, and Params D/E for the End shape.",shader:{function:`
    void formula_JuliaMorph(inout vec4 z, inout float dr, inout float trap, vec4 c) {
        vec3 p = z.xyz;
        
        // --- 1. MAPPING & DEFORMATION ---
        float height = max(0.1, uParamA); 
        vec2 Z = p.xy;
        float z_val = p.z;
        float t = clamp((p.z / height) + 0.5, 0.0, 1.0);

        if (uParamC > 0.001) {
            // Standard Twist: Rotate around center (0,0) in XY plane
            float ang = p.z * uParamC;
            float s = sin(ang); float co = cos(ang);
            Z = mat2(co, -s, s, co) * p.xy;
        } else if (uParamC < -0.001) {
            // Spatial Bend: Rotate the slices along the Y-axis pivot at X = -2.0
            // Curvature kappa scales with strength. 
            // R (Radius of Curvature) = 2.0 / strength. 
            // This ensures at strength 1.0, the pivot is exactly at X = -2.0.
            float strength = -uParamC; 
            float R = 20.0 / strength;
            
            // Shift coordinates so the pivot is at the origin of this local polar space
            vec2 xz_shifted = vec2(p.x + R, p.z);
            float dist_to_pivot = length(xz_shifted);
            float angle_to_pivot = atan(xz_shifted.y, xz_shifted.x);
            
            // Inverse Transform: Map the curved ray back to the straight fractal stack
            // Local X is the radial distance from the pivot (offset back so center is 0)
            Z.x = dist_to_pivot - R;
            Z.y = p.y;
            
            // Local Z is the arc length along the curve
            z_val = angle_to_pivot * R;
            t = clamp((z_val / height) + 0.5, 0.0, 1.0);
        }

        // --- 2. INTERPOLATION ---
        vec2 c1 = uJulia.xy;
        vec2 c2 = vec2(uParamD, uParamE);
        float t_smooth = t * t * (3.0 - 2.0 * t);
        vec2 C = mix(c1, c2, t_smooth);

        // --- 3. 2D JULIA ITERATION ---
        float r2 = dot(Z,Z);
        float dz_2d = 1.0;
        float iter_count = 0.0;
        float smooth_iter = 0.0;
        
        float bailout = 10000.0; 
        int limit = int(uIterations);
        float localTrap = 1e10;
        
        bool escaped = false;
        
        // Local hard limit high enough for intricate sets
        const int MAX_FORMULA_ITER = 3000;

        for(int i=0; i<MAX_FORMULA_ITER; i++) {
            if (i >= limit) break;
            
            // Derivative: dz = 2*Z*dz
            dz_2d *= 2.0 * sqrt(r2);
            if (dz_2d > 1.0e10) dz_2d = 1.0e10;
            
            // Z = Z^2 + C
            float nx = (Z.x * Z.x - Z.y * Z.y) + C.x;
            float ny = (2.0 * Z.x * Z.y) + C.y;
            Z = vec2(nx, ny);
            
            r2 = dot(Z,Z);
            localTrap = min(localTrap, r2); 
            iter_count += 1.0;
            
            if(r2 > bailout) {
                escaped = true;
                break; 
            }
        }
        
        // --- 4. SMOOTH ITERATION ---
        if (escaped) {
            float logZn = log(r2) / 2.0;
            float nu = log(logZn / log(2.0)) / log(2.0);
            smooth_iter = iter_count + 1.0 - nu;
        } else {
            smooth_iter = iter_count;
        }

        // --- 5. DISTANCE ESTIMATION ---
        float d2d = 0.0;
        if (escaped && dz_2d > 1.0e-7) {
             d2d = 0.5 * sqrt(r2) * log(r2) / dz_2d;
        } else {
             d2d = 0.0;
        }
        
        // Vertical Box Bounds (using warped z_val)
        float d_z = abs(z_val) - (height * 0.5);
        
        // Combine: Intersection of Infinite Column + Height Box
        float d = max(d2d * 0.25, d_z);
        
        // --- 6. SLICING ---
        float sliceInterval = uParamF;
        if (sliceInterval > 0.01) {
            float ratio = clamp(uParamB, 0.01, 0.95);
            float thickness = (sliceInterval * 0.5) * ratio;
            float distToSlice = abs(mod(z_val, sliceInterval) - sliceInterval * 0.5) - thickness;
            d = max(d, distToSlice);
        }
        
        trap = min(trap, localTrap);
        
        // Return packed result
        z = vec4(Z.x, Z.y, d, smooth_iter);
    }`,loopBody:"formula_JuliaMorph(z, dr, trap, c); break;",getDist:`
            return vec2(z.z, z.w);
        `},parameters:[{label:"Height (Z Scale)",id:"paramA",min:.1,max:10,step:.1,default:5},{label:"Slice Thickness",id:"paramB",min:.01,max:1,step:.01,default:.27},{label:"Twist / Bend",id:"paramC",min:-5,max:5,step:.01,default:0,scale:"pi"},{label:"End C (Real)",id:"paramD",min:-2,max:2,step:.001,default:.286},{label:"End C (Imag)",id:"paramE",min:-2,max:2,step:.001,default:.009},{label:"Slice Interval",id:"paramF",min:0,max:2,step:.01,default:.33}],defaultPreset:{formula:"JuliaMorph",features:{coreMath:{iterations:100,paramA:5,paramB:.27,paramC:0,paramD:.286,paramE:.009,paramF:.53},geometry:{juliaMode:!0,juliaX:1.03,juliaY:-1.072,juliaZ:0},coloring:{mode:1,scale:4.697920323185873,offset:.13,repeats:1,phase:.13,bias:1,escape:4,gradient:[{id:"1",position:0,color:"#080022",bias:.5,interpolation:"linear"},{id:"2",position:.3,color:"#1C2058",bias:.5,interpolation:"linear"},{id:"3",position:.6,color:"#00ccff",bias:.5,interpolation:"linear"},{id:"4",position:.735261118203675,color:"#ffffff",bias:.5,interpolation:"linear"},{id:"1768818072358",position:1,color:"#090022",bias:.5,interpolation:"linear"}],mode2:0,scale2:.4003079069279198,offset2:.48021004308135196,repeats2:1,phase2:0,bias2:1,twist2:0,blendMode:2,blendOpacity:1,gradient2:[{id:"1768817090653_0",position:0,color:"#9e0142",bias:.5,interpolation:"linear"},{id:"1768817090653_1",position:.111,color:"#d53e4f",bias:.5,interpolation:"linear"},{id:"1768817090653_2",position:.222,color:"#f46d43",bias:.5,interpolation:"linear"},{id:"1768817090653_3",position:.333,color:"#fdae61",bias:.5,interpolation:"linear"},{id:"1768817090653_4",position:.444,color:"#fee08b",bias:.5,interpolation:"linear"},{id:"1768817090653_5",position:.556,color:"#e6f598",bias:.5,interpolation:"linear"},{id:"1768817090653_6",position:.667,color:"#abdda4",bias:.5,interpolation:"linear"},{id:"1768817090653_7",position:.778,color:"#66c2a5",bias:.5,interpolation:"linear"},{id:"1768817090653_8",position:.889,color:"#3288bd",bias:.5,interpolation:"linear"},{id:"1768817090653_9",position:1,color:"#5e4fa2",bias:.5,interpolation:"linear"}],layer3Color:"#ffffff",layer3Scale:2,layer3Strength:0,layer3Bump:0,layer3Turbulence:0},atmosphere:{fogNear:0,fogFar:5,fogColor:"#050510",fogDensity:.02,glowIntensity:0,glowSharpness:200,glowMode:!1,glowColor:"#ffffff",aoIntensity:0,aoSpread:.2,aoMode:!1},materials:{diffuse:1,reflection:0,specular:.61,roughness:.22438819237827662,rim:0,rimExponent:4,envStrength:0,envMapVisible:!1,envBackgroundStrength:1,envSource:1,useEnvMap:!1,envRotation:0,envGradientStops:[{id:"sky",position:0,color:"#000000",bias:.5,interpolation:"smooth"},{id:"hor",position:.5,color:"#223344",bias:.5,interpolation:"smooth"},{id:"zen",position:1,color:"#88ccff",bias:.5,interpolation:"smooth"}],emission:0,emissionMode:0,emissionColor:"#ffffff",ptEmissionMult:1},lighting:{shadows:!0,shadowSoftness:41.7859226170808,shadowIntensity:.92,shadowBias:.002,ptBounces:3,ptGIStrength:1,ptStochasticShadows:!1},quality:{fudgeFactor:1,detail:4,pixelThreshold:.5,maxSteps:300,distanceMetric:0},optics:{camType:0,camFov:60,orthoScale:2,dofStrength:0,dofFocus:10},navigation:{flySpeed:.42,autoSlow:!0}},cameraPos:{x:0,y:0,z:0},cameraRot:{x:.21740819322063967,y:.12483788618539499,z:-.11589452875015582,w:.9611023035551793},sceneOffset:{x:0,y:-1,z:4,xL:.10960732222484179,yL:-.26099943689461447,zL:.15599693750325688},targetDistance:2.512885481119156,cameraMode:"Fly",lights:[{type:"Point",position:{x:2.056650977487994,y:-.7418778505604411,z:3.39849758131238},rotation:{x:0,y:0,z:0},color:"#ffffff",intensity:8.76,falloff:0,falloffType:"Quadratic",fixed:!1,visible:!0,castShadow:!0},{type:"Point",position:{x:-.37117243582015064,y:-1.5852765971855902,z:3.0489919017830487},rotation:{x:0,y:0,z:0},color:"#ff8800",intensity:.5,falloff:0,falloffType:"Quadratic",fixed:!1,visible:!0,castShadow:!0},{type:"Point",position:{x:0,y:-5,z:2},rotation:{x:0,y:0,z:0},color:"#0088ff",intensity:.25,falloff:0,falloffType:"Quadratic",fixed:!1,visible:!1,castShadow:!0}]}},un={id:"Mandelorus",name:"Mandelorus",shortDescription:'The "True" 3D Mandelbrot topology. Wraps space around a ring instead of a point.',description:"Wraps the fractal iteration around a Torus (Donut). Creates a Solenoid structure. Twist is linked to Power: 1.0 Twist = 1 Symmetry Shift (360/Power).",shader:{function:`
        void formula_Mandelorus(inout vec4 z, inout float dr, inout float trap, vec4 c) {
            vec3 p = z.xyz;
            float R = uParamA;       // Major Radius
            float twistInput = uParamB;   // Twist Steps (1.0 = 1 Symmetry Unit)
            float power = uParamC;   // Fractal Power
            
            // PI transform removed (handled by UI injection now)
            float ringPhase = uParamD; 
            float crossPhase = uParamE; 
            
            float zScale = 1.0 + uParamF; // Vertical Scale
            
            // 1. Toroidal Decomposition
            float lenXY = length(p.xy);
            // phi: The angle around the major ring (0 to 2PI)
            float phi = atan(p.y, p.x); 
            
            // q: The cross-section complex plane relative to the ring center
            vec2 q = vec2(lenXY - R, p.z * zScale);
            
            // 2. Twist (Pre-iteration)
            // Rotates the cross-section as we travel around the ring.
            // We want 1.0 "Twist Input" to equal 1 "Symmetry Step".
            // A Symmetry Step is (2 * PI) / Power.
            // So Total Rotation should be: phi * (TwistInput / Power).
            if (abs(twistInput) > 0.001) {
                float rotAng = phi * twistInput / max(1.0, power);
                float s = sin(rotAng); 
                float co = cos(rotAng);
                q = mat2(co, -s, s, co) * q;
            }

            // 3. Complex Power (The Fiber Iteration)
            float r2 = dot(q, q);
            float r = sqrt(r2);
            float angleQ = atan(q.y, q.x);
            
            // Apply Cross Phase (Theta)
            angleQ += crossPhase;

            // --- STABILITY IMPROVEMENT ---
            // Calculate derivative with compensation for Twist and Z-Scale
            
            float dr_cross = power * pow(r, power - 1.0);
            
            // The effective expansion is the max of the Ring expansion (Power)
            // and the Cross-Section expansion (dr_cross).
            float expansion = max(power, dr_cross);
            
            // Pad derivative based on Z-Scale
            expansion *= max(1.0, zScale);
            
            // Pad derivative based on Twist intensity
            // High twist stretches space, requiring smaller steps
            expansion *= (1.0 + abs(twistInput) * 0.3);

            dr = dr * expansion + 1.0;
            
            // Apply Power to Cross Section
            float newR = pow(r, power);
            float newAngleQ = angleQ * power;
            q = newR * vec2(cos(newAngleQ), sin(newAngleQ));
            
            // 4. Solenoidal Wrapping (The Base Iteration)
            // phi -> n * phi + turn
            phi = phi * power + ringPhase;
            
            // 5. Reconstruction (Map back to 3D)
            vec2 ringPos = vec2(cos(phi), sin(phi));
            
            vec3 p_next;
            p_next.xy = ringPos * (R + q.x); // Expand ring by new q.x
            p_next.z = q.y; 
            
            // 6. Addition of C
            p_next += c.xyz;
            
            z.xyz = p_next;
            
            // Trap: Use cross-section magnitude
            trap = min(trap, r2);
        }`,loopBody:"formula_Mandelorus(z, dr, trap, c);"},parameters:[{label:"Ring Radius",id:"paramA",min:.1,max:5,step:.01,default:1},{label:"Twist (Sym)",id:"paramB",min:-8,max:8,step:.1,default:0},{label:"Power",id:"paramC",min:1,max:16,step:.01,default:8},{label:"Ring Phase",id:"paramD",min:-6.28,max:6.28,step:.01,default:0,scale:"pi"},{label:"Cross Phase",id:"paramE",min:-6.28,max:6.28,step:.01,default:0,scale:"pi"},{label:"Vert Scale",id:"paramF",min:-.9,max:2,step:.01,default:0}],defaultPreset:{version:2,name:"Mandelorus",formula:"Mandelorus",features:{coreMath:{iterations:31,paramA:1.32,paramB:0,paramC:5,paramD:0,paramE:-1.159203974648639,paramF:0},geometry:{applyTransformLogic:!0,preRotMaster:!0,hybridComplex:!1,burningEnabled:!1,hybridMode:!1,hybridIter:2,hybridFoldLimit:1,hybridScale:2,hybridMinR:.5,hybridFixedR:1,hybridAddC:!1,hybridProtect:!0,hybridSwap:!1,hybridSkip:1,preRotEnabled:!1,preRotY:0,preRotX:0,preRotZ:0,juliaMode:!1,juliaX:0,juliaY:0,juliaZ:0,preRot:{x:0,y:0,z:0},julia:{x:0,y:0,z:0}},lighting:{advancedLighting:!0,ptEnabled:!0,renderMode:0,ptBounces:3,ptGIStrength:1,shadowsCompile:!0,shadowAlgorithm:0,ptStochasticShadows:!1,shadows:!0,shadowIntensity:1,shadowSoftness:16,shadowSteps:128,shadowBias:.002,lights:[{type:"Directional",position:{x:1.8089856063656191,y:.769231473548869,z:-3.1565777253328235},rotation:{x:.08548818739394098,y:2.7391915549407027,z:.41340674852481984},color:"#ffffff",intensity:1.5,falloff:0,falloffType:"Quadratic",fixed:!1,visible:!0,castShadow:!0},{type:"Point",position:{x:2,y:-1,z:1},rotation:{x:0,y:0,z:0},color:"#ff8800",intensity:.5,falloff:0,falloffType:"Quadratic",fixed:!1,visible:!1,castShadow:!0},{type:"Point",position:{x:0,y:-5,z:2},rotation:{x:0,y:0,z:0},color:"#0088ff",intensity:.25,falloff:0,falloffType:"Quadratic",fixed:!0,visible:!1,castShadow:!0}]},ao:{aoIntensity:.3992177013734381,aoSpread:.12250592248526632,aoSamples:5,aoMode:!1,aoMaxSamples:32,aoStochasticCp:!0,aoEnabled:!0},reflections:{mixStrength:1,roughnessThreshold:.5,bounces:1,steps:64,enabled:!0},atmosphere:{glowEnabled:!0,glowQuality:0,fogIntensity:0,fogNear:0,fogFar:5,fogColor:"#000000",fogDensity:0,glowIntensity:.0013419894295067058,glowSharpness:13.803842646028853,glowMode:!0,glowColor:"#ff0000"},materials:{diffuse:1,reflection:0,specular:.3,roughness:.5,rim:0,rimExponent:4,envStrength:0,envBackgroundStrength:0,envSource:1,envMapData:null,envMapColorSpace:0,useEnvMap:!1,envRotation:0,envGradientStops:[{id:"sky",position:0,color:"#000000",bias:.5,interpolation:"smooth"},{id:"hor",position:.5,color:"#223344",bias:.5,interpolation:"smooth"},{id:"zen",position:1,color:"#88ccff",bias:.5,interpolation:"smooth"}],emission:.4,emissionMode:2,emissionColor:"#ffffff",ptEmissionMult:1},waterPlane:{waterEnabled:!1,active:!0,height:-2,color:"#001133",roughness:.02,waveStrength:.1,waveSpeed:1,waveFrequency:1.5},coloring:{gradient:{stops:[{id:"1771161402247_0",position:.07178750897343862,color:"#141414",bias:.5,interpolation:"linear"},{id:"1771161413328",position:.1225174070688263,color:"#F40000",bias:.5,interpolation:"linear"},{id:"1771161432807",position:.1627184120939519,color:"#FFA9A9",bias:.5,interpolation:"linear"},{id:"1771161412141",position:.2027890750198856,color:"#0D0D0D",bias:.5,interpolation:"linear"},{id:"1771161402247_1",position:.6090930507893446,color:"#ffffff",bias:.5,interpolation:"linear"},{id:"1771161445770",position:1,color:"#181818",bias:.5,interpolation:"linear"}],colorSpace:"srgb"},mode:0,scale:5,offset:.30000000000000004,repeats:1,phase:-.7,bias:1,twist:0,escape:4,gradient2:{stops:[{id:"1771161496387_0",position:0,color:"#000000",bias:.5,interpolation:"linear"},{id:"1771161496387_1",position:.07083040060795048,color:"#550000",bias:.5,interpolation:"linear"},{id:"1771161496387_2",position:.1627184120939519,color:"#FF2222",bias:.5,interpolation:"linear"},{id:"1771161496387_3",position:.2027890750198856,color:"#000000",bias:.5,interpolation:"linear"},{id:"1771161496387_4",position:.6090930507893446,color:"#000000",bias:.5,interpolation:"linear"},{id:"1771161496387_5",position:1,color:"#000000",bias:.5,interpolation:"linear"}],colorSpace:"srgb"},mode2:0,scale2:4.999999999999999,offset2:.30000000000000004,repeats2:1,phase2:-.7,bias2:1,twist2:0,blendMode:1,blendOpacity:1,layer3Color:"#ffffff",layer3Scale:2,layer3Strength:0,layer3Bump:0,layer3Turbulence:0},texturing:{active:!1,layer1Data:null,colorSpace:0,mapU:6,mapV:1,scaleX:1,scaleY:1,offset:{x:0,y:0},textureScale:{x:1,y:1}},quality:{engineQuality:!0,compilerHardCap:500,precisionMode:0,bufferPrecision:0,maxSteps:300,distanceMetric:0,estimator:0,fudgeFactor:.5,stepRelaxation:0,refinementSteps:0,detail:2,pixelThreshold:.5,overstepTolerance:0,dynamicScaling:!1,interactionDownsample:2},droste:{active:!1,tiling:1,center:{x:0,y:0},radiusInside:5,radiusOutside:100,periodicity:2,strands:2,autoPeriodicity:!1,strandMirror:!1,zoom:0,rotate:0,rotateSpin:0,rotatePolar:0,twist:!0,hyperDroste:!1,fractalPoints:1},colorGrading:{active:!1,saturation:1,levelsMin:0,levelsMax:1,levelsGamma:1},optics:{camType:0,camFov:60,orthoScale:2,dofStrength:0,dofFocus:10},navigation:{flySpeed:.5,autoSlow:!0},cameraManager:{},audio:{isEnabled:!1,smoothing:.8,threshold:.1,agcEnabled:!1,attack:.1,decay:.3,highPass:20,lowPass:2e4,gain:1},sonification:{isEnabled:!1,active:!0,baseFrequency:220,masterGain:.5,scanArea:.1,harmonics:!0,lastDimension:0},drawing:{activeTool:"rect",enabled:!1,active:!1,originMode:1,color:"#00ffff",lineWidth:1,showLabels:!0,showAxes:!1,shapes:[],refreshTrigger:0},modulation:{rules:[],selectedRuleId:null},webcam:{isEnabled:!1,opacity:1,posX:20,posY:80,width:320,height:240,cropL:0,cropR:0,cropT:0,cropB:0,blendMode:0,crtMode:!1,tilt:0,fontSize:12},debugTools:{shaderDebuggerOpen:!1,stateDebuggerOpen:!1},engineSettings:{showEngineTab:!1}},cameraPos:{x:0,y:0,z:0},cameraRot:{x:1,y:-727156800341211e-47,z:-6123233995736766e-32,w:3710962377975166e-33},sceneOffset:{x:.02015586569905281,y:.005605148617178202,z:-5.211455821990967,xL:5716822570889235e-25,yL:21298747235435714e-26,zL:-22618142203612024e-23},targetDistance:5.214554250240326,cameraMode:"Orbit",lights:[],renderMode:"Direct",quality:{aaMode:"Always",aaLevel:1,msaa:1,accumulation:!0},animations:[],sequence:{durationFrames:300,fps:30,tracks:{"camera.unified.x":{id:"camera.unified.x",type:"float",label:"Position X",keyframes:[{id:"520JCebpirpIjkgSfViyb",frame:0,value:-.05059101356107703,interpolation:"Linear",autoTangent:!1,brokenTangents:!1}],hidden:!1},"camera.unified.y":{id:"camera.unified.y",type:"float",label:"Position Y",keyframes:[{id:"TlKGVi6rVx8aPvZFWKlvw",frame:0,value:-.1358890818952094,interpolation:"Linear",autoTangent:!1,brokenTangents:!1}],hidden:!1},"camera.unified.z":{id:"camera.unified.z",type:"float",label:"Position Z",keyframes:[{id:"zcz_hIp4HhQTRZSagfckN",frame:0,value:-5.918975187098582,interpolation:"Linear",autoTangent:!1,brokenTangents:!1}],hidden:!1},"camera.rotation.x":{id:"camera.rotation.x",type:"float",label:"Rotation X",keyframes:[{id:"sLYXo677pGLgJlq19eoEQ",frame:0,value:3.141592653589793,interpolation:"Linear",autoTangent:!1,brokenTangents:!1}],hidden:!1},"camera.rotation.y":{id:"camera.rotation.y",type:"float",label:"Rotation Y",keyframes:[{id:"9Og7ZQx3kB_GSO0hjPEQs",frame:0,value:0,interpolation:"Linear",autoTangent:!1,brokenTangents:!1}],hidden:!1},"camera.rotation.z":{id:"camera.rotation.z",type:"float",label:"Rotation Z",keyframes:[{id:"sZtDA1yOQQpJIB1P6Nn7v",frame:0,value:0,interpolation:"Linear",autoTangent:!1,brokenTangents:!1}],hidden:!1}}},duration:300}},fn={id:"Appell",name:"Appell Spectral (Ghost)",shortDescription:'Based on Appell Polynomials and Clifford Analysis. Renders the "Hidden Skeleton" of 3D numbers.',description:'Implements the "Pseudo-Square" $P_2(x) = x^2 - k|x|^2$. This iteration destabilizes the surface, revealing a skeletal, interference-like structure. Best viewed as a volumetric cloud.',shader:{function:`
    void formula_Appell(inout vec4 z, inout float dr, inout float trap, vec4 c) {
        vec3 p = z.xyz;
        float r = length(p);
        
        // Param A: Interference Factor (k)
        // 0.333 is the theoretical "Euclidean" balance. 
        // Higher values strip the "flesh" off the fractal, leaving the skeleton.
        float k = uParamA;
        
        // Param B: Power (approximate)
        float power = uParamB;
        
        // Param C: Ghost Shift (4th Dimension Bias)
        // Adds a constant bias to the magnitude calculation, simulating a 4D slice.
        float bias = uParamC;
        
        // --- The Appell Polynomial Iteration ---
        
        // 1. Standard Hypercomplex Power
        // We use spherical conversion for generic power support
        float theta = acos(clamp(p.z / r, -1.0, 1.0));
        float phi = atan(p.y, p.x);
        
        // Apply rotation/twist
        phi += uParamE; 
        
        float zr = pow(r, power);
        theta *= power;
        phi *= power;
        
        vec3 p_hyper = zr * vec3(sin(theta) * cos(phi), sin(phi) * sin(theta), cos(theta));
        
        // 2. The Appell Subtraction
        // P_k(x) = x^k - k * |x|^2 ... (Simplified)
        // We subtract the magnitude squared from the Real component (X-axis in this projection)
        // This is the non-conformal "correction" that reveals the skeleton.
        
        float magSq = r*r + bias;
        p_hyper.x -= k * magSq;
        
        // 3. Update Derivative
        // The subtraction term makes the derivative complex. 
        // We approximate it: dr = power * r^(power-1) * dr - 2*k*r*dr
        // This creates "Fuzzy" boundaries automatically.
        dr = (power * pow(r, power - 1.0) - (2.0 * k * r)) * dr + 1.0;
        
        // 4. Param D: Fuzziness (Density Control)
        // Artificially reduces the derivative growth to create volumetric clouds
        if (uParamD > 0.0) {
            dr *= (1.0 - uParamD * 0.1);
        }
        
        z.xyz = p_hyper + c.xyz;
        
        trap = min(trap, r);
    }`,loopBody:"formula_Appell(z, dr, trap, c);"},parameters:[{label:"Interference",id:"paramA",min:0,max:1.5,step:.001,default:.333},{label:"Power",id:"paramB",min:1,max:8,step:.01,default:2},{label:"Ghost Shift",id:"paramC",min:-1,max:1,step:.001,default:0},{label:"Cloud Density",id:"paramD",min:0,max:1,step:.01,default:.5},{label:"Phase",id:"paramE",min:0,max:6.28,step:.01,default:0,scale:"pi"}],defaultPreset:{version:2,name:"Appell",formula:"Appell",features:{coreMath:{iterations:10,paramA:.761,paramB:2.83,paramC:-.391,paramD:.24,paramE:0,paramF:0},geometry:{applyTransformLogic:!0,preRotMaster:!0,hybridComplex:!1,burningEnabled:!1,hybridMode:!1,hybridIter:2,hybridFoldLimit:1,hybridScale:2,hybridMinR:.5,hybridFixedR:1,hybridAddC:!1,hybridProtect:!0,hybridSwap:!1,hybridSkip:1,preRotEnabled:!1,preRotY:0,preRotX:0,preRotZ:0,juliaMode:!1,juliaX:0,juliaY:0,juliaZ:0,preRot:{x:0,y:0,z:0},julia:{x:0,y:0,z:0}},lighting:{advancedLighting:!0,ptEnabled:!0,renderMode:0,ptBounces:3,ptGIStrength:1,shadowsCompile:!0,shadowAlgorithm:0,ptStochasticShadows:!1,shadows:!0,shadowIntensity:1,shadowSoftness:16,shadowSteps:128,shadowBias:.002,lights:[{type:"Point",position:{x:-2,y:1,z:2},rotation:{x:0,y:0,z:0},color:"#ffffff",intensity:1.5,falloff:0,falloffType:"Quadratic",fixed:!1,visible:!1,castShadow:!0},{type:"Point",position:{x:2,y:-1,z:1},rotation:{x:0,y:0,z:0},color:"#ff8800",intensity:.5,falloff:0,falloffType:"Quadratic",fixed:!1,visible:!1,castShadow:!0},{type:"Point",position:{x:0,y:-5,z:2},rotation:{x:0,y:0,z:0},color:"#0088ff",intensity:.25,falloff:0,falloffType:"Quadratic",fixed:!0,visible:!1,castShadow:!0}]},ao:{aoIntensity:0,aoSpread:.5,aoSamples:5,aoMode:!0,aoMaxSamples:32,aoStochasticCp:!0,aoEnabled:!0},reflections:{mixStrength:1,roughnessThreshold:.5,bounces:1,steps:64,enabled:!0},atmosphere:{glowEnabled:!0,glowQuality:0,fogIntensity:0,fogNear:0,fogFar:6,fogColor:"#000000",fogDensity:0,glowIntensity:4.999999999999999,glowSharpness:12.02264434617413,glowMode:!1,glowColor:"#00ffff"},materials:{diffuse:1.16,reflection:0,specular:0,roughness:.5872188659713031,rim:0,rimExponent:4,envStrength:0,envBackgroundStrength:0,envSource:1,envMapData:null,envMapColorSpace:0,useEnvMap:!1,envRotation:0,envGradientStops:[{id:"sky",position:0,color:"#000000",bias:.5,interpolation:"smooth"},{id:"hor",position:.5,color:"#223344",bias:.5,interpolation:"smooth"},{id:"zen",position:1,color:"#88ccff",bias:.5,interpolation:"smooth"}],emission:0,emissionMode:0,emissionColor:"#ffffff",ptEmissionMult:1},waterPlane:{waterEnabled:!1,active:!0,height:-2,color:"#001133",roughness:.02,waveStrength:.1,waveSpeed:1,waveFrequency:1.5},coloring:{gradient:{stops:[{id:"5",position:.006101938262742301,color:"#000000",bias:.5,interpolation:"linear"},{id:"4",position:.07666905958363249,color:"#5744FF",bias:.5,interpolation:"linear"},{id:"3",position:.2198492462311558,color:"#0088ff",bias:.5,interpolation:"linear"},{id:"2",position:.3802584350323044,color:"#001133",bias:.5,interpolation:"linear"},{id:"1",position:.46518305814788224,color:"#000000",bias:.5,interpolation:"linear"},{id:"1771161963853_0",position:.5402010050251256,color:"#000000",bias:.5,interpolation:"linear"},{id:"1771161963853_1",position:.6,color:"#001133",bias:.5,interpolation:"linear"},{id:"1771161963853_2",position:.75,color:"#0088ff",bias:.5,interpolation:"linear"},{id:"1771161963853_3",position:.9,color:"#F644FF",bias:.5,interpolation:"linear"},{id:"1771161963853_4",position:1,color:"#000000",bias:.5,interpolation:"linear"}],colorSpace:"srgb"},mode:8,scale:.5557213101593343,offset:.05468077546160833,repeats:1.2,phase:0,bias:1,twist:0,escape:4,gradient2:[{id:"1",position:0,color:"#000000"},{id:"2",position:1,color:"#ffffff"}],mode2:4,scale2:1,offset2:0,repeats2:1,phase2:0,bias2:1,twist2:0,blendMode:0,blendOpacity:0,layer3Color:"#ffffff",layer3Scale:2,layer3Strength:0,layer3Bump:0,layer3Turbulence:0},texturing:{active:!1,layer1Data:null,colorSpace:0,mapU:6,mapV:1,scaleX:1,scaleY:1,offset:{x:0,y:0},textureScale:{x:1,y:1}},quality:{engineQuality:!0,compilerHardCap:500,precisionMode:0,bufferPrecision:0,maxSteps:300,distanceMetric:0,estimator:0,fudgeFactor:.01,stepRelaxation:0,refinementSteps:0,detail:3.1,pixelThreshold:1,overstepTolerance:0,dynamicScaling:!1,interactionDownsample:2},droste:{active:!1,tiling:1,center:{x:0,y:0},radiusInside:5,radiusOutside:100,periodicity:2,strands:2,autoPeriodicity:!1,strandMirror:!1,zoom:0,rotate:0,rotateSpin:0,rotatePolar:0,twist:!0,hyperDroste:!1,fractalPoints:1},colorGrading:{active:!1,saturation:1,levelsMin:0,levelsMax:1,levelsGamma:1},optics:{camType:0,camFov:60,orthoScale:2,dofStrength:0,dofFocus:10},navigation:{flySpeed:.5,autoSlow:!0},cameraManager:{},audio:{isEnabled:!1,smoothing:.8,threshold:.1,agcEnabled:!1,attack:.1,decay:.3,highPass:20,lowPass:2e4,gain:1},sonification:{isEnabled:!1,active:!0,baseFrequency:220,masterGain:.5,scanArea:.1,harmonics:!0,lastDimension:0},drawing:{activeTool:"rect",enabled:!1,active:!1,originMode:1,color:"#00ffff",lineWidth:1,showLabels:!0,showAxes:!1,shapes:[],refreshTrigger:0},modulation:{rules:[],selectedRuleId:null},webcam:{isEnabled:!1,opacity:1,posX:20,posY:80,width:320,height:240,cropL:0,cropR:0,cropT:0,cropB:0,blendMode:0,crtMode:!1,tilt:0,fontSize:12},debugTools:{shaderDebuggerOpen:!1,stateDebuggerOpen:!1},engineSettings:{showEngineTab:!1}},cameraPos:{x:0,y:0,z:0},cameraRot:{x:.6190587983598513,y:.40078133786953346,z:-.5821092438548545,w:.3424753299253732},sceneOffset:{x:-.3737236559391022,y:-1.5770468711853027,z:-.1308211237192154,xL:-.060257730662381714,yL:.02761814157420639,zL:.002646650329445943},targetDistance:1.0691482573747906,cameraMode:"Orbit",lights:[],renderMode:"Direct",quality:{aaMode:"Always",aaLevel:1,msaa:1,accumulation:!0},animations:[],sequence:{durationFrames:300,fps:30,tracks:{}},duration:300}},pn={id:"Borromean",name:"Borromean (Cyclic)",shortDescription:"Three interlocking Complex Planes. Uses dimensional feedback loops instead of spherical math.",description:'Treats 3D space as three coupled 2D planes (XY, YZ, ZX). The output of one plane becomes the input of the next, creating a "Rock-Paper-Scissors" feedback loop. Produces tetrahedral symmetries and solid, non-spherical shapes.',shader:{function:`
    void formula_Borromean(inout vec4 z, inout float dr, inout float trap, vec4 c) {
        vec3 p = z.xyz;
        
        // Param A: Power
        float power = uParamA;
        
        // Param E: Phase Shift (Rotation per iteration)
        float phase = uParamE;
        if (abs(phase) > 0.001) {
            float s = sin(phase); 
            float co = cos(phase);
            p.xy = mat2(co, -s, s, co) * p.xy;
        }

        // Derivative for generalized power
        float r = length(p);
        dr = power * pow(r, power - 1.0) * dr + 1.0;
        
        // Generalized Power Terms
        float xP = pow(abs(p.x), power);
        float yP = pow(abs(p.y), power);
        float zP = pow(abs(p.z), power);
        
        // Param B: Connection (The Link Strength)
        float connect = uParamB;
        
        // Param C: Repulsion (The Subtractive Force)
        float repel = uParamC;
        
        // Param D: Balance (Mixing Force)
        float balance = uParamD;
        
        // Param F: Invert (Sign Flip)
        float invert = uParamF;
        
        // The Cyclic Permutation
        // X driven by Z
        // Y driven by X
        // Z driven by Y
        
        float nx = (xP - repel * yP - balance * zP) + (invert * connect * 2.0 * p.z * p.x);
        float ny = (yP - repel * zP - balance * xP) + (invert * connect * 2.0 * p.x * p.y);
        float nz = (zP - repel * xP - balance * yP) + (invert * connect * 2.0 * p.y * p.z);
        
        z.xyz = vec3(nx, ny, nz) + c.xyz;
        
        trap = min(trap, dot(z.xyz, z.xyz));
    }`,loopBody:"formula_Borromean(z, dr, trap, c);"},parameters:[{label:"Power",id:"paramA",min:1,max:5,step:.01,default:2},{label:"Connection",id:"paramB",min:0,max:3,step:.01,default:1},{label:"Repulsion",id:"paramC",min:0,max:3,step:.01,default:1},{label:"Balance",id:"paramD",min:0,max:2,step:.01,default:0},{label:"Phase",id:"paramE",min:-3.14,max:3.14,step:.01,default:0,scale:"pi"},{label:"Invert",id:"paramF",min:-1,max:1,step:2,default:1}],defaultPreset:{version:1,name:"Borromean",formula:"Borromean",features:{coreMath:{iterations:28,paramA:2.25,paramB:1.04,paramC:.92,paramD:0,paramE:0,paramF:1},geometry:{applyTransformLogic:!0,preRotMaster:!0,hybridComplex:!1,burningEnabled:!1,hybridMode:!1,hybridIter:2,hybridFoldLimit:1,hybridScale:2,hybridMinR:.5,hybridFixedR:1,hybridAddC:!1,hybridProtect:!0,hybridSwap:!1,hybridSkip:1,preRotEnabled:!1,preRotY:0,preRotX:0,preRotZ:0,juliaMode:!1,juliaX:0,juliaY:0,juliaZ:0,preRot:{x:0,y:0,z:0},julia:{x:0,y:0,z:0}},lighting:{advancedLighting:!0,ptEnabled:!0,renderMode:0,ptBounces:3,ptGIStrength:1,shadowsCompile:!0,shadowAlgorithm:0,ptStochasticShadows:!1,shadows:!0,shadowIntensity:.82,shadowSoftness:8,shadowSteps:128,shadowBias:.002,lights:[{type:"Directional",position:{x:-1.9999999999999998,y:1,z:2},rotation:{x:-1.3618058113303921,y:2.6135019110558524,z:-2.4974118716462748},color:"#ffffff",intensity:2.8224,falloff:0,falloffType:"Quadratic",fixed:!1,visible:!0,castShadow:!0},{type:"Point",position:{x:2,y:-1,z:1},rotation:{x:0,y:0,z:0},color:"#ff8800",intensity:.5,falloff:0,falloffType:"Quadratic",fixed:!1,visible:!1,castShadow:!0},{type:"Point",position:{x:0,y:-5,z:2},rotation:{x:0,y:0,z:0},color:"#0088ff",intensity:.25,falloff:0,falloffType:"Quadratic",fixed:!0,visible:!1,castShadow:!0}]},ao:{aoIntensity:.36219236319294446,aoSpread:.010521796258218545,aoSamples:22,aoMode:!0,aoMaxSamples:32,aoStochasticCp:!0,aoEnabled:!0},reflections:{mixStrength:1,roughnessThreshold:.5,bounces:1,steps:64,enabled:!0},atmosphere:{glowEnabled:!0,glowQuality:0,fogIntensity:0,fogNear:0,fogFar:5,fogColor:"#000000",fogDensity:0,glowIntensity:.064445198559225,glowSharpness:1.8620871366628675,glowMode:!1,glowColor:"#ffffff"},materials:{diffuse:1.92,reflection:0,specular:1.52,roughness:.23035625001175353,rim:0,rimExponent:4,envStrength:0,envBackgroundStrength:0,envSource:1,envMapData:null,envMapColorSpace:0,useEnvMap:!1,envRotation:0,envGradientStops:[{id:"sky",position:0,color:"#000000",bias:.5,interpolation:"smooth"},{id:"hor",position:.5,color:"#223344",bias:.5,interpolation:"smooth"},{id:"zen",position:1,color:"#88ccff",bias:.5,interpolation:"smooth"}],emission:0,emissionMode:0,emissionColor:"#ffffff",ptEmissionMult:1},waterPlane:{waterEnabled:!1,active:!0,height:-2,color:"#001133",roughness:.02,waveStrength:.1,waveSpeed:1,waveFrequency:1.5},coloring:{gradient:{stops:[{id:"1771160459074_0",position:0,color:"#5F4690",bias:.5,interpolation:"linear"},{id:"1771160459074_1",position:.091,color:"#1D6996",bias:.5,interpolation:"linear"},{id:"1771160459074_2",position:.182,color:"#38A6A5",bias:.5,interpolation:"linear"},{id:"1771160459074_3",position:.273,color:"#0F8554",bias:.5,interpolation:"linear"},{id:"1771160459074_4",position:.364,color:"#73AF48",bias:.5,interpolation:"linear"},{id:"1771160459074_5",position:.455,color:"#EDAD08",bias:.5,interpolation:"linear"},{id:"1771160459074_6",position:.545,color:"#E17C05",bias:.5,interpolation:"linear"},{id:"1771160459074_7",position:.636,color:"#CC503E",bias:.5,interpolation:"linear"},{id:"1771160459074_8",position:.727,color:"#94346E",bias:.5,interpolation:"linear"},{id:"1771160459074_9",position:.818,color:"#6F4070",bias:.5,interpolation:"linear"},{id:"1771160459074_10",position:.909,color:"#994E95",bias:.5,interpolation:"linear"},{id:"1771160459074_11",position:1,color:"#666666",bias:.5,interpolation:"linear"}],colorSpace:"linear"},mode:1,scale:2.2754446706935223,offset:-.07388697269814448,repeats:2,phase:0,bias:1,twist:0,escape:4,gradient2:[{id:"1",position:0,color:"#000000"},{id:"2",position:1,color:"#ffffff"}],mode2:4,scale2:1,offset2:0,repeats2:1,phase2:0,bias2:1,twist2:0,blendMode:0,blendOpacity:0,layer3Color:"#ffffff",layer3Scale:2,layer3Strength:0,layer3Bump:0,layer3Turbulence:0},texturing:{active:!1,layer1Data:null,colorSpace:0,mapU:6,mapV:1,scaleX:1,scaleY:1,offset:{x:0,y:0},textureScale:{x:1,y:1}},quality:{engineQuality:!0,compilerHardCap:500,precisionMode:0,bufferPrecision:0,maxSteps:300,distanceMetric:0,estimator:0,fudgeFactor:.5,stepRelaxation:0,refinementSteps:0,detail:2,pixelThreshold:.5,overstepTolerance:0,dynamicScaling:!1,interactionDownsample:2},droste:{active:!1,tiling:1,center:{x:0,y:0},radiusInside:5,radiusOutside:100,periodicity:2,strands:2,autoPeriodicity:!1,strandMirror:!1,zoom:0,rotate:0,rotateSpin:0,rotatePolar:0,twist:!0,hyperDroste:!1,fractalPoints:1},colorGrading:{active:!1,saturation:1,levelsMin:0,levelsMax:1,levelsGamma:1},optics:{camType:0,camFov:60,orthoScale:2,dofStrength:0,dofFocus:10},navigation:{flySpeed:.5,autoSlow:!0},cameraManager:{},audio:{isEnabled:!1,smoothing:.8,threshold:.1,agcEnabled:!1,attack:.1,decay:.3,highPass:20,lowPass:2e4,gain:1},sonification:{isEnabled:!1,active:!0,baseFrequency:220,masterGain:.5,scanArea:.1,harmonics:!0,lastDimension:0},drawing:{activeTool:"rect",enabled:!1,active:!1,originMode:1,color:"#00ffff",lineWidth:1,showLabels:!0,showAxes:!1,shapes:[],refreshTrigger:0},modulation:{rules:[],selectedRuleId:null},webcam:{isEnabled:!1,opacity:1,posX:20,posY:80,width:320,height:240,cropL:0,cropR:0,cropT:0,cropB:0,blendMode:0,crtMode:!1,tilt:0,fontSize:12},debugTools:{shaderDebuggerOpen:!1,stateDebuggerOpen:!1},engineSettings:{showEngineTab:!1}},cameraPos:{x:0,y:0,z:0},cameraRot:{x:-.2938195179022356,y:.33371368466206736,z:.11030705445694247,w:.8888968563933598},sceneOffset:{x:1.540531039237976,y:1.1154367923736572,z:1.807411551475525,xL:-.31978609027941085,yL:.2396308322743712,zL:-.23608000053467415},targetDistance:2.0720281302928925,cameraMode:"Orbit",lights:[],renderMode:"Direct",quality:{aaMode:"Always",aaLevel:1,msaa:1,accumulation:!0},animations:[],sequence:{durationFrames:300,fps:30,tracks:{}},duration:300}},hn={id:"MandelMap",name:"MandelMap (Unrolled)",shortDescription:"Unrolls the Mandelbulb surface. Features Sphere, Cylinder, and Torus projections.",description:'Maps the Mandelbulb 3D structure onto a 2D plane. Use "Projection" (Param D) to switch between Spherical (Standard), Cylindrical (Infinite Vertical), and Toroidal (Seamless) mappings.',shader:{function:`
    vec3 planeToBulb(vec3 p, float scale, float heightAmp, float thetaOffset, float phiOffset, float mode) {
        // --- 1. COORDINATE PREP ---
        // Apply Map Scaling & Phase Compensation first
        // This effectively "Slides" the map texture to counter-act the fractal rotation
        float u = p.x * scale - phiOffset;
        float v = p.z * scale - thetaOffset;
        
        // Height (Radius base)
        // Base radius 1.1 puts Y=0 slightly outside the unit bulb surface
        float r = 1.1 + (p.y / max(0.01, heightAmp));
        
        // --- 2. PROJECTION MAPPING ---
        
        if (mode < 0.5) {
            // MODE 0: SPHERICAL (Mercator)
            // Classic mapping. Distorts at poles (high Z).
            // u -> Longitude (Phi), v -> Latitude (Theta)
            
            float theta = v + 1.570796; // Center at equator
            float phi = u;
            
            return r * vec3(sin(theta) * cos(phi), sin(theta) * sin(phi), cos(theta));
        } 
        else if (mode < 1.5) {
            // MODE 1: CYLINDRICAL
            // Unwraps to an infinite vertical column. No polar distortion.
            // u -> Angle (Phi), v -> Height (Y), r -> Radius
            
            float phi = u;
            float height = v;
            
            // X/Z form the circle, Y is height
            return vec3(r * cos(phi), height, r * sin(phi));
        } 
        else {
            // MODE 2: TOROIDAL
            // Wraps around a donut. Seamless tiling in all directions.
            // u -> Major Angle, v -> Minor Angle
            
            float majorR = 2.0; // Radius of the donut hole
            
            // Torus formula:
            // X = (R + r*cos(v)) * cos(u)
            // Y = (R + r*cos(v)) * sin(u)
            // Z = r * sin(v)
            // We use 'r' (height) as the minor radius scaler
            
            float minorR = r; 
            
            return vec3(
                (majorR + minorR * cos(v)) * cos(u),
                minorR * sin(v),
                (majorR + minorR * cos(v)) * sin(u)
            );
        }
    }

    void formula_MandelMap(inout vec4 z, inout float dr, inout float trap, inout vec4 c) {
        float power = uParamA;
        float thetaPhase = uParamE;
        float phiPhase = uParamF;

        // Run transform only on the first iteration
        if (dr == 1.0) {
            float heightAmp = uParamB;
            float mapScale = uParamC;
            float projMode = uParamD;
            
            // --- Coordinate Compensation Logic ---
            // Symmetry Shift = Phase / (Power - 1.0)
            // This locks the visual features in place while they mutate
            float divisor = max(1.0, power - 1.0);
            float thetaOffset = thetaPhase / divisor;
            float phiOffset = phiPhase / divisor;
            
            vec3 w = planeToBulb(z.xyz, mapScale, heightAmp, thetaOffset, phiOffset, projMode);
            
            // --- Lipschitz Correction ---
            // Estimate expansion factor to correct Distance Estimation
            float r = length(w);
            float verticalScale = 1.0 / max(0.01, heightAmp);
            float horizontalScale = r * mapScale;
            float stretch = max(verticalScale, horizontalScale);
            
            dr *= max(1.0, stretch);
            
            z.xyz = w;
            
            if (uJuliaMode < 0.5) {
                c.xyz = w;
            }
        }

        // Standard Mandelbulb Iteration
        vec3 p = z.xyz;
        float r = length(p);
        
        if (r > 1.0e-4) {
            dr = pow(r, power - 1.0) * power * dr + 1.0;
            
            float theta = acos(clamp(p.z / r, -1.0, 1.0));
            float phi = atan(p.y, p.x);
            
            float zr = pow(r, power);
            
            // Apply Phase Shifts
            theta = theta * power + thetaPhase;
            phi = phi * power + phiPhase;
            
            p = zr * vec3(sin(theta)*cos(phi), sin(theta)*sin(phi), cos(theta));
        }
        
        p += c.xyz;
        
        z.xyz = p;
        trap = min(trap, length(p));
    }`,loopBody:"formula_MandelMap(z, dr, trap, c);"},parameters:[{label:"Power",id:"paramA",min:2,max:16,step:.01,default:8},{label:"Height Amp",id:"paramB",min:.1,max:10,step:.1,default:2},{label:"Map Scale",id:"paramC",min:.1,max:5,step:.01,default:1},{label:"Projection",id:"paramD",min:0,max:2,step:1,default:1,options:[{label:"Spherical",value:0},{label:"Cylindrical",value:1},{label:"Toroidal",value:2}]},{label:"Theta Phase",id:"paramE",min:-3.14,max:3.14,step:.01,default:0,scale:"pi"},{label:"Phi Phase",id:"paramF",min:-6.28,max:6.28,step:.01,default:0,scale:"pi"}],defaultPreset:{version:1,name:"MandelMap",formula:"MandelMap",features:{coreMath:{iterations:11,paramA:4,paramB:1.61,paramC:1,paramD:0,paramE:0,paramF:0},geometry:{applyTransformLogic:!0,preRotMaster:!0,hybridComplex:!1,burningEnabled:!1,hybridMode:!1,hybridIter:2,hybridFoldLimit:1,hybridScale:2,hybridMinR:.5,hybridFixedR:1,hybridAddC:!1,hybridProtect:!0,hybridSwap:!1,hybridSkip:1,preRotEnabled:!1,preRotY:0,preRotX:0,preRotZ:0,juliaMode:!1,juliaX:0,juliaY:0,juliaZ:0,preRot:{x:0,y:0,z:0},julia:{x:0,y:0,z:0}},lighting:{advancedLighting:!0,ptEnabled:!0,renderMode:0,ptBounces:3,ptGIStrength:1,shadowsCompile:!0,shadowAlgorithm:0,ptStochasticShadows:!1,shadows:!0,shadowIntensity:1,shadowSoftness:33.96487304923489,shadowSteps:304,shadowBias:0,lights:[{type:"Directional",position:{x:-2,y:1,z:2},rotation:{x:-1.2945477312837892,y:3.0961684975756443,z:-3.0815085191809364},color:"#ffffff",intensity:6.969599999999999,falloff:0,falloffType:"Quadratic",fixed:!1,visible:!0,castShadow:!0},{type:"Point",position:{x:2,y:-1,z:1},rotation:{x:0,y:0,z:0},color:"#ff8800",intensity:.5,falloff:0,falloffType:"Quadratic",fixed:!1,visible:!1,castShadow:!0},{type:"Point",position:{x:0,y:-5,z:2},rotation:{x:0,y:0,z:0},color:"#0088ff",intensity:.25,falloff:0,falloffType:"Quadratic",fixed:!0,visible:!1,castShadow:!0}]},ao:{aoIntensity:.7102583030181524,aoSpread:.02075305004726551,aoSamples:5,aoMode:!0,aoMaxSamples:32,aoStochasticCp:!0,aoEnabled:!0},reflections:{mixStrength:1,roughnessThreshold:.5,bounces:1,steps:64,enabled:!0},atmosphere:{glowEnabled:!0,glowQuality:0,fogIntensity:.66,fogNear:3.3177600000000007,fogFar:14.5,fogColor:"#7f6969",fogDensity:0,glowIntensity:0,glowSharpness:11.220184543019629,glowMode:!1,glowColor:"#ffffff"},materials:{diffuse:2,reflection:0,specular:0,roughness:.5,rim:0,rimExponent:4,envStrength:.75,envBackgroundStrength:0,envSource:1,envMapData:null,envMapColorSpace:0,useEnvMap:!1,envRotation:0,envGradientStops:[{id:"sky",position:0,color:"#000000",bias:.5,interpolation:"smooth"},{id:"hor",position:.5,color:"#223344",bias:.5,interpolation:"smooth"},{id:"zen",position:1,color:"#88ccff",bias:.5,interpolation:"smooth"}],emission:0,emissionMode:0,emissionColor:"#ffffff",ptEmissionMult:1},waterPlane:{waterEnabled:!1,active:!0,height:-2,color:"#001133",roughness:.02,waveStrength:.1,waveSpeed:1,waveFrequency:1.5},coloring:{gradient:{stops:[{id:"1771159172325_0",position:0,color:"#009392",bias:.5,interpolation:"linear"},{id:"1771159172325_1",position:.167,color:"#39b185",bias:.5,interpolation:"linear"},{id:"1771159172325_2",position:.333,color:"#9ccb86",bias:.5,interpolation:"linear"},{id:"1771159172325_3",position:.5,color:"#e9e29c",bias:.5,interpolation:"linear"},{id:"1771159172325_4",position:.667,color:"#eeb479",bias:.5,interpolation:"linear"},{id:"1771159172325_5",position:.833,color:"#e88471",bias:.5,interpolation:"linear"},{id:"1771159172325_6",position:1,color:"#cf597e",bias:.5,interpolation:"linear"}],colorSpace:"linear"},mode:1,scale:3.1065735566446993,offset:.20712783526166173,repeats:1,phase:0,bias:.5963552876944301,twist:0,escape:4,gradient2:[{id:"1",position:0,color:"#000000"},{id:"2",position:1,color:"#ffffff"}],mode2:4,scale2:1,offset2:0,repeats2:1,phase2:0,bias2:1,twist2:0,blendMode:0,blendOpacity:0,layer3Color:"#ffffff",layer3Scale:2,layer3Strength:0,layer3Bump:0,layer3Turbulence:0},texturing:{active:!1,layer1Data:null,colorSpace:0,mapU:6,mapV:1,scaleX:1,scaleY:1,offset:{x:0,y:0},textureScale:{x:1,y:1}},quality:{engineQuality:!0,compilerHardCap:500,precisionMode:0,bufferPrecision:0,maxSteps:300,distanceMetric:0,estimator:0,fudgeFactor:1,stepRelaxation:0,refinementSteps:0,detail:2,pixelThreshold:.5,overstepTolerance:0,dynamicScaling:!1,interactionDownsample:2},droste:{active:!1,tiling:1,center:{x:0,y:0},radiusInside:5,radiusOutside:100,periodicity:2,strands:2,autoPeriodicity:!1,strandMirror:!1,zoom:0,rotate:0,rotateSpin:0,rotatePolar:0,twist:!0,hyperDroste:!1,fractalPoints:1},colorGrading:{active:!1,saturation:1,levelsMin:0,levelsMax:1,levelsGamma:1},optics:{camType:0,camFov:60,orthoScale:2,dofStrength:0,dofFocus:10},navigation:{flySpeed:.5,autoSlow:!0},cameraManager:{},audio:{isEnabled:!1,smoothing:.8,threshold:.1,agcEnabled:!1,attack:.1,decay:.3,highPass:20,lowPass:2e4,gain:1},sonification:{isEnabled:!1,active:!0,baseFrequency:220,masterGain:.5,scanArea:.1,harmonics:!0,lastDimension:0},drawing:{activeTool:"rect",enabled:!1,active:!1,originMode:1,color:"#00ffff",lineWidth:1,showLabels:!0,showAxes:!1,shapes:[],refreshTrigger:0},modulation:{rules:[],selectedRuleId:null},webcam:{isEnabled:!1,opacity:1,posX:20,posY:80,width:320,height:240,cropL:0,cropR:0,cropT:0,cropB:0,blendMode:0,crtMode:!1,tilt:0,fontSize:12},debugTools:{shaderDebuggerOpen:!1,stateDebuggerOpen:!1},engineSettings:{showEngineTab:!1}},cameraPos:{x:0,y:0,z:0},cameraRot:{x:-.40127164816286187,y:8701571167029472e-23,z:2710286594285787e-22,w:.9159590953642958},sceneOffset:{x:0,y:4,z:5,xL:-.00800157869605831,yL:-.1778496246363903,zL:-.24803174116677118},targetDistance:4.905199170112612,cameraMode:"Orbit",lights:[],renderMode:"Direct",quality:{aaMode:"Always",aaLevel:1,msaa:1,accumulation:!0},animations:[],sequence:{durationFrames:300,fps:30,tracks:{}},duration:300}},al=[$r,un,Zr,hn,pn,fn,Gr,Qr,Wr,cn,qr,Kr,ln,Hr,Ur,Xr,Yr,dn,sn,Vr,rn,Jr,en,tn,an,on,nn];al.forEach(a=>Le.register(a));Le.registerAlias("UberMenger","MengerAdvanced");Le.registerAlias("FoldingBrot","BoxBulb");Le.registerAlias("HyperTorus","Mandelorus");const ol=[{name:"Featured Fractals",match:[$r.id,un.id,Zr.id,Gr.id,Qr.id,Wr.id,qr.id,Kr.id,ln.id]},{name:"Geometric & Folding",match:[cn.id,Xr.id,Yr.id,en.id,Jr.id]},{name:"Hybrids & Experiments",match:[hn.id,pn.id,fn.id,dn.id,sn.id,Vr.id,rn.id,tn.id,an.id,on.id,Hr.id,Ur.id]},{name:"Systems",match:[nn.id]}],rl=(a,t)=>({isPlaying:!1,isRecording:!1,isScrubbing:!1,recordCamera:!0,isCameraInteracting:!1,currentFrame:0,fps:30,durationFrames:300,zoomLevel:1,loopMode:"Loop",isArmingModulation:!1,isRecordingModulation:!1,recordingSnapshot:null,play:()=>{const o=t();if(o.currentFrame>=o.durationFrames-.1&&a({currentFrame:0}),o.isArmingModulation){o.snapshot();const r=JSON.parse(JSON.stringify(o.sequence));a({isRecordingModulation:!0,isArmingModulation:!1,recordingSnapshot:r,isPlaying:!0,currentFrame:0})}else a({isPlaying:!0})},pause:()=>a({isPlaying:!1,isRecordingModulation:!1,recordingSnapshot:null}),stop:()=>a({isPlaying:!1,currentFrame:0,isRecordingModulation:!1,recordingSnapshot:null}),toggleRecording:()=>a(o=>({isRecording:!o.isRecording})),toggleRecordCamera:()=>a(o=>({recordCamera:!o.recordCamera})),toggleArmModulation:()=>a(o=>({isArmingModulation:!o.isArmingModulation,isRecording:!1})),stopModulationRecording:()=>a({isRecordingModulation:!1,isPlaying:!1,recordingSnapshot:null}),setLoopMode:o=>a({loopMode:o}),setIsScrubbing:o=>a({isScrubbing:o}),setIsCameraInteracting:o=>a({isCameraInteracting:o}),seek:o=>a({currentFrame:Math.max(0,Math.min(t().durationFrames,o))}),setDuration:o=>{a({durationFrames:o})},setFps:o=>{a({fps:o})}}),nl=(a,t)=>({selectedTrackIds:[],selectedKeyframeIds:[],softSelectionRadius:0,softSelectionEnabled:!1,softSelectionType:"S-Curve",bounceTension:.5,bounceFriction:.6,selectTrack:(o,r)=>a(n=>({selectedTrackIds:r?n.selectedTrackIds.includes(o)?n.selectedTrackIds.filter(i=>i!==o):[...n.selectedTrackIds,o]:[o]})),selectTracks:(o,r)=>a(n=>{const i=new Set(n.selectedTrackIds);return r?o.forEach(s=>i.add(s)):o.forEach(s=>i.delete(s)),{selectedTrackIds:Array.from(i)}}),selectKeyframe:(o,r,n)=>a(i=>{const s=`${o}::${r}`;return{selectedKeyframeIds:n?i.selectedKeyframeIds.includes(s)?i.selectedKeyframeIds.filter(l=>l!==s):[...i.selectedKeyframeIds,s]:[s]}}),selectKeyframes:(o,r)=>a(n=>({selectedKeyframeIds:r?Array.from(new Set([...n.selectedKeyframeIds,...o])):o})),deselectAll:()=>a({selectedTrackIds:[],selectedKeyframeIds:[]}),deselectAllKeys:()=>a({selectedKeyframeIds:[]}),setSoftSelection:(o,r)=>a({softSelectionRadius:o,softSelectionEnabled:r}),setSoftSelectionType:o=>a({softSelectionType:o}),setBouncePhysics:(o,r)=>a({bounceTension:o,bounceFriction:r})}),ot={getUnifiedPosition:(a,t)=>new ie(t.x+t.xL+a.x,t.y+t.yL+a.y,t.z+t.zL+a.z),getUnifiedFromEngine:()=>B.activeCamera?ot.getUnifiedPosition(B.activeCamera.position,B.sceneOffset):new ie,getRotationFromEngine:()=>B.activeCamera?B.activeCamera.quaternion.clone():new Be,getDistanceFromEngine:()=>{if(B.activeCamera){const a=B.activeCamera.position.length();if(a>.001)return a}return null},getRotationDegrees:a=>{const t=new Be(a.x,a.y,a.z,a.w),o=new qe().setFromQuaternion(t);return new ie(Ze.radToDeg(o.x),Ze.radToDeg(o.y),Ze.radToDeg(o.z))},teleportPosition:(a,t,o)=>{const r=Ae.split(a.x),n=Ae.split(a.y),i=Ae.split(a.z),s={position:{x:0,y:0,z:0},sceneOffset:{x:r.high,y:n.high,z:i.high,xL:r.low,yL:n.low,zL:i.low}};if(t)s.rotation=t;else if(B.activeCamera){const l=B.activeCamera.quaternion;s.rotation={x:l.x,y:l.y,z:l.z,w:l.w}}o!==void 0&&(s.targetDistance=o),le.emit(Fe.CAMERA_TELEPORT,s)},teleportRotation:a=>{if(isNaN(a.x)||isNaN(a.y)||isNaN(a.z))return;const t=new qe(Ze.degToRad(a.x),Ze.degToRad(a.y),Ze.degToRad(a.z)),o=new Be().setFromEuler(t),r=ot.getUnifiedFromEngine(),n=Ae.split(r.x),i=Ae.split(r.y),s=Ae.split(r.z);le.emit(Fe.CAMERA_TELEPORT,{position:{x:0,y:0,z:0},rotation:{x:o.x,y:o.y,z:o.z,w:o.w},sceneOffset:{x:n.high,y:i.high,z:s.high,xL:n.low,yL:i.low,zL:s.low}})}};function mn(a,t,o,r,n){const i=1-a,s=a*a,l=i*i,d=l*i,c=s*a;return d*t+3*l*a*o+3*i*s*r+c*n}function Uo(a,t){let o=t[0],r=t[t.length-1];for(let f=0;f<t.length-1;f++)if(a>=t[f].frame&&a<t[f+1].frame){o=t[f],r=t[f+1];break}if(a>=r.frame)return r.value;if(a<=o.frame)return o.value;const n=r.frame-o.frame,i=(a-o.frame)/n;if(o.interpolation==="Step")return o.value;if(o.interpolation==="Linear")return o.value+(r.value-o.value)*i;const s=o.value,l=o.value+(o.rightTangent?o.rightTangent.y:0),d=r.value+(r.leftTangent?r.leftTangent.y:0),c=r.value;return mn(i,s,l,d,c)}function il(a,t=1){const o=[],r=a[0].frame,n=a[a.length-1].frame,i=Math.max(t,(n-r)/50);for(let s=r;s<=n;s+=i)o.push({t:s,val:Uo(s,a)});return o.length>0&&o[o.length-1].t<n&&o.push({t:n,val:Uo(n,a)}),o}function sl(a,t,o){let r=0,n=0,i=0,s=0,l=0,d=0,c=0;for(let m=0;m<a.length;m++){const y=a[m].t,x=1-y,C=a[m].val;d+=C,c+=C*C;const k=3*x*x*y,S=3*x*y*y,b=x*x*x*t+y*y*y*o,w=C-b;r+=k*k,n+=k*S,i+=S*S,s+=w*k,l+=w*S}const f=a.length,u=d/f;if(c/f-u*u<1e-9)return null;const h=r*i-n*n;if(Math.abs(h)<1e-9)return null;const g=(i*s-n*l)/h,M=(r*l-n*s)/h;return{h1:g,h2:M}}function ll(a,t){const o=a.length;if(o<2){const h=a[0].val;return{leftY:h,rightY:h}}const r=a[0].val,n=a[o-1].val,i=n-r,s=r+i*.333,l=r+i*.666,d=sl(a,r,n);let c=s,f=l;d&&(c=d.h1,f=d.h2);const u=s+(c-s)*t,p=l+(f-l)*t;return{leftY:u,rightY:p}}function Ka(a,t,o,r){if(a.length<2)return;const n=a[0],i=a[a.length-1],s=i.t-n.t,l=a.map(p=>({t:(p.t-n.t)/s,val:p.val})),{leftY:d,rightY:c}=ll(l,r);let f=0,u=-1;if(s<1)f=0;else for(let p=1;p<l.length-1;p++){const h=l[p].t,g=mn(h,n.val,d,c,i.val),M=Math.abs(g-l[p].val);M>f&&(f=M,u=p)}if(f<=o||a.length<=2){const p=t[t.length-1];p&&(p.rightTangent={x:s*.333,y:d-n.val});const h={id:tt(),frame:i.t,value:i.val,interpolation:"Bezier",brokenTangents:!1,autoTangent:!1,leftTangent:{x:-s*.333,y:c-i.val},rightTangent:{x:1,y:0}};t.push(h)}else{const p=a.slice(0,u+1),h=a.slice(u);Ka(p,t,o,r),Ka(h,t,o,r)}}const gn=(a,t,o=1)=>{if(a.length<2)return a;o=Math.max(0,Math.min(1,o));const r=[...a].sort((l,d)=>l.frame-d.frame),n=il(r,1),i=[],s=n[0];return i.push({id:tt(),frame:s.t,value:s.val,interpolation:"Bezier",brokenTangents:!1,autoTangent:!1,leftTangent:{x:-1,y:0},rightTangent:{x:1,y:0}}),Ka(n,i,t,o),i.length>0&&(i[0].leftTangent={x:-1,y:0},i[i.length-1].rightTangent={x:1,y:0}),i},cl=4;function xn(a,t,o,r,n){const i=1-a,s=a*a,l=i*i,d=l*i,c=s*a;return d*t+3*l*a*o+3*i*s*r+c*n}function dl(a,t,o,r,n){const i=1-a;return 3*i*i*(o-t)+6*i*a*(r-o)+3*a*a*(n-r)}function ul(a,t,o,r,n){const i=n-t;if(i<=1e-9)return 0;let s=(a-t)/i;for(let l=0;l<cl;++l){const d=xn(s,t,o,r,n),c=dl(s,t,o,r,n);if(Math.abs(c)<1e-9)break;const f=d-a;s-=f/c}return Math.max(0,Math.min(1,s))}function fl(a,t,o,r,n,i,s,l,d){const c=t,f=o,u=t+r,p=o+n,h=i+l,g=s+d,M=i,m=s,y=ul(a,c,u,h,M);return xn(y,f,p,g,m)}const nt=.333,rt={interpolate:(a,t,o,r=!1)=>{if(t.interpolation==="Step")return t.value;let n=t.value,i=o.value;if(r){const d=Math.PI*2,c=i-n;c>Math.PI?i-=d:c<-Math.PI&&(i+=d)}if(t.interpolation==="Bezier"){const d=t.rightTangent?t.rightTangent.x:(o.frame-t.frame)*nt,c=t.rightTangent?t.rightTangent.y:0,f=o.leftTangent?o.leftTangent.x:-(o.frame-t.frame)*nt,u=o.leftTangent?o.leftTangent.y:0;return fl(a,t.frame,n,d,c,o.frame,i,f,u)}const s=o.frame-t.frame;if(s<1e-9)return n;const l=(a-t.frame)/s;return n+(i-n)*l},scaleHandles:(a,t,o,r,n)=>{const i={};if(a.interpolation!=="Bezier")return i;if(t&&a.leftTangent){const s=r-t.frame,l=n-t.frame;if(Math.abs(s)>1e-5&&Math.abs(l)>1e-5){const d=l/s;i.leftTangent={x:a.leftTangent.x*d,y:a.leftTangent.y*d}}}if(o&&a.rightTangent){const s=o.frame-r,l=o.frame-n;if(Math.abs(s)>1e-5&&Math.abs(l)>1e-5){const d=l/s;i.rightTangent={x:a.rightTangent.x*d,y:a.rightTangent.y*d}}}return i},calculateTangents:(a,t,o,r)=>{if(r==="Ease"){const m=t?(a.frame-t.frame)*nt:10,y=o?(o.frame-a.frame)*nt:10;return{l:{x:-m,y:0},r:{x:y,y:0}}}if(!t&&!o)return{l:{x:-10,y:0},r:{x:10,y:0}};if(!t){const m=(o.value-a.value)/(o.frame-a.frame),y=(o.frame-a.frame)*nt;return{l:{x:-10,y:0},r:{x:y,y:y*m}}}if(!o){const m=(a.value-t.value)/(a.frame-t.frame),y=(a.frame-t.frame)*nt;return{l:{x:-y,y:-y*m},r:{x:10,y:0}}}const n=a.frame-t.frame,i=a.value-t.value,s=n===0?0:i/n,l=o.frame-a.frame,d=o.value-a.value,c=l===0?0:d/l;if(s*c<=0){const m=n*nt,y=l*nt;return{l:{x:-m,y:0},r:{x:y,y:0}}}const f=o.frame-t.frame,u=o.value-t.value;let p=f===0?0:u/f;const h=3*Math.min(Math.abs(s),Math.abs(c));Math.abs(p)>h&&(p=Math.sign(p)*h);const g=n*nt,M=l*nt;return{l:{x:-g,y:-g*p},r:{x:M,y:M*p}}},constrainHandles:(a,t,o)=>{const r={};if(a.leftTangent&&t){const n=a.frame-t.frame;if(n>.001){const i=n*nt;if(Math.abs(a.leftTangent.x)>i){const s=i/Math.abs(a.leftTangent.x);r.leftTangent={x:a.leftTangent.x*s,y:a.leftTangent.y*s}}a.leftTangent.x>0&&(r.leftTangent={...r.leftTangent,x:0})}}if(a.rightTangent&&o){const n=o.frame-a.frame;if(n>.001){const i=n*nt;if(Math.abs(a.rightTangent.x)>i){const s=i/Math.abs(a.rightTangent.x);r.rightTangent={x:a.rightTangent.x*s,y:a.rightTangent.y*s}}a.rightTangent.x<0&&(r.rightTangent={...r.rightTangent,x:0})}}return r},calculateSoftFalloff:(a,t,o)=>{if(a>=t)return 0;const r=a/t;switch(o){case"Linear":return 1-r;case"Dome":return Math.sqrt(1-r*r);case"Pinpoint":return Math.pow(1-r,4);case"S-Curve":return .5*(1+Math.cos(r*Math.PI));default:return 1-r}}},$a={updateNeighbors:(a,t)=>{const o=a[t],r=t===a.length-1,n=t-1;if(n>=0){const s={...a[n]};if(a[n]=s,s.interpolation==="Bezier"){const l=o.frame-s.frame;if(s.autoTangent){const d=a[n-1],{l:c,r:f}=rt.calculateTangents(s,d,o,"Auto");s.leftTangent=c,s.rightTangent=f}else{const d=rt.constrainHandles(s,a[n-1],o);Object.assign(s,d)}if(r&&l>1e-4){const d=l*.3,c=s.rightTangent||{x:10,y:0};if(c.x<d){const f=d/Math.max(1e-4,Math.abs(c.x));s.rightTangent={x:d,y:c.y*f}}}}}const i=t+1;if(i<a.length){const s={...a[i]};if(a[i]=s,s.interpolation==="Bezier")if(s.autoTangent){const l=a[i+1],{l:d,r:c}=rt.calculateTangents(s,o,l,"Auto");s.leftTangent=d,s.rightTangent=c}else{const l=rt.constrainHandles(s,o,a[i+1]);Object.assign(s,l)}}},inferInterpolation:(a,t)=>{const o=a.filter(r=>r.frame<t).sort((r,n)=>n.frame-r.frame);return o.length===0||o[0].interpolation==="Linear"?"Linear":o[0].interpolation==="Step"?"Step":"Bezier"}},pl={durationFrames:300,fps:30,tracks:{}},hl=(a,t)=>({sequence:pl,clipboard:null,undoStack:[],redoStack:[],snapshot:()=>{const o=t().sequence,r=JSON.parse(JSON.stringify(o));a(n=>{const i=[...n.undoStack,{type:"SEQUENCE",data:r}];return{undoStack:i.length>50?i.slice(1):i,redoStack:[]}})},undo:()=>{const{undoStack:o,redoStack:r,sequence:n}=t();if(o.length===0)return!1;const i=o[o.length-1],s=o.slice(0,-1),d={type:"SEQUENCE",data:JSON.parse(JSON.stringify(n))};return a({sequence:i.data,undoStack:s,redoStack:[d,...r]}),!0},redo:()=>{const{undoStack:o,redoStack:r,sequence:n}=t();if(r.length===0)return!1;const i=r[0],s=r.slice(1),d={type:"SEQUENCE",data:JSON.parse(JSON.stringify(n))};return a({sequence:i.data,undoStack:[...o,d],redoStack:s}),!0},setSequence:o=>{t().snapshot(),a({sequence:o})},addTrack:(o,r)=>{t().snapshot(),a(n=>n.sequence.tracks[o]?n:{sequence:{...n.sequence,tracks:{...n.sequence.tracks,[o]:{id:o,type:"float",label:r,keyframes:[]}}}})},removeTrack:o=>{t().snapshot(),a(r=>{const n={...r.sequence.tracks};return delete n[o],{sequence:{...r.sequence,tracks:n},selectedTrackIds:r.selectedTrackIds.filter(i=>i!==o)}})},setTrackBehavior:(o,r)=>{t().snapshot(),a(n=>{const i=n.sequence.tracks[o];return i?{sequence:{...n.sequence,tracks:{...n.sequence.tracks,[o]:{...i,postBehavior:r}}}}:n})},addKeyframe:(o,r,n,i)=>{a(s=>{const l=s.sequence.tracks[o];if(!l)return s;let d=i||"Bezier";i||(d=$a.inferInterpolation(l.keyframes,r));const c=d==="Bezier",f={id:tt(),frame:r,value:n,interpolation:d,autoTangent:c,brokenTangents:!1},p=[...l.keyframes.filter(g=>Math.abs(g.frame-r)>.001),f].sort((g,M)=>g.frame-M.frame),h=p.findIndex(g=>g.id===f.id);if(d==="Bezier"){const g=h>0?p[h-1]:void 0,M=h<p.length-1?p[h+1]:void 0,{l:m,r:y}=rt.calculateTangents(f,g,M,"Auto");f.leftTangent=m,f.rightTangent=y}return $a.updateNeighbors(p,h),{sequence:{...s.sequence,tracks:{...s.sequence.tracks,[o]:{...l,keyframes:p}}}}})},batchAddKeyframes:(o,r,n)=>{a(i=>{const s={...i.sequence.tracks};let l=!1;return r.forEach(({trackId:d,value:c})=>{s[d]||(s[d]={id:d,type:"float",label:d,keyframes:[]},l=!0);const f=s[d],u=[...f.keyframes],p=u.length>0?u[u.length-1]:null,h={id:tt(),frame:o,value:c,interpolation:n||"Linear",autoTangent:n==="Bezier",brokenTangents:!1};if(p)if(o>p.frame)u.push(h);else if(Math.abs(o-p.frame)<.001)h.id=p.id,u[u.length-1]=h;else{const g=u.filter(M=>Math.abs(M.frame-o)>.001);g.push(h),g.sort((M,m)=>M.frame-m.frame),f.keyframes=g,l=!0;return}else u.push(h);f.keyframes=u,l=!0}),l?{sequence:{...i.sequence,tracks:s}}:i})},removeKeyframe:(o,r)=>{t().snapshot(),a(n=>{const i=n.sequence.tracks[o];return i?{sequence:{...n.sequence,tracks:{...n.sequence.tracks,[o]:{...i,keyframes:i.keyframes.filter(s=>s.id!==r)}}}}:n})},updateKeyframe:(o,r,n)=>{a(i=>{const s=i.sequence.tracks[o];if(!s)return i;const l=s.keyframes.map(d=>d.id===r?{...d,...n}:d).sort((d,c)=>d.frame-c.frame);return{sequence:{...i.sequence,tracks:{...i.sequence.tracks,[o]:{...s,keyframes:l}}}}})},updateKeyframes:o=>{a(r=>{const n={...r.sequence.tracks};return o.forEach(({trackId:i,keyId:s,patch:l})=>{const d=n[i];if(d){const c=d.keyframes.findIndex(f=>f.id===s);if(c!==-1){const f=d.keyframes[c];l.interpolation==="Bezier"&&f.interpolation!=="Bezier"&&(l.autoTangent=!0),d.keyframes[c]={...f,...l}}}}),Object.keys(n).forEach(i=>{n[i].keyframes.sort((s,l)=>s.frame-l.frame)}),{sequence:{...r.sequence,tracks:n}}})},deleteSelectedKeyframes:()=>{t().snapshot(),a(o=>{const r={...o.sequence.tracks},n=new Set(o.selectedKeyframeIds);return Object.keys(r).forEach(i=>{r[i]={...r[i],keyframes:r[i].keyframes.filter(s=>!n.has(`${i}::${s.id}`))}}),{sequence:{...o.sequence,tracks:r},selectedKeyframeIds:[]}})},deleteAllKeys:()=>{t().snapshot(),a(o=>{const r={...o.sequence.tracks};return Object.keys(r).forEach(n=>{r[n]={...r[n],keyframes:[]}}),{sequence:{...o.sequence,tracks:r},selectedKeyframeIds:[]}})},deleteAllTracks:()=>{t().snapshot(),a({sequence:{...t().sequence,tracks:{}},selectedTrackIds:[],selectedKeyframeIds:[]})},setTangents:o=>{t().snapshot(),a(r=>{const n={...r.sequence.tracks};return r.selectedKeyframeIds.forEach(i=>{const[s,l]=i.split("::"),d=n[s];if(d){const c=d.keyframes.findIndex(u=>u.id===l);if(c===-1)return;const f=d.keyframes[c];if(o==="Split")d.keyframes[c]={...f,brokenTangents:!0,autoTangent:!1};else if(o==="Unified"){let u=f.rightTangent,p=f.leftTangent;if(u&&p){const h=Math.sqrt(u.x*u.x+u.y*u.y),g=Math.sqrt(p.x*p.x+p.y*p.y);u={x:-p.x*(h/Math.max(.001,g)),y:-p.y*(h/Math.max(.001,g))}}d.keyframes[c]={...f,rightTangent:u,brokenTangents:!1,autoTangent:!1}}else if(o==="Auto"||o==="Ease"){const u=d.keyframes[c-1],p=d.keyframes[c+1],{l:h,r:g}=rt.calculateTangents(f,u,p,o);d.keyframes[c]={...f,autoTangent:o==="Auto",brokenTangents:!1,leftTangent:h,rightTangent:g}}}}),{sequence:{...r.sequence,tracks:n}}})},setGlobalInterpolation:(o,r)=>{t().snapshot(),a(n=>{const i={...n.sequence.tracks};return Object.keys(i).forEach(s=>{const l=i[s];l.keyframes.length!==0&&l.keyframes.forEach((d,c)=>{if(d.interpolation=o,o==="Bezier"&&r){const f=l.keyframes[c-1],u=l.keyframes[c+1],{l:p,r:h}=rt.calculateTangents(d,f,u,r);d.leftTangent=p,d.rightTangent=h,d.autoTangent=r==="Auto",d.brokenTangents=!1}})}),{sequence:{...n.sequence,tracks:i}}})},copySelectedKeyframes:()=>{const{sequence:o,selectedKeyframeIds:r}=t();if(r.length===0)return;let n=1/0;r.forEach(s=>{var f,u;const[l,d]=s.split("::"),c=(u=(f=o.tracks[l])==null?void 0:f.keyframes.find(p=>p.id===d))==null?void 0:u.frame;c!==void 0&&c<n&&(n=c)});const i=[];r.forEach(s=>{var f;const[l,d]=s.split("::"),c=(f=o.tracks[l])==null?void 0:f.keyframes.find(u=>u.id===d);c&&i.push({relativeFrame:c.frame-n,value:c.value,interpolation:c.interpolation,leftTangent:c.leftTangent,rightTangent:c.rightTangent,originalTrackId:l})}),i.length>0&&a({clipboard:i})},pasteKeyframes:o=>{const{clipboard:r,currentFrame:n}=t();r&&(t().snapshot(),a(i=>{const s={...i.sequence.tracks},l=o!==void 0?o:n;return r.forEach(d=>{const c=s[d.originalTrackId];if(c){const f=l+d.relativeFrame,u={id:tt(),frame:f,value:d.value,interpolation:d.interpolation,leftTangent:d.leftTangent,rightTangent:d.rightTangent,autoTangent:!1,brokenTangents:!1};c.keyframes=[...c.keyframes.filter(p=>Math.abs(p.frame-f)>.001),u].sort((p,h)=>p.frame-h.frame)}}),{sequence:{...i.sequence,tracks:s}}}))},duplicateSelection:()=>{t().copySelectedKeyframes(),t().pasteKeyframes(t().currentFrame)},loopSelection:o=>{const r=t();if(r.selectedKeyframeIds.length<1)return;r.snapshot();let n=1/0,i=-1/0;if(r.selectedKeyframeIds.forEach(l=>{const[d,c]=l.split("::"),f=r.sequence.tracks[d],u=f==null?void 0:f.keyframes.find(p=>p.id===c);u&&(u.frame<n&&(n=u.frame),u.frame>i&&(i=u.frame))}),n===1/0||i===-1/0)return;const s=Math.max(1,i-n);a(l=>{const d={...l.sequence.tracks};for(let c=1;c<=o;c++){const f=s*c;l.selectedKeyframeIds.forEach(u=>{const[p,h]=u.split("::"),g=d[p];if(!g)return;const M=g.keyframes.find(m=>m.id===h);if(M){const m=M.frame+f,y={...M,id:tt(),frame:m};g.keyframes=[...g.keyframes.filter(x=>Math.abs(x.frame-m)>.001),y]}})}return Object.values(d).forEach(c=>c.keyframes.sort((f,u)=>f.frame-u.frame)),{sequence:{...l.sequence,tracks:d}}})},captureCameraFrame:(o,r=!1,n)=>{if(!B.activeCamera)return;r||t().snapshot();const i=ot.getUnifiedFromEngine(),s=B.activeCamera.quaternion,l=new qe().setFromQuaternion(s),d=[{id:"camera.unified.x",val:i.x,label:"Position X"},{id:"camera.unified.y",val:i.y,label:"Position Y"},{id:"camera.unified.z",val:i.z,label:"Position Z"},{id:"camera.rotation.x",val:l.x,label:"Rotation X"},{id:"camera.rotation.y",val:l.y,label:"Rotation Y"},{id:"camera.rotation.z",val:l.z,label:"Rotation Z"}];a(c=>{const f={...c.sequence.tracks},u=f["camera.unified.x"],p=!u||u.keyframes.length===0,h=n||(p?"Linear":"Bezier");return d.forEach(g=>{let M=f[g.id];M||(M={id:g.id,type:"float",label:g.label,keyframes:[],hidden:!1},f[g.id]=M);const m={id:tt(),frame:o,value:g.val,interpolation:h,autoTangent:h==="Bezier",brokenTangents:!1},x=[...M.keyframes.filter(k=>Math.abs(k.frame-o)>.001),m].sort((k,S)=>k.frame-S.frame),C=x.findIndex(k=>k.id===m.id);if(h==="Bezier"){const k=C>0?x[C-1]:void 0,S=C<x.length-1?x[C+1]:void 0,{l:b,r:w}=rt.calculateTangents(m,k,S,"Auto");m.leftTangent=b,m.rightTangent=w}$a.updateNeighbors(x,C),M.keyframes=x}),{sequence:{...c.sequence,tracks:f}}})},simplifySelectedKeys:(o=.01)=>{t().snapshot(),a(r=>{const n=r,i={...n.sequence.tracks},s=new Set(n.selectedKeyframeIds),l={};n.selectedKeyframeIds.forEach(c=>{const[f,u]=c.split("::");l[f]||(l[f]=[]);const p=n.sequence.tracks[f],h=p==null?void 0:p.keyframes.find(g=>g.id===u);h&&l[f].push(h)});const d=[];return Object.entries(l).forEach(([c,f])=>{const u=i[c];if(!u)return;const p={...u};if(i[c]=p,f.length<3)return;const h=f.sort((M,m)=>M.frame-m.frame);p.keyframes=p.keyframes.filter(M=>!s.has(`${c}::${M.id}`));const g=gn(h,o);p.keyframes=[...p.keyframes,...g].sort((M,m)=>M.frame-m.frame),g.forEach(M=>d.push(`${c}::${M.id}`))}),{sequence:{...n.sequence,tracks:i},selectedKeyframeIds:d}})}}),xe=Pr()(Er((a,t,o)=>({...rl(a,t),...nl(a),...hl(a,t)})));typeof window<"u"&&(window.useAnimationStore=xe);class ml{constructor(){Z(this,"pendingCam");Z(this,"binders",new Map);Z(this,"overriddenTracks",new Set);Z(this,"lastCameraIndex",-1);this.pendingCam={rot:new qe,unified:new ie,rotDirty:!1,unifiedDirty:!1}}setOverriddenTracks(t){this.overriddenTracks=t}getBinder(t){if(this.binders.has(t))return this.binders.get(t);let o=()=>{};if(t==="camera.active_index")o=r=>{const n=Math.round(r);if(n!==this.lastCameraIndex){const i=Y.getState(),s=i.savedCameras;s&&s[n]&&(i.selectCamera(s[n].id),this.lastCameraIndex=n)}};else if(t.startsWith("camera.")){const r=t.split("."),n=r[1],i=r[2];n==="unified"?o=s=>{this.pendingCam.unified[i]=s,this.pendingCam.unifiedDirty=!0}:n==="rotation"&&(o=s=>{this.pendingCam.rot[i]=s,this.pendingCam.rotDirty=!0})}else if(t.startsWith("lights.")){const r=t.split("."),n=parseInt(r[1]),i=r[2];let s="";i==="position"?s=`pos${r[3].toUpperCase()}`:i==="color"?s="color":s=i;const l=`lighting.light${n}_${s}`;return this.getBinder(l)}else if(t.startsWith("lighting.light")){const r=t.match(/lighting\.light(\d+)_(\w+)/);if(r){const n=parseInt(r[1]),i=r[2],s=Y.getState();if(i==="intensity")o=l=>s.updateLight({index:n,params:{intensity:l}});else if(i==="falloff")o=l=>s.updateLight({index:n,params:{falloff:l}});else if(i.startsWith("pos")){const l=i.replace("pos","").toLowerCase();o=d=>{var u;const f=(u=Y.getState().lighting)==null?void 0:u.lights[n];if(f){const p={...f.position,[l]:d};s.updateLight({index:n,params:{position:p}})}}}else if(i.startsWith("rot")){const l=i.replace("rot","").toLowerCase();o=d=>{var u;const f=(u=Y.getState().lighting)==null?void 0:u.lights[n];if(f){const p={...f.rotation,[l]:d};s.updateLight({index:n,params:{rotation:p}})}}}}}else if(t.includes(".")){const r=t.split("."),n=r[0],i=r[1];if(ve.get(n)){const l=Y.getState(),d=`set${n.charAt(0).toUpperCase()+n.slice(1)}`,c=l[d];c&&typeof c=="function"?o=f=>c({[i]:f}):console.warn(`AnimationEngine: Setter ${d} not found for feature ${n}`)}}else{const r=Y.getState(),n="set"+t.charAt(0).toUpperCase()+t.slice(1);typeof r[n]=="function"&&(o=i=>r[n](i))}return this.binders.set(t,o),o}tick(t){const o=xe.getState();if(!o.isPlaying)return;const r=o.fps,n=o.currentFrame,i=o.durationFrames,s=o.loopMode,l=t*r;let d=n+l;if(d>=i)if(s==="Once"||o.isRecordingModulation){d=i,xe.setState({isPlaying:!1,currentFrame:i}),o.isRecordingModulation&&o.stopModulationRecording();return}else d=0;xe.setState({currentFrame:d}),this.scrub(d)}scrub(t){const{sequence:o,isPlaying:r,isRecording:n,recordCamera:i}=xe.getState(),s=Object.values(o.tracks);this.syncBuffersFromEngine();const l=r&&n&&i;for(let d=0;d<s.length;d++){const c=s[d];if(this.overriddenTracks.has(c.id)||c.keyframes.length===0||c.type!=="float"||c.id.includes("camera.position")||c.id.includes("camera.offset")||l&&c.id.startsWith("camera."))continue;const f=this.interpolate(c,t);this.getBinder(c.id)(f)}this.commitState()}syncBuffersFromEngine(){const t=B.activeCamera;if(t){this.pendingCam.rot.setFromQuaternion(t.quaternion);const o=B.sceneOffset;this.pendingCam.unified.set(o.x+o.xL+t.position.x,o.y+o.yL+t.position.y,o.z+o.zL+t.position.z),this.pendingCam.rotDirty=!1,this.pendingCam.unifiedDirty=!1}}interpolate(t,o){const r=t.keyframes;if(r.length===0)return 0;const n=r[0],i=r[r.length-1],s=t.id.startsWith("camera.rotation")||t.id.includes("rot")||t.id.includes("phase")||t.id.includes("twist");if(o>i.frame){const l=t.postBehavior||"Hold";if(l==="Hold")return i.value;if(l==="Continue"){let h=0;if(r.length>1){const g=r[r.length-2];i.interpolation==="Linear"?h=(i.value-g.value)/(i.frame-g.frame):i.interpolation==="Bezier"&&(i.leftTangent&&Math.abs(i.leftTangent.x)>.001?h=i.leftTangent.y/i.leftTangent.x:h=(i.value-g.value)/(i.frame-g.frame))}return i.value+h*(o-i.frame)}const d=i.frame-n.frame;if(d<=.001)return i.value;const c=o-n.frame,f=Math.floor(c/d),u=n.frame+c%d,p=this.evaluateCurveInternal(r,u,s);if(l==="Loop")return p;if(l==="PingPong"){if(f%2===1){const g=i.frame-c%d;return this.evaluateCurveInternal(r,g,s)}return p}if(l==="OffsetLoop"){const h=i.value-n.value;return p+h*f}}return o<n.frame?n.value:this.evaluateCurveInternal(r,o,s)}evaluateCurveInternal(t,o,r){for(let n=0;n<t.length-1;n++){const i=t[n],s=t[n+1];if(o>=i.frame&&o<=s.frame)return rt.interpolate(o,i,s,r)}return t[t.length-1].value}commitState(){if(this.pendingCam.unifiedDirty||this.pendingCam.rotDirty){B.shouldSnapCamera=!0;const t=new Be().setFromEuler(this.pendingCam.rot),o={x:t.x,y:t.y,z:t.z,w:t.w},r=Ae.split(this.pendingCam.unified.x),n=Ae.split(this.pendingCam.unified.y),i=Ae.split(this.pendingCam.unified.z);le.emit(Fe.CAMERA_TELEPORT,{position:{x:0,y:0,z:0},rotation:o,sceneOffset:{x:r.high,y:n.high,z:i.high,xL:r.low,yL:n.low,zL:i.low}}),Y.setState({cameraRot:o})}}}const Ke=new ml;class Go{constructor(t){Z(this,"element");Z(this,"sourceNode",null);Z(this,"gainNode",null);Z(this,"fileUrl",null);Z(this,"fileName",null);this.element=new Audio,this.element.loop=!0,this.element.crossOrigin="anonymous"}load(t,o,r){this.fileUrl&&URL.revokeObjectURL(this.fileUrl),this.fileUrl=URL.createObjectURL(t),this.fileName=t.name,this.element.src=this.fileUrl,this.sourceNode||(this.sourceNode=o.createMediaElementSource(this.element),this.gainNode=o.createGain(),this.sourceNode.connect(this.gainNode),this.gainNode.connect(r))}play(){this.element.play().catch(t=>console.warn("Deck play failed",t))}pause(){this.element.pause()}stop(){this.element.pause(),this.element.currentTime=0}seek(t){this.element.currentTime=t}setVolume(t){this.gainNode&&(this.gainNode.gain.value=t)}get duration(){return this.element.duration||0}get currentTime(){return this.element.currentTime||0}}class gl{constructor(){Z(this,"audioContext",null);Z(this,"analyser",null);Z(this,"micSource",null);Z(this,"decks",[null,null]);Z(this,"masterGain",null);Z(this,"dataArray",null);Z(this,"isMicActive",!1);Z(this,"crossfade",.5)}init(){this.audioContext||(this.audioContext=new(window.AudioContext||window.webkitAudioContext),this.masterGain=this.audioContext.createGain(),this.masterGain.connect(this.audioContext.destination),this.analyser=this.audioContext.createAnalyser(),this.analyser.fftSize=2048,this.analyser.smoothingTimeConstant=.8,this.dataArray=new Uint8Array(this.analyser.frequencyBinCount),this.masterGain.connect(this.analyser),this.decks[0]=new Go(this.audioContext),this.decks[1]=new Go(this.audioContext),this.setCrossfade(.5))}setSmoothing(t){this.analyser&&(this.analyser.smoothingTimeConstant=Math.max(0,Math.min(.99,t)))}async connectMicrophone(){if(this.init(),!(!this.audioContext||!this.masterGain)){this.decks.forEach(t=>t==null?void 0:t.pause());try{const t=await navigator.mediaDevices.getUserMedia({audio:!0});this.micSource&&this.micSource.disconnect(),this.micSource=this.audioContext.createMediaStreamSource(t),this.micSource.connect(this.analyser),this.isMicActive=!0,this.audioContext.state==="suspended"&&this.audioContext.resume()}catch(t){console.error("AudioEngine: Mic access denied",t),alert("Microphone access denied.")}}}async connectSystemAudio(){if(this.init(),!!this.audioContext)try{const t=await navigator.mediaDevices.getDisplayMedia({video:!0,audio:!0});if(t.getVideoTracks().forEach(o=>o.stop()),t.getAudioTracks().length===0)return;this.micSource&&this.micSource.disconnect(),this.micSource=this.audioContext.createMediaStreamSource(t),this.micSource.connect(this.analyser),this.micSource.connect(this.audioContext.destination),this.isMicActive=!0,this.audioContext.state==="suspended"&&this.audioContext.resume()}catch{}}loadTrack(t,o){var r;this.init(),!(!this.audioContext||!this.masterGain)&&(this.micSource&&(this.micSource.disconnect(),this.micSource=null,this.isMicActive=!1),(r=this.decks[t])==null||r.load(o,this.audioContext,this.masterGain),this.setCrossfade(this.crossfade),this.audioContext.state==="suspended"&&this.audioContext.resume())}play(t){var o;(o=this.decks[t])==null||o.play()}pause(t){var o;(o=this.decks[t])==null||o.pause()}stop(t){var o;(o=this.decks[t])==null||o.stop()}seek(t,o){var r;(r=this.decks[t])==null||r.seek(o)}getTrackInfo(t){const o=this.decks[t];return{duration:(o==null?void 0:o.duration)||1,currentTime:(o==null?void 0:o.currentTime)||0,hasTrack:!!(o!=null&&o.sourceNode),fileName:(o==null?void 0:o.fileName)||null}}setCrossfade(t){this.crossfade=t;const o=Math.cos(t*.5*Math.PI),r=Math.cos((1-t)*.5*Math.PI);this.decks[0]&&this.decks[0].setVolume(o),this.decks[1]&&this.decks[1].setVolume(r)}update(){!this.analyser||!this.dataArray||this.analyser.getByteFrequencyData(this.dataArray)}getRawData(){return this.dataArray}}const et=new gl;class xl{constructor(){Z(this,"ruleValues",{});Z(this,"lfoValues",{});Z(this,"lfoStates",{});Z(this,"outputValues",{});Z(this,"lfoPrevOffsets",{});Z(this,"offsets",{})}getRuleValue(t){return this.ruleValues[t]||0}updateOscillators(t,o,r){for(let n=0;n<t.length;n++){const i=t[n];if(!i.enabled)continue;const s=(o/i.period+i.phase)%1;let l=0;switch(i.shape){case"Sine":l=Math.sin(s*Math.PI*2);break;case"Triangle":l=1-Math.abs(s*2-1)*2;break;case"Sawtooth":l=s*2-1;break;case"Pulse":l=s<.5?1:-1;break;case"Noise":const p=i.id;this.lfoStates[p]||(this.lfoStates[p]=Math.random()),this.lfoStates[p]+=r*5,l=Math.sin(this.lfoStates[p])*Math.cos(this.lfoStates[p]*.73);break}const d=l*.5+.5;this.lfoValues[`lfo-${n+1}`]=d;const c=l*i.amplitude,f=this.lfoPrevOffsets[i.id]??c;let u=c;if(i.smoothing>.001){const p=50*Math.pow(1-i.smoothing,2)+.1,h=1-Math.exp(-p*r);u=f+(c-f)*h}this.lfoPrevOffsets[i.id]=u,this.offsets[i.target]=(this.offsets[i.target]||0)+u}}update(t,o){const r=et.getRawData();for(const n of t){if(!n.enabled)continue;let i=0;n.source==="audio"?r&&(i=this.processAudioSignal(n,r)):n.source.startsWith("lfo-")&&(i=this.lfoValues[n.source]||0);const s=this.ruleValues[n.id]||0;let l=s;if(i>s){const f=1-Math.pow(n.attack,.2);l=s+(i-s)*f}else{const f=1-Math.pow(n.decay,.2);l=s+(i-s)*f}this.ruleValues[n.id]=l;let d=l;if(n.smoothing&&n.smoothing>.001){const f=this.outputValues[n.id]||0,u=1-Math.pow(n.smoothing,.5);d=f+(l-f)*u}this.outputValues[n.id]=d;const c=d*n.gain+n.offset;this.offsets[n.target]=(this.offsets[n.target]||0)+c}}resetOffsets(){this.offsets={}}processAudioSignal(t,o){const r=o.length,n=Math.floor(t.freqStart*r),i=Math.floor(t.freqEnd*r);if(n>=r||i<=n)return 0;let s=0,l=0;for(let u=n;u<i;u++)s+=o[u],l++;if(l===0)return 0;const d=s/l/255;if(d<t.thresholdMin)return 0;const c=Math.max(.001,t.thresholdMax-t.thresholdMin),f=(d-t.thresholdMin)/c;return Math.min(1,f)}}const mt=new xl;class Wo{static findNALUs(t){const o=[];let r=0;for(;r<t.length;){let n=0;if(r+2<t.length&&t[r]===0&&t[r+1]===0&&t[r+2]===1?n=3:r+3<t.length&&t[r]===0&&t[r+1]===0&&t[r+2]===0&&t[r+3]===1&&(n=4),n>0){let i=t.length;for(let d=r+n;d<t.length-2;d++)if(t[d]===0&&t[d+1]===0&&(t[d+2]===1||d+3<t.length&&t[d+2]===0&&t[d+3]===1)){i=d;break}const s=t.subarray(r+n,i),l=s[0]&31;o.push({type:l,data:s}),r=i}else r++}return o}static createAVCCDescription(t,o){const r=[1,t[1],t[2],t[3],255,225,t.length>>8&255,t.length&255];for(let n=0;n<t.length;n++)r.push(t[n]);r.push(1,o.length>>8&255,o.length&255);for(let n=0;n<o.length;n++)r.push(o[n]);return new Uint8Array(r)}static convertChunkToAVCC(t){const o=this.findNALUs(t);let r=0;o.forEach(d=>r+=4+d.data.length);const n=new Uint8Array(r);let i=0,s=null,l=null;for(const d of o){d.type===7&&(s=d.data),d.type===8&&(l=d.data);const c=d.data.length;n[i]=c>>24&255,n[i+1]=c>>16&255,n[i+2]=c>>8&255,n[i+3]=c&255,n.set(d.data,i+4),i+=4+c}return{data:n,sps:s,pps:l}}}const qo=(a,t)=>{let o=0,r=1/t,n=a;for(;n>0;)o=o+r*(n%t),n=Math.floor(n/t),r=r/t;return o};class yl{constructor(t){Z(this,"engine");Z(this,"accumTargetA",null);Z(this,"accumTargetB",null);Z(this,"exportTarget",null);Z(this,"pixelBuffer",null);Z(this,"ppScene");Z(this,"ppCamera");Z(this,"session",null);Z(this,"isPaused",!1);Z(this,"shouldStitchEarly",!1);Z(this,"isFinishing",!1);Z(this,"extractedDescription",null);Z(this,"internalFrameCounter",0);Z(this,"juliaScratch",new ie);Z(this,"mat4Scratch",new We);Z(this,"mat3Scratch",new qt);this.engine=t,this.ppScene=new bt,this.ppCamera=new Pt(-1,1,1,-1,0,1);const o=new jt(new Tt(2,2),this.engine.materials.exportMaterial);o.frustumCulled=!1,this.ppScene.add(o)}get active(){return!!this.session}captureCurrentState(){const t=xe.getState(),o=this.engine.activeCamera;return{frame:t.currentFrame,offset:{...this.engine.sceneOffset},camPos:o?o.position.clone():new ie,camQuat:o?o.quaternion.clone():new Be,wasPlaying:t.isPlaying,camAspect:o instanceof Fr?o.aspect:1,lastFrameCount:this.engine.mainUniforms.uFrameCount.value}}start(t,o){if(!this.engine.renderer)throw new Error("Renderer not ready");const r=xe.getState();r.isPlaying&&r.pause();const n=16,i=Math.floor(t.width/n)*n,s=Math.floor(t.height/n)*n,l=t.internalScale||1,d=Math.floor(i*l),c=Math.floor(s*l);this.initTargets(i,s,d,c);const f=this.engine.activeCamera,u=this.captureCurrentState();f.aspect=i/s,f.updateProjectionMatrix(),this.internalFrameCounter=0;const p=oa[t.formatIndex]||oa[0];let h,g;p.container==="webm"?(h=o?new Ro(o,{chunked:!0}):new zo,g=new fi):(h=o?new Ro(o,{chunked:!0}):new zo,g=new pi({fastStart:"in-memory"}));const M=new hi({format:g,target:h}),m=new mi(p.codec);this.extractedDescription=null;const y=new VideoEncoder({output:(w,j)=>this.handleEncodedChunk(w,j),error:w=>{console.error("Encoder Error",w)}}),x={codec:p.codec==="avc"?"avc1.640034":p.codec,width:i,height:s,bitrate:t.bitrate*as.BITRATE_MULTIPLIER,framerate:t.fps,latencyMode:"quality",avc:{format:p.container==="mp4"?"annexb":"avc"}};y.configure(x);const C=Math.max(0,t.startFrame),k=Math.max(C,Math.min(r.durationFrames,t.endFrame)),S=Math.max(1,Math.floor(t.frameStep)),b=Math.floor((k-C)/S)+1;this.session={output:M,packetSource:m,encoder:y,muxerChain:Promise.resolve(),config:t,safeWidth:i,safeHeight:s,renderWidth:d,renderHeight:c,totalFrames:b,currentOutputIndex:0,currentSample:0,startState:u,directStream:o,formatDef:p},this.isPaused=!1,this.shouldStitchEarly=!1,this.isFinishing=!1,Y.getState().setIsExporting(!0),this.engine.resetAccumulation()}handleEncodedChunk(t,o){var l;if(!this.session)return;const r=this.session,n=new Uint8Array(t.byteLength);t.copyTo(n);const i=o?{decoderConfig:{...o.decoderConfig,description:(l=o.decoderConfig)!=null&&l.description?new Uint8Array(o.decoderConfig.description).slice():void 0}}:void 0,s=new gi(n,t.type,t.timestamp/1e6,(t.duration??0)/1e6);r.muxerChain=r.muxerChain.then(async()=>{var d;try{if(r.formatDef.container==="mp4"&&r.formatDef.codec==="avc"){const c=Wo.convertChunkToAVCC(s.data);s.data=c.data,c.sps&&c.pps&&!this.extractedDescription&&(this.extractedDescription=Wo.createAVCCDescription(c.sps,c.pps))}if(i&&i.decoderConfig&&!i.decoderConfig.description&&this.extractedDescription&&(i.decoderConfig.description=this.extractedDescription),r.output.state==="pending"){const c=this.extractedDescription||((d=i==null?void 0:i.decoderConfig)==null?void 0:d.description);if(r.formatDef.container==="mp4"&&!c){console.warn("Waiting for SPS/PPS...");return}r.output.addVideoTrack(r.packetSource,{frameRate:r.config.fps,width:r.safeWidth,height:r.safeHeight,description:c}),await r.output.start()}await r.packetSource.add(s,i)}catch(c){console.error("Muxing error:",c),this.cancel()}})}tick(t){if(!this.session||this.isFinishing||this.isPaused)return;const o=this.session;if(o.currentOutputIndex>=o.totalFrames){this.finish();return}if(o.currentSample===0){const r=o.config.startFrame+o.currentOutputIndex*o.config.frameStep,n=r/o.config.fps;Ke.scrub(r),this.applyModulations(n),this.updateDerivedState(),this.engine.setUniform("uTime",n),this.engine.setUniform("uResolution",new Se(o.renderWidth,o.renderHeight)),this.engine.setUniform("uInternalScale",o.config.internalScale||1),this.engine.pipeline.resize(o.renderWidth,o.renderHeight);const i=this.engine.activeCamera;i&&this.engine.syncFrame(i,{clock:{elapsedTime:n}}),t.setRenderTarget(this.accumTargetA),t.clear(),t.setRenderTarget(this.accumTargetB),t.clear();const s=o.currentOutputIndex/o.totalFrames*100;le.emit(Fe.BUCKET_STATUS,{isRendering:!0,progress:s})}this.renderStep(t),o.currentSample++,o.currentSample>=o.config.samples&&(this.captureAndEncode(t),o.currentOutputIndex++,o.currentSample=0,this.shouldStitchEarly&&this.finish())}applyModulations(t){const o=Y.getState(),r=o.animations;mt.resetOffsets(),mt.updateOscillators(r,t,1/this.session.config.fps),o.modulation&&o.modulation.rules&&mt.update(o.modulation.rules,1/this.session.config.fps);const n=mt.offsets,i=Object.keys(n);let s=!1;if(i.forEach(l=>{var u;const d=n[l];if(Math.abs(d)<1e-6)return;if(l.startsWith("coloring.")){if(l==="coloring.repeats"){const p=o.coloring,h=p.scale/p.repeats;this.engine.setUniform("uColorScale",(p.repeats+d)*h);return}if(l==="coloring.phase"){const p=o.coloring;this.engine.setUniform("uColorOffset",p.offset+d);return}}if(l.startsWith("geometry.julia")){s=!0;return}let c="",f=0;if(l.includes(".")){const[p,h]=l.split("."),g=ve.get(p);if(g&&g.params[h]){c=g.params[h].uniform||"";const M=o[p];M&&(f=M[h]??0)}}else l.startsWith("param")&&(c="u"+l.charAt(0).toUpperCase()+l.slice(1),f=((u=o.coreMath)==null?void 0:u[l])??0);c&&this.engine.setUniform(c,f+d)}),s){const l=o.geometry,d=(l.juliaX??0)+(n["geometry.juliaX"]||0),c=(l.juliaY??0)+(n["geometry.juliaY"]||0),f=(l.juliaZ??0)+(n["geometry.juliaZ"]||0);this.juliaScratch.set(d,c,f),this.engine.setUniform("uJulia",this.juliaScratch)}}updateDerivedState(){const o=Y.getState().geometry,r=mt.offsets,n=(o.preRotX??0)+(r["geometry.preRotX"]||0),i=(o.preRotY??0)+(r["geometry.preRotY"]||0),s=(o.preRotZ??0)+(r["geometry.preRotZ"]||0);if(o&&o.preRotMaster){const l=new We().makeRotationX(n),d=new We().makeRotationY(i),c=new We().makeRotationZ(s);this.mat4Scratch.identity().multiply(c).multiply(l).multiply(d),this.mat3Scratch.setFromMatrix4(this.mat4Scratch),this.engine.setUniform("uPreRotMatrix",this.mat3Scratch)}}renderStep(t){if(!this.session)return;const{renderWidth:o,renderHeight:r,currentSample:n}=this.session;let i=this.accumTargetA,s=this.accumTargetB;n%2!==0&&(i=this.accumTargetB,s=this.accumTargetA);const l=1/(n+1);if(this.engine.mainUniforms.uBlendFactor.value=l,this.engine.mainUniforms.uExtraSeed.value=Math.random()*100,this.engine.mainUniforms.uHistoryTexture.value=s.texture,this.internalFrameCounter++,this.engine.mainUniforms.uFrameCount.value=this.internalFrameCounter,n>0){const y=n%16+1,x=qo(y,2),C=qo(y,3);this.engine.mainUniforms.uJitter.value.set(x*2-1,C*2-1)}else this.engine.mainUniforms.uJitter.value.set(0,0);t.setRenderTarget(i),t.render(this.engine.mainScene,this.engine.mainCamera);const d=t.domElement,c=d.width,f=d.height,u=c/f,p=this.session.renderWidth/this.session.renderHeight;let h=0,g=0,M=c,m=f;u>p?(M=Math.round(f*p),h=Math.round((c-M)/2)):(m=Math.round(c/p),g=Math.round((f-m)/2)),this.engine.materials.displayMaterial.uniforms.map.value=i.texture,this.engine.materials.displayMaterial.uniforms.uResolution.value.set(this.session.renderWidth,this.session.renderHeight),t.setRenderTarget(null),t.setScissor(0,0,c,f),t.setScissorTest(!0),t.setClearColor(0,1),t.clearColor(),t.setViewport(h,g,M,m),t.setScissor(h,g,M,m),t.render(this.engine.sceneCtrl.displayScene,this.engine.sceneCtrl.mainCamera)}captureAndEncode(t){if(!this.session)return;const o=this.session.currentSample%2!==0?this.accumTargetA:this.accumTargetB;this.engine.materials.exportMaterial.uniforms.map.value=o.texture,this.engine.materials.exportMaterial.uniforms.uResolution.value.set(this.session.safeWidth,this.session.safeHeight),t.setRenderTarget(this.exportTarget),t.setViewport(0,0,this.session.safeWidth,this.session.safeHeight),t.render(this.ppScene,this.ppCamera),t.readRenderTargetPixels(this.exportTarget,0,0,this.session.safeWidth,this.session.safeHeight,this.pixelBuffer);const r=this.session.safeWidth,n=this.session.safeHeight,i=r*4,s=Math.floor(n/2);for(let c=0;c<s;c++){const f=c*i,u=(n-c-1)*i,p=this.pixelBuffer.subarray(f,f+i),h=this.pixelBuffer.subarray(u,u+i);for(let g=0;g<i;g++){const M=p[g];p[g]=h[g],h[g]=M}}const l=new VideoFrame(this.pixelBuffer,{format:"RGBX",codedWidth:r,codedHeight:n,timestamp:this.session.currentOutputIndex*(1e6/this.session.config.fps),duration:1e6/this.session.config.fps,colorSpace:{primaries:"bt709",transfer:"bt709",matrix:"rgb",fullRange:!0}}),d=this.session.currentOutputIndex===0;this.session.encoder.encode(l,{keyFrame:d}),l.close()}async finish(){if(!this.session||this.isFinishing)return;this.isFinishing=!0;const t=this.session;console.log("Export Finishing...");try{if(await t.encoder.flush(),t.encoder.close(),await t.muxerChain,await t.output.finalize(),t.directStream)await t.directStream.close();else{const o=t.output.target;if(o.buffer){const r=new Blob([o.buffer],{type:t.formatDef.mime}),n=URL.createObjectURL(r),i=document.createElement("a");i.href=n,i.download=`fractal_export.${t.formatDef.ext}`,i.click(),setTimeout(()=>URL.revokeObjectURL(n),6e4)}}}catch(o){console.error("Finalize Error",o),alert("Error finalizing video file.")}this.session=null,this.isFinishing=!1,this.cleanup(),this.restoreState(t.startState)}cancel(){if(!this.session)return;const t=this.session.startState;this.session.directStream&&this.session.directStream.close().catch(()=>{}),this.session=null,this.isFinishing=!1,this.cleanup(),this.restoreState(t)}pause(){this.isPaused=!0}resume(){this.isPaused=!1}finishAndStitch(){this.shouldStitchEarly=!0}cleanup(){var t,o,r;Y.getState().setIsExporting(!1),le.emit(Fe.BUCKET_STATUS,{isRendering:!1,progress:0}),(t=this.accumTargetA)==null||t.dispose(),(o=this.accumTargetB)==null||o.dispose(),(r=this.exportTarget)==null||r.dispose(),this.accumTargetA=null,this.accumTargetB=null,this.exportTarget=null,this.pixelBuffer=null}restoreState(t){const o=xe.getState();if(Y.getState().setSceneOffset(t.offset),o.seek(t.frame),this.engine.activeCamera){const n=this.engine.activeCamera;n.position.copy(t.camPos),n.quaternion.copy(t.camQuat),n.aspect=t.camAspect,n.updateProjectionMatrix(),n.updateMatrixWorld()}if(Ke.scrub(t.frame),t.wasPlaying&&o.play(),this.engine.resetAccumulation(),this.engine.mainUniforms.uFrameCount.value=t.lastFrameCount,this.engine.renderer){const n=this.engine.renderer.domElement;this.engine.renderer.setViewport(0,0,n.width,n.height),this.engine.renderer.setScissor(0,0,n.width,n.height),this.engine.renderer.setScissorTest(!1),this.engine.pipeline.resize(n.width,n.height)}}initTargets(t,o,r,n){var s,l;const i=Wt;if(this.accumTargetA&&(this.accumTargetA.width!==r||this.accumTargetA.height!==n)&&(this.accumTargetA.dispose(),(s=this.accumTargetB)==null||s.dispose(),(l=this.exportTarget)==null||l.dispose(),this.accumTargetA=null),!this.accumTargetA){const d={minFilter:Ue,magFilter:Ue,stencilBuffer:!1,depthBuffer:!1,generateMipmaps:!1,format:at,type:i};this.accumTargetA=new ft(r,n,d),this.accumTargetB=new ft(r,n,d),this.exportTarget=new ft(t,o,{minFilter:Ue,magFilter:Ue,format:at,type:so,stencilBuffer:!1,depthBuffer:!1}),this.pixelBuffer=new Uint8Array(t*o*4)}}}const Xo=(a,t)=>{let o=0,r=1/t,n=a;for(;n>0;)o=o+r*(n%t),n=Math.floor(n/t),r=r/t;return o},Qa=[];for(let a=1;a<=2048;a++){const t=Xo(a,2)*2-1,o=Xo(a,3)*2-1;Qa.push(new Se(t,o))}class bl{constructor(){Z(this,"materials");Z(this,"sceneCtrl");Z(this,"pickingCtrl");Z(this,"uniformManager");Z(this,"configManager");Z(this,"virtualSpace",new Ae);Z(this,"renderer",null);Z(this,"pipeline");Z(this,"videoExporter");Z(this,"modulations",{});Z(this,"state",{cameraMode:"Orbit",isExporting:!1,isBucketRendering:!1,isGizmoInteracting:!1,isCameraInteracting:!1,isMobile:!1,optics:null,lighting:null,quality:null,bucketConfig:{bucketSize:128,bucketUpscale:1,convergenceThreshold:.1,accumulation:!0,samplesPerBucket:64}});Z(this,"isPaused",!1);Z(this,"lastInteractionTime",0);Z(this,"shouldSnapCamera",!1);Z(this,"lastMeasuredDistance",10);Z(this,"dirty",!0);Z(this,"lastCompileDuration",0);Z(this,"isBooted",!1);Z(this,"_isCompiling",!1);Z(this,"compileTimer",null);Z(this,"_pendingTeleport",null);Z(this,"_totalFrames",0);Z(this,"hasCompiledShader",!1);Z(this,"lastRenderState",{pos:new ie,quat:new Be,offset:{x:0,y:0,z:0,xL:0,yL:0,zL:0},fov:60});Z(this,"jitterVec",new Se);Z(this,"inputState",{isDragging:!1,lastX:0,lastY:0,zoomSpeed:.1,rotateSpeed:.005});const t=typeof window<"u"&&(window.matchMedia("(pointer: coarse)").matches||window.innerWidth<768);this.state.isMobile=t;const o={formula:"Mandelbulb",pipelineRevision:0,msaaSamples:1,previewMode:!1,maxSteps:300,renderMode:"Direct",compilerHardCap:500,shadows:!0};ve.getAll().forEach(n=>{const i={};Object.entries(n.params).forEach(([l,d])=>{d.composeFrom||(i[l]=d.default)});const s={};Object.keys(i).forEach(l=>{const d=i[l];d&&typeof d=="object"?d.clone?s[l]=d.clone():Array.isArray(d)?s[l]=JSON.parse(JSON.stringify(d)):s[l]={...d}:s[l]=d}),o[n.id]=s}),t&&o.quality&&(o.quality.precisionMode=1,o.quality.bufferPrecision=1),this.configManager=new tl(o),this.materials=new Vs(o),this.sceneCtrl=new Zs(this.materials),this.pipeline=new Ni,this.pickingCtrl=new Ks(this.materials,this.sceneCtrl,this.virtualSpace,this.pipeline),this.videoExporter=new yl(this),this.pipeline.updateQuality(o.quality),this.uniformManager=new el(this.materials.mainUniforms,this.virtualSpace,this.pipeline),this.materials.setGradient([{id:"1",position:0,color:"#000000"},{id:"2",position:1,color:"#ffffff"}],1),this.bindEvents(),this.isBooted=!1,this.markInteraction()}get isGizmoInteracting(){return this.state.isGizmoInteracting}set isGizmoInteracting(t){this.state.isGizmoInteracting=t}get isCameraInteracting(){return this.state.isCameraInteracting}set isCameraInteracting(t){this.state.isCameraInteracting=t}handleInput(t){if(!this.activeCamera)return;const{type:o,dx:r,dy:n,delta:i}=t;if(this.markInteraction(),o==="wheel"){const s=new ie(0,0,-1).applyQuaternion(this.activeCamera.quaternion);this.activeCamera.position.addScaledVector(s,i*this.inputState.zoomSpeed*this.lastMeasuredDistance),this.resetAccumulation()}else if(o==="drag"){const s=new ie(0,1,0),l=new ie(1,0,0).applyQuaternion(this.activeCamera.quaternion),d=new Be().setFromAxisAngle(l,n*this.inputState.rotateSpeed),c=new Be().setFromAxisAngle(s,-r*this.inputState.rotateSpeed);this.activeCamera.quaternion.multiplyQuaternions(c,this.activeCamera.quaternion),this.activeCamera.quaternion.multiplyQuaternions(this.activeCamera.quaternion,d),this.resetAccumulation()}}markInteraction(){this.lastInteractionTime=performance.now()}bootWithConfig(t){this.isBooted||(console.log(" FractalEngine: Booting..."),this.configManager.config={...t},this.configManager.rebuildMap(),this.isBooted=!0,this.scheduleCompile())}get mainMaterial(){return this.materials.mainMaterial}get histogramMaterial(){return this.materials.histogramMaterial}get mainUniforms(){return this.materials.mainUniforms}get histogramUniforms(){return this.materials.histogramUniforms}get mainScene(){return this.sceneCtrl.mainScene}get mainCamera(){return this.sceneCtrl.mainCamera}get mainMesh(){return this.sceneCtrl.mainMesh}get activeCamera(){return this.sceneCtrl.activeCamera}get lastGeneratedFrag(){return this.materials.getLastFrag()}get isCompiling(){return this._isCompiling}get sceneOffset(){return this.virtualSpace.state}get isExporting(){return this.state.isExporting}get isBucketRendering(){return this.state.isBucketRendering}bindEvents(){le.on(Fe.UNIFORM,({key:t,value:o,noReset:r})=>{this.setUniform(t,o,r)}),le.on(Fe.CONFIG,t=>{this.updateConfigInternal(t)}),le.on(Fe.GRADIENT,({stops:t,layer:o})=>{this.materials.setGradient(t,o),this.resetAccumulation()}),le.on(Fe.RESET_ACCUM,()=>{this.resetAccumulation()}),le.on(Fe.OFFSET_SHIFT,({x:t,y:o,z:r})=>{this.virtualSpace.move(t,o,r),this.resetAccumulation()}),le.on(Fe.OFFSET_SET,t=>{const o=this.virtualSpace.state;(Math.abs(o.x-t.x)>1e-9||Math.abs(o.y-t.y)>1e-9||Math.abs(o.z-t.z)>1e-9)&&(this.virtualSpace.state=t,this.resetAccumulation())}),le.on(Fe.CAMERA_ABSORB,({camera:t})=>{this.virtualSpace.absorbCamera(t.position),t.position.set(0,0,0),t.updateMatrixWorld(),this.resetAccumulation()}),le.on(Fe.CAMERA_SNAP,()=>{this.shouldSnapCamera=!0,this.resetAccumulation()}),le.on(Fe.CAMERA_TELEPORT,t=>{this.activeCamera?(this.virtualSpace.applyCameraState(this.activeCamera,t),t.targetDistance&&t.targetDistance>0&&(this.lastMeasuredDistance=t.targetDistance),this.shouldSnapCamera=!0,this.resetAccumulation()):this._pendingTeleport=t})}updateTexture(t,o){this.materials.loadTexture(t,o)}resetAccumulation(){var t;this.markInteraction(),(t=this.pipeline)==null||t.resetAccumulation()}setPreviewSampleCap(t){var o;(o=this.pipeline)==null||o.setSampleCap(t),this.resetAccumulation()}registerCamera(t){this.sceneCtrl.registerCamera(t),this._pendingTeleport&&(this.virtualSpace.applyCameraState(t,this._pendingTeleport),this._pendingTeleport.targetDistance&&(this.lastMeasuredDistance=this._pendingTeleport.targetDistance),le.emit(Fe.CAMERA_TELEPORT,this._pendingTeleport),this._pendingTeleport=null,this.shouldSnapCamera=!0,this.resetAccumulation())}registerRenderer(t){this.renderer=t}resolveLightPosition(t,o){return this.virtualSpace.resolveRealWorldPosition(t,o,this.sceneCtrl.getCamera())}updateConfigInternal(t){var i;if(this.markInteraction(),t.quality&&this.pipeline.updateQuality(t.quality),((i=t.quality)==null?void 0:i.accumulation)!==void 0&&this.pipeline.setAccumulationEnabled(t.quality.accumulation),!this.isBooted){this.configManager.update(t,this.state);return}const{rebuildNeeded:o,uniformUpdate:r,modeChanged:n}=this.configManager.update(t,this.state);if(t.maxSteps!==void 0&&this.setUniform("uMaxSteps",t.maxSteps),n){const s=this.configManager.config.renderMode,l=this.materials.getMaterial(s||"Direct");this.sceneCtrl.setMaterial(l),this.resetAccumulation(),le.emit(Fe.SHADER_CODE,this.materials.getLastFrag())}o?this.scheduleCompile():(this._isCompiling||le.emit(Fe.IS_COMPILING,!1),r?(this.materials.syncConfigUniforms(this.configManager.config),this.configManager.config.pipeline&&this.materials.syncModularUniforms(this.configManager.config.pipeline),this.resetAccumulation()):Object.keys(t).length>0&&this.resetAccumulation())}scheduleCompile(){console.log("FractalEngine: scheduleCompile called"),this.compileTimer&&clearTimeout(this.compileTimer),this._isCompiling=!0,le.emit(Fe.IS_COMPILING,"Compiling Shader..."),(async()=>{for(await new Promise(o=>requestAnimationFrame(o));!this.renderer;)await new Promise(o=>setTimeout(o,50));this.performCompilation()})()}async performCompilation(){if(console.log("FractalEngine: performCompilation started"),!this.renderer){console.log("FractalEngine: No renderer available");return}const t=performance.now();(this.mainUniforms.uResolution.value.x===0||this.mainUniforms.uResolution.value.y===0)&&this.mainUniforms.uResolution.value.set(1024,768),console.log("FractalEngine: Resizing pipeline to",this.mainUniforms.uResolution.value.x,"x",this.mainUniforms.uResolution.value.y),this.pipeline.resize(Math.floor(this.mainUniforms.uResolution.value.x),Math.floor(this.mainUniforms.uResolution.value.y)),console.log("FractalEngine: Updating materials"),this.materials.updateConfig(this.configManager.config),this.materials.syncConfigUniforms(this.configManager.config),this.configManager.config.pipeline&&this.materials.syncModularUniforms(this.configManager.config.pipeline),await new Promise(l=>setTimeout(l,0));const o=this.configManager.config.renderMode||"Direct",r=this.materials.getMaterial(o);this.sceneCtrl.setMaterial(r),this.resetAccumulation();const n=o==="Direct"?this.materials.materialDirect:this.materials.materialPT;!this.hasCompiledShader||n.needsUpdate?(console.log("FractalEngine: Triggering GPU shader compilation"),this.pipeline.render(this.renderer),await new Promise(l=>setTimeout(l,20)),this.pipeline.render(this.renderer),await new Promise(l=>setTimeout(l,50)),this.hasCompiledShader=!0,n.needsUpdate=!1):console.log("FractalEngine: Shader unchanged - skipping GPU compilation"),this._isCompiling=!1,this.compileTimer=null;const s=(performance.now()-t)/1e3;this.lastCompileDuration=s,console.log(`[Shader Compiled] Time: ${s.toFixed(3)}s`),le.emit(Fe.IS_COMPILING,!1),s>.1&&le.emit(Fe.COMPILE_TIME,s),le.emit(Fe.SHADER_CODE,this.materials.getLastFrag()),console.log("FractalEngine: performCompilation completed")}setUniform(t,o,r=!1){this.materials.setUniform(t,o),this.configManager.syncUniform(t,o),r||this.resetAccumulation()}setRenderState(t){var o,r;Object.assign(this.state,t),t.quality&&this.pipeline.updateQuality(t.quality),((o=t.bucketConfig)==null?void 0:o.accumulation)!==void 0&&this.pipeline.setAccumulationEnabled(t.bucketConfig.accumulation),((r=t.quality)==null?void 0:r.accumulation)!==void 0&&this.pipeline.setAccumulationEnabled(t.quality.accumulation)}update(t,o,r,n=!1){var g;if(!this.isBooted||this.state.isExporting)return;n&&this.markInteraction(),this._totalFrames++,this.mainUniforms[ce.FrameCount].value=this._totalFrames,this.renderer&&this.state.isBucketRendering&&It.update(this.renderer,this.state.bucketConfig);const i=((g=this.state.optics)==null?void 0:g.camFov)??60,s=this.state.cameraMode==="Orbit";this.virtualSpace.updateSmoothing(t,i,o,s,this.shouldSnapCamera,n),this.shouldSnapCamera&&(this.shouldSnapCamera=!1,this.pipeline.resetAccumulation());const l=this.sceneOffset,d=this.lastRenderState.offset,c=Math.abs(l.x-d.x)>1e-9||Math.abs(l.y-d.y)>1e-9||Math.abs(l.z-d.z)>1e-9,f=this.virtualSpace.smoothedPos,u=this.virtualSpace.smoothedQuat,p=this.virtualSpace.smoothedFov;(f.distanceToSquared(this.lastRenderState.pos)>1e-4||u.angleTo(this.lastRenderState.quat)>.001||Math.abs(p-this.lastRenderState.fov)>.1||c||this.dirty)&&(this.pipeline.resetAccumulation(),this.dirty=!1,this.lastRenderState.pos.copy(f),this.lastRenderState.quat.copy(u),this.lastRenderState.offset={...l},this.lastRenderState.fov=p);const h=t;this.sceneCtrl.updateFallback(f,u,p,h.aspect),this.syncFrame(this.sceneCtrl.fallbackCamera,r)}compute(t){var i;if(!this.isBooted||this._isCompiling||this.state.isExporting||this.isPaused&&!this.state.isBucketRendering&&performance.now()-this.lastInteractionTime>1e3)return;const o=(((i=this.state.optics)==null?void 0:i.dofStrength)??0)>1e-4,r=this.pipeline.isHolding,n=!o&&(this.state.isCameraInteracting||this.state.isGizmoInteracting);if(this.pipeline.setHold(n),n&&!r&&this.pipeline.resetAccumulation(),this.pipeline.accumulationCount>1){const s=this.pipeline.accumulationCount%Qa.length,l=Qa[s];this.jitterVec.copy(l),this.mainUniforms.uJitter.value.copy(this.jitterVec)}else this.mainUniforms.uJitter.value.set(0,0);this.pipeline.render(t)}render(t){this.compute(t);const o=this.pipeline.getOutputTexture();o&&(this.materials.displayMaterial.uniforms.map.value=o,t.setRenderTarget(null),t.render(this.sceneCtrl.displayScene,this.sceneCtrl.mainCamera))}async captureSnapshot(){if(!this.renderer)return null;const t=this.pipeline.getOutputTexture();if(!t)return null;const o=t.image.width,r=t.image.height,n=new ft(o,r,{type:so,format:at,stencilBuffer:!1,depthBuffer:!1,minFilter:ct,magFilter:ct}),i=this.renderer.getRenderTarget();this.renderer.setRenderTarget(n),this.renderer.clear(),this.materials.displayMaterial.uniforms.map.value=t,this.materials.displayMaterial.uniforms.uResolution.value.set(o,r);const s=this.materials.displayMaterial.uniforms.uEncodeOutput.value;this.materials.displayMaterial.uniforms.uEncodeOutput.value=1,this.renderer.render(this.sceneCtrl.displayScene,this.sceneCtrl.mainCamera);const l=new Uint8Array(o*r*4);this.renderer.readRenderTargetPixels(n,0,0,o,r,l),this.renderer.setRenderTarget(i),this.materials.displayMaterial.uniforms.uEncodeOutput.value=s,n.dispose();const d=document.createElement("canvas");d.width=o,d.height=r;const c=d.getContext("2d");if(!c)return null;const f=c.createImageData(o,r),u=o*4;for(let p=0;p<r;p++){const h=p*u,g=(r-1-p)*u;f.data.set(l.subarray(h,h+u),g)}return c.putImageData(f,0,0),new Promise(p=>d.toBlob(p,"image/png"))}syncFrame(t,o){!this.state.optics&&!this.state.lighting||this.uniformManager.syncFrame(t,o,this.renderer,this.state,this.state.optics||{},this.state.lighting||{},this.modulations,this.materials)}measureDistanceAtScreenPoint(t,o,r,n){return this.pickingCtrl.measureDistance(t,o,r,n)}pickWorldPosition(t,o){return!this.renderer||!this.activeCamera?null:this.pickingCtrl.pickWorldPosition(t,o,this.renderer,this.activeCamera)}getWebGLProgram(t){if(!this.renderer)return null;const o=this.renderer.properties,r=Array.isArray(t)?t[0]:t,n=o.get(r);return n&&(n.program||n.currentProgram)||null}getCompiledFragmentShader(){if(!this.renderer)return null;const t=this.sceneCtrl.mainMesh;if(!t||!t.material)return null;const o=this.getWebGLProgram(t.material);if(!o)return null;const r=this.renderer.getContext();if(o.fragmentShader){if(typeof o.fragmentShader=="object")return r.getShaderSource(o.fragmentShader);if(typeof o.fragmentShader=="string")return o.fragmentShader}return null}getTranslatedFragmentShader(){if(!this.renderer)return null;const o=this.renderer.getContext().getExtension("WEBGL_debug_shaders");if(!o)return null;const r=this.sceneCtrl.mainMesh;if(!r||!r.material)return null;const n=this.getWebGLProgram(r.material);if(!n||!n.fragmentShader)return null;const i=typeof n.fragmentShader=="object"?n.fragmentShader:null;return i?o.getTranslatedShaderSource(i):null}checkHalfFloatAlphaSupport(){try{const t=document.createElement("canvas");t.width=1,t.height=1;let o=t.getContext("webgl2"),r;if(o)r=o.HALF_FLOAT;else{if(o=t.getContext("webgl"),!o)return!1;const d=o.getExtension("OES_texture_half_float");if(!d)return!1;r=d.HALF_FLOAT_OES}const n=o.createTexture();o.bindTexture(o.TEXTURE_2D,n),o.texImage2D(o.TEXTURE_2D,0,o.RGBA,1,1,0,o.RGBA,r,null);const i=o.createFramebuffer();o.bindFramebuffer(o.FRAMEBUFFER,i),o.framebufferTexture2D(o.FRAMEBUFFER,o.COLOR_ATTACHMENT0,o.TEXTURE_2D,n,0);const l=o.checkFramebufferStatus(o.FRAMEBUFFER)===o.FRAMEBUFFER_COMPLETE;return o.deleteFramebuffer(i),o.deleteTexture(n),console.log(`[GMT] HalfFloat16 Alpha Support: ${l?"YES":"NO"}`),l}catch(t){return console.warn("[GMT] HalfFloat alpha support check failed:",t),!1}}}const B=new bl,vl={id:"cam_main",label:"Main Camera",position:{x:0,y:0,z:0},rotation:{x:0,y:0,z:0,w:1},sceneOffset:{x:0,y:0,z:3.5,xL:0,yL:0,zL:0},targetDistance:3.5,optics:{camType:0,camFov:60,orthoScale:2,dofStrength:0,dofFocus:10}},wl=(a,t)=>({cameraMode:"Orbit",sceneOffset:{x:0,y:0,z:1,xL:0,yL:0,zL:-.24751033974403658},cameraPos:{x:0,y:0,z:0},cameraRot:{x:0,y:0,z:0,w:1},targetDistance:3.5,undoStack:[],redoStack:[],savedCameras:[vl],activeCameraId:"cam_main",setCameraMode:o=>a({cameraMode:o}),setSceneOffset:o=>{const r={x:o.x,y:o.y,z:o.z,xL:o.xL||0,yL:o.yL||0,zL:o.zL||0};B.virtualSpace.state=r,a({sceneOffset:B.virtualSpace.state}),le.emit("offset_set",B.virtualSpace.state)},addCamera:o=>{const r=t();let n;B.activeCamera?n=B.virtualSpace.getUnifiedCameraState(B.activeCamera,B.lastMeasuredDistance):n={position:r.cameraPos,rotation:r.cameraRot,sceneOffset:r.sceneOffset,targetDistance:r.targetDistance};const i={...r.optics},s=o||`Camera ${r.savedCameras.length+1}`,l={id:tt(),label:s,position:n.position,rotation:n.rotation,sceneOffset:n.sceneOffset,targetDistance:n.targetDistance,optics:i};a(d=>({savedCameras:[...d.savedCameras,l],activeCameraId:l.id}))},updateCamera:(o,r)=>{a(n=>({savedCameras:n.savedCameras.map(i=>i.id===o?{...i,...r}:i)}))},deleteCamera:o=>{a(r=>({savedCameras:r.savedCameras.filter(i=>i.id!==o),activeCameraId:r.activeCameraId===o?null:r.activeCameraId}))},selectCamera:o=>{const r=t(),n=r.activeCameraId;if(n&&B.activeCamera){const l=B.virtualSpace.getUnifiedCameraState(B.activeCamera,B.lastMeasuredDistance);r.savedCameras.some(d=>d.id===n)&&a(d=>({savedCameras:d.savedCameras.map(c=>c.id===n?{...c,position:l.position,rotation:l.rotation,sceneOffset:l.sceneOffset,targetDistance:l.targetDistance}:c)}))}if(o===null){a({activeCameraId:null});return}const s=t().savedCameras.find(l=>l.id===o);if(s){if(B.activeCamera&&(B.virtualSpace.applyCameraState(B.activeCamera,s),le.emit("camera_teleport",s)),a({activeCameraId:o,cameraPos:s.position,cameraRot:s.rotation,sceneOffset:s.sceneOffset,targetDistance:s.targetDistance||3.5}),s.optics){const l=r.setOptics;l&&l(s.optics)}B.resetAccumulation()}},resetCamera:()=>{a({activeCameraId:null});const o=t().formula,r=Le.get(o),n=r==null?void 0:r.defaultPreset,i=(n==null?void 0:n.sceneOffset)||{x:0,y:0,z:0,xL:0,yL:0,zL:0},s=(n==null?void 0:n.cameraPos)||{x:0,y:0,z:3.5},l=(n==null?void 0:n.cameraRot)||{x:0,y:0,z:0,w:1},d=(n==null?void 0:n.targetDistance)||3.5,c=i.x+i.xL+s.x,f=i.y+i.yL+s.y,u=i.z+i.zL+s.z,p=Ae.split(c),h=Ae.split(f),g=Ae.split(u),M={x:p.high,y:h.high,z:g.high,xL:p.low,yL:h.low,zL:g.low};if(t().setSceneOffset(M),a({cameraPos:{x:0,y:0,z:0},cameraRot:l,targetDistance:d}),B.activeCamera){B.activeCamera.position.set(0,0,0),B.activeCamera.quaternion.set(l.x,l.y,l.z,l.w),B.activeCamera.updateMatrixWorld(),B.virtualSpace.state=M;const m={position:{x:0,y:0,z:0},rotation:l,sceneOffset:M,targetDistance:d};le.emit("reset_accum",void 0),le.emit("camera_teleport",m)}},undoCamera:()=>{const{undoStack:o,redoStack:r}=t();if(o.length===0)return;const n=o[o.length-1];if(B.activeCamera){const i=B.virtualSpace.getUnifiedCameraState(B.activeCamera,t().targetDistance);B.virtualSpace.applyCameraState(B.activeCamera,n),n.sceneOffset&&a({sceneOffset:n.sceneOffset}),a({cameraPos:n.position,cameraRot:n.rotation,targetDistance:n.targetDistance||3.5,redoStack:[...r,i],undoStack:o.slice(0,-1)}),le.emit("reset_accum",void 0),le.emit("camera_teleport",n)}},redoCamera:()=>{const{undoStack:o,redoStack:r}=t();if(r.length===0)return;const n=r[r.length-1];if(B.activeCamera){const i=B.virtualSpace.getUnifiedCameraState(B.activeCamera,t().targetDistance);B.virtualSpace.applyCameraState(B.activeCamera,n),n.sceneOffset&&a({sceneOffset:n.sceneOffset}),a({cameraPos:n.position,cameraRot:n.rotation,targetDistance:n.targetDistance||3.5,undoStack:[...o,i],redoStack:r.slice(0,-1)}),le.emit("reset_accum",void 0),le.emit("camera_teleport",n)}}}),Sl=a=>{const t={formula:a.formula,pipeline:a.pipeline,renderRegion:a.renderRegion?{...a.renderRegion}:null};return ve.getAll().forEach(r=>{const n=a[r.id];n&&(t[r.id]=JSON.parse(JSON.stringify(n)))}),t},Yo=(a,t,o)=>{const r=o();t(a),Object.keys(a).forEach(n=>{const i=n,s=a[i];if(i==="formula"){le.emit("config",{formula:s});return}const l="set"+i.charAt(0).toUpperCase()+i.slice(1);if(typeof r[l]=="function"){r[l](s);return}if(i==="pipeline"){r.setPipeline(s);return}if(i==="graph"){r.setGraph(s);return}const d="set"+i.charAt(0).toUpperCase()+i.slice(1);typeof r[d]=="function"&&!ve.get(i)&&r[d](s)}),B.resetAccumulation()},Ml=(a,t)=>({paramUndoStack:[],paramRedoStack:[],interactionSnapshot:null,handleInteractionStart:o=>{if(a({isUserInteracting:!0}),o&&typeof o=="object"&&o.position){const n=o;a(i=>({undoStack:[...i.undoStack,n],redoStack:[]}));return}const r=Sl(t());a({interactionSnapshot:r})},handleInteractionEnd:()=>{a({isUserInteracting:!1});const{interactionSnapshot:o,aaMode:r,aaLevel:n,msaaSamples:i,dpr:s}=t();let l=r==="Auto"||r==="Always"?n:1;if(Math.abs(s-l)>1e-4&&(a({dpr:l}),le.emit("config",{msaaSamples:r==="Auto"||r==="Always"?i:1}),le.emit("reset_accum",void 0)),!o)return;const d=t(),c={};let f=!1;Object.keys(o).forEach(u=>{const p=u,h=o[p],g=d[p];JSON.stringify(h)!==JSON.stringify(g)&&(c[p]=h,f=!0)}),a(f?u=>({paramUndoStack:[...u.paramUndoStack,c],paramRedoStack:[],interactionSnapshot:null}):{interactionSnapshot:null})},undoParam:()=>{const{paramUndoStack:o,paramRedoStack:r}=t();if(o.length===0)return;const n=o[o.length-1],i=o.slice(0,-1),s=t(),l={};Object.keys(n).forEach(d=>{l[d]=s[d]}),Yo(n,a,t),a({paramUndoStack:i,paramRedoStack:[...r,l]})},redoParam:()=>{const{paramUndoStack:o,paramRedoStack:r}=t();if(r.length===0)return;const n=r[r.length-1],i=r.slice(0,-1),s=t(),l={};Object.keys(n).forEach(d=>{l[d]=s[d]}),Yo(n,a,t),a({paramUndoStack:[...o,l],paramRedoStack:i})},resetParamHistory:()=>{a({paramUndoStack:[],paramRedoStack:[],interactionSnapshot:null})}}),Cl=(a,t)=>{const o={};return ve.getAll().forEach(n=>{const i={},s={};n.state&&Object.assign(i,n.state),Object.entries(n.params).forEach(([d,c])=>{c.composeFrom?c.composeFrom.forEach(f=>{s[f]=d}):i[d]===void 0&&(i[d]=c.default)}),o[n.id]=i;const l=`set${n.id.charAt(0).toUpperCase()+n.id.slice(1)}`;o[l]=d=>{let c=!1;const f={};a(u=>{const p=u[n.id],h={...d};Object.keys(d).forEach(m=>{const y=n.params[m];if(y){const x=d[m];if(x==null)return;y.type==="vec2"&&!(x instanceof Se)&&(h[m]=new Se(x.x,x.y)),y.type==="vec3"&&!(x instanceof ie)&&(h[m]=new ie(x.x,x.y,x.z)),y.type==="color"&&!(x instanceof $e)&&(typeof x=="string"?h[m]=new $e(x):typeof x=="number"?h[m]=new $e(x):typeof x=="object"&&"r"in x&&(h[m]=new $e(x.r,x.g,x.b)))}});const g={...p,...h},M=new Set;return Object.keys(h).forEach(m=>{const y=n.params[m];if(s[m]&&M.add(s[m]),y&&(y.noReset||(c=!0),y.onUpdate==="compile"&&(f[n.id]||(f[n.id]={}),f[n.id][m]=g[m]),y.uniform)){const x=g[m];if(y.type==="image")x&&typeof x=="string"?new io().load(x,k=>{const S=y.textureSettings||{};S.wrapS&&(k.wrapS=S.wrapS),S.wrapT&&(k.wrapT=S.wrapT),S.minFilter&&(k.minFilter=S.minFilter),S.magFilter&&(k.magFilter=S.magFilter),k.needsUpdate=!0,le.emit("uniform",{key:y.uniform,value:k,noReset:!!y.noReset})}):le.emit("uniform",{key:y.uniform,value:null,noReset:!!y.noReset});else if(y.type==="gradient"){const C=Ta(x);le.emit("uniform",{key:y.uniform,value:{isGradientBuffer:!0,buffer:C},noReset:!!y.noReset})}else{let C=x;y.type==="boolean"&&(C=x?1:0),y.type==="color"&&!(C instanceof $e)&&(C=new $e(C)),le.emit("uniform",{key:y.uniform,value:C,noReset:!!y.noReset})}}}),M.forEach(m=>{const y=n.params[m];if(y&&y.composeFrom&&y.uniform){const x=y.composeFrom.map(C=>g[C]);if(y.type==="gradient"){const C=g[m];if(C){const k=Ta(C);le.emit("uniform",{key:y.uniform,value:{isGradientBuffer:!0,buffer:k},noReset:!!y.noReset}),y.noReset||(c=!0)}}else if(y.type==="vec2"){const C=new Se(x[0],x[1]);le.emit("uniform",{key:y.uniform,value:C,noReset:!!y.noReset}),y.noReset||(c=!0)}else if(y.type==="vec3"){const C=new ie(x[0],x[1],x[2]);le.emit("uniform",{key:y.uniform,value:C,noReset:!!y.noReset}),y.noReset||(c=!0)}}}),{[n.id]:g}}),Object.keys(f).length>0&&le.emit("config",f),c&&le.emit("reset_accum",void 0)},n.actions&&Object.entries(n.actions).forEach(([d,c])=>{o[d]=f=>{const p=t()[n.id],h=c(p,f);h&&Object.keys(h).length>0&&(a({[n.id]:{...p,...h}}),le.emit("reset_accum",void 0))}})}),o};class Ja{constructor(t,o=null){Z(this,"defaultState");Z(this,"dictionary");Z(this,"reverseDictCache",new Map);this.defaultState=t,this.dictionary=o}encode(t,o=!1){try{const r=this.getDiff(t,this.defaultState);if(!r||Object.keys(r).length===0)return"";let n=this.quantize(r);if(!n||Object.keys(n).length===0)return"";this.dictionary&&(n=this.applyDictionary(n,this.dictionary,!0));const i=JSON.stringify(n);o&&(console.group("UrlStateEncoder: Debug Output"),console.log("Input State:",t),console.log("Minified JSON:",i),console.groupEnd());const s=Fo.deflate(i),l=Array.from(s).map(c=>String.fromCharCode(c)).join("");return btoa(l).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"")}catch(r){return console.error("UrlStateEncoder: Error encoding",r),""}}decode(t){try{if(!t)return null;let o=t.replace(/-/g,"+").replace(/_/g,"/");for(;o.length%4;)o+="=";const r=atob(o),n=new Uint8Array(r.length);for(let l=0;l<r.length;l++)n[l]=r.charCodeAt(l);const i=Fo.inflate(n,{to:"string"});let s=JSON.parse(i);return this.dictionary&&(s=this.applyDictionary(s,this.dictionary,!1)),this.deepMerge({...this.defaultState},s)}catch(o){return console.error("UrlStateEncoder: Error decoding",o),null}}getReverseDict(t){if(this.reverseDictCache.has(t))return this.reverseDictCache.get(t);const o={};return Object.keys(t).forEach(r=>{const n=t[r];typeof n=="string"?o[n]=r:o[n._alias]=r}),this.reverseDictCache.set(t,o),o}applyDictionary(t,o,r){if(!t||typeof t!="object"||Array.isArray(t))return t;const n={};if(r)Object.keys(t).forEach(i=>{let s=i,l=null;const d=o[i];d&&(typeof d=="string"?s=d:(s=d._alias,l=d.children));const c=t[i];l&&c&&typeof c=="object"&&!Array.isArray(c)?n[s]=this.applyDictionary(c,l,!0):n[s]=c});else{const i=this.getReverseDict(o);Object.keys(t).forEach(s=>{const l=i[s]||s,d=t[s],c=o[l],f=c&&typeof c=="object"?c.children:null;f&&d&&typeof d=="object"&&!Array.isArray(d)?n[l]=this.applyDictionary(d,f,!1):n[l]=d})}return n}isEqual(t,o){if(t===o)return!0;if(t==null||o==null)return t===o;if(typeof t=="number"&&typeof o=="number")return Math.abs(t-o)<1e-4;if(Array.isArray(t)&&Array.isArray(o))return t.length!==o.length?!1:t.every((r,n)=>this.isEqual(r,o[n]));if(typeof t=="object"&&typeof o=="object"){const r=Object.keys(t).filter(i=>!i.startsWith("is")),n=Object.keys(o).filter(i=>!i.startsWith("is"));return r.length!==n.length?!1:r.every(i=>this.isEqual(t[i],o[i]))}return!1}quantize(t){if(typeof t=="string")return t.startsWith("data:image")?void 0:t;if(typeof t=="number")return t===0||Math.abs(t)<1e-9?0:parseFloat(t.toFixed(5));if(Array.isArray(t))return t.map(o=>this.quantize(o));if(t!==null&&typeof t=="object"){const o={};let r=!1;const n=Object.keys(t).filter(i=>!i.startsWith("is"));for(const i of n){const s=this.quantize(t[i]);s!==void 0&&(o[i]=s,r=!0)}return r?o:void 0}return t}getDiff(t,o){if(this.isEqual(t,o))return;if(typeof t!="object"||t===null||typeof o!="object"||o===null||Array.isArray(t))return t;const r={};let n=!1;return Object.keys(t).forEach(i=>{if(i.startsWith("is")||i==="histogramData"||i==="interactionSnapshot"||i==="liveModulations"||i.endsWith("Stack"))return;const s=this.getDiff(t[i],o[i]);s!==void 0&&(r[i]=s,n=!0)}),n?r:void 0}deepMerge(t,o){if(typeof o!="object"||o===null)return o;const r={...t};return Object.keys(o).forEach(n=>{typeof o[n]=="object"&&o[n]!==null&&!Array.isArray(o[n])?r[n]=this.deepMerge(t[n]||{},o[n]):r[n]=o[n]}),r}}const Ha=a=>{const t={};return a&&Object.keys(a).forEach(o=>{if(o.startsWith("is"))return;const r=a[o];r&&typeof r=="object"&&r.isColor?t[o]="#"+r.getHexString():r&&typeof r=="object"&&(r.isVector2||r.isVector3)?(t[o]={...r},delete t[o].isVector2,delete t[o].isVector3):t[o]=r}),t},yn=a=>{const t=Le.get(a),o=t&&t.defaultPreset?t.defaultPreset:{},r={version:5,name:a,formula:a,features:{}};return ve.getAll().forEach(n=>{const i={};Object.entries(n.params).forEach(([s,l])=>{l.composeFrom||(i[s]=l.default)}),r.features[n.id]=Ha(i)}),o.features&&Object.entries(o.features).forEach(([n,i])=>{r.features[n]?r.features[n]={...r.features[n],...Ha(i)}:r.features[n]=Ha(i)}),o.lights&&(r.features.lighting||(r.features.lighting={}),r.features.lighting.lights=o.lights),o.renderMode&&(r.features.lighting||(r.features.lighting={}),r.features.lighting.renderMode=o.renderMode==="PathTracing"?1:0),r.cameraMode=o.cameraMode||"Orbit",r.quality={aaMode:"Always",aaLevel:1,msaa:1,accumulation:!0,...o.quality||{}},r.lights=[],r.animations=o.animations||[],r.navigation={flySpeed:.5,autoSlow:!0,...o.navigation||{}},r.sceneOffset=o.sceneOffset||{x:0,y:0,z:0,xL:0,yL:0,zL:0},r.cameraPos=o.cameraPos||{x:0,y:0,z:3.5},r.cameraRot=o.cameraRot||{x:0,y:0,z:0,w:1},r.targetDistance=o.targetDistance||3.5,r.duration=o.duration||300,r.sequence=o.sequence||{durationFrames:300,fps:30,tracks:{}},r},kl=(a,t,o)=>{const r=o(),n=a.features||{};if(a.renderMode&&(n.lighting||(n.lighting={}),n.lighting.renderMode===void 0&&(n.lighting.renderMode=a.renderMode==="PathTracing"?1:0)),n.atmosphere&&!n.ao){const y={};n.atmosphere.aoIntensity!==void 0&&(y.aoIntensity=n.atmosphere.aoIntensity),n.atmosphere.aoSpread!==void 0&&(y.aoSpread=n.atmosphere.aoSpread),n.atmosphere.aoMode!==void 0&&(y.aoMode=n.atmosphere.aoMode),n.atmosphere.aoEnabled!==void 0&&(y.aoEnabled=n.atmosphere.aoEnabled),Object.keys(y).length>0&&(n.ao=y)}if(ve.getAll().forEach(y=>{const x=`set${y.id.charAt(0).toUpperCase()+y.id.slice(1)}`,C=r[x];if(typeof C=="function"){const k=n[y.id],S={};if(y.state&&Object.assign(S,y.state),Object.entries(y.params).forEach(([b,w])=>{if(k&&k[b]!==void 0){let j=k[b];w.type==="vec2"&&j&&!(j instanceof Se)?j=new Se(j.x,j.y):w.type==="vec3"&&j&&!(j instanceof ie)?j=new ie(j.x,j.y,j.z):w.type==="color"&&j&&!(j instanceof $e)&&(j=new $e(j)),S[b]=j}else if(S[b]===void 0){let j=w.default;j&&typeof j=="object"&&(typeof j.clone=="function"?j=j.clone():Array.isArray(j)?j=[...j]:j={...j}),S[b]=j}}),y.id==="lighting"&&k){if(k.lights)S.lights=k.lights.map(b=>({...b,type:b.type||"Point",rotation:b.rotation||{x:0,y:0,z:0}}));else if(k.light0_posX!==void 0){const b=[];for(let w=0;w<3;w++)if(k[`light${w}_posX`]!==void 0){let j=k[`light${w}_color`]||"#ffffff";j.getHexString&&(j="#"+j.getHexString()),b.push({type:"Point",position:{x:k[`light${w}_posX`],y:k[`light${w}_posY`],z:k[`light${w}_posZ`]},rotation:{x:0,y:0,z:0},color:j,intensity:k[`light${w}_intensity`]??1,falloff:k[`light${w}_falloff`]??0,falloffType:k[`light${w}_type`]?"Linear":"Quadratic",fixed:k[`light${w}_fixed`]??!1,visible:k[`light${w}_visible`]??w===0,castShadow:k[`light${w}_castShadow`]??!0})}b.length>0&&(S.lights=b)}}y.id==="materials"&&k&&k.envMapVisible!==void 0&&k.envBackgroundStrength===void 0&&(S.envBackgroundStrength=k.envMapVisible?1:0),C(S)}}),a.lights&&a.lights.length>0&&r.setLighting){const y=a.lights.map(x=>({...x,type:x.type||"Point",rotation:x.rotation||{x:0,y:0,z:0}}));r.setLighting({lights:y})}a.sequence&&xe.getState().setSequence(a.sequence),r.setAnimations(a.animations||[]);const i=a.cameraPos||{x:0,y:0,z:3.5},s=a.sceneOffset||{x:0,y:0,z:0,xL:0,yL:0,zL:0},l=a.targetDistance||3.5,d=a.cameraRot||{x:0,y:0,z:0,w:1},c=s.x+s.xL+i.x,f=s.y+s.yL+i.y,u=s.z+s.zL+i.z,p=Ae.split(c),h=Ae.split(f),g=Ae.split(u),M={x:p.high,y:h.high,z:g.high,xL:p.low,yL:h.low,zL:g.low},m={x:0,y:0,z:0};t({cameraPos:m,cameraRot:d,targetDistance:l,sceneOffset:M,cameraMode:a.cameraMode||o().cameraMode}),B.activeCamera&&B.virtualSpace.applyCameraState(B.activeCamera,{position:m,rotation:d,sceneOffset:M,targetDistance:l}),le.emit("camera_teleport",{position:m,rotation:d,sceneOffset:M,targetDistance:l}),a.duration&&xe.getState().setDuration(a.duration),a.formula==="Modular"&&r.refreshPipeline(),r.refreshHistogram(),le.emit("reset_accum",void 0)},jl={formula:"Mandelbulb",cameraPos:{x:0,y:0,z:0},cameraRot:{x:0,y:0,z:0,w:1},sceneOffset:{x:0,y:0,z:0,xL:0,yL:0,zL:0},targetDistance:3.5,cameraMode:"Orbit"},Tl=(a,t,o={includeAnimations:!0})=>{try{a.quality&&(delete a.quality.aaLevel,delete a.quality.aaMode,delete a.quality.msaa),a.features&&a.features.quality&&delete a.features.quality.resolutionMode,o.includeAnimations===!1&&(delete a.sequence,delete a.animations);const r=yn(a.formula);r.formula="";const n=ve.getDictionary();return new Ja(r,n).encode(a,t)}catch(r){return console.error("Sharing: Failed to generate share string",r),""}},fo=a=>{if(!a)return null;try{const t=ve.getDictionary(),r=new Ja(jl,t).decode(a);if(r&&r.formula){const n=yn(r.formula);return new Ja(n,t).decode(a)}}catch(t){console.error("Sharing: Failed to load share string",t)}return null},Pl=(a,t)=>{const o={};a.forEach(s=>o[s.id]=[]),t.forEach(s=>{o[s.source]&&o[s.source].push(s.target)});const r=new Set,n=new Set,i=s=>{if(!r.has(s)){r.add(s),n.add(s);const l=o[s]||[];for(const d of l)if(!r.has(d)&&i(d)||n.has(d))return!0}return n.delete(s),!1};for(const s of a)if(i(s.id))return!0;return!1},Vo=(a,t)=>{const o={},r={};a.forEach(s=>{o[s.id]=[],r[s.id]=0}),t.forEach(s=>{o[s.source]&&(o[s.source].push(s.target),r[s.target]=(r[s.target]||0)+1)});const n=[];a.forEach(s=>{r[s.id]===0&&n.push(s.id)});const i=[];for(;n.length>0;){n.sort();const s=n.shift(),l=a.find(d=>d.id===s);if(l){const{position:d,...c}=l;i.push(c)}if(o[s])for(const d of o[s])r[d]--,r[d]===0&&n.push(d)}return i},Zo=a=>{const t=a.map((r,n)=>({...r,position:{x:250,y:150+n*200}})),o=[];if(t.length>0){o.push({id:`e-root-start-${t[0].id}`,source:"root-start",target:t[0].id});for(let r=0;r<t.length-1;r++)o.push({id:`e-${t[r].id}-${t[r+1].id}`,source:t[r].id,target:t[r+1].id});o.push({id:`e-${t[t.length-1].id}-root-end`,source:t[t.length-1].id,target:"root-end"})}return{nodes:t,edges:o}},Rl=(a,t)=>{if(a.length!==t.length)return!1;for(let o=0;o<a.length;o++){const r=a[o],n=t[o];if(r.id!==n.id||r.type!==n.type||r.enabled!==n.enabled)return!1;const i=r.bindings||{},s=n.bindings||{},l=Object.keys(i).filter(u=>i[u]!==void 0),d=Object.keys(s).filter(u=>s[u]!==void 0);if(l.length!==d.length)return!1;for(const u of l)if(i[u]!==s[u])return!1;const c=r.condition||{active:!1,mod:0,rem:0},f=n.condition||{active:!1,mod:0,rem:0};if(c.active!==f.active||c.active&&(c.mod!==f.mod||c.rem!==f.rem))return!1}return!0},zl=(a,t)=>a.length!==t.length?!1:JSON.stringify(a)===JSON.stringify(t),Y=Pr()(Er((a,t,o)=>({...zi(a,t),...Ii(a,t),...wl(a,t),...Ml(a,t),...Cl(a,t),formula:"Mandelbulb",pipeline:Za,pipelineRevision:1,graph:Zo(Za),projectSettings:{name:"Mandelbulb",version:0},lastSavedHash:null,animations:[],liveModulations:{},setFormula:(r,n={})=>{const i=t(),s=i.formula;if(s===r&&r!=="Modular")return;n.skipDefaultPreset||t().resetParamHistory();const l=i.projectSettings.name;let d=l;if((l===s||l==="Untitled"||l==="Custom Preset")&&(d=r),a({formula:r,projectSettings:{...i.projectSettings,name:d}}),le.emit(Fe.CONFIG,{formula:r,pipeline:i.pipeline,graph:i.graph}),r!=="Modular"&&!n.skipDefaultPreset){const c=Le.get(r),f=c&&c.defaultPreset?JSON.parse(JSON.stringify(c.defaultPreset)):{formula:r},u=lo(t());if(u!=="custom"&&u!=="balanced"){const h=Lt[u];h&&(f.features||(f.features={}),Object.entries(h).forEach(([g,M])=>{f.features[g]||(f.features[g]={}),Object.assign(f.features[g],M)}))}if(t().lockSceneOnSwitch){const h=t().getPreset(),g={...h.features||{}},M=f.features||{};M.coreMath&&(g.coreMath=M.coreMath),M.geometry&&(g.geometry=M.geometry);const m={...h,formula:r,features:g};t().loadPreset(m)}else t().loadPreset(f)}t().handleInteractionEnd()},setProjectSettings:r=>a(n=>{const i={...n.projectSettings,...r};return r.name&&r.name!==n.projectSettings.name?(i.version=0,{projectSettings:i,lastSavedHash:null}):{projectSettings:i}}),prepareExport:()=>{const r=t(),n=r.getPreset({includeScene:!0}),{version:i,name:s,...l}=n,d=JSON.stringify(l);if(r.lastSavedHash===null||r.projectSettings.version===0){const c=Math.max(1,r.projectSettings.version+1);return a({projectSettings:{...r.projectSettings,version:c},lastSavedHash:d}),c}if(r.lastSavedHash!==d){const c=r.projectSettings.version+1;return a({projectSettings:{...r.projectSettings,version:c},lastSavedHash:d}),c}return r.projectSettings.version},setAnimations:r=>{const n=t().animations,i=r.map(s=>{const l=n.find(d=>d.id===s.id);if(!l)return s;if(s.period!==l.period&&s.period>0){const d=performance.now()/1e3,c=(d/l.period+l.phase-d/s.period)%1;return{...s,phase:(c+1)%1}}return s});a({animations:i})},setLiveModulations:r=>a({liveModulations:r}),setGraph:r=>{const n=Vo(r.nodes,r.edges),i=t();if(Rl(i.pipeline,n))zl(i.pipeline,n)?a({graph:r}):(a({graph:r,pipeline:n}),le.emit(Fe.CONFIG,{pipeline:n}));else if(i.autoCompile){const s=i.pipelineRevision+1;a({graph:r,pipeline:n,pipelineRevision:s}),le.emit(Fe.CONFIG,{pipeline:n,graph:r,pipelineRevision:s})}else a({graph:r})},setPipeline:r=>{const n=t().pipelineRevision+1,i=Zo(r);a({pipeline:r,graph:i,pipelineRevision:n}),le.emit(Fe.CONFIG,{pipeline:r,graph:i,pipelineRevision:n})},refreshPipeline:()=>{const r=t(),n=Vo(r.graph.nodes,r.graph.edges),i=r.pipelineRevision+1;a({pipeline:n,pipelineRevision:i}),le.emit(Fe.CONFIG,{pipeline:n,graph:r.graph,pipelineRevision:i})},loadPreset:r=>{t().resetParamHistory();const n=Le.get(r.formula),i=n?n.id:r.formula;a({formula:i}),le.emit(Fe.CONFIG,{formula:i});let s=r.name;(!s||s==="Untitled"||s==="Custom Preset")&&(s=i),a({projectSettings:{name:s,version:0},lastSavedHash:null}),kl(r,a,t),setTimeout(()=>{const l=t().getPreset({includeScene:!0}),{version:d,name:c,...f}=l;a({lastSavedHash:JSON.stringify(f)})},50)},getPreset:r=>{var l,d;const n=t(),i={version:n.projectSettings.version,name:n.projectSettings.name,formula:n.formula,features:{}};if((r==null?void 0:r.includeScene)!==!1){if(B.activeCamera){const c=B.virtualSpace.getUnifiedCameraState(B.activeCamera,n.targetDistance);i.cameraPos=c.position,i.cameraRot=c.rotation,i.sceneOffset=c.sceneOffset,i.targetDistance=c.targetDistance}else i.cameraPos=n.cameraPos,i.cameraRot=n.cameraRot,i.sceneOffset=n.sceneOffset,i.targetDistance=n.targetDistance;i.cameraMode=n.cameraMode,i.lights=[],i.renderMode=n.renderMode,i.quality={aaMode:n.aaMode,aaLevel:n.aaLevel,msaa:n.msaaSamples,accumulation:n.accumulation}}ve.getAll().forEach(c=>{const f=n[c.id];if(f){i.features||(i.features={});const u={};Object.keys(f).forEach(p=>{const h=f[p];h&&typeof h=="object"&&h.isColor?u[p]="#"+h.getHexString():h&&typeof h=="object"&&(h.isVector2||h.isVector3)?(u[p]={...h},delete u[p].isVector2,delete u[p].isVector3):u[p]=h}),i.features[c.id]=u}}),i.animations=n.animations,n.formula==="Modular"&&(i.graph=n.graph,i.pipeline=n.pipeline);try{const c=(d=(l=window.useAnimationStore)==null?void 0:l.getState)==null?void 0:d.call(l);c&&(i.sequence=c.sequence,i.duration=c.durationFrames)}catch(c){console.warn("Failed to save animation sequence:",c)}return i},getShareString:r=>{const n=t().getPreset({includeScene:!0}),i=t().advancedMode;return Tl(n,i,r)},loadShareString:r=>{const n=fo(r);return n?(t().loadPreset(n),!0):!1}}))),bn=a=>a.isUserInteracting||a.interactionMode!=="none",eo=a=>{var o;if(a.isGizmoDragging||a.interactionMode!=="none"||a.isExporting)return!0;const t=ve.getAll();for(const r of t)if((o=r.interactionConfig)!=null&&o.blockCamera&&r.interactionConfig.activeParam){const n=a[r.id];if(n&&n[r.interactionConfig.activeParam])return!0}return!1},vn=a=>{const t={formula:a.formula,pipeline:a.pipeline,pipelineRevision:a.pipelineRevision,graph:a.graph,msaaSamples:a.msaaSamples,previewMode:a.previewMode,renderMode:a.renderMode,compilerHardCap:a.compilerHardCap,shadows:!0,quality:a.quality};return ve.getAll().forEach(r=>{const n=a[r.id];n&&(t[r.id]=n)}),t},Fl=()=>{const a=Y.getState(),t=r=>B.setRenderState(r);t({isExporting:a.isExporting,isBucketRendering:a.isBucketRendering,cameraMode:a.cameraMode,optics:a.optics,lighting:a.lighting,quality:a.quality,bucketConfig:{bucketSize:a.bucketSize,bucketUpscale:a.bucketUpscale,convergenceThreshold:a.convergenceThreshold,accumulation:a.accumulation}}),B.isPaused=a.isPaused,B.setPreviewSampleCap(a.sampleCap),le.emit(Fe.CONFIG,vn(a)),Y.subscribe(r=>r.isExporting,r=>t({isExporting:r})),Y.subscribe(r=>r.isBucketRendering,r=>t({isBucketRendering:r})),Y.subscribe(r=>r.cameraMode,r=>t({cameraMode:r})),Y.subscribe(r=>r.lighting,r=>t({lighting:r})),Y.subscribe(r=>r.quality,r=>t({quality:r})),Y.subscribe(r=>r.isPaused,r=>{B.isPaused=r}),Y.subscribe(r=>r.sampleCap,r=>{B.setPreviewSampleCap(r)}),Y.subscribe(r=>[r.cameraPos,r.cameraRot,r.sceneOffset,r.targetDistance,r.optics],r=>{var u,p;const[n,i,s,l,d]=r,c=Y.getState(),f=(p=(u=window.useAnimationStore)==null?void 0:u.getState)==null?void 0:p.call(u).isPlaying;c.activeCameraId&&!f&&c.updateCamera(c.activeCameraId,{position:n,rotation:i,sceneOffset:s,targetDistance:l,optics:d})},{fireImmediately:!1,equalityFn:(r,n)=>JSON.stringify(r)===JSON.stringify(n)});const o=()=>{const r=Y.getState();t({bucketConfig:{bucketSize:r.bucketSize,bucketUpscale:r.bucketUpscale,convergenceThreshold:r.convergenceThreshold,accumulation:r.accumulation,samplesPerBucket:r.samplesPerBucket}})};Y.subscribe(r=>r.bucketSize,o),Y.subscribe(r=>r.bucketUpscale,o),Y.subscribe(r=>r.convergenceThreshold,o),Y.subscribe(r=>r.accumulation,o),Y.subscribe(r=>r.samplesPerBucket,o),Y.subscribe(r=>{var n;return(n=r.quality)==null?void 0:n.bufferPrecision},r=>{if(B.renderer){const n=B.renderer.domElement;B.pipeline.resize(n.width,n.height)}}),Y.subscribe(r=>{var n;return(n=r.lighting)==null?void 0:n.renderMode},r=>{const n=r===1?"PathTracing":"Direct";Y.getState().renderMode!==n&&Y.setState({renderMode:n})}),Y.subscribe(r=>r.optics,r=>t({optics:r})),le.on(Fe.BUCKET_STATUS,({isRendering:r})=>{Y.getState().setIsBucketRendering(r)})},Rt=()=>e.jsx("svg",{width:"14",height:"14",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:e.jsx("polyline",{points:"6 9 12 15 18 9"})}),wn=()=>e.jsx("svg",{width:"14",height:"14",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:e.jsx("polyline",{points:"18 15 12 9 6 15"})}),Ko=()=>e.jsx("svg",{width:"14",height:"14",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:e.jsx("polyline",{points:"15 18 9 12 15 6"})}),Xt=()=>e.jsx("svg",{width:"10",height:"10",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"3",strokeLinecap:"round",strokeLinejoin:"round",children:e.jsx("polyline",{points:"9 18 15 12 9 6"})}),Il=()=>e.jsx("svg",{width:"10",height:"10",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:e.jsx("polyline",{points:"9 18 15 12 9 6"})}),El=()=>e.jsx("svg",{width:"14",height:"14",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2.5",strokeLinecap:"round",strokeLinejoin:"round",children:e.jsx("path",{d:"M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"})}),Nl=()=>e.jsx("svg",{width:"100%",height:"100%",viewBox:"0 0 10 10",children:e.jsx("path",{d:"M 6 10 L 10 6 L 10 10 Z",fill:"currentColor",opacity:"0.5"})}),Sn=()=>e.jsxs("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("line",{x1:"4",y1:"9",x2:"20",y2:"9"}),e.jsx("line",{x1:"4",y1:"15",x2:"20",y2:"15"})]}),St=()=>e.jsx("svg",{width:"10",height:"10",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:e.jsx("path",{d:"M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"})}),Vt=()=>e.jsxs("svg",{width:"10",height:"10",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"3",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("line",{x1:"18",y1:"6",x2:"6",y2:"18"}),e.jsx("line",{x1:"6",y1:"6",x2:"18",y2:"18"})]}),po=()=>e.jsxs("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("line",{x1:"3",y1:"12",x2:"21",y2:"12"}),e.jsx("line",{x1:"3",y1:"6",x2:"21",y2:"6"}),e.jsx("line",{x1:"3",y1:"18",x2:"21",y2:"18"})]}),to=()=>e.jsxs("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("path",{d:"M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"}),e.jsx("path",{d:"M17 21v-8H7v8"}),e.jsx("path",{d:"M7 3v5h8"})]}),Qo=()=>e.jsxs("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("path",{d:"M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"}),e.jsx("polyline",{points:"7 10 12 15 17 10"}),e.jsx("line",{x1:"12",y1:"15",x2:"12",y2:"3"})]}),ho=()=>e.jsxs("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("circle",{cx:"12",cy:"12",r:"10"}),e.jsx("line",{x1:"12",cy:"16",x2:"12",y2:"12"}),e.jsx("line",{x1:"12",cy:"8",x2:"12.01",y2:"8"})]}),Mn=()=>e.jsxs("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("circle",{cx:"12",cy:"12",r:"10"}),e.jsx("path",{d:"M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"}),e.jsx("line",{x1:"12",y1:"17",x2:"12.01",y2:"17"})]}),Dl=()=>e.jsxs("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("path",{d:"M3 10h10a5 5 0 0 1 5 5v2"}),e.jsx("path",{d:"M7 6l-4 4 4 4"})]}),Ll=()=>e.jsxs("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("path",{d:"M21 10h-10a5 5 0 0 0 -5 5v2"}),e.jsx("path",{d:"M17 6l4 4 -4 4"})]}),Cn=()=>e.jsxs("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("path",{d:"M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"}),e.jsx("path",{d:"M3 3v5h5"})]}),xt=()=>e.jsx("svg",{width:"10",height:"10",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"3",strokeLinecap:"round",strokeLinejoin:"round",children:e.jsx("polyline",{points:"20 6 9 17 4 12"})}),mo=()=>e.jsxs("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2.5",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("path",{d:"M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"}),e.jsx("polyline",{points:"17 8 12 3 7 8"}),e.jsx("line",{x1:"12",y1:"3",x2:"12",y2:"15"})]}),kn=()=>e.jsxs("svg",{width:"14",height:"14",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("path",{d:"M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"}),e.jsx("polyline",{points:"7 10 12 15 17 10"}),e.jsx("line",{x1:"12",y1:"15",x2:"12",y2:"3"})]}),sa=()=>e.jsxs("svg",{width:"10",height:"10",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"4",children:[e.jsx("line",{x1:"12",y1:"5",x2:"12",y2:"19"}),e.jsx("line",{x1:"5",y1:"12",x2:"19",y2:"12"})]}),Zt=()=>e.jsx("svg",{width:"14",height:"14",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:e.jsx("path",{d:"M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"})}),Al=()=>e.jsxs("svg",{width:"64",height:"64",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"1.5",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("rect",{x:"5",y:"2",width:"14",height:"20",rx:"2",ry:"2"}),e.jsx("path",{d:"M12 18h.01"})]}),jn=({className:a})=>e.jsxs("svg",{className:a,xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",children:[e.jsx("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4"}),e.jsx("path",{className:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"})]}),_l=()=>e.jsxs("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("polyline",{points:"16 18 22 12 16 6"}),e.jsx("polyline",{points:"8 6 2 12 8 18"})]}),Bl=()=>e.jsxs("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("circle",{cx:"12",cy:"12",r:"10"}),e.jsx("path",{d:"M8 14s1.5 2 4 2 4-2 4-2"}),e.jsx("line",{x1:"9",y1:"9",x2:"9.01",y2:"9"}),e.jsx("line",{x1:"15",y1:"9",x2:"15.01",y2:"9"})]}),la=()=>e.jsxs("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("path",{d:"M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"}),e.jsx("polyline",{points:"3.27 6.96 12 12.01 20.73 6.96"}),e.jsx("line",{x1:"12",y1:"22.08",x2:"12",y2:"12"})]}),Jo=()=>e.jsxs("svg",{width:"10",height:"10",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2.5",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("rect",{x:"3",y:"3",width:"18",height:"18",rx:"2",strokeDasharray:"4 4"}),e.jsx("path",{d:"M9 12l2 2 4-4"})]}),Ol=()=>e.jsx("svg",{width:"14",height:"14",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:e.jsx("rect",{x:"3",y:"3",width:"18",height:"18",rx:"2",ry:"2"})}),$l=()=>e.jsx("svg",{width:"14",height:"14",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:e.jsx("circle",{cx:"12",cy:"12",r:"10"})}),er=()=>e.jsxs("svg",{width:"14",height:"14",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("path",{d:"M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"}),e.jsx("circle",{cx:"12",cy:"13",r:"4"})]}),Hl=()=>e.jsxs("svg",{width:"14",height:"14",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("path",{d:"M12 3v18"}),e.jsx("path",{d:"M3 12h18"}),e.jsx("circle",{cx:"12",cy:"12",r:"3"})]}),Ul=()=>e.jsx("svg",{width:"14",height:"14",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:e.jsx("path",{d:"M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"})}),go=()=>e.jsxs("svg",{width:"14",height:"14",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("polygon",{points:"12 2 2 7 12 12 22 7 12 2"}),e.jsx("polyline",{points:"2 17 12 22 22 17"}),e.jsx("polyline",{points:"2 12 12 17 22 12"})]}),Gl=()=>e.jsxs("svg",{width:"14",height:"14",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("path",{d:"M12 2l-5 9h10l-5 9"}),e.jsx("path",{d:"M12 2v20"})]}),Tn=()=>e.jsxs("svg",{width:"14",height:"14",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("path",{d:"M6 2v14a2 2 0 0 0 2 2h14"}),e.jsx("path",{d:"M18 22V8a2 2 0 0 0-2-2H2"})]}),Wl=()=>e.jsxs("svg",{width:"14",height:"14",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("rect",{x:"3",y:"3",width:"18",height:"18",rx:"2",ry:"2"}),e.jsx("line",{x1:"9",y1:"9",x2:"15",y2:"15"}),e.jsx("line",{x1:"15",y1:"9",x2:"9",y2:"15"})]}),ql=()=>e.jsxs("svg",{width:"14",height:"14",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("rect",{x:"3",y:"3",width:"7",height:"7"}),e.jsx("rect",{x:"14",y:"3",width:"7",height:"7"}),e.jsx("rect",{x:"14",y:"14",width:"7",height:"7"}),e.jsx("path",{d:"M3 14h7v7H3z",fill:"currentColor",stroke:"none"})]}),Xl=()=>e.jsx("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"currentColor",children:e.jsx("path",{d:"M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V5h14v14zM7 10h2v7H7zm4-3h2v10h-2zm4 6h2v4h-2z"})}),Pn=()=>e.jsxs("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2.5",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("rect",{x:"3",y:"3",width:"7",height:"7"}),e.jsx("rect",{x:"14",y:"3",width:"7",height:"7"}),e.jsx("rect",{x:"14",y:"14",width:"7",height:"7"}),e.jsx("path",{d:"M10 7h4"}),e.jsx("path",{d:"M17 10v4"})]}),Yl=()=>e.jsxs("svg",{width:"14",height:"14",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2.5",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("path",{d:"M12 22V8"}),e.jsx("path",{d:"M5 12H2a10 10 0 0 0 20 0h-3"}),e.jsx("circle",{cx:"12",cy:"5",r:"3"})]}),Vl=()=>e.jsxs("svg",{width:"14",height:"14",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2.5",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("path",{d:"M12 18V8"}),e.jsx("path",{d:"M5 12H2a10 10 0 0 0 20 0h-3"}),e.jsx("circle",{cx:"12",cy:"5",r:"3"}),e.jsx("line",{x1:"3",y1:"21",x2:"21",y2:"3",stroke:"currentColor",opacity:"0.9"})]}),Zl=({status:a})=>{let t="currentColor";a==="keyed"||a==="partial"?t="#f59e0b":(a==="dirty"||a==="keyed-dirty")&&(t="#ef4444");const o=a==="keyed"||a==="keyed-dirty"?t:"none";return e.jsx("svg",{width:"10",height:"10",viewBox:"0 0 24 24",fill:"none",stroke:t,strokeWidth:"2.5",children:e.jsx("path",{d:"M12 2L2 12l10 10 10-10L12 2z",fill:o})})},na=({active:a})=>e.jsxs("svg",{width:"10",height:"10",viewBox:"0 0 24 24",fill:"none",stroke:a?"#22d3ee":"#666",strokeWidth:"3",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("path",{d:"M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"}),e.jsx("path",{d:"M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"})]}),Kl=()=>e.jsxs("svg",{width:"10",height:"10",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("path",{d:"M10 13l-4 4"}),e.jsx("path",{d:"M14 11l4 -4"})]}),Ql=({active:a})=>e.jsxs("svg",{width:"10",height:"10",viewBox:"0 0 24 24",fill:"none",stroke:a?"#f59e0b":"#666",strokeWidth:"3",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("polyline",{points:"16 18 22 12 16 6"}),e.jsx("polyline",{points:"8 6 2 12 8 18"})]}),Rn=({open:a})=>e.jsx("svg",{width:"10",height:"10",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",className:`transition-transform ${a?"rotate-90":""}`,children:e.jsx("path",{d:"M9 18l6-6-6-6"})}),Jl=()=>e.jsxs("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("rect",{x:"2",y:"2",width:"20",height:"20",rx:"5",ry:"5"}),e.jsx("path",{d:"M16 8h.01"}),e.jsx("path",{d:"M8 8h.01"}),e.jsx("path",{d:"M8 16h.01"}),e.jsx("path",{d:"M16 16h.01"}),e.jsx("path",{d:"M12 12h.01"})]}),ec=()=>e.jsxs("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("polyline",{points:"16 3 21 3 21 8"}),e.jsx("line",{x1:"4",y1:"20",x2:"21",y2:"3"}),e.jsx("polyline",{points:"21 16 21 21 16 21"}),e.jsx("line",{x1:"15",y1:"15",x2:"21",y2:"21"}),e.jsx("line",{x1:"4",y1:"4",x2:"9",y2:"9"})]}),ia=()=>e.jsx("svg",{width:"12",height:"12",fill:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{d:"M8 5v14l11-7z"})}),xo=()=>e.jsx("svg",{width:"12",height:"12",fill:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{d:"M6 19h4V5H6v14zm8-14v14h4V5h-4z"})}),zn=()=>e.jsx("svg",{width:"12",height:"12",fill:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{d:"M6 6h12v12H6z"})}),tc=({active:a})=>e.jsx("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:a?"currentColor":"none",stroke:"currentColor",strokeWidth:"2",children:e.jsx("circle",{cx:"12",cy:"12",r:"10",stroke:a?"none":"currentColor",fill:a?"#ef4444":"none"})}),ac=({active:a})=>e.jsx("svg",{width:"14",height:"14",viewBox:"0 0 24 24",fill:"none",stroke:a?"#22d3ee":"currentColor",strokeWidth:"2",children:e.jsx("path",{d:"M3 18C3 18 6 5 12 12C18 19 21 5 21 5"})}),oc=({active:a})=>e.jsxs("svg",{width:"14",height:"14",viewBox:"0 0 24 24",fill:"none",stroke:a?"#22d3ee":"currentColor",strokeWidth:"2",children:[e.jsx("rect",{x:"3",y:"8",width:"6",height:"8"}),e.jsx("rect",{x:"15",y:"8",width:"6",height:"8"})]}),rc=()=>e.jsxs("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("path",{d:"M4 15s1-1 4-1 5 2 8 2 4-1 4-1V3s-1 1-4 1-5-2-8-2-4 1-4 1z"}),e.jsx("path",{d:"M4 22v-7"}),e.jsx("path",{d:"M8 4v10"}),e.jsx("path",{d:"M12 5v10"}),e.jsx("path",{d:"M16 4v10"}),e.jsx("path",{d:"M4 8h16"}),e.jsx("path",{d:"M4 12h16"})]}),Fn=({active:a})=>e.jsxs("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("rect",{x:"3",y:"3",width:"18",height:"18",rx:"2",ry:"2"}),e.jsx("line",{x1:"3",y1:"9",x2:"21",y2:"9"}),e.jsx("line",{x1:"3",y1:"15",x2:"21",y2:"15"}),e.jsx("line",{x1:"9",y1:"3",x2:"9",y2:"21"}),e.jsx("line",{x1:"15",y1:"3",x2:"15",y2:"21"})]}),nc=({mode:a})=>e.jsx("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:a==="Loop"||a==="PingPong"?e.jsx("path",{d:"M17 2l4 4-4 4 M3 11v-1a4 4 0 0 1 4-4h14 M7 22l-4-4 4-4 M21 13v1a4 4 0 0 1-4 4H3"}):e.jsx("path",{d:"M5 12h14 M12 5l7 7-7 7"})}),ic=({active:a,arming:t})=>e.jsxs("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("path",{d:"M3 12h18",strokeOpacity:a||t?.3:.2}),e.jsx("path",{d:"M3 12 Q 6 2, 9 12 T 15 12 T 21 12",stroke:a?"#ef4444":t?"#fca5a5":"currentColor"}),t&&!a&&e.jsx("circle",{cx:"12",cy:"12",r:"3",fill:"#fca5a5",stroke:"none"})]}),sc=()=>e.jsxs("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("polyline",{points:"4 14 10 14 10 20"}),e.jsx("polyline",{points:"20 10 14 10 14 4"}),e.jsx("line",{x1:"14",y1:"10",x2:"21",y2:"3"}),e.jsx("line",{x1:"3",y1:"21",x2:"10",y2:"14"})]}),lc=()=>e.jsxs("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("path",{d:"M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"}),e.jsx("circle",{cx:"12",cy:"12",r:"3",fill:"currentColor",stroke:"none"})]}),cc=({active:a})=>e.jsxs("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"none",stroke:a?"#22d3ee":"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("line",{x1:"4",y1:"20",x2:"20",y2:"20"}),e.jsx("line",{x1:"4",y1:"4",x2:"20",y2:"4"}),e.jsx("polyline",{points:"4 14 8 10 12 14 16 10 20 14"})]}),dc=()=>e.jsxs("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("path",{d:"M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"}),e.jsx("path",{d:"M4 12h16"}),e.jsx("path",{d:"M12 4v16"}),e.jsx("path",{d:"M16 16l-4 4-4-4"})]}),In=({active:a})=>e.jsxs("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"none",stroke:a?"#22d3ee":"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("path",{d:"M19 13l-7-7-7 7"}),e.jsx("path",{d:"M5 19l7-7 7 7"}),e.jsx("path",{d:"M12 5l2-2 2 2-2 2-2-2z",fill:a?"#22d3ee":"none",stroke:"none"}),e.jsx("path",{d:"M12 5l-2-2-2 2 2 2 2-2z",fill:a?"#22d3ee":"none",stroke:"none"})]}),En=({active:a})=>e.jsx("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"none",stroke:a?"#22d3ee":"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:e.jsx("path",{d:"M2 12s3-7 7-7 7 7 7 7 3-7 7-7"})}),tr=({active:a})=>e.jsxs("svg",{width:"10",height:"10",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2.5",strokeLinecap:"round",strokeLinejoin:"round",className:a?"text-gray-200":"text-gray-600",children:[e.jsx("path",{d:"M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"}),e.jsx("circle",{cx:"12",cy:"12",r:"3"})]}),ht={frameCount:0,lastTime:performance.now(),ref:null},uc=()=>{const a=performance.now();ht.frameCount++,a-ht.lastTime>=1e3&&(ht.ref&&(ht.ref.innerText=`${ht.frameCount} FPS`),ht.frameCount=0,ht.lastTime=a)},fc=()=>{const a=Y(s=>s.isPaused),t=Y(bn),o=xe(s=>s.isCameraInteracting),r=xe(s=>s.isScrubbing),n=a&&!t&&!o&&!r,i=v.useRef(null);return v.useEffect(()=>(ht.ref=i.current,()=>{ht.ref===i.current&&(ht.ref=null)}),[]),e.jsx("span",{ref:i,className:`text-[10px] font-mono w-12 text-right transition-colors duration-300 ${n?"text-gray-600":"text-cyan-500/80"}`,title:a?"Rendering Paused (Battery Saver)":"Frames Per Second",children:"-- FPS"})},Oe=a=>{var r;const t=new Set;let o=a;for(;o&&o!==document.body;)(r=o.dataset)!=null&&r.helpId&&o.dataset.helpId.split(/\s+/).forEach(i=>{i&&t.add(i)}),o=o.parentElement;return Array.from(t)},Na=(a,t,o,r)=>{if(t)return 0;const n=Y.getState();n.geometry;const i=n.lighting;if(a.startsWith("camera.unified")){const l=B.activeCamera?B.activeCamera.position:n.cameraPos,d=ot.getUnifiedPosition(l,n.sceneOffset);if(a==="camera.unified.x")return d.x;if(a==="camera.unified.y")return d.y;if(a==="camera.unified.z")return d.z}if(a.startsWith("camera.rotation")){const l=B.activeCamera;if(l){const d=new qe().setFromQuaternion(l.quaternion);if(a==="camera.rotation.x")return d.x;if(a==="camera.rotation.y")return d.y;if(a==="camera.rotation.z")return d.z}return 0}if(a.startsWith("lights.")||a.startsWith("lighting.")){const l=a.match(/lighting\.light(\d+)_(\w+)/);if(l){const d=parseInt(l[1]),c=l[2],f=Dt(i,d);if(f){if(c==="intensity")return f.intensity;if(c==="falloff")return f.falloff;if(c==="posX")return f.position.x;if(c==="posY")return f.position.y;if(c==="posZ")return f.position.z}}}if(a.includes(".")){const l=a.split("."),d=l[0],c=l[1];if(ve.get(d)){const f=n[d];if(f&&f[c]!==void 0){let u=f[c];if(typeof u=="boolean")return u?1:0;if(typeof u=="number")return u}}}const s=n.coreMath;if(s){if(a==="paramA")return s.paramA;if(a==="paramB")return s.paramB;if(a==="paramC")return s.paramC;if(a==="paramD")return s.paramD;if(a==="paramE")return s.paramE;if(a==="paramF")return s.paramF;if(a==="iterations")return s.iterations}return 0},Qe=(a,t,o)=>{if(a.length===0)return 0;if(t<=a[0].frame)return a[0].value;if(t>=a[a.length-1].frame)return a[a.length-1].value;for(let r=0;r<a.length-1;r++){const n=a[r],i=a[r+1];if(t>=n.frame&&t<i.frame)return rt.interpolate(t,n,i,o)}return a[0].value},ma=(a,t,o)=>{if(!a)return{angle:0,length:0};const r=o?-a.x:a.x,n=o?-a.y:a.y,i=Math.atan2(n,r)*(180/Math.PI);let s=0;return t&&Math.abs(t)>1e-9?s=Math.abs(a.x)/Math.abs(t)*100:s=Math.abs(a.x)*10,{angle:i,length:s}},ar=(a,t,o,r)=>{const i=Math.max(-89.9,Math.min(89.9,t))*(Math.PI/180),s=Math.abs(r)<1e-4?10:Math.abs(r),l=(a?-1:1)*(o/100)*s,d=Math.abs(l)*Math.tan(i)*(a?-1:1);return{x:l,y:d}},Nn=rt.constrainHandles,Dn=rt.calculateSoftFalloff,Ln=rt.scaleHandles,pc=(a,t)=>{const o=[],r=Math.PI*2;return a.forEach(n=>{const i=t.tracks[n],s=/rotation|rot|phase|twist/i.test(n)||/param[C-F]/i.test(n);if(i&&i.keyframes.length>1&&s){const l=[...i.keyframes].sort((f,u)=>f.frame-u.frame),c=[...l.map(f=>f.value)];for(let f=1;f<c.length;f++){let u=c[f]-c[f-1];u-=Math.round(u/r)*r,c[f]=c[f-1]+u}l.forEach((f,u)=>{Math.abs(f.value-c[u])>1e-4&&o.push({trackId:n,keyId:f.id,patch:{value:c[u]}})})}}),o},hc=(a,t,o,r=1,n,i=.5,s=.6)=>{const l=[],d=o.length>0,c=new Set(o),f=r<0,u=Math.abs(r);if(u===0)return n&&a.forEach(m=>{const y=n.tracks[m],x=t.tracks[m];!y||!x||y.keyframes.forEach(C=>{const k=x.keyframes.find(S=>S.id===C.id);k&&(!d||c.has(`${m}::${C.id}`))&&Math.abs(k.value-C.value)>1e-9&&l.push({trackId:m,keyId:C.id,patch:{value:C.value}})})}),l;const p=n||t,h=Math.max(.1,u/2.5),g=2*h*h,M=Math.ceil(u);return a.forEach(m=>{const y=p.tracks[m];if(!y||y.keyframes.length<2)return;const x=/rotation|rot|phase|twist/i.test(m)||/param[C-F]/i.test(m),C=[...y.keyframes].sort((S,b)=>S.frame-b.frame);if(f){const S=Math.min(u,5)/5,b=i*(1-S*.9),w=s*(1-S*.8);let j=C[0].value,T=0;const L=C[0].frame,_=C[C.length-1].frame;let z=Qe(C,L+1,x)-j;x&&(z>Math.PI?z-=Math.PI*2:z<-Math.PI&&(z+=Math.PI*2)),T=z;for(let E=L;E<=_;E++){let N=Qe(C,E,x);if(x){const W=N-j;W>Math.PI?N-=Math.PI*2:W<-Math.PI&&(N+=Math.PI*2)}const P=(N-j)*b,$=-T*w,O=P+$;T+=O,j+=T;const X=C.find(W=>Math.abs(W.frame-E)<.1);if(X)if(!d||c.has(`${m}::${X.id}`))l.push({trackId:m,keyId:X.id,patch:{value:j}});else{j=X.value;let H=Qe(C,E+1,x)-j;x&&(H>Math.PI?H-=Math.PI*2:H<-Math.PI&&(H+=Math.PI*2)),T=H}}return}let k=[];if(d){let S=[];C.forEach((b,w)=>{c.has(`${m}::${b.id}`)?S.push(w):S.length>0&&(k.push(S),S=[])}),S.length>0&&k.push(S)}else k.push(C.map((S,b)=>b));k.forEach(S=>{const b=w=>w<0?C[0].value:w>=C.length?C[C.length-1].value:C[w].value;for(let w=0;w<S.length;w++){const j=S[w],T=C[j];let L=0,_=0;for(let R=-M;R<=M;R++){const z=j+R,E=Math.exp(-(R*R)/g);let N=b(z);_+=N*E,L+=E}if(L>0){let R=_/L;const z=t.tracks[m],E=z?z.keyframes.find(N=>N.id===T.id):null;E&&Math.abs(R-E.value)>1e-9&&l.push({trackId:m,keyId:T.id,patch:{value:R}})}}})}),l},mc=(a,t,o=1)=>{const r=[];return a.forEach(n=>{const i=t.tracks[n];if(!i||i.keyframes.length===0)return;const s=[...i.keyframes].sort((u,p)=>u.frame-p.frame),l=Math.ceil(s[0].frame),d=Math.floor(s[s.length-1].frame),c=n.startsWith("camera.rotation"),f=[];for(let u=l;u<=d;u+=o){const p=Qe(s,u,c);f.push({id:tt(),frame:u,value:p,interpolation:"Linear",autoTangent:!1,brokenTangents:!1})}f.length>0&&r.push({trackId:n,newKeys:f})}),r},gc=(a,t,o)=>{const{sequence:r,currentFrame:n,addTrack:i,addKeyframe:s,removeKeyframe:l,isRecording:d,snapshot:c}=xe(),f=(()=>{if(!a||!r.tracks[a])return"none";const g=r.tracks[a],M=g.keyframes.find(m=>Math.abs(m.frame-n)<.1);if(M)return Math.abs(M.value-t)>1e-4?"keyed-dirty":"keyed";{const m=/rotation|rot|phase|twist/i.test(a)||/param[C-F]/i.test(a),y=Qe(g.keyframes,n,m);return Math.abs(y-t)>.001?"dirty":"partial"}})();return{status:f,toggleKey:()=>{if(a){if(c(),f==="keyed"){const g=r.tracks[a].keyframes.find(M=>Math.abs(M.frame-n)<.1);g&&l(a,g.id)}else r.tracks[a]||i(a,o),s(a,n,t);le.emit(Fe.TRACK_FOCUS,a)}},autoKeyOnChange:g=>{a&&d&&(r.tracks[a]||i(a,o),s(a,n,g))},autoKeyOnDragStart:()=>{a&&d&&(c(),le.emit(Fe.TRACK_FOCUS,a))}}},ca=({status:a,onClick:t,className:o=""})=>e.jsx("button",{onClick:r=>{r.stopPropagation(),t()},tabIndex:-1,className:`p-0.5 rounded hover:bg-white/10 transition-colors shrink-0 ${a==="keyed"?"text-amber-400":a==="keyed-dirty"||a==="dirty"?"text-red-500":a==="partial"?"text-orange-500 hover:text-amber-300":"text-gray-600 hover:text-amber-200"} ${o}`,title:a==="none"?"Add Keyframe":a==="dirty"?"Add Key (Value mismatch)":a==="keyed-dirty"?"Update Key (Value changed)":a==="partial"?"Add Key (Track exists)":"Remove Key",children:e.jsx(Zl,{status:a})}),ga=a=>a===0||Math.abs(a)<1e-9?"0":parseFloat(a.toFixed(8)).toString(),yo=({value:a,onChange:t,onMiddleChange:o,step:r,min:n,max:i,highlight:s,overrideText:l,onDragStart:d,onDragEnd:c,sensitivity:f=1,disabled:u=!1})=>{const[p,h]=v.useState(!1),[g,M]=v.useState(""),[m,y]=v.useState(!1),x=v.useRef(null),C=v.useRef(0),k=v.useRef(0),S=v.useRef(!1),b=v.useRef(0),w=E=>{u||(E.preventDefault(),!(E.button!==0&&E.button!==1)&&(E.button===1&&!o||(E.currentTarget.setPointerCapture(E.pointerId),C.current=E.clientX,k.current=a??0,S.current=!1,b.current=E.button,y(!0),d&&d())))},j=E=>{if(!m||u)return;E.preventDefault();const N=E.clientX-C.current;Math.abs(N)>3&&(S.current=!0);let P=1;E.shiftKey&&(P=10),E.altKey&&(P=.1);const $=N*r*P*f;let O=k.current+$;n!==void 0&&(O=Math.max(n,O)),i!==void 0&&(O=Math.min(i,O));const X=r.toString(),W=X.includes(".")?X.split(".")[1].length:0,H=E.altKey?W+1:W,A=parseFloat(O.toFixed(H));b.current===1&&o?o(A):t(A)},T=E=>{u||(y(!1),c&&c(),E.currentTarget.releasePointerCapture(E.pointerId),!S.current&&b.current===0&&(h(!0),M(ga(a??0))))},L=()=>{u||(h(!0),M(ga(a??0)))},_=E=>{u||(E.key==="Enter"||E.key===" ")&&(E.preventDefault(),h(!0),M(ga(a??0)))},R=()=>{d&&d();const E=parseFloat(g);if(!isNaN(E)){let N=E;n!==void 0&&(N=Math.max(n,N)),i!==void 0&&(N=Math.min(i,N)),t(N)}c&&c(),h(!1)};if(p)return e.jsx("input",{autoFocus:!0,type:"text",value:g,onChange:E=>M(E.target.value),onBlur:()=>R(),onFocus:E=>E.target.select(),onKeyDown:E=>{E.key==="Enter"&&R(),E.key==="Escape"&&h(!1)},className:"w-full h-full bg-gray-900 text-white text-xs border-none outline-none font-mono text-center px-1",onClick:E=>E.stopPropagation()});let z=l;return z||(a==null||isNaN(a)?z="---":z=ga(a)),e.jsx("div",{ref:x,tabIndex:u?-1:0,onPointerDown:w,onPointerMove:j,onPointerUp:T,onKeyDown:_,onFocus:L,className:`w-full h-full flex items-center justify-center text-xs font-mono select-none transition-colors touch-none outline-none ${u?"cursor-not-allowed opacity-50 text-gray-600":"cursor-ew-resize focus:ring-1 focus:ring-cyan-500/50"} ${m?"bg-cyan-500/20 text-cyan-300":s&&!u?"text-cyan-400":u?"":"text-gray-300 hover:text-white"}`,title:u?"Disabled":"Click to edit, Drag to adjust (Shift=Fast, Alt=Slow)",children:z})},xc=({label:a,value:t,min:o,max:r,step:n,hardMin:i,hardMax:s,onChange:l,highlight:d,overrideText:c,customMapping:f,mapTextInput:u,liveValue:p,headerRight:h,footer:g,labelSuffix:M,onContextMenu:m,dataHelpId:y,onDragStart:x,onDragEnd:C,disabled:k=!1,className:S=""})=>{const b=t??0,w=f?f.toSlider(b):b,j=f?f.min:o,T=f?f.max:r,L=P=>{if(k)return;const $=parseFloat(P.target.value),O=f?f.fromSlider($):$;l(O)},_=u&&f?w:b;u&&f&&(i!==void 0?f.toSlider(i):f.min,s!==void 0?f.toSlider(s):f.max);const R=P=>{k||l(u&&f?f.fromSlider(P):P)},z=Math.max(0,Math.min(100,(w-j)/(T-j)*100));let E=0;if(p!==void 0){const P=f?f.toSlider(p):p;E=Math.max(0,Math.min(100,(P-j)/(T-j)*100))}const N=d||p!==void 0;return e.jsxs("div",{className:`mb-px animate-slider-entry ${k?"opacity-50 pointer-events-none":""} ${S}`,"data-help-id":y,onContextMenu:m,children:[e.jsxs("div",{className:"flex items-stretch bg-white/[0.12] rounded-t-sm h-9 md:h-[26px] overflow-hidden border-b border-white/5",children:[e.jsxs("div",{className:"flex-1 flex items-center gap-2 px-2 min-w-0",children:[h,e.jsxs("label",{className:`text-[10px] font-medium tracking-tight select-none flex items-center gap-2 truncate pointer-events-none ${k?"text-gray-600":"text-gray-400"}`,children:[a,M,p!==void 0&&!k&&e.jsx("span",{className:"w-1.5 h-1.5 rounded-full bg-purple-500 animate-pulse shadow-[0_0_4px_#a855f7]"})]})]}),e.jsx("div",{className:"w-1/2 relative bg-white/[0.02] border-l border-white/10 group/num-area touch-none",style:k?{}:{backgroundImage:"repeating-linear-gradient(45deg, transparent, transparent 5px, rgba(255,255,255,0.03) 5px, rgba(255,255,255,0.03) 10px)"},children:e.jsx(yo,{value:_,onChange:R,step:n,min:i,max:s,highlight:N,overrideText:c,onDragStart:x,onDragEnd:C,disabled:k})})]}),e.jsxs("div",{className:"relative h-5 flex items-center touch-none overflow-hidden",style:{touchAction:"none"},children:[e.jsx("input",{type:"range",min:j,max:T,step:n,value:w,onChange:L,disabled:k,onPointerDown:P=>{k||(P.stopPropagation(),x&&x())},onPointerUp:()=>{!k&&C&&C()},className:`precision-slider w-full h-full appearance-none cursor-pointer focus:outline-none z-10 ${N&&!k?"accent-cyan-500":"accent-gray-400"}`,style:{background:"transparent",touchAction:"none"},tabIndex:-1}),e.jsxs("div",{className:"absolute inset-0 bg-white/10 pointer-events-none",children:[e.jsx("div",{className:`absolute top-0 bottom-0 left-0 transition-[width] duration-75 ease-out ${k?"bg-gray-500/20":"bg-cyan-500/30"}`,style:{width:`${z}%`}}),p!==void 0&&!k&&e.jsx("div",{className:"absolute top-0 bottom-0 w-1.5 bg-purple-500 blur-[1px] transition-all duration-75 ease-out z-0",style:{left:`calc(${E}% - 0.75px)`}})]}),g]})]})},_e=a=>{const{handleInteractionStart:t,handleInteractionEnd:o}=Y();return e.jsx(yo,{...a,onDragStart:()=>{t("param"),a.onDragStart&&a.onDragStart()},onDragEnd:()=>{o(),a.onDragEnd&&a.onDragEnd()}})},Me=({trackId:a,onKeyToggle:t,defaultValue:o,overrideInputText:r,dataHelpId:n,onChange:i,...s})=>{var b,w,j;const{openContextMenu:l,handleInteractionStart:d,handleInteractionEnd:c}=Y(),{status:f,toggleKey:u,autoKeyOnChange:p,autoKeyOnDragStart:h}=gc(a,s.value??0,s.label),g=[];a&&g.push(a),n&&g.push(n),g.push("ui.slider");const M=g.join(" "),m=T=>{if(s.disabled)return;T.preventDefault(),T.stopPropagation();const L=[];o!==void 0&&L.push({label:"Reset to Default",action:()=>{d("param"),a&&h(),i(o),p(o),c()}});const _=Oe(T.currentTarget);l(T.clientX,T.clientY,L,_)},y=T=>{i(T),p(T)},x=()=>{d("param"),h(),s.onDragStart&&s.onDragStart()},C=()=>{c(),s.onDragEnd&&s.onDragEnd()},k=a&&!s.disabled?e.jsx(ca,{status:f,onClick:()=>{u(),t&&t()}}):void 0,S=o!==void 0&&!s.disabled?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"absolute w-0.5 h-full bg-white/40 pointer-events-none z-0 transform -translate-x-1/2",style:{left:`${((s.customMapping?s.customMapping.toSlider(o):o)-(((b=s.customMapping)==null?void 0:b.min)??s.min??0))/((((w=s.customMapping)==null?void 0:w.max)??s.max??1)-(((j=s.customMapping)==null?void 0:j.min)??s.min??0))*100}%`}}),e.jsx("button",{onClick:T=>{T.preventDefault(),T.stopPropagation(),d("param"),a&&h(),i(o),p(o),c()},className:"absolute top-0 bottom-0 right-0 w-2 bg-gray-500/20 hover:bg-gray-400/50 cursor-pointer z-20 transition-colors border-l border-black/10",title:`Reset to ${o}`,"aria-label":"Reset to default",tabIndex:-1})]}):void 0;return e.jsx(xc,{...s,onChange:y,onDragStart:x,onDragEnd:C,onContextMenu:m,dataHelpId:M,headerRight:k,footer:S,highlight:s.highlight||f!=="none",overrideText:r})};function Ge({label:a,value:t,onChange:o,options:r,helpId:n,color:i="bg-cyan-600",onLfoToggle:s,isLfoActive:l,icon:d,disabled:c=!1,variant:f="default"}){const{openContextMenu:u,handleInteractionStart:p,handleInteractionEnd:h}=Y(),g=T=>{if(c)return;const L=Oe(T.currentTarget);L.length>0&&(T.preventDefault(),T.stopPropagation(),u(T.clientX,T.clientY,[],L))};if(f==="dense"&&!r&&typeof t=="boolean")return e.jsxs("div",{className:`flex items-center justify-between px-3 py-1 border-b border-white/5 hover:bg-white/5 transition-colors ${c?"opacity-50 pointer-events-none":""}`,"data-help-id":n,onContextMenu:g,children:[e.jsxs("div",{className:"flex items-center gap-2",children:[d,e.jsx("span",{className:"text-[10px] text-gray-400 font-sans font-medium tracking-tight truncate select-none",children:a})]}),e.jsx("input",{type:"checkbox",checked:t,onChange:()=>{p("param"),o(!t),h()},className:`w-3 h-3 appearance-none border rounded-[2px] cursor-pointer transition-colors ${t?"bg-cyan-600 border-cyan-500":"bg-black/40 border-gray-600 hover:border-gray-400"}`})]});const M=`mb-px flex items-center min-h-[22px] w-full ${c?"opacity-50 pointer-events-none":""}`,m="flex items-center gap-2 w-[50%] pr-2 shrink-0 select-none overflow-hidden",y="text-[10px] text-gray-400 font-medium tracking-tight truncate",k=`flex ${r?"w-full":a?"w-[90%]":s?"w-[84px]":"w-[60px]"} rounded overflow-hidden bg-gradient-to-b from-[#1a1a1a] to-transparent border border-white/5`,S=T=>{c||(p("param"),o(T),h())},b=()=>{c||(p("param"),o(!t),h())},w=()=>e.jsxs("div",{className:k,children:[e.jsx("button",{onClick:b,disabled:c,className:`
                    flex-1 py-0.5 px-1 text-[9px] font-bold uppercase tracking-wide border-r border-white/5 transition-all
                    ${t===!1?"bg-gray-800 text-gray-400 shadow-inner":"bg-transparent text-gray-600 hover:text-gray-400 hover:bg-white/5"}
                `,children:"O"}),e.jsx("button",{onClick:b,disabled:c,className:`
                    flex-1 py-0.5 px-1 text-[9px] font-bold uppercase tracking-wide transition-all
                    ${t===!0?`${i} text-white shadow-inner`:"bg-transparent text-gray-600 hover:text-gray-400 hover:bg-white/5"}
                `,children:"I"}),s&&e.jsx("button",{onClick:T=>{T.stopPropagation(),c||s()},disabled:c,className:`
                        flex-1 py-0.5 px-1 text-[9px] font-bold uppercase tracking-wide border-l border-white/5 transition-all
                        ${l?"bg-purple-900 text-purple-300 border-purple-700 shadow-inner":"bg-transparent text-gray-600 hover:text-purple-400 hover:bg-white/5"}
                    `,title:"LFO",children:"X"})]}),j=()=>e.jsx("div",{className:k,children:r==null?void 0:r.map(T=>e.jsx("button",{onClick:()=>S(T.value),disabled:c,className:`
                        flex-1 min-w-0 py-1.5 px-1 text-[9px] font-bold uppercase tracking-wide border-r border-white/5 last:border-r-0 transition-all truncate
                        ${t===T.value?"bg-cyan-900 text-cyan-200 border-cyan-700 shadow-inner":"bg-transparent text-gray-600 hover:text-gray-400 hover:bg-white/5"}
                    `,title:T.tooltip||T.label,children:T.label},String(T.value)))});return a?e.jsxs("div",{className:M,"data-help-id":n,onContextMenu:g,children:[e.jsxs("div",{className:m,title:a,children:[d,e.jsx("span",{className:y,children:a})]}),e.jsx("div",{className:`w-[50%] flex ${r?"":"justify-center"}`,children:r?j():w()})]}):e.jsx("div",{className:`flex flex-col mb-px w-full ${c?"opacity-50 pointer-events-none":""}`,"data-help-id":n,onContextMenu:g,children:e.jsx("div",{className:`flex ${r?"":"justify-end"}`,children:r?j():w()})})}const yc=()=>{const a=Y(),t=It.getProgress(),o=()=>{a.handleInteractionStart("param"),a.isBucketRendering?It.stop():(a.setBucketUpscale(1),It.start(!1,{bucketSize:a.bucketSize,bucketUpscale:1,convergenceThreshold:a.convergenceThreshold,accumulation:a.accumulation,samplesPerBucket:a.samplesPerBucket})),a.handleInteractionEnd()},r=()=>{if(a.handleInteractionStart("param"),a.isBucketRendering)It.stop();else{const n=a.getPreset({includeScene:!0}),i=a.prepareExport();It.start(!0,{bucketSize:a.bucketSize,bucketUpscale:a.bucketUpscale,convergenceThreshold:a.convergenceThreshold,accumulation:a.accumulation,samplesPerBucket:a.samplesPerBucket},{preset:n,name:a.projectSettings.name,version:i})}a.handleInteractionEnd()};return e.jsxs("div",{className:"absolute top-full mt-4 left-1/2 -translate-x-1/2 w-72 bg-black border border-white/20 rounded-xl p-3 shadow-2xl z-[70] animate-fade-in origin-top",onClick:n=>n.stopPropagation(),children:[e.jsx("div",{className:"absolute -top-1.5 left-1/2 -translate-x-1/2 w-3 h-3 bg-black border-t border-l border-white/20 transform rotate-45"}),e.jsxs("div",{className:"relative space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between border-b border-white/10 pb-2",children:[e.jsx("span",{className:"text-[10px] font-bold text-gray-400 uppercase tracking-wider",children:"High Quality Render"}),a.isBucketRendering&&e.jsx("button",{onClick:()=>It.stop(),className:"text-[9px] font-bold px-2 py-0.5 rounded border border-red-500/50 bg-red-500/20 text-red-300 animate-pulse",children:"STOP"})]}),a.isBucketRendering?e.jsxs("div",{className:"bg-white/5 rounded p-2 mb-2",children:[e.jsxs("div",{className:"flex justify-between text-[9px] text-gray-400 mb-1",children:[e.jsx("span",{children:"Progress"}),e.jsxs("span",{children:[t.toFixed(1),"%"]})]}),e.jsx("div",{className:"w-full h-1.5 bg-black rounded-full overflow-hidden",children:e.jsx("div",{className:"h-full bg-cyan-500 transition-all duration-300 ease-linear",style:{width:`${t}%`}})})]}):e.jsxs("div",{className:"flex gap-2 mb-2",children:[e.jsxs("button",{onClick:o,className:"flex-1 py-2 rounded bg-gray-800 hover:bg-white/10 border border-white/10 text-[9px] font-bold text-gray-300 uppercase tracking-wide transition-all hover:border-cyan-500/50 hover:text-cyan-400 flex flex-col items-center gap-1",title:"Refine Viewport (1x)",children:[e.jsx(xt,{}),e.jsx("span",{children:"Refine View"})]}),e.jsxs("button",{onClick:r,className:"flex-1 py-2 rounded bg-cyan-900/30 hover:bg-cyan-800/50 border border-cyan-500/30 text-[9px] font-bold text-cyan-300 uppercase tracking-wide transition-all hover:border-cyan-400 flex flex-col items-center gap-1",title:"Render & Save Image",children:[e.jsx(kn,{}),e.jsx("span",{children:"Export Image"})]})]}),e.jsxs("div",{className:`space-y-1 transition-opacity ${a.isBucketRendering?"opacity-50 pointer-events-none":"opacity-100"}`,children:[e.jsx(Me,{label:"Convergence Threshold",value:a.convergenceThreshold,min:.01,max:1,step:.01,onChange:a.setConvergenceThreshold,customMapping:{min:0,max:100,toSlider:n=>(Math.log10(n)+2)/2*100,fromSlider:n=>Math.pow(10,n/100*2-2)},overrideInputText:`${a.convergenceThreshold.toFixed(2)}%`}),e.jsx("p",{className:"text-[8px] text-gray-500 -mt-1 px-1 mb-2",children:"Lower = more samples, higher quality. 0.1%=production, 1%=fast"}),e.jsx(Me,{label:"Max Samples Per Bucket",value:a.samplesPerBucket,min:16,max:1024,step:16,onChange:a.setSamplesPerBucket,overrideInputText:`${a.samplesPerBucket} max`,highlight:a.samplesPerBucket>=256}),e.jsx("p",{className:"text-[8px] text-gray-500 -mt-1 px-1 mb-2",children:"Safety limit. Tiles stop early if converged."}),e.jsxs("div",{className:"pt-2 border-t border-white/5",children:[e.jsx(Me,{label:"Export Scale",value:a.bucketUpscale,min:1,max:8,step:.5,onChange:a.setBucketUpscale,overrideInputText:`${a.bucketUpscale}x`,highlight:a.bucketUpscale>1}),e.jsx("p",{className:"text-[8px] text-gray-500 -mt-1 px-1 mb-2",children:"Resolution multiplier. 2x = 4K from 1080p, 4x = 8K, 8x = 10K+"}),e.jsx("label",{className:"text-[9px] font-bold text-gray-400 uppercase tracking-wide block mb-1",children:"Bucket Size"}),e.jsx(Ge,{value:a.bucketSize,onChange:a.setBucketSize,options:[{label:"64",value:64},{label:"128",value:128},{label:"256",value:256},{label:"512",value:512}]}),e.jsx("p",{className:"text-[8px] text-gray-500 mt-1 px-1",children:"Smaller = less memory, larger = faster"})]})]})]})]})},bc=({isMobileMode:a,vibrate:t})=>{const o=Y(),r=xe(O=>O.isPlaying),{handleInteractionStart:n,handleInteractionEnd:i,openContextMenu:s}=Y(),l=Y(bn),d=xe(O=>O.isCameraInteracting),c=xe(O=>O.isScrubbing),f=o.isPaused&&!d&&!l&&!c,[u,p]=v.useState(!1),[h,g]=v.useState(!1),[M,m]=v.useState(!1),y=v.useRef(null),x=v.useRef(null),C=v.useRef(null),k=v.useRef(null),[S,b]=v.useState(o.projectSettings.name),[w,j]=v.useState(o.projectSettings.version);v.useEffect(()=>{h&&(b(o.projectSettings.name),j(o.projectSettings.version))},[h,o.projectSettings]),v.useEffect(()=>{const O=X=>{y.current&&!y.current.contains(X.target)&&p(!1),C.current&&!C.current.contains(X.target)&&g(!1)};return(u||h)&&window.addEventListener("mousedown",O),()=>window.removeEventListener("mousedown",O)},[u,h]);const T=(O,X)=>{O.preventDefault(),O.stopPropagation(),s(O.clientX,O.clientY,[],X)},L=()=>{if(t(5),o.renderRegion){o.setRenderRegion(null);return}o.interactionMode==="selecting_region"?o.setInteractionMode("none"):o.setInteractionMode("selecting_region")},_=o.lighting,R=(_==null?void 0:_.ptEnabled)!==!1,z=async()=>{R&&(t(5),n("param"),le.emit("is_compiling","Loading Material..."),await new Promise(O=>setTimeout(O,50)),o.setRenderMode(o.renderMode==="PathTracing"?"Direct":"PathTracing"),i())},E=()=>{o.setProjectSettings({name:S,version:w}),g(!1)},N=()=>{t(5);const O=Y.getState().isPaused;o.setIsPaused(!O),B.markInteraction()},P=()=>{k.current&&clearTimeout(k.current),m(!0)},$=()=>{k.current=window.setTimeout(()=>{m(!1)},300)};return e.jsxs("div",{className:"flex items-center gap-6",children:[e.jsxs("div",{className:"flex flex-col leading-none relative",children:[e.jsxs("span",{className:"text-xl font-black tracking-tighter text-white",children:["G",e.jsx("span",{className:"text-cyan-400",children:"M"}),"T"]}),e.jsx("button",{onClick:()=>g(!0),className:"text-[8px] font-mono text-gray-500 uppercase tracking-[0.2em] hover:text-cyan-300 transition-colors text-left truncate max-w-[120px]",title:"Click to Rename Project",children:o.projectSettings.name}),h&&e.jsx("div",{ref:C,className:"absolute top-full left-0 mt-2 w-48 bg-black border border-white/20 rounded-lg p-3 shadow-2xl z-[100] animate-fade-in origin-top-left",onClick:O=>O.stopPropagation(),children:e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-[9px] text-gray-500 font-bold uppercase block mb-1",children:"Project Name"}),e.jsx("input",{type:"text",value:S,onChange:O=>b(O.target.value),className:"w-full bg-gray-900 border border-white/10 rounded px-2 py-1 text-xs text-white outline-none focus:border-cyan-500",placeholder:"Enter name...",autoFocus:!0})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("label",{className:"text-[9px] text-gray-500 font-bold uppercase block mb-1",children:"Ver"}),e.jsx("div",{className:"h-6 bg-gray-900 border border-white/10 rounded overflow-hidden",children:e.jsx(_e,{value:w,onChange:O=>j(Math.max(1,Math.round(O))),step:1,min:1,max:99})})]}),e.jsx("button",{onClick:E,className:"flex-1 bg-cyan-900/40 hover:bg-cyan-800 text-cyan-300 border border-cyan-500/30 rounded flex items-center justify-center mt-3.5",title:"Save Settings",children:e.jsx(xt,{})})]})]})})]}),e.jsx("div",{className:"h-6 w-px bg-white/10"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(fc,{}),r&&e.jsxs("div",{className:"flex items-center gap-1.5 px-2 py-0.5 bg-green-900/30 border border-green-500/30 rounded text-[9px] font-bold text-green-400 uppercase tracking-wider animate-pulse",children:[e.jsx("svg",{width:"8",height:"8",viewBox:"0 0 24 24",fill:"currentColor",children:e.jsx("path",{d:"M8 5v14l11-7z"})}),e.jsx("span",{children:"Playing"})]}),!a&&e.jsxs("div",{className:"relative",onMouseEnter:P,onMouseLeave:$,ref:x,children:[e.jsx("button",{onClick:N,className:`p-0.5 rounded transition-colors ${f?"text-amber-400 bg-amber-900/30 border border-amber-500/30":"text-gray-600 hover:text-gray-400"}`,title:o.isPaused?"Resume Rendering":"Pause Rendering (Battery Saver)",children:f?e.jsx(ia,{}):e.jsx(xo,{})}),M&&e.jsxs("div",{className:"absolute top-full left-1/2 -translate-x-1/2 mt-3 w-40 bg-black border border-white/20 rounded-xl p-2 shadow-2xl z-[70] animate-fade-in origin-top",children:[e.jsx("div",{className:"absolute -top-1.5 left-1/2 -translate-x-1/2 w-3 h-3 bg-black border-t border-l border-white/20 transform rotate-45"}),e.jsxs("div",{className:"mb-1",children:[e.jsx(Me,{label:"Auto-Stop (Samples)",value:o.sampleCap,min:0,max:4096,step:32,onChange:o.setSampleCap,overrideInputText:o.sampleCap===0?"Infinite":o.sampleCap.toFixed(0)}),e.jsx("div",{className:"text-[8px] text-gray-500 text-center mt-1",children:"0 = Never Stop"})]})]})]}),e.jsx("div",{className:"w-px h-3 bg-white/10 mx-1"}),e.jsx("button",{onClick:()=>{t(5),n("param"),o.setAccumulation(!o.accumulation),i()},onContextMenu:O=>T(O,["quality.tss"]),className:`p-0.5 rounded transition-colors ${o.accumulation?"text-green-400 bg-green-900/30":"text-gray-600 hover:text-gray-400"}`,title:"TSS (Temporal Anti-Aliasing)",children:e.jsx(go,{})}),e.jsx("div",{className:"w-px h-3 bg-white/10 mx-1"}),e.jsx("button",{onClick:z,disabled:!R,className:`p-0.5 rounded transition-colors ${R?o.renderMode==="PathTracing"?"text-purple-400 bg-purple-900/30":"text-gray-600 hover:text-gray-400":"text-gray-700 cursor-not-allowed opacity-50"}`,title:R?a?"Enable Path Tracer (Experimental)":"Path Tracer (Global Illumination)":"Path Tracing disabled in Engine Panel",children:e.jsx(Gl,{})}),!a&&e.jsxs(e.Fragment,{children:[e.jsx("button",{onClick:L,className:`p-0.5 rounded transition-colors ${o.interactionMode==="selecting_region"?"text-cyan-400 bg-cyan-900/30 border border-cyan-500/30":o.renderRegion?"text-green-400 bg-green-900/30 border border-green-500/30":"text-gray-600 hover:text-gray-400"}`,title:o.renderRegion?"Clear Region":o.interactionMode==="selecting_region"?"Cancel Selection":"Select Region",children:o.renderRegion?e.jsx(Wl,{}):e.jsx(Tn,{})}),e.jsxs("div",{className:"relative",ref:y,children:[e.jsx("button",{onClick:O=>{O.stopPropagation(),t(5),p(!u)},className:`bucket-toggle-btn p-0.5 rounded transition-colors ${o.isBucketRendering?"text-cyan-400 bg-cyan-900/30 border border-cyan-500/30 animate-pulse":"text-gray-600 hover:text-gray-400"}`,title:"Render!",children:e.jsx(ql,{})}),u&&e.jsx(yc,{})]})]})]})]})};let Pa=[];const Qt=a=>{const t=a.toUpperCase();Pa=[t,...Pa.filter(o=>o!==t)].slice(0,3)},da=({color:a,onColorChange:t})=>{const[o,r]=v.useState(()=>{const y=ut(a);return y?pa(y):{h:0,s:0,v:100}}),n=v.useRef(a.toUpperCase()),{openContextMenu:i,handleInteractionStart:s,handleInteractionEnd:l}=Y();v.useEffect(()=>{if(a.toUpperCase()!==n.current){const y=ut(a);if(y){const x=pa(y);r(x),n.current=a.toUpperCase()}}},[a]);const d=y=>{const x={...o,...y};r(x);const C=Gt(ha(x.h,x.s,x.v));n.current=C,t(C)},c=()=>{Qt(n.current)},f="linear-gradient(to right, #f00, #ff0, #0f0, #0ff, #00f, #f0f, #f00)",u=v.useMemo(()=>`linear-gradient(to right, ${Gt(ha(o.h,0,o.v))}, ${Gt(ha(o.h,100,o.v))})`,[o.h,o.v]),p=v.useMemo(()=>`linear-gradient(to right, #000, ${Gt(ha(o.h,o.s,100))})`,[o.h,o.s]),h=y=>{if(y.button!==0&&y.button!==2)return;y.preventDefault(),y.stopPropagation();const x=[{label:"Actions",action:()=>{},isHeader:!0},{label:`Copy Hex (${a})`,action:()=>navigator.clipboard.writeText(a.toUpperCase())},{label:"Paste Hex",action:async()=>{try{let C=await navigator.clipboard.readText();if(C=C.trim(),C.startsWith("#")||(C="#"+C),/^#[0-9A-F]{6}$/i.test(C)||/^#[0-9A-F]{3}$/i.test(C)){if(C.length===4){const b=C[1],w=C[2],j=C[3];C=`#${b}${b}${w}${w}${j}${j}`}const k=C.toUpperCase(),S=ut(k);S&&(s("param"),r(pa(S)),n.current=k,t(k),Qt(k),l())}}catch(C){console.warn("Paste failed",C)}}},{label:"Quick Picks",action:()=>{},isHeader:!0},{label:"White (#FFFFFF)",icon:e.jsx("div",{className:"w-3 h-3 rounded-full bg-white border border-gray-600"}),action:()=>{s("param");const C="#FFFFFF";r({h:0,s:0,v:100}),n.current=C,t(C),Qt(C),l()}},{label:"Black (#000000)",icon:e.jsx("div",{className:"w-3 h-3 rounded-full bg-black border border-gray-600"}),action:()=>{s("param");const C="#000000";r({h:0,s:0,v:0}),n.current=C,t(C),Qt(C),l()}}];Pa.length>0&&(x.push({label:"History",action:()=>{},isHeader:!0}),Pa.forEach(C=>{x.push({label:C,icon:e.jsx("div",{className:"w-3 h-3 rounded-full border border-gray-600",style:{backgroundColor:C}}),action:()=>{s("param");const k=ut(C);k&&(r(pa(k)),n.current=C,t(C),Qt(C)),l()}})})),i(y.clientX,y.clientY,x,["ui.colorpicker"])},g=y=>{if(y.target.closest(".hsv-stack")){const x=Oe(y.currentTarget);x.length>0&&(y.preventDefault(),y.stopPropagation(),i(y.clientX,y.clientY,[],x))}},M=()=>s("param"),m=()=>l();return e.jsxs("div",{className:"flex flex-row h-[66px] bg-black/40 border border-white/5 overflow-hidden group/picker relative gradient-interactive-element",onMouseUp:c,"data-help-id":"ui.colorpicker",onContextMenu:g,children:[e.jsx("div",{className:"w-8 shrink-0 relative cursor-pointer border-r border-white/10 hover:brightness-110 active:brightness-125 transition-all bg-gray-800",style:{backgroundColor:a},onMouseDown:h,onContextMenu:h,title:"Color Actions & History (Right Click)",children:e.jsx("div",{className:"absolute inset-0 flex items-center justify-center -rotate-90 whitespace-nowrap text-[10px] font-mono font-bold mix-blend-difference text-white tracking-[0.25em] uppercase opacity-80 group-hover/picker:opacity-100 transition-opacity pl-[0.25em]",children:a})}),e.jsxs("div",{className:"flex-1 flex flex-col gap-[1px] hsv-stack",children:[e.jsx("div",{className:"relative h-[21.3px]",style:{background:f},children:e.jsx("input",{type:"range",min:"0",max:"360",step:"0.1",value:o.h,onChange:y=>d({h:Number(y.target.value)}),onPointerDown:M,onPointerUp:m,className:"precision-slider absolute inset-0 w-full h-full cursor-crosshair"})}),e.jsx("div",{className:"relative h-[21.3px]",style:{background:u},children:e.jsx("input",{type:"range",min:"0",max:"100",step:"0.1",value:o.s,onChange:y=>d({s:Number(y.target.value)}),onPointerDown:M,onPointerUp:m,className:"precision-slider absolute inset-0 w-full h-full cursor-crosshair"})}),e.jsx("div",{className:"relative h-[21.3px]",style:{background:p},children:e.jsx("input",{type:"range",min:"0",max:"100",step:"0.1",value:o.v,onChange:y=>d({v:Number(y.target.value)}),onPointerDown:M,onPointerUp:m,className:"precision-slider absolute inset-0 w-full h-full cursor-crosshair"})})]})]})},An=({index:a,value:t,onChange:o,isFixed:r=!1,size:n=140,width:i,height:s})=>{const l=i||n,d=s||n,c=l/2,f=d/2,u=l*.35,p=d*.35,h=v.useRef(null),[g,M]=v.useState(!1),{handleInteractionStart:m,handleInteractionEnd:y}=Y(),x=Y(H=>H.cameraRot),{sequence:C,currentFrame:k,isPlaying:S,addTrack:b,addKeyframe:w,removeKeyframe:j,snapshot:T,isRecording:L}=xe(),_=()=>{const H=new Be().setFromEuler(new qe(t.x,t.y,t.z,"YXZ"));return new ie(0,0,-1).applyQuaternion(H)},R=()=>{let A=_().clone();if(!r){const J=new Be(x.x,x.y,x.z,x.w);A.applyQuaternion(J.clone().invert())}const F=new ie(0,0,-1),I=A.angleTo(F),D=I/(Math.PI/2),G=Math.atan2(A.y,A.x),q=-Math.cos(G)*D*u,Q=Math.sin(G)*D*p;return{x:c+q,y:f+Q,isBacklit:I>Math.PI/2}},z=(H,A)=>{if(!h.current)return;const F=h.current.getBoundingClientRect(),I=F.left+l/2,D=F.top+d/2,G=H-I,q=A-D,Q=G/u,J=q/p,re=Math.sqrt(Q*Q+J*J),U=Math.atan2(J,Q),V=re*(Math.PI/2),te=Math.min(V,Math.PI-.001),K=Math.sin(te);let se=new ie(-K*Math.cos(U),K*Math.sin(U),-Math.cos(te));if(!r){const he=new Be(x.x,x.y,x.z,x.w);se.applyQuaternion(he)}const ee=new Be().setFromUnitVectors(new ie(0,0,-1),se),ne=new qe().setFromQuaternion(ee,"YXZ");o({x:ne.x,y:ne.y,z:ne.z})},E=R(),N=H=>{H.preventDefault(),H.stopPropagation(),m("param"),M(!0),H.target.setPointerCapture(H.pointerId),z(H.clientX,H.clientY)},P=H=>{g&&z(H.clientX,H.clientY)},$=H=>{if(g){if(M(!1),H.target.releasePointerCapture(H.pointerId),L){const A=`lighting.light${a}_rotX`,F=`lighting.light${a}_rotY`,I=`lighting.light${a}_rotZ`;C.tracks[A]||b(A,`Light ${a+1} Pitch`),C.tracks[F]||b(F,`Light ${a+1} Yaw`),C.tracks[I]||b(I,`Light ${a+1} Roll`),w(A,k,t.x),w(F,k,t.y),w(I,k,t.z)}y()}},O=[`lighting.light${a}_rotX`,`lighting.light${a}_rotY`],X=(()=>{let H=!1,A=!1,F=!1;return O.forEach((I,D)=>{const G=C.tracks[I];if(G){H=!0;const q=G.keyframes.find(Q=>Math.abs(Q.frame-k)<.1);if(q&&(A=!0),!S){const Q=D===0?t.x:t.y,J=q?q.value:Qe(G.keyframes,k,D===0||D===1);Math.abs(Q-J)>.001&&(F=!0)}}}),H?A?F?"keyed-dirty":"keyed":F?"dirty":"partial":"none"})(),W=()=>{T(),X==="keyed"?O.forEach(H=>{const A=C.tracks[H],F=A==null?void 0:A.keyframes.find(I=>Math.abs(I.frame-k)<.1);F&&j(H,F.id)}):O.forEach((H,A)=>{C.tracks[H]||b(H,A===0?`Light ${a+1} Pitch`:`Light ${a+1} Yaw`),w(H,k,A===0?t.x:t.y)})};return e.jsxs("div",{className:"flex flex-col items-center mb-2",children:[e.jsxs("div",{className:"w-full flex justify-between items-center mb-1 px-1",children:[e.jsx("label",{className:"text-[9px] font-bold text-gray-500 uppercase tracking-wider",children:"Heliotrope"}),e.jsx(ca,{status:X,onClick:W})]}),e.jsxs("div",{ref:h,className:"relative cursor-crosshair touch-none rounded-[30px] border border-white/10 shadow-inner group overflow-hidden",style:{width:l,height:d,background:"radial-gradient(circle at center, #0f172a 0%, #020617 80%)"},onPointerDown:N,onPointerMove:P,onPointerUp:$,title:r?"Headlamp Mode: Light is attached to Camera. Center = Camera Forward.":"World Mode: Light is fixed in space. Center = Direction you are looking.",children:[e.jsxs("div",{className:"absolute inset-0 flex items-center justify-center pointer-events-none opacity-20",children:[e.jsx("div",{className:"border border-cyan-500 rounded-full",style:{width:u*2,height:p*2}}),e.jsx("div",{className:"absolute w-full h-px bg-white/20"}),e.jsx("div",{className:"absolute h-full w-px bg-white/20"})]}),e.jsx("div",{className:"absolute top-1 left-1/2 -translate-x-1/2 text-[7px] text-gray-600 font-bold pointer-events-none",children:"TOP"}),e.jsx("div",{className:"absolute bottom-1 left-1/2 -translate-x-1/2 text-[7px] text-gray-600 font-bold pointer-events-none",children:"BTM"}),e.jsx("div",{className:"absolute left-1 top-1/2 -translate-y-1/2 text-[7px] text-gray-600 font-bold pointer-events-none",children:"L"}),e.jsx("div",{className:"absolute right-1 top-1/2 -translate-y-1/2 text-[7px] text-gray-600 font-bold pointer-events-none",children:"R"}),e.jsx("div",{className:`absolute inset-0 rounded-[30px] border-2 border-red-500/30 pointer-events-none transition-opacity duration-300 ${E.isBacklit?"opacity-100 animate-pulse":"opacity-0"}`}),e.jsx("div",{className:`absolute w-3 h-3 -ml-1.5 -mt-1.5 rounded-full shadow-[0_0_10px_white] pointer-events-none transition-transform duration-75 ${g?"scale-125 bg-white":"bg-yellow-400"} ${E.isBacklit?"border-2 border-red-500":""}`,style:{left:E.x,top:E.y}})]}),e.jsxs("div",{className:"flex gap-2 w-full mt-2 px-1",children:[e.jsxs("div",{className:"flex-1 bg-black/40 rounded border border-white/10 flex items-center px-2 py-1",children:[e.jsx("span",{className:"text-[8px] text-gray-500 font-bold mr-2",children:"Pitch"}),e.jsx(_e,{value:t.x*180/Math.PI,onChange:H=>o({...t,x:H*Math.PI/180}),step:1,min:-180,max:180,overrideText:(t.x*180/Math.PI).toFixed(1)+"",onDragStart:()=>m("param"),onDragEnd:()=>y()})]}),e.jsxs("div",{className:"flex-1 bg-black/40 rounded border border-white/10 flex items-center px-2 py-1",children:[e.jsx("span",{className:"text-[8px] text-gray-500 font-bold mr-2",children:"Yaw"}),e.jsx(_e,{value:t.y*180/Math.PI,onChange:H=>o({...t,y:H*Math.PI/180}),step:1,min:-180,max:180,overrideText:(t.y*180/Math.PI).toFixed(1)+"",onDragStart:()=>m("param"),onDragEnd:()=>y()})]})]})]})},vc=({index:a,color:t,active:o,type:r,rotation:n,onClick:i,onDragStart:s})=>{const d=(()=>{if(!n)return{x:50,y:50};const f=n.y;return{x:50+Math.sin(f)*35,y:50-Math.cos(f)*35}})(),c=Array.from({length:12}).map((f,u)=>u*30);return e.jsxs("div",{className:`group relative flex flex-col items-center justify-center cursor-grab active:cursor-grabbing transition-all duration-300 touch-none ${o?"opacity-100 scale-100":"opacity-50 hover:opacity-100 scale-90 hover:scale-100"}`,onPointerDown:f=>{f.button===0&&(f.stopPropagation(),s())},onClick:f=>{f.stopPropagation(),i()},children:[!o&&e.jsxs("div",{className:"absolute top-full mt-2 left-1/2 -translate-x-1/2 bg-black border border-white/20 text-[9px] font-bold text-gray-300 px-2 py-1 rounded shadow-xl opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap pointer-events-none z-50",children:["Drag to Screen",e.jsx("div",{className:"absolute -top-1 left-1/2 -translate-x-1/2 w-2 h-2 bg-black border-t border-l border-white/20 transform rotate-45"})]}),e.jsxs("div",{className:"w-8 h-8 relative",children:[o&&e.jsx("div",{className:"absolute inset-0 rounded-full transition-all duration-300",style:{boxShadow:`0 0 ${r==="Directional"?"12px":"20px"} ${t}`,opacity:r==="Directional"?.6:1,backgroundColor:r==="Directional"?"transparent":t}}),o&&r==="Directional"&&e.jsx("div",{className:"absolute inset-0 pointer-events-none",children:c.map(f=>e.jsx("div",{className:"absolute w-px h-[3px] rounded-full",style:{backgroundColor:t,top:"50%",left:"50%",marginTop:"-1.5px",marginLeft:"-0.5px",transform:`rotate(${f}deg) translateY(-17px)`,boxShadow:`0 0 2px ${t}`}},f))}),e.jsx("div",{className:"absolute inset-0 rounded-full border border-white overflow-hidden z-10 shadow-[inset_0_0_6px_rgba(255,255,255,0.4)] isolate",style:{backgroundColor:r==="Directional"?"#000000":t},children:o&&r==="Directional"&&e.jsx("div",{className:"absolute inset-0 w-full h-full",style:{background:`radial-gradient(circle at ${d.x}% ${d.y}%, ${t} 0%, transparent 65%)`,opacity:1}})}),o&&r!=="Directional"&&e.jsx("div",{className:"absolute inset-0 rounded-full border border-white/50 animate-ping opacity-20 pointer-events-none"})]}),e.jsxs("span",{className:"absolute -bottom-4 text-[8px] font-bold text-gray-500 uppercase tracking-widest opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap",children:["L",a+1]})]})},_n=({index:a})=>{const t=Y(w=>Dt(w.lighting,a)),o=Y(w=>w.updateLight),r=Y(w=>w.removeLight),{handleInteractionStart:n,handleInteractionEnd:i}=Y(),{addTrack:s,addKeyframe:l,currentFrame:d,sequence:c,isPlaying:f}=xe(),[u,p]=v.useState(t.useTemperature??!1),[h,g]=v.useState(t.temperature??6500);if(!t.visible)return null;const M=()=>{if(!B.activeCamera)return;const w=t.fixed;let j=t.position,T=t.rotation;t.type==="Point"?j=B.virtualSpace.resolveRealWorldPosition(t.position,w,B.activeCamera):T=B.virtualSpace.resolveRealWorldRotation(t.rotation,w,B.activeCamera),o({index:a,params:{fixed:!w,position:j,rotation:T}})},m=()=>{["X","Y","Z"].forEach(j=>{const T=`lighting.light${a}_pos${j}`;c.tracks[T]||s(T,`Light ${a+1} Pos ${j}`),l(T,d,t.position[j.toLowerCase()])})},x=(()=>{const w=["X","Y","Z"];let j=!1,T=!1,L=!1;return w.forEach(_=>{const R=`lighting.light${a}_pos${_}`,z=c.tracks[R];if(z){j=!0;const E=z.keyframes.find(N=>Math.abs(N.frame-d)<.1);if(E&&(T=!0),!f){const N=t.position[_.toLowerCase()];let P=0;E?P=E.value:P=Qe(z.keyframes,d,!1),Math.abs(P-N)>1e-4&&(L=!0)}}}),j?T?L?"keyed-dirty":"keyed":L?"dirty":"partial":"none"})(),C=Math.max(.01,t.intensity),k=t.falloff/C,S=`lighting.light${a}`,b=w=>{if(w===0)return"0";if(Math.abs(w)<1)return w.toFixed(3);const j=w.toPrecision(5);return j.includes(".")?j.replace(/\.?0+$/,""):j};return e.jsxs("div",{className:"absolute top-full mt-4 left-1/2 -translate-x-1/2 w-52 bg-black border border-white/20 rounded-xl p-3 shadow-2xl z-[70] animate-fade-in origin-top",onClick:w=>w.stopPropagation(),children:[e.jsx("div",{className:"absolute -top-1.5 left-1/2 -translate-x-1/2 w-3 h-3 bg-black border-t border-l border-white/20 transform rotate-45"}),e.jsxs("div",{className:"relative space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between border-b border-white/10 pb-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[t.type==="Point"&&e.jsx(ca,{status:x,onClick:m}),e.jsxs("span",{className:"text-[10px] font-bold text-gray-400 uppercase tracking-wider",children:["Light ",a+1]})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("button",{onClick:w=>{w.stopPropagation(),n("param"),r(a),i()},className:"p-1 text-red-500 hover:text-red-300 hover:bg-red-900/20 rounded transition-colors",title:"Remove Light",children:e.jsx(St,{})}),e.jsx("button",{onClick:()=>{n("param"),M(),i()},className:`text-[9px] font-bold px-2 py-0.5 rounded border transition-colors ${t.fixed?"bg-orange-500/20 text-orange-300 border-orange-500/50":"bg-cyan-500/20 text-cyan-300 border-cyan-500/50"}`,children:t.fixed?"ANCHORED":"FLOATING"})]})]}),e.jsxs("div",{className:"space-y-1",children:[t.type==="Directional"&&e.jsx("div",{className:"mb-2",children:e.jsx(An,{index:a,value:t.rotation,onChange:w=>o({index:a,params:{rotation:w}}),isFixed:t.fixed,width:180,height:110})}),e.jsx(Me,{label:"Intensity",value:t.intensity,min:0,max:100,step:.1,onChange:w=>o({index:a,params:{intensity:w}}),customMapping:{min:0,max:100,toSlider:w=>Math.sqrt(w/100)*100,fromSlider:w=>w*w/100},overrideInputText:b(t.intensity),trackId:`${S}_intensity`}),t.type!=="Directional"&&e.jsx(Me,{label:"Falloff",value:k,min:0,max:10,step:.01,onChange:w=>{const j=w*t.intensity;o({index:a,params:{falloff:j}})},customMapping:{min:0,max:100,toSlider:w=>Math.pow(w/10,1/1.5)*100,fromSlider:w=>Math.pow(w/100,1.5)*10},overrideInputText:k<1e-4?"Infinite":b(k),trackId:`${S}_falloff`})]}),e.jsxs("div",{className:"pt-2 border-t border-white/10 space-y-2",children:[e.jsxs("div",{className:"flex items-center gap-1 mb-2",children:[e.jsx("button",{onClick:()=>{p(!1),o({index:a,params:{useTemperature:!1}})},className:`text-[9px] font-bold px-2 py-0.5 rounded border transition-colors ${u?"bg-white/5 text-gray-400 border-white/20 hover:border-white/40":"bg-cyan-500/20 text-cyan-300 border-cyan-500/50"}`,children:"COLOR"}),e.jsx("button",{onClick:()=>{const w=!u;if(p(w),w){const j=_o(h);o({index:a,params:{color:j,useTemperature:!0,temperature:h}})}else o({index:a,params:{useTemperature:!1}})},className:`text-[9px] font-bold px-2 py-0.5 rounded border transition-colors ${u?"bg-amber-500/20 text-amber-300 border-amber-500/50":"bg-white/5 text-gray-400 border-white/20 hover:border-white/40"}`,children:"TEMPERATURE"})]}),u?e.jsxs("div",{className:"space-y-1",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("label",{className:"text-[10px] text-gray-400 font-medium",children:"Temperature (K)"}),e.jsx("span",{className:"text-[10px] text-gray-300 font-mono",children:h})]}),e.jsx("input",{type:"range",min:1e3,max:1e4,step:100,value:h,onChange:w=>{const j=parseInt(w.target.value);g(j);const T=_o(j);o({index:a,params:{temperature:j,color:T}})},className:"w-full h-1.5 bg-gradient-to-r from-orange-500 via-yellow-200 to-blue-200 rounded-full appearance-none cursor-pointer",style:{background:"linear-gradient(to right, #ff6b35, #ffcc66, #ffffff, #cce5ff, #66b3ff)"}})]}):e.jsx(da,{color:t.color,onColorChange:w=>o({index:a,params:{color:w}})}),e.jsxs("div",{className:"flex items-center justify-between pt-1",children:[e.jsx("label",{className:"text-xs text-gray-400 font-medium",children:"Cast Shadows"}),e.jsx("input",{type:"checkbox",checked:t.castShadow,onChange:w=>{n("param"),o({index:a,params:{castShadow:w.target.checked}}),i()},className:"w-3 h-3 accent-cyan-500 bg-gray-800 border-gray-600 rounded cursor-pointer"})]})]})]})]})},wc=({targetRef:a,color:t,onChange:o,onClose:r,label:n})=>{const[i,s]=v.useState({x:0,y:0});return v.useLayoutEffect(()=>{if(a.current){const l=a.current.getBoundingClientRect(),d=window.innerWidth,c=window.innerHeight,f=240,u=150;let p=l.right+5,h=l.top;p+f>d&&(p=l.left-f-5),h+u>c&&(h=l.bottom-u),s({x:p,y:h})}},[a]),v.useEffect(()=>{const l=d=>{a.current&&!a.current.contains(d.target)&&(d.target.closest(".picker-popup")||r())};return window.addEventListener("mousedown",l),()=>window.removeEventListener("mousedown",l)},[r,a]),wt.createPortal(e.jsxs("div",{className:"picker-popup fixed z-[9999] bg-black border border-white/20 p-3 rounded-xl shadow-[0_10px_40px_rgba(0,0,0,0.8)] w-56 animate-fade-in",style:{left:i.x,top:i.y},onMouseDown:l=>l.stopPropagation(),children:[n&&e.jsx("div",{className:"text-[10px] font-bold text-gray-500 mb-2 uppercase tracking-widest text-center",children:n}),e.jsx(da,{color:t,onColorChange:o})]}),document.body)},Ra=({color:a,onChange:t,label:o})=>{const[r,n]=v.useState(!1),i=v.useRef(null),s=Y(d=>d.openContextMenu),l=d=>{const c=Oe(d.currentTarget);c.unshift("ui.colorpicker"),c.length>0&&(d.preventDefault(),d.stopPropagation(),s(d.clientX,d.clientY,[],c))};return e.jsxs(e.Fragment,{children:[e.jsx("button",{ref:i,onClick:()=>n(!r),onContextMenu:l,className:"w-16 h-6 rounded border border-white/10 shadow-lg transition-all hover:scale-105 active:scale-95 flex items-center justify-center overflow-hidden",style:{backgroundColor:a},title:o||"Pick Color",children:e.jsx("div",{className:"text-[8px] font-mono font-black mix-blend-difference text-white uppercase",children:a})}),r&&e.jsx(wc,{targetRef:i,color:a,onChange:t,onClose:()=>n(!1),label:o})]})};function vt({label:a,value:t,options:o,onChange:r,helpId:n,fullWidth:i,className:s="",selectClassName:l="",labelSuffix:d}){const{openContextMenu:c,handleInteractionStart:f,handleInteractionEnd:u}=Y(),p=g=>{const M=Oe(g.currentTarget);M.length>0&&(g.preventDefault(),g.stopPropagation(),c(g.clientX,g.clientY,[],M))},h=g=>{var y;f("param");const M=g.target.value,m=typeof((y=o[0])==null?void 0:y.value)=="number";r(m?Number(M):M),u()};return e.jsxs("div",{className:`flex items-center justify-between min-h-[22px] mb-px px-3 ${i?"w-full":""} ${s}`,"data-help-id":n,onContextMenu:p,children:[a&&e.jsxs("label",{className:"text-[10px] text-gray-400 font-medium tracking-tight mr-2 shrink-0 select-none",children:[a,d]}),e.jsxs("div",{className:"relative w-[50%] min-w-[120px]",children:[e.jsx("select",{value:t,onChange:h,className:`t-dropdown pr-6 ${l}`,children:o.map(g=>e.jsx("option",{value:String(g.value),children:g.label},String(g.value)))}),e.jsx("div",{className:"absolute right-2 top-1/2 -translate-y-1/2 pointer-events-none text-gray-500",children:e.jsx("div",{className:"w-2.5 h-2.5",children:e.jsx(Rt,{})})})]})]})}const Mt=a=>a.map((t,o)=>({id:`${o}`,position:parseFloat((o/(a.length-1)).toFixed(3)),color:t})),Sc=[{name:"Grayscale",stops:Mt(["#000000","#ffffff"])},{name:"Warm Sunset",stops:Mt(["#fcde9c","#faa476","#f0746e","#e34f6f","#dc3977","#b9257a","#7c1d6f"])},{name:"Cool Forest",stops:Mt(["#d3f2a3","#97e196","#6cc08b","#4c9b82","#217a79","#105965","#074050"])},{name:"Spring Floral",stops:Mt(["#009392","#39b185","#9ccb86","#e9e29c","#eeb479","#e88471","#cf597e"])},{name:"Pastel Dreams",stops:Mt(["#009392","#72aaa1","#b1c7b3","#f1eac8","#e5b9ad","#d98994","#d0587e"])},{name:"Earth Tones",stops:Mt(["#3d5941","#778868","#b5b991","#f6edbd","#edbb8a","#de8a5a","#ca562c"])},{name:"Spectrum",stops:Mt(["#5F4690","#1D6996","#38A6A5","#0F8554","#73AF48","#EDAD08","#E17C05","#CC503E","#94346E","#6F4070","#994E95","#666666"])},{name:"Rainbow Divergent",stops:Mt(["#9e0142","#d53e4f","#f46d43","#fdae61","#fee08b","#e6f598","#abdda4","#66c2a5","#3288bd","#5e4fa2"])},{name:"Rainbow Full",stops:[{id:"1",position:0,color:"#ff0000"},{id:"2",position:.17,color:"#ffff00"},{id:"3",position:.33,color:"#00ff00"},{id:"4",position:.5,color:"#00ffff"},{id:"5",position:.67,color:"#0000ff"},{id:"6",position:.83,color:"#ff00ff"},{id:"7",position:1,color:"#ff0000"}]},{name:"Oceanic",stops:[{id:"1",position:0,color:"#001133"},{id:"2",position:.5,color:"#0066aa"},{id:"3",position:1,color:"#00ffff"}]},{name:"Neon Cyber",stops:[{id:"1",position:0,color:"#220033"},{id:"2",position:.3,color:"#aa00ff"},{id:"3",position:.7,color:"#00ffcc"},{id:"4",position:1,color:"#ffffff"}]},{name:"Golden Sands",stops:[{id:"1",position:0,color:"#331a00"},{id:"2",position:.5,color:"#cc8800"},{id:"3",position:1,color:"#ffeeaa"}]}],Mc=({x:a,y:t,options:o,onClose:r})=>{const n=v.useRef(null),[i,s]=v.useState({top:t,left:a,visible:!1});return v.useEffect(()=>{const l=d=>{n.current&&!n.current.contains(d.target)&&r()};return document.addEventListener("pointerdown",l,!0),()=>document.removeEventListener("pointerdown",l,!0)},[r]),v.useLayoutEffect(()=>{if(!n.current)return;const l=()=>{if(!n.current)return;const c=n.current.getBoundingClientRect(),f=window.innerWidth,u=window.innerHeight,p=12;if(c.width===0||c.height===0){requestAnimationFrame(l);return}let h=t,g=a;g+c.width>f-p&&(g=a-c.width),g<p&&(g=p),h+c.height>u-p&&(h=t-c.height),h<p&&(h=p),s({top:h,left:g,visible:!0})};l();const d=setTimeout(l,16);return()=>clearTimeout(d)},[a,t,o]),wt.createPortal(e.jsx("div",{ref:n,className:"fixed bg-[#1a1f3a] border border-white/20 rounded-md shadow-2xl py-1 z-[9999] w-[220px] max-h-[400px] overflow-y-auto custom-scroll transition-opacity duration-150",style:{top:i.top,left:i.left,opacity:i.visible?1:0,visibility:i.visible?"visible":"hidden",pointerEvents:i.visible?"auto":"none"},onMouseDown:l=>l.stopPropagation(),children:o.map((l,d)=>l.isHeader?e.jsx("div",{className:"px-4 py-1 text-[10px] uppercase font-bold text-gray-500 tracking-wider border-b border-white/5 mt-1 mb-1 bg-black/20",children:l.label},d):e.jsxs("button",{onClick:()=>{l.action(),r()},disabled:l.disabled,className:"w-full text-left px-4 py-2 text-xs text-gray-200 hover:bg-white/10 disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-between group transition-colors",children:[e.jsx("span",{className:"truncate mr-2",children:l.label}),l.stops&&e.jsx("div",{className:"w-16 h-3 rounded border border-white/20 shadow-sm shrink-0",style:{background:ja(l.stops)}})]},d))}),document.body)},Cc=(a,t)=>{const o=[...a].sort((r,n)=>r.position-n.position);if(o.length===0)return"#FFFFFF";if(t<=o[0].position)return o[0].color;if(t>=o[o.length-1].position)return o[o.length-1].color;for(let r=0;r<o.length-1;r++)if(t>=o[r].position&&t<=o[r+1].position){const n=(t-o[r].position)/(o[r+1].position-o[r].position),i=ut(o[r].color)||{r:255,g:255,b:255},s=ut(o[r+1].color)||{r:255,g:255,b:255};return Gt(Ar(i,s,n))}return"#FFFFFF"},kc=()=>e.jsx("svg",{width:"12",height:"12",viewBox:"0 0 10 10",className:"fill-gray-700 hover:fill-white drop-shadow-md stroke-white stroke-[0.5] pointer-events-none",children:e.jsx("path",{d:"M 5 0 L 10 5 L 5 10 L 0 5 Z"})}),jc=({color:a,isSelected:t})=>e.jsx("svg",{width:"14",height:"18",viewBox:"0 0 14 18",className:"drop-shadow-md pointer-events-none",children:e.jsx("path",{d:"M 7 0 L 14 7 L 14 17 L 0 17 L 0 7 Z",fill:a,stroke:t?"white":"#555",strokeWidth:t?"2":"1"})}),Tc=({value:a,onChange:t,helpId:o})=>{const{stops:r,colorSpace:n}=v.useMemo(()=>Array.isArray(a)?{stops:a,colorSpace:"srgb"}:{stops:a.stops,colorSpace:a.colorSpace},[a]),[i,s]=v.useState([]),l=v.useRef(t);v.useEffect(()=>{l.current=t},[t]);const{openContextMenu:d,handleInteractionStart:c,handleInteractionEnd:f}=Y();v.useEffect(()=>{s(r.map(U=>({id:U.id,position:U.position,color:U.color,bias:U.bias??.5,interpolation:U.interpolation??"linear"})).sort((U,V)=>U.position-V.position))},[r]);const u=v.useRef(i);v.useEffect(()=>{u.current=i},[i]);const[p,h]=v.useState(new Set),[g,M]=v.useState(!0),[m,y]=v.useState(!0),x=v.useRef(null),[C,k]=v.useState(!1),S=v.useRef(!1),[b,w]=v.useState(null),[j,T]=v.useState(null),L=v.useRef(null),_=v.useRef(null),R=v.useCallback((U,V)=>{const te=[...U].sort((ae,se)=>ae.position-se.position);s(te);const K=te.map(({id:ae,position:se,color:ee,bias:ne,interpolation:he})=>({id:ae,position:se,color:ee,bias:ne,interpolation:he}));l.current({stops:K,colorSpace:V||n})},[n]),z=()=>{c("param"),R(i,n==="srgb"?"linear":n==="linear"?"aces_inverse":"srgb"),f()},E=v.useCallback(U=>{p.size>0&&R(u.current.map(V=>p.has(V.id)?{...V,color:U}:V))},[p,R]),N=()=>{const U=JSON.stringify({stops:u.current.map(({position:V,color:te,bias:K,interpolation:ae})=>({position:V,color:te,bias:K,interpolation:ae})),colorSpace:n});navigator.clipboard.writeText(U)},P=async()=>{try{const U=await navigator.clipboard.readText(),V=JSON.parse(U);let te=[],K="srgb";if(Array.isArray(V)?te=V:V.stops&&(te=V.stops,K=V.colorSpace||"srgb"),te.length>=2){c("param");const ae=te.map((se,ee)=>({id:`${Date.now()}_${ee}`,position:se.position,color:se.color,bias:se.bias??.5,interpolation:se.interpolation??"linear"}));R(ae,K),h(new Set),f()}}catch(U){console.error(U)}},$=U=>{c("param");const V=U.map((te,K)=>({id:`${Date.now()}_${K}`,position:te.position,color:te.color,bias:te.bias??.5,interpolation:te.interpolation??"linear"}));R(V,"srgb"),h(new Set),f()},O=v.useCallback(U=>{var oe;const V=x.current;if(!V)return;const{type:te,ids:K,startX:ae,startY:se,initialKnots:ee}=V,ne=(oe=_.current)==null?void 0:oe.getBoundingClientRect();if(!ne)return;const de=(U.clientX-ae)/ne.width;if(te==="marquee"){w({x:Math.min(ae,U.clientX),y:Math.min(se,U.clientY),w:Math.abs(U.clientX-ae),h:Math.abs(U.clientY-se)});return}if(te==="knot"||te==="bracket_move"){const ye=Math.abs(U.clientY-(ne.top+ne.height/2)),pe=Math.max(0,ne.left-U.clientX,U.clientX-ne.right),be=(ye>50||pe>50)&&ee.length>K.length;S.current!==be&&(S.current=be,k(be),document.body.style.cursor=be?"no-drop":"ew-resize");const fe=ee.map(me=>{if(K.includes(me.id)){let ue=Math.max(0,Math.min(1,me.position+de));return U.shiftKey&&(ue=Math.round(ue*20)/20),{...me,position:ue}}return me});R(fe)}if(te.startsWith("bracket_scale")){const ye=ee.filter(ke=>K.includes(ke.id));if(ye.length<2)return;const pe=Math.min(...ye.map(ke=>ke.position)),be=Math.max(...ye.map(ke=>ke.position)),fe=te==="bracket_scale_left"?be:pe,me=te==="bracket_scale_left"?Math.min(fe-.01,pe+de):Math.max(fe+.01,be+de),ue=Math.abs(me-fe)/Math.abs(be-pe),ge=ee.map(ke=>{if(K.includes(ke.id)){let je=fe+(ke.position-fe)*ue;return{...ke,position:Math.max(0,Math.min(1,je))}}return ke});R(ge)}if(te==="bias"){const ye=K[0],pe=ee.findIndex(fe=>fe.id===ye);if(pe===-1||pe>=ee.length-1)return;const be=ee[pe+1].position-ee[pe].position;if(be>.001){let fe=Math.max(0,Math.min(1,ee[pe].bias+de/be));U.shiftKey&&(fe=Math.round(fe*20)/20);const me=[...ee];me[pe]={...me[pe],bias:fe},R(me)}}},[R]),X=v.useCallback(U=>{const V=x.current;if(V){if(V.type==="marquee"&&_.current){const te=_.current.getBoundingClientRect(),K=Math.min(V.startX,U.clientX),ae=Math.max(V.startX,U.clientX),se=Math.min(V.startY,U.clientY),ee=Math.max(V.startY,U.clientY),ne=new Set;u.current.forEach(he=>{const de=te.left+he.position*te.width,oe=te.top+te.height/2;de>=K&&de<=ae&&oe>=se-20&&oe<=ee+20&&ne.add(he.id)}),h(he=>U.shiftKey||U.ctrlKey?new Set([...he,...ne]):ne),w(null)}else V.type==="knot"||V.type==="bracket_move"?(S.current?(R(u.current.filter(te=>!V.ids.includes(te.id))),h(new Set)):R(u.current),S.current=!1,k(!1),f()):V.type!=="marquee"&&(R(u.current),f());x.current=null,document.body.style.cursor="",window.removeEventListener("mousemove",O),window.removeEventListener("mouseup",X)}},[R,O,f]),W=(U,V,te,K,ae)=>{te.preventDefault(),te.stopPropagation(),U!=="marquee"&&!ae&&c("param"),x.current={type:U,ids:V,startX:te.clientX,startY:te.clientY,initialKnots:JSON.parse(JSON.stringify(K||i))},window.addEventListener("mousemove",O),window.addEventListener("mouseup",X)},H=U=>{if(U.button!==0||U.target.closest(".gradient-interactive-element")||!_.current)return;c("param");const V=_.current.getBoundingClientRect(),te=Math.max(0,Math.min(1,(U.clientX-V.left)/V.width)),K=Cc(i,te),ae=[...i].sort((he,de)=>he.position-de.position);let se;for(let he of ae)if(he.position<=te)se=he;else break;const ee={id:Date.now().toString(),position:te,color:K,bias:.5,interpolation:se?se.interpolation:"linear"},ne=[...i,ee].sort((he,de)=>he.position-de.position);s(ne),h(new Set([ee.id])),R(ne),W("knot",[ee.id],U,ne,!0)};v.useEffect(()=>{const U=V=>{if(!(p.size===0||V.target.tagName==="INPUT")){if((V.key==="Delete"||V.key==="Backspace")&&i.length>p.size)c("param"),R(i.filter(te=>!p.has(te.id))),h(new Set),f();else if(V.key.startsWith("Arrow")){V.preventDefault(),c("param");const te=V.key==="ArrowLeft"?-1:1,K=V.shiftKey?.05:.01;R(i.map(ae=>p.has(ae.id)?{...ae,position:Math.max(0,Math.min(1,ae.position+te*K))}:ae)),f()}}};return window.addEventListener("keydown",U),()=>window.removeEventListener("keydown",U)},[p,i,R]);const A=v.useMemo(()=>{if(p.size<2)return null;const U=i.filter(V=>p.has(V.id));return U.length===0?null:{min:Math.min(...U.map(V=>V.position)),max:Math.max(...U.map(V=>V.position))}},[p,i]),F=v.useMemo(()=>i.filter(U=>p.has(U.id)),[i,p]),I=v.useMemo(()=>{if(F.length===0)return"linear";const U=F[0].interpolation;return F.every(V=>V.interpolation===U)?U:"mixed"},[F]),D=v.useMemo(()=>{if(F.length===0)return .5;const U=F[0].bias;return F.every(V=>V.bias===U)?U:-1},[F]),G=v.useMemo(()=>{if(F.length===0)return"#FFFFFF";const U=F[0].color;return F.every(V=>V.color===U)?U:F[0].color},[F]),q=(U,V)=>{c("param");const te=i.map(K=>p.has(K.id)?{...K,[U]:V}:K);R(te),f()},Q=U=>{U.preventDefault(),U.stopPropagation();const V=K=>()=>{c("param"),K(),f()},te=[{label:"Actions",action:()=>{},isHeader:!0},{label:"Invert Gradient",action:V(()=>R(i.map(K=>({...K,position:1-K.position})).reverse()))},{label:"Double Knots",action:V(()=>R([...i.map(K=>({...K,position:K.position*.5})),...i.map((K,ae)=>({...K,id:`${Date.now()}_${ae}`,position:.5+K.position*.5}))]))},{label:"Distribute Selected",disabled:p.size<3,action:V(()=>{const K=i.filter(se=>p.has(se.id)).sort((se,ee)=>se.position-ee.position),ae=(K[K.length-1].position-K[0].position)/(K.length-1);R(i.map(se=>p.has(se.id)?{...se,position:K[0].position+ae*K.findIndex(ee=>ee.id===se.id)}:se))})},{label:"Delete Selected",disabled:p.size===0||i.length<=2,danger:!0,action:V(()=>{R(i.filter(K=>!p.has(K.id))),h(new Set)})},{label:"View",action:()=>{},isHeader:!0},{label:"Bias Handles",checked:m,action:()=>y(!m)},{label:"Reset Default",danger:!0,action:V(()=>{R([{id:"1",position:0,color:"#000000",bias:.5,interpolation:"linear"},{id:"2",position:1,color:"#FFFFFF",bias:.5,interpolation:"linear"}],"srgb"),h(new Set)})},{label:"Output Mode",action:()=>{},isHeader:!0},{label:"sRGB (Standard)",checked:n==="srgb",action:V(()=>R(i,"srgb"))},{label:"Linear (Physical)",checked:n==="linear",action:V(()=>R(i,"linear"))},{label:"Inverse ACES",checked:n==="aces_inverse",action:V(()=>R(i,"aces_inverse"))}];d(U.clientX,U.clientY,te,[o||"ui.gradient_editor"])},J=U=>{U.stopPropagation(),U.preventDefault();const V=U.currentTarget.getBoundingClientRect();T({x:V.left,y:V.bottom+5})},re=U=>{const V=Oe(U.currentTarget);V.length>0&&(U.preventDefault(),U.stopPropagation(),d(U.clientX,U.clientY,[],V))};return e.jsxs("div",{className:"w-full select-none",ref:L,"data-help-id":o||"ui.gradient_editor",onContextMenu:re,onMouseDown:U=>{var V,te;U.button===0&&(U.target.closest(".gradient-interactive-element")||(!U.shiftKey&&!U.ctrlKey&&!((V=_.current)!=null&&V.contains(U.target))&&h(new Set),(te=_.current)!=null&&te.contains(U.target)||W("marquee",[],U)))},children:[e.jsxs("div",{className:"flex items-center justify-between mb-1",children:[e.jsx("div",{className:"flex items-center gap-2 cursor-pointer text-[10px] font-semibold text-gray-400 hover:text-white tracking-wider gradient-interactive-element",onClick:()=>M(!g),children:e.jsx("span",{className:`transform transition-transform duration-200 text-base ${g?"rotate-90":""}`,children:""})}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"text-[8px] font-bold text-gray-600 uppercase cursor-pointer hover:text-cyan-400 transition-colors select-none",onClick:z,title:"Click to switch Color Profile",children:n==="srgb"?"Standard":n==="linear"?"Linear":"ACES"}),e.jsx("button",{className:"gradient-interactive-element p-1 rounded hover:bg-white/10 text-gray-400 hover:text-white transition-colors active:scale-95",onClick:J,title:"Presets",children:e.jsx(po,{})}),j&&e.jsx(Mc,{x:j.x,y:j.y,onClose:()=>T(null),options:[{label:"Clipboard",action:()=>{},isHeader:!0},{label:"Copy Gradient",action:N},{label:"Paste Gradient",action:P},{label:"Presets",action:()=>{},isHeader:!0},...Sc.map(U=>({label:U.name,action:()=>$(U.stops),stops:U.stops}))]})]})]}),e.jsxs("div",{className:"relative",onContextMenu:Q,children:[e.jsx("div",{className:"h-8 w-full rounded-t border border-white/20 relative mb-0 cursor-pointer",style:{background:ja(i)},onDoubleClick:U=>{U.preventDefault(),h(new Set(i.map(V=>V.id)))},title:"Double-click to select all",children:m&&[...i].sort((U,V)=>U.position-V.position).map((U,V,te)=>{if(V>=te.length-1||te[V+1].position-U.position<.02)return null;const K=U.position+(te[V+1].position-U.position)*U.bias;return e.jsx("div",{className:"bias-handle gradient-interactive-element absolute top-1/2 -translate-y-1/2 w-3 h-3 transform -translate-x-1/2 cursor-ew-resize z-10",style:{left:`${K*100}%`},onMouseDown:ae=>{ae.button===0&&W("bias",[U.id],ae)},children:e.jsx(kc,{})},`bias-${U.id}`)})}),e.jsxs("div",{ref:_,className:"h-6 w-full bg-white/5 border-x border-b border-white/10 relative rounded-b cursor-crosshair",onMouseDown:H,title:"Click & drag to add/move knot",children:[i.map(U=>e.jsx("div",{className:`gradient-interactive-element absolute top-0 w-4 h-5 -ml-2 cursor-grab active:cursor-grabbing z-20 flex flex-col items-center group transition-opacity duration-200 ${C&&p.has(U.id)?"opacity-30":"opacity-100"}`,style:{left:`${U.position*100}%`},onMouseDown:V=>{V.stopPropagation();const te=V.button===2;let K=new Set(p);V.shiftKey||V.ctrlKey?p.has(U.id)?K.delete(U.id):K.add(U.id):(!p.has(U.id)||!te)&&(K=new Set([U.id])),h(K),te||W("knot",Array.from(K),V)},children:e.jsx(jc,{color:U.color,isSelected:p.has(U.id)})},U.id)),A&&e.jsxs("div",{className:"gradient-interactive-element absolute -bottom-3 h-3 border-l-2 border-r-2 border-b-4 border-[#6D48E3] z-10",style:{left:`calc(${A.min*100}% - 15px)`,width:`calc(${(A.max-A.min)*100}% + 30px)`,pointerEvents:"none"},children:[e.jsx("div",{className:"absolute bottom-0 left-0 right-0 h-8 cursor-grab active:cursor-grabbing pointer-events-auto",onMouseDown:U=>{U.button===0&&W("bracket_move",Array.from(p),U)}}),e.jsx("div",{className:"absolute bottom-0 -left-0 w-2 h-4 bg-[#6D48E3] cursor-ew-resize pointer-events-auto rounded-sm",onMouseDown:U=>{U.button===0&&W("bracket_scale_left",Array.from(p),U)}}),e.jsx("div",{className:"absolute bottom-0 -right-0 w-2 h-4 bg-[#6D48E3] cursor-ew-resize pointer-events-auto rounded-sm",onMouseDown:U=>{U.button===0&&W("bracket_scale_right",Array.from(p),U)}})]})]})]}),g&&e.jsx("div",{className:"flex flex-col animate-slider-entry gradient-interactive-element overflow-hidden",children:F.length>0?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"mb-px mt-2",children:e.jsx(da,{color:G,onColorChange:E})}),e.jsxs("div",{className:"flex flex-col",children:[e.jsx(vt,{label:"Interpolation",value:I,onChange:U=>q("interpolation",U),options:[...I==="mixed"?[{label:"Mixed",value:"mixed"}]:[],{label:"Linear",value:"linear"},{label:"Step",value:"step"},{label:"Smooth",value:"smooth"}],className:"mb-px"}),F.length===1&&e.jsx(Me,{label:"Position",value:F[0].position*100,min:0,max:100,step:.1,onChange:U=>q("position",U/100)}),e.jsx(Me,{label:"Bias (Midpoint)",value:D===-1?50:D*100,min:0,max:100,step:1,onChange:U=>q("bias",U/100),overrideInputText:D===-1?"Mixed":void 0})]})]}):e.jsx("div",{className:"h-1 bg-white/5 opacity-50 mt-1"})}),b&&wt.createPortal(e.jsx("div",{className:"fixed border border-blue-400 bg-blue-500/20 z-[9999] pointer-events-none",style:{left:b.x,top:b.y,width:b.w,height:b.h}}),document.body)]})},Pc=({label:a,valueX:t,valueY:o,onChange:r,min:n,max:i})=>{const s=v.useRef(null),[l,d]=v.useState(!1),{handleInteractionStart:c,handleInteractionEnd:f}=Y(),u=y=>(y-n)/(i-n)*100,p=y=>n+y/100*(i-n),h=y=>{y.preventDefault(),c("param"),d(!0),y.target.setPointerCapture(y.pointerId),m(y)},g=y=>{l&&m(y)},M=y=>{l&&(d(!1),y.target.releasePointerCapture(y.pointerId),f())},m=y=>{if(!s.current)return;const x=s.current.getBoundingClientRect(),C=Math.max(0,Math.min(100,(y.clientX-x.left)/x.width*100)),S=100-Math.max(0,Math.min(100,(y.clientY-x.top)/x.height*100)),b=p(C),w=p(S);r(b,w)};return e.jsxs("div",{className:"mb-3",children:[e.jsxs("div",{className:"flex justify-between items-center mb-1",children:[e.jsx("label",{className:"text-xs text-gray-400 font-medium",children:a}),e.jsxs("div",{className:"flex gap-1 w-32 h-5",children:[e.jsx("div",{className:"flex-1 bg-black/40 rounded border border-white/10 relative overflow-hidden",children:e.jsx(_e,{value:t,onChange:y=>r(y,o),step:.01,highlight:!0})}),e.jsx("div",{className:"flex-1 bg-black/40 rounded border border-white/10 relative overflow-hidden",children:e.jsx(_e,{value:o,onChange:y=>r(t,y),step:.01,highlight:!0})})]})]}),e.jsxs("div",{ref:s,className:"w-full h-24 bg-gray-900 border border-gray-700 rounded relative cursor-crosshair touch-none overflow-hidden hover:border-gray-500 transition-colors",onPointerDown:h,onPointerMove:g,onPointerUp:M,children:[e.jsx("div",{className:"absolute top-1/2 left-0 right-0 h-px bg-gray-800 pointer-events-none"}),e.jsx("div",{className:"absolute left-1/2 top-0 bottom-0 w-px bg-gray-800 pointer-events-none"}),e.jsx("div",{className:`absolute w-3 h-3 border-2 border-white rounded-full -ml-1.5 -mt-1.5 shadow-md pointer-events-none transition-transform ${l?"scale-125 bg-cyan-500":"bg-transparent"}`,style:{left:`${u(t)}%`,top:`${100-u(o)}%`}})]})]})},Rc=[{label:"X",color:"bg-red-500",text:"text-red-400",border:"group-focus-within:border-red-500/50"},{label:"Y",color:"bg-green-500",text:"text-green-400",border:"group-focus-within:border-green-500/50"},{label:"Z",color:"bg-blue-500",text:"text-blue-400",border:"group-focus-within:border-blue-500/50"}],Ua=({axisIndex:a,value:t,min:o,max:r,step:n,onUpdate:i,onDragStart:s,onDragEnd:l,disabled:d})=>{const[c,f]=v.useState(!1),[u,p]=v.useState(""),h=v.useRef(null),g=v.useRef(0),M=v.useRef(0),m=v.useRef(!1),y=Rc[a];let x=0;if(Number.isFinite(o)&&Number.isFinite(r)){const T=r-o,L=isNaN(t)?o:t;x=Math.min(100,Math.max(0,(L-o)/T*100))}const C=T=>{d||c||T.button===0&&(T.preventDefault(),T.stopPropagation(),T.currentTarget.setPointerCapture(T.pointerId),g.current=T.clientX,M.current=isNaN(t)?0:t,m.current=!1,s())},k=T=>{if(c||d||!T.currentTarget.hasPointerCapture(T.pointerId))return;const L=T.clientX-g.current;if(Math.abs(L)>2&&(m.current=!0),!m.current&&Math.abs(L)<2)return;T.preventDefault(),T.stopPropagation();let R=.005*(Number.isFinite(r)&&Number.isFinite(o)?r-o:10);T.shiftKey&&(R*=10),T.altKey&&(R*=.1);let z=M.current+L*R;n&&(z=Math.round(z/n)*n),Number.isFinite(o)&&Number.isFinite(r)&&(z=Math.min(r,Math.max(o,z))),isNaN(z)||i(z)},S=T=>{d||c||(T.currentTarget.releasePointerCapture(T.pointerId),l(),m.current||b(),m.current=!1,T.stopPropagation())},b=()=>{f(!0),p(t.toFixed(4)),setTimeout(()=>{h.current&&(h.current.focus(),h.current.select())},10)},w=()=>{const T=parseFloat(u);isNaN(T)?i(t):(s(),i(T),l()),f(!1)},j=T=>{T.key==="Enter"&&w(),T.key==="Escape"&&f(!1),T.stopPropagation()};return e.jsxs("div",{className:`relative flex-1 h-6 bg-black/40 border border-white/10 rounded overflow-hidden group transition-colors ${y.border} ${d?"opacity-50 pointer-events-none":"hover:border-white/30"}`,onPointerDown:C,onPointerMove:k,onPointerUp:S,children:[!c&&Number.isFinite(o)&&Number.isFinite(r)&&e.jsx("div",{className:`absolute top-0 bottom-0 left-0 opacity-20 transition-all duration-75 pointer-events-none ${y.color}`,style:{width:`${x}%`}}),e.jsx("div",{className:"absolute top-0 bottom-0 left-0 w-4 flex items-center justify-center border-r border-white/5 bg-white/5 pointer-events-none select-none",children:e.jsx("span",{className:`text-[8px] font-black ${y.text}`,children:y.label})}),e.jsx("div",{className:"absolute inset-0 left-4 right-0 flex items-center",children:c?e.jsx("input",{ref:h,type:"text",value:u,onChange:T=>p(T.target.value),onBlur:w,onKeyDown:j,className:"w-full h-full bg-black text-white text-[9px] font-mono px-2 outline-none border-none"}):e.jsx("div",{className:"w-full h-full flex items-center justify-end px-2 cursor-ew-resize",children:e.jsx("span",{className:"text-[9px] font-mono text-gray-300 group-hover:text-white transition-colors select-none",children:t.toFixed(3)})})})]})},zc=({label:a,value:t,onChange:o,min:r=-1e4,max:n=1e4,step:i=.01,disabled:s=!1,convertRadToDeg:l=!1,onDragStart:d,onDragEnd:c,headerRight:f})=>{const[u,p]=v.useState(t||new ie(0,0,0)),h=v.useRef(!1),g=v.useRef(null),M=Math.PI/180;v.useEffect(()=>{!h.current&&t&&p(t.clone())},[t==null?void 0:t.x,t==null?void 0:t.y,t==null?void 0:t.z]);const m=()=>{h.current=!0,g.current=u.clone(),d&&d()},y=()=>{g.current=null,h.current=!1,c&&c()},x=(C,k)=>{const b=(g.current||u).clone();if(b[C]=k,p(b),l){const w=b.clone();w.x*=M,w.y*=M,w.z*=M,o(b)}else o(b)};return e.jsxs("div",{className:"flex flex-col gap-1 mb-2",children:[a&&e.jsxs("div",{className:"flex justify-between items-end px-1",children:[e.jsx("label",{className:"text-[9px] font-bold text-gray-500 uppercase tracking-wider select-none",children:a}),f]}),e.jsxs("div",{className:"flex gap-1",children:[e.jsx(Ua,{axisIndex:0,value:u.x,min:r,max:n,step:i,onUpdate:C=>x("x",C),onDragStart:m,onDragEnd:y,disabled:s}),e.jsx(Ua,{axisIndex:1,value:u.y,min:r,max:n,step:i,onUpdate:C=>x("y",C),onDragStart:m,onDragEnd:y,disabled:s}),e.jsx(Ua,{axisIndex:2,value:u.z,min:r,max:n,step:i,onUpdate:C=>x("z",C),onDragStart:m,onDragEnd:y,disabled:s})]})]})},za=({interactionMode:a="param",trackKeys:t,trackLabels:o,...r})=>{const{handleInteractionStart:n,handleInteractionEnd:i}=Y(),{sequence:s,currentFrame:l,isPlaying:d,addTrack:c,addKeyframe:f,removeKeyframe:u,snapshot:p,isRecording:h}=xe(),g=v.useRef(r.value),M=()=>{n(a),h&&t&&(p(),t.forEach((b,w)=>{if(b){const j=o?o[w]:b;s.tracks[b]||c(b,j)}}))},m=()=>{if(h&&t){const b=["x","y","z"];t.forEach((w,j)=>{if(w){let T=g.current[b[j]];f(w,l,T)}})}i()},y=b=>{g.current=b,r.onChange(b)},C=(()=>{if(!t||t.length!==3)return"none";let b=!1,w=!1,j=!1;const T=["x","y","z"];return t.forEach((L,_)=>{const R=s.tracks[L];if(R){b=!0;const z=R.keyframes.find(E=>Math.abs(E.frame-l)<.1);if(z&&(w=!0),!d){let E=r.value[T[_]],N=0;z?N=z.value:N=Qe(R.keyframes,l,!1),Math.abs(N-E)>.05&&(j=!0)}}}),b?w?j?"keyed-dirty":"keyed":j?"dirty":"partial":"none"})(),k=()=>{if(!t)return;const b=["x","y","z"];p(),C==="keyed"?t.forEach(w=>{const j=s.tracks[w];if(j){const T=j.keyframes.find(L=>Math.abs(L.frame-l)<.1);T&&u(w,T.id)}}):t.forEach((w,j)=>{const T=o?o[j]:w;s.tracks[w]||c(w,T);let L=r.value[b[j]];f(w,l,L)})},S=t?e.jsx(ca,{status:C,onClick:k}):void 0;return e.jsx(zc,{...r,onChange:y,onDragStart:M,onDragEnd:m,headerRight:S})},Fc=({label:a,value:t,min:o,max:r,step:n=.01,onChange:i,size:s=40,color:l="#22d3ee",tooltip:d,unconstrained:c=!1,defaultValue:f,onDragStart:u,onDragEnd:p})=>{const[h,g]=v.useState(!1),M=v.useRef(0),m=v.useRef(0),y=r-o,x=Math.max(o,Math.min(r,t)),C=Math.max(0,Math.min(1,(x-o)/y)),k=-135+C*270,S=s/2-4,b=s/2,w=s/2,j=2*Math.PI*S,T=j,L=j*(1-C*.75),_=N=>{N.preventDefault(),N.stopPropagation(),g(!0),M.current=N.clientY,m.current=t,u&&u(),N.target.setPointerCapture(N.pointerId)},R=N=>{if(!h)return;N.preventDefault();const P=M.current-N.clientY;let $=.005;N.shiftKey&&($*=5),N.altKey&&($*=.1);const O=P*$*y;let X=m.current+O;c||(X=Math.max(o,Math.min(r,X))),n&&(X=Math.round(X/n)*n),i(X)},z=N=>{g(!1),p&&p(),N.target.releasePointerCapture(N.pointerId)},E=N=>{N.preventDefault(),N.stopPropagation(),f!==void 0&&(u&&u(),i(f),p&&p())};return e.jsxs("div",{className:"flex flex-col items-center gap-1 select-none touch-none group",title:d||`${t.toFixed(2)}`,onDoubleClick:E,children:[e.jsxs("div",{className:"relative cursor-ns-resize",style:{width:s,height:s},onPointerDown:_,onPointerMove:R,onPointerUp:z,children:[e.jsxs("svg",{width:s,height:s,className:"overflow-visible transform rotate-90",children:[e.jsx("circle",{cx:b,cy:w,r:S,fill:"none",stroke:"#333",strokeWidth:"3",strokeDasharray:j,strokeDashoffset:j*.25,strokeLinecap:"round"}),e.jsx("circle",{cx:b,cy:w,r:S,fill:"none",stroke:h?"#fff":l,strokeWidth:"3",strokeDasharray:T,strokeDashoffset:L,strokeLinecap:"round",className:"transition-colors duration-200"})]}),e.jsx("div",{className:"absolute w-1.5 h-1.5 bg-white rounded-full shadow-sm pointer-events-none",style:{top:"50%",left:"50%",marginTop:-3,marginLeft:-3,transform:`rotate(${k}deg) translate(0, -${S}px)`}})]}),e.jsx("div",{className:"h-3 min-w-[30px] flex items-center justify-center bg-black/40 rounded px-1 border border-white/5 hover:border-white/20 transition-colors",children:e.jsx(yo,{value:t,onChange:i,min:c?void 0:o,max:c?void 0:r,step:n,onDragStart:u,onDragEnd:p})}),a&&e.jsx("span",{className:"text-[8px] text-gray-500 font-bold uppercase tracking-wide group-hover:text-gray-300 transition-colors -mt-0.5",children:a})]})},Ot=a=>{const{handleInteractionStart:t,handleInteractionEnd:o}=Y();return e.jsx(Fc,{...a,onDragStart:()=>{t("param"),a.onDragStart&&a.onDragStart()},onDragEnd:()=>{o(),a.onDragEnd&&a.onDragEnd()}})};class Ic{constructor(){Z(this,"components",new Map)}register(t,o){this.components.has(t)&&console.warn(`ComponentRegistry: Overwriting component '${t}'`),this.components.set(t,o)}get(t){return this.components.get(t)}}const Ne=new Ic,ao=({label:a,isActive:t,onToggle:o,numericValue:r,onNumericChange:n,options:i,onOptionChange:s,status:l,disabled:d=!1,hideCheckbox:c=!1,description:f,min:u,max:p,step:h})=>{var _;const[g,M]=v.useState(!1),m=v.useRef(null),[y,x]=v.useState({top:0,right:0}),C=()=>{if(f&&m.current){const R=m.current.getBoundingClientRect();x({top:R.top+R.height/2,right:window.innerWidth-R.left+6}),M(!0)}},k=()=>M(!1),S=l==="pending"?"text-amber-400":t?"text-gray-300":"text-gray-500";let b="",w="";switch(l){case"pending":b="bg-amber-500 shadow-[0_0_6px_rgba(245,158,11,0.6)] animate-pulse",w="Pending Compilation (Click Apply)";break;case"runtime":b="bg-blue-500 shadow-[0_0_4px_rgba(59,130,246,0.5)]",w="Runtime Uniform (Instant Update)";break;case"synced":default:b=t?"bg-green-500 shadow-[0_0_4px_rgba(34,197,94,0.4)]":"bg-gray-700",w="Compiled & Active";break}const j=i&&r!==void 0?(_=i.find(R=>R.value==r))==null?void 0:_.label:"",T=h??(r!==void 0&&Number.isInteger(r)?1:.01);let L=1;return u!==void 0&&p!==void 0&&p>u&&(L=(p-u)*.01/T),e.jsxs(e.Fragment,{children:[e.jsxs("div",{ref:m,className:`flex items-center justify-between px-3 py-1.5 border-b border-white/5 hover:bg-white/5 transition-colors ${d?"opacity-30 pointer-events-none":""}`,onMouseEnter:C,onMouseLeave:k,children:[e.jsxs("div",{className:"flex items-center gap-2.5 flex-1 min-w-0",children:[e.jsx("div",{className:`w-1.5 h-1.5 rounded-full flex-shrink-0 transition-all duration-300 ${b}`,title:w}),e.jsxs("span",{className:`text-[10px] font-sans font-medium tracking-tight truncate ${S}`,children:[a," ",l==="pending"&&"*"]})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[i&&s?e.jsxs("div",{className:"relative w-20 h-4 bg-black/40 border border-white/10 rounded-sm hover:border-white/30 transition-colors",children:[e.jsx("select",{className:"absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10",value:r,onChange:R=>s(Number(R.target.value)),children:i.map(R=>e.jsx("option",{value:R.value,children:R.label},R.value))}),e.jsxs("div",{className:"absolute inset-0 flex items-center justify-between px-1.5 pointer-events-none",children:[e.jsx("span",{className:"text-[9px] text-cyan-400 font-mono font-medium truncate pr-1",children:j}),e.jsx("span",{className:"text-[6px] text-gray-500",children:""})]})]}):n&&r!==void 0&&e.jsx("div",{className:"w-10 h-4 bg-black/40 border border-white/10 relative overflow-hidden rounded-sm",children:e.jsx(_e,{value:r,onChange:n,step:T,min:u,max:p,sensitivity:L,highlight:t})}),!c&&e.jsx("input",{type:"checkbox",checked:t,onChange:()=>o(!t),className:`w-3 h-3 appearance-none border rounded-[2px] cursor-pointer transition-colors ${t?l==="pending"?"bg-amber-600 border-amber-500":"bg-cyan-600 border-cyan-500":"bg-black/40 border-gray-600 hover:border-gray-400"}`})]})]}),g&&wt.createPortal(e.jsx("div",{className:"fixed z-[9999] pointer-events-none flex items-center animate-fade-in",style:{top:y.top,right:y.right,transform:"translateY(-50%)"},children:e.jsxs("div",{className:"bg-black text-white text-[9px] px-2 py-1 rounded border border-white/20 shadow-xl whitespace-nowrap",children:[f,e.jsx("div",{className:"absolute top-1/2 -right-1 -translate-y-1/2 border-t-4 border-b-4 border-l-4 border-t-transparent border-b-transparent border-l-white/20"}),e.jsx("div",{className:"absolute top-1/2 -right-[3px] -translate-y-1/2 border-t-[3px] border-b-[3px] border-l-[3px] border-t-transparent border-b-transparent border-l-black"})]})}),document.body)]})},Fa=(a,t,o,r)=>{if(a.or)return a.or.some(s=>Fa(s,t,o,r));if(a.and)return a.and.every(s=>Fa(s,t,o,r));let n=a.param||r,i;if(n&&n.startsWith("$")){const s=n.slice(1);if(s.includes(".")){const l=s.split(".");let d=o;for(const c of l){if(d==null){d=void 0;break}d=d[c]}i=d}else i=o[s]}else if(n)i=t[n];else return!0;if(a.eq===void 0&&a.neq===void 0&&a.gt===void 0&&a.lt===void 0&&a.bool===void 0)return typeof i=="boolean"?i:typeof i=="number"?i>0:!!i;if(a.eq!==void 0||a.neq!==void 0){let s=i;if(typeof i=="object"&&i&&i.getHexString&&(s="#"+i.getHexString()),a.eq!==void 0)return s==a.eq;if(a.neq!==void 0)return s!=a.neq}return a.bool!==void 0?!!i===a.bool:a.gt!==void 0?i>a.gt:a.lt!==void 0?i<a.lt:!0},xa=(a,t,o,r)=>{if(!a){if(r){const n=t[r];return typeof n=="boolean"?n:typeof n=="number"?n>0:!!n}return!0}return Array.isArray(a)?a.every(n=>Fa(n,t,o,r)):Fa(a,t,o,r)},Ec=a=>{const t=a.min??0,o=a.max??1;if(a.scale==="pi")return{min:t/Math.PI,max:o/Math.PI,toSlider:r=>r/Math.PI,fromSlider:r=>r*Math.PI};if(!(!a.scale||a.scale==="linear")){if(a.scale==="square")return{min:0,max:100,toSlider:r=>Math.sqrt((r-t)/(o-t))*100,fromSlider:r=>t+Math.pow(r/100,2)*(o-t)};if(a.scale==="log"){const r=Math.max(1e-6,t);return{min:0,max:100,toSlider:n=>n<=t?0:(Math.log10(Math.max(r,n))-Math.log10(r))/(Math.log10(o)-Math.log10(r))*100,fromSlider:n=>n<=0?t:Math.pow(10,Math.log10(r)+n/100*(Math.log10(o)-Math.log10(r)))}}}},Ce=({featureId:a,groupFilter:t,className:o,isDisabled:r=!1,disabledParams:n=[],excludeParams:i=[],whitelistParams:s=[],variant:l="default",forcedState:d,onChangeOverride:c,pendingChanges:f})=>{var E;const u=ve.get(a),p=Y(N=>N[a]),h=d||p,g=Y(N=>N.liveModulations),M=Y(),m=Y(),y=Y(N=>N.openContextMenu),x=Y(N=>N.showHints),[C,k]=v.useState(null),S=v.useMemo(()=>`set${a.charAt(0).toUpperCase()+a.slice(1)}`,[a]),b=(N,P)=>{if(r||n.includes(N))return;if(c){c(N,P);return}const $=u.params[N];if($!=null&&$.confirmation&&P===!0&&h[N]===!1){k({key:N,value:P,message:$.confirmation});return}const O=m[S];O&&O({[N]:P})},w=()=>{if(!C)return;if(c){c(C.key,C.value),k(null);return}const N=m[S];N&&(le.emit("is_compiling","Optimizing Shader..."),setTimeout(()=>{N({[C.key]:C.value}),k(null)},50))},j=N=>{if(r)return;const P=Oe(N.currentTarget);P.length>0&&(N.preventDefault(),N.stopPropagation(),y(N.clientX,N.clientY,[],P))},T=(N,P)=>{if(!(r||n.includes(P))&&N.target.files&&N.target.files[0]){const $=new FileReader;$.onload=O=>{var X;(X=O.target)!=null&&X.result&&b(P,O.target.result)},$.readAsDataURL(N.target.files[0])}};if(!u||!h)return null;const L=(N,P)=>{var X;const $=h[N]??P.default,O=r||n.includes(N);if(l==="dense"){let W="runtime";if(P.onUpdate==="compile"&&(W=f&&f[`${a}.${N}`]!==void 0?"pending":"synced"),P.type==="boolean")return e.jsx(ao,{label:P.label,description:P.description,isActive:!!$,onToggle:H=>b(N,H),status:W,disabled:O});if(P.type==="float"||P.type==="int")return e.jsx(ao,{label:P.label,description:P.description,isActive:!0,onToggle:()=>{},numericValue:$,onNumericChange:H=>b(N,H),options:P.options,onOptionChange:P.options?H=>b(N,H):void 0,status:W,disabled:O,hideCheckbox:!0,step:P.step,min:P.min,max:P.max})}if(P.type==="color"){let W=$;return typeof $=="object"&&$.getHexString&&(W="#"+$.getHexString()),P.layout==="embedded"||P.parentId?e.jsx("div",{className:`mb-px pr-1 ${O?"opacity-30 pointer-events-none":""}`,children:e.jsx(da,{color:W,onColorChange:H=>b(N,H)})}):e.jsxs("div",{className:`flex items-center justify-between px-3 py-1 bg-gray-800/20 mb-px ${O?"opacity-30 pointer-events-none":""}`,children:[e.jsx("label",{className:"text-[10px] text-gray-400 font-bold uppercase tracking-wider",children:P.label}),e.jsx(Ra,{color:W,onChange:H=>b(N,H),label:P.label})]})}if(P.type==="boolean")return P.ui==="checkbox"?e.jsx("div",{className:O?"opacity-30 pointer-events-none":"",children:e.jsx(Ge,{label:P.label,value:$,onChange:W=>b(N,W),disabled:O,variant:"dense"})}):e.jsx("div",{className:`mb-1 ${P.parentId?"ml-1 p-1 pl-2 bg-white/5 border-l-2 border-white/10 rounded-r":""}`,children:e.jsx(Ge,{label:P.label,value:$,onChange:W=>b(N,W),options:P.options,disabled:O})});if(P.type==="float"||P.type==="int"){const W=P.onUpdate==="compile"?e.jsx("span",{className:"text-[8px] text-amber-400 font-bold ml-1",title:"Requires shader recompile",children:""}):null;if(P.options)return e.jsx("div",{className:`mb-px ${O?"opacity-30 pointer-events-none":""}`,children:e.jsx(vt,{label:P.label,value:$,onChange:D=>b(N,D),options:P.options,fullWidth:!0,labelSuffix:W})});if(P.ui==="knob")return e.jsx("div",{className:P.layout==="half"?"flex flex-col items-center justify-center py-2":"flex justify-center p-2",children:e.jsx(Ot,{label:P.label,value:$,min:P.min??0,max:P.max??1,step:P.step,onChange:D=>b(N,D),color:$>(P.min??0)?"#22d3ee":"#444",size:40})});const H=Ec(P);let A=P.format?P.format($):void 0;P.scale==="pi"&&(A=`${($/Math.PI).toFixed(2)}`);const F=`${a}.${N}`,I=g[F];return e.jsx("div",{children:e.jsx(Me,{label:P.label,value:$,min:P.min??0,max:P.max??1,step:P.step??.01,onChange:D=>b(N,D),highlight:$!==P.default,trackId:F,liveValue:I,defaultValue:P.default,customMapping:H,overrideInputText:A,mapTextInput:P.scale==="pi",disabled:O,labelSuffix:W})})}if(P.type==="vec2")return e.jsx("div",{className:`mb-2 ${O?"opacity-30 pointer-events-none":""}`,children:e.jsx(Pc,{label:P.label,valueX:($==null?void 0:$.x)??0,valueY:($==null?void 0:$.y)??0,min:P.min??-1,max:P.max??1,onChange:(W,H)=>b(N,{x:W,y:H})})});if(P.type==="vec3"){const W=$ instanceof ie?$:new ie($.x,$.y,$.z),H=P.composeFrom?P.composeFrom.map(A=>`${a}.${A}`):void 0;return e.jsx("div",{className:`mb-px ${O?"opacity-30 pointer-events-none":""}`,children:e.jsx(za,{label:P.label,value:W,min:P.min??-10,max:P.max??10,step:P.step,onChange:A=>b(N,A),disabled:O,trackKeys:H})})}if(P.type==="image"){const W=((X=P.linkedParams)==null?void 0:X.colorSpace)||"colorSpace",H=u.params[W],A=h[W],F=()=>{if(H&&typeof A=="number"){const D=(A+1)%3;b(W,D)}},I=A===1?"LIN":A===2?"ACES":"sRGB";return e.jsx("div",{className:`mb-px ${O?"opacity-30 pointer-events-none":""}`,children:e.jsxs("div",{className:"bg-gray-800/30 border border-white/5 text-center overflow-hidden relative group",children:[e.jsx("input",{type:"file",accept:"image/*",onChange:D=>T(D,N),className:"hidden",id:`file-input-${N}`}),e.jsx("label",{htmlFor:`file-input-${N}`,className:"block bg-cyan-900/40 hover:bg-cyan-800/60 text-cyan-300 w-full py-2 text-xs font-bold transition-colors cursor-pointer uppercase",children:$?"Replace Texture":P.label}),H&&e.jsx("div",{className:"absolute right-1 top-1/2 -translate-y-1/2 text-[8px] font-bold text-gray-500 bg-black/50 px-1.5 py-0.5 rounded cursor-pointer hover:text-white hover:bg-cyan-900/80 transition-colors select-none",onClick:D=>{D.preventDefault(),F()},title:"Input Color Profile: sRGB / Linear / ACES",children:I})]})})}return P.type==="gradient"?e.jsx("div",{className:`pr-1 ${O?"opacity-30 pointer-events-none":""}`,children:e.jsx(Tc,{value:$,onChange:W=>b(N,W)})}):null},_=(N,P=!1)=>{const $=u.params[N];if(!$||$.hidden||i.includes(N)||!xa($.condition,h,M,$.parentId)||$.isAdvanced&&!M.advancedMode)return null;const O=L(N,$),W=Object.keys(u.params).filter(A=>u.params[A].parentId===N).map(A=>_(A)).filter(Boolean),H=P?"flex-1 min-w-0":"flex flex-col";return e.jsxs("div",{className:`w-full ${H}`,children:[O,x&&$.description&&!r&&l!=="dense"&&e.jsx("p",{className:"px-3 pb-2 text-[9px] text-gray-500 leading-tight italic border-l-2 border-white/5 ml-1 mb-1",children:$.description}),W.length>0&&e.jsx("div",{className:"ml-2 flex flex-col",children:W})]},N)},R=Object.keys(u.params).filter(N=>u.params[N].parentId?!1:s&&s.length>0?s.includes(N):t?u.params[N].group===t:!0),z=[];for(let N=0;N<R.length;N++){const P=R[N],$=u.params[P];if(!($.hidden||i.includes(P)||!xa($.condition,h,M))){if($.layout==="half"&&l!=="dense"){let O=R[N+1],X=O?u.params[O]:null;if(X&&X.layout==="half"&&!X.hidden&&!i.includes(O)&&xa(X.condition,h,M)){z.push(e.jsxs("div",{className:"flex gap-0.5 mb-px",children:[_(P,!0),_(O,!0)]},`${P}-${O}`)),N++;continue}}z.push(_(P))}}return(E=u.customUI)==null||E.forEach(N=>{if(s&&s.length>0||t&&N.group!==t||!xa(N.condition,h,M))return;const P=Ne.get(N.componentId);P&&z.push(e.jsx("div",{className:`flex flex-col mb-2 ${r?"grayscale opacity-30 pointer-events-none":""}`,children:e.jsx(P,{featureId:a,sliceState:h,actions:m,...N.props})},`custom-${N.componentId}`))}),e.jsxs("div",{className:`flex flex-col relative ${o||""}`,onContextMenu:j,children:[z,C&&e.jsx("div",{className:"absolute inset-0 z-50 animate-pop-in",children:e.jsxs("div",{className:"bg-black/95 border border-white/20 rounded shadow-2xl overflow-hidden h-full flex flex-col",children:[e.jsxs("div",{className:"flex items-center gap-2 p-2 border-b border-white/10 bg-white/5",children:[e.jsx(Zt,{}),e.jsx("span",{className:"text-[10px] font-bold uppercase tracking-widest text-gray-300",children:"Warning"})]}),e.jsxs("div",{className:"p-3 flex-1 flex flex-col justify-between",children:[e.jsx("p",{className:"text-[10px] text-gray-400 leading-relaxed whitespace-pre-wrap",children:C.message}),e.jsxs("div",{className:"flex gap-1 mt-4",children:[e.jsx("button",{onClick:()=>k(null),className:"flex-1 py-1.5 bg-gray-800 text-gray-300 text-[9px] font-bold uppercase rounded border border-white/10 hover:bg-gray-700 transition-colors",children:"Cancel"}),e.jsx("button",{onClick:w,className:"flex-1 py-1.5 bg-cyan-900/50 text-cyan-300 text-[9px] font-bold uppercase rounded border border-cyan-500/30 hover:bg-cyan-900 transition-colors",children:"Confirm"})]})]})]})})]})},Nc=()=>{const a=Y(),t=a.lighting;return t?e.jsxs("div",{className:"absolute top-full mt-4 left-1/2 -translate-x-1/2 w-52 bg-black border border-white/20 rounded-xl p-2 shadow-2xl z-[70] animate-fade-in origin-top",children:[e.jsx("div",{className:"absolute -top-1.5 left-1/2 -translate-x-1/2 w-3 h-3 bg-black border-t border-l border-white/20 transform rotate-45"}),e.jsxs("div",{className:"relative space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between border-b border-white/10 pb-2 px-1",children:[e.jsx("span",{className:"text-[10px] font-bold text-gray-400 uppercase tracking-wider",children:"Shadows"}),e.jsx("button",{onClick:()=>{a.handleInteractionStart("param"),a.setLighting({shadows:!t.shadows}),a.handleInteractionEnd()},className:`text-[9px] font-bold px-2 py-0.5 rounded border transition-colors ${t.shadows?"bg-yellow-500/20 text-yellow-300 border-yellow-500/50":"bg-gray-800 text-gray-500 border-gray-600"}`,children:t.shadows?"ENABLED":"DISABLED"})]}),t.shadows&&e.jsx("div",{className:"space-y-1",children:e.jsx(Ce,{featureId:"lighting",groupFilter:"shadows"})})]})]}):null},Dc=({isMobileMode:a,vibrate:t})=>{var R;const o=Y(),r=o.lighting,{openContextMenu:n,handleInteractionStart:i,handleInteractionEnd:s}=Y(),[l,d]=v.useState(null),[c,f]=v.useState(null),[u,p]=v.useState(!1),[h,g]=v.useState(!1),M=v.useRef(null),m=v.useRef(null),y=v.useRef(null),x=v.useRef(null);v.useEffect(()=>{const z=E=>{const N=E.target;m.current&&!m.current.contains(N)&&!N.closest(".shadow-toggle-btn")&&p(!1),a&&c!==null&&!N.closest(".light-orb-wrapper")&&f(null),h&&x.current&&!x.current.contains(N)&&!N.closest(".expand-trigger")&&g(!1)};return document.addEventListener("mousedown",z),document.addEventListener("touchstart",z),()=>{document.removeEventListener("mousedown",z),document.removeEventListener("touchstart",z)}},[c,a,h]);const C=(z,E)=>{z.preventDefault(),z.stopPropagation(),n(z.clientX,z.clientY,[],E)},k=(z,E)=>{z.preventDefault(),z.stopPropagation();const N=Dt(o.lighting,E),P=[{label:`Light ${E+1}`,isHeader:!0,action:()=>{}},{label:"Enabled",checked:N.visible,action:()=>{i("param"),o.updateLight({index:E,params:{visible:!N.visible}}),s()}},{label:"Type",isHeader:!0,action:()=>{}},{label:"Point",checked:N.type==="Point",action:()=>{i("param"),o.updateLight({index:E,params:{type:"Point"}}),s()}},{label:"Directional (Sun)",checked:N.type==="Directional",action:()=>{i("param"),o.updateLight({index:E,params:{type:"Directional"}}),s()}}];n(z.clientX,z.clientY,P,["panel.light"])},S=z=>{const E=Dt(o.lighting,z);if(!a){t(5),i("param"),o.updateLight({index:z,params:{visible:!E.visible}}),s();return}E.visible?c!==z?(t(5),f(z)):(t([10,30,10]),i("param"),o.updateLight({index:z,params:{visible:!1}}),s(),f(null)):(t(10),i("param"),o.updateLight({index:z,params:{visible:!0}}),s(),f(null))},b=(z,E)=>{a||E.nativeEvent.pointerType==="touch"||(M.current&&clearTimeout(M.current),d(z))},w=()=>{a||(M.current=window.setTimeout(()=>{d(null)},400))},j=z=>{t(5),o.setDraggedLight(z),a||(f(null),d(null))},T=()=>{o.addLight()},L=((R=o.lighting)==null?void 0:R.lights)||[],_=z=>{const E=L[z];return E?e.jsxs("div",{className:"relative light-orb-wrapper flex justify-center w-8 h-8",onMouseEnter:N=>b(z,N),onMouseLeave:w,onContextMenu:N=>k(N,z),children:[e.jsx(vc,{index:z,color:E.color,active:E.visible,type:E.type,rotation:E.rotation,onClick:()=>S(z),onDragStart:()=>j(z)}),o.draggedLightIndex!==z&&(l===z||c===z)&&e.jsx(_n,{index:z})]},z):z<He?e.jsx("div",{className:"flex justify-center items-center w-8 h-8",children:e.jsx("button",{onClick:T,className:"w-8 h-8 rounded-full border border-white/10 flex items-center justify-center text-gray-500 hover:text-cyan-400 hover:border-cyan-500/50 hover:bg-white/5 transition-all",title:"Add Light",children:e.jsx(sa,{})})},z):e.jsx("div",{className:"w-8 h-8"},z)};return e.jsxs("div",{ref:y,className:"absolute left-1/2 -translate-x-1/2 flex items-center bg-white/5 pr-2 pl-6 py-1.5 rounded-full border border-white/5 shadow-inner z-[65]",children:[e.jsxs("div",{className:"relative",children:[e.jsxs("div",{className:`flex items-center gap-6 transition-opacity duration-200 ${h?"opacity-0 pointer-events-none":"opacity-100"}`,children:[[0,1,2].map(z=>_(z)),e.jsx("button",{onClick:()=>{t(5),g(!0)},className:"expand-trigger w-5 h-5 flex items-center justify-center rounded-full bg-white/5 hover:bg-white/10 text-gray-400 hover:text-white transition-colors ml-[-8px]",title:"Expand Light Studio",children:e.jsx(Rt,{})})]}),h&&e.jsx("div",{ref:x,className:"absolute top-[-20px] left-[-20px] bg-black/95 border border-white/20 p-5 rounded-2xl shadow-2xl animate-fade-in z-[80]",children:e.jsxs("div",{className:"grid grid-cols-3 gap-6",children:[Array.from({length:8}).map((z,E)=>_(E)),e.jsx("div",{className:"flex justify-center items-center w-8 h-8",children:e.jsx("button",{onClick:()=>g(!1),className:"w-8 h-8 rounded-full border border-white/10 flex items-center justify-center text-gray-500 hover:text-white hover:bg-white/10 transition-colors",title:"Collapse",children:e.jsx(wn,{})})})]})})]}),e.jsx("div",{className:"h-6 w-px bg-white/10 mx-4"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("div",{className:"relative",ref:m,children:[e.jsx("button",{onClick:z=>{z.stopPropagation(),t(5),p(!u)},onContextMenu:z=>C(z,["shadows"]),className:`shadow-toggle-btn p-2 rounded-full border transition-all duration-300 ${r!=null&&r.shadows?"bg-yellow-500/10 border-yellow-500/50 text-yellow-300 shadow-[0_0_10px_rgba(234,179,8,0.1)]":"bg-transparent border-transparent text-gray-600 hover:text-gray-300 hover:bg-white/5"}`,title:"Shadow Settings",children:e.jsx(Ul,{})}),u&&e.jsx(Nc,{})]}),e.jsx("button",{onClick:()=>{t(5),i("param"),o.setShowLightGizmo(!o.showLightGizmo),s()},onContextMenu:z=>C(z,["ui.viewport"]),className:`p-2 rounded-full border transition-all duration-300 ${o.showLightGizmo?"bg-cyan-500/20 border-cyan-500 text-cyan-300 shadow-[0_0_10px_rgba(34,211,238,0.2)]":"bg-transparent border-transparent text-gray-600 hover:text-gray-300 hover:bg-white/5"}`,children:e.jsx(Hl,{})})]})]})},Lc=({isMobileMode:a,vibrate:t,btnBase:o,btnActive:r,btnInactive:n})=>{const i=Y(),{movePanel:s}=i,[l,d]=v.useState(!1),[c,f]=v.useState(!1),u=v.useRef(null),p=v.useRef(null),h=async()=>{if(B.renderer){f(!0),d(!1),await new Promise(x=>setTimeout(x,50));try{const x=await B.captureSnapshot();if(!x){console.error("Snapshot generation returned null.");return}const C=i.getPreset({includeScene:!0}),k=JSON.stringify(C),S=i.prepareExport(),b=uo(i.projectSettings.name,S,"png");try{const w=await Br(x,"FractalData",k),j=URL.createObjectURL(w),T=document.createElement("a");T.download=b,T.href=j,T.click(),URL.revokeObjectURL(j),t(50)}catch(w){console.error("Metadata injection failed, saving raw image",w);const j=URL.createObjectURL(x),T=document.createElement("a");T.download=b,T.href=j,T.click(),URL.revokeObjectURL(j)}}catch(x){console.error("Snapshot failed",x)}finally{f(!1)}}},g=x=>{x.stopPropagation(),a?(t(5),d(!l)):h()},M=()=>{a||(u.current&&clearTimeout(u.current),d(!0))},m=()=>{a||(u.current=window.setTimeout(()=>{d(!1)},200))},y=()=>{t(5),s("Camera Manager","left"),d(!1)};return v.useEffect(()=>{if(!a||!l)return;const x=C=>{const k=C.target;p.current&&!p.current.contains(k)&&!k.closest(".camera-menu-trigger")&&d(!1)};return document.addEventListener("mousedown",x),document.addEventListener("touchstart",x),()=>{document.removeEventListener("mousedown",x),document.removeEventListener("touchstart",x)}},[l,a]),e.jsxs(e.Fragment,{children:[c&&e.jsx("div",{className:"fixed inset-0 z-[9999] flex items-center justify-center bg-black/50 backdrop-blur-sm animate-fade-in",children:e.jsxs("div",{className:"bg-gray-900 border border-cyan-500/50 rounded-xl px-6 py-4 shadow-2xl flex items-center gap-3",children:[e.jsx("div",{className:"w-5 h-5 border-2 border-cyan-400 border-t-transparent rounded-full animate-spin"}),e.jsx("span",{className:"text-cyan-300 font-bold text-sm tracking-wide",children:"Capturing..."})]})}),e.jsxs("div",{className:"relative",ref:p,onMouseEnter:M,onMouseLeave:m,children:[e.jsx("button",{onClick:g,className:`camera-menu-trigger ${o} ${l?r:n}`,title:a?"Camera Menu":"Click: Take Snapshot / Hover: Camera Menu",children:e.jsx(er,{})}),l&&e.jsxs("div",{className:"absolute top-full right-0 mt-2 w-48 bg-black border border-white/20 rounded-xl p-2 shadow-2xl z-[70] animate-fade-in origin-top-right",children:[e.jsx("div",{className:"absolute -top-1.5 right-4 w-3 h-3 bg-black border-t border-l border-white/20 transform rotate-45"}),e.jsx("div",{className:"px-2 py-1 text-[10px] font-bold text-gray-500 uppercase tracking-wider border-b border-white/10 mb-1",children:"Camera Tools"}),e.jsxs("div",{className:"space-y-1",children:[e.jsxs("button",{onClick:()=>{t(5),i.undoCamera()},disabled:i.undoStack.length===0,className:"w-full flex items-center justify-between p-2 rounded hover:bg-white/10 disabled:opacity-30 text-xs text-gray-300 text-left",children:[e.jsxs("span",{className:"flex items-center gap-2",children:[e.jsx(Dl,{})," Undo Move"]}),e.jsx("kbd",{className:"text-[8px] text-gray-500 bg-gray-800 px-1 rounded",children:"Ctrl+Shift+Z"})]}),e.jsxs("button",{onClick:()=>{t(5),i.redoCamera()},disabled:i.redoStack.length===0,className:"w-full flex items-center justify-between p-2 rounded hover:bg-white/10 disabled:opacity-30 text-xs text-gray-300 text-left",children:[e.jsxs("span",{className:"flex items-center gap-2",children:[e.jsx(Ll,{})," Redo Move"]}),e.jsx("kbd",{className:"text-[8px] text-gray-500 bg-gray-800 px-1 rounded",children:"Ctrl+Shift+Y"})]}),e.jsxs("button",{onClick:()=>{t(30),i.resetCamera(),i.setShowLightGizmo(!1)},className:"w-full flex items-center gap-2 p-2 rounded hover:bg-white/10 text-xs text-gray-300 text-left",children:[e.jsx(Cn,{})," Reset Position"]}),e.jsx("div",{className:"h-px bg-white/10 my-1"}),e.jsxs("button",{onClick:y,className:"w-full flex items-center gap-2 p-2 rounded hover:bg-white/10 text-xs text-cyan-300 text-left",children:[e.jsx(go,{})," Camera Manager"]}),e.jsx("div",{className:"h-px bg-white/10 my-1"}),e.jsxs("button",{onClick:h,className:"w-full flex items-center gap-2 p-2 rounded hover:bg-cyan-900/50 text-xs text-cyan-400 font-bold text-left",title:"Save PNG with embedded scene data",children:[e.jsx(er,{})," Take Snapshot"]})]})]})]})]})},Ac=({isMobileMode:a,vibrate:t,btnBase:o,btnActive:r,btnInactive:n})=>{const i=Y(),s=i,{handleInteractionStart:l,handleInteractionEnd:d}=i,[c,f]=v.useState(!1),[u,p]=v.useState(!1),[h,g]=v.useState(""),[M,m]=v.useState(null),[y,x]=v.useState(null),C=v.useRef(null),k=v.useRef(null),S=ve.getMenuFeatures(),b=ve.getExtraMenuItems(),w=lo(i),j=w.charAt(0).toUpperCase()+w.slice(1);v.useEffect(()=>{if(B.renderer){const A=B.renderer.getContext(),F=A.getExtension("WEBGL_debug_renderer_info");g(F?A.getParameter(F.UNMASKED_RENDERER_WEBGL):"Generic WebGL Device")}},[]),v.useEffect(()=>{const A=F=>{const I=F.target;if(C.current&&!C.current.contains(I)){if(I.closest(".portal-dropdown-content")||I.closest(".t-dropdown"))return;f(!1),p(!1)}};return c&&(document.addEventListener("mousedown",A),document.addEventListener("touchstart",A)),()=>{document.removeEventListener("mousedown",A),document.removeEventListener("touchstart",A)}},[c]);const T=A=>{A.stopPropagation(),t(5),f(!c)},L=()=>{const A=i.prepareExport(),F=i.projectSettings,I=i.getPreset(),D=new Blob([JSON.stringify(I,null,2)],{type:"application/json"}),G=URL.createObjectURL(D),q=document.createElement("a");q.href=G,q.download=uo(F.name,A,"json"),q.click(),URL.revokeObjectURL(G)},_=()=>{var A;return(A=k.current)==null?void 0:A.click()},R=async A=>{var I;const F=(I=A.target.files)==null?void 0:I[0];if(F){le.emit("is_compiling","Processing..."),await new Promise(D=>setTimeout(D,50));try{let D="";if(F.type==="image/png"){const q=await Or(F,"FractalData");if(q)D=q;else throw new Error("No Fractal Data found in this image.")}else D=await F.text();const G=JSON.parse(D);i.loadPreset(G),t(50),f(!1)}catch(D){console.error("Load Failed:",D),le.emit("is_compiling",!1),x("Error!"),setTimeout(()=>x(null),2e3),alert("Could not load preset. "+D.message)}A.target.value=""}},z=()=>{let F=i.getShareString({includeAnimations:!0}),I="";if(F.length>4096){const G=i.getShareString({includeAnimations:!1});G.length<F.length&&G.length<4096?(F=G,I=" (Anims Removed)"):I=" (Long URL)"}const D=`${window.location.origin}${window.location.pathname}#s=${F}`;navigator.clipboard.writeText(D).then(()=>{m(`Copied!${I}`),t(50),setTimeout(()=>m(null),2500)})},E=()=>{var G,q,Q,J,re,U,V,te,K;t(20);const A=i.getPreset(),F=Le.get(i.formula);if(!F||!F.defaultPreset)return;const I=F.defaultPreset,D={...I,cameraPos:A.cameraPos,cameraRot:A.cameraRot,sceneOffset:A.sceneOffset,targetDistance:A.targetDistance,cameraMode:A.cameraMode,lights:A.lights,features:{...I.features||{},atmosphere:(G=A.features)==null?void 0:G.atmosphere,lighting:(q=A.features)==null?void 0:q.lighting,optics:(Q=A.features)==null?void 0:Q.optics,materials:(J=A.features)==null?void 0:J.materials,coreMath:(re=I.features)==null?void 0:re.coreMath,geometry:(U=I.features)==null?void 0:U.geometry,coloring:(V=I.features)==null?void 0:V.coloring,texturing:(te=I.features)==null?void 0:te.texturing,quality:(K=I.features)==null?void 0:K.quality}};l("param"),i.loadPreset(D),d(),f(!1)},N=()=>{var I,D,G,q,Q;t(20);const A=i.getPreset();l("camera"),i.resetCamera();const F=(I=Le.get("Mandelbulb"))==null?void 0:I.defaultPreset;if(F){const J={...A,cameraPos:F.cameraPos,cameraRot:F.cameraRot,sceneOffset:F.sceneOffset,targetDistance:F.targetDistance,features:{...A.features,atmosphere:(D=F.features)==null?void 0:D.atmosphere,lighting:(G=F.features)==null?void 0:G.lighting,optics:(q=F.features)==null?void 0:q.optics,materials:(Q=F.features)==null?void 0:Q.materials}};i.loadPreset(J)}d(),f(!1)},P=(A,F,I)=>{const D=`set${A.charAt(0).toUpperCase()+A.slice(1)}`,G=i[D];if(G){G({[F]:I});const q=ve.get(A);if(q!=null&&q.tabConfig){const Q=q.tabConfig.label;A==="engineSettings"?I&&i.movePanel(Q,"left"):I?i.floatTab(Q):i.dockTab(Q)}}},$=(A,F=!1)=>{const I=s[A.id||A.featureId];if(!I)return null;const D=!!I[A.toggleParam],G=A.id==="audio"?"bg-green-600":"bg-cyan-600",q=A.id==="audio"?"text-green-400":"text-cyan-400";if(F){const Q={Code:e.jsx(_l,{}),Info:e.jsx(ho,{})},J=A.icon?Q[A.icon]:null;return e.jsxs("button",{onClick:re=>{re.stopPropagation(),t(5),P(A.featureId,A.toggleParam,!D),f(!1)},className:`w-full flex items-center justify-between p-2 rounded transition-colors group ${D?"bg-white/10 text-cyan-400":"hover:bg-white/5 text-gray-300"}`,children:[e.jsx("span",{className:"text-xs font-bold",children:A.label}),J]},`${A.featureId}-${A.toggleParam}`)}return e.jsxs("label",{className:"flex items-center justify-between p-2 rounded hover:bg-white/5 cursor-pointer animate-fade-in-left",children:[e.jsx("span",{className:`text-xs font-bold ${D?q:"text-gray-300"}`,children:A.label}),e.jsx("div",{className:`w-8 h-4 rounded-full p-0.5 transition-colors ${D?G:"bg-gray-700"}`,children:e.jsx("div",{className:`w-3 h-3 bg-white rounded-full transition-transform ${D?"translate-x-4":"translate-x-0"}`})}),e.jsx("input",{type:"checkbox",className:"hidden",checked:D,onChange:Q=>P(A.id,A.toggleParam,Q.target.checked)})]},A.id)},O=A=>{t(10),le.emit("is_compiling","Switching Profile..."),setTimeout(()=>{i.applyPreset({mode:A.toLowerCase(),actions:i})},10)},X=S.filter(A=>!A.advancedOnly),W=S.filter(A=>A.advancedOnly),H=b.filter(A=>A.advancedOnly);return e.jsxs(e.Fragment,{children:[!a&&e.jsxs(e.Fragment,{children:[e.jsxs("button",{onClick:z,className:`${o} ${n} relative`,title:"Copy Share Link",children:[e.jsx(na,{}),M&&e.jsx("div",{className:"absolute top-full mt-2 left-1/2 -translate-x-1/2 px-2 py-1 bg-green-600 text-white text-[9px] font-bold uppercase rounded whitespace-nowrap animate-fade-in",children:M})]}),e.jsx("button",{onClick:L,className:`${o} ${n}`,title:"Save Preset (JSON)",children:e.jsx(to,{})}),e.jsxs("button",{onClick:_,className:`${o} ${n} relative`,title:"Load Preset (JSON or PNG)",children:[e.jsx(Qo,{}),y&&e.jsx("div",{className:"absolute top-full mt-2 left-1/2 -translate-x-1/2 px-2 py-1 bg-blue-600 text-white text-[9px] font-bold uppercase rounded whitespace-nowrap animate-fade-in",children:y})]})]}),e.jsx("input",{ref:k,type:"file",accept:".json,.png",className:"hidden",onChange:R}),e.jsxs("div",{className:"relative",ref:C,children:[e.jsx("button",{onClick:T,className:`${o} ${c?r:n}`,children:e.jsx(po,{})}),c&&e.jsxs("div",{className:"absolute top-full right-0 mt-2 w-64 bg-black border border-white/20 rounded-xl p-2 shadow-2xl z-[70] animate-fade-in origin-top-right custom-scroll overflow-y-auto max-h-[85vh]",children:[e.jsx("div",{className:"absolute -top-1.5 right-4 w-3 h-3 bg-black border-t border-l border-white/20 transform rotate-45"}),e.jsxs("div",{className:"space-y-1",children:[e.jsxs("button",{onClick:A=>{A.stopPropagation(),z()},className:"w-full flex items-center justify-between p-2 rounded hover:bg-white/5 text-gray-300 transition-colors group",children:[e.jsx("span",{className:`text-xs font-bold ${M?"text-green-400":"group-hover:text-white"}`,children:M||"Copy Share Link"}),e.jsx(na,{active:!!M})]}),e.jsx("div",{className:"h-px bg-white/10 my-1"}),a&&e.jsxs(e.Fragment,{children:[e.jsxs("button",{onClick:A=>{A.stopPropagation(),T(A),L()},className:"w-full flex items-center justify-between p-2 rounded hover:bg-white/5 text-gray-300 transition-colors group border-b border-white/10 mb-1",children:[e.jsx("span",{className:"text-xs font-bold group-hover:text-white",children:"Save Preset"}),e.jsx(to,{})]}),e.jsxs("button",{onClick:A=>{A.stopPropagation(),T(A),_()},className:"w-full flex items-center justify-between p-2 rounded hover:bg-white/5 text-gray-300 transition-colors group border-b border-white/10 mb-1",children:[e.jsx("span",{className:"text-xs font-bold group-hover:text-white",children:"Load Preset"}),e.jsx(Qo,{})]}),e.jsx("div",{className:"h-px bg-white/10 my-1"})]}),e.jsxs("button",{onClick:A=>{A.stopPropagation(),E()},className:"w-full flex items-center justify-between p-2 rounded hover:bg-white/5 text-gray-300 hover:text-white transition-colors group",children:[e.jsx("span",{className:"text-xs font-bold",children:"Reset Formula"}),e.jsx(Cn,{})]}),e.jsxs("button",{onClick:A=>{A.stopPropagation(),N()},className:"w-full flex items-center justify-between p-2 rounded hover:bg-white/5 text-gray-300 hover:text-white transition-colors group",children:[e.jsx("span",{className:"text-xs font-bold",children:"Reset Scene"}),e.jsx(la,{})]}),e.jsx("div",{className:"h-px bg-white/10 my-1"}),X.map(A=>$(A)),e.jsx("div",{className:"h-px bg-white/10 my-1"}),$({id:"engineSettings",toggleParam:"showEngineTab",label:"Engine Settings"}),e.jsx("div",{className:"px-2 mb-1 mt-0.5",children:e.jsx(vt,{value:j,onChange:O,selectClassName:"!text-left pl-2",options:[{label:"Fastest (Bare)",value:"Fastest"},{label:"Lite (Fast)",value:"Lite"},{label:"Balanced",value:"Balanced"},{label:"Ultra",value:"Ultra"},{label:"---",value:"Custom"}],fullWidth:!0})}),e.jsxs("button",{onClick:A=>{A.stopPropagation(),i.setIsBroadcastMode(!0)},className:"w-full flex items-center justify-between p-2 rounded hover:bg-white/5 text-gray-300 transition-colors group",children:[e.jsxs("span",{className:"text-xs font-bold group-hover:text-cyan-400",children:["Hide Interface ",e.jsx("span",{className:"text-gray-500 font-normal",children:"[B]"})]}),e.jsx(El,{})]}),e.jsxs("label",{className:"flex items-center justify-between p-2 rounded hover:bg-white/5 cursor-pointer",children:[e.jsx("span",{className:"text-xs text-gray-300 font-bold",children:"Invert Look Y"}),e.jsx("div",{className:`w-8 h-4 rounded-full p-0.5 transition-colors ${i.invertY?"bg-cyan-600":"bg-gray-700"}`,children:e.jsx("div",{className:`w-3 h-3 bg-white rounded-full transition-transform ${i.invertY?"translate-x-4":"translate-x-0"}`})}),e.jsx("input",{type:"checkbox",className:"hidden",checked:i.invertY,onChange:A=>{t(5),i.setInvertY(A.target.checked)}})]}),e.jsx("div",{className:"h-px bg-white/10 my-1"}),e.jsxs("label",{className:"flex items-center justify-between p-2 rounded hover:bg-white/5 cursor-pointer",title:"Keyboard: ` (tilde)",children:[e.jsxs("span",{className:"text-xs text-gray-300 font-bold",children:["Advanced Mode ",e.jsx("span",{className:"text-gray-500 font-normal",children:"[`]"})]}),e.jsx("div",{className:`w-8 h-4 rounded-full p-0.5 transition-colors ${i.advancedMode?"bg-purple-600":"bg-gray-700"}`,children:e.jsx("div",{className:`w-3 h-3 bg-white rounded-full transition-transform ${i.advancedMode?"translate-x-4":"translate-x-0"}`})}),e.jsx("input",{type:"checkbox",className:"hidden",checked:i.advancedMode,onChange:A=>i.setAdvancedMode(A.target.checked)})]}),i.advancedMode&&e.jsxs("div",{className:"mt-1 pl-2 border-l border-white/10 ml-2",children:[W.map(A=>$(A)),H.map(A=>$(A,!0)),e.jsxs("label",{className:"flex items-center justify-between p-2 rounded hover:bg-white/5 cursor-pointer",children:[e.jsx("span",{className:"text-xs text-gray-300 font-bold",children:"Force Mobile UI"}),e.jsx("div",{className:`w-8 h-4 rounded-full p-0.5 transition-colors ${i.debugMobileLayout?"bg-purple-600":"bg-gray-700"}`,children:e.jsx("div",{className:`w-3 h-3 bg-white rounded-full transition-transform ${i.debugMobileLayout?"translate-x-4":"translate-x-0"}`})}),e.jsx("input",{type:"checkbox",className:"hidden",checked:i.debugMobileLayout,onChange:A=>i.setDebugMobileLayout(A.target.checked)})]})]}),e.jsx("div",{className:"h-px bg-white/10 my-1"}),e.jsxs("label",{className:"flex items-center justify-between p-2 rounded hover:bg-white/5 cursor-pointer",title:"Keyboard: H",children:[e.jsxs("span",{className:"text-xs text-gray-300 font-bold",children:["Show Hints ",e.jsx("span",{className:"text-gray-500 font-normal",children:"[H]"})]}),e.jsx("div",{className:`w-8 h-4 rounded-full p-0.5 transition-colors ${i.showHints?"bg-green-600":"bg-gray-700"}`,children:e.jsx("div",{className:`w-3 h-3 bg-white rounded-full transition-transform ${i.showHints?"translate-x-4":"translate-x-0"}`})}),e.jsx("input",{type:"checkbox",className:"hidden",checked:i.showHints,onChange:A=>{t(5),i.setShowHints(A.target.checked)}})]}),e.jsxs("button",{onClick:A=>{A.stopPropagation(),t(5),i.openHelp("general.shortcuts"),f(!1)},className:"w-full flex items-center justify-between p-2 rounded hover:bg-white/5 text-cyan-400 transition-colors group",children:[e.jsx("span",{className:"text-xs font-bold group-hover:text-cyan-200",children:"Help"}),e.jsx(Mn,{})]}),e.jsxs("button",{onClick:A=>{A.stopPropagation(),t(5),p(!u)},className:`w-full flex items-center justify-between p-2 rounded transition-colors ${u?"bg-white/10 text-cyan-400":"hover:bg-white/5 text-gray-300"}`,children:[e.jsx("span",{className:"text-xs font-bold",children:"About GMT"}),e.jsx(Bl,{})]}),u&&e.jsx("div",{className:"p-3 bg-white/5 rounded-lg border border-white/5 animate-fade-in mt-1",children:e.jsxs("div",{className:"text-[10px] text-gray-400 leading-relaxed space-y-2",children:[h&&e.jsxs("div",{className:"mb-2 pb-2 border-b border-white/10",children:[e.jsx("div",{className:"text-[8px] text-gray-500 uppercase font-bold tracking-widest mb-1",children:"Active Renderer"}),e.jsx("div",{className:"text-[9px] text-green-400 font-mono break-all",children:h})]}),e.jsxs("p",{children:["GMT was crafted with  by ",e.jsx("span",{className:"text-white font-bold",children:"Guy Zack"})," using ",e.jsx("a",{href:"https://aistudio.google.com",target:"_blank",rel:"noopener noreferrer",className:"text-cyan-400 hover:underline",children:"Gemini"}),"."]}),e.jsxs("div",{className:"flex flex-col gap-1 pt-2 border-t border-white/10",children:[e.jsxs("a",{href:"https://www.reddit.com/r/GMT_fractals/",target:"_blank",rel:"noopener noreferrer",className:"flex items-center gap-2 hover:text-white transition-colors",children:[e.jsx("span",{children:"Community:"}),e.jsx("span",{className:"text-cyan-400 hover:underline",children:"r/GMT_fractals"})]}),e.jsxs("a",{href:"https://github.com/gamazama/GMT-fractals",target:"_blank",rel:"noopener noreferrer",className:"flex items-center gap-2 hover:text-white transition-colors",children:[e.jsx("span",{children:"Source:"}),e.jsx("span",{className:"text-cyan-400 hover:underline",children:"GitHub (GPL-3.0)"})]})]})]})})]})]})]})]})},_c=()=>{const a=Y(),[t,o]=v.useState(window.innerWidth),[r,n]=v.useState(!1);v.useEffect(()=>{const f=()=>o(window.innerWidth),u=()=>n(window.matchMedia("(pointer: coarse)").matches);return window.addEventListener("resize",f),u(),()=>window.removeEventListener("resize",f)},[]);const i=a.debugMobileLayout||t<768||r,s=(f=10)=>{navigator.vibrate&&navigator.vibrate(f)},l="p-2.5 rounded-lg transition-all active:scale-95 border flex items-center justify-center",d="bg-transparent border-transparent text-gray-400 hover:text-white hover:bg-white/10 hover:border-white/10",c="bg-gray-800 border-gray-600 text-white";return e.jsxs("header",{className:"relative shrink-0 w-full h-14 z-[500] bg-black/90 border-b border-white/10 flex items-center justify-between px-6 animate-fade-in-down select-none",children:[e.jsx(bc,{isMobileMode:i,vibrate:s}),e.jsx(Dc,{isMobileMode:i,vibrate:s}),e.jsxs("div",{className:"flex gap-2 relative items-center",children:[e.jsx(Lc,{isMobileMode:i,vibrate:s,btnBase:l,btnActive:c,btnInactive:d}),e.jsx("div",{className:"h-6 w-px bg-white/10 mx-1"}),e.jsx(Ac,{isMobileMode:i,vibrate:s,btnBase:l,btnActive:c,btnInactive:d})]})]})},it={gridColor:"#333",zeroLineColor:"#666",keyColor:"#fbbf24",keySelectedColor:"#fff",handleColor:"#a855f7",handleLineColor:"#6b21a8",backgroundColor:"#050505"},Bn=(a,t)=>(a-t.panX)*t.scaleX,oo=(a,t)=>a/t.scaleX+t.panX,Je=(a,t)=>t.height/2-(a-t.panY)*t.scaleY,ya=(a,t)=>{const o=t.height/2;return t.panY+(o-a)/t.scaleY},or=(a,t=50)=>{const o=t/a,r=Math.floor(Math.log10(o)),n=Math.pow(10,r),i=o/n;let s=1;return i>5?s=10:i>2?s=5:i>1?s=2:s=1,s*n},On=a=>{const r=[1,2,5,10,25,50,100,250,500,1e3,5e3];let n=r.find(s=>s*a>=40)||1e3,i=r.find(s=>s*a>=6)||n;return n%i!==0&&(i=n),{textStep:n,lineStep:i}},ba=(a,t,o)=>{let r=1/0,n=-1/0,i=1/0,s=-1/0,l=!1;const d=(c,f)=>{o&&o.length>0&&!o.includes(`${f}::${c.id}`)||(l=!0,c.value<r&&(r=c.value),c.value>n&&(n=c.value),c.frame<i&&(i=c.frame),c.frame>s&&(s=c.frame))};return a.forEach(c=>{const f=t.tracks[c];f&&f.keyframes.forEach(u=>d(u,c))}),l?{minV:r,maxV:n,minF:i,maxF:s}:null},va=8,rr=24,Bc=(a,t,o,r,n,i,s,l,d,c,f,u)=>{const{sequence:p,currentFrame:h,updateKeyframe:g,updateKeyframes:M,selectKeyframe:m,selectKeyframes:y,deselectAllKeys:x,selectTracks:C,selectTrack:k,selectedKeyframeIds:S,snapshot:b,setIsScrubbing:w,seek:j,softSelectionEnabled:T,softSelectionRadius:L,setSoftSelection:_,softSelectionType:R}=xe(),z=v.useRef(!1),E=v.useRef({x:0,y:0}),N=v.useRef({x:0,y:0}),P=v.useRef({panX:0,panY:0}),$=v.useRef(null),O=v.useRef(!1),X=v.useRef([]),W=v.useRef(new Map),H=v.useRef({}),A=v.useRef(null),F=v.useRef({x:0,y:0}),[I,D]=v.useState(null),[G,q]=v.useState({isAdjusting:!1,anchorKey:null}),Q=v.useRef({view:t,normalized:r,trackRanges:n,sequence:p,currentFrame:h,selectedKeyframeIds:S,trackIds:o,v2p:i,canvasPixelToFrame:f,frameToCanvasPixel:c,onSetScroll:s,onSetFrameWidth:l,setViewY:d,softSelectionEnabled:T,softSelectionRadius:L,setSoftSelection:_,softSelectionType:R});v.useEffect(()=>{Q.current={view:t,normalized:r,trackRanges:n,sequence:p,currentFrame:h,selectedKeyframeIds:S,trackIds:o,v2p:i,canvasPixelToFrame:f,frameToCanvasPixel:c,onSetScroll:s,onSetFrameWidth:l,setViewY:d,softSelectionEnabled:T,softSelectionRadius:L,setSoftSelection:_,softSelectionType:R}},[t,r,n,p,h,S,o,i,f,c,s,l,d,T,L,_,R]);const J=(K,ae)=>{for(const se of o){const ee=p.tracks[se];if(ee){for(const ne of ee.keyframes)if(!(!S.includes(`${se}::${ne.id}`)||ne.interpolation!=="Bezier")){if(ne.leftTangent){const de=ne.frame+ne.leftTangent.x,oe=r&&n[se]?(ne.value+ne.leftTangent.y-n[se].min)/n[se].span:ne.value+ne.leftTangent.y,ye=c(de),pe=Je(oe,t);if(Math.hypot(K-ye,ae-pe)<va)return{type:"handle",trackId:se,keyId:ne.id,side:"left",key:ne}}if(ne.rightTangent){const de=ne.frame+ne.rightTangent.x,oe=r&&n[se]?(ne.value+ne.rightTangent.y-n[se].min)/n[se].span:ne.value+ne.rightTangent.y,ye=c(de),pe=Je(oe,t);if(Math.hypot(K-ye,ae-pe)<va)return{type:"handle",trackId:se,keyId:ne.id,side:"right",key:ne}}}}}for(const se of o){const ee=p.tracks[se];if(ee)for(const ne of ee.keyframes){const he=c(ne.frame),de=i(ne.value,se);if(Math.abs(K-he)<va&&Math.abs(ae-de)<va)return{type:"key",trackId:se,keyId:ne.id,key:ne}}}return null},re=K=>{const ae=new Set;K.forEach(ee=>{ee&&ae.add(ee.split("::")[0])});const se=Array.from(ae);se.length>0&&(k(se[0],!1),se.length>1&&C(se.slice(1),!0))},U=v.useCallback(K=>{var ye;if(!z.current)return;const ae=Q.current,se=(ye=a.current)==null?void 0:ye.getBoundingClientRect();if(!se)return;const ee=K.clientX-se.left,ne=K.clientX-E.current.x,he=K.clientY-E.current.y,de=K.clientX-N.current.x,oe=K.clientY-N.current.y;if(Math.hypot(de,oe)>5&&(O.current=!0),$.current==="scrub"){const pe=ae.canvasPixelToFrame(ee),be=Math.max(0,Math.round(pe));j(be),Ke.scrub(be)}else if($.current==="scrub_passive"){const pe=ae.canvasPixelToFrame(ee),be=Math.max(0,Math.round(pe));j(be)}else if($.current==="pan"){const pe=oe/ae.view.scaleY,be=P.current.panX*ae.view.scaleX-de;ae.onSetScroll(be),ae.setViewY(fe=>({...fe,pan:P.current.panY+pe}))}else if($.current==="zoom"){const pe=1+ne*.01,be=Math.max(.1,ae.view.scaleX*pe),me=ae.canvasPixelToFrame(ee)-(ee-u)/be;ae.onSetFrameWidth(be),ae.onSetScroll(me*be);const ue=1-he*.01,ge=Math.max(.1,ae.view.scaleY*ue),ke=K.clientY-se.top,je=se.height/2,Ee=ae.view.panY+(je-ke)/ae.view.scaleY-(je-ke)/ge;ae.setViewY({pan:Ee,scale:ge})}else if($.current==="soft_radius"){const pe=Math.max(0,ae.softSelectionRadius+ne/ae.view.scaleX);ae.setSoftSelection(pe,!0)}else if($.current==="key"){const pe=de/ae.view.scaleX,be=-oe/ae.view.scaleY,fe=[];if(ae.softSelectionEnabled&&ae.softSelectionRadius>0){const me=new Set;X.current.forEach(ue=>me.add(ue.trackId)),me.forEach(ue=>{const ge=ae.sequence.tracks[ue];if(!ge)return;const ke=X.current.filter(je=>je.trackId===ue);ge.keyframes.forEach(je=>{const ze=je.id,Ee=`${ue}::${ze}`,Pe=H.current[Ee];if(!Pe)return;const we=ke.find(Ye=>Ye.keyId===ze);if(we){const Ye=Math.max(0,Math.round(we.startFrame+pe)),Ve=we.startVal+be;fe.push({trackId:ue,keyId:ze,patch:{frame:Ye,value:Ve}});return}let Re=0;for(const Ye of ke){const Ve=Math.abs(Pe.f-Ye.startFrame);if(Ve<ae.softSelectionRadius){const yt=Dn(Ve,ae.softSelectionRadius,ae.softSelectionType);yt>Re&&(Re=yt)}}if(Re>0){const Ye=Pe.v+be*Re,Ve=Math.max(0,Pe.f+pe*Re);fe.push({trackId:ue,keyId:je.id,patch:{value:Ye,frame:Math.round(Ve*100)/100}})}})})}else{const me=new Map;X.current.forEach(ue=>{me.set(ue.keyId,Math.max(0,Math.round(ue.startFrame+pe)))}),X.current.forEach(ue=>{let ge=Math.max(0,Math.round(ue.startFrame+pe)),ke=ue.startVal+be;const je={frame:ge,value:ke},ze=ae.sequence.tracks[ue.trackId];if(ze){const Ee=[...ze.keyframes].sort((we,Re)=>we.frame-Re.frame),Pe=Ee.find(we=>we.id===ue.keyId);if(Pe){const we=Ee.indexOf(Pe),Re=we>0?Ee[we-1]:void 0,Ye=we<Ee.length-1?Ee[we+1]:void 0,Ve={...Pe,leftTangent:ue.startLeftTan,rightTangent:ue.startRightTan},yt=Ln(Ve,Re,Ye,ue.startFrame,ge);Object.assign(je,yt);const pt={...Pe,frame:ge,value:ke,...je},Kt=Nn(pt,Re,Ye);Object.assign(je,Kt)}}fe.push({trackId:ue.trackId,keyId:ue.keyId,patch:je})}),W.current.forEach(ue=>{var ke,je;const ge={};if(ue.rightReferenceKeyId&&ue.startRightTan){const ze=me.get(ue.rightReferenceKeyId),Ee=(ke=X.current.find(Pe=>Pe.keyId===ue.rightReferenceKeyId))==null?void 0:ke.startFrame;if(ze!==void 0&&Ee!==void 0){const Pe=Ee-ue.frame,we=ze-ue.frame;if(Math.abs(Pe)>1e-5&&Math.abs(we)>1e-5){const Re=we/Pe;ge.rightTangent={x:ue.startRightTan.x*Re,y:ue.startRightTan.y*Re}}}}if(ue.leftReferenceKeyId&&ue.startLeftTan){const ze=me.get(ue.leftReferenceKeyId),Ee=(je=X.current.find(Pe=>Pe.keyId===ue.leftReferenceKeyId))==null?void 0:je.startFrame;if(ze!==void 0&&Ee!==void 0){const Pe=ue.frame-Ee,we=ue.frame-ze;if(Math.abs(Pe)>1e-5&&Math.abs(we)>1e-5){const Re=we/Pe;ge.leftTangent={x:ue.startLeftTan.x*Re,y:ue.startLeftTan.y*Re}}}}Object.keys(ge).length>0&&fe.push({trackId:ue.trackId,keyId:ue.keyId,patch:ge})})}M(fe),Ke.scrub(ae.currentFrame)}else if($.current==="handle"){if(!A.current)return;const{trackId:pe,keyId:be,side:fe,initialHandle:me}=A.current,ue=ae.sequence.tracks[pe];if(!ue)return;const ge=ue.keyframes.find(pt=>pt.id===be);if(!ge)return;const ke=ae.frameToCanvasPixel(ge.frame),je=ae.v2p(ge.value,pe);let ze=ee-ke,Pe=K.clientY-se.top-je,we=ze/ae.view.scaleX,Re=-Pe/ae.view.scaleY;if(ae.normalized){const pt=ae.trackRanges[pe];pt&&(Re*=pt.span)}if(K.shiftKey){const pt=me.x,Kt=me.y,Jn=we,ei=Re,Da=Math.sqrt(pt*pt+Kt*Kt);if(Da>1e-4){const vo=pt/Da,wo=Kt/Da;let So=Jn*vo+ei*wo;we=vo*So,Re=wo*So}}const Ye={x:we,y:Re},Ve={},yt=K.ctrlKey||ge.brokenTangents;yt!==ge.brokenTangents&&(Ve.brokenTangents=yt),fe==="left"?(Ve.leftTangent=Ye,!yt&&ge.rightTangent&&(Ve.rightTangent={x:-Ye.x,y:-Ye.y})):(Ve.rightTangent=Ye,!yt&&ge.leftTangent&&(Ve.leftTangent={x:-Ye.x,y:-Ye.y})),Ve.autoTangent=!1,g(pe,be,Ve),Ke.scrub(ae.currentFrame)}else if($.current==="box"&&F.current){const pe=K.clientY-se.top;D({x:Math.min(ee,F.current.x),y:Math.min(pe,F.current.y),w:Math.abs(ee-F.current.x),h:Math.abs(pe-F.current.y)})}E.current={x:K.clientX,y:K.clientY}},[j,g,M,u]),V=v.useCallback(K=>{var se;($.current==="scrub"||$.current==="scrub_passive")&&w(!1),z.current=!1;const ae=Q.current;if($.current==="box"&&F.current){const ee=(se=a.current)==null?void 0:se.getBoundingClientRect();if(ee){const ne=K.clientX-ee.left,he=K.clientY-ee.top,de=Math.min(ne,F.current.x),oe=Math.min(he,F.current.y),ye=Math.abs(ne-F.current.x),pe=Math.abs(he-F.current.y),be=[],fe=K.shiftKey||K.ctrlKey;ae.trackIds.forEach(ke=>{const je=ae.sequence.tracks[ke];je&&je.keyframes.forEach(ze=>{const Ee=ae.frameToCanvasPixel(ze.frame),Pe=ae.v2p(ze.value,ke);Ee>=de&&Ee<=de+ye&&Pe>=oe&&Pe<=oe+pe&&be.push(`${ke}::${ze.id}`)})}),y(be,fe);const me=new Set(ae.selectedKeyframeIds),ue=new Set(fe?me:[]);be.forEach(ke=>ue.add(ke));const ge=Array.from(ue);ge.length>0&&re(ge)}D(null)}$.current=null,X.current=[],W.current=new Map,H.current={},A.current=null,q({isAdjusting:!1,anchorKey:null}),setTimeout(()=>{O.current=!1},100),window.removeEventListener("mousemove",U),window.removeEventListener("mouseup",V)},[w,y,U]),te=K=>{var he;O.current=!1;const ae=(he=a.current)==null?void 0:he.getBoundingClientRect();if(!ae)return;const se=K.clientX-ae.left,ee=K.clientY-ae.top,ne=Q.current;if(E.current={x:K.clientX,y:K.clientY},N.current={x:K.clientX,y:K.clientY},P.current={panX:ne.view.panX,panY:ne.view.panY},K.altKey)K.button===0&&($.current="pan",z.current=!0),K.button===2&&($.current="zoom",z.current=!0);else if(K.button===1)if(K.preventDefault(),ee<rr){$.current="scrub_passive",z.current=!0,w(!0);const de=ne.canvasPixelToFrame(se);j(Math.max(0,Math.round(de)))}else $.current="pan",z.current=!0;else if(K.button===0)if(ee<rr){$.current="scrub",z.current=!0,w(!0);const de=ne.canvasPixelToFrame(se);j(Math.max(0,Math.round(de))),Ke.scrub(Math.max(0,Math.round(de)))}else{const de=J(se,ee);if(de){if(de.type==="handle"){$.current="handle";let oe={x:0,y:0};de.side==="left"&&de.key.leftTangent?oe={...de.key.leftTangent}:de.side==="right"&&de.key.rightTangent&&(oe={...de.key.rightTangent}),A.current={trackId:de.trackId,keyId:de.keyId,side:de.side,key:de.key,initialHandle:oe},z.current=!0,b()}else if(de.type==="key"){const oe=`${de.trackId}::${de.key.id}`;if(K.ctrlKey&&!A.current){if(z.current)return;$.current="soft_radius",z.current=!0,q({isAdjusting:!0,anchorKey:oe}),ne.softSelectionEnabled||ne.setSoftSelection(ne.softSelectionRadius||10,!0),ne.selectedKeyframeIds.includes(oe)||(m(de.trackId,de.keyId,!1),re([oe]))}else{$.current="key";const ye=K.shiftKey||K.metaKey;ne.selectedKeyframeIds.includes(oe)||(ye||x(),m(de.trackId,de.keyId,!0));const pe=ne.selectedKeyframeIds,be=pe.includes(oe)||ye?pe.includes(oe)?pe:[...pe,oe]:[oe];re(be);const fe=[],me={},ue=new Map,ge=new Set;be.forEach(je=>{if(!je)return;const[ze,Ee]=je.split("::"),Pe=p.tracks[ze],we=Pe==null?void 0:Pe.keyframes.find(Re=>Re.id===Ee);we&&(fe.push({trackId:ze,keyId:we.id,startFrame:we.frame,startVal:we.value,startLeftTan:we.leftTangent?{...we.leftTangent}:void 0,startRightTan:we.rightTangent?{...we.rightTangent}:void 0}),me[`${ze}::${we.id}`]={f:we.frame,v:we.value},ge.add(ze))});const ke=new Set(be);fe.forEach(je=>{const ze=p.tracks[je.trackId];if(!ze)return;const Ee=[...ze.keyframes].sort((we,Re)=>we.frame-Re.frame),Pe=Ee.findIndex(we=>we.id===je.keyId);if(Pe!==-1){if(Pe>0){const we=Ee[Pe-1],Re=`${je.trackId}::${we.id}`;ke.has(Re)||(ue.has(Re)||ue.set(Re,{trackId:je.trackId,keyId:we.id,frame:we.frame,startRightTan:we.rightTangent?{...we.rightTangent}:void 0}),ue.get(Re).rightReferenceKeyId=je.keyId)}if(Pe<Ee.length-1){const we=Ee[Pe+1],Re=`${je.trackId}::${we.id}`;ke.has(Re)||(ue.has(Re)||ue.set(Re,{trackId:je.trackId,keyId:we.id,frame:we.frame,startLeftTan:we.leftTangent?{...we.leftTangent}:void 0}),ue.get(Re).leftReferenceKeyId=je.keyId)}}}),ne.softSelectionEnabled&&ne.softSelectionRadius>0&&ge.forEach(je=>{const ze=p.tracks[je];ze&&ze.keyframes.forEach(Ee=>{const Pe=`${je}::${Ee.id}`;me[Pe]||(me[Pe]={f:Ee.frame,v:Ee.value})})}),X.current=fe,W.current=ue,H.current=me,z.current=!0,b()}}}else $.current="box",F.current={x:se,y:ee},D({x:se,y:ee,w:0,h:0}),z.current=!0,!K.shiftKey&&!K.ctrlKey&&x()}z.current&&(window.addEventListener("mousemove",U),window.addEventListener("mouseup",V))};return v.useEffect(()=>()=>{window.removeEventListener("mousemove",U),window.removeEventListener("mouseup",V)},[U,V]),{handleMouseDown:te,getHit:J,selectionBox:I,softInteraction:G,shouldSuppressContextMenu:()=>O.current}};function Oc(a,t,o,r,n){const i=new Float64Array(a),s=new Float64Array(a),l=new Float64Array(a),d=o[0];if(Math.abs(d)<1e-12)return i;s[0]=r[0]/d,l[0]=n[0]/d;for(let c=1;c<a;c++){const f=o[c]-t[c]*s[c-1];Math.abs(f)<1e-12||(c<a-1&&(s[c]=r[c]/f),l[c]=(n[c]-t[c]*l[c-1])/f)}i[a-1]=l[a-1];for(let c=a-2;c>=0;c--)i[c]=l[c]-s[c]*i[c+1];return i}const $c=(a,t,o,r)=>{const n=[],i=new Set(o),s=1,l=Math.max(0,r*5);return l<=.001||a.forEach(d=>{const c=t.tracks[d];if(!c||c.keyframes.length<3)return;const f=[...c.keyframes].sort((g,M)=>g.frame-M.frame),u=[];if(f.forEach((g,M)=>{i.has(`${d}::${g.id}`)&&u.push(M)}),u.length===0)return;const p=[];let h=[u[0]];for(let g=1;g<u.length;g++)u[g]===u[g-1]+1?h.push(u[g]):(p.push(h),h=[u[g]]);p.push(h),p.forEach(g=>{const M=g.length,m=g[0],y=g[M-1],x=new Float64Array(M),C=new Float64Array(M),k=new Float64Array(M),S=new Float64Array(M),b=m===0,w=y===f.length-1;if(M===1&&(b||w))return;for(let T=0;T<M;T++){const L=g[T],_=f[L].value;let R=-l,z=s+2*l,E=-l,N=s*_;T===0&&(m>0?(N-=R*f[m-1].value,R=0):(z=s+2*l,E=-2*l,R=0)),T===M-1&&(y<f.length-1?(N-=E*f[y+1].value,E=0):(z=s+2*l,R=-2*l,E=0)),C[T]=z,T>0&&(x[T]=R),T<M-1&&(k[T]=E),S[T]=N}const j=Oc(M,x,C,k,S);for(let T=0;T<M;T++){const L=g[T],_=f[L],R=j[T];Math.abs(R-_.value)>1e-9&&n.push({trackId:d,keyId:_.id,patch:{value:R}})}})}),n},Hc=({sequence:a,trackIds:t,selectedTrackIds:o,selectedKeyframeIds:r,frameWidth:n,view:i,normalized:s,trackRanges:l,v2p:d,canvasPixelToFrame:c})=>{const{updateKeyframes:f,snapshot:u,addKeyframe:p,selectKeyframes:h,bounceTension:g,bounceFriction:M}=xe(),[m,y]=v.useState(!1),[x,C]=v.useState(0),[k,S]=v.useState(!1),[b,w]=v.useState(1),[j,T]=v.useState(!1),[L,_]=v.useState(1),R=v.useRef({x:0,y:0}),z=v.useRef(null),E=v.useRef([]),N=v.useCallback(()=>{if(r.length>0){const U=new Set;return r.forEach(V=>{V&&U.add(V.split("::")[0])}),Array.from(U)}return o.length>0?o:[]},[r,o]),P=v.useCallback(()=>{if(r.length>0)return r;if(o.length>0){const U=[];return o.forEach(V=>{const te=a.tracks[V];te&&te.keyframes.forEach(K=>U.push(`${V}::${K.id}`))}),U}return[]},[r,o,a]),$=v.useCallback(U=>{if(!z.current)return;const V=N();if(V.length===0)return;const te=mc(V,z.current,U);if(te.length>0){const K=[];xe.setState(ae=>{const se={...ae.sequence.tracks};return te.forEach(ee=>{se[ee.trackId]&&(se[ee.trackId].keyframes=ee.newKeys,ee.newKeys.forEach(ne=>K.push(`${ee.trackId}::${ne.id}`)))}),{sequence:{...ae.sequence,tracks:se}}}),h(K,!1)}},[N,h]),O=v.useCallback(U=>{if(!z.current)return;const V=[],te=[],K=new Set(E.current),ae=new Set;E.current.forEach(se=>{se&&ae.add(se.split("::")[0])}),ae.forEach(se=>{const ee=z.current.tracks[se];if(!ee)return;const ne=ee.keyframes.filter(me=>K.has(`${se}::${me.id}`));if(ne.length<2)return;const he=ne.sort((me,ue)=>me.frame-ue.frame),de=he[0].frame,oe=he[he.length-1].frame,ye=ee.keyframes.filter(me=>me.frame<de-1e-4),pe=ee.keyframes.filter(me=>me.frame>oe+1e-4),be=gn(he,.01,U),fe=[...ye,...be,...pe].sort((me,ue)=>me.frame-ue.frame);V.push({trackId:se,newKeys:fe}),be.forEach(me=>te.push(`${se}::${me.id}`))}),V.length>0&&(xe.setState(se=>{const ee={...se.sequence.tracks};return V.forEach(ne=>{ee[ne.trackId]&&(ee[ne.trackId]={...ee[ne.trackId],keyframes:ne.newKeys})}),{sequence:{...se.sequence,tracks:ee}}}),h(te,!1))},[h]),X=v.useCallback(()=>{const U=N();if(U.length===0)return;u();const V=pc(U,a);V.length>0&&f(V)},[N,a,u,f]),W=v.useCallback(()=>{const U=r.length>0?r:t.map(te=>{var K;return(K=a.tracks[te])==null?void 0:K.keyframes.map(ae=>`${te}::${ae.id}`)}).flat().filter(Boolean),V={};U.forEach(te=>{if(!te)return;const[K,ae]=te.split("::");if(/rotation|rot|phase|twist/i.test(K)||/param[C-F]/i.test(K)){V[K]||(V[K]=[]);const se=a.tracks[K];if(!se)return;const ee=se.keyframes.find(ne=>ne.id===ae);ee&&V[K].push(ee)}});for(const te in V){const K=V[te].sort((ae,se)=>ae.frame-se.frame);for(let ae=0;ae<K.length-1;ae++)if(Math.abs(K[ae+1].value-K[ae].value)>Math.PI)return!0}return!1},[r,t,a]),H=U=>{N().length!==0&&(U.preventDefault(),U.stopPropagation(),U.target.setPointerCapture(U.pointerId),u(),z.current=JSON.parse(JSON.stringify(a)),R.current={x:U.clientX,y:U.clientY},C(.1),y(!0),window.addEventListener("pointermove",A),window.addEventListener("pointerup",F))},A=U=>{const te=(U.clientX-R.current.x)/30;if(Math.abs(te-x)>.01){if(C(te),!z.current)return;const K=N();let ae=r;ae.length===0&&(ae=P());let se=[];te>0?se=$c(K,z.current,ae,te):se=hc(K,a,ae,te,z.current,g,M),se.length>0&&f(se)}},F=()=>{y(!1),C(0),z.current=null,window.removeEventListener("pointermove",A),window.removeEventListener("pointerup",F)},I=U=>{N().length!==0&&(U.preventDefault(),U.stopPropagation(),U.target.setPointerCapture(U.pointerId),u(),z.current=JSON.parse(JSON.stringify(a)),R.current={x:U.clientX,y:U.clientY},w(1),S(!0),$(1),window.addEventListener("pointermove",D),window.addEventListener("pointerup",G))},D=U=>{const V=U.clientX-R.current.x,te=Math.max(1,1+Math.floor(V/30));te!==b&&(w(te),$(te))},G=()=>{S(!1),z.current=null,window.removeEventListener("pointermove",D),window.removeEventListener("pointerup",G)},q=U=>{let V=r;V.length<2&&(V=P()),!(V.length<2)&&(U.preventDefault(),U.stopPropagation(),U.target.setPointerCapture(U.pointerId),u(),z.current=JSON.parse(JSON.stringify(a)),R.current={x:U.clientX,y:U.clientY},E.current=[...V],_(1),T(!0),O(1),window.addEventListener("pointermove",Q),window.addEventListener("pointerup",J))},Q=U=>{const te=(U.clientX-R.current.x)/200,K=Math.max(0,Math.min(1,1+te));Math.abs(K-L)>.01&&(_(K),O(K))},J=()=>{T(!1),z.current=null,window.removeEventListener("pointermove",Q),window.removeEventListener("pointerup",J)},re=v.useCallback((U,V)=>{const te=U.clientX-V.left,K=U.clientY-V.top,ae=c(te),se=Math.max(0,Math.round(ae));let ee=10,ne=null,he=0;t.forEach(de=>{const oe=a.tracks[de];if(!oe||oe.keyframes.length===0)return;const ye=/rotation|rot|phase|twist/i.test(de)||/param[C-F]/i.test(de),pe=Qe(oe.keyframes,ae,ye),be=d(pe,de),fe=Math.abs(K-be);fe<ee&&(ee=fe,ne=de,he=pe)}),ne&&(u(),p(ne,se,he,"Bezier"))},[t,a,d,c,p,u]);return{isSmoothing:m,smoothingRadius:x,isBaking:k,bakeStep:b,isSimplifying:j,simplifyStrength:L,handleSmoothDown:H,handleBakeDown:I,handleSimplifyDown:q,applyEulerFilter:X,checkEulerNeeded:W,createKeyAtMouse:re}},Ia=["#22d3ee","#a855f7","#22c55e","#f59e0b","#ef4444","#ec4899"],De=aa,Uc=ta;let wa=null;const Gc=a=>{if(wa)return wa;const t=20,o=document.createElement("canvas");o.width=t,o.height=t;const r=o.getContext("2d");return r&&(r.strokeStyle="rgba(0,0,0,0.3)",r.lineWidth=10,r.lineCap="butt",r.beginPath(),r.moveTo(-10,10),r.lineTo(10,-10),r.moveTo(0,20),r.lineTo(20,0),r.moveTo(10,30),r.lineTo(30,10),r.stroke()),wa=a.createPattern(o,"repeat"),wa},Wc=(a,t,o,r)=>{if(!r.softSelectionEnabled||r.softSelectionRadius<=0)return 0;let n=0;return r.selectedKeyframeIds.forEach(i=>{const[s,l]=i.split("::");if(s!==o)return;const d=r.sequence.tracks[s],c=d==null?void 0:d.keyframes.find(f=>f.id===l);if(c){const f=Math.abs(t-c.frame);if(f<r.softSelectionRadius){const u=Dn(f,r.softSelectionRadius,r.softSelectionType);u>n&&(n=u)}}}),n},nr=(a,t,o,r,n,i,s,l,d)=>{const c=o.postBehavior||"Hold",f=l(n.frame);if(!(f>i)){if(a.save(),a.beginPath(),a.setLineDash([4,4]),a.globalAlpha=.5,a.moveTo(Math.max(De,f),s(n.value)),c==="Hold"){const u=s(n.value);a.lineTo(i,u)}else if(c==="Continue"){let u=0;const p=o.keyframes;if(p.length>1){const M=p[p.length-2];n.interpolation==="Linear"?u=(n.value-M.value)/(n.frame-M.frame):n.interpolation==="Bezier"&&(n.leftTangent&&Math.abs(n.leftTangent.x)>.001?u=n.leftTangent.y/n.leftTangent.x:u=(n.value-M.value)/(n.frame-M.frame))}const h=d(i),g=n.value+u*(h-n.frame);a.lineTo(i,s(g))}else{const u=n.frame-r.frame;if(u>.001){const h=o.id.startsWith("camera.rotation"),g=Math.max(f,De);a.moveTo(g,s(n.value));for(let M=g;M<i+5;M+=5){const y=d(M)-n.frame,x=Math.floor(y/u)+1,C=y%u;let k=0;if(c==="Loop"||c==="OffsetLoop"){const S=r.frame+C;if(k=Qe(o.keyframes,S,h),c==="OffsetLoop"){const b=n.value-r.value;k+=b*x}}else if(c==="PingPong")if(x%2===1){const b=n.frame-C;k=Qe(o.keyframes,b,h)}else{const b=r.frame+C;k=Qe(o.keyframes,b,h)}a.lineTo(M,s(k))}}else{const p=s(n.value);a.lineTo(i,p)}}a.stroke(),a.setLineDash([]),a.restore()}},qc=a=>{const{ctx:t,width:o,height:r,view:n,sequence:i,trackIds:s,currentFrame:l,durationFrames:d,selectedKeyframeIds:c,selectionBox:f,normalized:u,trackRanges:p,softSelectionEnabled:h,softSelectionRadius:g,softInteraction:M,highlightedTracks:m}=a,y=z=>Bn(z,n)+De,x=z=>oo(z-De,n),C=(z,E)=>{if(!u)return z;const N=p[E];return N?(z-N.min)/N.span:.5},k=(z,E)=>{if(u){const N=C(z,E);return Je(N,n)}return Je(z,n)};t.fillStyle=it.backgroundColor,t.fillRect(0,0,o,r),t.lineWidth=1;const S=Uc,b=Math.floor(n.panX),w=Math.ceil(oo(o-De,n));t.textAlign="left";const{textStep:j,lineStep:T}=On(n.scaleX),L=Math.floor(b/T)*T;for(let z=L;z<=w;z+=T){const E=y(z);E<De||(t.beginPath(),t.strokeStyle=z===0?it.zeroLineColor:it.gridColor,t.globalAlpha=z%j===0?.3:.1,t.moveTo(E,S),t.lineTo(E,r),t.stroke(),t.globalAlpha=1)}if(u){const z=Je(0,n),E=Je(1,n);t.strokeStyle="#444",t.beginPath(),t.moveTo(De,z),t.lineTo(o,z),t.stroke(),t.beginPath(),t.moveTo(De,E),t.lineTo(o,E),t.stroke()}else{const z=or(n.scaleY,40),E=ya(r,n),N=ya(0,n),P=Math.floor(E/z)*z;for(let $=P;$<=N;$+=z){const O=Je($,n);O<S||(t.beginPath(),t.strokeStyle=Math.abs($)<1e-6?it.zeroLineColor:it.gridColor,t.moveTo(De,O),t.lineTo(o,O),t.stroke(),O>S+10&&O<r-10&&t.fillText($.toString(),De-4,O+3))}}t.save(),t.beginPath(),t.rect(De,S,o-De,r-S),t.clip(),s.forEach((z,E)=>{const N=i.tracks[z];if(!N||N.type!=="float")return;const P=Ia[E%Ia.length],$=N.keyframes,O=m.has(z);if($.length>0){t.strokeStyle=P,t.lineWidth=O?3:1.5,t.globalAlpha=O||m.size===0?1:.4,t.beginPath();const X=y($[0].frame),W=k($[0].value,z);t.moveTo(Math.min(X,De),W),t.lineTo(X,W);for(let F=0;F<$.length-1;F++){const I=$[F],D=$[F+1];y(I.frame);const G=k(I.value,z),q=y(D.frame),Q=k(D.value,z);if(I.interpolation==="Step")t.lineTo(q,G),t.lineTo(q,Q);else if(I.interpolation==="Linear")t.lineTo(q,Q);else{let J=I.rightTangent?I.rightTangent.x:(D.frame-I.frame)*.33,re=I.rightTangent?I.rightTangent.y:0,U=D.leftTangent?D.leftTangent.x:-(D.frame-I.frame)*.33,V=D.leftTangent?D.leftTangent.y:0;if(u){const ee=p[z];ee&&(re=re/ee.span,V=V/ee.span)}const te=y(I.frame+J),K=G-re*n.scaleY,ae=y(D.frame+U),se=Q-V*n.scaleY;t.bezierCurveTo(te,K,ae,se,q,Q)}}const H=$[$.length-1];t.lineTo(y(H.frame),k(H.value,z)),t.stroke();const A=$[0];N.postBehavior&&N.postBehavior!=="Hold"?nr(t,n,N,A,H,o,F=>k(F,z),y,x):(!N.postBehavior||N.postBehavior==="Hold")&&nr(t,n,N,A,H,o,F=>k(F,z),y,x),t.globalAlpha=1,$.forEach(F=>{const I=y(F.frame),D=k(F.value,z),G=`${z}::${F.id}`,q=c.includes(G),Q=Wc(F.id,F.frame,z,a);if(!(D<S-10||D>r+10||I<De-5)){if(q||O||m.size===0?t.globalAlpha=1:t.globalAlpha=.4,q&&F.interpolation==="Bezier"){t.strokeStyle=it.handleLineColor,t.lineWidth=1;const J=u?p[z]:null;if(F.rightTangent){const re=F.frame+F.rightTangent.x,U=u&&J?C(F.value+F.rightTangent.y,z):F.value+F.rightTangent.y,V=y(re),te=Je(U,n);t.beginPath(),t.moveTo(I,D),t.lineTo(V,te),t.stroke(),t.fillStyle=it.handleColor,t.beginPath(),t.arc(V,te,3,0,Math.PI*2),t.fill()}if(F.leftTangent){const re=F.frame+F.leftTangent.x,U=u&&J?C(F.value+F.leftTangent.y,z):F.value+F.leftTangent.y,V=y(re),te=Je(U,n);t.beginPath(),t.moveTo(I,D),t.lineTo(V,te),t.stroke(),t.fillStyle=it.handleColor,t.beginPath(),t.arc(V,te,3,0,Math.PI*2),t.fill()}}if(q?t.fillStyle=it.keySelectedColor:Q>0?t.fillStyle=`color-mix(in srgb, ${it.keyColor} ${Math.round(Q*100)}%, ${P})`:t.fillStyle=P,F.interpolation==="Step"?t.fillRect(I-4,D-4,8,8):F.interpolation==="Bezier"?(t.beginPath(),t.arc(I,D,4,0,Math.PI*2),t.fill()):(t.save(),t.translate(I,D),t.rotate(Math.PI/4),t.fillRect(-3,-3,6,6),t.restore()),q&&(t.strokeStyle="#fff",t.lineWidth=1,t.beginPath(),t.arc(I,D,6,0,Math.PI*2),t.stroke()),h&&M.isAdjusting&&M.anchorKey===G){t.globalAlpha=1,t.strokeStyle="rgba(255, 255, 255, 0.4)",t.lineWidth=1,t.setLineDash([4,4]),t.beginPath();const J=Math.abs(g)*n.scaleX;t.arc(I,D,J,0,Math.PI*2),t.stroke(),t.setLineDash([]),t.fillStyle=g>0?"rgba(255, 255, 255, 0.05)":"rgba(255, 100, 100, 0.1)",t.fill()}}}),t.globalAlpha=1}}),t.restore(),t.fillStyle="#080808",t.fillRect(De,0,o,S),t.beginPath(),t.strokeStyle="#444",t.moveTo(De,S),t.lineTo(o,S),t.stroke(),t.textAlign="left",t.textBaseline="top",t.fillStyle="#888";for(let z=L;z<=w;z+=j){const E=y(z);E<De||(t.fillRect(E,S-8,1,8),t.fillText(z.toString(),E+4,2))}if(t.fillStyle="#080808",t.fillRect(0,0,De,r),t.fillStyle="#374151",t.fillRect(De-1,0,1,r),t.textAlign="right",t.font="9px monospace",t.fillStyle="#9ca3af",u){const z=Je(0,n),E=Je(1,n);t.fillText("1.0",De-4,E+3),t.fillText("0.0",De-4,z+3)}else{const z=or(n.scaleY,40),E=ya(r,n),N=ya(0,n),P=Math.floor(E/z)*z;for(let $=P;$<=N;$+=z){const O=Je($,n);O<S||(t.beginPath(),t.strokeStyle=Math.abs($)<1e-6?it.zeroLineColor:it.gridColor,t.moveTo(De,O),t.lineTo(o,O),t.stroke(),O>S+10&&O<r-10&&t.fillText($.toString(),De-4,O+3))}}const _=y(d);if(_<o){t.fillStyle="rgba(0, 0, 0, 0.6)",t.fillRect(_,0,o-_,r);const z=Gc(t);z&&(t.save(),t.translate(_,0),t.fillStyle=z,t.fillRect(0,0,o-_,r),t.restore()),t.strokeStyle="#666",t.lineWidth=1,t.beginPath(),t.moveTo(_,0),t.lineTo(_,r),t.stroke()}f&&(t.fillStyle="rgba(0, 200, 255, 0.1)",t.strokeStyle="rgba(0, 200, 255, 0.5)",t.lineWidth=1,t.fillRect(f.x,f.y,f.w,f.h),t.strokeRect(f.x,f.y,f.w,f.h));const R=y(l);R<De?(t.fillStyle="#ef4444",t.beginPath(),t.moveTo(De+8,r/2-6),t.lineTo(De+2,r/2),t.lineTo(De+8,r/2+6),t.fill()):R>o?(t.fillStyle="#ef4444",t.beginPath(),t.moveTo(o-8,r/2-6),t.lineTo(o-2,r/2),t.lineTo(o-8,r/2+6),t.fill()):(t.strokeStyle="#ef4444",t.lineWidth=1,t.beginPath(),t.moveTo(R,0),t.lineTo(R,r),t.stroke(),t.fillStyle="#ef4444",t.beginPath(),t.moveTo(R,0),t.lineTo(R+5,0),t.lineTo(R+5,12),t.lineTo(R,18),t.lineTo(R-5,12),t.lineTo(R-5,0),t.fill())},Xc=({tid:a})=>{const t=v.useRef(null),o=xe;return v.useEffect(()=>{let r;const n=()=>{if(!t.current)return;const i=o.getState(),s=Na(a,i.isPlaying,i.currentFrame,i.sequence);t.current.innerText=s.toFixed(2),r=requestAnimationFrame(n)};return n(),()=>cancelAnimationFrame(r)},[a]),e.jsx("span",{ref:t,className:"text-[9px] font-mono text-gray-400",children:"--"})},Yc=({visibleTrackIds:a,setVisibleTracks:t})=>{const{sequence:o,selectedTrackIds:r,selectTrack:n,selectKeyframes:i,removeTrack:s,setTrackBehavior:l}=xe(),d=Y(S=>S.openContextMenu),[c,f]=v.useState(new Set(["Formula","Optics","Lighting","Shading"])),u=v.useRef(null),p=v.useMemo(()=>{const S={},b=[];return S.Camera=[],S.Formula=[],S.Optics=[],S.Lighting=[],S.Shading=[],o&&Object.values(o.tracks).forEach(w=>{w.hidden||(w.id.startsWith("camera.")?S.Camera.push(w.id):w.id.startsWith("lights.")||w.id.startsWith("lighting.")?S.Lighting.push(w.id):w.id.startsWith("coreMath.")||w.id.startsWith("geometry.")||w.id.startsWith("param")||w.id.startsWith("julia.")||w.id.startsWith("hybridParams.")||w.id==="iterations"?S.Formula.push(w.id):w.id==="camFov"||w.id.startsWith("optics.")||w.id.startsWith("dof")||w.id.startsWith("fog")||w.id.startsWith("atmosphere.")?w.id.startsWith("fog")||w.id.startsWith("atmosphere.")?S.Shading.push(w.id):S.Optics.push(w.id):S.Shading.push(w.id))}),Object.keys(S).forEach(w=>{S[w].length===0&&delete S[w]}),{groups:S,standalone:b}},[o]),h=v.useMemo(()=>{let S=[];return Object.entries(p.groups).forEach(([b,w])=>{c.has(b)||(S=S.concat(w))}),S=S.concat(p.standalone),S},[p,c]),g=S=>{a.includes(S)?t(a.filter(b=>b!==S)):t([...a,S])},M=S=>{if(S.every(w=>a.includes(w))){const w=new Set(S);t(a.filter(j=>!w.has(j)))}else{const w=new Set(a);S.forEach(j=>w.add(j)),t(Array.from(w))}},m=(S,b)=>{const w=S.ctrlKey||S.metaKey;if(S.shiftKey&&u.current){const j=h.indexOf(u.current),T=h.indexOf(b);if(j!==-1&&T!==-1){const L=Math.min(j,T),_=Math.max(j,T),R=h.slice(L,_+1);R.forEach(E=>{r.includes(E)||n(E,!0),a.includes(E)||t([...a,E])});const z=new Set(a);R.forEach(E=>z.add(E)),t(Array.from(z))}}else n(b,w),a.includes(b)||t([...a,b]);u.current=b},y=(S,b)=>{S.preventDefault(),S.stopPropagation();const w=o.tracks[b];if(!w)return;const j=w.postBehavior||"Hold",T=[{label:w.label,action:()=>{},isHeader:!0},{label:"Delete Track",danger:!0,action:()=>s(b)},{label:"Extrapolation",action:()=>{},isHeader:!0},{label:"Post Behavior",children:[{label:"Hold (Default)",checked:j==="Hold",action:()=>l(b,"Hold")},{label:"Loop (Repeat)",checked:j==="Loop",action:()=>l(b,"Loop")},{label:"Ping-Pong",checked:j==="PingPong",action:()=>l(b,"PingPong")},{label:"Continue (Slope)",checked:j==="Continue",action:()=>l(b,"Continue")},{label:"Offset Loop (Relative)",checked:j==="OffsetLoop",action:()=>l(b,"OffsetLoop")}]}];d(S.clientX,S.clientY,T,["anim.tracks"])},x=(S,b)=>{S.stopPropagation();const w=S.shiftKey||S.ctrlKey,j=[];b.forEach(T=>{const L=o.tracks[T];L&&L.keyframes.forEach(_=>j.push(`${T}::${_.id}`)),r.includes(T)||n(T,!0),a.includes(T)||g(T)}),i(j,w)},C=(S,b)=>{f(w=>{const j=new Set(w);return b?(j.clear(),Object.keys(p.groups).forEach(T=>{T!==S&&j.add(T)}),j.delete(S)):j.has(S)?j.delete(S):j.add(S),j})},k=S=>{const b=o.tracks[S];if(!b)return null;const w=a.includes(S),j=r.includes(S),T=a.indexOf(S),L=T!==-1?Ia[T%Ia.length]:"#555";return e.jsxs("div",{className:`flex items-center justify-between px-3 py-1.5 cursor-pointer border-b border-white/5 transition-colors group ${j?"bg-white/10":"hover:bg-white/5"}`,onClick:_=>m(_,S),onContextMenu:_=>y(_,S),children:[e.jsxs("div",{className:"flex items-center gap-2 min-w-0",children:[e.jsx("div",{className:`w-1.5 h-1.5 rounded-full shrink-0 transition-opacity ${w?"opacity-100":"opacity-0"}`,style:{backgroundColor:L}}),e.jsx("span",{className:`text-[10px] truncate ${j?"text-white font-bold":w?"text-gray-300":"text-gray-500"}`,title:b.label,children:b.label}),b.postBehavior&&b.postBehavior!=="Hold"&&e.jsxs("span",{className:"text-[8px] text-cyan-500 font-mono tracking-tighter opacity-50 ml-1",children:["[",b.postBehavior.substring(0,1),"]"]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{className:"opacity-0 group-hover:opacity-100 p-0.5 rounded hover:bg-white/20 text-gray-500 hover:text-cyan-400 transition-all",onClick:_=>x(_,[S]),title:"Select All Keys",children:e.jsx(Jo,{})}),w&&e.jsx(Xc,{tid:S}),e.jsx("div",{className:"p-1 rounded hover:bg-white/20 text-gray-500 hover:text-white",onClick:_=>{_.stopPropagation(),g(S)},children:e.jsx(tr,{active:w})})]})]},S)};return e.jsxs("div",{className:"w-[220px] bg-black/80 backdrop-blur-sm border-r border-white/10 flex flex-col shrink-0 overflow-y-auto custom-scroll",children:[e.jsxs("div",{className:"h-6 flex items-center justify-between px-2 border-b border-white/5 text-[9px] text-gray-500 font-bold uppercase tracking-widest bg-black sticky top-0 z-10",children:[e.jsx("span",{children:"Curves"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{onClick:()=>t([]),className:"hover:text-white text-gray-600 px-1",title:"Hide All",children:"None"}),e.jsx("button",{onClick:()=>{const S=Object.values(o.tracks).filter(b=>!b.hidden).map(b=>b.id);t(S)},className:"hover:text-white text-gray-600 px-1",title:"Show All",children:"All"})]})]}),Object.entries(p.groups).map(([S,b])=>{const w=b,j=w.every(L=>a.includes(L))&&w.length>0,T=w.some(L=>a.includes(L))&&!j;return e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between px-2 py-1.5 border-b border-white/10 cursor-pointer select-none group bg-[#1a1a1a] hover:bg-gray-700",children:[e.jsxs("div",{className:"flex items-center gap-2 flex-1",onClick:L=>C(S,L.altKey),children:[e.jsx("span",{className:"text-gray-500 w-4",children:e.jsx(Rn,{open:!c.has(S)})}),e.jsx("span",{className:"text-[10px] font-bold text-gray-300 uppercase tracking-wider",children:S})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("button",{className:"opacity-0 group-hover:opacity-100 p-0.5 rounded hover:bg-white/20 text-gray-500 hover:text-cyan-400 transition-all mr-1",onClick:L=>x(L,w),title:"Select All Keys in Group",children:e.jsx(Jo,{})}),e.jsx("div",{className:"p-1 rounded hover:bg-white/10 text-gray-500 hover:text-white",onClick:L=>M(w),children:e.jsx(tr,{active:j||T})})]})]}),!c.has(S)&&w.map(L=>k(L))]},S)}),p.standalone.map(S=>k(S)),(!o||Object.keys(o.tracks).length===0)&&e.jsx("div",{className:"p-4 text-xs text-gray-600 text-center italic",children:"No tracks yet"}),e.jsx("div",{className:"h-10"})]})},Vc=({text:a})=>e.jsxs("div",{className:"absolute left-full ml-1 top-1/2 -translate-y-1/2 bg-black text-white text-[9px] px-1.5 py-0.5 rounded whitespace-nowrap pointer-events-none z-50 opacity-0 group-hover/btn:opacity-100 transition-opacity",children:[a,e.jsx("div",{className:"absolute top-1/2 -left-1 -translate-y-1/2 border-t-4 border-b-4 border-r-4 border-t-transparent border-b-transparent border-r-black"})]}),zt=({onClick:a,active:t,icon:o,tooltip:r,onPointerDown:n,danger:i,onContextMenu:s})=>e.jsxs("button",{onClick:a,onPointerDown:n,onContextMenu:s,className:`group/btn relative w-6 h-6 flex items-center justify-center rounded border transition-all ${t?"bg-cyan-900/80 text-cyan-300 border-cyan-500/50":i?"bg-red-900/20 text-red-400 border-red-500/30 animate-pulse":"bg-black/60 text-gray-400 border-white/10 hover:text-white"}`,children:[o,e.jsx(Vc,{text:r})]}),Zc=()=>{const{bounceTension:a,bounceFriction:t,setBouncePhysics:o}=xe();return e.jsxs("div",{className:"flex flex-col gap-1 py-1",children:[e.jsx("div",{className:"px-3",children:e.jsx(Me,{label:"Tension (Spring)",value:a,min:.1,max:2,step:.1,onChange:r=>o(r,t)})}),e.jsx("div",{className:"px-3",children:e.jsx(Me,{label:"Friction (Damping)",value:t,min:.1,max:1,step:.1,onChange:r=>o(a,r)})}),e.jsx("div",{className:"px-3 pt-1",children:e.jsx("button",{onClick:()=>o(.5,.6),className:"w-full py-1 text-[9px] uppercase font-bold text-gray-500 hover:text-white border border-white/10 rounded hover:bg-white/5 transition-colors",children:"Reset Defaults"})})]})},Kc=({normalized:a,onToggleNormalize:t,onFitView:o,onFitSelection:r,onApplyEuler:n,needsEulerFix:i,isBaking:s,onBakeDown:l,isSmoothing:d,onSmoothDown:c,isSimplifying:f,onSimplifyDown:u})=>{const p=Y(M=>M.openContextMenu),h=M=>{const m=Oe(M.currentTarget);m.length>0&&(M.preventDefault(),M.stopPropagation(),p(M.clientX,M.clientY,[],m))},g=M=>{M.preventDefault(),M.stopPropagation();const m=[{label:"Bounce Physics",action:()=>{},isHeader:!0},{element:e.jsx(Zc,{})}];p(M.clientX,M.clientY,m,[])};return e.jsxs("div",{className:"absolute top-[30px] left-[4px] flex flex-col gap-1 z-20 w-[42px]","data-help-id":"anim.graph",onContextMenu:h,children:[e.jsx(zt,{onClick:o,active:!1,icon:e.jsx(sc,{}),tooltip:"Fit View (All Keys)"}),e.jsx(zt,{onClick:r,active:!1,icon:e.jsx(lc,{}),tooltip:"Fit Selection"}),e.jsx(zt,{onClick:t,active:a,icon:e.jsx(cc,{active:a}),tooltip:"Normalize (0-1 Range)"}),e.jsx(zt,{onClick:n,active:!1,danger:i,icon:e.jsx(dc,{}),tooltip:"Fix Rotation (Euler Filter)"}),e.jsx(zt,{onClick:()=>{},onPointerDown:u,active:f,icon:e.jsx(In,{active:f}),tooltip:"Simplify / Fit Curve (Drag Left/Right)"}),e.jsx(zt,{onClick:()=>{},onPointerDown:l,active:s,icon:e.jsx(Fn,{active:s}),tooltip:"Bake / Resample (Drag right)"}),e.jsx(zt,{onClick:()=>{},onPointerDown:c,onContextMenu:g,active:d,icon:e.jsx(En,{active:d}),tooltip:"Smooth (Right) / Bounce (Left) - Right Click for Settings"})]})},Qc=a=>{const t=v.useRef(null);return v.useEffect(()=>{const o=t.current;if(!o)return;const r=o.getContext("2d");r&&qc({ctx:r,width:a.width,height:a.height,view:a.view,sequence:a.sequence,trackIds:a.trackIds,currentFrame:a.currentFrame,durationFrames:a.durationFrames,selectedKeyframeIds:a.selectedKeyframeIds,selectionBox:a.selectionBox,normalized:a.normalized,trackRanges:a.trackRanges,softSelectionEnabled:a.softSelectionEnabled,softSelectionRadius:a.softSelectionRadius,softSelectionType:a.softSelectionType,softInteraction:a.softInteraction,highlightedTracks:a.highlightedTracks})},[a.width,a.height,a.view,a.sequence,a.trackIds,a.currentFrame,a.durationFrames,a.selectedKeyframeIds,a.selectionBox,a.normalized,a.trackRanges,a.softSelectionEnabled,a.softSelectionRadius,a.softSelectionType,a.softInteraction,a.highlightedTracks]),e.jsx("canvas",{ref:t,width:a.width,height:a.height,className:"block cursor-crosshair",onMouseDown:a.onMouseDown,onContextMenu:a.onContextMenu,onDoubleClick:a.onDoubleClick})},Jc=({trackIds:a,setVisibleTracks:t,width:o,height:r,normalized:n=!1,onContextMenu:i,scrollLeft:s,frameWidth:l,sidebarWidth:d,onSetScroll:c,onSetFrameWidth:f})=>{const u=v.useRef(null),p=v.useRef(null),{sequence:h,currentFrame:g,durationFrames:M,selectedKeyframeIds:m,selectedTrackIds:y,selectKeyframe:x,selectTracks:C,softSelectionEnabled:k,softSelectionRadius:S,softSelectionType:b,copySelectedKeyframes:w,pasteKeyframes:j,deleteSelectedKeyframes:T}=xe(),{openContextMenu:L}=Y(),[_,R]=v.useState({pan:0,scale:50}),[z,E]=v.useState(n),N=Math.max(10,o-d),P=v.useMemo(()=>({panX:s/l,panY:_.pan,scaleX:l,scaleY:_.scale,width:N,height:r}),[s,l,_,N,r]),$=v.useMemo(()=>{const ee={};return a.forEach(ne=>{const he=h.tracks[ne];if(!he||he.keyframes.length===0){ee[ne]={min:0,max:1,span:1};return}let de=1/0,oe=-1/0;he.keyframes.forEach(pe=>{pe.value<de&&(de=pe.value),pe.value>oe&&(oe=pe.value)}),oe-de<1e-5&&(de-=.5,oe+=.5),ee[ne]={min:de,max:oe,span:oe-de}}),ee},[a,h,z]),O=(ee,ne)=>{if(!z)return ee;const he=$[ne];return he?(ee-he.min)/he.span:.5},X=(ee,ne)=>{if(z){const he=O(ee,ne);return Je(he,P)}return Je(ee,P)},W=ee=>Bn(ee,P)+aa,H=ee=>oo(ee-aa,P),{handleMouseDown:A,getHit:F,selectionBox:I,softInteraction:D,shouldSuppressContextMenu:G}=Bc(p,P,a,z,$,X,c,f,R,W,H,aa),q=Hc({sequence:h,trackIds:a,selectedTrackIds:y,selectedKeyframeIds:m,frameWidth:l,view:P,normalized:z,trackRanges:$,v2p:X,canvasPixelToFrame:H}),Q=ee=>{if(!ee){R({pan:0,scale:50});return}if(z){const pe=(r-ta-30)/1;R({pan:.5,scale:pe})}else{const ye=Math.max(ee.maxV-ee.minV,.1),fe=Math.max(50,r-ta-40)/(ye*1.1);R({scale:fe,pan:(ee.minV+ee.maxV)/2})}const ne=N-aa;let he=ee.maxF-ee.minF,de=0,oe=1;if(he<=1){he=Math.max(M,10);const ye=he*.05;oe=ne/(he+ye*2),de=-ye}else{he=Math.max(he,10);const ye=he*.1;oe=ne/(he+ye*2),de=ee.minF-ye}f(oe),c(de*oe)},J=()=>Q(ba(a,h)),re=()=>{if(m.length>0){Q(ba(a,h,m));return}const ee=y.filter(ne=>a.includes(ne));if(ee.length>0){Q(ba(ee,h));return}J()},U=()=>{if(z){const ee=ba(a,h);if(ee){const ne=Math.max(ee.maxV-ee.minV,.1),he=ne*.2,de=(r-ta)/(ne+he*2);R({scale:de,pan:(ee.minV+ee.maxV)/2})}E(!1)}else{const ne=(r-ta)/1.2;R({pan:.5,scale:ne}),E(!0)}},V=v.useRef(!1);v.useEffect(()=>{V.current=!1},[a]),v.useEffect(()=>{if(a.length>0&&o>100&&!V.current){const ee=setTimeout(()=>{J(),V.current=!0},50);return()=>clearTimeout(ee)}},[a,o]),v.useEffect(()=>{const ee=ne=>{ne.target.tagName!=="INPUT"&&(ne.ctrlKey||ne.metaKey?ne.key==="c"?(ne.preventDefault(),w()):ne.key==="v"&&(ne.preventDefault(),j()):((ne.key==="Delete"||ne.key==="Backspace")&&(ne.preventDefault(),T()),ne.key==="f"&&(ne.preventDefault(),re())))};return window.addEventListener("keydown",ee),()=>window.removeEventListener("keydown",ee)},[w,j,T,re]);const te=ee=>{var ne;if(ee.button===0&&(ee.ctrlKey||ee.metaKey)){const he=(ne=p.current)==null?void 0:ne.getBoundingClientRect();if(he){const de=ee.clientX-he.left,oe=ee.clientY-he.top;if(!F(de,oe)){q.createKeyAtMouse(ee,he);return}}}A(ee)},K=ee=>{var ye;if(ee.preventDefault(),G())return;const ne=(ye=p.current)==null?void 0:ye.getBoundingClientRect();if(!ne)return;const he=ee.clientX-ne.left,de=ee.clientY-ne.top,oe=F(he,de);if(oe&&oe.type==="key"&&i){const pe=`${oe.trackId}::${oe.key.id}`;m.includes(pe)||(x(oe.trackId,oe.key.id,!1),xe.getState().selectTracks([oe.trackId],!1)),i(ee,oe.trackId,oe.key.id,oe.key.interpolation)}else{const pe=H(he),be=Math.max(0,Math.round(pe)),fe=[{label:"Graph Actions",action:()=>{},isHeader:!0},{label:"Create Keyframe Here",action:()=>q.createKeyAtMouse(ee,ne)},{label:"Paste Keys",action:()=>j(be),disabled:!xe.getState().clipboard},{label:"View",action:()=>{},isHeader:!0},{label:"Fit View",action:J},{label:"Reset Zoom",action:()=>{R({pan:0,scale:50}),f(8)}}];L(ee.clientX,ee.clientY,fe,["anim.graph"])}},ae=ee=>{var he;const ne=(he=p.current)==null?void 0:he.getBoundingClientRect();ne&&q.createKeyAtMouse(ee,ne)},se=v.useMemo(()=>{const ee=new Set;return y.forEach(ne=>{a.includes(ne)&&ee.add(ne)}),ee},[m,y,a]);return e.jsxs("div",{className:"flex w-full h-full bg-transparent select-none","data-help-id":"anim.graph",children:[e.jsx(Yc,{visibleTrackIds:a,setVisibleTracks:t}),e.jsxs("div",{className:"flex-1 relative group overflow-hidden","data-help-id":"anim.graph",ref:u,children:[e.jsx("div",{ref:p,children:e.jsx(Qc,{width:N,height:r,view:P,sequence:h,trackIds:a,currentFrame:g,durationFrames:M,selectedKeyframeIds:m,selectionBox:I,normalized:z,trackRanges:$,softSelectionEnabled:k,softSelectionRadius:S,softSelectionType:b,softInteraction:D,highlightedTracks:se,onMouseDown:te,onContextMenu:K,onDoubleClick:ae})}),q.isSmoothing&&e.jsxs("div",{className:"absolute top-4 left-1/2 -translate-x-1/2 bg-black/80 text-cyan-300 px-3 py-1.5 rounded-full border border-cyan-500/50 text-xs font-bold shadow-xl animate-fade-in z-50 pointer-events-none flex items-center gap-2",children:[e.jsx(En,{active:!0}),e.jsx("span",{children:q.smoothingRadius>0?`Constrained Smooth: ${q.smoothingRadius.toFixed(1)}`:`Bounce: ${Math.abs(q.smoothingRadius).toFixed(1)}`})]}),q.isBaking&&e.jsxs("div",{className:"absolute top-4 left-1/2 -translate-x-1/2 bg-black/80 text-purple-300 px-3 py-1.5 rounded-full border border-purple-500/50 text-xs font-bold shadow-xl animate-fade-in z-50 pointer-events-none flex items-center gap-2",children:[e.jsx(Fn,{active:!0}),e.jsxs("span",{children:["Bake Interval: ",q.bakeStep," frames"]})]}),q.isSimplifying&&e.jsxs("div",{className:"absolute top-4 left-1/2 -translate-x-1/2 bg-black/80 text-amber-300 px-3 py-1.5 rounded-full border border-amber-500/50 text-xs font-bold shadow-xl animate-fade-in z-50 pointer-events-none flex items-center gap-2",children:[e.jsx(In,{active:!0}),e.jsxs("span",{children:["Fit Strength: ",(q.simplifyStrength*100).toFixed(0),"%"]})]}),e.jsx(Kc,{normalized:z,onToggleNormalize:U,onFitView:J,onFitSelection:re,onApplyEuler:q.applyEulerFilter,needsEulerFix:q.checkEulerNeeded(),isBaking:q.isBaking,onBakeDown:q.handleBakeDown,isSmoothing:q.isSmoothing,onSmoothDown:q.handleSmoothDown,isSimplifying:q.isSimplifying,onSimplifyDown:q.handleSimplifyDown})]})]})},ed=220,td=({totalWidth:a,viewportWidth:t,scrollLeft:o,onScroll:r,onZoom:n,containerRef:i,frameWidth:s,durationFrames:l})=>{const d=v.useRef(null),c=v.useRef(null),f=Math.max(a,1),u=t/f*100,p=o/f*100,h=Math.min(100,Math.max(5,u)),g=Math.max(0,Math.min(100-h,p));v.useEffect(()=>{const C=d.current;if(!C)return;const k=S=>{S.preventDefault();const w=1+S.deltaY*.001;n(w,"factor")};return C.addEventListener("wheel",k,{passive:!1}),()=>C.removeEventListener("wheel",k)},[n]);const M=(C,k)=>{if(C.preventDefault(),C.stopPropagation(),!d.current)return;const S=d.current.getBoundingClientRect(),b=h/100*S.width,w=g/100*S.width;c.current={type:k,startX:C.clientX,startThumbLeft:w,startThumbWidth:b,navWidth:S.width,startScrollLeft:o},k==="scroll"&&x(C.clientX),window.addEventListener("mousemove",m),window.addEventListener("mouseup",y)},m=C=>{if(!c.current||!d.current)return;const{type:k,startX:S,startThumbWidth:b,navWidth:w,startThumbLeft:j}=c.current,T=C.clientX-S;if(k==="scroll")x(C.clientX);else if(k==="resizeRight"||k==="resizeLeft"){let L=b,_=j;k==="resizeRight"?L+=T:(L-=T,_+=T);const R=20;if(L<R){const P=R-L;L=R,k==="resizeLeft"&&(_-=P)}L>w&&(L=w),_<0&&(_=0);const z=t*w/L,N=Math.max(100,z-ed)/(l+20);if(n(N,"absolute"),k==="resizeLeft"){const $=_/w*z;i&&i.current?i.current.scrollLeft=$:r($)}}},y=()=>{c.current=null,window.removeEventListener("mousemove",m),window.removeEventListener("mouseup",y)},x=C=>{if(!d.current)return;const k=d.current.getBoundingClientRect(),S=Math.max(0,Math.min(C-k.left,k.width)),b=t/f*k.width/2,T=(S-b)/k.width*f;i&&i.current?i.current.scrollLeft=Math.max(0,T):r(Math.max(0,T))};return e.jsxs("div",{ref:d,className:"flex-1 h-3 bg-black border border-gray-700 rounded mx-4 relative select-none group cursor-pointer",onMouseDown:C=>M(C,"scroll"),title:"Drag bar to Scroll, Drag handles or Wheel to Zoom",children:[e.jsx("div",{className:"absolute inset-0 bg-gray-800/30 rounded"}),e.jsxs("div",{className:"absolute top-0 bottom-0 bg-gray-600 border border-gray-500 rounded-sm opacity-80 group-hover:bg-cyan-600 group-hover:border-cyan-400 transition-colors cursor-grab active:cursor-grabbing",style:{left:`${g}%`,width:`${h}%`},onMouseDown:C=>M(C,"scroll"),children:[e.jsx("div",{className:"absolute left-0 top-0 bottom-0 w-2 -ml-1 cursor-ew-resize hover:bg-white/50 z-10",onMouseDown:C=>M(C,"resizeLeft")}),e.jsx("div",{className:"absolute right-0 top-0 bottom-0 w-2 -mr-1 cursor-ew-resize hover:bg-white/50 z-10",onMouseDown:C=>M(C,"resizeRight")})]})]})},gt=({label:a,active:t,variant:o="primary",icon:r,fullWidth:n,className:i,children:s,onClick:l,...d})=>{const c=Y(p=>p.openContextMenu),f=p=>{const h=Oe(p.currentTarget);h.length>0&&(p.preventDefault(),p.stopPropagation(),c(p.clientX,p.clientY,[],h))};let u="bg-cyan-900 text-cyan-200 border-cyan-700 shadow-inner";return o==="danger"&&(u="bg-red-900 text-red-200 border-red-700 shadow-inner"),o==="success"&&(u="bg-green-900 text-green-200 border-green-700 shadow-inner"),o==="warning"&&(u="bg-amber-900 text-amber-200 border-amber-700 shadow-inner"),e.jsxs("button",{className:`t-btn ${t?u:"t-btn-default"} ${n?"w-full":"flex-1"} ${i||""}`,onClick:l,onContextMenu:f,...d,children:[r,a||s]})},Yt=({id:a,title:t,children:o,position:r,onPositionChange:n,size:i,onSizeChange:s,onClose:l,disableClose:d,zIndex:c,initialPos:f,initialSize:u})=>{const{panels:p,setFloatPosition:h,setFloatSize:g,togglePanel:M,startPanelDrag:m}=Y(),y=!!a,x=a?p[a]:null,[C,k]=v.useState(f||{x:100,y:100}),[S,b]=v.useState(u||{width:300,height:200}),w=y?(x==null?void 0:x.floatPos)||{x:100,y:100}:r||C,j=y?(x==null?void 0:x.floatSize)||{width:320,height:400}:i||S,T=v.useRef(w),L=v.useRef(j),_=v.useRef(null),R=v.useRef(null);if(v.useEffect(()=>{T.current=w},[w.x,w.y]),v.useEffect(()=>{L.current=j},[j.width,j.height]),y&&(!x||!x.isOpen||x.location!=="float"))return null;const z=t||(x?x.id:"Window"),E=c||(y?100:200),N=()=>{if(l)l();else if(y&&a){const X=Y.getState();a==="Audio"?X.setAudio({isEnabled:!1}):a==="Drawing"?X.setDrawing({enabled:!1}):a==="Engine"?X.setEngineSettings({showEngineTab:!1}):a==="Sonification"&&X.setSonification({isEnabled:!1}),M(a,!1)}},P=O=>{if(O.target.closest("button"))return;O.preventDefault(),_.current={x:O.clientX,y:O.clientY,startX:T.current.x,startY:T.current.y};const X=H=>{if(!_.current)return;const A=H.clientX-_.current.x,F=H.clientY-_.current.y,I={x:_.current.startX+A,y:_.current.startY+F};n?n(I):y&&a?h(a,I.x,I.y):k(I),T.current=I},W=()=>{_.current=null,window.removeEventListener("mousemove",X),window.removeEventListener("mouseup",W)};window.addEventListener("mousemove",X),window.addEventListener("mouseup",W)},$=O=>{O.preventDefault(),O.stopPropagation(),R.current={x:O.clientX,y:O.clientY,startW:L.current.width,startH:L.current.height};const X=H=>{if(!R.current)return;const A=H.clientX-R.current.x,F=H.clientY-R.current.y,I={width:Math.max(200,R.current.startW+A),height:Math.max(150,R.current.startH+F)};s?s(I):y&&a?g(a,I.width,I.height):b(I),L.current=I},W=()=>{R.current=null,window.removeEventListener("mousemove",X),window.removeEventListener("mouseup",W)};window.addEventListener("mousemove",X),window.addEventListener("mouseup",W)};return wt.createPortal(e.jsxs("div",{className:"fixed glass-panel flex flex-col overflow-hidden animate-pop-in shadow-[0_10px_40px_rgba(0,0,0,0.5)]",style:{left:w.x,top:w.y,width:j.width,height:j.height,maxHeight:"90vh",zIndex:E},children:[e.jsxs("div",{onMouseDown:P,className:"panel-header cursor-move flex items-center justify-between px-2 py-1.5 bg-gray-800/90 border-b border-white/10",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[y&&e.jsx("div",{className:"cursor-grab text-gray-500 hover:text-white",onMouseDown:O=>{O.stopPropagation(),a&&m(a)},children:e.jsx(Sn,{})}),e.jsx("span",{className:"t-label text-gray-200",children:z})]}),!d&&(l||y&&!(x!=null&&x.isCore))&&e.jsx("button",{onClick:N,className:"icon-btn",title:"Close",children:e.jsx(Vt,{})})]}),e.jsx("div",{className:"p-3 overflow-y-auto overflow-x-hidden custom-scroll flex-1 relative bg-black/80 backdrop-blur-md",children:o}),e.jsx("div",{onMouseDown:$,className:"absolute bottom-0 right-0 w-4 h-4 cursor-nwse-resize z-20 touch-none text-gray-500",children:e.jsx(Nl,{})})]}),document.body)},ad=({onClose:a})=>{const t=xe(),{resolutionMode:o,fixedResolution:r}=Y(),[n,i]=v.useState(()=>o==="Fixed"?{w:r[0],h:r[1]}:{w:1280,h:720}),[s,l]=v.useState(0),[d,c]=v.useState(16),[f,u]=v.useState(12),[p,h]=v.useState(0),[g,M]=v.useState(t.durationFrames),[m,y]=v.useState(1),[x,C]=v.useState(1),[k,S]=v.useState(0),[b,w]=v.useState(""),[j,T]=v.useState(!1),[L,_]=v.useState(!1),R=v.useRef(0),[z,E]=v.useState(0),[N,P]=v.useState({min:0,max:0}),[$,O]=v.useState(0),[X,W]=v.useState({duration:0,progress:0}),[H,A]=v.useState(!1),[F,I]=v.useState(!0),D=[...o==="Fixed"?[{label:`Viewport (${r[0]}x${r[1]})`,value:`${r[0]}x${r[1]}`}]:[],{label:`Screen (${window.innerWidth}x${window.innerHeight})`,value:`${window.innerWidth}x${window.innerHeight}`},{label:"720p HD (16:9)",value:"1280x720"},{label:"1080p FHD (16:9)",value:"1920x1080"},{label:"1440p QHD (16:9)",value:"2560x1440"},{label:"4K UHD (16:9)",value:"3840x2160"},{label:"Square 1:1 (Insta)",value:"1080x1080"},{label:"Portrait 4:5 (Insta)",value:"1080x1350"},{label:"Vertical 9:16 (TikTok/Reels)",value:"1080x1920"}],G=oa.map((fe,me)=>({label:fe.label,value:me})),q=t.fps,Q=oa[s],J=320,re=400,U=450,[V,te]=v.useState(()=>({x:Math.max(20,window.innerWidth-320-320-20),y:80})),[K,ae]=v.useState({width:J,height:U});v.useEffect(()=>{typeof window<"u"&&"showSaveFilePicker"in window?A(!0):A(!1),B.setPreviewSampleCap(d);const fe=setInterval(()=>{if(j)return;const me=B.pipeline;if(me){const ue=me.getCurrentFrameDuration(),ge=Math.min(1,me.accumulationCount/d);W({duration:ue,progress:ge})}},30);return()=>{B.setPreviewSampleCap(0),clearInterval(fe)}},[d,j]),v.useEffect(()=>{const fe=Math.floor((g-p)/m)+1;let me=Date.now();return le.on(Fe.BUCKET_STATUS,ge=>{if(!ge.isRendering){T(!1),ae({width:J,height:U});return}S(ge.progress);const ke=Date.now(),je=(ke-R.current)/1e3;if(E(je),ge.progress>0){const ze=ge.progress/100*fe;if(ze>=1&&ze%1<.1){const Re=(ke-me)/1e3;O(Re),me=ke}const Ee=je/ze,we=(fe-ze)*Ee;P(Re=>({min:we*.9,max:we*1.1}))}})},[p,g,m]),v.useEffect(()=>{(async()=>{if(typeof VideoEncoder>"u"){I(!1);return}try{const me=n.w%2===0?n.w:n.w-1,ue=n.h%2===0?n.h:n.h-1,ge=await xi(Q.codec,{width:me,height:ue,bitrate:f*1e6,frameRate:q});I(ge)}catch(me){console.warn("Format check failed:",me),I(!1)}})()},[s,n,f,q]);const se=async()=>{console.log("RenderPopup: Initializing export sequence...");const fe=oa[s];let me=null,ue=H;if(H)try{me=await(await window.showSaveFilePicker({suggestedName:`fractal_${n.w}x${n.h}.${fe.ext}`,types:[{description:fe.label,accept:{[fe.mime]:[`.${fe.ext}`]}}]})).createWritable()}catch(ge){if(ge.name==="AbortError")return;if(ge.name==="SecurityError"||ge.message.includes("not supported")||ge.message.includes("not a function"))console.warn("RenderPopup: Disk Access blocked. Fallback to RAM."),me=null,ue=!1;else{alert("Could not start export. Error: "+ge.message);return}}ae({width:re,height:U}),T(!0),_(!1),S(0),E(0),P({min:0,max:0}),O(0),w(ue?"Exporting to Disk...":"Exporting to RAM..."),await new Promise(ge=>setTimeout(ge,100)),R.current=Date.now();try{B.videoExporter.start({width:n.w,height:n.h,fps:q,samples:d,bitrate:f,startFrame:p,endFrame:g,frameStep:m,formatIndex:s,internalScale:x},me)}catch(ge){ge.message!=="Cancelled by user"&&(console.error("RenderPopup: Render sequence failed",ge),alert(`Render process failed.

Error: ${ge.message}`),T(!1))}},ee=()=>{_(!0),B.videoExporter.pause()},ne=()=>{_(!1),B.videoExporter.resume()},he=()=>{w("Stitching..."),B.videoExporter.finishAndStitch(),B.videoExporter.resume()},de=()=>{B.videoExporter.cancel(),B.videoExporter.resume(),T(!1)},oe=Math.floor((g-p)/m)+1,pe=(()=>{if(!X.duration)return 0;let fe=1;if(B.renderer){const ue=B.renderer.domElement,ge=ue.width*ue.height,ke=n.w*x,je=n.h*x,ze=ke*je;ge>0&&(fe=ze/ge)}return X.duration/1e3*fe*oe})(),be=H?"Direct Disk Write (Stream)":"RAM Buffer: Browser may crash if video exceeds ~2GB. Use Chrome for Disk Mode.";return j?e.jsx(Yt,{title:"Rendering...",onClose:a,position:V,onPositionChange:te,size:K,onSizeChange:ae,disableClose:!0,zIndex:600,children:e.jsxs("div",{className:"flex flex-col h-full space-y-4 p-2",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsxs("div",{className:"flex justify-between items-baseline t-label-sm",children:[e.jsxs("span",{className:"text-cyan-300 font-bold",children:[k.toFixed(1),"%"]}),e.jsx("span",{className:"text-[9px] text-gray-400 font-normal truncate max-w-[200px]",children:b})]}),e.jsx("div",{className:"h-3 w-full bg-gray-900 rounded-full overflow-hidden border border-white/10",children:e.jsx("div",{className:"h-full bg-gradient-to-r from-cyan-600 to-cyan-400 transition-all duration-300 ease-out relative",style:{width:`${k}%`},children:e.jsx("div",{className:"absolute inset-0 bg-white/20 animate-pulse"})})})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-3 bg-white/5 p-3 rounded border border-white/5",children:[e.jsxs("div",{className:"flex flex-col",children:[e.jsx("span",{className:"t-label-sm text-gray-500 mb-0.5",children:"Elapsed"}),e.jsx("span",{className:"font-mono text-sm font-bold text-white",children:$t(z)})]}),e.jsxs("div",{className:"flex flex-col text-right",children:[e.jsx("span",{className:"t-label-sm text-gray-500 mb-0.5",children:"Remaining"}),e.jsxs("span",{className:"font-mono text-sm font-bold text-cyan-300",children:[$t(N.min)," - ",$t(N.max)]})]}),e.jsxs("div",{className:"flex flex-col pt-2 border-t border-white/5",children:[e.jsx("span",{className:"t-label-sm text-gray-500 mb-0.5",children:"Last Frame"}),e.jsxs("span",{className:`font-mono text-xs ${$>2?"text-amber-400":"text-gray-300"}`,children:[$.toFixed(2),"s"]})]}),e.jsxs("div",{className:"flex flex-col text-right pt-2 border-t border-white/5",children:[e.jsx("span",{className:"t-label-sm text-gray-500 mb-0.5",children:"Est. Total"}),e.jsx("span",{className:"font-mono text-xs text-gray-300",children:z>0&&k>0?$t(z/(k/100)):"--"})]})]}),e.jsxs("div",{className:"text-[9px] text-gray-500 grid grid-cols-2 gap-y-1 border-t border-white/5 pt-3",children:[e.jsxs("span",{children:["Resolution: ",e.jsxs("span",{className:"text-gray-300",children:[n.w,"x",n.h]})]}),e.jsxs("span",{children:["Format: ",e.jsx("span",{className:"text-gray-300",children:Q.label.split(" ")[0]})]}),e.jsxs("span",{children:["Scale: ",e.jsxs("span",{className:"text-gray-300",children:[x,"x"]})]}),e.jsxs("span",{children:["Samples: ",e.jsx("span",{className:"text-gray-300",children:d})]})]}),e.jsx("div",{className:"mt-auto pt-2",children:L?e.jsxs("div",{className:"grid grid-cols-3 gap-2 animate-fade-in",children:[e.jsx(gt,{onClick:ne,label:"Resume",variant:"primary",icon:e.jsx(ia,{})}),e.jsx(gt,{onClick:he,label:"Finish",variant:"success",icon:e.jsx(xt,{})}),e.jsx(gt,{onClick:de,label:"Discard",variant:"danger",icon:e.jsx(St,{})})]}):e.jsx(gt,{onClick:ee,label:"Interrupt Render",variant:"danger",icon:e.jsx(zn,{}),fullWidth:!0})})]})}):e.jsx(Yt,{title:"Render Sequence",onClose:a,position:V,onPositionChange:te,size:K,onSizeChange:ae,disableClose:!1,zIndex:600,children:e.jsxs("div",{className:"flex flex-col -m-3 h-[calc(100%+20px)]",children:[e.jsxs("div",{className:"px-3 py-1 bg-black/20 border-b border-white/5 flex justify-between items-center shrink-0",children:[e.jsxs("span",{className:"t-label",children:[Q.container.toUpperCase(),"  ",Q.codec.toUpperCase(),"  ",q," FPS"]}),e.jsx("div",{className:"flex items-center gap-2",children:e.jsx("div",{className:`text-[8px] font-bold px-1.5 py-0.5 rounded border cursor-help ${H?"bg-green-900/30 text-green-400 border-green-500/30":"bg-amber-900/30 text-amber-400 border-amber-500/30"}`,title:be,children:H?"DISK MODE":"RAM MODE"})})]}),e.jsx("div",{className:"flex flex-1 min-h-0",children:e.jsxs("div",{className:"w-full flex flex-col h-full",children:[e.jsx("div",{className:"flex-1 transition-all duration-300 overflow-y-auto custom-scroll",children:e.jsxs("div",{className:"p-1.5 space-y-1",children:[e.jsx(vt,{label:"Resolution",value:`${n.w}x${n.h}`,onChange:fe=>{const[me,ue]=fe.split("x").map(Number);i({w:me,h:ue})},options:D,className:"mb-1.5"}),e.jsx(vt,{label:"Format",value:s,onChange:fe=>l(Number(fe)),options:G,className:"mb-1.5"}),!F&&e.jsxs("div",{className:"mx-1 mb-2 p-1.5 bg-red-900/20 border border-red-500/30 rounded flex items-center gap-2 text-[9px] text-red-300",children:[e.jsx(Zt,{}),e.jsx("span",{children:"Format incompatible with browser/GPU."})]}),e.jsxs("div",{className:"flex gap-1",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("label",{className:"t-label mb-0.5 block",children:"Start"}),e.jsx("div",{className:"h-5 bg-black/40 rounded border border-white/10 relative",children:e.jsx(_e,{value:p,onChange:fe=>h(Math.max(0,Math.min(Math.round(fe),g))),step:1,highlight:!0,overrideText:p.toFixed(0)})})]}),e.jsxs("div",{className:"flex-1",children:[e.jsx("label",{className:"t-label mb-0.5 block",children:"End"}),e.jsx("div",{className:"h-5 bg-black/40 rounded border border-white/10 relative",children:e.jsx(_e,{value:g,onChange:fe=>M(Math.max(p,Math.min(Math.round(fe),t.durationFrames))),step:1,highlight:!0,overrideText:g.toFixed(0)})})]}),e.jsxs("div",{className:"flex-[0.7]",children:[e.jsx("label",{className:"t-label mb-0.5 block",children:"Step"}),e.jsx("div",{className:"h-5 bg-black/40 rounded border border-white/10 relative",children:e.jsx(_e,{value:m,onChange:fe=>y(Math.max(1,Math.round(fe))),step:1,min:1,overrideText:m.toFixed(0)})})]})]}),e.jsx(Me,{label:"Bitrate (Mbps)",value:f,min:1,max:100,step:1,onChange:u,overrideInputText:`${f}`}),e.jsx(Me,{label:"Samples (Quality)",value:d,min:1,max:64,step:1,onChange:c,overrideInputText:d.toFixed(0)}),e.jsx(Me,{label:"Internal Scale (SSAA)",value:x,min:1,max:2,step:.1,onChange:C,overrideInputText:`${x}x`,highlight:x>1}),e.jsx("div",{className:"px-2 text-[8px] text-gray-500 mb-2",children:"Use 1.5x or 2.0x for sharper details (Supersampling)."}),H&&e.jsx("div",{className:"px-2 py-1 mx-2 mb-1 bg-green-900/10 border border-green-500/20 rounded",children:e.jsx("p",{className:"text-[8px] text-green-400 leading-tight",children:"Disk Mode Active: You can render unlimited video sizes."})}),e.jsxs("div",{className:"p-1.5 pt-0.5 space-y-1",children:[e.jsxs("div",{className:"relative flex justify-between items-center px-2 py-0.5 bg-white/5 rounded border border-white/5 overflow-hidden group",children:[e.jsx("div",{className:"absolute inset-0 bg-cyan-500/10 origin-left transition-transform duration-75 ease-linear pointer-events-none",style:{transform:`scaleX(${X.progress})`}}),e.jsx("span",{className:"t-label-sm relative z-10 text-gray-400",children:"Viewport Sample"}),e.jsx("span",{className:`text-[10px] font-mono font-bold relative z-10 ${X.duration>0?"text-green-400":"text-gray-500 animate-pulse"}`,children:X.duration>0?od(X.duration):"Estimating..."})]}),X.duration>0&&e.jsxs("div",{className:"flex flex-col gap-1 px-1 bg-white/5 rounded border border-white/5 p-2",children:[e.jsxs("div",{className:"flex justify-between items-center t-label-sm",children:[e.jsx("span",{children:"Est. Total"}),e.jsx("span",{className:"font-mono text-cyan-300",children:$t(pe)})]}),e.jsx("p",{className:"text-[8px] text-gray-500 italic leading-tight",children:"Calculated based on target resolution pixels vs current viewport."})]})]})]})}),e.jsx("div",{className:"p-1.5 bg-gray-900/50 border-t border-white/10 shrink-0",children:e.jsx(gt,{onClick:se,label:H?"Select Output File...":"Start RAM Render",variant:"primary",fullWidth:!0,disabled:!F,icon:H?e.jsx(to,{}):e.jsx(ia,{})})})]})})]})})},$t=a=>{if(!isFinite(a)||a<0)return"--";if(a<60)return`${a.toFixed(0)}s`;const t=Math.floor(a/60),o=Math.floor(a%60);if(t<60)return`${t}m ${o}s`;const r=Math.floor(t/60),n=t%60;return`${r}h ${n}m`},od=a=>{if(a<1e3)return`${a.toFixed(0)}ms`;const t=a/1e3;return t<60?`${t.toFixed(1)}s`:$t(t)},rd=()=>{const{sequence:a,currentFrame:t,isPlaying:o,captureCameraFrame:r}=xe();Y(l=>[l.cameraPos,l.cameraRot,l.sceneOffset]);const n=()=>{r(t),le.emit(Fe.TRACK_FOCUS,"camera.unified.x")},s=(()=>{const l=["camera.unified.x","camera.unified.y","camera.unified.z","camera.rotation.x","camera.rotation.y","camera.rotation.z"];let d=!1,c=!1,f=!1;for(const u of l){const p=a.tracks[u];if(p){d=!0;const h=p.keyframes.find(g=>Math.abs(g.frame-t)<.1);if(h&&(c=!0),!o){const g=Na(u,!1);let M=0;h?M=h.value:M=Qe(p.keyframes,t,u.includes("rotation")),Math.abs(M-g)>.001&&(f=!0)}}}return d?c?f?"keyed-dirty":"keyed":f?"dirty":"partial":"none"})();return e.jsxs("div",{className:`flex items-center gap-2 px-2 py-1 rounded transition-colors cursor-pointer border ${s==="keyed"?"bg-amber-900/40 hover:bg-amber-800/60 text-amber-200 border-amber-500/30":s==="keyed-dirty"?"bg-red-900/40 hover:bg-red-800/60 text-red-200 border-red-500/30":s==="dirty"?"bg-red-900/20 hover:bg-red-800/40 text-red-200 border-red-500/20":s==="partial"?"bg-amber-900/20 hover:bg-amber-800/40 text-amber-100/70 border-amber-500/20":"bg-white/5 hover:bg-white/10 text-gray-400 border-white/10"}`,"data-help-id":"anim.camera",onClick:n,title:"Keyframe Camera (Position + Rotation)",children:[e.jsx(ca,{status:s,onClick:n}),e.jsx("span",{className:"text-[10px] font-bold tracking-wide",children:"KEY CAM"})]})},nd=({mode:a,setMode:t,totalContentWidth:o,viewportWidth:r,scrollLeft:n,onScroll:i,onZoom:s,onClose:l,containerRef:d,frameWidth:c,durationFrames:f,inspectorVisible:u})=>{const{isPlaying:p,isRecording:h,currentFrame:g,fps:M,durationFrames:m,recordCamera:y,loopMode:x,isArmingModulation:C,isRecordingModulation:k,play:S,pause:b,stop:w,toggleRecording:j,setFps:T,setDuration:L,captureCameraFrame:_,seek:R,deleteAllKeys:z,deleteAllTracks:E,snapshot:N,toggleRecordCamera:P,setLoopMode:$,toggleArmModulation:O}=xe(),X=Y(q=>q.openContextMenu),[W,H]=v.useState(!1),[A,F]=v.useState(!1),I=v.useRef(null),D=q=>{const Q=Oe(q.currentTarget);Q.length>0&&(q.preventDefault(),q.stopPropagation(),X(q.clientX,q.clientY,[],Q))};v.useEffect(()=>{const q=Q=>{I.current&&!I.current.contains(Q.target)&&F(!1)};return A&&window.addEventListener("mousedown",q),()=>window.removeEventListener("mousedown",q)},[A]);const G=q=>{R(q),Ke.scrub(q)};return e.jsxs("div",{className:"h-8 border-b border-white/10 flex items-center px-2 gap-2 bg-white/5 shrink-0 z-50 select-none relative","data-help-id":"ui.timeline",onContextMenu:D,children:[e.jsxs("div",{className:"flex items-center gap-1 pr-2 mr-1","data-help-id":"anim.transport",children:[e.jsx("button",{onClick:w,className:"icon-btn",children:e.jsx(zn,{})}),e.jsx("button",{onClick:p?b:S,className:`p-1.5 rounded text-white ${p?k?"bg-red-600 animate-pulse":"bg-cyan-700":"bg-gray-700 hover:bg-gray-600"}`,title:"Space",children:p?e.jsx(xo,{}):e.jsx(ia,{})}),e.jsx("button",{onClick:j,className:`icon-btn ${h?"text-red-500 bg-red-900/20 shadow-[inset_0_0_8px_rgba(239,68,68,0.2)]":"hover:text-red-400"}`,title:"Auto-Keyframe Mode (Record)",children:e.jsx(tc,{active:h})}),e.jsx("button",{onClick:O,disabled:p&&!k,className:`icon-btn ${k?"text-white bg-red-600 animate-pulse":C?"text-red-200 bg-red-900/40 border border-red-500/40":"hover:text-red-200"}`,title:k?"Recording Modulation...":C?"Modulation Record Armed (Press Play)":"Record Audio/LFO Modulation",children:e.jsx(ic,{active:k,arming:C})}),e.jsx("button",{onClick:()=>$(x==="Loop"?"Once":"Loop"),className:`icon-btn ${x==="Loop"?"text-green-400":"text-gray-500"}`,title:x==="Loop"?"Looping":"Play Once",children:e.jsx(nc,{mode:x})})]}),e.jsx("div",{className:"flex items-center h-full px-1",children:e.jsxs("div",{className:"flex bg-black rounded-md px-3 py-1 gap-2 shadow-sm items-center border border-white/10",children:[e.jsx("button",{onClick:()=>t("DopeSheet"),className:`icon-btn ${a==="DopeSheet"?"icon-btn-active":""}`,title:"Dope Sheet",style:{height:"20px",width:"26px"},children:e.jsx(oc,{active:a==="DopeSheet"})}),e.jsx("button",{onClick:()=>t("Graph"),className:`icon-btn ${a==="Graph"?"icon-btn-active":""}`,title:"Curve Editor","data-help-id":"anim.graph",style:{height:"20px",width:"26px"},children:e.jsx(ac,{active:a==="Graph"})})]})}),e.jsxs("div",{className:"flex items-center gap-1.5 t-label pl-1 pr-3",children:[e.jsx("span",{className:"text-gray-600",children:"FRM"}),e.jsx("div",{className:"w-10 h-5 bg-black/40 rounded border border-white/10 relative",children:e.jsx(_e,{value:Math.floor(g),onChange:G,onMiddleChange:R,step:1,min:0,max:f,highlight:!0,overrideText:Math.floor(g).toFixed(0)})})]}),e.jsx(rd,{}),e.jsx(td,{totalWidth:o,viewportWidth:r,scrollLeft:n,onScroll:i,onZoom:s,containerRef:d,frameWidth:c,durationFrames:f}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs("div",{className:"flex items-center gap-1 t-label",children:[e.jsx("span",{className:"text-gray-600",children:"LEN"}),e.jsx("div",{className:"w-10 h-5 bg-black/40 rounded border border-white/10 relative",children:e.jsx(_e,{value:m,onChange:L,step:1,min:10,max:1e4,overrideText:m.toFixed(0),onDragStart:N,sensitivity:.15})})]}),e.jsx("div",{className:"w-px bg-white/10 h-4 mx-1"}),e.jsxs("button",{onClick:()=>H(!W),className:`flex items-center gap-1.5 px-2 py-0.5 rounded border transition-colors text-[10px] uppercase ${W?"bg-cyan-900 border-cyan-500 text-white":"bg-transparent border-gray-700 text-gray-400 hover:text-white hover:bg-white/5"}`,title:"Render Video","data-help-id":"export.video",children:[e.jsx(rc,{}),e.jsx("span",{className:"font-bold",children:"RENDER"})]})]}),e.jsxs("div",{className:"relative",ref:I,children:[e.jsx("button",{onClick:()=>F(!A),className:`ml-1 icon-btn ${A?"bg-white/20 text-white":""}`,children:e.jsx(po,{})}),A&&e.jsxs("div",{className:"absolute top-full right-0 mt-2 w-48 bg-[#1a1f3a] border border-white/20 rounded shadow-xl z-50 p-1 flex flex-col gap-1",children:[e.jsxs("div",{className:"flex items-center justify-between px-3 py-2 text-xs text-gray-300",children:[e.jsx("span",{className:"font-bold",children:"FPS"}),e.jsx("div",{className:"w-12 h-5 bg-black/40 rounded border border-white/10 relative",children:e.jsx(_e,{value:M,onChange:T,step:1,min:1,max:120,overrideText:M.toFixed(0),onDragStart:N})})]}),e.jsxs("button",{onClick:()=>{P()},className:"flex items-center justify-between px-3 py-2 text-xs text-gray-300 hover:bg-white/10 rounded transition-colors",children:[e.jsx("span",{children:"Record Camera"}),y&&e.jsx("span",{className:"text-cyan-400",children:e.jsx(xt,{})})]}),e.jsx("div",{className:"h-px bg-white/10 mx-1"}),e.jsx("button",{onClick:()=>{z(),F(!1)},className:"text-left px-3 py-2 text-xs text-gray-300 hover:bg-white/10 rounded transition-colors",children:"Delete All Keys"}),e.jsx("button",{onClick:()=>{E(),F(!1)},className:"text-left px-3 py-2 text-xs text-red-400 hover:bg-red-900/20 hover:text-red-300 rounded transition-colors",children:"Delete All Tracks"})]})]}),e.jsx("button",{onClick:l,className:"ml-1 icon-btn",title:"Close Timeline",children:e.jsx(Vt,{})}),W&&e.jsx(ad,{onClose:()=>H(!1)})]})},Ga=({label:a,onClick:t,title:o,active:r})=>e.jsx("button",{onClick:t,className:`flex-1 py-1.5 text-[9px] font-bold uppercase tracking-wide rounded border transition-colors ${r?"bg-cyan-900/50 text-cyan-300 border-cyan-500/50":"bg-white/5 text-gray-400 border-white/5 hover:bg-white/10 hover:text-white"}`,title:o,children:a}),id=({options:a,value:t,onChange:o})=>e.jsx("div",{className:"flex bg-black/40 rounded p-0.5 border border-white/10 w-full",children:a.map(r=>e.jsxs("button",{onClick:()=>o(r.value),className:`flex-1 py-1 text-[9px] font-bold uppercase rounded transition-colors flex items-center justify-center gap-1 ${t===r.value?"bg-cyan-900 text-cyan-300 shadow-sm":"text-gray-500 hover:text-gray-300"}`,children:[r.value?e.jsx(Kl,{}):e.jsx(na,{}),r.label]},r.label))}),Wa=({label:a,children:t})=>e.jsxs("div",{className:"flex items-center justify-between h-[26px] bg-white/[0.02] border-b border-white/5 px-2",children:[e.jsx("label",{className:"text-[10px] text-gray-400 font-medium tracking-tight w-24 shrink-0 truncate",title:a,children:a}),e.jsx("div",{className:"flex-1 min-w-0 flex justify-end",children:t})]}),sd=()=>{const{selectedKeyframeIds:a,sequence:t,updateKeyframes:o,setTangents:r,deleteSelectedKeyframes:n,snapshot:i,setIsScrubbing:s,softSelectionEnabled:l,softSelectionRadius:d,setSoftSelection:c,softSelectionType:f,setSoftSelectionType:u,setGlobalInterpolation:p}=xe(),h=v.useMemo(()=>{const A=[];return a.forEach(F=>{if(!F)return;const[I,D]=F.split("::"),G=t.tracks[I],q=G==null?void 0:G.keyframes.find(Q=>Q.id===D);if(G&&q){let Q,J;const re=G.keyframes.indexOf(q);re>0&&(Q=G.keyframes[re-1]),re<G.keyframes.length-1&&(J=G.keyframes[re+1]),A.push({tid:I,kid:D,key:q,prevKey:Q,nextKey:J,isRotation:I.includes("rotation")})}}),A},[a,t]),g=h.length>0,M=g?h[0]:null,m=M?M.key:null,y=g&&h.every(A=>A.isRotation),x=g&&h.every(A=>Math.abs(A.key.frame-m.frame)<.001),C=g&&h.every(A=>Math.abs(A.key.value-m.value)<1e-5),k=g&&h.every(A=>A.key.interpolation===m.interpolation),S=g&&h.every(A=>A.key.brokenTangents===m.brokenTangents),b=g&&h.every(A=>A.key.autoTangent===m.autoTangent),w=A=>{if(!g){A==="Linear"?p("Linear"):A==="Auto"?p("Bezier","Auto"):A==="Ease"&&p("Bezier","Ease");return}if(i(),A==="Linear"){const F=h.map(I=>({trackId:I.tid,keyId:I.kid,patch:{interpolation:"Linear"}}));o(F)}else{if(h.some(I=>I.key.interpolation!=="Bezier")){const I=h.map(D=>({trackId:D.tid,keyId:D.kid,patch:{interpolation:"Bezier"}}));o(I)}r(A)}},j=g&&(M!=null&&M.prevKey)?M.prevKey.frame:m?m.frame-10:0,T=g&&(M!=null&&M.nextKey)?M.nextKey.frame:m?m.frame+10:10,L=g?ma(m.leftTangent,m.frame-j,!0):{angle:0,length:0},_=g?ma(m.rightTangent,T-m.frame,!1):{angle:0,length:0},R=A=>{g&&(o(h.map(F=>({trackId:F.tid,keyId:F.kid,patch:{frame:Math.max(0,Math.round(A))}}))),Ke.scrub(Math.max(0,Math.round(A))))},z=A=>{if(!g)return;const F=y?Ze.degToRad(A):A;o(h.map(D=>({trackId:D.tid,keyId:D.kid,patch:{value:F}})));const{currentFrame:I}=xe.getState();Ke.scrub(I)},E=A=>{r(A?"Split":"Unified")},N=(A,F,I)=>{if(!g)return;const D=h.map(G=>{const q=G.key,Q=G.prevKey?G.prevKey.frame:q.frame-10,J=G.nextKey?G.nextKey.frame:q.frame+10,re=q.frame-Q,U=J-q.frame,V=ma(q.leftTangent,re,!0),te=ma(q.rightTangent,U,!1);let K=V.angle,ae=V.length,se=te.angle,ee=te.length;return A==="left"?F==="angle"?(K=I,q.brokenTangents||(se=I)):ae=I:F==="angle"?(se=I,q.brokenTangents||(K=I)):ee=I,{trackId:G.tid,keyId:G.kid,patch:{autoTangent:!1,leftTangent:ar(!0,K,ae,re),rightTangent:ar(!1,se,ee,U)}}});o(D),Ke.scrub(xe.getState().currentFrame)},P=()=>{i(),s(!0)},$=()=>s(!1),O=g&&m?y?Ze.radToDeg(m.value):m.value:0,X=Array.from(new Set(h.map(A=>A.tid))),W=X.length===1?X[0]:null,H=g?W&&t.tracks[W]?`${t.tracks[W].label} (${h.length})`:`Attributes (${h.length})`:"Global Properties";return e.jsxs("div",{className:"w-64 bg-[#111] border-l border-white/10 flex flex-col shrink-0 overflow-y-auto animate-fade-in-left select-none h-full","data-help-id":"anim.keyframes",children:[e.jsxs("div",{className:"flex items-center justify-between px-3 py-2 border-b border-white/10 bg-white/5 shrink-0 h-8",children:[e.jsx("span",{className:"text-[10px] font-bold text-gray-400 uppercase tracking-wider truncate mr-2",title:H,children:H}),g&&e.jsx("button",{onClick:n,className:"text-red-400 hover:text-red-300 p-1 hover:bg-white/10 rounded",children:e.jsx(St,{})})]}),e.jsxs("div",{className:"flex gap-1 px-2 py-2 border-b border-white/5 bg-black/20",children:[e.jsx(Ga,{label:"Linear",onClick:()=>w("Linear"),title:g?"Set Selected Linear":"Set All Keys Linear",active:g&&k&&m.interpolation==="Linear"}),e.jsx(Ga,{label:"Smooth",onClick:()=>w("Auto"),title:g?"Set Selected Auto-Bezier":"Set All Keys Auto-Bezier",active:g&&k&&m.interpolation==="Bezier"&&b&&m.autoTangent}),e.jsx(Ga,{label:"Flat",onClick:()=>w("Ease"),title:g?"Set Selected Flat-Bezier":"Set All Keys Flat-Bezier"})]}),g?e.jsxs("div",{className:"flex flex-col",children:[e.jsx(Wa,{label:"Frame",children:e.jsx("div",{className:"w-20",children:x?e.jsx(_e,{value:m.frame,onChange:R,step:1,min:0,highlight:!0,onDragStart:P,onDragEnd:$}):e.jsx("div",{className:"text-center text-[10px] text-gray-600",children:"---"})})}),e.jsx(Wa,{label:y?"Value (Deg)":"Value",children:e.jsx("div",{className:"w-20",children:C?e.jsx(_e,{value:O,onChange:z,step:y?1:.01,highlight:!0,onDragStart:P,onDragEnd:$,overrideText:O.toFixed(3)}):e.jsx("div",{className:"text-center text-[10px] text-gray-600",children:"---"})})}),e.jsx(Wa,{label:"Interpolation",children:e.jsxs("select",{value:k?m.interpolation:"Mixed",onChange:A=>{i();const F=A.target.value;o(h.map(I=>({trackId:I.tid,keyId:I.kid,patch:{interpolation:F}})))},className:"bg-transparent text-[10px] text-cyan-400 font-bold outline-none text-right cursor-pointer w-20",children:[!k&&e.jsx("option",{value:"Mixed",children:"Mixed"}),e.jsx("option",{value:"Bezier",children:"Bezier"}),e.jsx("option",{value:"Linear",children:"Linear"}),e.jsx("option",{value:"Step",children:"Step"})]})}),e.jsxs("div",{className:"border-t border-white/5 mt-2 bg-purple-900/10",children:[e.jsxs("div",{className:"flex items-center justify-between px-3 py-2 cursor-pointer hover:bg-white/5",onClick:()=>c(d||10,!l),children:[e.jsx("span",{className:"text-[9px] font-bold text-purple-300 uppercase tracking-wider",children:"Soft Selection"}),e.jsx("div",{className:`w-2 h-2 rounded-full ${l?"bg-purple-500 shadow-[0_0_5px_rgba(168,85,247,0.8)]":"bg-gray-700"}`})]}),l&&e.jsxs("div",{className:"px-3 pb-2 pt-1 animate-fade-in space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("label",{className:"text-[9px] text-gray-400 font-medium",children:"Falloff"}),e.jsxs("select",{value:f,onChange:A=>u(A.target.value),className:"bg-black/40 border border-white/10 rounded px-1 py-0.5 text-[9px] text-purple-300 outline-none cursor-pointer",children:[e.jsx("option",{value:"Linear",children:"Linear"}),e.jsx("option",{value:"Dome",children:"Dome"}),e.jsx("option",{value:"S-Curve",children:"S-Curve"}),e.jsx("option",{value:"Pinpoint",children:"Pinpoint"})]})]}),e.jsx(Me,{label:"Radius (Frames)",value:d,min:0,max:100,step:1,onChange:A=>c(A,!0),highlight:!0}),e.jsx("div",{className:"text-[8px] text-gray-500 italic pl-1",children:"Ctrl+Drag Key to adjust size"})]})]}),m.interpolation==="Bezier"&&e.jsx(e.Fragment,{children:e.jsxs("div",{className:"px-3 py-2 border-y border-white/5 bg-black/20 mt-2","data-help-id":"anim.graph",children:[e.jsx("span",{className:"text-[9px] font-bold text-gray-500 uppercase tracking-wider block mb-2",children:"Tangents"}),e.jsxs("div",{className:"grid grid-cols-2 gap-3 mb-3",children:[e.jsxs("div",{children:[e.jsx("span",{className:"text-[8px] text-gray-500 font-bold block mb-1",children:"LEFT HANDLE"}),e.jsxs("div",{className:"flex flex-col gap-1 pl-1 border-l border-white/5",children:[e.jsxs("div",{className:"flex justify-between items-center h-5",children:[e.jsx("span",{className:"text-[9px] text-gray-400",children:"Angle"}),e.jsx("div",{className:"w-12 bg-black/40 rounded px-1",children:e.jsx(_e,{value:L.angle,onChange:A=>N("left","angle",A),step:1,onDragStart:P,onDragEnd:$})})]}),e.jsxs("div",{className:"flex justify-between items-center h-5",children:[e.jsx("span",{className:"text-[9px] text-gray-400",children:"Weight"}),e.jsx("div",{className:"w-12 bg-black/40 rounded px-1",children:e.jsx(_e,{value:L.length,onChange:A=>N("left","length",A),step:1,min:0,onDragStart:P,onDragEnd:$})})]})]})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-[8px] text-gray-500 font-bold block mb-1",children:"RIGHT HANDLE"}),e.jsxs("div",{className:"flex flex-col gap-1 pl-1 border-l border-white/5",children:[e.jsxs("div",{className:"flex justify-between items-center h-5",children:[e.jsx("span",{className:"text-[9px] text-gray-400",children:"Angle"}),e.jsx("div",{className:"w-12 bg-black/40 rounded px-1",children:e.jsx(_e,{value:_.angle,onChange:A=>N("right","angle",A),step:1,onDragStart:P,onDragEnd:$})})]}),e.jsxs("div",{className:"flex justify-between items-center h-5",children:[e.jsx("span",{className:"text-[9px] text-gray-400",children:"Weight"}),e.jsx("div",{className:"w-12 bg-black/40 rounded px-1",children:e.jsx(_e,{value:_.length,onChange:A=>N("right","length",A),step:1,min:0,onDragStart:P,onDragEnd:$})})]})]})]})]}),e.jsx(id,{value:S?!!m.brokenTangents:!1,onChange:E,options:[{label:"Unified",value:!1},{label:"Broken",value:!0}]})]})})]}):e.jsxs("div",{className:"p-4 text-[9px] text-gray-500 italic text-center leading-relaxed opacity-75",children:["No keys selected.",e.jsx("br",{}),e.jsx("br",{}),"Use the buttons above to change interpolation for ",e.jsx("strong",{children:"the entire animation"}),"."]})]})},ld=({FRAME_WIDTH:a,durationFrames:t,scrollLeft:o,visibleWidth:r})=>{const n=v.useRef(null),{currentFrame:i,seek:s,setIsScrubbing:l}=xe(),d=Math.max(1,r-dt);v.useEffect(()=>{const f=n.current;if(!f)return;const u=f.getContext("2d");if(!u)return;const p=window.devicePixelRatio||1;f.width=d*p,f.height=24*p,u.setTransform(1,0,0,1,0,0),u.scale(p,p),u.fillStyle="#080808",u.fillRect(0,0,d,24),u.save(),u.translate(-o,0),u.font="10px monospace",u.textAlign="left",u.textBaseline="top";const{textStep:h,lineStep:g}=On(a),M=Math.max(0,Math.floor(o/a)),m=Math.ceil((o+d)/a),y=Math.floor(M/g)*g;for(let k=y;k<=m;k+=g){const S=k*a;k%h===0?(u.fillStyle="#9ca3af",u.fillRect(S,0,1,12),u.fillText(k.toString(),S+4,2)):(u.fillStyle="#374151",u.fillRect(S,16,1,8))}u.fillStyle="#374151",u.fillRect(o,23,d,1);const x=t*a;if(x<o+d){const k=o+d-x+500;u.fillStyle="rgba(0, 0, 0, 0.6)",u.fillRect(x,0,k,24);const S=document.createElement("canvas");S.width=10,S.height=10;const b=S.getContext("2d");if(b){b.strokeStyle="rgba(255,255,255,0.1)",b.lineWidth=1,b.beginPath(),b.moveTo(0,10),b.lineTo(10,0),b.stroke();const w=u.createPattern(S,"repeat");w&&(u.fillStyle=w,u.fillRect(x,0,k,24))}u.fillStyle="#666",u.fillRect(x,0,1,24)}const C=i*a;C>=o-10&&C<=o+d+10&&(u.fillStyle="#ef4444",u.beginPath(),u.moveTo(C-6,0),u.lineTo(C+6,0),u.lineTo(C,8),u.fill()),u.restore()},[t,a,d,o,i]);const c=f=>{f.preventDefault(),f.stopPropagation();const u=f.button===1;l(!0);const p=f.currentTarget.getBoundingClientRect(),h=m=>{const x=m-p.left+o,C=Math.max(0,Math.round(x/a));s(C),u||Ke.scrub(C)};h(f.clientX);const g=m=>h(m.clientX),M=()=>{l(!1),window.removeEventListener("mousemove",g),window.removeEventListener("mouseup",M)};window.addEventListener("mousemove",g),window.addEventListener("mouseup",M)};return e.jsxs("div",{className:"flex bg-black/20 border-b border-white/10 z-30 sticky top-0",style:{height:Dr},children:[e.jsx("div",{className:"sticky left-0 z-30 w-[220px] bg-black/80 backdrop-blur-sm border-r border-white/10 shrink-0 flex items-center px-2 text-[9px] text-gray-500 font-bold uppercase tracking-widest",style:{width:dt},children:"Tracks"}),e.jsx("div",{className:"relative cursor-ew-resize overflow-hidden z-20",style:{transform:`translateX(${o}px)`,width:d},onMouseDown:c,children:e.jsx("canvas",{ref:n,style:{width:d,height:24,display:"block"}})})]})},ro={displays:new Map},cd=()=>{const a=xe.getState();ro.displays.forEach((t,o)=>{if(t)try{const r=Na(o,a.isPlaying,a.currentFrame,a.sequence);t.innerText=r.toFixed(2)}catch(r){console.error("Error updating live value display:",r)}})},dd=({tid:a})=>{const t=v.useRef(null);return v.useEffect(()=>(t.current&&ro.displays.set(a,t.current),()=>{ro.displays.delete(a)}),[a]),e.jsx("span",{ref:t,className:"text-[9px] font-mono text-gray-600 w-12 text-right",children:"--"})},$n=v.memo(({tid:a,sequence:t,frameWidth:o,isSelected:r,selectedKeys:n,onSelect:i,onRemove:s,onAddKey:l,onKeyMouseDown:d})=>{const c=Y(u=>u.openContextMenu),f=u=>{const p=Oe(u.currentTarget);p.length>0&&(u.preventDefault(),u.stopPropagation(),c(u.clientX,u.clientY,[],p))};return e.jsxs("div",{className:"flex border-b border-white/5 bg-transparent hover:bg-white/5",style:{height:32},"data-help-id":"anim.tracks",children:[e.jsxs("div",{className:`sticky left-0 z-30 w-[220px] bg-black/80 backdrop-blur-sm border-r border-white/10 shrink-0 flex items-center justify-between px-3 cursor-pointer group select-none ${r?"border-l-2 border-l-cyan-500":""}`,onClick:u=>i(u,a),onMouseDown:u=>u.stopPropagation(),onContextMenu:f,"data-help-id":"anim.tracks",children:[e.jsx("div",{className:"truncate text-[10px] font-bold text-gray-400 group-hover:text-cyan-400 pl-4",title:t.tracks[a].label,children:t.tracks[a].label}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(dd,{tid:a}),e.jsx("button",{onClick:u=>{u.stopPropagation(),s()},className:"opacity-0 group-hover:opacity-100 text-red-500 hover:text-red-400",children:e.jsx(St,{})})]})]}),e.jsxs("div",{className:"flex-1 relative group/track z-10",onDoubleClick:u=>{u.stopPropagation();const p=u.currentTarget.getBoundingClientRect(),h=Math.max(0,Math.round((u.clientX-p.left)/o));l(h)},children:[e.jsx("div",{className:"absolute inset-0 opacity-0 group-hover/track:opacity-5 bg-white pointer-events-none"}),t.tracks[a].keyframes.map(u=>{const p=n.includes(`${a}::${u.id}`);return e.jsx("div",{className:"absolute top-1/2 -translate-y-1/2 z-20 cursor-grab group/key",style:{left:`${u.frame*o-10}px`,width:"20px",height:"20px"},onMouseDown:h=>d(h,a,u.id),"data-help-id":"anim.keyframes",children:e.jsx("div",{className:`absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-3 h-3 border transition-transform ${p?"bg-white border-white scale-125 z-30":"bg-cyan-900 border-cyan-400 group-hover/key:scale-125 group-hover/key:bg-cyan-400"} ${u.interpolation==="Linear"?"rotate-45 rounded-sm":u.interpolation==="Step"?"rounded-none":"rounded-full"}`})},u.id)})]})]})}),ud=v.memo(({groupName:a,trackIds:t,collapsed:o,onToggle:r,sequence:n,frameWidth:i,selectedTrackIds:s,selectedKeyframeIds:l,onTrackSelect:d,onRemoveTrack:c,onAddKey:f,onKeyMouseDown:u,onGroupKeyMouseDown:p})=>{const h=At.useMemo(()=>{const g=new Set;return t.forEach(M=>{const m=n.tracks[M];m&&m.keyframes.forEach(y=>g.add(y.frame))}),Array.from(g).sort((M,m)=>M-m)},[t,n]);return e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex border-b border-white/5 bg-white/10",style:{height:24},children:[e.jsxs("div",{className:"sticky left-0 z-30 w-[220px] bg-[#1a1a1a] border-r border-white/10 shrink-0 flex items-center px-2 cursor-pointer hover:bg-gray-700 select-none",onClick:g=>{g.stopPropagation(),r(a,g.altKey)},onMouseDown:g=>g.stopPropagation(),"data-help-id":"anim.tracks",children:[e.jsx("span",{className:"text-gray-500 w-4",children:e.jsx(Rn,{open:!o})}),e.jsx("span",{className:"text-[10px] font-bold text-gray-300 uppercase tracking-wider",children:a})]}),e.jsx("div",{className:"flex-1 relative group/track",children:h.map(g=>e.jsx("div",{className:"absolute top-1/2 -mt-1.5 w-3 h-3 bg-gray-500/50 border border-gray-400/50 rotate-45 cursor-grab hover:bg-white hover:border-white hover:scale-125 z-10",style:{left:`${g*i-6}px`},onMouseDown:M=>p(M,t,g),"data-help-id":"anim.keyframes"},g))})]}),!o&&t.map(g=>e.jsx($n,{tid:g,sequence:n,frameWidth:i,isSelected:s.includes(g),selectedKeys:l,onSelect:d,onRemove:()=>c(g),onAddKey:M=>f(g,M),onKeyMouseDown:u},g))]})}),fd=({frameWidth:a,contentRef:t,scrollContainerRef:o,SIDEBAR_WIDTH:r,RULER_HEIGHT:n,GROUP_HEIGHT:i,TRACK_HEIGHT:s,organizedTracks:l,collapsedGroups:d,sequence:c,selectedTrackIds:f})=>{const{updateKeyframes:u,selectKeyframes:p,selectTrack:h,deselectAllKeys:g,setIsScrubbing:M,selectedKeyframeIds:m,snapshot:y}=xe(),[x,C]=v.useState(null),k=v.useRef(null),S=v.useRef(null),b=v.useRef(null),w=(_,R)=>{const z=[],E=new Set(R),N=new Map;R.forEach(P=>{const[$,O]=P.split("::"),X=c.tracks[$],W=X==null?void 0:X.keyframes.find(H=>H.id===O);W&&z.push({trackId:$,keyId:O,startFrame:W.frame,startLeftTan:W.leftTangent?{...W.leftTangent}:void 0,startRightTan:W.rightTangent?{...W.rightTangent}:void 0})}),z.forEach(P=>{const $=c.tracks[P.trackId];if(!$)return;const O=[...$.keyframes].sort((W,H)=>W.frame-H.frame),X=O.findIndex(W=>W.id===P.keyId);if(X!==-1){if(X>0){const W=O[X-1],H=`${P.trackId}::${W.id}`;E.has(H)||(N.has(H)||N.set(H,{trackId:P.trackId,keyId:W.id,frame:W.frame,startRightTan:W.rightTangent?{...W.rightTangent}:void 0}),N.get(H).rightReferenceKeyId=P.keyId)}if(X<O.length-1){const W=O[X+1],H=`${P.trackId}::${W.id}`;E.has(H)||(N.has(H)||N.set(H,{trackId:P.trackId,keyId:W.id,frame:W.frame,startLeftTan:W.leftTangent?{...W.leftTangent}:void 0}),N.get(H).leftReferenceKeyId=P.keyId)}}}),S.current={startX:_,keys:z,neighbors:N},M(!0)},j=(_,R,z,E)=>{_.stopPropagation(),_.preventDefault(),y(),M(!0);const N=[];m.forEach(P=>{const[$,O]=P.split("::"),X=c.tracks[$],W=X==null?void 0:X.keyframes.find(H=>H.id===O);W&&N.push({trackId:$,keyId:W.id,startFrame:W.frame})}),b.current={type:R,startX:_.clientX,initialKeys:N,minFrame:z,maxFrame:E}},T=_=>{if(_.button!==0||_.target.closest(".transform-handle"))return;!_.shiftKey&&!_.ctrlKey&&!_.metaKey&&g();const R=t.current;if(!R)return;let z=null;if(o.current){const $=o.current.getBoundingClientRect(),O=_.clientY-$.top;if(O<n||(O<n+i&&(z=n+1),_.clientX-$.left<r))return}const E=R.getBoundingClientRect(),N=_.clientX-E.left,P=z!==null?z:_.clientY-E.top;k.current={x:N,y:P},C({x:N,y:P,w:0,h:0})},L=v.useRef({organizedTracks:l,collapsedGroups:d,sequence:c,selectedTrackIds:f,frameWidth:a});return v.useEffect(()=>{L.current={organizedTracks:l,collapsedGroups:d,sequence:c,selectedTrackIds:f,frameWidth:a}},[l,d,c,f,a]),v.useEffect(()=>{const _=z=>{const E=xe.getState().currentFrame,N=L.current.frameWidth;if(S.current){const P=z.clientX-S.current.startX,$=Math.round(P/N),O=new Map;S.current.keys.forEach(W=>{O.set(W.keyId,Math.max(0,W.startFrame+$))});const X=[];S.current.keys.forEach(W=>{const H=Math.max(0,W.startFrame+$),A={frame:H},F=L.current.sequence.tracks[W.trackId];if(F){const I=[...F.keyframes].sort((G,q)=>G.frame-q.frame),D=I.find(G=>G.id===W.keyId);if(D){const G=I.indexOf(D),q=G>0?I[G-1]:void 0,Q=G<I.length-1?I[G+1]:void 0,J={...D,leftTangent:W.startLeftTan,rightTangent:W.startRightTan},re=Ln(J,q,Q,W.startFrame,H);Object.assign(A,re);const U={...D,frame:H,...A},V=Nn(U,q,Q);Object.assign(A,V)}}X.push({trackId:W.trackId,keyId:W.keyId,patch:A})}),S.current.neighbors.forEach(W=>{var A,F;const H={};if(W.rightReferenceKeyId&&W.startRightTan){const I=O.get(W.rightReferenceKeyId),D=(A=S.current.keys.find(G=>G.keyId===W.rightReferenceKeyId))==null?void 0:A.startFrame;if(I!==void 0&&D!==void 0){const G=D-W.frame,q=I-W.frame;if(Math.abs(G)>1e-5&&Math.abs(q)>1e-5){const Q=q/G;H.rightTangent={x:W.startRightTan.x*Q,y:W.startRightTan.y*Q}}}}if(W.leftReferenceKeyId&&W.startLeftTan){const I=O.get(W.leftReferenceKeyId),D=(F=S.current.keys.find(G=>G.keyId===W.leftReferenceKeyId))==null?void 0:F.startFrame;if(I!==void 0&&D!==void 0){const G=W.frame-D,q=W.frame-I;if(Math.abs(G)>1e-5&&Math.abs(q)>1e-5){const Q=q/G;H.leftTangent={x:W.startLeftTan.x*Q,y:W.startLeftTan.y*Q}}}}Object.keys(H).length>0&&X.push({trackId:W.trackId,keyId:W.keyId,patch:H})}),u(X),Ke.scrub(E)}if(b.current){const{type:P,startX:$,initialKeys:O,minFrame:X,maxFrame:W}=b.current,H=z.clientX-$,A=[];if(P==="move"){const F=Math.round(H/N);O.forEach(I=>{const D=Math.max(0,I.startFrame+F);A.push({trackId:I.trackId,keyId:I.keyId,patch:{frame:D}})})}else if(P==="scale_left"||P==="scale_right"){const F=Math.max(1,W-X);let I=1;if(P==="scale_right"){const D=H/N;I=Math.max(1,F+D)/F,O.forEach(q=>{const Q=q.startFrame-X,J=X+Q*I;A.push({trackId:q.trackId,keyId:q.keyId,patch:{frame:Math.max(0,Math.round(J))}})})}else{const D=H/N;I=Math.max(1,F-D)/F,O.forEach(q=>{const Q=W-q.startFrame,J=W-Q*I;A.push({trackId:q.trackId,keyId:q.keyId,patch:{frame:Math.max(0,Math.round(J))}})})}}A.length>0&&(u(A),Ke.scrub(E))}if(k.current&&t.current){const P=t.current.getBoundingClientRect(),$=z.clientX-P.left,O=z.clientY-P.top,X=Math.min($,k.current.x),W=Math.min(O,k.current.y),H=Math.abs($-k.current.x),A=Math.abs(O-k.current.y);C({x:X,y:W,w:H,h:A})}},R=z=>{const{organizedTracks:E,collapsedGroups:N,sequence:P,selectedTrackIds:$,frameWidth:O}=L.current;if((S.current||b.current)&&M(!1),S.current=null,b.current=null,k.current&&x&&t.current){const X=new Set,W=new Set,H=x.x,A=x.y,F=H+x.w,I=A+x.h,D=n,G=n+i;I>D&&A<G&&Object.values(P.tracks).forEach(U=>{U.hidden||U.keyframes.forEach(V=>{const te=r+V.frame*O;te>=H&&te<=F&&(X.add(`${U.id}::${V.id}`),W.add(U.id))})});let q=n+i;const Q=4,J=re=>{const U=q+Q,V=q+s-Q;if(I>U&&A<V){const te=P.tracks[re];te&&te.keyframes.forEach(K=>{const ae=r+K.frame*O;ae>=H&&ae<=F&&(X.add(`${re}::${K.id}`),W.add(re))})}q+=s};if(Object.entries(E.groups).forEach(([re,U])=>{const V=q,te=q+i;I>V&&A<te&&U.forEach(K=>{const ae=P.tracks[K];ae&&ae.keyframes.forEach(se=>{const ee=r+se.frame*O;ee>=H&&ee<=F&&(X.add(`${K}::${se.id}`),W.add(K))})}),q+=i,N.has(re)||U.forEach(K=>J(K))}),E.standalone.forEach(re=>J(re)),X.size>0){const re=z.shiftKey||z.ctrlKey,U=Array.from(X);if(p(U,re),re)W.forEach(V=>{$.includes(V)||h(V,!0)});else{const V=Array.from(W);if(V.length>0){h(V[0],!1);for(let te=1;te<V.length;te++)h(V[te],!0)}}}else!z.shiftKey&&!z.ctrlKey&&g();C(null),k.current=null}};return window.addEventListener("mousemove",_),window.addEventListener("mouseup",R),()=>{window.removeEventListener("mousemove",_),window.removeEventListener("mouseup",R)}},[x]),{selectionBox:x,handleContentMouseDown:T,startDragKeys:w,startTransformSelection:j}},pd=({frameWidth:a})=>{const t=xe(o=>o.currentFrame);return e.jsx("div",{className:"absolute top-6 bottom-0 w-px bg-red-500/50 pointer-events-none z-10",style:{left:`${dt+t*a}px`}})},hd=({frameWidth:a,totalContentWidth:t,onContextMenu:o,onCanvasContextMenu:r,scrollContainerRef:n,scrollLeft:i,visibleWidth:s})=>{const l=xe(F=>F.sequence),d=xe(F=>F.selectedTrackIds),c=xe(F=>F.selectedKeyframeIds),f=xe(F=>F.durationFrames),{selectTrack:u,selectKeyframe:p,selectKeyframes:h,removeTrack:g,addKeyframe:M,snapshot:m,deleteSelectedKeyframes:y}=xe(),[x,C]=v.useState(new Set(["Formula","Optics","Lighting","Shading"])),k=v.useRef(null),S=v.useRef(null);v.useLayoutEffect(()=>{n.current&&(n.current.scrollLeft=i)},[i,n]),v.useEffect(()=>{const F=I=>{I.target.tagName==="INPUT"||I.target.tagName==="TEXTAREA"||(I.key==="Delete"||I.key==="Backspace")&&(I.preventDefault(),y())};return window.addEventListener("keydown",F),()=>window.removeEventListener("keydown",F)},[y]),v.useEffect(()=>{const F=D=>{if(!D)return;const G=String(D);let q="Shading";G.startsWith("camera.")?q="Camera":G.startsWith("lights.")||G.startsWith("lighting.")?q="Lighting":G.startsWith("coreMath.")||G.startsWith("geometry.")||G.startsWith("julia.")||G.startsWith("hybridParams.")||G==="iterations"||G.startsWith("param")?q="Formula":(G==="camFov"||G.startsWith("optics.")||G.startsWith("dof")||G.startsWith("fog"))&&(q="Optics"),C(Q=>{const J=new Set(["Camera","Formula","Optics","Lighting","Shading"]);return J.delete(q),J})};return le.on(Fe.TRACK_FOCUS,F)},[]);const b=(F,I)=>{C(D=>{const G=new Set(D);return I?(G.clear(),Object.keys(w.groups).forEach(q=>{q!==F&&G.add(q)}),G.delete(F)):G.has(F)?G.delete(F):G.add(F),G})},w=v.useMemo(()=>{const F={},I=[];return F.Camera=[],F.Formula=[],F.Optics=[],F.Lighting=[],F.Shading=[],Object.values(l.tracks).forEach(D=>{D.hidden||(D.id.startsWith("camera.")?F.Camera.push(D.id):D.id.startsWith("lights.")||D.id.startsWith("lighting.")?F.Lighting.push(D.id):D.id.startsWith("coreMath.")||D.id.startsWith("geometry.")||D.id.startsWith("param")||D.id.startsWith("julia.")||D.id.startsWith("hybridParams.")||D.id==="iterations"?F.Formula.push(D.id):D.id==="camFov"||D.id.startsWith("optics.")||D.id.startsWith("dof")||D.id.startsWith("fog")||D.id.startsWith("atmosphere.")?D.id.startsWith("fog")||D.id.startsWith("atmosphere.")?F.Shading.push(D.id):F.Optics.push(D.id):F.Shading.push(D.id))}),Object.keys(F).forEach(D=>{F[D].length===0&&delete F[D]}),{groups:F,standalone:I}},[l.tracks]),j=v.useMemo(()=>{let F=[];return Object.entries(w.groups).forEach(([I,D])=>{x.has(I)||(F=F.concat(D))}),F=F.concat(w.standalone),F},[w,x]),T=v.useMemo(()=>{if(c.length<2)return null;let F=1/0,I=-1/0,D=!1;return c.forEach(G=>{const[q,Q]=G.split("::"),J=l.tracks[q];if(J){const re=J.keyframes.find(U=>U.id===Q);re&&(re.frame<F&&(F=re.frame),re.frame>I&&(I=re.frame),D=!0)}}),!D||F===1/0||Math.abs(I-F)<.001?null:{min:F,max:I}},[c,l]),{selectionBox:L,handleContentMouseDown:_,startDragKeys:R,startTransformSelection:z}=fd({frameWidth:a,contentRef:k,scrollContainerRef:n,SIDEBAR_WIDTH:dt,RULER_HEIGHT:Dr,GROUP_HEIGHT:No,TRACK_HEIGHT:Ji,organizedTracks:w,collapsedGroups:x,sequence:l,selectedTrackIds:d}),E=F=>{const I=new Set;return F.forEach(D=>{const G=l.tracks[D];G&&G.keyframes.forEach(q=>I.add(q.frame))}),Array.from(I).sort((D,G)=>D-G)},N=()=>{const F=Object.values(l.tracks).filter(I=>!I.hidden).map(I=>I.id);return E(F)},P=(F,I)=>{const D=F.ctrlKey||F.metaKey||F.shiftKey;if(F.shiftKey&&S.current){const G=j.indexOf(S.current),q=j.indexOf(I);if(G!==-1&&q!==-1){const Q=Math.min(G,q),J=Math.max(G,q),re=j.slice(Q,J+1);re.forEach(V=>u(V,!0));const U=[];re.forEach(V=>{const te=l.tracks[V];te&&te.keyframes.forEach(K=>U.push(`${V}::${K.id}`))}),h(U,!0)}}else{u(I,D);const G=l.tracks[I];if(G){const q=G.keyframes.map(Q=>`${I}::${Q.id}`);h(q,D)}}S.current=I},$=(F,I,D)=>{if(F.stopPropagation(),F.preventDefault(),F.button===2){const J=`${I}::${D}`;c.includes(J)||(p(I,D,!1),u(I,!1));const re=l.tracks[I],U=re==null?void 0:re.keyframes.find(V=>V.id===D);U&&o(F,I,D,U.interpolation,!!U.brokenTangents,!!U.autoTangent);return}const G=`${I}::${D}`,q=c.includes(G);if(F.shiftKey||F.ctrlKey||F.metaKey){p(I,D,!0),d.includes(I)||u(I,!0),m();const J=q?c:[...c,G];R(F.clientX,J)}else q?(m(),R(F.clientX,c)):(p(I,D,!1),u(I,!1),m(),R(F.clientX,[G]))},O=(F,I,D)=>{F.stopPropagation(),F.preventDefault();const G=[];if(I.forEach(Q=>{const J=l.tracks[Q],re=J==null?void 0:J.keyframes.find(U=>Math.abs(U.frame-D)<.001);re&&G.push(`${Q}::${re.id}`)}),G.length===0)return;if(F.button===2){h(G,!1);const[Q,J]=G[0].split("::"),re=l.tracks[Q],U=re==null?void 0:re.keyframes.find(V=>V.id===J);U&&o(F,Q,J,U.interpolation,!!U.brokenTangents,!!U.autoTangent);return}const q=F.shiftKey||F.ctrlKey||F.metaKey;if(m(),q){h(G,!0),I.forEach(J=>{d.includes(J)||u(J,!0)});const Q=Array.from(new Set([...c,...G]));R(F.clientX,Q)}else h(G,!1),I.forEach((Q,J)=>{J===0?u(Q,!1):u(Q,!0)}),R(F.clientX,G)},X=(F,I)=>{m();const D=Na(F,!1);M(F,I,D)},W=F=>{var U;F.preventDefault();const I=k.current;if(!I)return;const D=I.getBoundingClientRect(),G=F.clientX-D.left,q=((U=n.current)==null?void 0:U.scrollLeft)||0,J=G+q-dt,re=Math.max(0,Math.round(J/a));r(F,re)},H=dt+f*a,A=Math.max(0,i+s-H+500);return e.jsxs("div",{ref:k,className:"relative min-h-full bg-[#111]",style:{minWidth:t},onMouseDown:_,"data-help-id":"ui.timeline",onContextMenu:W,children:[e.jsx("div",{className:"absolute top-0 bottom-0 pointer-events-none z-0",style:{left:H,width:A,backgroundImage:"repeating-linear-gradient(45deg, rgba(0,0,0,0.3) 0px, rgba(0,0,0,0.3) 10px, transparent 10px, transparent 20px)",backgroundColor:"rgba(0,0,0,0.5)"}}),e.jsx(ld,{FRAME_WIDTH:a,durationFrames:f,scrollLeft:i,visibleWidth:s}),e.jsx(pd,{frameWidth:a}),L&&e.jsx("div",{className:"absolute bg-cyan-500/20 border border-cyan-400/50 z-50 pointer-events-none",style:{left:L.x,top:L.y,width:L.w,height:L.h}}),e.jsxs("div",{className:"flex border-b border-white/5 bg-white/5 sticky top-6 z-20",style:{height:No},children:[e.jsx("div",{className:"sticky left-0 z-20 w-[220px] bg-black/80 backdrop-blur-sm border-r border-white/10 shrink-0 flex items-center px-2 select-none",children:e.jsx("span",{className:"text-[10px] font-black text-cyan-400 uppercase tracking-widest pl-4",children:"Global Summary"})}),e.jsxs("div",{className:"flex-1 relative group/track",children:[N().map(F=>e.jsx("div",{className:"absolute top-1/2 -mt-1.5 w-3 h-3 bg-cyan-600 border border-cyan-300 rotate-45 cursor-grab hover:bg-white hover:border-white hover:scale-125 z-10 shadow-sm",style:{left:`${F*a-6}px`},onMouseDown:I=>O(I,Object.keys(l.tracks),F),"data-help-id":"anim.keyframes"},F)),T&&e.jsxs("div",{className:"absolute top-0 bottom-0 z-30 transform-handle group/transform",style:{left:`${T.min*a-12}px`,width:`${(T.max-T.min)*a+24}px`},children:[e.jsx("div",{className:"absolute top-1 bottom-1 left-0 right-0 bg-orange-500/20 border border-orange-500/50 rounded-md cursor-grab active:cursor-grabbing hover:bg-orange-500/30 transition-colors",onMouseDown:F=>z(F,"move",T.min,T.max)}),e.jsx("div",{className:"absolute top-0 bottom-0 left-0 w-3 cursor-ew-resize flex items-center justify-center group/l",onMouseDown:F=>z(F,"scale_left",T.min,T.max),children:e.jsx("div",{className:"w-1 h-3 bg-orange-400 rounded-full shadow-sm group-hover/l:bg-white"})}),e.jsx("div",{className:"absolute top-0 bottom-0 right-0 w-3 cursor-ew-resize flex items-center justify-center group/r",onMouseDown:F=>z(F,"scale_right",T.min,T.max),children:e.jsx("div",{className:"w-1 h-3 bg-orange-400 rounded-full shadow-sm group-hover/r:bg-white"})})]})]})]}),Object.entries(w.groups).map(([F,I])=>e.jsx(ud,{groupName:F,trackIds:I,collapsed:x.has(F),onToggle:(D,G)=>b(D,G),sequence:l,frameWidth:a,selectedTrackIds:d,selectedKeyframeIds:c,onTrackSelect:P,onRemoveTrack:g,onAddKey:X,onKeyMouseDown:$,onGroupKeyMouseDown:O},F)),w.standalone.map(F=>e.jsx($n,{tid:F,sequence:l,frameWidth:a,isSelected:d.includes(F),selectedKeys:c,onSelect:P,onRemove:()=>g(F),onAddKey:I=>X(F,I),onKeyMouseDown:$},F)),e.jsx("div",{className:"h-32"})]})},md=(a,t,o,r,n,i)=>{const s=[{label:"Interpolation",action:()=>{},isHeader:!0},{label:"Linear",checked:a==="Linear",action:()=>r.updateInterp("Linear")},{label:"Step",checked:a==="Step",action:()=>r.updateInterp("Step")},{label:"Bezier",checked:a==="Bezier",action:()=>r.updateInterp("Bezier")}];return a==="Bezier"&&s.push({label:"Tangents",action:()=>{},isHeader:!0},{label:"Auto (Smooth)",checked:!!o,action:()=>r.setTangents("Auto")},{label:"Ease (Flat)",action:()=>r.setTangents("Ease")},{label:"Unified",checked:!t&&!o,action:()=>r.setTangents("Unified")},{label:"Broken",checked:!!t,action:()=>r.setTangents("Split")}),s.push({label:"Clipboard",action:()=>{},isHeader:!0},{label:`Copy ${n>1?`(${n})`:""}`,action:r.copyKeys},{label:"Paste",disabled:!i,action:r.pasteKeys},{label:"Duplicate Here",action:r.duplicateKeys},{label:"Duplicate & Loop",children:[{label:"Loop x2",action:()=>r.loopKeys(1)},{label:"Loop x3",action:()=>r.loopKeys(2)},{label:"Loop x4",action:()=>r.loopKeys(3)},{label:"Loop x8",action:()=>r.loopKeys(7)}]}),s.push({label:"Actions",action:()=>{},isHeader:!0},{label:`Delete ${n>1?"Keys":"Key"}`,danger:!0,action:r.deleteKeys}),s},gd=({onClose:a})=>{const{isPlaying:t,currentFrame:o,durationFrames:r,sequence:n,selectedTrackIds:i,updateKeyframes:s,setTangents:l,deleteSelectedKeyframes:d,snapshot:c,selectedKeyframeIds:f,clipboard:u,copySelectedKeyframes:p,pasteKeyframes:h,duplicateSelection:g,loopSelection:M}=xe(),m=Y(I=>I.openContextMenu),y=Y(I=>I.setIsTimelineHovered),[x,C]=v.useState("DopeSheet"),[k,S]=v.useState(250),[b,w]=v.useState(!1),[j,T]=v.useState(8),[L,_]=v.useState(0),[R,z]=v.useState(0),E=v.useRef(null),[N,P]=v.useState([]),$=!0;v.useEffect(()=>{if(x==="Graph"&&N.length===0)if(i.length>0)P([...i]);else{const I=Object.values(n.tracks).filter(D=>!D.hidden).map(D=>D.id);P(I)}},[x,i.length,n.tracks]),v.useEffect(()=>{x==="DopeSheet"&&E.current&&(E.current.scrollLeft=L)},[x,L]),v.useEffect(()=>{if(!t||!E.current)return;const I=E.current.clientWidth,D=dt+o*j,G=L+dt,q=L+I,Q=D>q,J=D<G;if(Q||J){const re=D-I/2;x==="DopeSheet"?E.current.scrollLeft=Math.max(0,re):_(Math.max(0,re))}},[o,t,x,L,j]),v.useEffect(()=>{if(!E.current)return;const I=new ResizeObserver(D=>{for(let G of D)z(G.contentRect.width)});return I.observe(E.current),z(E.current.clientWidth),()=>I.disconnect()},[]);const O=I=>{x==="DopeSheet"&&_(I.currentTarget.scrollLeft)},X=(I,D="factor")=>{let G=j;D==="factor"?G=j*I:G=I,G=Math.max(1,Math.min(200,G)),T(G)},W=(I,D,G,q,Q,J)=>{I.preventDefault();const U=md(q,Q,J,{updateInterp:V=>{c();const K=(f.length>0?f:[`${D}::${G}`]).map(ae=>{const[se,ee]=ae.split("::");return{trackId:se,keyId:ee,patch:{interpolation:V}}});s(K)},setTangents:V=>l(V),deleteKeys:d,copyKeys:p,pasteKeys:()=>h(o),duplicateKeys:g,loopKeys:V=>M(V)},f.length,!!u);m(I.clientX,I.clientY,U,["ui.timeline"])},H=(I,D)=>{I.preventDefault();const G=[{label:"Timeline Actions",action:()=>{},isHeader:!0},{label:`Copy Selected (${f.length})`,action:p,disabled:f.length===0},{label:"Paste Keys Here",action:()=>h(D),disabled:!u},{label:"Duplicate Selection Here",action:()=>{p(),h(D)},disabled:f.length===0},{label:"View",action:()=>{},isHeader:!0},{label:"Fit View (Duration)",action:()=>{const Q=(R-dt)/(r+10);X(Q,"absolute"),_(0),E.current&&(E.current.scrollLeft=0)}},{label:"Reset Zoom (8px)",action:()=>{X(8,"absolute")}}];m(I.clientX,I.clientY,G,["ui.timeline"])};v.useEffect(()=>{const I=G=>{if(b){const q=window.innerHeight-G.clientY;S(Math.max(150,Math.min(window.innerHeight*.8,q)))}},D=()=>{w(!1),document.body.style.cursor=""};return window.addEventListener("mousemove",I),window.addEventListener("mouseup",D),()=>{window.removeEventListener("mousemove",I),window.removeEventListener("mouseup",D)}},[b]);const A=(r+20)*j,F=dt+A;return e.jsxs("div",{className:"flex-shrink-0 bg-black/95 border-t border-white/10 flex flex-col z-40 select-none shadow-[0_-4px_20px_rgba(0,0,0,0.5)] relative backdrop-blur-md",style:{height:k},"data-help-id":"ui.timeline",onMouseEnter:()=>y(!0),onMouseLeave:()=>y(!1),children:[e.jsx("style",{children:`
                .no-scrollbar::-webkit-scrollbar { display: none; }
                .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
            `}),e.jsxs("div",{className:"absolute top-[-4px] left-0 right-0 h-3 cursor-row-resize z-[100] group flex items-center justify-center",onMouseDown:I=>{I.preventDefault(),w(!0),document.body.style.cursor="row-resize"},children:[e.jsx("div",{className:"w-full h-px bg-cyan-500/0 group-hover:bg-cyan-500/50 transition-colors"}),e.jsx("div",{className:"absolute w-16 h-1 bg-gray-600 rounded-full group-hover:bg-cyan-400 opacity-50 group-hover:opacity-100 transition-all"})]}),e.jsxs("div",{className:"flex flex-col flex-1 overflow-hidden h-full",children:[e.jsx(nd,{mode:x,setMode:C,totalContentWidth:F,viewportWidth:R,scrollLeft:L,onScroll:I=>{_(I),E.current&&x==="DopeSheet"&&(E.current.scrollLeft=I)},onZoom:X,onClose:a,containerRef:x==="DopeSheet"?E:void 0,frameWidth:j,durationFrames:r,inspectorVisible:$}),e.jsxs("div",{className:"flex flex-1 overflow-hidden",children:[e.jsx("div",{className:"flex-1 flex flex-col min-w-0 bg-[#080808] relative",children:x==="DopeSheet"?e.jsx("div",{ref:E,onScroll:O,className:"flex-1 overflow-auto bg-transparent no-scrollbar relative",children:e.jsx(hd,{frameWidth:j,totalContentWidth:F,scrollContainerRef:E,onContextMenu:W,onCanvasContextMenu:H,scrollLeft:L,visibleWidth:R})}):e.jsx("div",{ref:E,className:"flex-1 bg-transparent relative overflow-hidden",children:e.jsx(Jc,{trackIds:N,setVisibleTracks:P,width:R,height:k-32,scrollLeft:L,frameWidth:j,sidebarWidth:dt,onSetScroll:_,onSetFrameWidth:T,onContextMenu:(I,D,G,q)=>{const Q=n.tracks[D],J=Q==null?void 0:Q.keyframes.find(re=>re.id===G);W(I,D,G,q,J==null?void 0:J.brokenTangents,J==null?void 0:J.autoTangent)}})})}),e.jsx(sd,{})]})]})]})},bo=()=>{const[a,t]=v.useState(typeof window<"u"?window.innerHeight>window.innerWidth:!1),[o,r]=v.useState(!1);return v.useEffect(()=>{const n=()=>{t(window.innerHeight>window.innerWidth),r(window.matchMedia("(pointer: coarse)").matches||window.innerWidth<768)};return window.addEventListener("resize",n),n(),()=>window.removeEventListener("resize",n)},[]),{isPortrait:a,isMobile:o}},ir=({onMove:a,label:t,active:o})=>{const[r,n]=v.useState(!1),[i,s]=v.useState({x:0,y:0}),l=v.useRef(null),d=v.useRef(null),c=v.useRef({x:0,y:0}),f=v.useCallback((p,h)=>{if(!l.current)return;const g=l.current.getBoundingClientRect(),M=g.left+g.width/2,m=g.top+g.height/2,y=g.width/2;let x=(p-M)/y,C=(h-m)/y;const k=Math.sqrt(x*x+C*C);k>1&&(x/=k,C/=k);const S=30,b=Math.min(1,k),w=(k>0?x:0)*b*S,j=(k>0?C:0)*b*S;s({x:w,y:j}),c.current={x,y:-C}},[]),u=p=>{o&&(p.stopPropagation(),d.current=p.pointerId,n(!0),f(p.clientX,p.clientY),navigator.vibrate&&navigator.vibrate(10))};return v.useEffect(()=>{if(!r)return;const p=g=>{g.pointerId===d.current&&(g.cancelable&&g.preventDefault(),f(g.clientX,g.clientY),a(c.current.x,c.current.y))},h=g=>{g.pointerId===d.current&&(c.current={x:0,y:0},a(0,0),n(!1),s({x:0,y:0}),d.current=null,navigator.vibrate&&navigator.vibrate(5))};return window.addEventListener("pointermove",p,{passive:!1}),window.addEventListener("pointerup",h),window.addEventListener("pointercancel",h),()=>{window.removeEventListener("pointermove",p),window.removeEventListener("pointerup",h),window.removeEventListener("pointercancel",h)}},[r,f,a]),e.jsx("div",{ref:l,className:`w-36 h-36 rounded-full transition-all duration-200 relative flex items-center justify-center touch-none select-none ${r?"scale-110 shadow-[0_0_30px_rgba(34,211,238,0.1)]":"scale-100"} ${o?"pointer-events-auto":"pointer-events-none"}`,style:{touchAction:"none"},onPointerDown:u,children:e.jsxs("div",{className:`w-24 h-24 rounded-full border transition-all duration-500 flex items-center justify-center ${r?"bg-cyan-500/10 border-cyan-400":"bg-white/5 border-white/10"} ${o?"opacity-100":"opacity-0 scale-50"}`,children:[e.jsx("div",{className:`absolute -top-6 text-[8px] font-black uppercase tracking-widest pointer-events-none transition-colors ${r?"text-cyan-400":"text-white/30"}`,children:t}),e.jsx("div",{className:"absolute inset-2 rounded-full border border-white/5 pointer-events-none"}),e.jsx("div",{className:`w-10 h-10 rounded-full border shadow-xl transition-transform duration-75 pointer-events-none ${r?"bg-cyan-400 border-white shadow-[0_0_20px_rgba(34,211,238,0.5)]":"bg-white/10 border-white/20"}`,style:{transform:`translate(${i.x}px, ${i.y}px)`}})]})})},xd=()=>{const{cameraMode:a,setCameraMode:t,debugMobileLayout:o}=Y(),{isMobile:r}=bo(),[n,i]=v.useState(!1);v.useEffect(()=>{i(r||o)},[o,r]);const s=v.useCallback((c,f)=>{window.dispatchEvent(new CustomEvent("joyMove",{detail:{x:c,y:f}}))},[]),l=v.useCallback((c,f)=>{window.dispatchEvent(new CustomEvent("joyLook",{detail:{x:c,y:f}}))},[]);if(!n)return null;const d=a==="Fly";return e.jsxs("div",{className:"absolute inset-0 pointer-events-none z-[100] flex flex-col justify-between p-6 pb-10",children:[e.jsx("div",{className:"flex justify-start pt-16",children:e.jsxs("button",{onClick:()=>{navigator.vibrate&&navigator.vibrate(20),t(d?"Orbit":"Fly")},className:"pointer-events-auto flex items-center gap-2 bg-black/80 border border-white/20 px-4 py-2.5 rounded-full backdrop-blur-xl shadow-2xl active:scale-90 transition-all active:border-cyan-400",children:[e.jsx("div",{className:`w-2 h-2 rounded-full ${d?"bg-cyan-400 animate-pulse shadow-[0_0_5px_cyan]":"bg-purple-400"}`}),e.jsxs("span",{className:"text-[10px] font-black text-white uppercase tracking-widest",children:[a," Mode"]})]})}),e.jsxs("div",{className:"flex justify-between items-end transition-all duration-500",children:[e.jsx("div",{className:d?"pointer-events-auto":"pointer-events-none",children:e.jsx(ir,{label:"Move",onMove:s,active:d})}),e.jsx("div",{className:d?"pointer-events-auto":"pointer-events-none",children:e.jsx(ir,{label:"Look",onMove:l,active:d})})]})]})},yd=`
attribute vec2 position;
void main() {
  gl_Position = vec4(position, 0.0, 1.0);
}
`,bd=`
precision highp float;
uniform float uTime;
uniform vec2 uResolution;
uniform float uProgress; // 0.0 to 1.0

void main() {
    vec2 uv = gl_FragCoord.xy / uResolution.xy;
    vec2 p = (gl_FragCoord.xy - 0.5 * uResolution.xy) / uResolution.y;

    // --- Unfolding Animation ---
    p.x += (1.0 - uProgress) * 0.5;
    float zoom = 1.5 - 0.9 * pow(uProgress, 0.5); 
    p *= zoom;
    
    float ang = (1.0 - pow(uProgress, 0.2)) * 0.5;
    float s = sin(ang);
    float c = cos(ang);
    p = vec2(c*p.x - s*p.y, s*p.x + c*p.y);

    float t = uTime * 0.5;
    vec2 cJulia = vec2(cos(t) * 0.7885, sin(t) * 0.7885);
    
    vec2 z = p;
    float iter = 0.0;
    
    float maxIter = 10.0 + 80.0 * pow(uProgress, 1.5);
    
    for(float i = 0.0; i < 100.0; i++) {
        if (i > maxIter) break;
        if(dot(z,z) > 4.0) break;
        z = vec2(z.x*z.x - z.y*z.y, 2.0*z.x*z.y) + cJulia;
        iter++;
    }
    
    float sn = iter - log2(log2(dot(z,z))) + 4.0;
    float val = sn / 64.0; 
    
    vec3 col = 0.5 + 0.5 * cos(3.0 + val * 10.0 + vec3(0.0, 0.6, 1.0));
    
    float alpha = 1.0;
    if(iter >= maxIter) {
        col = vec3(0.0);
        alpha = 0.0;
    }
    
    if (alpha > 0.0) {
        col += 0.1 * sin(uv.x * 30.0 - uTime * 8.0) * uProgress;
    }
    
    gl_FragColor = vec4(col, alpha);
}
`;class vd{constructor(t){Z(this,"gl",null);Z(this,"program",null);Z(this,"locs",{});Z(this,"buffer",null);const o=t.getContext("webgl",{alpha:!0,premultipliedAlpha:!1});if(!o)return;this.gl=o,o.enable(o.BLEND),o.blendFunc(o.SRC_ALPHA,o.ONE_MINUS_SRC_ALPHA);const r=this.createShader(o.VERTEX_SHADER,yd),n=this.createShader(o.FRAGMENT_SHADER,bd);if(!r||!n)return;const i=o.createProgram();if(!i)return;o.attachShader(i,r),o.attachShader(i,n),o.linkProgram(i),o.useProgram(i),this.program=i,this.buffer=o.createBuffer(),o.bindBuffer(o.ARRAY_BUFFER,this.buffer),o.bufferData(o.ARRAY_BUFFER,new Float32Array([-1,-1,1,-1,-1,1,-1,1,1,-1,1,1]),o.STATIC_DRAW);const s=o.getAttribLocation(i,"position");o.enableVertexAttribArray(s),o.vertexAttribPointer(s,2,o.FLOAT,!1,0,0),this.locs={time:o.getUniformLocation(i,"uTime"),res:o.getUniformLocation(i,"uResolution"),prog:o.getUniformLocation(i,"uProgress")}}createShader(t,o){if(!this.gl)return null;const r=this.gl.createShader(t);return r?(this.gl.shaderSource(r,o),this.gl.compileShader(r),this.gl.getShaderParameter(r,this.gl.COMPILE_STATUS)?r:(console.error("Loading Shader Error:",this.gl.getShaderInfoLog(r)),this.gl.deleteShader(r),null)):null}render(t,o){if(!this.gl||!this.program)return;const r=this.gl,n=r.canvas;(n.width!==n.clientWidth||n.height!==n.clientHeight)&&(n.width=n.clientWidth,n.height=n.clientHeight,r.viewport(0,0,n.width,n.height)),r.clearColor(0,0,0,0),r.clear(r.COLOR_BUFFER_BIT),r.useProgram(this.program),r.uniform1f(this.locs.time,t*.001),r.uniform2f(this.locs.res,n.width,n.height),r.uniform1f(this.locs.prog,o),r.bindBuffer(r.ARRAY_BUFFER,this.buffer),r.drawArrays(r.TRIANGLES,0,6)}dispose(){if(this.gl){const t=this.gl.getExtension("WEBGL_lose_context");t&&t.loseContext()}}}const sr=a=>`thumbnails/fractal_${a}.jpg`,wd=({isReady:a,onFinished:t,startupMode:o,onPresetLoaded:r,bootEngine:n})=>{var N;const i=v.useRef(null),s=v.useRef(null),l=v.useRef(a),d=v.useRef(!1),c=v.useRef(n);v.useEffect(()=>{l.current=a},[a]),v.useEffect(()=>{c.current=n},[n]);const f=v.useRef(null),u=Y(P=>P.formula),p=Y(P=>P.setFormula),h=Y(P=>P.loadPreset),g=Y(),M=g.quality,m=(M==null?void 0:M.precisionMode)===1,[y,x]=v.useState(0),[C,k]=v.useState(1),[S,b]=v.useState(!0),[w,j]=v.useState(!1);v.useEffect(()=>{d.current=w},[w]);const[T,L]=v.useState(null);v.useEffect(()=>{o==="url"&&n&&n()},[o,n]);const _=P=>{if(p(P),j(!1),x(0),r){const $=Le.get(P);$&&$.defaultPreset&&r($.defaultPreset)}c.current&&c.current()},R=async P=>{var O;const $=(O=P.target.files)==null?void 0:O[0];if($)try{let X="";if($.type==="image/png"){const H=await Or($,"FractalData");if(H)X=H;else throw new Error("No Fractal Data found in PNG.")}else X=await $.text();const W=JSON.parse(X);h(W),r&&r(W),j(!1),x(0),c.current&&c.current()}catch(X){alert("Load failed: "+X.message)}},z=()=>{const P=m?"balanced":"lite";le.emit("is_compiling",`Switching to ${P} mode...`),g.applyPreset&&g.applyPreset({mode:P,actions:g})},E=v.useMemo(()=>Le.getAll(),[]);return v.useEffect(()=>{if(!i.current)return;try{s.current=new vd(i.current)}catch(H){console.warn("LoadingScreen: WebGL context creation failed for spinner.",H)}let P=0,$=0,O=performance.now();const X=2500,W=H=>{const A=performance.now(),F=Math.min(A-O,60);O=A;const I=l.current,D=d.current;$>60&&!B.isBooted&&!D&&o!=="url"&&c.current&&c.current(),$<100&&($>95&&!I?$+=F*(1/1e3):I&&$>95?$+=F*(100/300):$+=F*(100/X)),$>100&&($=100),Math.floor($)>Math.floor(y)&&x($),s.current&&s.current.render(H,$/100),$>=100&&!D?(!B.isBooted&&c.current&&c.current(),setTimeout(()=>{k(0),setTimeout(()=>{b(!1),s.current&&s.current.dispose(),t()},800)},200)):P=requestAnimationFrame(W)};return P=requestAnimationFrame(W),()=>cancelAnimationFrame(P)},[]),S?e.jsxs("div",{className:"fixed inset-0 z-[100] flex flex-col items-center justify-center bg-black transition-opacity duration-1000",style:{opacity:C},children:[e.jsxs("div",{className:"text-center mb-10 relative animate-fade-in-up z-10",children:[e.jsxs("h1",{className:"text-7xl font-black text-white tracking-tighter drop-shadow-[0_0_15px_rgba(34,211,238,0.5)] mb-2",children:["G",e.jsx("span",{className:"text-cyan-400",children:"M"}),"T"]}),e.jsx("div",{className:"text-xs text-gray-400 font-mono uppercase tracking-[0.4em]",children:"GPU Mandelbulb Tracer"})]}),e.jsxs("div",{className:"relative z-10 w-[500px] h-16 bg-gray-900/80 rounded-full border border-gray-700/50 overflow-hidden shadow-[0_0_50px_rgba(0,255,255,0.1)] backdrop-blur-sm",children:[e.jsx("div",{className:"absolute top-0 left-0 h-full overflow-hidden will-change-[width] transition-[width] duration-75 ease-linear",style:{width:`${y}%`},children:e.jsx("canvas",{ref:i,className:"absolute top-0 left-0 w-[500px] h-16"})}),e.jsx("div",{className:"absolute inset-0 bg-gradient-to-b from-white/5 to-transparent pointer-events-none"})]}),e.jsx("div",{className:"mt-6 font-mono text-sm text-cyan-500/80 z-20 flex flex-col items-center h-10",children:o==="url"?e.jsxs("span",{className:"animate-pulse tracking-wide",children:["LOADING SHARED SCENE... ",Math.floor(y),"%"]}):e.jsxs("div",{className:"relative flex flex-col items-center",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-cyan-600/80",children:"LOADING"}),e.jsxs("button",{onClick:()=>j(!w),className:"flex items-center gap-1 text-cyan-400 hover:text-white transition-colors border-b border-dashed border-cyan-500/30 hover:border-cyan-400 pb-0.5 outline-none",children:[e.jsxs("span",{className:"font-bold tracking-wide uppercase",children:["[",u,"]"]}),e.jsx("span",{className:`text-[10px] transform transition-transform ${w?"rotate-180":""}`,children:e.jsx(Rt,{})})]}),e.jsxs("span",{className:"text-cyan-600/80",children:[Math.floor(y),"%"]})]}),e.jsx("button",{onClick:z,className:`mt-4 px-3 py-1.5 text-[9px] font-bold uppercase tracking-widest rounded border transition-all ${m?"bg-orange-900/40 text-orange-200 border-orange-500/40 hover:bg-orange-800/50":"bg-white/5 text-gray-500 border-white/5 hover:text-white hover:border-white/20"}`,children:m?"Lite Render Active":"Enable Lite Render"}),w&&e.jsxs("div",{className:"absolute bottom-full mb-4 w-[340px] bg-black/95 border border-white/20 rounded-xl shadow-[0_10px_60px_rgba(0,0,0,0.9)] backdrop-blur-xl animate-fade-in text-xs z-[110]",onMouseLeave:()=>L(null),children:[T&&T!=="Modular"&&e.jsxs("div",{className:"absolute left-[350px] bottom-0 w-[256px] h-[256px] bg-black border border-cyan-500/50 rounded-lg shadow-[0_0_50px_rgba(0,0,0,1)] overflow-hidden animate-fade-in pointer-events-none",children:[e.jsx("img",{src:sr(T),className:"w-full h-full object-cover",alt:"Preview",onError:P=>{P.currentTarget.style.display="none"}}),e.jsx("div",{className:"absolute inset-0 bg-[linear-gradient(rgba(18,16,16,0)_50%,rgba(0,0,0,0.1)_50%),linear-gradient(90deg,rgba(255,0,0,0.03),rgba(0,255,0,0.01),rgba(0,0,255,0.03))] bg-[length:100%_4px,4px_100%] pointer-events-none"}),e.jsx("div",{className:"absolute bottom-0 left-0 right-0 p-3 bg-black/60 text-cyan-300 font-bold uppercase text-[9px] tracking-widest border-t border-white/5",children:(N=Le.get(T))==null?void 0:N.name})]}),e.jsxs("div",{className:"p-1 max-h-[400px] overflow-y-auto custom-scroll",children:[e.jsxs("button",{onClick:()=>{var P;return(P=f.current)==null?void 0:P.click()},className:"w-full flex items-center gap-2 px-3 py-2 text-left text-gray-300 hover:bg-white/10 hover:text-white rounded transition-colors mb-1 border-b border-white/10",children:[e.jsx(mo,{})," ",e.jsx("span",{className:"font-bold uppercase tracking-wider text-[10px]",children:"Load From File..."})]}),e.jsx("input",{type:"file",ref:f,className:"hidden",accept:".json,.png",onChange:R}),e.jsx("div",{className:"px-3 py-1.5 text-[9px] font-black text-gray-500 uppercase tracking-widest bg-white/5 mb-1",children:"Select Engine"}),E.map(P=>e.jsxs("button",{onClick:()=>_(P.id),onMouseEnter:()=>L(P.id),className:`w-full text-left px-3 py-2.5 transition-all flex gap-3 border-b border-white/5 last:border-b-0 ${P.id===u?"bg-cyan-900/30":"hover:bg-white/5"}`,children:[e.jsxs("div",{className:"w-16 h-10 shrink-0 bg-black rounded border border-white/10 overflow-hidden relative",children:[P.id!=="Modular"?e.jsx("img",{src:sr(P.id),alt:P.name,className:"w-full h-full object-cover",onError:$=>{$.currentTarget.style.display="none",$.currentTarget.nextElementSibling&&($.currentTarget.nextElementSibling.style.display="flex")}}):null,e.jsx("div",{className:`w-full h-full items-center justify-center text-gray-700 bg-gray-900 ${P.id!=="Modular"?"hidden":"flex"}`,children:P.id==="Modular"?e.jsx(Pn,{}):e.jsx(la,{})})]}),e.jsx("div",{className:"flex flex-col min-w-0",children:e.jsx("span",{className:`text-[11px] font-bold tracking-tight mb-0.5 ${P.id===u?"text-cyan-400":"text-gray-200"}`,children:P.name})})]},P.id))]})]})]})})]}):null},Sd=(a,t)=>{const o=Y,r=xe;v.useEffect(()=>{const n=i=>{const s=i.target,l=s.tagName==="INPUT"&&s.type==="range";if(s.tagName==="INPUT"&&!l||s.tagName==="TEXTAREA"||s.isContentEditable)return;const c=i.ctrlKey||i.metaKey,f=i.shiftKey;if(c&&!i.altKey){const u=o.getState().isTimelineHovered;if(i.code==="KeyZ"&&f){i.preventDefault(),i.stopPropagation(),o.getState().undoCamera();return}if(i.code==="KeyY"&&f){i.preventDefault(),i.stopPropagation(),o.getState().redoCamera();return}if(i.code==="KeyZ"&&!f){i.preventDefault(),i.stopPropagation(),u&&r.getState().undo()||o.getState().undoParam();return}if(i.code==="KeyY"&&!f){i.preventDefault(),i.stopPropagation(),u&&r.getState().redo()||o.getState().redoParam();return}}switch(i.code){case"Tab":i.preventDefault(),o.getState().setCameraMode(o.getState().cameraMode==="Fly"?"Orbit":"Fly");break;case"KeyT":c||t(m=>!m);break;case"Escape":o.getState().isBroadcastMode&&o.getState().setIsBroadcastMode(!1),o.getState().interactionMode!=="none"&&o.getState().setInteractionMode("none"),r.getState().deselectAll();break;case"KeyH":o.getState().setShowHints(!o.getState().showHints);break;case"Backquote":o.getState().setAdvancedMode(!o.getState().advancedMode);break;case"KeyB":if(!c){const m=o.getState();m.setIsBroadcastMode(!m.isBroadcastMode)}break;case"Space":const{cameraMode:u,isTimelineHovered:p}=o.getState(),{sequence:h,isPlaying:g}=r.getState();let M=!1;if(a)M=u!=="Fly"||p;else{const m=Object.keys(h.tracks).length>0;u!=="Fly"&&m&&(M=!0)}M&&(i.preventDefault(),g?r.getState().pause():r.getState().play());break}};return window.addEventListener("keydown",n,{capture:!0}),()=>window.removeEventListener("keydown",n,{capture:!0})},[a,t])},lr=({onUpdate:a,autoUpdate:t,trigger:o,source:r})=>{const n=v.useRef(null),i=v.useRef(o);return v.useEffect(()=>{const s=new bt,l=new Pt(-1,1,1,-1,0,1),d=new ft(128,128,{minFilter:ct,magFilter:ct,format:at,type:Wt}),c=new Float32Array(128*128*4);let f;r==="geometry"?f=B.histogramMaterial:f=new Nt({uniforms:{tMap:{value:null}},vertexShader:`
                    out vec2 vUv;
                    void main() { 
                        vUv = uv; 
                        gl_Position = vec4(position, 1.0); 
                    }
                `,fragmentShader:`
                    precision highp float;
                    uniform sampler2D tMap;
                    in vec2 vUv;
                    layout(location = 0) out vec4 pc_fragColor;
                    void main() {
                        vec4 c = texture(tMap, vUv);
                        float l = dot(c.rgb, vec3(0.2126, 0.7152, 0.0722));
                        pc_fragColor = vec4(l, 0.0, 0.0, 1.0);
                    }
                `,glslVersion:Jt,depthTest:!1,depthWrite:!1});const u=new jt(new Tt(2,2),f);return u.frustumCulled=!1,s.add(u),n.current={scene:s,camera:l,renderTarget:d,pixelBuffer:c,material:f,mesh:u,scratchMatrix:new We,camRight:new ie,camUp:new ie,camForward:new ie},()=>{d.dispose(),r!=="geometry"&&f.dispose()}},[r]),v.useEffect(()=>{let s=0,l=0;const d=()=>{if(!n.current||!B.renderer){s=requestAnimationFrame(d);return}const c=n.current,f=o!==i.current;if(f&&(i.current=o),l++,t&&l%60===0||f){const p=B.renderer,h=B.activeCamera;if(r==="geometry"&&h){const M=B.histogramUniforms;B.virtualSpace.updateShaderUniforms(h.position,M[ce.SceneOffsetHigh].value,M[ce.SceneOffsetLow].value),M[ce.CameraPosition].value.set(0,0,0),M[ce.Resolution].value.set(128,128),c.scratchMatrix.makeRotationFromQuaternion(h.quaternion);const m=c.scratchMatrix.elements;c.camRight.set(m[0],m[1],m[2]),c.camUp.set(m[4],m[5],m[6]),c.camForward.set(-m[8],-m[9],-m[10]);const y=Math.tan(Ze.degToRad(h.fov)*.5);c.camRight.multiplyScalar(y*h.aspect),c.camUp.multiplyScalar(y),M[ce.CamBasisX].value.copy(c.camRight),M[ce.CamBasisY].value.copy(c.camUp),M[ce.CamForward].value.copy(c.camForward)}else{const M=B.pipeline.getOutputTexture();M&&(c.material.uniforms.tMap.value=M)}const g=p.getRenderTarget();p.setRenderTarget(c.renderTarget),p.clear(),p.render(c.scene,c.camera),p.readRenderTargetPixels(c.renderTarget,0,0,128,128,c.pixelBuffer),p.setRenderTarget(g),a(new Float32Array(c.pixelBuffer))}s=requestAnimationFrame(d)};return d(),()=>cancelAnimationFrame(s)},[t,o,r,a]),null},Md=({state:a,actions:t,isMobile:o,hudRefs:r})=>{var u;const n=v.useRef(null),i=v.useRef(null),s=a.tabSwitchCount,l=t.incrementTabSwitchCount;v.useEffect(()=>{const p=xe.subscribe(h=>h.isCameraInteracting,h=>{r.container.current&&(h?(r.container.current.style.opacity="1",i.current&&(clearTimeout(i.current),i.current=null)):(i.current&&clearTimeout(i.current),i.current=window.setTimeout(()=>{r.container.current&&(r.container.current.style.opacity="0")},2e3)))});return()=>{p(),i.current&&clearTimeout(i.current)}},[]),v.useEffect(()=>Y.subscribe(h=>h.cameraMode,()=>l()),[l]);const d=p=>{if(!n.current||a.cameraMode==="Orbit")return;const h=n.current.getBoundingClientRect(),g=y=>{const x=Math.max(0,Math.min(1,(y-h.left)/h.width)),C=Math.pow(10,x*3-3);t.setNavigation({flySpeed:C}),(x===0||x===1)&&navigator.vibrate&&navigator.vibrate(5)};g(p.clientX);const M=y=>g(y.clientX),m=()=>{window.removeEventListener("pointermove",M),window.removeEventListener("pointerup",m)};window.addEventListener("pointermove",M),window.addEventListener("pointerup",m)},c=((u=a.navigation)==null?void 0:u.flySpeed)??.5,f=(Math.log10(c)+3)/3;return e.jsx("div",{ref:r.container,className:"absolute inset-0 pointer-events-none z-10 transition-opacity duration-500 opacity-0",children:e.jsxs("div",{className:"absolute inset-0 flex items-center justify-center",children:[e.jsx("div",{className:"absolute pointer-events-none opacity-20",children:a.cameraMode==="Fly"?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-[40px] h-[1px] bg-cyan-400"}),e.jsx("div",{className:"absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-[1px] h-[40px] bg-cyan-400"})]}):e.jsxs("div",{className:"relative flex items-center justify-center",children:[e.jsx("div",{className:"absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-[20px] h-[1px] bg-cyan-400"}),e.jsx("div",{className:"absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-[1px] h-[20px] bg-cyan-400"}),e.jsx("div",{className:"absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-[24px] h-[24px] rounded-full border border-cyan-400 opacity-60"})]})}),e.jsxs("div",{ref:r.reticle,className:"absolute w-8 h-8 pointer-events-none opacity-0 transition-opacity duration-150 ease-out will-change-transform",children:[e.jsx("div",{className:"absolute inset-0 border-2 border-cyan-400 rounded-full shadow-[0_0_15px_cyan] opacity-80"}),e.jsx("div",{className:"absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-1 h-1 bg-white rounded-full"})]}),e.jsxs("div",{className:"absolute left-1/2 -translate-x-1/2 flex flex-col items-center pointer-events-none transition-all duration-300 ease-out",style:{bottom:a.showHints&&!o?"4rem":"3.5rem"},children:[e.jsx("button",{ref:r.reset,onClick:()=>{t.resetCamera(),navigator.vibrate&&navigator.vibrate(30)},className:"pointer-events-auto px-4 py-1.5 bg-black/60 hover:bg-cyan-900/80 text-cyan-400 hover:text-white text-[9px] font-black uppercase tracking-widest rounded-t-lg border-x border-t border-white/10 backdrop-blur-md hidden animate-fade-in shadow-xl mb-[-1px]",children:"Reset Camera"}),e.jsxs("div",{className:"flex items-stretch gap-px bg-black/40 rounded-full border border-white/10 backdrop-blur-md overflow-hidden pointer-events-auto shadow-2xl",children:[a.cameraMode==="Fly"&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{ref:n,onPointerDown:d,className:"relative flex items-center px-6 py-3 cursor-ew-resize group min-w-[120px]",children:[e.jsx("div",{className:"absolute inset-0 bg-cyan-500/10 border-r border-cyan-500/20 transition-all duration-300 ease-out",style:{width:`${f*100}%`}}),e.jsxs("span",{ref:r.speed,className:"relative z-10 font-bold text-cyan-300 font-mono text-[10px] tracking-widest uppercase group-hover:text-white transition-colors",children:["SPD x",c.toFixed(3)]})]}),e.jsx("div",{className:"w-px bg-white/5"})]}),e.jsx("div",{className:"px-6 py-3 bg-white/5 flex items-center min-w-[100px] justify-center",children:e.jsx("span",{ref:r.dist,className:"text-cyan-500/80 font-mono text-[10px] tracking-widest uppercase",children:"DST ---"})})]}),a.showHints&&!o&&e.jsxs("div",{className:"mt-3 text-[9px] font-medium text-white/40 tracking-widest uppercase text-center animate-fade-in text-shadow-sm whitespace-nowrap",children:[e.jsxs("span",{className:"text-cyan-400/60 font-bold mr-2",children:["[",a.cameraMode.toUpperCase(),"]"]}),a.cameraMode==="Fly"?"WASD Move  Space/C Vert  Shift Boost":"L-Drag Rotate  R-Drag Pan  Scroll Zoom"]}),s<2&&!o&&a.showHints&&e.jsxs("div",{className:"mt-2 text-[10px] font-bold text-cyan-300 animate-pulse bg-cyan-950/40 px-3 py-1 rounded border border-cyan-500/30 shadow-lg tracking-wider",children:["PRESS ",e.jsx("span",{className:"text-white border border-white/20 rounded px-1 bg-white/10 mx-0.5",children:"TAB"})," FOR ",a.cameraMode==="Orbit"?"FLY":"ORBIT"," NAVIGATION"]})]})]})})},cr={current:new Set},dr=new ie,ur=new We,fr=new qt,Sa={current:new ie(-1e3,-1e3,-1e3)},no={current:-1},Et={current:{}},Cd=a=>{var z,E,N;const t=xe.getState(),o=Y.getState(),n=Object.keys(t.sequence.tracks).length>0,i=o.animations.length>0,s=((E=(z=o.modulation)==null?void 0:z.rules)==null?void 0:E.length)>0,l=((N=o.audio)==null?void 0:N.isEnabled)??!1;if(!n&&!i&&!s&&!l)return;Ke.tick(a);const d=o.modulation,c=o.audio;c&&c.isEnabled&&et.update(),mt.resetOffsets(),B.modulations={};const f=o.animations;mt.updateOscillators(f,performance.now()/1e3,a),d&&d.rules&&mt.update(d.rules,a);const u=mt.offsets,p={},h=new Set(Object.keys(u)),g=cr.current,M=new Set;h.forEach(P=>M.add(P)),g.forEach(P=>M.add(P));let m=0,y=0,x=0,C=!1,k=0,S=0,b=0,w=!1;const j=Math.floor(t.currentFrame),T=xe.getState().isRecordingModulation,L=T&&j>no.current;L&&(no.current=j);const _=[];if(T&&M.size>0&&Ke.setOverriddenTracks(M),M.forEach(P=>{var A,F,I;const $=!h.has(P),O=$?0:u[P]??0;Math.abs(O)>1e-4&&(w=!0);let X=0,W="",H=!1;if(P.includes(".")){const[D,G]=P.split("."),q=ve.get(D),Q=o[D];if(q&&Q){const J=q.params[G];J&&(typeof Q[G]=="number"&&(X=Q[G]),J.uniform&&(W=J.uniform),J.noReset&&(H=!0))}}else P==="iterations"?(W="uIterations",X=((A=o.coreMath)==null?void 0:A.iterations)??0):P.startsWith("param")&&(W="u"+P.charAt(0).toUpperCase()+P.slice(1),X=((F=o.coreMath)==null?void 0:F[P])??0);if(L&&Math.abs(O)>1e-6){let D=X;const G=t.recordingSnapshot;if(G&&G.tracks[P]){const q=G.tracks[P],Q=P.includes("rotation");D=Qe(q.keyframes,t.currentFrame,Q)}else Et.current[P]===void 0&&(Et.current[P]=X),D=Et.current[P];_.push({trackId:P,value:D+O}),X=D}if(P.startsWith("coloring.")){if(P==="coloring.repeats"){const D=o.coloring;if(D&&Math.abs(D.repeats)>.001){const G=L?X:D.repeats,q=D.scale/G,Q=(G+O)*q;$||(p[P]=G+O),B.setUniform("uColorScale",Q)}return}if(P==="coloring.phase"){const D=o.coloring,G=L?X:D.phase;$||(p[P]=G+O),B.setUniform("uColorOffset",D.offset+O);return}if(P==="coloring.repeats2"){const D=o.coloring;if(D&&Math.abs(D.repeats2)>.001){const G=L?X:D.repeats2,q=D.scale2/G,Q=(G+O)*q;$||(p[P]=G+O),B.setUniform("uColorScale2",Q)}return}if(P==="coloring.phase2"){const D=o.coloring,G=L?X:D.phase2;$||(p[P]=G+O),B.setUniform("uColorOffset2",D.offset2+O);return}}if(P.startsWith("julia.")||P.startsWith("geometry.julia")){const D=o.geometry,G=(D==null?void 0:D.juliaX)??0,q=(D==null?void 0:D.juliaY)??0,Q=(D==null?void 0:D.juliaZ)??0;P.endsWith("juliaX")||P.endsWith("x")?(m=G+O,p[P]=m,L&&_.push({trackId:"geometry.juliaX",value:m})):P.endsWith("juliaY")||P.endsWith("y")?(y=q+O,p[P]=y,L&&_.push({trackId:"geometry.juliaY",value:y})):(P.endsWith("juliaZ")||P.endsWith("z"))&&(x=Q+O,p[P]=x,L&&_.push({trackId:"geometry.juliaZ",value:x})),C=!0;return}if(P.startsWith("camera.")){P.startsWith("camera.unified")?P.endsWith("x")?B.modulations["camera.unified.x"]=O:P.endsWith("y")?B.modulations["camera.unified.y"]=O:P.endsWith("z")&&(B.modulations["camera.unified.z"]=O):P.startsWith("camera.rotation")&&(P.endsWith("x")?B.modulations["camera.rotation.x"]=O:P.endsWith("y")?B.modulations["camera.rotation.y"]=O:P.endsWith("z")&&(B.modulations["camera.rotation.z"]=O)),p[P]=O;return}if(P.startsWith("geometry.preRot")){P.endsWith("X")?(k=O,p[P]=O):P.endsWith("Y")?(S=O,p[P]=O):P.endsWith("Z")&&(b=O,p[P]=O);return}if(P.startsWith("lighting.light")){const D=P.match(/lighting\.light(\d+)_(\w+)/);if(D){const G=parseInt(D[1]),q=D[2],Q=(I=o.lighting)==null?void 0:I.lights;if(Q&&Q[G]){const J=Q[G];let re=0,U=!1;if(q==="intensity"?(re=J.intensity,U=!0):q==="falloff"?(re=J.falloff,U=!0):q==="posX"?(re=J.position.x,U=!0):q==="posY"?(re=J.position.y,U=!0):q==="posZ"&&(re=J.position.z,U=!0),U){if(L){let V=re;t.recordingSnapshot&&t.recordingSnapshot.tracks[P]?V=Qe(t.recordingSnapshot.tracks[P].keyframes,t.currentFrame,!1):(Et.current[P]===void 0&&(Et.current[P]=re),V=Et.current[P]),_.push({trackId:P,value:V+O}),p[P]=V+O}else p[P]=re+O;B.modulations[P]=O}}}return}if(W){const D=X+O;$||(p[P]=D),B.setUniform(W,D,H)}}),_.length>0&&t.batchAddKeyframes(j,_,"Linear"),C){const P=o.geometry;p["geometry.juliaX"]===void 0&&p["julia.x"]===void 0&&(m=(P==null?void 0:P.juliaX)??0),p["geometry.juliaY"]===void 0&&p["julia.y"]===void 0&&(y=(P==null?void 0:P.juliaY)??0),p["geometry.juliaZ"]===void 0&&p["julia.z"]===void 0&&(x=(P==null?void 0:P.juliaZ)??0),dr.set(m,y,x),B.setUniform("uJulia",dr)}const R=o.geometry;if(R&&R.preRotMaster){const P=R.preRotX+k,$=R.preRotY+S,O=R.preRotZ+b;if(Math.abs(P-Sa.current.x)>1e-6||Math.abs($-Sa.current.y)>1e-6||Math.abs(O-Sa.current.z)>1e-6){const X=new We().makeRotationX(P),W=new We().makeRotationY($),H=new We().makeRotationZ(O);ur.identity().multiply(H).multiply(X).multiply(W),fr.setFromMatrix4(ur),B.setUniform("uPreRotMatrix",fr),Sa.current.set(P,$,O),w=!0}}w&&B.resetAccumulation(),(Object.keys(p).length>0||Object.keys(o.liveModulations).length>0)&&Y.getState().setLiveModulations(p),cr.current=h},kd=()=>{const a=xe(t=>t.isRecordingModulation);return v.useEffect(()=>{a?(Et.current={},no.current=-1):Ke.setOverriddenTracks(new Set)},[a]),null},jd=a=>{const t=v.useRef(!1),o=v.useRef(new ie),r=v.useRef(new ie),n=v.useRef(!1),i=v.useRef(null),s=v.useRef({x:0,y:0}),l=xe;v.useEffect(()=>{const d=u=>{const p=Y.getState(),h=p.interactionMode;if(a.current){const g=a.current.getBoundingClientRect(),M=(u.clientX-g.left)/g.width*2-1,m=-((u.clientY-g.top)/g.height)*2+1;if(s.current={x:M,y:m},h==="picking_focus"){n.current=!0;const y=()=>{if(n.current){if(B.renderer&&B.activeCamera){const x=B.measureDistanceAtScreenPoint(s.current.x,s.current.y,B.renderer,B.activeCamera);if(x>0){Y.getState().setOptics({dofFocus:x});const{isRecording:C,isPlaying:k,addKeyframe:S,addTrack:b,currentFrame:w,sequence:j}=l.getState();if(C){const T="optics.dofFocus";j.tracks[T]||b(T,"Focus Distance"),S(T,w,x,k?"Linear":"Bezier")}}}i.current=requestAnimationFrame(y)}};i.current=requestAnimationFrame(y)}if(h==="picking_julia"){t.current=!0;const y=p.geometry;r.current.set(y.juliaX,y.juliaY,y.juliaZ);const x=B.pickWorldPosition(M,m);if(x)if(p.formula==="MandelTerrain"){const k=p.coreMath,S=Math.pow(2,k.paramB),b=k.paramE,w=k.paramF,j=x.x*(2/S)+b,T=x.z*(2/S)+w;o.current.set(j,T,0)}else p.formula==="JuliaMorph"?o.current.set(x.x,x.y,0):o.current.copy(x);else o.current.copy(r.current);const C=()=>{if(!t.current)return;const k=B.pickWorldPosition(s.current.x,s.current.y),S=Y.getState();if(k)if(S.formula==="MandelTerrain"){const b=S.coreMath,w=Math.pow(2,b.paramB),j=b.paramE,T=b.paramF,L=k.x*(2/w)+j,_=k.z*(2/w)+T;o.current.set(L,_,0)}else S.formula==="JuliaMorph"?o.current.set(k.x,k.y,0):o.current.copy(k);if(r.current.lerp(o.current,.1),r.current.distanceToSquared(o.current)>1e-8||k){S.setGeometry({juliaX:r.current.x,juliaY:r.current.y,juliaZ:r.current.z});const{isRecording:b,isPlaying:w,addKeyframe:j,addTrack:T,currentFrame:L,sequence:_}=l.getState();if(b){_.tracks["geometry.juliaX"]||T("geometry.juliaX","Julia X"),_.tracks["geometry.juliaY"]||T("geometry.juliaY","Julia Y"),_.tracks["geometry.juliaZ"]||T("geometry.juliaZ","Julia Z");const R=w?"Linear":"Bezier";j("geometry.juliaX",L,r.current.x,R),j("geometry.juliaY",L,r.current.y,R),j("geometry.juliaZ",L,r.current.z,R)}}i.current=requestAnimationFrame(C)};i.current=requestAnimationFrame(C)}}},c=u=>{if(a.current){const p=a.current.getBoundingClientRect(),h=(u.clientX-p.left)/p.width*2-1,g=-((u.clientY-p.top)/p.height)*2+1;(t.current||n.current)&&(s.current={x:h,y:g});const M=Y.getState();if(M.draggedLightIndex!==null&&!B.isGizmoInteracting){const m=B.activeCamera;if(m){const y=new Ea;y.setFromCamera(new Se(h,g),m);const x=Math.max(2e-4,Math.min(20,B.lastMeasuredDistance*.5)),C=new ie().copy(y.ray.direction).multiplyScalar(x).add(y.ray.origin),k=B.sceneOffset,S={x:C.x+(k.x+k.xL),y:C.y+(k.y+k.yL),z:C.z+(k.z+k.zL)};M.updateLight({index:M.draggedLightIndex,params:{fixed:!1,visible:!0,castShadow:!0,position:S}}),M.lighting.shadows||M.setLighting({shadows:!0}),M.showLightGizmo||M.setShowLightGizmo(!0)}}}},f=()=>{const u=Y.getState();u.setDraggedLight(null),t.current&&(t.current=!1,i.current&&cancelAnimationFrame(i.current),u.setInteractionMode("none"),navigator.vibrate&&navigator.vibrate(20)),n.current&&(n.current=!1,i.current&&cancelAnimationFrame(i.current),u.setInteractionMode("none"),navigator.vibrate&&navigator.vibrate(20))};return window.addEventListener("pointerdown",d),window.addEventListener("pointermove",c),window.addEventListener("pointerup",f),()=>{window.removeEventListener("pointerdown",d),window.removeEventListener("pointermove",c),window.removeEventListener("pointerup",f),i.current&&cancelAnimationFrame(i.current)}},[a])},Td=a=>{const{interactionMode:t,setInteractionMode:o,setRenderRegion:r,renderRegion:n}=Y(),i=t==="selecting_region",[s,l]=v.useState(null),[d,c]=v.useState(null),[f,u]=v.useState(null),p=v.useRef(null),h=v.useRef(null),g=v.useRef(null),M=(m,y)=>({x:Math.max(0,Math.min(1,(m.clientX-y.left)/y.width)),y:Math.max(0,Math.min(1,(m.clientY-y.top)/y.height))});return v.useEffect(()=>{if(!a.current)return;const m=a.current,y=k=>{const S=k.target,b=m.getBoundingClientRect(),w=M(k,b);if(n&&!i){const j=S.dataset.handle;if(j||S.closest(".region-box")){k.stopPropagation(),p.current=j||"move",l({x:w.x,y:w.y}),h.current={...n},u({...n}),g.current={...n};return}}if(i){k.stopPropagation(),p.current="draw";const j=k.clientX-b.left,T=k.clientY-b.top;l({x:j,y:T}),c({x:j,y:T})}},x=k=>{if(!p.current)return;k.stopPropagation(),k.preventDefault();const S=m.getBoundingClientRect();if(p.current==="draw"){const b=Math.max(0,Math.min(S.width,k.clientX-S.left)),w=Math.max(0,Math.min(S.height,k.clientY-S.top));c({x:b,y:w})}else if(h.current&&s){const b=M(k,S),w=b.x-s.x,j=1-b.y-(1-s.y);let T={...h.current};const L=p.current;if(L==="move"){const R=T.maxX-T.minX,z=T.maxY-T.minY;T.minX+=w,T.maxX+=w,T.minY+=j,T.maxY+=j,T.minX<0&&(T.minX=0,T.maxX=R),T.maxX>1&&(T.maxX=1,T.minX=1-R),T.minY<0&&(T.minY=0,T.maxY=z),T.maxY>1&&(T.maxY=1,T.minY=1-z)}else L!=null&&L.includes("e")&&(T.maxX=Math.min(1,h.current.maxX+w)),L!=null&&L.includes("w")&&(T.minX=Math.max(0,h.current.minX+w)),L!=null&&L.includes("n")&&(T.maxY=Math.min(1,h.current.maxY+j)),L!=null&&L.includes("s")&&(T.minY=Math.max(0,h.current.minY+j));const _={minX:Math.min(T.minX,T.maxX),maxX:Math.max(T.minX,T.maxX),minY:Math.min(T.minY,T.maxY),maxY:Math.max(T.minY,T.maxY)};_.maxX-_.minX<.01&&(_.maxX=_.minX+.01),_.maxY-_.minY<.01&&(_.maxY=_.minY+.01),u(_),g.current=_}},C=k=>{if(p.current){if(k.stopPropagation(),p.current==="draw"&&s&&d){const S=m.getBoundingClientRect(),b=Math.min(s.x,d.x),w=Math.max(s.x,d.x),j=Math.min(s.y,d.y),T=Math.max(s.y,d.y),L=w-b,_=T-j;if(L>10&&_>10){const R=b/S.width,z=w/S.width,E=1-T/S.height,N=1-j/S.height;r({minX:R,minY:E,maxX:z,maxY:N})}o("none")}else g.current&&r(g.current);p.current=null,l(null),c(null),h.current=null,u(null),g.current=null}};return m.addEventListener("mousedown",y),window.addEventListener("mousemove",x),window.addEventListener("mouseup",C),()=>{m.removeEventListener("mousedown",y),window.removeEventListener("mousemove",x),window.removeEventListener("mouseup",C)}},[i,n,s,d,o,r,a]),{visualRegion:f,isGhostDragging:!!f,renderRegion:n,isSelectingRegion:i}},Te={lowFpsBuffer:0,lastTime:performance.now(),lastFrameCount:0,setShowWarning:null,setCurrentFps:null,isPaused:!1,isScrubbing:!1,isExporting:!1,isBroadcastMode:!1,renderMode:"PathTracing",frameTimestamps:[]},Pd=()=>{const a=performance.now();Te.frameTimestamps.push(a);const t=a-2e3;if(Te.frameTimestamps=Te.frameTimestamps.filter(r=>r>t),a-Te.lastTime>=500){let r=0;if(Te.frameTimestamps.length>1){const l=Te.frameTimestamps[0],c=Te.frameTimestamps[Te.frameTimestamps.length-1]-l;r=(Te.frameTimestamps.length-1)/c*1e3}Te.lastTime=a,Te.lastFrameCount=B.pipeline?B.pipeline.frameCount:0;const n=Y.getState(),i=n.sampleCap>0&&B.pipeline&&B.pipeline.accumulationCount>=n.sampleCap;if(Te.isPaused||Te.isScrubbing||document.hidden||B.isCompiling||Te.isExporting||i)Te.lowFpsBuffer=0;else if(a<8e3)Te.lowFpsBuffer=0;else{Te.setCurrentFps&&Te.setCurrentFps(r);const l=Te.renderMode==="PathTracing",d=l?10:15,c=l?22:30;r<d?Te.lowFpsBuffer+=r<5?2:1:r>=c&&(Te.lowFpsBuffer=Math.max(0,Te.lowFpsBuffer-3),Te.lowFpsBuffer===0&&Te.setShowWarning&&Te.setShowWarning(!1)),Te.lowFpsBuffer>=5&&Te.setShowWarning&&Te.setShowWarning(!0)}}},Rd=()=>{const a=v.useRef(0);v.useRef(performance.now()),v.useRef(0);const{resolutionMode:t,setResolutionMode:o,setFixedResolution:r,fixedResolution:n,isExporting:i,isBroadcastMode:s,openContextMenu:l,aaLevel:d,setAALevel:c,renderMode:f,quality:u}=Y(),p=Y(E=>E.isPaused),h=xe(E=>E.isScrubbing),[g,M]=v.useState(!1),[m,y]=v.useState(60);v.useEffect(()=>(Te.setShowWarning=M,Te.setCurrentFps=y,Te.isPaused=p,Te.isScrubbing=h,Te.isExporting=i,Te.isBroadcastMode=s,Te.renderMode=f,Te.lastTime=performance.now(),Te.lastFrameCount=B.pipeline?B.pipeline.frameCount:0,()=>{Te.setShowWarning===M&&(Te.setShowWarning=null),Te.setCurrentFps===y&&(Te.setCurrentFps=null)}),[p,h,i,s,f]);const x=E=>{const N=Oe(E.currentTarget);N.length>0&&(E.preventDefault(),E.stopPropagation(),l(E.clientX,E.clientY,[],N))};if(s||!g)return null;let C=window.innerWidth,k=window.innerHeight;if(B.renderer){const E=B.renderer.domElement;C=E.width,k=E.height}else t==="Fixed"&&(C=n[0],k=n[1]);const S=C>480,b=()=>{const E=Math.max(320,Math.round(C*.66/8)*8),N=Math.max(240,Math.round(k*.66/8)*8);o("Fixed"),r(E,N),z()},w=d>1,j=()=>{c(1),z()},T=u,_=!((T==null?void 0:T.precisionMode)===1),R=()=>{const E=Y.getState().setQuality,N=Y.getState().setLighting;E&&E({precisionMode:1,bufferPrecision:1}),N&&N({shadows:!1}),z()},z=()=>{M(!1),a.current=-10};return e.jsx("div",{className:"absolute top-2 right-4 z-[50] pointer-events-auto animate-fade-in-left origin-top-right max-w-[200px]","data-help-id":"ui.performance",onContextMenu:x,children:e.jsxs("div",{className:"flex flex-col gap-1 bg-red-950/90 border border-red-500/30 rounded-lg shadow-xl backdrop-blur-md p-2",children:[e.jsxs("div",{className:"flex items-center justify-between mb-1",children:[e.jsxs("div",{className:"flex items-center gap-2 text-red-200 text-[10px] font-bold uppercase tracking-wider",children:[e.jsx(Zt,{}),e.jsxs("span",{children:["Low FPS (",m.toFixed(1),")"]})]}),e.jsx("button",{onClick:()=>{M(!1),a.current=-40},className:"text-red-400 hover:text-white transition-colors p-0.5",title:"Dismiss",children:e.jsx(Vt,{})})]}),e.jsxs("div",{className:"flex flex-col gap-1",children:[w&&e.jsxs("button",{onClick:j,className:"flex items-center justify-between bg-black/40 hover:bg-white/10 text-gray-300 text-[9px] px-2 py-1.5 rounded transition-colors border border-white/5",children:[e.jsxs("span",{className:"flex items-center gap-1.5",children:[e.jsx(go,{})," Reset Scale (1x)"]}),e.jsx("span",{className:"text-cyan-400 font-bold",children:"Fix"})]}),_&&e.jsxs("button",{onClick:R,className:"flex items-center justify-between bg-black/40 hover:bg-white/10 text-gray-300 text-[9px] px-2 py-1.5 rounded transition-colors border border-white/5",children:[e.jsxs("span",{className:"flex items-center gap-1.5",children:[e.jsx(la,{})," Enable Lite Mode"]}),e.jsx("span",{className:"text-cyan-400 font-bold",children:"Fix"})]}),S&&e.jsxs("button",{onClick:b,className:"flex items-center justify-between bg-black/40 hover:bg-white/10 text-gray-300 text-[9px] px-2 py-1.5 rounded transition-colors border border-white/5",children:[e.jsxs("span",{className:"flex items-center gap-1.5",children:[e.jsx(xt,{})," Reduce Resolution"]}),e.jsx("span",{className:"text-cyan-400 font-bold",children:"-33%"})]})]})]})})},zd=[{label:"Maximum",ratio:"Max"},{label:"Square (1:1)",ratio:1},{label:"Landscape (16:9)",ratio:1.7777},{label:"Portrait (4:5)",ratio:.8},{label:"Social (9:16)",ratio:.5625},{label:"Cinematic (2.35:1)",ratio:2.35},{label:"Classic (4:3)",ratio:1.3333},{label:"Skybox (2:1)",ratio:2}],Fd=({width:a,height:t,top:o,left:r,maxAvailableWidth:n,maxAvailableHeight:i,onSetResolution:s,onSetMode:l})=>{const[d,c]=v.useState(!1),f=v.useRef(null),u=v.useRef(null),p=Y(x=>x.openContextMenu);v.useEffect(()=>{if(!d)return;const x=C=>{f.current&&!f.current.contains(C.target)&&c(!1)};return window.addEventListener("mousedown",x),()=>window.removeEventListener("mousedown",x)},[d]);const h=x=>{const C=Oe(x.currentTarget);C.length>0&&(x.preventDefault(),x.stopPropagation(),p(x.clientX,x.clientY,[],C))},g=x=>{x.preventDefault(),x.stopPropagation(),x.target.setPointerCapture(x.pointerId),u.current={startX:x.clientX,startY:x.clientY,startW:a,startH:t,hasMoved:!1}},M=x=>{if(!u.current)return;const C=u.current.startX-x.clientX,k=u.current.startY-x.clientY;(Math.abs(C)>3||Math.abs(k)>3)&&(u.current.hasMoved=!0);const S=Math.round(k/4),b=Math.round(C/20),j=(S+b)*8;if(j!==0){const T=u.current.startW/u.current.startH,L=Math.max(64,u.current.startW+j),_=Math.round(L/8)*8,R=_/T,z=Math.max(64,Math.round(R/8)*8);s(_,z)}},m=x=>{x.target.releasePointerCapture(x.pointerId),u.current&&!u.current.hasMoved&&c(C=>!C),u.current=null},y=x=>{const k=Math.max(100,n-40),S=Math.max(100,i-40);let b,w;x==="Max"?(b=k,w=S):k/S>x?(w=S,b=w*x):(b=k,w=b/x);const j=Math.round(b/8)*8,T=Math.round(w/8)*8;s(j,T),c(!1)};return e.jsxs("div",{className:"absolute flex items-center gap-2 z-50 transition-all duration-100 ease-out",style:{top:o,left:r},"data-help-id":"ui.resolution",onContextMenu:h,children:[e.jsxs("div",{className:"relative text-[10px] font-mono text-gray-400 bg-black/80 px-2 py-1 rounded border border-white/10 shadow-sm backdrop-blur-md cursor-ns-resize hover:text-white hover:border-cyan-500/50 transition-colors select-none flex items-center gap-2",onPointerDown:g,onPointerMove:M,onPointerUp:m,title:"Drag Up or Left to Increase Size",children:[e.jsxs("span",{children:[a," ",e.jsx("span",{className:"text-gray-600",children:"x"})," ",t]}),e.jsx("span",{className:"opacity-50",children:e.jsx(Rt,{})})]}),d&&e.jsxs("div",{ref:f,className:"absolute top-8 left-0 w-32 bg-black border border-white/20 rounded shadow-xl z-50 overflow-hidden flex flex-col py-1 animate-fade-in",children:[e.jsx("div",{className:"px-3 py-1 text-[8px] font-bold text-gray-500 uppercase tracking-wider border-b border-white/10 mb-1",children:"Fit to Window"}),zd.map(x=>e.jsx("button",{onClick:()=>y(x.ratio),className:"text-left px-3 py-1.5 text-[10px] text-gray-300 hover:bg-white/10 hover:text-white transition-colors flex justify-between",children:e.jsx("span",{children:x.label})},x.label))]}),e.jsxs("button",{onClick:x=>{x.stopPropagation(),l("Full")},className:"flex items-center gap-1.5 text-[9px] font-bold text-gray-300 bg-black/80 px-2 py-1 rounded border border-white/10 hover:border-cyan-500/50 hover:text-cyan-400 hover:bg-cyan-900/30 transition-all shadow-sm backdrop-blur-md uppercase tracking-wide group",title:"Return to Fullscreen Mode",children:[e.jsx("span",{className:"w-2 h-2 border border-current rounded-sm group-hover:scale-110 transition-transform"}),"Fill"]})]})},Id=({width:a,height:t})=>{const o=Y(d=>d.compositionOverlay),r=Y(d=>d.compositionOverlaySettings);if(o==="none"||!o)return null;const{opacity:n,lineThickness:i,color:s}=r;let l=s;if(s.startsWith("#")){const d=ut(s);d&&(l=`rgba(${d.r},${d.g},${d.b},${n})`)}else s.startsWith("rgba")?l=s.replace(/rgba\(([^,]+),([^,]+),([^,]+),([^)]+)\)/,`rgba($1,$2,$3,${n})`):s.startsWith("rgb(")&&(l=s.replace(/rgb\(([^,]+),([^,]+),([^)]+)\)/,`rgba($1,$2,$3,${n})`));return e.jsxs("svg",{className:"absolute inset-0 pointer-events-none z-[15]",width:a,height:t,style:{mixBlendMode:"difference"},children:[o==="grid"&&e.jsx(Ed,{width:a,height:t,strokeColor:l,lineThickness:i,divisionsX:r.gridDivisionsX,divisionsY:r.gridDivisionsY}),o==="thirds"&&e.jsx(Nd,{width:a,height:t,strokeColor:l,lineThickness:i}),o==="golden"&&e.jsx(Hn,{width:a,height:t,strokeColor:l,lineThickness:i}),o==="spiral"&&e.jsx(Dd,{width:a,height:t,strokeColor:l,lineThickness:i,rotation:r.spiralRotation,positionX:r.spiralPositionX,positionY:r.spiralPositionY,scale:r.spiralScale,ratio:r.spiralRatio}),o==="center"&&e.jsx(pr,{width:a,height:t,strokeColor:l,lineThickness:i}),o==="diagonal"&&e.jsx(Ld,{width:a,height:t,strokeColor:l,lineThickness:i}),o==="safearea"&&e.jsx(hr,{width:a,height:t,strokeColor:l,lineThickness:i}),r.showCenterMark&&o!=="center"&&e.jsx(pr,{width:a,height:t,strokeColor:l,lineThickness:i}),r.showSafeAreas&&o!=="safearea"&&e.jsx(hr,{width:a,height:t,strokeColor:l,lineThickness:i*.5})]})},Ed=({width:a,height:t,strokeColor:o,lineThickness:r,divisionsX:n=4,divisionsY:i=4})=>{const s=[];for(let l=1;l<n;l++){const d=a/n*l;s.push(e.jsx("line",{x1:d,y1:0,x2:d,y2:t,stroke:o,strokeWidth:r*.5},`v${l}`))}for(let l=1;l<i;l++){const d=t/i*l;s.push(e.jsx("line",{x1:0,y1:d,x2:a,y2:d,stroke:o,strokeWidth:r*.5},`h${l}`))}return e.jsx(e.Fragment,{children:s})},Nd=({width:a,height:t,strokeColor:o,lineThickness:r})=>{const n=a/3,i=t/3;return e.jsxs(e.Fragment,{children:[e.jsx("line",{x1:n,y1:0,x2:n,y2:t,stroke:o,strokeWidth:r}),e.jsx("line",{x1:n*2,y1:0,x2:n*2,y2:t,stroke:o,strokeWidth:r}),e.jsx("line",{x1:0,y1:i,x2:a,y2:i,stroke:o,strokeWidth:r}),e.jsx("line",{x1:0,y1:i*2,x2:a,y2:i*2,stroke:o,strokeWidth:r}),e.jsx("circle",{cx:n,cy:i,r:r*3,fill:o}),e.jsx("circle",{cx:n*2,cy:i,r:r*3,fill:o}),e.jsx("circle",{cx:n,cy:i*2,r:r*3,fill:o}),e.jsx("circle",{cx:n*2,cy:i*2,r:r*3,fill:o})]})},Hn=({width:a,height:t,strokeColor:o,lineThickness:r})=>{const n=1.618033988749895,i=a/n,s=t/n;return e.jsxs(e.Fragment,{children:[e.jsx("line",{x1:i,y1:0,x2:i,y2:t,stroke:o,strokeWidth:r}),e.jsx("line",{x1:a-i,y1:0,x2:a-i,y2:t,stroke:o,strokeWidth:r}),e.jsx("line",{x1:0,y1:s,x2:a,y2:s,stroke:o,strokeWidth:r}),e.jsx("line",{x1:0,y1:t-s,x2:a,y2:t-s,stroke:o,strokeWidth:r}),e.jsx("circle",{cx:i,cy:s,r:r*3,fill:o}),e.jsx("circle",{cx:a-i,cy:s,r:r*3,fill:o}),e.jsx("circle",{cx:i,cy:t-s,r:r*3,fill:o}),e.jsx("circle",{cx:a-i,cy:t-s,r:r*3,fill:o})]})},Dd=({width:a,height:t,strokeColor:o,lineThickness:r,rotation:n=0,positionX:i=.5,positionY:s=.5,scale:l=1,ratio:d=1.618033988749895})=>{const c=Math.min(a,t),f=a*i,u=t*s,p=c*.45*l,h=n*Math.PI/180,g=[],M=3,m=100;for(let y=0;y<=m;y++){const x=y/m*M*2*Math.PI,C=p*Math.pow(d,-x/(2*Math.PI)),k=f+C*Math.cos(x+h),S=u+C*Math.sin(x+h);g.push(`${y===0?"M":"L"} ${k} ${S}`)}return e.jsxs(e.Fragment,{children:[e.jsx("path",{d:g.join(" "),fill:"none",stroke:o,strokeWidth:r*1.5,strokeLinecap:"round"}),e.jsx(Hn,{width:a,height:t,strokeColor:o.replace(/[\d.]+\)$/,"0.2)"),lineThickness:r*.5})]})},pr=({width:a,height:t,strokeColor:o,lineThickness:r})=>{const n=a/2,i=t/2,s=Math.min(a,t)*.05;return e.jsxs(e.Fragment,{children:[e.jsx("line",{x1:n-s,y1:i,x2:n+s,y2:i,stroke:o,strokeWidth:r}),e.jsx("line",{x1:n,y1:i-s,x2:n,y2:i+s,stroke:o,strokeWidth:r}),e.jsx("circle",{cx:n,cy:i,r:s*.3,fill:"none",stroke:o,strokeWidth:r})]})},Ld=({width:a,height:t,strokeColor:o,lineThickness:r})=>e.jsxs(e.Fragment,{children:[e.jsx("line",{x1:0,y1:0,x2:a,y2:t,stroke:o,strokeWidth:r}),e.jsx("line",{x1:a,y1:0,x2:0,y2:t,stroke:o,strokeWidth:r}),e.jsx("line",{x1:a/2,y1:0,x2:a/2,y2:t,stroke:o,strokeWidth:r*.5,strokeDasharray:"4 4"}),e.jsx("line",{x1:0,y1:t/2,x2:a,y2:t/2,stroke:o,strokeWidth:r*.5,strokeDasharray:"4 4"})]}),hr=({width:a,height:t,strokeColor:o,lineThickness:r})=>{const i=a*.05,s=t*.05,l=a*(1-.05*2),d=t*(1-.05*2),c=.1,f=a*c,u=t*c,p=a*(1-c*2),h=t*(1-c*2);return e.jsxs(e.Fragment,{children:[e.jsx("rect",{x:i,y:s,width:l,height:d,fill:"none",stroke:o,strokeWidth:r}),e.jsx("rect",{x:f,y:u,width:p,height:h,fill:"none",stroke:o,strokeWidth:r*.5,strokeDasharray:"4 4"}),[[i,s],[i+l,s],[i,s+d],[i+l,s+d]].map(([g,M],m)=>e.jsx("circle",{cx:g,cy:M,r:r*2,fill:o},m))]})},Ad=(a,t,o,r)=>{const{gl:n}=_t(),i=Y(x=>x.invertY),s=Y(x=>x.debugMobileLayout),l=v.useRef({forward:!1,backward:!1,left:!1,right:!1,up:!1,down:!1,rollLeft:!1,rollRight:!1,boost:!1}),d=v.useRef(!1),c=v.useRef({x:0,y:0}),f=v.useRef({x:0,y:0}),u=v.useRef(0),p=v.useRef(0),h=v.useRef({x:0,y:0}),g=v.useRef({x:0,y:0}),M=v.useRef(t);v.useEffect(()=>{M.current=t},[t]);const m=()=>{u.current=performance.now()};return v.useEffect(()=>{h.current={x:0,y:0},g.current={x:0,y:0},p.current=0,m()},[a]),Bt((x,C)=>{const k=l.current.rollLeft?1:l.current.rollRight?-1:0,b=1-Math.exp(-(k!==0?1:3)*C),w=Math.max(.1,M.current);p.current+=(k*w-p.current)*b,k===0&&Math.abs(p.current)<.001&&(p.current=0)}),v.useEffect(()=>{const x=j=>{if(j.target.tagName==="INPUT"||j.target.tagName==="TEXTAREA"||((j.ctrlKey||j.metaKey)&&(j.key==="w"||j.code==="KeyW")&&j.preventDefault(),j.code==="Space"&&j.preventDefault(),j.key==="Alt"&&j.preventDefault(),Y.getState().isTimelineHovered))return;let L=!0;switch(j.code){case"KeyW":l.current.forward=!0;break;case"KeyS":l.current.backward=!0;break;case"KeyA":l.current.left=!0;break;case"KeyD":l.current.right=!0;break;case"KeyQ":l.current.rollLeft=!0;break;case"KeyE":l.current.rollRight=!0;break;case"Space":l.current.up=!0;break;case"KeyC":l.current.down=!0;break;case"ShiftLeft":case"ShiftRight":l.current.boost=!0;break;default:L=!1}L&&m()},C=j=>{switch(j.key==="Alt"&&j.preventDefault(),j.code){case"KeyW":l.current.forward=!1;break;case"KeyS":l.current.backward=!1;break;case"KeyA":l.current.left=!1;break;case"KeyD":l.current.right=!1;break;case"KeyQ":l.current.rollLeft=!1;break;case"KeyE":l.current.rollRight=!1;break;case"Space":l.current.up=!1;break;case"KeyC":l.current.down=!1;break;case"ShiftLeft":case"ShiftRight":l.current.boost=!1;break}},k=j=>{const T=Y.getState();if(eo(T))return;if(T.optics&&Math.abs(T.optics.camType-1)<.1){const R=j.deltaY>0?1:-1,E=T.optics.orthoScale*(1+R*.1);T.setOptics({orthoScale:Math.max(1e-10,Math.min(1e3,E))}),m();return}if(a==="Fly"){const R=j.deltaY>0?-1:1;let z=M.current,E=.01;z<.05&&(E=.005),z>.1&&(E=.02);let N=Math.max(.001,Math.min(1,z+R*E));M.current=N,o(N),m()}else a==="Orbit"&&m()},S=()=>{l.current={forward:!1,backward:!1,left:!1,right:!1,up:!1,down:!1,rollLeft:!1,rollRight:!1,boost:!1}},b=j=>{h.current=j.detail,m()},w=j=>{g.current=j.detail,m()};return window.addEventListener("keydown",x),window.addEventListener("keyup",C),window.addEventListener("blur",S),window.addEventListener("joyMove",b),window.addEventListener("joyLook",w),n.domElement.addEventListener("wheel",k,{passive:!0}),()=>{window.removeEventListener("keydown",x),window.removeEventListener("keyup",C),window.removeEventListener("blur",S),window.removeEventListener("joyMove",b),window.removeEventListener("joyLook",w),n.domElement.removeEventListener("wheel",k)}},[a,n,o]),v.useEffect(()=>{const x=n.domElement,C=(w,j)=>{const T=x.getBoundingClientRect();return{x:(w-T.left)/T.width*2-1,y:-((j-T.top)/T.height)*2+1}},k=w=>{const j=Y.getState();if(eo(j))return;if(r){if(Object.values(r).some(_=>_.current&&_.current.contains(w.target)))return}else if(w.target.closest(".pointer-events-auto"))return;if(!((s||window.innerWidth<768||w.pointerType==="touch")&&a==="Fly")&&(m(),w.button===0&&a==="Fly")){d.current=!0;const{x:L,y:_}=C(w.clientX,w.clientY);c.current={x:L,y:_},f.current={x:L,y:_}}},S=w=>{if(d.current){const{x:j,y:T}=C(w.clientX,w.clientY);f.current={x:j,y:T},m()}else a==="Orbit"&&w.buttons>0&&m()},b=()=>d.current=!1;return x.addEventListener("mousedown",k),window.addEventListener("mousemove",S),window.addEventListener("mouseup",b),()=>{x.removeEventListener("mousedown",k),window.removeEventListener("mousemove",S),window.removeEventListener("mouseup",b)}},[a,n,s,r]),{moveState:l,isDraggingRef:d,dragStart:c,mousePos:f,speedRef:M,joystickMove:h,joystickLook:g,invertY:i,rollVelocity:p,isInteracting:()=>{const x=l.current,C=x.forward||x.backward||x.left||x.right||x.up||x.down||x.rollLeft||x.rollRight,k=Math.abs(h.current.x)>.01||Math.abs(h.current.y)>.01||Math.abs(g.current.x)>.01||Math.abs(g.current.y)>.01,S=performance.now()-u.current<200;return d.current||C||k||S}}},_d=(a,t)=>{const{camera:o}=_t(),r=Y(f=>f.quality),n=v.useRef(10),i=v.useRef(10),s=v.useRef(0);v.useRef(!1);const l=v.useRef(null),d=v.useRef(new Float32Array(4)),c=f=>{if(f<0||f>1e3||!Number.isFinite(f)){n.current>0&&n.current,a.dist.current&&(a.dist.current.innerText="DST INF",a.dist.current.style.color="#888"),a.reset.current&&(a.reset.current.style.display="block");return}if(n.current=f,i.current=f,B.lastMeasuredDistance=f,a.dist.current&&(a.dist.current.innerText=`DST ${f<.001?f.toExponential(2):f.toFixed(4)}`,a.dist.current.style.color=f<1?"#ff4444":"#00ffff"),a.reset.current){const u=f>100||f<.001;a.reset.current.style.display=u?"block":"none"}};return Bt(f=>{var m,y,x,C;if(s.current++,!B.hasCompiledShader||s.current<15){a.dist.current&&s.current%10===0&&(a.dist.current.innerText=`DST ${n.current.toFixed(4)}`),a.speed.current&&s.current%10===0&&(a.speed.current.innerText=`SPD ${(t.current*100).toFixed(1)}%`);return}if((r.physicsProbeMode??0)===2){const k=r.manualDistance;if(n.current=k,i.current=k,B.lastMeasuredDistance=k,a.dist.current&&(a.dist.current.innerText=`DST ${k<.001?k.toExponential(2):k.toFixed(4)}`,a.dist.current.style.color=k<1?"#ff4444":"#00ffff"),a.reset.current){const S=k>100||k<.001;a.reset.current.style.display=S?"block":"none"}a.speed.current&&s.current%10===0&&(a.speed.current.innerText=`SPD ${(t.current*100).toFixed(1)}%`);return}const p=B.renderer;if(!p)return;const h=(y=(m=B.pipeline).getPreviousRenderTarget)==null?void 0:y.call(m);if(!h){a.dist.current&&s.current%10===0&&(a.dist.current.innerText=`DST ${n.current.toFixed(4)}`),a.speed.current&&s.current%10===0&&(a.speed.current.innerText=`SPD ${(t.current*100).toFixed(1)}%`);return}const g=h.width||1,M=h.height||1;if(g<=0||M<=0){a.dist.current&&s.current%10===0&&(a.dist.current.innerText=`DST ${n.current.toFixed(4)}`),a.speed.current&&s.current%10===0&&(a.speed.current.innerText=`SPD ${(t.current*100).toFixed(1)}%`);return}(!l.current||l.current.length!==64)&&(l.current=new Float32Array(64));try{const k=Math.floor(g/2),S=Math.floor(M/2),w=Math.floor(3/2);let j=0,T=0;for(let L=-w;L<=w;L++){for(let _=-w;_<=w;_++){const R=k+L,z=S+_;if(R>=0&&R<g&&z>=0&&z<M&&((C=(x=B.pipeline).readPixels)==null?void 0:C.call(x,p,R,z,1,1,d.current))){const N=d.current[3];N>0&&N<1e3&&Number.isFinite(N)&&(j+=N,T++)}}if(T>0){const _=j/T;c(_)}}if(T>0){const L=j/T;if(L>=1e3){const _=n.current>0?n.current:10;a.dist.current&&(a.dist.current.innerText="DST INF",a.dist.current.style.color="#888"),a.reset.current&&(a.reset.current.style.display="block")}else c(L)}}catch(k){console.warn("Depth readback failed:",k)}a.speed.current&&s.current%10===0&&(a.speed.current.innerText=`SPD ${(t.current*100).toFixed(1)}%`)}),{distAverageRef:n,distMinRef:i}};class Bd{constructor(){Z(this,"currentRotVelocity",new ie);Z(this,"rollVelocity",0);Z(this,"smoothedDistEstimate",10);Z(this,"ROTATION_SMOOTHING",20);Z(this,"ROLL_SMOOTHING",3);Z(this,"SENSITIVITY",2.5);Z(this,"DIST_INCREASE_LERP_RATE",8)}reset(){this.currentRotVelocity.set(0,0,0),this.rollVelocity=0,this.smoothedDistEstimate=10}applyCurve(t){return Math.sign(t)*Math.pow(Math.abs(t),2)}update(t,o,r,n){let i=!1;const s=n.distEstimate,l=Math.min(o,.1);if(s>this.smoothedDistEstimate){const S=1-Math.exp(-this.DIST_INCREASE_LERP_RATE*l);this.smoothedDistEstimate+=(s-this.smoothedDistEstimate)*S}else this.smoothedDistEstimate=s;const d=this.smoothedDistEstimate,c=r.move.boost?4:1,f=n.autoSlow?Math.max(d*n.baseSpeed*c,1e-6):2*n.baseSpeed*c,u=new ie(0,0,0);if(r.move.forward&&(u.z-=1),r.move.backward&&(u.z+=1),r.move.left&&(u.x-=1),r.move.right&&(u.x+=1),r.move.up&&(u.y+=1),r.move.down&&(u.y-=1),(Math.abs(r.moveJoy.x)>.01||Math.abs(r.moveJoy.y)>.01)&&(u.z-=this.applyCurve(r.moveJoy.y),u.x+=this.applyCurve(r.moveJoy.x)),u.lengthSq()>0){u.normalize().multiplyScalar(f*l);const S=u.clone().applyQuaternion(t.quaternion);le.emit("offset_shift",{x:S.x,y:S.y,z:S.z}),i=!0}const h=r.move.rollLeft?1:r.move.rollRight?-1:0,g=h!==0?1:this.ROLL_SMOOTHING,M=1-Math.exp(-g*o),m=Math.max(.1,n.baseSpeed);this.rollVelocity+=(h*m-this.rollVelocity)*M,h===0&&Math.abs(this.rollVelocity)<.001&&(this.rollVelocity=0);const y=new ie(0,0,0),x=r.invertY?-1:1,C=Math.abs(r.look.x)>.01||Math.abs(r.look.y)>.01;r.isDragging?(y.y=-r.dragDelta.x*2,y.x=r.dragDelta.y*2*x):C&&(y.y=-this.applyCurve(r.look.x)*.66,y.x=this.applyCurve(r.look.y)*.66*x),y.z=this.rollVelocity*.62;const k=1-Math.exp(-this.ROTATION_SMOOTHING*l);if(this.currentRotVelocity.lerp(y,k),this.currentRotVelocity.lengthSq()<1e-6&&this.currentRotVelocity.set(0,0,0),this.currentRotVelocity.lengthSq()>1e-8){const S=this.currentRotVelocity;t.rotateX(S.x*l*this.SENSITIVITY),t.rotateY(S.y*l*this.SENSITIVITY),t.rotateZ(S.z*l*this.SENSITIVITY),i=!0}return i}}const Od=({mode:a,onStart:t,onEnd:o,hudRefs:r,setSceneOffset:n,fitScale:i=1})=>{const{camera:s,gl:l}=_t(),d=v.useRef(null),c=Y(eo),f=Y(oe=>oe.optics),u=f&&Math.abs(f.camType-1)<.1,p=Y(oe=>oe.navigation),h=Y(oe=>oe.setNavigation),g=xe(oe=>oe.setIsCameraInteracting),[M,m]=v.useState(new ie(0,0,0)),[y,x]=v.useState(a==="Orbit"),[C,k]=v.useState(0),S=v.useRef(new Bd),b=v.useRef(new ie),w=v.useRef(new Be),j=v.useRef(new ie),T=v.useRef(new ie);v.useRef(0);const{moveState:L,isDraggingRef:_,dragStart:R,mousePos:z,speedRef:E,joystickMove:N,joystickLook:P,invertY:$,rollVelocity:O,isInteracting:X}=Ad(a,(p==null?void 0:p.flySpeed)??.5,oe=>h({flySpeed:oe}),r),{distAverageRef:W}=_d(r,E),H=(oe,ye=!1)=>{s.updateMatrixWorld();const pe=new ie(0,1,0).applyQuaternion(s.quaternion);s.up.copy(pe);let be=oe||B.lastMeasuredDistance;(be<=1e-7||be>1e3)&&(be=Y.getState().targetDistance||3.5);const fe=new ie(0,0,-1).applyQuaternion(s.quaternion),me=new ie().copy(s.position).addScaledVector(fe,be);m(me.clone()),ye?k(ue=>ue+1):d.current&&(d.current.target.copy(me),d.current.update()),x(!0)};v.useEffect(()=>{const oe=Y.getState();s.position.set(oe.cameraPos.x,oe.cameraPos.y,oe.cameraPos.z),s.quaternion.set(oe.cameraRot.x,oe.cameraRot.y,oe.cameraRot.z,oe.cameraRot.w),s.updateMatrixWorld(),b.current.copy(s.position),w.current.copy(s.quaternion),oe.targetDistance&&(W.current=oe.targetDistance),a==="Orbit"&&H(oe.targetDistance,!0)},[]),v.useEffect(()=>{const oe=fe=>{s.position.set(fe.position.x,fe.position.y,fe.position.z),s.quaternion.set(fe.rotation.x,fe.rotation.y,fe.rotation.z,fe.rotation.w),s.updateMatrixWorld(),j.current.set(0,0,0),T.current.set(0,0,0),S.current.reset(),b.current.copy(s.position),w.current.copy(s.quaternion),fe.targetDistance&&fe.targetDistance>.001&&(W.current=fe.targetDistance,B.lastMeasuredDistance=fe.targetDistance),a==="Orbit"&&!V.current&&H(fe.targetDistance,!1)},ye=()=>{},pe=le.on("camera_teleport",oe),be=le.on("reset_accum",ye);return()=>{pe(),be()}},[a,s]);const A=xe(oe=>oe.isPlaying),F=xe(oe=>oe.isScrubbing),I=xe(oe=>oe.isRecording),D=xe(oe=>oe.recordCamera),G=xe(oe=>oe.currentFrame),q=xe(oe=>oe.sequence),Q=xe(oe=>oe.captureCameraFrame),J=v.useRef(!1),re=v.useRef(null),U=v.useRef(a),V=v.useRef(!1),te=v.useRef(!1),K=v.useRef(null),ae=v.useRef(A),se=v.useRef(F),ee=v.useRef(1),ne=v.useRef(!1),he=v.useRef(!1);v.useEffect(()=>{const oe=()=>{te.current=!0,K.current&&clearTimeout(K.current),K.current=setTimeout(()=>{te.current=!1},100)};return window.addEventListener("wheel",oe,{passive:!0}),()=>{window.removeEventListener("wheel",oe),K.current&&clearTimeout(K.current)}},[]),v.useEffect(()=>{if(a!=="Orbit")return;const oe=l.domElement,ye=be=>{if(be.target.closest(".pointer-events-auto")){he.current=!1;return}he.current=!0,d.current&&(d.current.enabled=!0)},pe=()=>{he.current=!1};return oe.addEventListener("pointerdown",ye,{capture:!0}),window.addEventListener("pointerup",pe),()=>{oe.removeEventListener("pointerdown",ye,{capture:!0}),window.removeEventListener("pointerup",pe)}},[a,l]);const de=A&&(!I||!D)&&Object.keys(q.tracks).some(oe=>oe.startsWith("camera."))||F;return ne.current=de,v.useEffect(()=>{de?x(!1):a==="Orbit"&&!y&&H(void 0,!0)},[de,a]),v.useLayoutEffect(()=>{if(U.current!==a){if(le.emit("camera_snap",void 0),a==="Fly"){le.emit("camera_absorb",{camera:s});const oe=B.sceneOffset;n({...oe}),b.current.set(0,0,0),j.current.set(0,0,0),T.current.set(0,0,0),S.current.reset(),x(!1);const ye=B.lastMeasuredDistance;ye>.001&&(W.current=ye)}else a==="Orbit"&&H(void 0,!0);U.current=a}},[a,s]),Bt((oe,ye)=>{const pe=ae.current&&!A,be=se.current&&!F;if((pe||be)&&(le.emit("camera_snap",void 0),a==="Orbit"?H(void 0,!1):a==="Fly"&&(le.emit("camera_absorb",{camera:s}),n({...B.sceneOffset}))),ae.current=A,se.current=F,de){d.current&&(d.current.enabled=!1),g&&g(!1),B.isCameraInteracting=!1;return}a==="Orbit"&&!y&&H(void 0,!0);const fe=s.position.distanceToSquared(b.current)>1e-12,me=s.quaternion.angleTo(w.current)>1e-11,ue=X()||V.current||te.current;if(g&&g(ue),B.isCameraInteracting=ue,ue&&(fe||me)&&(B.dirty=!0,!J.current&&t&&(J.current=!0,t(B.virtualSpace.getUnifiedCameraState(s,B.lastMeasuredDistance))),I&&D&&Q(G,!0,A?"Linear":"Bezier")),(fe||me||ue)&&(re.current&&clearTimeout(re.current),re.current=setTimeout(()=>{if(J.current=!1,o&&o(),Y.getState().isUserInteracting)return;let ge=B.lastMeasuredDistance;if(a==="Orbit"){const ke=s.position.length();ke>1e-4&&(ge=ke)}ge<=0&&(ge=3.5),Y.setState({cameraPos:{x:s.position.x,y:s.position.y,z:s.position.z},cameraRot:{x:s.quaternion.x,y:s.quaternion.y,z:s.quaternion.z,w:s.quaternion.w},sceneOffset:B.sceneOffset,targetDistance:ge})},100),b.current.copy(s.position),w.current.copy(s.quaternion)),a==="Fly"){if(c)return;const ge=_.current?z.current.x-R.current.x:0,ke=_.current?z.current.y-R.current.y:0;S.current.update(s,ye,{move:L.current,look:P.current,moveJoy:N.current,isDragging:_.current,dragDelta:{x:ge,y:ke},invertY:$},{baseSpeed:E.current,distEstimate:W.current,autoSlow:(p==null?void 0:p.autoSlow)??!0})}else if(a==="Orbit"&&d.current&&(d.current.enabled=!c&&!ne.current&&(he.current||V.current||te.current),d.current.zoomSpeed=ee.current,d.current.rotateSpeed=1/(i||1),Math.abs(O.current)>.01)){const ge=new ie;s.getWorldDirection(ge),s.up.applyAxisAngle(ge,-O.current*2*ye).normalize(),d.current.update()}}),a!=="Orbit"||!y||de?null:e.jsx(ni,{ref:d,enabled:!c,makeDefault:!0,enableDamping:!1,target:M,enableZoom:!u,mouseButtons:{LEFT:La.ROTATE,MIDDLE:La.DOLLY,RIGHT:La.PAN},touches:{ONE:To.ROTATE,TWO:To.DOLLY_PAN},onStart:()=>{if(V.current=!0,d.current){const oe=W.current>0?W.current:Y.getState().targetDistance||3.5,ye=new ie(0,0,-1).applyQuaternion(s.quaternion),pe=new ie().copy(s.position).addScaledVector(ye,oe);d.current.target.copy(pe),d.current.update(),d.current.saveState();const be=s.position.distanceTo(pe);be>1e-8&&(ee.current=Math.max(.001,oe/be*1.25))}},onEnd:()=>{if(V.current=!1,d.current){const oe=d.current.target.clone();oe.lengthSq()>1e-12&&(d.current.target.set(0,0,0),m(new ie(0,0,0)),s.position.sub(oe),s.updateMatrixWorld(),le.emit("offset_shift",{x:oe.x,y:oe.y,z:oe.z}),B.shouldSnapCamera=!0,B.activeCamera&&(B.activeCamera.position.copy(s.position),B.activeCamera.updateMatrixWorld()),d.current.update())}}},`orbit-controls-${C}`)},$d=()=>{const[a,t]=v.useState(!1);v.useEffect(()=>{B.isCompiling&&t(!0);const n=s=>{t(s)};return le.on("is_compiling",n)},[]);const o=!!a,r=typeof a=="string"?a:"Compiling...";return e.jsx("div",{className:`fixed inset-0 z-[99999] flex items-center justify-center pointer-events-none transition-opacity duration-200 ${o?"opacity-100":"opacity-0"}`,children:e.jsxs("div",{className:"bg-black/90 backdrop-blur-md border border-white/20 px-6 py-3 rounded-full flex items-center gap-3 shadow-2xl",children:[e.jsx(jn,{className:"animate-spin h-4 w-4 text-cyan-400"}),e.jsx("span",{className:"text-[10px] font-black text-cyan-100 uppercase tracking-widest",children:r})]})})},Hd=.15,Ud=.4,Xe={X:"#ff4444",Y:"#44ff44",Z:"#4444ff",Hover:"#ffffff",PlaneXY:"#4444ff",PlaneXZ:"#44ff44",PlaneYZ:"#ff4444"},lt=new ie,ra=new ie,mr=(a,t,o)=>(lt.set(a.position.x,a.position.y,a.position.z),a.fixed?lt.applyQuaternion(t.quaternion).add(t.position):lt.sub({x:o.x+o.xL,y:o.y+o.yL,z:o.z+o.zL}),lt.clone()),Gd=(a,t,o,r)=>{t.updateMatrixWorld();const n=t.matrixWorldInverse;if(ra.copy(a).applyMatrix4(n),ra.z>-5e-5)return null;lt.copy(a).project(t);const i=o/2,s=r/2,l=lt.x*i+i,d=-(lt.y*s)+s;return Math.abs(l)>5e4||Math.abs(d)>5e4?null:{x:l,y:d,z:ra.z,isBehindCamera:!1}},qa=(a,t,o,r,n,i,s,l)=>{const d=a.clone().add(t.clone().multiplyScalar(o));if(ra.copy(d).applyMatrix4(n),ra.z>-5e-5)return null;lt.copy(d).project(r),lt.x*s/2,-(lt.y*l/2);const c=lt.x*s/2+s/2,f=-(lt.y*l/2)+l/2;return{x:c-i.x,y:f-i.y}},Wd=At.forwardRef((a,t)=>{const{index:o,light:r,onDragStart:n}=a,i=v.useRef(null),[s,l]=v.useState(null),[d,c]=v.useState(!1),f=Y(m=>m.updateLight),u=m=>l({part:m}),p=()=>l(null),h=()=>{if(!B.activeCamera)return;const m=r.fixed,y=B.virtualSpace.resolveRealWorldPosition(r.position,m,B.activeCamera);f({index:o,params:{fixed:!m,position:y}})};At.useImperativeHandle(t,()=>({update:()=>{if(r.type==="Directional"||!r.visible){i.current&&(i.current.style.display="none");return}const m=B.activeCamera,y=B.renderer,x=i.current;if(!m||!y||!x)return;const C=y.domElement.getBoundingClientRect(),k=C.width,S=C.height,b=B.sceneOffset,w=mr(r,m,b),j=Gd(w,m,k,S);if(!j){x.style.display="none";return}x.style.display="flex",x.style.transform=`translate3d(${j.x}px, ${j.y}px, 0)`;const L=w.distanceTo(m.position)*Hd,_=m.matrixWorldInverse,R=new ie(1,0,0),z=new ie(0,1,0),E=new ie(0,0,1);r.fixed&&(R.applyQuaternion(m.quaternion),z.applyQuaternion(m.quaternion),E.applyQuaternion(m.quaternion));const N=qa(w,R,L,m,_,j,k,S),P=qa(w,z,L,m,_,j,k,S),$=qa(w,E,L,m,_,j,k,S),O=(W,H)=>{x.querySelectorAll(`.${W}`).forEach(F=>{H?(F.setAttribute("x2",String(H.x)),F.setAttribute("y2",String(H.y)),F.setAttribute("visibility","visible")):F.setAttribute("visibility","hidden")})};O("axis-x-line",N),O("axis-y-line",P),O("axis-z-line",$);const X=(W,H,A)=>{const F=x.querySelector(`.${W}`);if(F)if(H&&A){const I=Ud,D=H.x*I,G=H.y*I,q=A.x*I,Q=A.y*I,J=D+q,re=G+Q;F.setAttribute("d",`M0,0 L${D},${G} L${J},${re} L${q},${Q} Z`),F.setAttribute("visibility","visible")}else F.setAttribute("visibility","hidden")};X("plane-xy",N,P),X("plane-xz",N,$),X("plane-yz",P,$)}}));const g=(m,y)=>{const x=B.activeCamera;if(!x)return;const C=mr(r,x,B.sceneOffset);n(m,o,y,C)},M=m=>{m.stopPropagation(),c(!d)};return r.type==="Directional"?null:e.jsxs("div",{ref:i,className:"absolute flex items-center justify-center w-0 h-0 pointer-events-auto",style:{display:"none",willChange:"transform"},children:[e.jsxs("svg",{className:"absolute overflow-visible pointer-events-none",style:{left:0,top:0},children:[e.jsxs("defs",{children:[e.jsx("marker",{id:`arrow-${o}-x`,markerWidth:"6",markerHeight:"6",refX:"5",refY:"3",orient:"auto",children:e.jsx("path",{d:"M0,0 L0,6 L6,3 z",fill:(s==null?void 0:s.part)==="axis-x"?Xe.Hover:Xe.X})}),e.jsx("marker",{id:`arrow-${o}-y`,markerWidth:"6",markerHeight:"6",refX:"5",refY:"3",orient:"auto",children:e.jsx("path",{d:"M0,0 L0,6 L6,3 z",fill:(s==null?void 0:s.part)==="axis-y"?Xe.Hover:Xe.Y})}),e.jsx("marker",{id:`arrow-${o}-z`,markerWidth:"6",markerHeight:"6",refX:"5",refY:"3",orient:"auto",children:e.jsx("path",{d:"M0,0 L0,6 L6,3 z",fill:(s==null?void 0:s.part)==="axis-z"?Xe.Hover:Xe.Z})})]}),e.jsx("path",{className:"plane-xy cursor-move pointer-events-auto transition-opacity duration-150",fill:(s==null?void 0:s.part)==="plane-xy"?Xe.Hover:Xe.PlaneXY,fillOpacity:"0.3",stroke:"none",onPointerDown:m=>g(m,"plane-xy"),onPointerEnter:()=>u("plane-xy"),onPointerLeave:p}),e.jsx("path",{className:"plane-xz cursor-move pointer-events-auto transition-opacity duration-150",fill:(s==null?void 0:s.part)==="plane-xz"?Xe.Hover:Xe.PlaneXZ,fillOpacity:"0.3",stroke:"none",onPointerDown:m=>g(m,"plane-xz"),onPointerEnter:()=>u("plane-xz"),onPointerLeave:p}),e.jsx("path",{className:"plane-yz cursor-move pointer-events-auto transition-opacity duration-150",fill:(s==null?void 0:s.part)==="plane-yz"?Xe.Hover:Xe.PlaneYZ,fillOpacity:"0.3",stroke:"none",onPointerDown:m=>g(m,"plane-yz"),onPointerEnter:()=>u("plane-yz"),onPointerLeave:p}),e.jsxs("g",{onPointerEnter:()=>u("axis-z"),onPointerLeave:p,children:[e.jsx("line",{className:"axis-z-line pointer-events-none transition-all duration-150",x1:"0",y1:"0",x2:"0",y2:"0",stroke:(s==null?void 0:s.part)==="axis-z"?Xe.Hover:Xe.Z,strokeWidth:"2",markerEnd:`url(#arrow-${o}-z)`}),e.jsx("line",{className:"axis-z-line cursor-pointer pointer-events-auto",x1:"0",y1:"0",x2:"0",y2:"0",stroke:"rgba(0,0,0,0)",strokeWidth:"12",onPointerDown:m=>g(m,"axis-z")})]}),e.jsxs("g",{onPointerEnter:()=>u("axis-y"),onPointerLeave:p,children:[e.jsx("line",{className:"axis-y-line pointer-events-none transition-all duration-150",x1:"0",y1:"0",x2:"0",y2:"0",stroke:(s==null?void 0:s.part)==="axis-y"?Xe.Hover:Xe.Y,strokeWidth:"2",markerEnd:`url(#arrow-${o}-y)`}),e.jsx("line",{className:"axis-y-line cursor-pointer pointer-events-auto",x1:"0",y1:"0",x2:"0",y2:"0",stroke:"rgba(0,0,0,0)",strokeWidth:"12",onPointerDown:m=>g(m,"axis-y")})]}),e.jsxs("g",{onPointerEnter:()=>u("axis-x"),onPointerLeave:p,children:[e.jsx("line",{className:"axis-x-line pointer-events-none transition-all duration-150",x1:"0",y1:"0",x2:"0",y2:"0",stroke:(s==null?void 0:s.part)==="axis-x"?Xe.Hover:Xe.X,strokeWidth:"2",markerEnd:`url(#arrow-${o}-x)`}),e.jsx("line",{className:"axis-x-line cursor-pointer pointer-events-auto",x1:"0",y1:"0",x2:"0",y2:"0",stroke:"rgba(0,0,0,0)",strokeWidth:"12",onPointerDown:m=>g(m,"axis-x")})]}),e.jsx("circle",{cx:"0",cy:"0",r:"6",fill:r.color,stroke:"white",strokeWidth:"2",className:`cursor-move pointer-events-auto transition-all duration-150 ${(s==null?void 0:s.part)==="free"?"stroke-cyan-400 r-[8px]":""}`,onPointerDown:m=>g(m,"free"),onPointerEnter:()=>u("free"),onPointerLeave:p})]}),e.jsxs("div",{className:"absolute top-[50px] left-0 transform -translate-x-1/2 flex items-center gap-1 bg-black/80 backdrop-blur px-1.5 py-0.5 rounded border border-white/20 select-none z-20 pointer-events-auto transition-transform hover:scale-105",onClick:M,children:[e.jsxs("span",{className:"text-[9px] font-bold text-white uppercase",children:["L",o+1]}),e.jsx("button",{className:"anchor-btn p-0.5 hover:text-cyan-400 transition-colors text-[9px]",onPointerDown:m=>m.stopPropagation(),onClick:m=>{m.stopPropagation(),h()},title:r.fixed?"Attached to Camera":"World Anchored",children:r.fixed?e.jsx(Vl,{}):e.jsx(Yl,{})})]}),d&&e.jsx("div",{className:"absolute left-6 top-10 ml-2 pointer-events-auto z-[100]",onPointerDown:m=>m.stopPropagation(),children:e.jsxs("div",{className:"bg-black/90 border border-white/20 rounded-xl p-2 w-56 shadow-2xl relative",children:[e.jsx("div",{className:"absolute top-4 -left-1.5 w-3 h-3 bg-black border-l border-b border-white/20 transform rotate-45"}),e.jsx(_n,{index:o})]})}),d&&e.jsx("div",{className:"fixed inset-0 z-50",onClick:()=>c(!1),onPointerDown:m=>m.stopPropagation()})]})}),Un={current:{}},qd=()=>{Object.values(Un.current).forEach(a=>{try{a.update()}catch(t){console.error("Error updating light gizmo:",t)}})},Xd=()=>{const a=Y(h=>h.showLightGizmo),t=Y(h=>{var g;return((g=h.lighting)==null?void 0:g.lights)||[]}),o=Y(h=>h.setGizmoDragging);Y(h=>h.updateLight);const r=Y(h=>h.setDraggedLight),{handleInteractionStart:n,handleInteractionEnd:i}=Y(),s=v.useRef(null),l=v.useMemo(()=>new Ir,[]),d=v.useMemo(()=>new Ea,[]),c=Un,f=(h,g,M,m)=>{h.preventDefault(),h.stopPropagation();const y=t[g];if(!y)return;n("param"),o(!0),B.isGizmoInteracting=!0,r(g),h.target.setPointerCapture(h.pointerId);const x=B.activeCamera;if(!x||!B.renderer)return;const C=B.renderer.domElement.getBoundingClientRect(),k=new Se((h.clientX-C.left)/C.width*2-1,-((h.clientY-C.top)/C.height)*2+1);if(d.setFromCamera(k,x),M.startsWith("plane")||M==="free"){let S=new ie;M==="free"?x.getWorldDirection(S):M==="plane-xy"?S.set(0,0,1):M==="plane-xz"?S.set(0,1,0):M==="plane-yz"&&S.set(1,0,0),y.fixed&&M!=="free"&&S.applyQuaternion(x.quaternion),l.setFromNormalAndCoplanarPoint(S,m);const b=new ie,j=d.ray.intersectPlane(l,b)?new ie().subVectors(m,b):new ie(0,0,0);s.current={active:!0,index:g,mode:M,startX:h.clientX,startY:h.clientY,startPos:m.clone(),planeNormal:S,planeOrigin:m,offsetFromIntersection:j,screenAxis:new Se,worldAxis:new ie}}else if(M.startsWith("axis")){let S=new ie;M==="axis-x"&&S.set(1,0,0),M==="axis-y"&&S.set(0,1,0),M==="axis-z"&&S.set(0,0,1),y.fixed&&S.applyQuaternion(x.quaternion);const b=m.clone().project(x),w=m.clone().add(S).project(x),j=B.renderer.domElement.width/window.devicePixelRatio,T=B.renderer.domElement.height/window.devicePixelRatio,L=(w.x-b.x)*j*.5,_=-(w.y-b.y)*T*.5;let R=new Se(L,_);R.lengthSq()<1&&R.set(1,0),R.normalize(),s.current={active:!0,index:g,mode:M,startX:h.clientX,startY:h.clientY,startPos:m.clone(),planeNormal:new ie,planeOrigin:new ie,offsetFromIntersection:new ie,screenAxis:R,worldAxis:S}}window.addEventListener("pointermove",u),window.addEventListener("pointerup",p)},u=h=>{var k;const g=s.current;if(!g||!g.active)return;h.preventDefault(),h.stopPropagation();const M=B.activeCamera;if(!M)return;const y=(((k=Y.getState().lighting)==null?void 0:k.lights)||[])[g.index];if(!y)return;let x=new ie;if(g.mode.startsWith("plane")||g.mode==="free"){const S=B.renderer.domElement.getBoundingClientRect(),b=new Se((h.clientX-S.left)/S.width*2-1,-((h.clientY-S.top)/S.height)*2+1);d.setFromCamera(b,M),l.setFromNormalAndCoplanarPoint(g.planeNormal,g.planeOrigin);const w=new ie;if(d.ray.intersectPlane(l,w))x.copy(w).add(g.offsetFromIntersection);else return}else{const S=h.clientX-g.startX,b=h.clientY-g.startY,w=S*g.screenAxis.x+b*g.screenAxis.y,T=g.startPos.distanceTo(M.position)*.0025;x.copy(g.startPos).addScaledVector(g.worldAxis,w*T)}let C={x:0,y:0,z:0};if(y.fixed){const S=x.clone().sub(M.position).applyQuaternion(M.quaternion.clone().invert());C={x:S.x,y:S.y,z:S.z}}else{const S=B.sceneOffset;C={x:x.x+(S.x+S.xL),y:x.y+(S.y+S.yL),z:x.z+(S.z+S.zL)}}Y.getState().updateLight({index:g.index,params:{position:C}})},p=h=>{s.current&&(o(!1),r(null),B.isGizmoInteracting=!1,i(),s.current=null,window.removeEventListener("pointermove",u),window.removeEventListener("pointerup",p))};return a?e.jsx("div",{className:"absolute inset-0 pointer-events-none overflow-hidden",children:t.map((h,g)=>e.jsx(Wd,{index:g,light:h,onDragStart:f,ref:M=>{M?c.current[g]=M:delete c.current[g]}},g))}):null},Yd=({onLoaded:a})=>{const{camera:t,size:o,gl:r,scene:n}=_t(),[i,s]=v.useState(!1),l=Y(u=>u.isExporting),d=v.useMemo(()=>new bt,[]),c=v.useMemo(()=>new Pt(-1,1,1,-1,0,1),[]),f=v.useRef(null);return v.useEffect(()=>{B.registerCamera(t),B.registerRenderer(r)},[t,r]),v.useEffect(()=>{if(!r||i)return;B.mainUniforms.uResolution.value.set(o.width,o.height),B.pipeline.resize(o.width,o.height);let u=!0;return(async()=>{for(;!B.isBooted;){if(!u)return;await new Promise(h=>setTimeout(h,50))}for(;B.isCompiling;){if(!u)return;await new Promise(h=>setTimeout(h,50))}s(!0),a&&a()})(),()=>{u=!1}},[r,o]),v.useEffect(()=>{B.mainUniforms.uResolution.value&&(B.mainUniforms.uResolution.value.set(o.width,o.height),B.pipeline.resize(o.width,o.height),B.resetAccumulation())},[o]),Bt((u,p)=>{if(!i)return;if(l){B.videoExporter.tick(r);return}Cd(p),B.update(t,p,u),qd(),uc(),Pd(),cd(),B.compute(r);const h=B.pipeline.getOutputTexture();f.current&&h&&(B.materials.displayMaterial.uniforms.map.value=h,r.autoClear=!1,r.clear(),r.render(d,c),r.clearDepth())},1),oi(e.jsx("mesh",{ref:f,frustumCulled:!1,material:B.materials.displayMaterial,children:e.jsx("planeGeometry",{args:[2,2]})}),d)},gr=12,Vd=40,Zd=()=>{const a=ve.getViewportOverlays().filter(r=>r.type==="dom"),t=Y(),o=Y();return e.jsx("div",{className:"absolute inset-0 pointer-events-none overflow-hidden z-[20]",children:a.map(r=>{const n=Ne.get(r.componentId);if(n){const i=r.id,s=t[i];return e.jsx(n,{featureId:i,sliceState:s,actions:o},r.id)}return null})})},Kd=()=>{const a=ve.getViewportOverlays().filter(r=>!r.type||r.type==="scene"),t=Y(),o=Y();return e.jsx(e.Fragment,{children:a.map(r=>{const n=Ne.get(r.componentId);if(n){const i=r.id,s=t[i];return e.jsx(n,{featureId:i,sliceState:s,actions:o},r.id)}return null})})},Qd=()=>{const{camera:a}=_t(),t=v.useRef(new ie),o=v.useRef(new Be),r=v.useRef(0);return Bt(()=>{if(B.activeCamera){let n=!1;if(t.current.equals(a.position)||(B.activeCamera.position.copy(a.position),t.current.copy(a.position),n=!0),o.current.equals(a.quaternion)||(B.activeCamera.quaternion.copy(a.quaternion),o.current.copy(a.quaternion),n=!0),a.isPerspectiveCamera&&B.activeCamera.isPerspectiveCamera){const i=B.activeCamera,s=a;i.fov!==s.fov&&(i.fov=s.fov,i.updateProjectionMatrix(),r.current=s.fov,n=!0)}n&&B.activeCamera.updateMatrixWorld()}}),null},Jd=({hudRefs:a,onSceneReady:t})=>{const o=Y(),r=v.useRef(null),n=v.useRef(null),{drawing:i,interactionMode:s}=o,l=i==null?void 0:i.active,d=s==="selecting_region",{visualRegion:c,isGhostDragging:f,renderRegion:u}=Td(r);jd(r);const{isMobile:p}=bo(),[h,g]=v.useState({w:0,h:0});v.useLayoutEffect(()=>{if(!n.current)return;const P=new ResizeObserver(O=>{for(const X of O){const W=Math.max(1,X.contentRect.width),H=Math.max(1,X.contentRect.height);g({w:W,h:H})}});P.observe(n.current);const $=n.current.getBoundingClientRect();return $.width>0&&$.height>0&&g({w:$.width,h:$.height}),()=>P.disconnect()},[]);const M=o.resolutionMode==="Fixed",[m,y]=o.fixedResolution,x=c||u,C=o.isBroadcastMode,k=40,S=Math.max(1,h.w-k),b=Math.max(1,h.h-k);let w=1;M&&(w=Math.min(1,S/m,b/y));const j=M?{width:m,height:y,transform:`scale(${w})`,transformOrigin:"center center",boxShadow:"0 0 50px rgba(0,0,0,0.5)",border:"1px solid rgba(255,255,255,0.1)",flexShrink:0}:{width:"100%",height:"100%"},T=M?m*w:h.w,L=M?y*w:h.h,_=(h.h-L)/2,R=(h.w-T)/2,z=Math.max(gr,_-Vd),E=Math.max(gr,R),N=P=>{};return e.jsxs("div",{ref:n,className:`relative flex-1 flex items-center justify-center overflow-hidden bg-[#050505] touch-none ${d||l?"cursor-crosshair":""}`,style:{backgroundImage:M?"radial-gradient(circle at center, #111 0%, #050505 100%)":"none"},onContextMenu:P=>{P.preventDefault(),P.stopPropagation()},children:[M&&e.jsx("div",{className:"absolute inset-0 opacity-20 pointer-events-none",style:{backgroundImage:"linear-gradient(#333 1px, transparent 1px), linear-gradient(90deg, #333 1px, transparent 1px)",backgroundSize:"40px 40px"}}),!C&&e.jsx(Md,{state:o,actions:o,isMobile:o.debugMobileLayout||p,hudRefs:a}),!C&&e.jsx($d,{}),!C&&e.jsx(Rd,{}),!C&&e.jsx(kd,{}),e.jsxs("div",{ref:r,style:j,className:"relative bg-[#111] group z-0",children:[(d||l)&&e.jsx("div",{className:"absolute inset-0 z-50 cursor-crosshair bg-transparent pointer-events-none"}),x&&!d&&!C&&e.jsx("div",{className:`absolute border-2 z-40 group/box region-box cursor-move transition-opacity duration-75 ${f?"border-cyan-400 border-dashed opacity-80":"border-cyan-500 opacity-100"}`,style:{left:`${x.minX*100}%`,bottom:`${x.minY*100}%`,right:`${(1-x.maxX)*100}%`,top:`${(1-x.maxY)*100}%`},children:e.jsxs("div",{className:"absolute top-0 right-0 bg-cyan-600 text-white text-[9px] font-bold px-1.5 py-0.5 flex items-center gap-2 pointer-events-auto shadow-md",children:[e.jsx("span",{children:f?"Moving...":"Active Region"}),e.jsx("div",{className:"w-px h-2 bg-cyan-400/50"}),e.jsx("button",{onClick:P=>{P.stopPropagation(),o.setRenderRegion(null)},className:"hover:text-black transition-colors",title:"Clear Region",children:""})]})}),e.jsxs(ri,{gl:{alpha:!1,depth:!1,antialias:!1,powerPreference:"high-performance",preserveDrawingBuffer:!0},camera:{position:[0,0,0],fov:60},style:{position:"absolute",inset:0,pointerEvents:"auto"},dpr:o.dpr,onPointerDown:P=>P.target.setPointerCapture(P.pointerId),onPointerMove:N,onWheel:N,children:[e.jsx(Od,{mode:o.cameraMode,hudRefs:a,onStart:P=>o.handleInteractionStart(P),onEnd:()=>o.handleInteractionEnd(),setSceneOffset:o.setSceneOffset,fitScale:w}),e.jsx(Yd,{onLoaded:t}),e.jsx(Qd,{}),e.jsx(Kd,{})]}),e.jsx(Zd,{}),!C&&e.jsx(Id,{width:M?m:h.w,height:M?y:h.h}),!C&&o.histogramActiveCount>0&&e.jsx(lr,{onUpdate:P=>o.setHistogramData(P),autoUpdate:o.histogramAutoUpdate,trigger:o.histogramTrigger,source:"geometry"}),!C&&o.sceneHistogramActiveCount>0&&e.jsx(lr,{onUpdate:P=>o.setSceneHistogramData(P),autoUpdate:!0,trigger:o.sceneHistogramTrigger,source:"color"}),d&&!C&&e.jsx("div",{className:"absolute top-4 left-1/2 -translate-x-1/2 bg-cyan-900/80 text-cyan-100 text-[10px] font-bold px-3 py-1 rounded-full border border-cyan-500/50 shadow-lg animate-pulse pointer-events-none z-[60]",children:"Drag to select render region"})]}),M&&!C&&e.jsx(Fd,{width:m,height:y,top:z,left:E,maxAvailableWidth:h.w,maxAvailableHeight:h.h,onSetResolution:o.setFixedResolution,onSetMode:o.setResolutionMode})]})},eu=()=>{const a=Y(t=>t.openContextMenu);v.useEffect(()=>{const t=o=>{if(o.defaultPrevented)return;const r=Oe(o.target);r.length>0&&(o.preventDefault(),a(o.clientX,o.clientY,[],r))};return window.addEventListener("contextmenu",t),()=>window.removeEventListener("contextmenu",t)},[a])},tu={"general.undo":{id:"general.undo",category:"General",title:"Undo & History",content:`
The application uses **Three Separate History Stacks** to manage state.
This separation ensures that navigating the world doesn't undo your careful parameter tuning, and vice versa.

## 1. Parameter History (Global)
Tracks changes to sliders, colors, checkboxes, and formula settings.
- **Undo**: **Ctrl + Z**
- **Redo**: **Ctrl + Y**
- **Scope**: Any change made in the Control Deck (Formula, Light, Shading, etc).

## 2. Camera History (Navigation)
Tracks your movement in 3D space (Orbit and Fly modes).
- **Undo**: **Ctrl + Shift + Z**
- **Redo**: **Ctrl + Shift + Y**
- **Why?** Navigation generates thousands of micro-updates. Separating this prevents the "Parameter Undo" from getting clogged with camera moves.
- **UI Access**: You can also use the Undo/Redo buttons in the **Camera Menu** (Camera Icon in Top Bar).

## 3. Timeline History (Animation)
Tracks keyframes, tracks, and sequence data.
- **Undo**: **Ctrl + Z** (Context Sensitive)
- **Redo**: **Ctrl + Y** (Context Sensitive)
- **Context**: This stack is active when your mouse is hovering over the **Timeline Panel**. If you move the mouse away, Ctrl+Z reverts to Parameter Undo.
`},"general.shortcuts":{id:"general.shortcuts",category:"General",title:"Keyboard Shortcuts",content:`
## Navigation (Fly Mode)
- **W / S**: Move Forward / Backward
- **A / D**: Strafe Left / Right
- **Space**: Move Up (Ascend)
- **C**: Move Down (Descend)
- **Q / E**: Roll Camera Left / Right
- **Shift**: Speed Boost (4x)
- **Mouse Drag**: Look around (Steer)
- **Scroll**: Adjust Fly Speed

## Navigation (Orbit Mode)
- **Left Drag**: Rotate around target
- **Right Drag**: Pan camera
- **Scroll**: Zoom In / Out
- **Q / E**: Roll Camera

## History & Undo
- **Ctrl + Z**: Undo Parameter Change
- **Ctrl + Y**: Redo Parameter Change
- **Ctrl + Shift + Z**: Undo Camera Movement
- **Ctrl + Shift + Y**: Redo Camera Movement

## Tools & UI
- **1 - 6**: Open Quick-Edit Slider for Params A-F (at mouse cursor)
- **Tab**: Toggle between Orbit and Fly Mode
- **T**: Toggle Timeline Panel
- **H**: Toggle UI Hints (Tooltip overlay)
- **Esc**: Cancel Focus Picking / Close Menus / Deselect
`},"general.disclaimer":{id:"general.disclaimer",category:"General",title:"Disclaimer & Terms",content:`
## Age Restriction
According to Google's Terms of Service, this application is **not intended for users under the age of 18**.

## AI & Human Verification
This application was created through a collaboration between Artificial Intelligence and Human Engineering. 
While rigorous verification processes are in place:
- Both AI and Humans are fallible.
- The software may contain errors, bugs, or inaccuracies.
- Use at your own risk.
`},"general.files":{id:"general.files",category:"General",title:"File Import & Export",content:`
## Smart PNGs (Steganography)
When you save a **Snapshot** (via the Camera Menu), the application embeds the full scene data into the image metadata.
- **Load**: Simply **drag and drop** the PNG file back into the browser window to restore the scene instantly.
- **Safety**: The visual image is standard PNG. The data is hidden in a \`tEXt\` chunk.
- **Warning**: Social media platforms (Twitter, Facebook, etc.) strip this metadata. Share the file directly (Discord, Drive, Email) to preserve the data.

## Shareable URLs
You can share your scene via the URL bar.
- **Copy Link**: Use the link icon in the System Menu.
- **Limits**: Browsers have a URL limit (approx 4096 characters). If your scene is too complex (e.g., thousands of keyframes), the app will automatically **strip animation data** to generate a working link. A warning "(Anims Removed)" will appear.
`}},au={"formula.active":{id:"formula.active",category:"Formulas",title:"Active Formula",content:`
This dropdown selects the mathematical equation used to generate the 3D shape.

## Categories
- **Classic Sets**: The original Mandelbulb and its variations (Power-based).
- **Geometric**: Box folds, Sponges, and Polyhedra (Fold-based).
- **Hybrids**: Formulas that mix folding and power functions for complex, organic-mechanical looks.
- **Systems**: The **Modular Builder**, allowing you to create custom pipelines.
`},"formula.transform":{id:"formula.transform",category:"Formulas",title:"Local Rotation (Pre-Transform)",content:`
Rotates the coordinate system $(x,y,z)$ *before* the fractal formula is applied.

## Why use this?
- **Orientation**: Rotates the fractal object itself, rather than moving the camera around it. This is useful for aligning the fractal with lighting or fog.
- **Symmetry**: Changing the input rotation can drastically change the shape of box-folded fractals (like Amazing Box or Menger Sponge) because the folding planes are axis-aligned. Rotating the space causes the folds to cut at diagonal angles.
`}},ou={"formula.mandelbulb":{id:"formula.mandelbulb",category:"Formulas",title:"Mandelbulb",parentId:"formula.active",content:`
## The Math
The Mandelbulb is a 3D analogue of the Mandelbrot set constructed using Spherical Coordinates.
The iteration maps a point $(x,y,z)$ to spherical $(r, 	heta, phi)$, powers it by $n$, and adds the constant $c$.
$$ v 	o v^n + c $$

**Reference:** [Wikipedia: Mandelbulb](https://en.wikipedia.org/wiki/Mandelbulb)
**Credits:** Discovered by **Daniel White** and **Paul Nylander**.

## Parameters
- **Param A (Power)**: The exponent $n$.
  - **8.0**: The classic "Broccoli" shape discovered by Daniel White.
  - **2.0**: A smooth, bulbous shape similar to a 3D Cardioid.
- **Param B (Theta Phase)**: Adds an offset to the polar angle $	heta$ during iteration. Warps the bulbs vertically.
- **Param C (Phi Phase)**: Adds an offset to the azimuthal angle $phi$. Twists the bulbs horizontally.
- **Param D (Z Twist)**: Applies a spatial twist along the Z-axis after the power function.
- **Param E (Radiolaria)**: Toggles the **Radiolaria Mutation**.
- **Param F (Radio Limit)**: When Radiolaria is on, this clamps the Y-coordinate.

## Radiolaria Mode
Inspired by **Tom Beddard's** Pixel Bender implementation.
If Param E is enabled (> 0.5), the formula clamps the Y-coordinate *during* the iteration loop.
This creates hollow, skeletal structures that resemble microscopic Radiolaria shells.
- **Tip**: Set Coloring Mode to **Trap** to highlight the "cut" surfaces, which are assigned a trap value of 0.
`},"formula.appell":{id:"formula.appell",category:"Formulas",title:"Appell Spectral (Ghost)",parentId:"formula.active",content:`
## The Math
Based on **Appell Polynomials** ($P_k$) from Clifford Analysis. 
While standard fractal formulas simply power the vector ($z^2$), the Appell sequence introduces a non-conformal subtraction term that exposes the underlying "Skeleton" of the math.
$$ P_2(x) = x^2 - k|x|^2 $$

## The "Ghost" Visuals
Because this formula subtracts magnitude during iteration, it doesn't converge to a hard surface like a standard Mandelbrot. 
Instead, it creates a field of "Interference Patterns". 
This implementation is designed to be rendered as a **Volumetric Cloud** (using the Glow engine) rather than a solid object.

## Parameters
- **Param A (Interference)**: The strength of the subtraction term $k$.
  - **0.0**: Standard "Lathe" fractal (Solid).
  - **0.33**: The theoretical Euclidean balance point.
  - **> 0.5**: Breaks the surface, revealing internal veins and structures.
- **Param C (Ghost Shift)**: Shifts the calculation into the 4th dimension. Use this to scan through the "inside" of the ghost.
- **Param D (Cloud Density)**: Artificially softens the Distance Estimator to make the fractal look like a nebula.
`},"formula.mandelbrotck":{id:"formula.mandelbrotck",category:"Formulas",title:"Mandelbrot Hypercomplex",parentId:"formula.active",content:`
## The Math
This is the corrected "True" 3D extension of the Mandelbrot set using Hypercomplex algebra.

## The "Missing Cross-Term"
Simple 3D extensions often look like a 2D Mandelbrot rotated around a stick (a "Lathe"). This happens because the Y and Z axes don't interact.
This formula adds the **Cross-Term ($2yz$)** to the iteration, forcing the Y and Z components to mix. This creates a fully connected 3D structure that is not just a surface of revolution.

## Parameters
- **Param A (Metric)**:
  - **-1.0**: Elliptic. Solid, bulbous, Tetabrot-like.
  - **1.0**: Hyperbolic. Creates "Saddles", "Feathers" and open filaments.
- **Param B (C-Phase)**: Rotates the injection constant $C$ during iteration. Creates spiraling arms and asymmetry.
- **Param C (Coupling)**: Controls the strength of the Y/Z mixing.
  - **0.0**: Lathe mode (No mixing).
  - **1.0**: Full 3D Fractal.
- **Param D (Burn Mix)**: Blends between Standard Mandelbrot and **Burning Ship** logic ($z 	o |z|$).
  - **0.0**: Smooth.
  - **1.0**: Sharp, skeletal, mechanical structures.
- **Param E (Spiral)**: Rotates the Y and Z axes at every step. Turns straight filaments into helixes.
- **Param F (Y Scale)**: Modifies the width of the fractal arms.
`},"formula.hypertorus":{id:"formula.hypertorus",category:"Formulas",title:"Mandelorus (HyperTorus)",parentId:"formula.active",content:`
## The Concept
Standard 3D fractals like the Mandelbulb suffer from "Polar Distortion"the texture gets pinched at the top and bottom poles (like the north pole of a globe).
The **Mandelorus** solves this by mapping the infinite fractal plane onto the surface of a **Torus** (Donut) instead of a Sphere.
This creates a **Solenoid** structure where the fractal wraps around the ring endlessly.

## The Math
1. Convert 3D position $(x,y,z)$ to Toroidal coordinates $(radius, angle, z)$.
2. The poloidal cross-section (the slice of the donut) forms a complex plane.
3. We iterate the Mandelbrot formula on this slice.
4. We apply a **Twist** rotation to the slice based on the angle around the ring.

## Parameters
- **Param A (Ring Radius)**: The major radius of the donut. Controls the size of the "hole".
- **Param B (Twist)**: The most important control. Spins the fractal pattern around the ring.
  - **0.0**: Creates a "Lathe" effect (constant cross-section).
  - **Values > 0**: Creates twisting, cable-like structures that connect endlessly.
- **Param C (Power)**: The exponent of the Mandelbrot set ($z^2$, $z^3$, etc).
- **Param D (Ring Phase)**: Shifts the fractal along the length of the tube.
- **Param E (Cross Phase)**: Rotates the cross-section slice.

## Usage
Perfect for creating "Endless Tunnels" or "Ouroboros" structures. Fly the camera inside the tube for infinite loops.
`},"formula.mandelbar3d":{id:"formula.mandelbar3d",category:"Formulas",title:"Mandelbar 3D (Tricorn)",parentId:"formula.active",content:`
## The Math
A 3D variation of the "Tricorn" or Mandelbar set. In 2D, the Tricorn uses the complex conjugate: $z_{n+1} = \bar{z}_n^2 + c$.
In 3D, this manifests as negating specific terms in the squaring formula.

**Reference:** [Wikipedia: Tricorn (Mathematics)](https://en.wikipedia.org/wiki/Tricorn_(mathematics))

## Parameters
- **Param A (Scale)**: Scales the entire coordinate system before iteration.
- **Param B (Offset)**: Shifts the fractal along the X-axis.
- **Param C (Rot X)**: Rotates the coordinate system around X per iteration.
- **Param D (Rot Z)**: Rotates the coordinate system around Z per iteration.
- **Param E (Offset Z)**: Shifts the fractal along the Z-axis.
- **Param F (Twist)**: Twists space based on Z-depth.

## Characteristics
Unlike the Mandelbulb, the Mandelbar tends to be flatter with shelf-like structures and "tri-corner" symmetries. It often resembles alien ruins or stacked pagodas.
`},"formula.mandelterrain":{id:"formula.mandelterrain",category:"Formulas",title:"Mandel Terrain",parentId:"formula.active",content:`
## The Math
This is not a true 3D fractal, but a heightmap generator. It calculates the 2D Mandelbrot set ($z^2+c$) on the XZ plane and uses the iteration count or orbit trap distance to displace the Y (Height) coordinate.

**Reference:** [Wikipedia: Mandelbrot Set](https://en.wikipedia.org/wiki/Mandelbrot_set)
**Credits:** Mathematical basis by **Benoit B. Mandelbrot**.

## Parameters
- **Param A (Height)**: Controls the vertical displacement strength based on the Distance Estimator.
- **Param B (Zoom)**: Zoom level into the 2D complex plane.
- **Param C (Layer 2)**: Adds secondary ripples driven by the "Layer 2" gradient brightness.
- **Param D (Smooth Trap)**: Adds spikey towers based on Orbit Trap proximity.
- **Param E/F (Pan)**: Moves the fractal center coordinates (Julia/Mandelbrot origin).

## Usage
Ideal for creating alien landscapes, canyons, and "Math Mountains".
`},"formula.quaternion":{id:"formula.quaternion",category:"Formulas",title:"Quaternion Julia",parentId:"formula.active",content:`
## The Math
Quaternions are a 4-dimensional number system ($x, y, z, w$). This formula iterates the classic $z^2+c$ using Quaternion multiplication.
Since our screens are 2D and the fractal is 4D, we view a **3D Slice** of the 4D object.

**Reference:** [Wikipedia: Quaternion](https://en.wikipedia.org/wiki/Quaternion)
**Credits:** Number system described by **William Rowan Hamilton**.

## Parameters
- **Param A (Julia W)**: The 4th coordinate of the Julia Constant $C$. Changing this "animates" the fractal as you move through the 4th dimension.
- **Param B (Slice W)**: The w-coordinate of the 3D slice we are rendering.
- **Param C-F (Rotations)**: Rotates the 4D hyper-object on various planes (XY, XZ, XW, YW) before slicing. This creates "inside-out" morphing effects.

## History
Quaternions were described by William Rowan Hamilton in 1843. They are the "true" 3D/4D extension of complex numbers, but because valid multiplication requires 4 dimensions, 3D slices often look "cut off" or smooth compared to the Mandelbulb.
`},"formula.amazingbox":{id:"formula.amazingbox",category:"Formulas",title:"Amazing Box (Mandelbox)",parentId:"formula.active",content:`
## The Math
The Mandelbox is defined by a "Map and Fold" algorithm rather than a power function.
1. **Box Fold**: If a point is outside the box $[-1, 1]$, reflect it back in.
2. **Sphere Fold**: If a point is inside a small sphere, scale it up (inversion).
3. **Scale**: Multiply the vector by a scale factor.

**Reference:** [Wikipedia: Mandelbox](https://en.wikipedia.org/wiki/Mandelbox)
**Credits:** Discovered by **Tom Lowe (Tglad)** in 2010.

## Parameters
- **Param A (Scale)**: The density multiplier. Positive values create solid cubes; negative values create hollow, lattice-like structures.
- **Param B (Min Radius)**: The inner radius of the Sphere Fold (linear scaling region).
- **Param C (Fold Limit)**: The size of the folding box.
- **Param D (Fixed Radius)**: The outer radius of the Sphere Fold (inversion region).
- **Param E/F (Pre-Rotation)**: Rotates space *before* the folds, creating diagonal symmetries.

## History
It is famous for resembling Borg cubes, sci-fi cities, and brutalist architecture.
`},"formula.marblemarcher":{id:"formula.marblemarcher",category:"Formulas",title:"Marble Marcher",parentId:"formula.active",content:`
## The Math
The formula from the game *Marble Marcher*. It is a specialized Menger Sponge Iterated Function System (IFS) that incorporates dynamic rotation and linear shifting in every step.

**Credits:** Created by **CodeParade** for the game [Marble Marcher](https://codeparade.itch.io/marblemarcher).

## Parameters
- **Param A (Scale)**: The scaling factor.
- **Param B/E/F (Shift)**: Linear translation vector.
- **Param C (Rot Z)**: Rotates the Z-plane.
- **Param D (Rot X)**: Rotates the X-plane.

## Usage
Produces highly dynamic, shifting geometric landscapes. Animate the Rotation and Shift parameters to see the geometry unfold and reconfigure itself.
`},"formula.mengersponge":{id:"formula.mengersponge",category:"Formulas",title:"Menger Sponge",parentId:"formula.active",content:`
## The Math
Based on the classic Sierpinski carpet extended to 3D. It recursively subdivides a cube into 27 sub-cubes and removes the center of each face and the center of the cube.
Our implementation adds **Rotation** to the folding steps, creating "Non-Orthogonal" Mengers.

**Reference:** [Wikipedia: Menger Sponge](https://en.wikipedia.org/wiki/Menger_sponge)

## Parameters
- **Param A (Scale)**: The scaling factor. Standard Menger is 3.0.
- **Param B (Offset)**: The spacing between sub-cubes.
- **Param C (Rot X)**: Rotates the coordinate system between iterations.
- **Param D (Rot Z)**: Rotates the coordinate system between iterations.
- **Param E (Z Shift)**: Stretches the fractal vertically.

## Visuals
With rotations set to 0, it looks like a perfect grid. Adding slight rotations creates complex, diagonal, interlocking machinery.
`},"formula.kleinian":{id:"formula.kleinian",category:"Formulas",title:"Kleinian",parentId:"formula.active",content:`
## The Math
Based on Kleinian groups and Limit Sets. It utilizes **Inversion in a Sphere** as its primary operation.
The formula repeats: Box Fold $	o$ Sphere Inversion $	o$ Scale $	o$ Shift.

**Reference:** [Wikipedia: Kleinian Group](https://en.wikipedia.org/wiki/Kleinian_group)
**Credits:** Named after **Felix Klein**.

## Parameters
- **Param A (Scale)**: Controls the size of the spheres.
- **Param B (X Offset)**: Shifts the structure horizontally.
- **Param C (Fold Size)**: Limit of the initial box fold.
- **Param D (K Factor)**: Controls the strength of the spherical inversion.

## Visuals
Resembles organic structures: coral reefs, sponge tissues, or jewelry. It lacks the hard edges of the Mandelbox.
`},"formula.pseudokleinian":{id:"formula.pseudokleinian",category:"Formulas",title:"Pseudo Kleinian",parentId:"formula.active",content:`
## The Math
A modification of the Kleinian formula that introduces a "Magic Factor" (Param D) to warp the inversion logic. It mixes the properties of a Menger Sponge with a Kleinian set.

**Reference:** [Wikipedia: Kleinian Group](https://en.wikipedia.org/wiki/Kleinian_group)

## Parameters
- **Param A (Box Limit)**: Size of the folding box.
- **Param B (Size C)**: Radius of the inversion sphere.
- **Param C (Power)**: Controls the mixing of the coordinate space.
- **Param D (Magic)**: Blends between standard Kleinian and chaotic variation.
- **Param E (Z Shift)**: Vertical offset.
- **Param F (Twist)**: Spatial twist.

## Visuals
Creates intricate, filigree-like patterns that look like carved ivory or 3D printed metal.
`},"formula.dodecahedron":{id:"formula.dodecahedron",category:"Formulas",title:"Dodecahedron",parentId:"formula.active",content:`
## The Math
Uses folding planes aligned to the 12 faces of a Dodecahedron (using the Golden Ratio $phi$).
Instead of folding into a box (Cube symmetry), it folds space into a Dodecahedron.

**Reference:** [Wikipedia: Regular Dodecahedron](https://en.wikipedia.org/wiki/Regular_dodecahedron)

## Parameters
- **Param A (Scale)**: Expansion factor.
- **Param B (Offset)**: Separation of the faces.
- **Param C/D (Rotation)**: Rotates the symmetry axis.
- **Param E (Z Shift)**: Stretches the shape.
- **Param F (Twist)**: Twists the arms of the fractal.

## Visuals
Produces soccer-ball-like symmetries, icosahedral viruses, and crystalline stars.
`},"formula.amazingsurface":{id:"formula.amazingsurface",category:"Formulas",title:"Amazing Surface",parentId:"formula.active",content:`
## The Math
A hybrid fractal that combines Menger Sponge sorting logic with Kleinian/Mandelbox inversion.
The iteration process:
1. **Sort Axes**: Like a Menger Sponge ($x < y$, etc).
2. **Box Fold**: Clamps and reflects geometry.
3. **Sphere Inversion**: The "Kleinian" part.
4. **Shift & Scale**.

## Parameters
- **Param A (Scale)**: Main scaling factor.
- **Param B (Inv Max)**: Clamps the sphere inversion radius.
- **Param C (Box Size Z)**: Stretches the folding box.
- **Param D (Trans Z)**: Z-axis shift.
- **Param E (Pre-Scale)**: Scales input before folding.
- **Param F (Thickness)**: Defines the surface thickness.
`},"formula.arisbrot":{id:"formula.arisbrot",category:"Formulas",title:"ArisBrot (Hybrid)",parentId:"formula.active",content:`
## The Math
A powerful hybrid discovered by **Dr. Aris** on Fractal Forums. It combines three distinct operations:
1. **Domain Warping:** Twists space based on Z-depth ("Reality Warp").
2. **Kaleidoscopic Fold:** Folds space diagonally (KIFS).
3. **Bulb Power:** Applies the Mandelbulb power function.

## Parameters
- **Param A (Scale)**: Scale of the KIFS fold.
- **Param B (Power)**: The exponent of the Mandelbulb finish.
- **Param C (Reality Warp)**: Strength of the domain twisting.
- **Param D (Void Radius)**: Size of the central spherical clearing.
- **Param E (Offset/Shear)**: Shifts the folding planes.
- **Param F (Warp Phase)**: Rotates the domain warp.

## Visuals
Known for creating "Sci-Fi Portal" looks with a smooth, twisted tunnel leading to a complex geometric center.
`},"formula.phoenix":{id:"formula.phoenix",category:"Formulas",title:"Phoenix 3D",parentId:"formula.active",content:`
## The Math
A 3D generalization of the Phoenix set. Unlike Julia sets which depend only on $z_n$, Phoenix depends on the *previous* iteration $z_{n-1}$.
$$ z_n = z_{n-1}^p + c + K cdot z_{n-2} $$

**Reference:** [Wikipedia: Phoenix Set](https://en.wikipedia.org/wiki/Phoenix_set)

## Parameters
- **Param A (Power)**: The main exponent.
- **Param B (Distortion Real)**: The real component of the historical influence $K$.
- **Param C (Distortion Imag)**: The imaginary component of $K$.
- **Param D (History Exp)**: Exponent applied to the previous iteration.
- **Param E (Z Stretch)**: Scales the Z-axis.
- **Param F (Twist)**: Applies spatial twist.

## Visuals
Creates distorted, stretching shapes that look like pulling taffy or molten glass.
`},"formula.buffalo":{id:"formula.buffalo",category:"Formulas",title:"Buffalo 3D",parentId:"formula.active",content:`
## The Math
Based on the "Buffalo" variation of the Mandelbrot set: $z_{n+1} = |z_n|^2 + c$.
In 3D, we apply the absolute value to coordinates *before* the rotation/power step.
Also includes a Menger-style scaling step to add structural holes.

**Reference:** [Wikipedia: Burning Ship Fractal](https://en.wikipedia.org/wiki/Burning_Ship_fractal) (Mathematical cousin)

## Parameters
- **Param A (Power)**: The exponent of the bulb function.
- **Param B (Fold Scale)**: Strength of the Menger-style scaling (cuts holes).
- **Param C (Rot X)**: Internal rotation.
- **Param D (Rot Z)**: Internal rotation.

## Visuals
Similar to the Mandelbulb but with a "furry" or "plate-like" texture due to the absolute value folds.
`},"formula.mixpinski":{id:"formula.mixpinski",category:"Formulas",title:"MixPinski",parentId:"formula.active",content:`
## The Math
A variant of the Sierpinski Tetrahedron (Tetrahedral symmetry).
It mixes the folding logic of a Sierpinski with an Analytic inversion and rotation.

**Reference:** [Wikipedia: Sierpinski Triangle (Higher Dimensions)](https://en.wikipedia.org/wiki/Sierpi%C5%84ski_triangle#Analogs_in_higher_dimensions)

## Parameters
- **Param A (Scale)**: Recursive scaling factor (usually 2.0).
- **Param B (Offset)**: Separation of child tetrahedrons.
- **Param C (Rotation)**: Spins the child elements.
- **Param D/E (Shift)**: Offsets the structure in Z/Y.
- **Param F (Twist)**: Twists the entire structure.

## Visuals
Creates "Greeble" surfacespatterns that look like highly detailed mechanical plating or cityscapes from a bird's eye view.
`},"formula.amazingsurf":{id:"formula.amazingsurf",category:"Formulas",title:"Amazing Surf",parentId:"formula.active",content:`
## The Math
A variation of the Amazing Box discovered by **Kali**. It adds a sinusoidal wave function to the iteration, creating organic, flowing forms.
$$ z 	o 	ext{Fold}(z) + sin(z) $$

**Credits:** Discovered by **Kali** (Fractal Forums).

## Parameters
- **Param A (Scale)**: Box scale.
- **Param B (Min Radius)**: Sphere fold radius.
- **Param C (Wave Freq)**: Frequency of the sine waves.
- **Param D (Wave Amp)**: Amplitude (height) of the sine waves.
- **Param E (Wave Twist)**: Twists the wave direction.
- **Param F (Vert Shift)**: Shifts the waves vertically.

## Visuals
Creates structures that look like melting machinery, flowing liquid metal, or alien biomechanical surfaces.
`},"formula.boxbulb":{id:"formula.boxbulb",category:"Formulas",title:"Box Bulb",parentId:"formula.active",content:`
## The Math
A direct hybrid of the Box Fold (Mandelbox) and the Mandelbulb.
In each iteration, it first applies a Box Fold, then feeds that result into the Mandelbulb Power function.

## Parameters
- **Param A (Power)**: Mandelbulb exponent.
- **Param B (Min Radius)**: Sphere fold inner radius.
- **Param C (Scale)**: Box fold scale.
- **Param D (Fixed Radius)**: Sphere fold outer radius.
- **Param E/F (Rotation)**: Rotates the coordinates between the Fold and the Power step.

## Visuals
Creates "Boxy Bulbs"fractals that have the general shape of a Mandelbulb but with square, mechanical surface details.
`},"formula.mengeradvanced":{id:"formula.mengeradvanced",category:"Formulas",title:"Menger Advanced",parentId:"formula.active",content:`
## The Math
An advanced version of the Menger Sponge shader with expanded control over the folding axes and shifts.

**Reference:** [Wikipedia: Menger Sponge](https://en.wikipedia.org/wiki/Menger_sponge)

## Parameters
- **Param A (Scale)**: Size multiplier (3.0 is standard).
- **Param B (Offset)**: Spacing of the sponge.
- **Param C (Rot X)**: Rotates the X-axis fold.
- **Param D (Rot Z)**: Rotates the Z-axis fold.
- **Param E (Shift)**: Linear shift applied after scaling.
- **Param F (Twist)**: Global twist.

## Visuals
Capable of generating "impossible geometry", piping systems, and Escher-like architectural loops.
`},"formula.bristorbrot":{id:"formula.bristorbrot",category:"Formulas",title:"Bristorbrot",parentId:"formula.active",content:`
## The Math
A specific algebraic variation of the Mandelbulb math.
Instead of standard spherical conversion, it uses a unique coordinate mixing strategy:
$y' = y cdot (2x - z)$
$z' = z cdot (2x + y)$

**Credits:** Discovered by **Bristor** (Fractal Forums).

## Parameters
- **Param A (Scale)**: Overall size.
- **Param B (Offset)**: Linear offset.
- **Param C/D (Rotation)**: Coordinate rotation.
- **Param E (Shift X)**: X-axis shift.
- **Param F (Twist)**: Z-axis twist.

## Visuals
Produces bulbous but distorted shapes, often with large smooth areas contrasted by sharp, bristly details (hence the name).
`},"formula.makinbrot":{id:"formula.makinbrot",category:"Formulas",title:"Makin Brot",parentId:"formula.active",content:`
## The Math
Another analytic variation discovered by a fractal forum user named **Makin**.
It uses a variation of the triplex multiplication found in the Mandelbulb but swaps axis dependencies.

**Credits:** Discovered by **Makin** (Fractal Forums).

## Parameters
- **Param A (Scale)**: Zoom/Scale of the object.
- **Param B (Offset)**: Offset vector size.
- **Param C/D (Rotation)**: Rotates the system.
- **Param E (Shift Y)**: Shifts the fractal vertically.
- **Param F (Twist)**: Twists the fractal.

## Visuals
Known for creating "Pagoda" shapes and deeply stacked, ornate structures.
`},"formula.tetrabrot":{id:"formula.tetrabrot",category:"Formulas",title:"Tetrabrot",parentId:"formula.active",content:`
## The Math
A pseudo-4D fractal. It uses a specific "Tetrahedral Squaring" function on a 4-component vector, then projects it down to 3D.

**Reference:** [Wikipedia: Quaternion](https://en.wikipedia.org/wiki/Quaternion) (Mathematical basis)

## Parameters
- **Param A (Julia C/W)**: The 4th dimensional constant.
- **Param B (Slice W)**: The 4th dimensional slice plane.
- **Param E (Rot Z)**: Rotation in the Z plane.
- **Param F (Rot X)**: Rotation in the X plane.

## Visuals
Similar to the Quaternion set but often produces more geometric, diamond-like symmetries.
`},"formula.modular":{id:"formula.modular",category:"Formulas",title:"Modular Builder",parentId:"formula.active",content:`
## The System
The Modular Builder allows you to construct your own fractal equation by chaining operations together.
Instead of a fixed equation, you drag-and-drop operations in the **Graph** tab.

## Node Types
- **Transforms**: Rotate, Scale, Translate, Twist.
- **Folds**: Box Fold, Sphere Fold, Abs, Plane Fold.
- **Fractals**: Mandelbulb, Menger.
- **Combiners (CSG)**: Union, Subtract, Intersect, Smooth Union.

## Usage
1. Open the **Graph** tab (or switch Formula to "Modular").
2. Right-click to add nodes.
3. Connect **Input (Z)** $	o$ **Nodes** $	o$ **Output (Distance)**.
4. Bind node parameters to global sliders (Param A-F) to animate them.
`},"formula.juliamorph":{id:"formula.juliamorph",category:"Formulas",title:"Julia Morph",parentId:"formula.active",content:`
## The Math
This formula creates a 3D volume by stacking 2D Julia sets along the Z-axis.
Instead of a single constant $C$, the value of $C$ interpolates from a Start value to an End value as $Z$ changes.

## Usage
1. **Start Shape**: Set using the **Julia Mode** controls (Julia X/Y/Z).
2. **End Shape**: Set using **Param D** (Real) and **Param E** (Imaginary).
3. **Height**: Controls the length of the stack.

## Slicing
This formula is often used with "Slice Thickness" to create disjointed, floating layers (like MRI scans or topographic maps).
`}},ru={"panel.formula":{id:"panel.formula",category:"Parameters",title:"Formula Parameters",content:`
This panel controls the mathematical equation that defines the fractal's shape.

## How Fractals Work (The Basics)
Fractals are generated by a **Feedback Loop**. We take a point in space ($z$), apply a formula to it, and feed the result back into the formula. We do this many times.
- If the point stays close to the center, it is "solid" (inside the fractal).
- If it shoots off to infinity, it is "empty space".

## Parameters (A-F)
The sliders **Param A** through **Param F** change the constants used in that formula. 
Because every formula is different, these parameters do different things depending on which fractal you have selected.
- **Param A** is usually the most important (Power, Scale, or Size).
- Check the **Help Library** for the specific formula (e.g. "Mandelbulb") to see exactly what each parameter does.

## Iterations
Controls how many times the loop runs.
- **Low (4-8)**: The shape looks smooth, blobby, or simple.
- **High (16-30)**: Fine details, recursive branches, and complex textures emerge.
- **Warning**: Higher iterations take more computing power.

##  Quick Edit Hotkeys
You can adjust parameters without opening the panel!
1. Hover your mouse over the 3D viewport.
2. Press keys **1, 2, 3, 4, 5, or 6**.
3. A popup slider will appear at your mouse cursor for Param A (1) through Param F (6).
`},"hybrid.mode":{id:"hybrid.mode",category:"Formulas",title:"Hybrid Mode (Box Fold)",content:`
Injects a "Mandelbox" cage around the active fractal.

## Modes
The engine has two different ways of calculating hybrids.

### 1. Standard (Fast Path)
This is the default mode. It runs a fixed loop of Box Folds *before* the main fractal iterations.
- **Performance**: Extremely fast. Zero compilation time.
- **Visual**: Creates a "Cage" or "Frame" around the fractal.
- **Limitations**: Cannot interleave folds (e.g., Box -> Bulb -> Box -> Bulb).

### 2. Advanced Mixing (Complex Path)
Click the **Lock Icon** to enable this.
This mode merges the Box Fold logic into the main iteration loop, allowing for complex **Alternating Formulas**.
- **Capabilities**: Enables **Box Skip** (interleaving) and **Swap Order**.
- **Warning**: Requires a complex shader recompilation. Toggling this on/off takes 30-60 seconds.

## Parameters
- **Box Iterations**: How many times to apply the Box Fold.
- **Scale**: The density of the box frame.
- **Min/Fixed Radius**: Controls the spherical inversion void in the center of the box.
- **Box Skip (Advanced)**: The interval between folds.
    - *Consecutive*: Box, Box, Box, Main...
    - *Every 2nd*: Box, Main, Box, Main... (Interleaved).
- **Swap Order (Advanced)**: Changes whether the Box Fold or Main Formula runs first in the loop.
`},"julia.mode":{id:"julia.mode",category:"Formulas",title:"Julia Mode",content:`
Unlocks the 4D parameter space of the fractal.

**Reference:** [Wikipedia: Julia Set](https://en.wikipedia.org/wiki/Julia_set)
**Credits:** Named after **Gaston Julia**.

## Mandelbrot vs. Julia
-   **Mandelbrot (Default)**: Each pixel represents a different *parameter* $C$. The shape is a map of "behavior". It shows where the formula explodes vs where it stays stable.
-   **Julia (Enabled)**: $C$ is fixed for the entire image (controlled by the **Julia X/Y/Z** sliders). Each pixel represents a different *starting position* $z_0$.

## Usage
1.  Enable **Julia Mode**.
2.  The shape will change significantly.
3.  Adjust **Julia X/Y/Z** sliders. You are now "morphing" the fractal.
4.  Effectively, the "Mandelbrot" shape acts as a map. If you set the Julia coordinates to a point that looks cool on the Mandelbrot map, you will explore the 3D structure of that specific coordinate.

## Animation
Animating the Julia coordinates is the best way to create "shapeshifting" organic motion loops.
`},"lfo.system":{id:"lfo.system",category:"Animation",title:"LFO Modulators",content:`
**Low Frequency Oscillators** allow you to animate parameters automatically over time.

## Usage
1. Click **+** to add an LFO.
2. Select a **Target** (e.g., Param A).
3. Choose a **Shape** (Sine, Sawtooth, Noise).
4. Adjust **Period** (Speed) and **Amplitude** (Strength).

The slider for the target parameter will show a "Ghost Knob" indicating the modulated value.
`}},nu={"ui.controls":{id:"ui.controls",category:"UI",title:"Control Deck",content:`
The Control Deck is your primary interface for manipulating the fractal.

## Docking System
The deck is designed to be flexible for multi-monitor or large screen workflows.
- **Undocking**: Click the **Undock Icon** (Square with arrow) next to a tab name to detach it into a floating window.
- **Redocking**: Close the floating window to return it to the main deck.
- **Minimizing**: Click the chevron arrow in the header to collapse the panel to the side/bottom.

## Tabs
- **Formula**: Shape structure, iterations, and core math parameters.
- **Scene**: Camera, Navigation, Fog, and Depth of Field.
- **Light** (Advanced Mode): Lighting studio (3 lights) and shadows.
- **Shading**: Surface material (PBR), Glow, and Ambient Occlusion.
- **Gradients**: Color palettes and texturing.
- **Quality**: Performance tuning, Anti-aliasing, and Resolution.
- **Graph** (Modular Mode): The node-based formula builder.
`},"ui.viewport":{id:"ui.viewport",category:"UI",title:"Viewport Interaction",content:`
The main view displays the fractal in real-time.

## Focus Picking (DOF)
To set the **Depth of Field** focal plane exactly on a subject:
1. Go to the **Scene** tab.
2. Click **Pick Focus**.
3. Click anywhere on the fractal surface in the viewport.
The camera lens will focus perfectly on that point, blurring foreground and background elements based on the **Aperture** setting.

## Light Gizmos
When the **Light Panel** is open or "Show 3d helpers" is enabled:
- Lights appear as glowing rings in 3D space.
- **Drag** a ring to move the light directly.
- **Click** a ring to open a quick-access menu for Color and Intensity.
- **Click the Anchor Icon** above a light to toggle between "Fixed" (Headlamp) and "World" modes.
`},"ui.colorpicker":{id:"ui.colorpicker",category:"UI",title:"Color Picker",content:`
The application uses a compact, high-precision **HSV Slider** system.

## Usage
- **Hue (H)**: Top bar. Shows the spectrum of colors.
- **Saturation (S)**: Middle bar. Intensity of color (Left=White, Right=Vivid).
- **Value (V)**: Bottom bar. Brightness (Left=Black, Right=Bright).

## Context Menu
**Right-click** the color swatch (square on the left) to access:
- **Copy/Paste**: Transfer hex codes between pickers.
- **History**: Quickly revert to recently used colors.
- **Presets**: Pure White/Black shortcuts.
`},"ui.gradient_editor":{id:"ui.gradient_editor",category:"UI",title:"Gradient Editor",content:`
A spline-based color ramp editor used for surface coloring.

## Interaction
- **Add Knot**: Click anywhere on the bottom track.
- **Move Knot**: Drag a knot left/right.
- **Remove Knot**: Drag a knot down (off the track) or press Delete.
- **Select Multiple**: Drag a selection box or Shift+Click knots.
- **Bias**: Drag the small diamond handle between knots to adjust the interpolation curve (Gamma).

## Context Menu
Right-click the track to:
- **Distribute**: Evenly space selected knots.
- **Invert**: Flip the gradient.
- **Double Knots**: Increase resolution.
`},"ui.histogram":{id:"ui.histogram",category:"UI",title:"Histogram & Auto-Levels",content:`
The Histogram visualizes the distribution of values across the fractal surface.

## Why is it useful?
Fractal coloring is based on mapping a value (like Orbit Trap distance) to a gradient.
If the mapping range doesn't match the actual values in the fractal, the image will look flat (all one color) or washed out.

## Controls
- **Graph**: Shows frequency of values. Tall bars mean "lots of pixels have this value".
- **Range Handles**: Drag the left/right handles to define the start/end of the gradient.
- **Auto**: Automatically analyzes the frame and sets the range to cover the most interesting data (ignoring background noise).
- **Refresh**: Manually re-scan the frame (useful if Auto is off to save performance).
`},"ui.slider":{id:"ui.slider",category:"UI",title:"Precision Sliders",content:`
All numeric inputs in the application use **Precision Draggable Sliders**.

## Interaction
- **Drag Number**: Click and hold the number display text to adjust the value. This allows values to extend beyond the visual slider's min/max limits.
- **Shift + Drag Number**: **10x Speed**. Useful for large adjustments.
- **Alt + Drag Number**: **0.1x Precision**. Useful for fine-tuning.
- **Click Number**: Switch to typing mode to enter exact values.
- **Reset**: Hover over the right edge of the slider track to reveal a hidden reset button (restores default value).

## Keyframing
If the Timeline is open and recording, changing a slider will automatically create a keyframe.
Sliders with active animations (LFO or Keyframes) will show a **Key Icon** or Highlight color.
`},"panel.drawing":{id:"panel.drawing",category:"UI",title:"Measurement & Drawing",content:`
Tools for annotated screenshots, measurements, and composition planning.

## Tools
- **Rectangle / Circle**: Select a shape type.
- **Origin Modes**:
  - **Global Zero**: Draws on the world plane $(0,0,0)$.
  - **Surface Probe**: Draws on a plane perpendicular to the camera at the exact distance of the fractal surface (like a 3D cursor).

## Keyboard Modifiers
- **Drag**: Draw shape corner-to-corner.
- **Hold Alt**: Draw from Center outward.
- **Hold Shift**: Constrain to 1:1 ratio (Perfect Square/Circle).
- **Hold X**: Snap plane to nearest World Axis (Front/Top/Side).
- **Hold Space**: Move the starting anchor point while drawing.
`},"ui.resolution":{id:"ui.resolution",category:"UI",title:"Resolution Controls",content:`
When in **Fixed Resolution** mode, an overlay appears in the top-left of the viewport.

- **Click Label**: Open a dropdown of common presets (Social Media, 4K, etc.).
- **Drag Label**: Interactively scale the resolution width/height.
- **Fill Button**: Instantly switch back to "Full Screen" mode.
`},"ui.performance":{id:"ui.performance",category:"UI",title:"Performance Monitor",content:`
The system automatically detects sustained low framerates.

- **Low FPS Warning**: Appears if the renderer struggles to maintain a usable frame rate.
- **Fix Button**: Instantly reduces the internal resolution by 25% to restore interactivity.
- **Dismiss**: Ignores the warning for this session.
`}},iu={"ui.timeline":{id:"ui.timeline",category:"Timeline",title:"Animation Timeline",content:`
The central hub for creating motion. It allows you to animate almost any parameter in the application using keyframes.

## Layout
- **Toolbar**: Playback controls, Recording toggle, and View Modes.
- **Navigator**: The mini-map strip below the toolbar. 
  - **Scroll**: Drag the bar left/right.
  - **Zoom**: Drag the edges of the active window or use the scroll wheel.
- **Track List**: On the left. Shows all animated properties grouped by category (Camera, Formula, etc.).
- **Work Area**: The main grid showing keys.
  - **Dope Sheet Mode**: View keyframes as discrete diamonds. Best for timing and retiming.
  - **Graph Editor Mode**: View keyframes as continuous curves. Best for easing and value adjustment.

## Basic Workflow
1. **Record**: Click the **Red Circle** button in the timeline toolbar.
2. **Move Playhead**: Drag the ruler to the desired frame.
3. **Change Value**: Move any slider (e.g., Param A, Light Intensity, Camera Position).
4. A keyframe is automatically created.
5. Move Playhead again and change value again.
6. Press **Space** to play.

## Selection & Editing
- **Click**: Select single key.
- **Shift+Click**: Add to selection.
- **Drag Box**: Select multiple keys.
- **Soft Selection**: Hold **Ctrl** while dragging a key to influence neighbor keys proportionally based on the radius (Rubber band effect).
- **Copy/Paste**: Use **Ctrl+C** and **Ctrl+V** to duplicate keys (works across different tracks!).
- **Delete**: Press Backspace/Delete.
`},"anim.transport":{id:"anim.transport",category:"Timeline",title:"Transport & Recording",parentId:"ui.timeline",content:`
Controls for playback and recording.

## Controls
- **Play/Pause**: Toggle playback (Hotkey: Space).
- **Stop**: Return to frame 0.
- **Record (Red Circle)**: Toggles Auto-Keyframe mode.
  - When enabled, changing ANY slider or moving the camera will automatically create a keyframe at the current time position.
- **Key Cam**: Manually captures the current camera state (Position + Rotation + Zoom) as a keyframe. Use this if you want to set a "pose" without moving the camera.
`},"anim.tracks":{id:"anim.tracks",category:"Timeline",title:"Tracks",parentId:"ui.timeline",content:`
Each animated parameter has its own **Track**.

- **Creation**: Tracks are created automatically when you add a keyframe to a parameter.
- **Visibility**: Use the Eye icon in the Graph Editor sidebar to show/hide curves.
- **Grouping**: Tracks are automatically grouped by category (Camera, Lighting, Formula) in the Dope Sheet.

## Context Menu
Right-click a track header to access:
- **Delete Track**: Removes the track and all keyframes.
- **Post Behavior**: Determines what happens after the last keyframe.
  - **Hold**: Value stays constant.
  - **Loop**: Animation repeats from the start.
  - **Ping-Pong**: Animation reverses, then repeats.
  - **Continue**: Value continues changing based on the exit velocity (Slope).
`},"anim.keyframes":{id:"anim.keyframes",category:"Timeline",title:"Keyframes & Interpolation",parentId:"ui.timeline",content:`
Keyframes store the value of a parameter at a specific time.

## Interpolation Types
Right-click a keyframe to change how the value moves *between* keys:
- **Bezier (Default)**: Smooth, curved transition. Customisable with handles in the Graph Editor.
- **Linear**: Straight line. Constant speed, sharp turns. Robotic movement.
- **Step**: Instant jump. The value holds constant until the next keyframe, then snaps instantly.

## Tangents (Graph Editor)
When using Bezier interpolation, handles control the curve slope:
- **Auto**: Automatically smooths the curve based on neighbors.
- **Flat (Ease)**: Flattens the slope to 0. Great for "Slow In / Slow Out".
- **Broken**: Allows sharp corners (incoming slope != outgoing slope).
`},"anim.graph":{id:"anim.graph",category:"Timeline",title:"Graph Editor (Curves)",parentId:"ui.timeline",content:`
A powerful F-Curve editor for fine-tuning motion dynamics.
Switch to this mode using the **Curve Icon** in the timeline toolbar.

## Toolbar Tools (Top Left)
- **Fit View / Selection**: Zooms the view to show all keys or just selected ones.
- **Normalize (N)**: Toggles "Normalized View". 
  - **Off**: Shows raw values. Good for seeing true scale.
  - **On**: Scales all curves to fit 0-1 height. Essential for comparing timing between tracks with vastly different values (e.g. Rotation vs Scale).
- **Euler Filter**: Fixes "Gimbal Lock" or rotation flips where values jump 360 degrees. Unwinds the curves to be continuous.
- **Simplify**: Drag to reduce the number of keyframes while preserving the curve shape.
- **Bake**: Resamples the curve at fixed intervals.
- **Smooth / Bounce**: Physics-based modifiers.
  - **Drag Right**: Applies Gaussian Smoothing to smooth out jitter.
  - **Drag Left**: Applies Spring Physics (Bounce) to create overshoot/elasticity.

## Curve Interaction
- **Select**: Click curve keys or drag a selection box.
- **Move**: Drag keys. Hold **Shift** to lock movement to X (Time) or Y (Value) axis.
- **Tangents**: Select a key to see its Bezier handles. Drag handles to adjust easing (Slow-in/Slow-out).
- **Extrapolation**: Dotted lines at the end of the curve visualize the Post Behavior (Loop, Ping-Pong, etc).

## Navigation
- **Alt + Right Drag**: Zoom view (Scale Time/Value).
- **Alt + Left Drag**: Pan view.
- **Double Click Ruler**: Fit view to all keyframes.
`},"anim.camera":{id:"anim.camera",category:"Animation",title:"Camera Animation",content:`
Animating the camera in a fractal is complex due to the infinite scale.

## The "Unified" Camera Key
Unlike standard 3D software which tracks X/Y/Z, this engine tracks **Unified Coordinates** (Fractal Offset + Camera Local).
To keyframe the camera:
1. Move to a position you like.
2. Click the **"KEY CAM"** button in the Timeline Toolbar.
3. This creates keys for Position (Unified) and Rotation (Euler Angles) simultaneously.

## Path Interpolation
- The engine uses **Logarithmic Interpolation** for zoom levels. This ensures that zooming from 1.0 to 1,000,000.0 feels constant speed, rather than accelerating wildly.
- Use **Fly Mode** to record natural, handheld-like motion paths, then refine them in the Graph Editor using the **Smooth** tool.
`}},su={"panel.light":{id:"panel.light",category:"Lighting",title:"Light Studio",content:`
The engine utilizes a sophisticated **Physically Based Rendering (PBR)** approximation to simulate how light interacts with the infinite surfaces of the fractal.

## Light Types
- **Point (Bulb)**: Standard light source. Has position and falloff.
- **Directional (Sun)**: Parallel rays from infinity. Has rotation only. No falloff.

## Top Bar Interaction
- **Light Orbs**: Toggle lights on/off by clicking the orbs in the top bar.
- **Drag & Drop**: Drag a light orb from the top bar directly onto the 3D viewport to place a light on the surface at that point (Raycast placement).
- **Context Menu**: Right-click the light orbs to access quick settings or help.

## The 3-Point System
You can enable up to 3 independent light sources to sculpt the 3D form.
- **Light 1 (Key)**: The primary illumination.
- **Light 2 (Fill)**: Usually placed opposite the Key light. Use a lower intensity and a cool color.
- **Light 3 (Rim)**: Placed behind the object. Creates a glowing outline.

## Gizmos
When the panel is open or **Show 3d helpers** is enabled, lights appear as glowing sprites in the viewport.
`},"light.type":{id:"light.type",category:"Lighting",title:"Light Type (Point vs Sun)",parentId:"panel.light",content:`
### Point Light (Bulb)
Emits light from a specific point in space radiating outwards.
- **Position**: X, Y, Z coordinates define the origin.
- **Falloff**: Light gets dimmer with distance (Inverse Square Law).
- **Shadows**: Perspective shadows that grow larger/softer with distance from the object.

### Directional Light (Sun)
Emits parallel light rays from infinity.
- **Position**: Irrelevant. Only **Rotation** matters.
- **Falloff**: Disabled (Infinite range). The light creates a constant wall of illumination.
- **Shadows**: Orthographic (Parallel) shadows. Ideally suited for "Sunlight" effects.
- **Visuals**: Indicated by a Sun icon (Rayed Circle) in the top bar.
`},"light.rot":{id:"light.rot",category:"Lighting",title:"Heliotrope (Direction)",parentId:"panel.light",content:`
The **Heliotrope** is a specialized control for setting the angle of Directional (Sun) lights. It maps the 3D sky dome onto a 2D circle.

### How to use
- **Center**: Light comes from directly "Forward" (relative to Camera or World, depending on Mode).
- **Edge**: Light comes from the Horizon (90 degrees).
- **Drag Dot**: Sets the specific angle.

### Parameters
- **Pitch**: Elevation angle (Up/Down). 90 is directly overhead.
- **Yaw**: Compass angle (North/South/East/West).

### Backlighting
If the dot enters the "Backlight Zone" (indicated by red/warning colors), the light is shining from *behind* the target. This creates Rim Lighting but leaves the front face dark.
`},"light.intensity":{id:"light.intensity",category:"Lighting",title:"Light Intensity & Color",parentId:"panel.light",content:`
## Intensity
Controls the energy output of the light source.
- **0.0**: Light is off.
- **1.0**: Standard physical brightness.
- **> 2.0**: High energy. Can cause **Bloom/Glow** artifacts if the surface becomes brighter than 1.0 (pure white).

**Keyframable**: Yes. Use the diamond icon in the popup menu.

## Color
Light color interacts with the **Surface Material** color via multiplication.
- A **Red Light** on a **White Surface** looks Red.
- A **Red Light** on a **Blue Surface** looks Black (physics correct).
- **Tip**: Use saturation sparingly. Pale lights often look more realistic than deep, saturated lights.
`},"light.mode":{id:"light.mode",category:"Lighting",title:"Attachment Mode (Fixed vs World)",parentId:"panel.light",content:`
Every light can be anchored in two different coordinate spaces.

### Headlamp (Fixed)
The light is parented to the **Camera**.
- **Behavior**: If you move, the light moves with you.
- **Coordinates**: $(0,0,0)$ places the light exactly inside the camera lens.
- **Use Case**: Flashlights, exploration, ensuring the fractal is always visible while flying.

### World (Anchored)
The light is parented to the **Fractal Universe**.
- **Behavior**: The light exists at a specific coordinate. You can fly past it, orbit around it, or leave it behind.
- **Use Case**: Suns, glowing artifacts, establishing a "sense of place" in a scene.
- **Note**: If you reset the camera position, World lights might end up far away. Use the **Gizmo** to find them.
`},"light.falloff":{id:"light.falloff",category:"Lighting",title:"Falloff (Inverse Square Law)",parentId:"panel.light",content:`
In the real world, light creates a sphere of influence that decays over distance. This setting controls that decay curve.
*Note: This setting is ignored for Directional Lights.*

### Falloff Type
- **Quadratic ($1/d^2$)**: Physically accurate. Light is blindingly bright near the source but fades very quickly. Use this for realistic lamps or fires.
- **Linear ($1/d$)**: Artificial decay. Light travels much further before fading. Useful for abstract scenes where you want to illuminate deep structures without over-exposing the foreground.

### Falloff Radius
- **0.0**: **Infinite Light**. The light does not decay. It shines with equal intensity at distance $0$ and distance $1,000,000$.
- **> 0.0**: The distance at which the light intensity reaches near-zero. Higher values = smaller light sphere.

**Keyframable**: Yes. Use the diamond icon.
`},shadows:{id:"shadows",category:"Lighting",title:"Raymarched Soft Shadows",parentId:"panel.light",content:`
Shadows are essential for depth perception. Without them, it is impossible to tell if a structure is floating or attached. 
In this engine, shadows can be enabled for **All 3 Lights**.

## The Tech: SDF Shadows
We do not use Shadow Maps (rasterization) or BVH Raytracing. We march a ray from the surface *towards* the light.

## Parameters
- **Softness**: Simulates the **Size** of the light source (Area Light).
  - **Low (2-10)**: Pin-point light source. Sharp, hard shadows.
  - **High (50-128)**: Large panel light. Soft, diffuse shadows (Penumbra).
- **Intensity**: The opacity of the shadow. Lower this to simulate ambient light filling in the dark spots.
- **Bias**: **Critical Setting**.
  - Pushes the shadow start point away from the surface.
  - **Too Low**: "Shadow Acne" (Black noise/speckles on the surface).
  - **Too High**: "Peter Panning" (Shadow detaches from the object).

## Stochastic Sampling
The engine uses **Stochastic Sampling** for shadow calculation. 
- Shadows may appear noisy or grainy while the camera is moving.
- They will converge to a high-quality soft shadow instantly when the camera stops (via Temporal Accumulation).
- This technique is required for accurate shadowing on complex sponge/box fractals where traditional methods fail.
`},"light.pos":{id:"light.pos",category:"Lighting",title:"Light Positioning",parentId:"panel.light",content:`
> **REQUIRES ADVANCED MODE**

Precise coordinate control for lights. 
- **Headlamp Mode**: Coordinates are relative to the camera view.
- **World Mode**: Coordinates are absolute in the fractal universe.

**Keyframing**: Use the **Key Icon** in the top bar popup to keyframe the X, Y, and Z coordinates simultaneously.
`}},lu={"panel.render":{id:"panel.render",category:"Rendering",title:"Shading & Materials",content:`
Controls the surface properties (PBR) and lighting response of the fractal.
`},"panel.quality":{id:"panel.quality",category:"Rendering",title:"Quality & Performance",content:`
Managing performance is a trade-off between speed and accuracy.

## Core Settings
- **Ray Detail**: Multiplies the epsilon (precision). Lower = Faster but "blobbier". Higher = Sharper but slower.
- **Max Steps** (Advanced): Hard limit on ray calculation. Increase if distant objects are getting cut off (black void).
- **Internal Scale**: Renders at a lower resolution and upscales.
  - **0.5x**: Great for editing/animation. 
  - **1.0x**: Native crispness.
  - **2.0x**: Super-sampling (very slow).
`},"render.engine":{id:"render.engine",category:"Rendering",title:"Render Engine Mode",parentId:"panel.quality",content:`
Switches the fundamental light transport algorithm.

### Direct (Fast)
Standard Raymarching with direct lighting.
- **Fast**: Up to 60FPS on decent GPUs.
- **Features**: Shadows, AO, Fog.
- **Best for**: Exploration, Animation, Real-time usage.

### Path Tracer (GI)
Physically based Monte-Carlo Path Tracing.
- **Slow**: Requires accumulation (image starts noisy and clears up).
- **Features**: Global Illumination (Bounce Light), Emissive Lighting, Soft Area Shadows.
- **Best for**: High-quality still images and photorealistic renders.
`},"pt.global":{id:"pt.global",category:"Rendering",title:"Path Tracer Globals",parentId:"panel.render",content:`
Settings specific to the Path Tracing engine.

- **Bounces**: Number of times light reflects. Higher = brighter interiors but slower render.
- **GI Strength**: Artificial multiplier for bounce light.
- **Stochastic Shadows**: If enabled, treats lights as physical spheres (Area Lights) rather than points. Shadows become softer with distance. Requires accumulation to look smooth.
`},"bucket.render":{id:"bucket.render",category:"Rendering",title:"High Quality Render (Buckets)",parentId:"panel.quality",content:`
Renders the image in small tiles (Buckets) instead of all at once.

## Why use it?
- **High Resolution**: Allows rendering 4K or 8K images that would otherwise crash the GPU memory.
- **Anti-Aliasing**: Each bucket is allowed to accumulate samples until it is perfectly noise-free before moving to the next.
- **Export**: Can automatically save the result as a PNG when finished.

## Usage
1. Click the **Grid Icon** in the top bar.
2. Select **Refine View** to clear up the current viewport.
3. Select **Export Image** to render and download a file.
`},"quality.detail":{id:"quality.detail",category:"Rendering",title:"Ray Detail (Epsilon)",parentId:"panel.quality",content:`
Controls the termination threshold of the raymarcher.

- **1.0 (Standard)**: Stops when ray is within 1 pixel size of the surface.
- **< 1.0 (Low)**: Stops earlier. Faster rendering, but surfaces look "puffy" or "blobby". Small details merge together.
- **> 1.0 (High)**: Forces the ray closer to the surface. Sharpens tiny details but requires significantly more steps (slower).
`},"quality.fudge":{id:"quality.fudge",category:"Rendering",title:"Slice Optimization (Fudge)",parentId:"panel.quality",content:`
Scales the raymarch step size. Also known as "Lipschitz Bound Relaxation".

- **1.0 (Safe)**: Mathematically correct stepping. Guarantees no artifacts.
- **< 1.0 (Slow/Safe)**: Takes smaller steps. Fixes "overstepping" artifacts (holes in the fractal) but is very slow.
- **> 1.0 (Fast/Risky)**: Takes larger steps. Renders much faster, but may clip through thin geometry, creating black noise or missing details.
`},"quality.threshold":{id:"quality.threshold",category:"Rendering",title:"Pixel Threshold",parentId:"panel.quality",content:`
An adaptive quality optimization. It relaxes the detail requirement for distant objects.
Increasing this makes the background render faster by allowing it to be slightly blurrier, which is often physically realistic (atmospheric scattering limits detail visibility at range).
`},"quality.steps":{id:"quality.steps",category:"Rendering",title:"Max Steps",parentId:"panel.quality",content:`
> **REQUIRES ADVANCED MODE**

The "Fuel Tank" for the ray.
If a ray marches for **N** steps and hasn't hit anything, it gives up (returns Sky color).
- **Low (100)**: Rays die quickly. Deep crevices or distant objects appear as flat black voids.
- **High (500+)**: Rays can travel into deep holes. Required for high zoom levels or very complex sponges. Significantly impacts performance.
`},"quality.scale":{id:"quality.scale",category:"Rendering",title:"Internal Resolution Scale",parentId:"panel.quality",content:`
Controls the resolution of the internal render buffer relative to the screen.

- **0.25x - 0.5x**: Retro/Pixelated look. Extremely fast. Great for complex editing on low-end devices.
- **1.0x**: Native resolution.
- **1.5x - 2.0x**: Super-sampling (SSAA). Renders at a higher resolution and scales down. Eliminates aliasing but is very expensive (4x the pixels).
`},"quality.tss":{id:"quality.tss",category:"Rendering",title:"Temporal Anti-Aliasing (TSS)",parentId:"panel.quality",content:`
**Temporal Super Sampling** is the secret sauce of this engine.

### How it works
Instead of trying to render a perfect image in 16ms (60fps), the engine renders a "noisy" image quickly. It then blends this frame with the previous frame.
Over the course of 10-20 frames, the noise cancels out, revealing a perfect, high-resolution, soft-shadowed image.

### Usage
- **Enabled (Default)**: Image is noisy when moving, but crystal clear when still.
- **Disabled**: Image is always sharp but lacks soft shadows/AO, or runs at very low FPS.
`},"mat.diffuse":{id:"mat.diffuse",category:"Rendering",title:"Diffuse Strength",parentId:"panel.render",content:`
The base brightness of the surface color.
- **1.0**: Standard brightness.
- **> 1.0**: Boosts color saturation and brightness artificially.
- **0.0**: Surface is black (unless Specular/Emission is active).
`},"mat.metallic":{id:"mat.metallic",category:"Rendering",title:"Metallic",parentId:"panel.render",content:`
Controls the surface conductivity and energy conservation.

- **0.0 (Dielectric)**: Plastic, Wood, Stone. 
  - Reflection color is **White** (4%).
  - Diffuse color is active.
- **1.0 (Metal)**: Gold, Chrome, Iron. 
  - Reflection color is **Tinted** by the surface gradient.
  - Diffuse color is disabled (Metals don't have diffuse scattering).
`},"mat.specular":{id:"mat.specular",category:"Rendering",title:"Specular Intensity",parentId:"panel.render",content:`
The strength of the light reflection (F0).
Even non-metals have some reflection.
- **Increase** to make the surface look wet or shiny.
- **Decrease** for a dry, matte look.
`},"mat.roughness":{id:"mat.roughness",category:"Rendering",title:"Roughness",parentId:"panel.render",content:`
Micro-surface detail.
- **0.0 (Smooth)**: Mirror-like reflections. Sharp highlights.
- **1.0 (Rough)**: Concrete/Chalk. Diffuse reflections. Highlights are spread out and dim.
`},"mat.rim":{id:"mat.rim",category:"Rendering",title:"Rim Light",parentId:"panel.render",content:`
Adds a glowing edge effect based on the viewing angle (Fresnel).
Useful for separating the fractal from the background or adding an "Alien" feel.

- **Rim Light**: Intensity of the edge glow.
- **Rim Sharpness**: Controls the width of the edge. Higher values make the rim thinner and sharper.
`},"mat.emission":{id:"mat.emission",category:"Rendering",title:"Self-Illumination",parentId:"panel.render",content:`
Makes the surface glow independently of light sources.

### Emission Sources
- **Full Surface**: The entire object glows using its final blended color.
- **Layer 1/2**: Only uses the specific gradient layer for the glow color. Useful for making just the "veins" (Layer 2) glow while the base rock (Layer 1) stays dark.
- **Layer 3 (Noise)**: Uses the procedural noise pattern to drive the glow intensity. Great for "magma cracks" or energy fields.
- **Solid Color**: Forces a specific, constant glow color everywhere.

### Path Tracing (GI)
In Path Tracing mode, the **Illumination Power** slider controls how much light the surface emits into the scene (Global Illumination) without changing how bright the surface looks to the camera.
- **1.0**: Physically accurate.
- **> 1.0**: Boosts the bounce light intensity. Great for making dim emissive veins light up a whole room without blowing out the surface detail.
`},"mat.env":{id:"mat.env",category:"Rendering",title:"Environment Map",parentId:"panel.render",content:`
Adds a fake sky reflection to the surface.
Useful for making metals look realistic by giving them something to reflect, even if the background is black.
`},"mat.glow":{id:"mat.glow",category:"Rendering",title:"Volumetric Glow",parentId:"panel.render",content:`
Accumulates light along the ray as it passes *near* fractal surfaces (without hitting them).

- **Intensity**: How bright the air is.
- **Tightness**: How close to the surface the glow hugs. 
  - **Low**: General foggy haze.
  - **High**: Neon outlines around geometry (Tron look).
`},"mat.ao":{id:"mat.ao",category:"Rendering",title:"Ambient Occlusion (AO)",parentId:"panel.render",content:`
Darkens crevices and holes to add depth perception.

- **Intensity**: Darkness of the shadows.
- **Spread**: Radius of the sampling. Larger spread = larger soft shadows in corners.
- **Mode**:
  - **Fast**: 6 fixed samples. Good for editing.
  - **High**: Stochastic sampling. Requires TSS (Accumulation) to look good, but produces photorealistic shading.

### Interaction with Emission
Ambient Occlusion acts as a multiplier for Self-Illumination and Rim Light. This allows "dirt" or crevices to darken glowing parts of the surface, adding realism to magma/energy cracks.

### Path Tracing
In Path Tracer mode, AO is applied **only to the direct camera view**. It is disabled for indirect light bounces to preserve the energy of the Global Illumination system.
`},"fog.settings":{id:"fog.settings",category:"Rendering",title:"Atmospheric Fog",parentId:"panel.scene",content:`
Adds depth cues by fading distant objects to a color.

- **Start (Near)**: Distance where fog begins.
- **Density (Far)**: Distance where everything becomes solid fog color.
- **Volumetric Density**: Adds a constant "thickness" to the air, making light shafts and distance haze visible even without geometry.
`},"dof.settings":{id:"dof.settings",category:"Rendering",title:"Depth of Field (DOF)",parentId:"panel.scene",content:`
Simulates a physical camera lens.

- **Aperture (Blur)**: Strength of the blur. 0.0 = Pinhole camera (infinite focus).
- **Focus Distance**: Distance to the sharp plane.
- **Auto-Focus**: Use the "Pick Focus" button in the Scene tab to click a point and set this value automatically.

**Note**: DOF requires **Temporal Accumulation** to look smooth. It uses stochastic jittering of the camera ray.
`},"export.video":{id:"export.video",category:"Export",title:"Video Export",content:`
Allows rendering high-quality video sequences offline.

### Browser Compatibility (Disk vs RAM)
Because 4K video files are huge, the exporter works differently depending on your browser.

- **Disk Mode (Chrome / Edge / Opera)**: Uses direct file access. When you click Render, you will be asked where to save the file immediately. The video is streamed directly to your hard drive, allowing unlimited file sizes (perfect for 4K).
- **RAM Mode (Firefox / Safari)**: Must store the *entire video* in memory until finished.
  - **Warning**: If the video file exceeds ~2GB-4GB, the browser tab will crash (Out of Memory).
  - **Workaround**: For long animations in these browsers, render shorter segments and stitch them later in a video editor.

### Settings
- **Resolution**: Includes social presets (Square 1:1, Portrait 4:5, Vertical 9:16).
- **Bitrate**: Higher = Less compression artifacts. 12-20 Mbps is usually sufficient for 1080p.
- **Samples**: How many accumulation passes per frame. 
  - 16-32: Good for Draft.
  - 64-128: Production Quality (removes all grain).
`}},cu={"panel.gradient":{id:"panel.gradient",category:"Coloring",title:"Coloring Engine",content:`
Fractals don't have "texture maps" in the traditional sense. Color is assigned mathematically based on the geometry.

## The Process
1. **Mapping**: The engine measures a specific value at the surface point (e.g., "How far is this point from the origin?").
2. **Transform**: This value is transformed using Scale, Offset, Phase, and Repeat sliders.
3. **Lookup**: The final value (0.0 to 1.0) is used to pick a color from the **Gradient**.

## Dual-Layer System
You can blend two completely different coloring strategies to create complex surfaces.
- **Layer 1**: The Base color.
- **Layer 2**: Detail or Overlay color.
- **Blend Mode**: Determines how they combine (Mix, Add, Multiply, Bump).
`},"grad.mapping":{id:"grad.mapping",category:"Coloring",title:"Mapping Modes",parentId:"panel.gradient",content:`
Determines the mathematical property used to select color from the gradient.

### Geometric Mappings
- **Orbit Trap**: Uses the *minimum distance* the orbit point reached relative to the origin during iteration. Creates geometric, cellular, or techno-organic patterns inside the bulbs. Good for "solid" looking interiors.
  - **Reference:** [Wikipedia: Orbit Trap](https://en.wikipedia.org/wiki/Orbit_trap)
- **Radial**: Based on the distance of the final surface point from the center $(0,0,0)$. Creates spherical gradients and large-scale color shifts.
- **Z-Depth**: Height map based on the Z coordinate. Useful for creating landscapes or strata effects.
- **Angle**: Based on the polar angle around the Z-axis. Creates spirals and pinwheels.
- **Normal**: Based on the surface slope (Up vs Down). Adds pseudo-lighting effects or "snow on peaks" looks.

### Fractal Mappings
- **Iterations (Glow)**: Based on how many iterations it took to decide the point was "solid". Creates smooth, glowing bands outlining the shape. The classic "Electric Sheep" look.
- **Raw Iterations**: Same as Iterations but without smoothing. Shows distinct bands or steps. Useful for technical analysis or stylized "8-bit" looks.
- **Decomposition**: Analytic decomposition of the complex number angles during iteration. Creates checkered, grid-like, or circuit-board patterns. Highly sensitive to the **Escape Radius**.
- **Potential (Log-Log)**: Measures the electrical potential of the set. Creates very smooth, gradient-like bands, especially near the boundaries of the fractal. Ideal for continuous color flows.
`},"grad.escape":{id:"grad.escape",category:"Coloring",title:"Escape Radius",parentId:"panel.gradient",content:`
The distance from the origin ($R$) at which the formula considers a point to have "escaped" to infinity.

### Impact on Coloring
- **Standard**: Usually around 2.0 to 4.0.
- **Decomposition**: Requires a higher escape radius (e.g., 10.0 - 100.0) to allow the "grid" pattern to resolve fully before the calculation stops. If your decomposition pattern looks noisy or cut off, increase this value.
- **Glow**: Higher values can compress the glow bands slightly.

**Performance Note**: Higher escape radii generally mean more iterations are needed to reach the edge, which can slightly reduce performance or require increasing the **Max Iterations** count.
`},"grad.layer2":{id:"grad.layer2",category:"Coloring",title:"Layer 2 & Blending",parentId:"panel.gradient",content:`
Layer 2 adds surface complexity by overlaying a second pattern on top of the base layer.

### Blend Modes
- **Mix**: Linear interpolation. At 0.5 opacity, the result is 50% Layer 1 and 50% Layer 2.
- **Add**: Adds brightness. Useful for creating glowing veins or energy overlays.
- **Multiply**: Darkens the base color. Great for adding grime, shadows, or ambient occlusion style darkening.
- **Overlay**: Increases contrast. Light parts get lighter, dark parts get darker. Preserves highlights and shadows.
- **Bump (Normal)**: **Does not change color!** Instead, it uses the brightness of Layer 2 to perturb the surface **Normal**.
  - Creates the illusion of physical depth, scratches, or embossing.
  - Requires **Shading** (Lighting) to be visible.
`},"grad.texture":{id:"grad.texture",category:"Coloring",title:"Image Texturing",parentId:"panel.gradient",content:`
Instead of a 1D gradient, you can map a 2D image onto the fractal surface.

### UV Generation
Since fractals are infinite and generated procedurally, they have no native UV coordinates. We must generate them mathematically.
- **U Mapping**: Selects the property for the horizontal (X) texture coordinate.
- **V Mapping**: Selects the property for the vertical (Y) texture coordinate.

### Tips for Good Texturing
- **Decomposition** on U and **Iterations** on V often produces a mapping that follows the natural flow of the fractal structures (like uv-unwrapping).
- **Radial** mapping on both axes can create spherical projection effects.
- **Texture Scale**: Controls how many times the image repeats. High values create detailed surface grain; low values project the image across the whole object.
- **Seamless Textures**: Use tileable images to avoid visible seams.
`},"grad.noise":{id:"grad.noise",category:"Coloring",title:"Procedural Noise",parentId:"panel.gradient",content:`
Adds fine surface detail using a 3D Simplex Noise function calculated in real-time.

### Parameters
- **Scale**: The size of the noise grain. 
  - High values (100+) create dusty, sandy, or metallic grain.
  - Low values (1-10) create large blobs or camouflage patterns.
- **Turbulence**: Distorts the noise coordinate space, creating marble-like swirls and fluid distortions.
- **Bump**: Uses the noise value to perturb the surface normals.
  - Positive values create bumps.
  - Negative values create pits/dents.
  - Essential for realistic rock, rust, or concrete surfaces.
- **Mix Strength**: Blends the noise color (single color) with the gradient colors.
`}},du={"ui.graph":{id:"ui.graph",category:"Graph",title:"Modular Graph Editor",content:`
The **Modular Formula** allows you to build your own fractal equation by chaining operations together.

## How it works
Standard formulas (like Mandelbulb) are hard-coded loops:
$z 	o z^8 + c$

The Graph allows you to insert steps:
$z 	o Rotate 	o Fold 	o Scale 	o z^8 + c$

## Node Types
- **Transform**: Rotate, Scale, Translate. Modifies the coordinate space.
- **Fold**: BoxFold, SphereFold, Abs. The core of fractal complexity. Reflects space back onto itself.
- **Logic**: Modulo (Repeat space), Conditions.
- **Combiners**: Union, Subtract. Combines shapes (Constructive Solid Geometry).

## Bindings
You can link any node parameter (like "Rotation X") to a global slider (Param A-F).
1. Click the **Link Icon** next to a node slider.
2. It cycles through Param A, B, C...
3. Now, changing Param A in the main UI will drive that specific node value. This allows you to animate complex graphs easily.
`}},uu={"panel.scene":{id:"panel.scene",category:"UI",title:"Scene Panel",content:`
Configures the camera, navigation physics, and atmospheric optics.

## Sections
- **Camera & Navigation** (Advanced Mode Only): Movement mode, speed, and absolute coordinates.
- **Atmosphere**: Distance fog and volumetric density.
- **Optics**: Field of view and Depth of Field (blur).
`},"scene.grading":{id:"scene.grading",category:"UI",title:"Color Correction",parentId:"panel.scene",content:`
Post-processing adjustments applied to the final image.

## Controls
- **Saturation**: Controls color intensity. 0.0 is Grayscale, 1.0 is Normal, >1.0 is Vivid.
- **Histogram & Levels**:
  - **Black Point (Min)**: Any pixel darker than this becomes pure black. Increasing this adds contrast.
  - **White Point (Max)**: Any pixel brighter than this becomes pure white.
  - **Gamma**: Non-linear brightness curve. Adjusts mid-tones without crushing blacks or whites.
`},"cam.mode":{id:"cam.mode",category:"UI",title:"Camera Mode",parentId:"panel.scene",content:`
> **REQUIRES ADVANCED MODE**

Determines how the camera moves through the fractal.

## Orbit Mode
The camera rotates around a pivot point.
- **Left Click**: Rotate around target.
- **Right Click**: Pan target.
- **Scroll**: Zoom in/out.
- **Precision**: When you release the mouse, the engine automatically re-centers the coordinate system around your new pivot point. This ensures you can zoom infinitely into details without losing floating-point precision.

## Fly Mode
First-person free flight, similar to a drone or spacecraft.
- **WASD**: Move horizontally.
- **Space/C**: Move Up/Down.
- **Q/E**: Roll.
- **Shift**: Speed Boost (4x).
- **Best For**: Exploration, cinematic fly-throughs, and navigating inside tunnels.
`},"cam.fov":{id:"cam.fov",category:"UI",title:"Field of View (FOV)",parentId:"panel.scene",content:`
Controls the zoom angle of the camera lens (in degrees).

- **High FOV (90+)**: "Fish-eye" look. Increases sense of speed and scale. Great for flying inside tunnels.
- **Low FOV (10-30)**: "Telephoto" look. Flattens depth. Great for macro photography of small details.
- **Standard (60)**: Natural human vision balance.
`},"cam.position":{id:"cam.position",category:"UI",title:"Absolute Position",parentId:"panel.scene",content:`
> **REQUIRES ADVANCED MODE**

The raw coordinate of the camera in fractal space.

## Precision Note
Due to the "Infinite Zoom" engine, this value combines the **Offset** (the position of the universe) and the **Local Camera** (relative position).
Editing these values directly allows for precise teleportation, but be careful: large jumps may land you inside solid geometry (black screen).
`},"dof.settings":{id:"dof.settings",category:"Rendering",title:"Depth of Field (DOF)",parentId:"panel.scene",content:`
Simulates a physical camera lens.

- **Aperture (Blur)**: Strength of the blur. 0.0 = Pinhole camera (infinite focus). 
  - The blur effect accumulates over time when the camera is stationary.
  - During camera movement, DOF is temporarily disabled for a stable preview.
  - Supports **High Precision** (down to $0.0001$) for macro photography.
- **Focus Distance**: Distance to the sharp plane.
- **Auto-Focus**: Use the "Pick Focus" button in the Scene tab to click a point and set this value automatically.

**Note**: DOF requires **Temporal Accumulation** to look smooth. It uses stochastic jittering of the camera ray.
`}},fu={"effect.droste":{id:"effect.droste",category:"Effects",title:"Escher Droste (Spiral)",content:`
The Droste effect recursively maps an image inside itself, creating infinite spirals or loops. This implementation is mathematically based on M.C. Escher's "Print Gallery".

**Reference:** [Wikipedia: Droste Effect](https://en.wikipedia.org/wiki/Droste_effect)
**Artistic Origin:** [M.C. Escher: Print Gallery](https://en.wikipedia.org/wiki/Print_Gallery_(M._C._Escher))

## How it works
It transforms the screen coordinates from **Cartesian** ($x, y$) to **Log-Polar** space. 
This turns scaling (zooming) into a linear shift, allowing us to repeat the image periodically as it shrinks towards the center.

## Key Controls
- **Inner/Outer Radius**: Defines the "Ring" (Annulus) where the image lives. The ratio between these determines how fast the spiral shrinks.
- **Periodicity**: How many times the image repeats per spiral loop.
- **Strands**: Number of separate spiral arms.
`},"droste.geometry":{id:"droste.geometry",category:"Effects",title:"Geometry & Tiling",parentId:"effect.droste",content:`
Controls the physical bounds of the spiral.

- **Inner Radius ($r_1$)**: The size of the "hole" in the center.
- **Outer Radius ($r_2$)**: The outer edge of the image.
- **Tiling**:
  - **Repeat**: Standard tile.
  - **Mirror**: Flips every other tile. Essential for seamless spirals if the image edges don't match.
  - **Clamp**: Stretches the edge pixels (Smear effect).
  - **Transparent**: Only draws the spiral ring, leaving the center/outside empty (or showing the background).
- **Center Shift**: Moves the vanishing point of the spiral.
`},"droste.structure":{id:"droste.structure",category:"Effects",title:"Spiral Structure",parentId:"effect.droste",content:`
Controls the math of the repetition.

- **Periodicity ($P_1$)**: The repetition frequency.
  - **1.0**: Image repeats once per full rotation.
  - **2.0**: Image repeats twice (180 symmetry).
- **Strands ($P_2$)**: The number of "arms" in the spiral.
  - **1**: Single continuous tunnel.
  - **2**: Double helix structure.
- **Auto Period**: Mathematically calculates the perfect Periodicity based on the Radius ratio ($r_2/r_1$) to prevent distortion. Recommended to keep this **ON** unless you want artistic stretching.
- **Mirror Strand**: Alters the rotation logic to align strands seamlessly when using Mirror Tiling.
`},"droste.transform":{id:"droste.transform",category:"Effects",title:"Transform & Distortion",parentId:"effect.droste",content:`
- **Zoom**: Moves the camera *into* the spiral. Because the spiral is infinite, zooming eventually brings you back to the start (just deeper).
- **Rotate**: Standard 2D rotation of the whole frame.
- **Twist**: The core "Escher" switch.
  - **On**: Log-Polar mapping (Spiral).
  - **Off**: Standard Log mapping (Tunnel/Grid).
- **Hyper Droste**: Applies a complex sine function, turning the spiral into a Fractal-like shape.
- **Fractal Points**: When Hyper Droste is on, determines the number of branches/tips in the fractal structure.
`}},pu={"panel.audio":{id:"panel.audio",category:"Audio",title:"Audio Engine",content:`
The Audio Engine analyzes sound frequencies in real-time to drive fractal parameters, allowing the visual to react to music or voice.

## How it works
1. **Source**: Select an audio input (Microphone, System Audio, or File).
2. **Spectrum**: The engine breaks the sound into frequencies (Bass on left, Treble on right).
3. **Links**: You create "Links" that map a specific frequency range (e.g., the kick drum) to a specific parameter (e.g., Scale).

## Performance
The audio analysis runs on a separate thread context (WebAudio API) and is very lightweight. However, modulating complex geometry parameters (like Loop Iterations) every frame can impact GPU performance.
`},"audio.sources":{id:"audio.sources",category:"Audio",title:"Input Sources",parentId:"panel.audio",content:`
Select where the audio data comes from.

- **Microphone**: Uses your default recording device. Great for voice reactivity or ambient room noise.
- **Desktop (System Audio)**: Captures audio from other tabs or applications. 
  - *Note*: When the browser dialog appears, you must check the **"Share System Audio"** box, otherwise only video is shared.
- **Load File**: Plays a local audio file (MP3/WAV) in a loop.
`},"audio.links":{id:"audio.links",category:"Audio",title:"Modulation Links",parentId:"panel.audio",content:`
A **Link** connects a slice of the audio spectrum to a fractal parameter.

## Frequency Selection
Drag the **box** on the spectrum view to define the frequency range.
- **Left (Bass)**: Kick drums, basslines.
- **Middle (Mids)**: Vocals, synths, guitars.
- **Right (Treble)**: Hi-hats, cymbals, air.

## Dynamics (Knobs)
- **Threshold (Gate)**: Drag the top/bottom edges of the box. Signals below the bottom edge are ignored (noise gate). Signals above the top edge are clamped (ceiling).
- **Gain**: Multiplies the output signal. Use this if the reaction is too subtle.
- **Attack**: How fast the value rises when a sound hits. Low = Snappy, High = Smooth.
- **Decay**: How fast the value falls after the sound stops. High decay creates a "trailing" effect.
- **Offset**: Adds a base value to the parameter, so it doesn't drop to zero when silent.
`}},Ct={...tu,...au,...ou,...ru,...nu,...iu,...su,...lu,...cu,...du,...uu,...fu,...pu},Gn=({x:a,y:t,items:o,targetHelpIds:r,onClose:n,onOpenHelp:i,isSubmenu:s})=>{const l=v.useRef(null),[d,c]=v.useState({x:a,y:t,opacity:0}),[f,u]=v.useState(null),p=v.useRef(null);v.useLayoutEffect(()=>{if(!l.current)return;const m=l.current.getBoundingClientRect(),y=window.innerWidth,x=window.innerHeight,C=8;let k=a,S=t;s?k+m.width>y-C&&(k=a-m.width-200,k=y-m.width-C):k+m.width>y-C&&(k=a-m.width),S+m.height>x-C&&(S=Math.max(C,x-m.height-C)),k=Math.max(C,Math.min(k,y-m.width-C)),S=Math.max(C,Math.min(S,x-m.height-C)),c({x:k,y:S,opacity:1})},[a,t,o,r,s]),v.useEffect(()=>{if(s)return;const m=x=>{x.target.closest(".fractal-context-menu")||n()},y=setTimeout(()=>window.addEventListener("mousedown",m),50);return()=>{clearTimeout(y),window.removeEventListener("mousedown",m)}},[n,s]);const h=r.map(m=>Ct[m]).filter(m=>!!m),g=(m,y)=>{if(p.current&&clearTimeout(p.current),m.children){const x=y.currentTarget.getBoundingClientRect();u({items:m.children,x:x.right,y:x.top})}else u(null)},M=e.jsxs("div",{ref:l,className:"fractal-context-menu fixed z-[9999] bg-[#1a1a1a] border border-white/20 rounded shadow-[0_4px_20px_rgba(0,0,0,0.8)] py-1 min-w-[200px] animate-fade-in [&_.animate-slider-entry]:!animate-none",style:{left:d.x,top:d.y,opacity:d.opacity},onContextMenu:m=>m.preventDefault(),children:[o.map((m,y)=>{var x;return m.element?e.jsx("div",{children:m.element},y):m.isHeader?e.jsx("div",{className:"px-4 py-1 text-[9px] text-gray-500 font-bold uppercase tracking-wider border-b border-white/10 mt-1 mb-1 bg-white/5",children:m.label},y):m.type==="slider"?e.jsx("div",{className:"px-3 py-1 mb-1",children:e.jsx(Me,{label:m.label||"",value:m.value??0,min:m.min??0,max:m.max??1,step:m.step??.01,onChange:C=>m.onChange&&m.onChange(C),highlight:!0,overrideInputText:(x=m.value)==null?void 0:x.toFixed(2)})},y):e.jsxs("button",{onClick:()=>{!m.disabled&&!m.children&&m.action&&(m.action(),m.keepOpen||n())},onMouseEnter:C=>g(m,C),disabled:m.disabled,className:`w-full text-left px-4 py-2 text-xs flex items-center justify-between transition-colors group relative ${m.disabled?"text-gray-600 cursor-not-allowed opacity-50":m.danger?"text-red-400 hover:bg-red-900/30 hover:text-red-300":"text-gray-300 hover:bg-white/10 hover:text-white"}`,children:[e.jsxs("div",{className:"flex items-center gap-2",children:[m.icon&&e.jsx("span",{className:m.disabled?"text-gray-600":"text-gray-500",children:m.icon}),e.jsx("span",{className:m.checked?"text-cyan-400 font-bold":"",children:m.label})]}),m.checked&&e.jsx(xt,{}),m.children&&e.jsx(Xt,{})]},y)}),o.length>0&&h.length>0&&e.jsx("div",{className:"h-px bg-white/10 my-1"}),h.length>0&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"px-4 py-1 text-[9px] text-cyan-700 font-bold uppercase tracking-wider mb-1 flex items-center gap-2",children:[e.jsx(Mn,{})," Context Help"]}),h.map((m,y)=>e.jsxs("button",{onClick:()=>{i(m.id),n()},className:`w-full text-left px-4 py-1.5 text-xs transition-colors flex items-center gap-2 group ${y===0?"text-cyan-400 hover:bg-cyan-900/30 hover:text-cyan-200 font-bold":"text-gray-400 hover:bg-white/5 hover:text-white"}`,style:{paddingLeft:`${16+y*8}px`},children:[y>0&&e.jsx("span",{className:"opacity-30 text-[8px]",children:""}),e.jsx("span",{children:m.title}),y===0&&e.jsx("span",{className:"ml-auto opacity-0 group-hover:opacity-100 transition-opacity",children:e.jsx(Il,{})})]},m.id))]}),f&&e.jsx(Gn,{x:f.x,y:f.y,items:f.items,targetHelpIds:[],onClose:n,onOpenHelp:i,isSubmenu:!0})]});return s?M:wt.createPortal(M,document.body)},Xa=["General","Formulas","Parameters","UI","Timeline","Graph","Animation","Lighting","Rendering","Coloring","Audio","Effects","Export"],hu=({activeTopicId:a,onClose:t,onNavigate:o})=>{const[r,n]=v.useState(""),[i,s]=v.useState(new Set),l=v.useRef(null),d=v.useRef({}),c=v.useRef(!1),f=v.useRef(!1),u=v.useRef(null),p=b=>{const w=[],j=new Set;let T=Ct[b];for(;T&&T.parentId;){if(j.has(T.parentId)){console.warn("Cycle detected in help topics:",b);break}j.add(T.parentId),w.push(T.parentId),T=Ct[T.parentId]}return w},h=(b,w)=>{w.stopPropagation(),s(j=>{const T=new Set(j);if(T.has(b))return T.delete(b),T;{const L=p(b);return new Set([...L,b])}})},g=a?Ct[a]:null,M=g?g.category:Xa[0],m=v.useMemo(()=>{const b={};return Object.values(Ct).forEach(w=>{r&&!w.title.toLowerCase().includes(r.toLowerCase())&&!w.content.toLowerCase().includes(r.toLowerCase())||(b[w.category]||(b[w.category]=[]),b[w.category].push(w))}),b},[r]),y=v.useMemo(()=>{let b=[];if(r)b=Object.values(Ct).filter(w=>w.title.toLowerCase().includes(r.toLowerCase())||w.content.toLowerCase().includes(r.toLowerCase())),b.sort((w,j)=>{const T=Xa.indexOf(w.category)-Xa.indexOf(j.category);return T!==0?T:w.title.localeCompare(j.title)});else{b=Object.values(Ct).filter(R=>R.category===M);const w={},j=[];b.forEach(R=>{var z;R.parentId&&((z=Ct[R.parentId])==null?void 0:z.category)===M?(w[R.parentId]||(w[R.parentId]=[]),w[R.parentId].push(R)):j.push(R)}),j.sort((R,z)=>R.title.localeCompare(z.title));const T=[],L=new Set,_=R=>{R.forEach(z=>{L.has(z.id)||(L.add(z.id),T.push(z),w[z.id]&&(w[z.id].sort((E,N)=>E.title.localeCompare(N.title)),_(w[z.id])))})};_(j),b=T}return b},[r,M]);v.useEffect(()=>{if(f.current=!0,!a||!l.current){f.current=!1;return}const b=setTimeout(()=>{const w=d.current[a];if(!w){f.current=!1;return}if(c.current){u.current&&clearTimeout(u.current),w.scrollIntoView({behavior:"smooth",block:"start"}),c.current=!1,u.current=window.setTimeout(()=>{f.current=!1},750);return}const j=w.getBoundingClientRect(),T=l.current.getBoundingClientRect();j.top>=T.top-50&&j.top<=T.top+300?f.current=!1:(u.current&&clearTimeout(u.current),w.scrollIntoView({behavior:"smooth",block:"start"}),u.current=window.setTimeout(()=>{f.current=!1},750))},50);return()=>clearTimeout(b)},[a,y]),v.useEffect(()=>{const b=l.current;if(!b)return;const w=new IntersectionObserver(j=>{if(f.current)return;const T=j.filter(L=>L.isIntersecting).sort((L,_)=>_.intersectionRatio-L.intersectionRatio);if(T.length>0){let L=T[0],_=1/0;const R=b.getBoundingClientRect().top;T.forEach(E=>{const N=Math.abs(E.boundingClientRect.top-R);N<_&&(_=N,L=E)});const z=L.target.getAttribute("data-topic-id");z&&z!==a&&!c.current&&!f.current&&o(z)}},{root:b,rootMargin:"-10% 0px -80% 0px",threshold:[0,.1,.5]});return y.forEach(j=>{const T=d.current[j.id];T&&w.observe(T)}),()=>w.disconnect()},[y,a,o]);const x=b=>{c.current=!0,o(b);const w=p(b);s(new Set([...w,b]))},C=b=>b.split(/(\*\*.*?\*\*|\$.*?\$|\[[^\]]+\]\([^)]+\))/g).map((j,T)=>{if(j.startsWith("**")&&j.endsWith("**"))return e.jsx("strong",{className:"text-white font-bold",children:j.slice(2,-2)},T);if(j.startsWith("$")&&j.endsWith("$"))return e.jsx("span",{className:"font-serif italic text-cyan-300 px-0.5 tracking-wide",children:j.slice(1,-1)},T);if(j.startsWith("[")&&j.includes("](")&&j.endsWith(")")){const L=j.match(/^\[([^\]]+)\]\(([^)]+)\)$/);if(L)return e.jsx("a",{href:L[2],target:"_blank",rel:"noopener noreferrer",className:"text-cyan-400 hover:underline hover:text-cyan-300 transition-colors cursor-pointer",onClick:_=>_.stopPropagation(),children:L[1]},T)}return j}),k=b=>b.split(`
`).map((w,j)=>{if(w.startsWith("### "))return e.jsx("h3",{className:"text-sm font-bold text-white mt-4 mb-2",children:w.replace("### ","")},j);if(w.startsWith("## "))return e.jsx("h2",{className:"text-base font-bold text-cyan-400 mt-5 mb-2 border-b border-white/10 pb-1",children:w.replace("## ","")},j);if(w.startsWith("$$")){const T=w.replace(/^\$\$\s*/,"").replace(/\s*\$\$$/,"");return e.jsx("div",{className:"font-serif italic text-center text-cyan-200 bg-black/30 p-3 rounded-lg my-3 text-sm border border-white/10 shadow-sm overflow-x-auto",children:T},j)}return w.startsWith("- ")?e.jsx("li",{className:"ml-4 text-xs text-gray-300 mb-1",children:C(w.replace("- ",""))},j):w.trim()===""?e.jsx("div",{className:"h-2"},j):e.jsx("p",{className:"text-xs text-gray-300 leading-relaxed mb-1",children:C(w)},j)}),S=b=>{const w=new Map(b.map(R=>[R.id,R])),j=new Map;b.forEach(R=>{R.parentId&&w.has(R.parentId)&&(j.has(R.parentId)||j.set(R.parentId,[]),j.get(R.parentId).push(R))});const T=b.filter(R=>!R.parentId||!w.has(R.parentId)),L=new Set,_=(R,z)=>{if(L.has(R.id))return null;L.add(R.id);const E=j.get(R.id),N=E&&E.length>0,P=a===R.id,$=i.has(R.id)||r.length>0;return e.jsxs(At.Fragment,{children:[e.jsxs("div",{className:"flex items-center w-full",children:[e.jsx("button",{onClick:()=>x(R.id),className:`flex-1 text-left py-1.5 text-xs rounded-l transition-colors truncate flex items-center ${P?"bg-cyan-900/50 text-cyan-300 border-l-2 border-cyan-500":"text-gray-400 hover:text-white hover:bg-white/5 border-l-2 border-transparent"}`,style:{paddingLeft:`${8+z*12}px`},children:e.jsx("span",{className:"truncate",children:R.title})}),N&&e.jsx("button",{onClick:O=>h(R.id,O),className:`p-2 hover:text-white transition-colors rounded-r ${P?"bg-cyan-900/50 text-cyan-400":"text-gray-600 hover:bg-white/5"}`,children:$?e.jsx(Rt,{}):e.jsx(Xt,{})})]}),N&&$&&e.jsx("div",{className:"animate-fade-in-down",children:E.map(O=>_(O,z+1))})]},R.id)};return T.map(R=>_(R,0))};return e.jsx(Yt,{title:"Library",onClose:t,initialPos:{x:100,y:100},initialSize:{width:700,height:600},zIndex:600,children:e.jsxs("div",{className:"flex h-full -m-3",children:[e.jsxs("div",{className:"w-[30%] bg-black/40 border-r border-white/10 flex flex-col shrink-0",children:[e.jsx("div",{className:"p-2 border-b border-white/10",children:e.jsx("input",{type:"text",placeholder:"Search...",value:r,onChange:b=>n(b.target.value),className:"w-full bg-gray-900 border border-gray-700 rounded px-2 py-1 text-xs text-white outline-none focus:border-cyan-500 transition-colors"})}),e.jsx("div",{className:"flex-1 overflow-y-auto custom-scroll p-2",children:Object.entries(m).map(([b,w])=>e.jsxs("div",{className:"mb-3",children:[e.jsx("div",{className:"text-[10px] font-bold text-gray-500 uppercase tracking-wider mb-1 px-2 sticky top-0 bg-[#151515]/95 z-10 backdrop-blur-sm py-1 border-b border-white/5",children:b}),S(w)]},b))})]}),e.jsxs("div",{ref:l,className:"flex-1 bg-gray-900/50 overflow-y-auto custom-scroll p-6 scroll-smooth",children:[!r&&e.jsx("div",{className:"mb-6 pb-2 border-b border-white/10",children:e.jsx("h2",{className:"text-2xl font-black text-gray-700 uppercase tracking-tighter",children:M})}),e.jsxs("div",{className:"space-y-12",children:[y.map(b=>e.jsxs("div",{id:`topic-${b.id}`,"data-topic-id":b.id,ref:w=>{d.current[b.id]=w},className:`transition-all duration-500 scroll-mt-24 ${b.id===a?"opacity-100 scale-100":"opacity-40 scale-[0.98] blur-[0.5px] grayscale hover:opacity-80 hover:grayscale-0 hover:blur-0 cursor-pointer"}`,onClick:()=>{b.id!==a&&o(b.id)},children:[e.jsxs("div",{className:"flex items-baseline justify-between border-b border-white/10 pb-2 mb-4",children:[e.jsx("h1",{className:"text-xl font-black text-white",children:b.title}),r&&e.jsx("span",{className:"text-[9px] font-mono text-gray-600 uppercase bg-black/40 px-2 py-1 rounded",children:b.category})]}),e.jsx("div",{className:"prose prose-invert prose-sm max-w-none",children:k(b.content)})]},b.id)),y.length===0&&e.jsx("div",{className:"text-center text-gray-500 italic mt-10",children:"No matching topics found."})]}),e.jsx("div",{className:"h-32 flex items-center justify-center text-gray-600 text-xs italic",children:"End of Section"})]})]})})},Ya=300,xr=60,mu=38,gu=()=>{const[a,t]=v.useState(null),o=v.useRef({x:0,y:0}),r=Y(),n=r.coreMath,{formula:i,setCoreMath:s}=r;if(!n)return null;const l={1:{key:"paramA",setter:c=>s({paramA:c}),val:n.paramA},2:{key:"paramB",setter:c=>s({paramB:c}),val:n.paramB},3:{key:"paramC",setter:c=>s({paramC:c}),val:n.paramC},4:{key:"paramD",setter:c=>s({paramD:c}),val:n.paramD},5:{key:"paramE",setter:c=>s({paramE:c}),val:n.paramE},6:{key:"paramF",setter:c=>s({paramF:c}),val:n.paramF}};if(v.useEffect(()=>{const c=p=>{o.current={x:p.clientX,y:p.clientY}},f=p=>{if(p.target.tagName==="INPUT"||p.target.tagName==="TEXTAREA")return;const h=p.key,g=l[h];if(g&&!a){const M=Le.get(i),m=parseInt(h)-1;let y=M==null?void 0:M.parameters[m];if(i==="Modular"&&(y={label:`Param ${String.fromCharCode(65+m)}`,id:g.key,min:-5,max:5,step:.01,default:0}),y){const x=y.max-y.min,C=(g.val-y.min)/x,k=Ya-24,S=12+C*k;let b=o.current.x-S,w=o.current.y-mu;b=Math.max(10,Math.min(window.innerWidth-Ya-10,b)),w=Math.max(10,Math.min(window.innerHeight-xr-10,w)),t({id:parseInt(h),paramKey:g.key,label:y.label,def:{min:y.min,max:y.max,step:y.step},x:b,y:w})}}},u=p=>{a&&p.key===String(a.id)&&t(null)};return window.addEventListener("mousemove",c),window.addEventListener("keydown",f),window.addEventListener("keyup",u),()=>{window.removeEventListener("mousemove",c),window.removeEventListener("keydown",f),window.removeEventListener("keyup",u)}},[a,i,n]),!a)return null;const d=l[String(a.id)];return e.jsxs("div",{className:"fixed z-[9999] bg-black/80 backdrop-blur-xl border border-cyan-500/50 rounded-xl shadow-[0_0_30px_rgba(0,0,0,0.5)] flex flex-col justify-center px-3 animate-pop-in",style:{left:a.x,top:a.y,width:Ya,height:xr},children:[e.jsxs("div",{className:"absolute -top-3 left-1/2 -translate-x-1/2 px-2 py-0.5 bg-cyan-900 rounded text-[9px] font-bold text-cyan-200 uppercase tracking-widest border border-cyan-700 shadow-sm",children:["Quick Edit (",a.id,")"]}),e.jsx(Me,{label:a.label,value:d.val,min:a.def.min,max:a.def.max,step:a.def.step,onChange:d.setter,highlight:!0,trackId:a.paramKey})]})},xu=()=>{const a=v.useRef(!1);return v.useEffect(()=>{a.current||(Fl(),a.current=!0,console.log(" Engine Bridge: Connected."))},[]),null},yr=()=>typeof window>"u"?!1:window.matchMedia("(pointer: coarse)").matches||window.innerWidth<768,yu=a=>{const t=Y(),o=v.useRef(null),r=v.useRef(null),[n,i]=v.useState("default"),s=v.useCallback(()=>{if(B.isBooted)return;console.log(" FractalEngine: Booting...");const d=Y.getState(),c=vn(d);try{setTimeout(()=>{B.bootWithConfig(c)},50)}catch(f){console.error("Critical Engine Boot Failure:",f)}},[]);v.useEffect(()=>{const d=window.location.hash;let c=null;if(d&&d.startsWith("#s=")){const u=d.slice(3);console.log("App: Found shared state in URL. Parsing..."),c=fo(u),c&&i("url")}if(!c){const u=Le.get("Mandelbulb");u&&u.defaultPreset&&(c=JSON.parse(JSON.stringify(u.defaultPreset)))}if(c&&yr()){console.log("App: Mobile detected. Enforcing Lite profile."),c.features||(c.features={});const u=Lt.lite;Object.entries(u).forEach(([p,h])=>{c.features[p]||(c.features[p]={}),Object.assign(c.features[p],h)})}c&&(console.log("App: Hydrating Store from Preset..."),t.loadPreset(c),o.current=c),n==="url"&&c&&setTimeout(()=>{s()},500);const f=setTimeout(()=>{B.isBooted||(console.warn("App: Loading Screen timeout. Forcing Engine Boot."),s())},4e3);return()=>clearTimeout(f)},[n]),v.useEffect(()=>{if(a&&B.isBooted){if(o.current){console.log("App: Scene Ready - Syncing Camera/State...");const c=Y.getState().quality;if((c==null?void 0:c.precisionMode)===1){const u=o.current,p=Lt.lite;u.features||(u.features={}),Object.entries(p).forEach(([h,g])=>{u.features[h]||(u.features[h]={}),Object.assign(u.features[h],g)})}t.loadPreset(o.current),o.current=null}if(r.current){console.log("App: Scene Ready - Applying Pending Manual Preset...");let d=r.current;if(yr()){const c=Lt.lite;d.features||(d.features={}),Object.entries(c).forEach(([f,u])=>{d.features[f]||(d.features[f]={}),Object.assign(d.features[f],u)})}t.loadPreset(d),r.current=null}}},[a]);const l=v.useCallback(d=>{r.current=d},[]);return{startupMode:n,queuePresetLoad:l,bootEngine:s}},Wn=({activeTab:a,state:t,actions:o,onSwitchTab:r})=>{if(a==="Graph"){const s=Ne.get("panel-graph");if(s)return e.jsx("div",{className:"h-[600px] -m-4",children:e.jsx(s,{state:t,actions:o})})}if(a==="Camera Manager"){const s=Ne.get("panel-cameramanager");if(s)return e.jsx(s,{state:t,actions:o})}if(a==="Engine"){const s=Ne.get("panel-engine");if(s)return e.jsx(s,{state:t,actions:o})}const i=ve.getTabs().find(s=>s.label===a);if(i){const s=Ne.get(i.componentId);if(s){const l=i.id,d=t[l];return e.jsx(s,{state:t,actions:o,onSwitchTab:r,featureId:l,sliceState:d})}}return e.jsx("div",{className:"flex h-full items-center justify-center text-gray-600 text-xs italic",children:"Select a module"})},bu=()=>typeof window>"u"?!1:window.matchMedia("(pointer: coarse)").matches||window.innerWidth<768,br=({side:a})=>{const{panels:t,activeLeftTab:o,activeRightTab:r,togglePanel:n,movePanel:i,reorderPanel:s,startPanelDrag:l,endPanelDrag:d,draggingPanelId:c,setDockSize:f,isLeftDockCollapsed:u,isRightDockCollapsed:p,setDockCollapsed:h,openContextMenu:g,leftDockSize:M,rightDockSize:m,formula:y,advancedMode:x}=Y(),C=bu(),k=Y.getState().audio,S=Y.getState().drawing,b=Y.getState().sonification,w=a==="left"?o:r,j=a==="left"?u:p,T=a==="left"?M:m,L=Object.values(t).filter(P=>{let $=P.location;return C&&(P.id==="Engine"||P.id==="Camera Manager")&&($="right"),!($!==a||P.id==="Graph"&&y!=="Modular"||P.id==="Light"&&!x||P.id==="Audio"&&!(k!=null&&k.isEnabled)||P.id==="Drawing"&&!(S!=null&&S.enabled)||P.id==="Sonification"&&!(b!=null&&b.isEnabled))}).sort((P,$)=>P.order-$.order),_=v.useRef(null),R=P=>{P.preventDefault(),_.current={startX:P.clientX,startW:T},window.addEventListener("mousemove",z),window.addEventListener("mouseup",E),document.body.style.cursor="ew-resize"},z=P=>{if(!_.current)return;const $=P.clientX-_.current.startX,O=a==="left"?$:-$,X=Math.max(200,Math.min(800,_.current.startW+O));f(a,X)},E=()=>{_.current=null,window.removeEventListener("mousemove",z),window.removeEventListener("mouseup",E),document.body.style.cursor=""},N=(P,$)=>{P.preventDefault();const O=Oe(P.currentTarget);g(P.clientX,P.clientY,[],O)};return L.length===0?null:j?e.jsxs("div",{className:`flex flex-col w-8 bg-black border-${a==="left"?"r":"l"} border-white/10 z-40 shrink-0`,children:[e.jsx("button",{onClick:()=>h(a,!1),className:"h-10 flex items-center justify-center text-gray-500 hover:text-white",children:a==="left"?e.jsx(Xt,{}):e.jsx(Ko,{})}),e.jsx("div",{className:"flex-1 flex flex-col items-center py-2 gap-2",children:L.map(P=>e.jsx("div",{onClick:()=>n(P.id,!0),className:`w-6 h-6 flex items-center justify-center rounded cursor-pointer ${P.id===w?"bg-cyan-900 text-cyan-400":"text-gray-600 hover:bg-white/10"}`,title:P.id,children:e.jsx("span",{className:"text-[10px] font-bold",children:P.id.charAt(0)})},P.id))})]}):e.jsxs("div",{className:`flex flex-col bg-[#080808] border-${a==="left"?"r":"l"} border-white/10 z-40 shrink-0 transition-all duration-75 relative`,style:{width:T},children:[e.jsx("div",{className:"flex flex-wrap gap-0.5 px-0.5 pt-1 bg-black/40 border-b border-white/10 shrink-0 relative items-end",children:L.map(P=>{const $=P.id===w;return e.jsxs("button",{onClick:()=>n(P.id,!0),onContextMenu:O=>N(O,P.id),onMouseEnter:()=>{if(c&&c!==P.id){const O=t[c];O&&O.location===a&&s(c,P.id)}},onMouseUp:O=>{c&&(O.stopPropagation(),d())},className:`flex items-center gap-0.5 px-1 py-1 text-[9px] font-bold uppercase tracking-normal transition-colors group relative rounded-t-sm
                                ${$?"bg-[#080808] text-cyan-400 border-x border-t border-white/10 z-10 -mb-px pb-2":"text-gray-500 hover:bg-white/5 hover:text-gray-300 border border-transparent"}`,children:[!C&&e.jsx("div",{className:`cursor-move ${$?"text-gray-600 group-hover:text-cyan-600":"text-gray-700 group-hover:text-white"} transition-colors`,onMouseDown:O=>{O.stopPropagation(),l(P.id)},children:e.jsx("div",{className:"transform scale-75 origin-center",children:e.jsx(Sn,{})})}),e.jsx("span",{className:"truncate max-w-[140px]",children:P.id})]},P.id)})}),e.jsx("button",{onClick:()=>h(a,!0),className:"absolute top-1 right-1 p-1 text-gray-600 hover:text-white z-20",children:a==="left"?e.jsx(Ko,{}):e.jsx(Xt,{})}),e.jsx("div",{className:"flex-1 overflow-y-auto custom-scroll p-4 relative",children:w?e.jsx(Wn,{activeTab:w,state:Y.getState(),actions:Y.getState(),onSwitchTab:n}):e.jsx("div",{className:"flex h-full items-center justify-center text-gray-700 text-xs italic",children:"Select a panel"})}),e.jsx("div",{className:`absolute top-0 bottom-0 w-1 cursor-ew-resize hover:bg-cyan-500/50 transition-colors z-50 ${a==="left"?"right-[-2px]":"left-[-2px]"}`,onMouseDown:R})]})},vu=()=>{const{draggingPanelId:a,movePanel:t,endPanelDrag:o,cancelPanelDrag:r,panels:n,leftDockSize:i,rightDockSize:s,isLeftDockCollapsed:l,isRightDockCollapsed:d}=Y();if(v.useEffect(()=>{if(!a)return;const g=()=>{r()};return window.addEventListener("mouseup",g),()=>window.removeEventListener("mouseup",g)},[a,r]),!a)return null;const c=n[a],f=c?c.location:null,u=(g,M)=>{g.stopPropagation(),t(a,M),o()},p=l?32:i,h=d?32:s;return e.jsxs("div",{className:"fixed inset-0 z-[1000] flex pointer-events-none",children:[e.jsx("div",{style:{width:p},className:`h-full flex items-center justify-center transition-all duration-200 border-r-2
                    ${f!=="left"?"bg-cyan-900/40 border-cyan-500/50 pointer-events-auto cursor-copy":"border-transparent pointer-events-none"}`,onMouseUp:g=>{f!=="left"&&u(g,"left")},children:f!=="left"&&e.jsx("div",{className:"bg-black/80 px-4 py-2 rounded border border-cyan-500/50 text-cyan-200 font-bold uppercase tracking-widest text-sm shadow-xl backdrop-blur-md",children:"Dock Left"})}),e.jsx("div",{className:`flex-1 h-full flex items-center justify-center transition-all duration-200
                    ${f!=="float"?"bg-purple-900/20 hover:bg-purple-900/30 border-x-2 border-purple-500/30 pointer-events-auto cursor-copy":"pointer-events-none"}`,onMouseUp:g=>{f!=="float"&&u(g,"float")},children:f!=="float"&&e.jsx("div",{className:"bg-black/80 px-4 py-2 rounded border border-purple-500/50 text-purple-200 font-bold uppercase tracking-widest text-sm shadow-xl backdrop-blur-md",children:"Float Window"})}),e.jsx("div",{style:{width:h},className:`h-full flex items-center justify-center transition-all duration-200 border-l-2
                    ${f!=="right"?"bg-cyan-900/40 border-cyan-500/50 pointer-events-auto cursor-copy":"border-transparent pointer-events-none"}`,onMouseUp:g=>{f!=="right"&&u(g,"right")},children:f!=="right"&&e.jsx("div",{className:"bg-black/80 px-4 py-2 rounded border border-cyan-500/50 text-cyan-200 font-bold uppercase tracking-widest text-sm shadow-xl backdrop-blur-md",children:"Dock Right"})})]})},wu=()=>{const a=Y(),[t,o]=v.useState(!1),[r,n]=v.useState(!0),[i,s]=v.useState(!1),l=v.useRef(null),d=v.useRef(null),c=v.useRef(null),f=v.useRef(null),u=v.useRef(null),p=v.useRef(null),h=v.useMemo(()=>({container:d,speed:c,dist:f,reset:u,reticle:p}),[]),{startupMode:g,queuePresetLoad:M,bootEngine:m}=yu(t),{isMobile:y,isPortrait:x}=bo();Sd(i,s),eu();const C=y||a.debugMobileLayout,k=a.quality,S=(k==null?void 0:k.precisionMode)===1,b=C&&a.cameraMode==="Fly",w=a.isBroadcastMode,j=a.interactionMode!=="none",T=E=>{E.preventDefault(),E.stopPropagation(),a.openContextMenu(E.clientX,E.clientY,[],["ui.timeline"])},L=()=>{const E=S?"balanced":"lite";le.emit("is_compiling",`Switching to ${E} mode...`);const N=a.applyPreset;N&&N({mode:E,actions:a})},_=()=>{n(!1),le.emit("camera_teleport",{position:a.cameraPos,rotation:a.cameraRot,sceneOffset:a.sceneOffset,targetDistance:a.targetDistance})},R=C&&!w?"min-h-[120vh] bg-black":"fixed inset-0 w-full h-full bg-black select-none overflow-hidden flex flex-col",z=Object.values(a.panels).filter(E=>E.location==="float"&&E.isOpen);return e.jsxs("div",{className:R,children:[e.jsx(xu,{}),e.jsx(vu,{}),z.map(E=>e.jsx(Yt,{id:E.id,title:E.id,children:e.jsx(Wn,{activeTab:E.id,state:a,actions:a,onSwitchTab:N=>a.togglePanel(N,!0)})},E.id)),C&&!w&&e.jsxs("div",{className:"w-full bg-[#080808] border-b border-white/10 p-8 pb-12 flex flex-col items-center text-center gap-3",children:[e.jsx("div",{className:"w-12 h-1 bg-gray-800 rounded-full mb-2"}),S?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex items-center gap-2 text-amber-500 mb-1",children:[e.jsx(Zt,{}),e.jsx("span",{className:"text-xs font-black uppercase tracking-widest",children:"Lite Render Mode"})]}),e.jsxs("p",{className:"text-[10px] text-gray-400 leading-relaxed max-w-[320px]",children:["Running lightweight engine.",e.jsx("br",{})]})]}):e.jsx(e.Fragment,{children:e.jsx("div",{className:"flex items-center gap-2 text-cyan-500 mb-1",children:e.jsx("span",{className:"text-xs font-black uppercase tracking-widest",children:"High Quality Mode"})})}),e.jsx("button",{onClick:L,className:"mt-2 px-3 py-1.5 text-[9px] font-bold uppercase tracking-widest rounded border border-white/10 bg-white/5 text-gray-300 hover:bg-white/10",children:S?"Switch to High Quality":"Switch to Lite Mode"})]}),e.jsxs("div",{ref:l,className:`relative bg-black select-none ${j?"cursor-crosshair":""} flex flex-col ${C&&!w?"h-[100vh] sticky top-0 overflow-hidden shadow-2xl":"w-full h-full"}`,onContextMenu:E=>E.preventDefault(),children:[e.jsx(wd,{isReady:t,onFinished:_,startupMode:g,onPresetLoaded:M,bootEngine:m}),C&&x&&!r&&!w&&e.jsxs("div",{className:"fixed inset-0 z-[9999] bg-black flex flex-col items-center justify-center p-10 text-center text-white",children:[e.jsx("div",{className:"text-cyan-400 mb-6 animate-bounce",children:e.jsx(Al,{})}),e.jsx("h2",{className:"text-2xl font-black uppercase tracking-tighter mb-2",children:"Landscape Recommended"}),e.jsx("p",{className:"text-gray-500 text-sm font-mono tracking-widest",children:"Rotate device to access controls."})]}),!r&&e.jsxs(e.Fragment,{children:[!w&&e.jsx(_c,{}),e.jsxs("div",{className:"flex-1 flex overflow-hidden relative",children:[!w&&!C&&e.jsx(br,{side:"left"}),e.jsx(Jd,{hudRefs:h,onSceneReady:()=>o(!0)}),!w&&e.jsx(br,{side:"right"})]}),!w&&e.jsx(xd,{}),!w&&e.jsx(gu,{}),a.contextMenu.visible&&!w&&e.jsx(Gn,{x:a.contextMenu.x,y:a.contextMenu.y,items:a.contextMenu.items,targetHelpIds:a.contextMenu.targetHelpIds,onClose:a.closeContextMenu,onOpenHelp:a.openHelp}),a.helpWindow.visible&&e.jsx(hu,{activeTopicId:a.helpWindow.activeTopicId,onClose:a.closeHelp,onNavigate:a.openHelp}),!i&&!b&&!w&&e.jsx("div",{className:"fixed bottom-4 left-4 z-50 flex gap-2 transition-all duration-500",children:e.jsx("button",{onClick:()=>s(!0),onContextMenu:T,className:"p-2 rounded-full border shadow-lg transition-all bg-gray-800 border-gray-600 text-gray-400 hover:text-white",title:"Open Timeline (T)",children:e.jsx(Xl,{})})}),i&&!w&&e.jsx(gd,{onClose:()=>s(!1)})]})]})]})},Su=({className:a="-m-3"})=>{const{drawing:t,setDrawing:o,removeDrawnShape:r,clearDrawnShapes:n,updateDrawnShape:i}=Y(),{active:s,activeTool:l,originMode:d,color:c,showLabels:f,showAxes:u,shapes:p,refreshTrigger:h}=t,[g,M]=v.useState(B.lastMeasuredDistance),[m,y]=v.useState(!0);v.useEffect(()=>{let k;return s&&d===1&&(k=window.setInterval(()=>{const S=B.lastMeasuredDistance;Math.abs(S-g)>1e-4&&M(S)},200)),()=>clearInterval(k)},[s,d,g]);const x=()=>{o({active:!s})},C=()=>{o({refreshTrigger:(h||0)+1}),M(B.lastMeasuredDistance)};return e.jsxs("div",{className:`flex flex-col h-full select-none ${a}`,"data-help-id":"panel.drawing",children:[e.jsxs("div",{className:"p-3 bg-black/40 border-b border-white/5",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-3",children:[e.jsx("span",{className:"w-2 h-2 rounded-full bg-cyan-500 shadow-[0_0_5px_cyan]"}),e.jsx("h3",{className:"text-[10px] font-black text-gray-300 uppercase tracking-[0.2em]",children:"Measurement Tools"})]}),e.jsx("div",{className:"flex gap-2 mb-2",children:e.jsx(gt,{onClick:x,active:s,variant:s?"success":"primary",className:"flex-1 py-3 text-xs shadow-lg",icon:s?e.jsx(xt,{}):e.jsx(Tn,{}),children:s?"DRAWING ACTIVE":"START DRAWING"})}),e.jsxs("div",{className:"flex bg-gray-800/50 rounded p-1 mb-3",children:[e.jsxs("button",{onClick:()=>o({activeTool:"rect"}),className:`flex-1 flex items-center justify-center gap-2 py-1.5 rounded text-[9px] font-bold uppercase transition-colors ${l==="rect"?"bg-cyan-900 text-cyan-200 shadow-sm":"text-gray-500 hover:text-white"}`,title:"Rectangle",children:[e.jsx(Ol,{})," RECT"]}),e.jsxs("button",{onClick:()=>o({activeTool:"circle"}),className:`flex-1 flex items-center justify-center gap-2 py-1.5 rounded text-[9px] font-bold uppercase transition-colors ${l==="circle"?"bg-cyan-900 text-cyan-200 shadow-sm":"text-gray-500 hover:text-white"}`,title:"Circle / Ellipse",children:[e.jsx($l,{})," CIRCLE"]})]}),e.jsxs("div",{className:"flex items-center justify-between mb-1",children:[e.jsx("label",{className:"text-[9px] font-bold text-gray-500 uppercase tracking-wider",children:"Default Color"}),e.jsx(Ra,{color:"#"+c.getHexString(),onChange:k=>o({color:new $e(k)}),label:""})]}),s&&e.jsxs("div",{className:"mt-2 px-2 py-1.5 bg-cyan-900/20 border border-cyan-500/20 rounded flex flex-col items-center gap-1 text-[9px] text-cyan-200 animate-fade-in text-center font-mono",children:[e.jsxs("div",{children:["Hold ",e.jsx("strong",{children:"X"})," to snap to World Axis"]}),e.jsxs("div",{children:["Hold ",e.jsx("strong",{children:"SHIFT"})," for 1:1 Ratio"]}),e.jsxs("div",{children:["Hold ",e.jsx("strong",{children:"ALT"})," for Center Draw"]}),e.jsxs("div",{children:["Hold ",e.jsx("strong",{children:"SPACE"})," to Move"]})]})]}),e.jsxs("div",{className:"p-3 border-b border-white/5 space-y-3 bg-white/[0.02]",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[9px] font-bold text-gray-500 uppercase tracking-wider",children:"Drawing Plane Origin"}),e.jsx(Ge,{value:d,onChange:k=>o({originMode:k}),options:[{label:"Global Zero",value:0},{label:"Surface Probe",value:1}]}),d===1&&e.jsxs("div",{className:"flex items-center justify-between bg-black/40 rounded border border-white/10 p-1.5 mt-1 animate-fade-in",children:[e.jsxs("span",{className:"text-[9px] text-gray-400 font-mono pl-1",children:["Depth: ",e.jsx("span",{className:"text-cyan-400 font-bold",children:g.toFixed(4)})]}),e.jsx("button",{onClick:C,className:"px-2 py-0.5 bg-gray-800 hover:bg-white/10 text-gray-300 text-[9px] font-bold uppercase rounded border border-white/5 hover:border-white/20 transition-all",title:"Update axis position to current probe location",children:"Refresh Axis"})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-2 pt-1",children:[e.jsxs("label",{className:"flex items-center gap-2 cursor-pointer group",children:[e.jsx("div",{className:`w-3 h-3 border rounded transition-colors ${f?"bg-cyan-500 border-cyan-500":"border-gray-600 bg-transparent"}`}),e.jsx("input",{type:"checkbox",className:"hidden",checked:f,onChange:k=>o({showLabels:k.target.checked})}),e.jsx("span",{className:"text-[10px] font-bold text-gray-400 group-hover:text-white transition-colors",children:"Show Labels"})]}),e.jsxs("label",{className:"flex items-center gap-2 cursor-pointer group",children:[e.jsx("div",{className:`w-3 h-3 border rounded transition-colors ${u?"bg-cyan-500 border-cyan-500":"border-gray-600 bg-transparent"}`}),e.jsx("input",{type:"checkbox",className:"hidden",checked:u,onChange:k=>o({showAxes:k.target.checked})}),e.jsx("span",{className:"text-[10px] font-bold text-gray-400 group-hover:text-white transition-colors",children:"Show Axes"})]})]})]}),e.jsxs("div",{className:"flex-1 overflow-y-auto custom-scroll p-3 bg-black/20",children:[e.jsxs("div",{className:"flex justify-between items-center mb-2 cursor-pointer hover:bg-white/5 p-1 rounded transition-colors",onClick:()=>y(!m),children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-gray-500",children:m?e.jsx(wn,{}):e.jsx(Rt,{})}),e.jsxs("span",{className:"text-[9px] font-bold text-gray-500 uppercase tracking-widest",children:["Measurement List (",(p||[]).length,")"]})]}),(p||[]).length>0&&m&&e.jsx("button",{onClick:k=>{k.stopPropagation(),n()},className:"text-[9px] text-red-500 hover:text-red-300 uppercase font-bold transition-colors px-2 py-0.5",children:"Clear"})]}),m&&e.jsx(e.Fragment,{children:(p||[]).length===0?e.jsx("div",{className:"text-center py-4 text-[10px] text-gray-600 italic",children:"No measurements drawn."}):e.jsx("div",{className:"space-y-1 animate-fade-in",children:(p||[]).map((k,S)=>{var w;const b=k.type==="rect"&&(k.size.z||0)>.001;return e.jsxs("div",{className:"flex flex-col bg-white/5 rounded border border-white/5 hover:border-cyan-500/30 transition-colors group",children:[e.jsxs("div",{className:"flex items-center justify-between p-2",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"transform scale-75 origin-left",children:e.jsx(Ra,{color:k.color,onChange:j=>i({id:k.id,updates:{color:j}}),label:""})}),e.jsxs("div",{className:"flex flex-col",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("span",{className:"text-[10px] text-gray-300 font-mono font-bold",children:["#",S+1]}),e.jsx("span",{className:"text-[8px] text-gray-500 font-bold uppercase bg-black/40 px-1 rounded",children:b?"CUBE":k.type})]}),e.jsxs("span",{className:"text-[9px] text-gray-500 font-mono",children:[k.size.x.toFixed(4)," x ",k.size.y.toFixed(4)," ",b?`x ${(w=k.size.z)==null?void 0:w.toFixed(4)}`:""]})]})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[k.type==="rect"&&e.jsx("button",{onClick:()=>{const T=(k.size.z||0)>0?0:Math.min(k.size.x,k.size.y);i({id:k.id,updates:{size:{...k.size,z:T}}})},className:`p-1.5 rounded transition-colors ${b?"text-cyan-300 bg-cyan-900/40":"text-gray-600 hover:text-cyan-400 hover:bg-white/5"}`,title:b?"Convert to Rect":"Extrude to Cube",children:e.jsx(la,{})}),e.jsx("button",{onClick:()=>r(k.id),className:"text-gray-600 hover:text-red-400 opacity-0 group-hover:opacity-100 transition-opacity p-1",title:"Delete",children:e.jsx(St,{})})]})]}),b&&e.jsxs("div",{className:"px-2 pb-2 pt-0 space-y-1 animate-slider-entry bg-black/20 mt-1 rounded border border-white/5 mx-1",children:[e.jsx(Me,{label:"Depth",value:k.size.z||0,onChange:j=>i({id:k.id,updates:{size:{...k.size,z:Math.max(.001,j)}}}),step:.01,min:.001,max:5,highlight:!0}),e.jsx(Me,{label:"Offset",value:k.zOffset||0,onChange:j=>i({id:k.id,updates:{zOffset:j}}),step:.01,min:-2,max:2})]})]},k.id)})})})]})]})},Mu=()=>{const{camera:a,gl:t}=_t(),{drawing:o,setDrawing:r,addDrawnShape:n,removeDrawnShape:i}=Y(),{active:s,activeTool:l,originMode:d,color:c,showLabels:f,showAxes:u,shapes:p,refreshTrigger:h}=o,[g,M]=v.useState(null),m=v.useRef(null),y=v.useRef(!1),x=v.useRef(new ie),C=v.useRef(new Se),k=v.useRef(new ie),S=v.useRef(new Ir),b=v.useRef(new ie),w=v.useRef(new ie),j=v.useRef({space:!1,x:!1}),T=_=>{let z=new ie(0,0,-1).applyQuaternion(a.quaternion).clone().negate();if(_){const $=Math.abs(z.x),O=Math.abs(z.y),X=Math.abs(z.z);$>O&&$>X?z.set(Math.sign(z.x),0,0):O>X?z.set(0,Math.sign(z.y),0):z.set(0,0,Math.sign(z.z))}let E=new ie(0,1,0);Math.abs(z.dot(E))>.99&&E.set(0,0,-1);let N=E.clone().sub(z.clone().multiplyScalar(E.dot(z)));N.normalize();const P=new ie().crossVectors(N,z).normalize();return b.current.copy(P),w.current.copy(N),S.current.setFromNormalAndCoplanarPoint(z,k.current),z},L=(_,R,z)=>{const E=new Se((_-z.left)/z.width*2-1,-((R-z.top)/z.height)*2+1),N=new Ea;N.setFromCamera(E,a);const P=new ie;return N.ray.intersectPlane(S.current,P)?P:null};return v.useEffect(()=>{const _=z=>{z.key==="Alt"&&z.preventDefault(),z.code==="Space"&&(j.current.space=!0,z.preventDefault()),z.key.toLowerCase()==="x"&&(j.current.x=!0)},R=z=>{z.key==="Alt"&&z.preventDefault(),z.code==="Space"&&(j.current.space=!1),z.key.toLowerCase()==="x"&&(j.current.x=!1)};return window.addEventListener("keydown",_),window.addEventListener("keyup",R),()=>{window.removeEventListener("keydown",_),window.removeEventListener("keyup",R)}},[]),v.useEffect(()=>{if(!s)return;const _=t.domElement,R=N=>{if(N.button!==0||N.target.closest(".drawing-ui"))return;const P=_.getBoundingClientRect();if(C.current.set(N.clientX,N.clientY),d===1){const X=Math.max(.1,B.lastMeasuredDistance),W=new ie(0,0,-1).applyQuaternion(a.quaternion);k.current.copy(a.position).addScaledVector(W,X)}else{const X=B.sceneOffset,W=-(X.x+X.xL),H=-(X.y+X.yL),A=-(X.z+X.zL);k.current.set(W,H,A)}const $=T(j.current.x),O=L(N.clientX,N.clientY,P);if(O){y.current=!0,x.current.copy(O);const X={center:void 0,size:{x:0,y:0},orientation:new Be().setFromRotationMatrix(new We().makeBasis(b.current,w.current,$)),type:l};M(X),m.current=X,_.setPointerCapture(N.pointerId)}},z=N=>{var H;if(!y.current)return;const P=_.getBoundingClientRect(),$=T(j.current.x),O=L(N.clientX,N.clientY,P);if(!O)return;if(j.current.space){const A=L(C.current.x,C.current.y,P);if(A){const F=new ie().subVectors(O,A);if(x.current.add(F),(H=m.current)!=null&&H.center){const I=m.current.center,D={...I,xL:I.xL+F.x,yL:I.yL+F.y,zL:I.zL+F.z},G={...m.current,center:D};M(G),m.current=G}}C.current.set(N.clientX,N.clientY);return}C.current.set(N.clientX,N.clientY);const X=O,W=x.current;if(W&&X){const A=new ie().subVectors(X,W);let F=A.dot(b.current),I=A.dot(w.current),D;if(N.altKey?(F*=2,I*=2,D=W.clone()):D=W.clone().addScaledVector(b.current,F*.5).addScaledVector(w.current,I*.5),N.shiftKey){const J=Math.max(Math.abs(F),Math.abs(I));F=Math.sign(F)*J,I=Math.sign(I)*J,N.altKey||(D=W.clone().addScaledVector(b.current,F*.5).addScaledVector(w.current,I*.5))}const G=B.sceneOffset,q={x:G.x,y:G.y,z:G.z,xL:G.xL+D.x,yL:G.yL+D.y,zL:G.zL+D.z},Q={...m.current,center:q,size:{x:Math.abs(F),y:Math.abs(I)},orientation:new Be().setFromRotationMatrix(new We().makeBasis(b.current,w.current,$))};M(Q),m.current=Q}},E=N=>{if(!y.current)return;y.current=!1,_.releasePointerCapture(N.pointerId);const P=m.current,$=Y.getState().drawing.color;P&&P.center&&P.size&&P.orientation&&(P.size.x>.001||P.size.y>.001)&&(n({id:tt(),type:P.type||"rect",center:P.center,size:P.size,orientation:P.orientation,color:"#"+$.getHexString()}),r({active:!1})),M(null),m.current=null};return _.addEventListener("pointerdown",R),_.addEventListener("pointermove",z),_.addEventListener("pointerup",E),()=>{_.removeEventListener("pointerdown",R),_.removeEventListener("pointermove",z),_.removeEventListener("pointerup",E)}},[s,l,d,a,t,r]),e.jsxs("group",{children:[u&&e.jsx(Cu,{originMode:d,trigger:h}),p&&p.map(_=>e.jsx(vr,{shape:_,color:_.color,showLabel:f,onDelete:()=>i(_.id),isActive:s},_.id)),g&&g.center&&g.size&&g.orientation&&e.jsx(vr,{shape:g,color:"#"+c.getHexString(),isTemp:!0,showLabel:f,onDelete:()=>{},isActive:!0})]})},Cu=({originMode:a,trigger:t})=>{const o=v.useRef(null),{camera:r}=_t(),n=v.useRef(null);return v.useEffect(()=>{let i=new ie(0,0,0);if(a===1){const l=Math.max(.1,B.lastMeasuredDistance),d=new ie(0,0,-1).applyQuaternion(r.quaternion);i.copy(r.position).addScaledVector(d,l)}else{const l=B.sceneOffset,d=-(l.x+l.xL),c=-(l.y+l.yL),f=-(l.z+l.zL);i.set(d,c,f)}const s=B.sceneOffset;n.current={x:s.x,y:s.y,z:s.z,xL:s.xL+i.x,yL:s.yL+i.y,zL:s.zL+i.z}},[a,t]),Bt(()=>{if(!o.current||!n.current)return;const i=B.sceneOffset,s=n.current,l=s.x-i.x+(s.xL-i.xL),d=s.y-i.y+(s.yL-i.yL),c=s.z-i.z+(s.zL-i.zL);o.current.position.set(l,d,c)}),e.jsxs("group",{ref:o,children:[e.jsx("gridHelper",{args:[10,10,16711680,4473924],rotation:[Math.PI/2,0,0]}),e.jsx("axesHelper",{args:[5]})]})},vr=({shape:a,color:t,isTemp:o,showLabel:r,onDelete:n,isActive:i})=>{const s=v.useRef(null),l=v.useMemo(()=>new li({color:new $e(t),linewidth:1,depthTest:!1,transparent:!0}),[t]);Bt(()=>{if(!s.current)return;const m=B.sceneOffset,y=a.center.x-m.x+(a.center.xL-m.xL),x=a.center.y-m.y+(a.center.yL-m.yL),C=a.center.z-m.z+(a.center.zL-m.zL);s.current.position.set(y,x,C),s.current.quaternion.set(a.orientation.x,a.orientation.y,a.orientation.z,a.orientation.w)});const d=a.size.x/2,c=a.size.y/2,f=a.size.z||0,u=a.zOffset||0,p=a.type==="rect"&&f>.001,h=v.useMemo(()=>{if(a.type==="circle"){const y=new ci(0,0,d,c,0,2*Math.PI,!1,0).getPoints(64);return new Po().setFromPoints(y)}else{if(p)return new di(new ui(a.size.x,a.size.y,f));{const m=[new ie(-d,-c,0),new ie(d,-c,0),new ie(d,c,0),new ie(-d,c,0)];return new Po().setFromPoints(m)}}},[d,c,f,a.type,p]),g="drawing-ui absolute select-none pointer-events-auto",M=p?u-f/2:u;return e.jsx("group",{ref:s,children:e.jsxs("group",{position:[0,0,M],children:[p?e.jsx("lineSegments",{geometry:h,material:l}):e.jsx("lineLoop",{geometry:h,material:l}),r&&e.jsxs(e.Fragment,{children:[e.jsx(ua,{position:[0,c,f/2],center:!0,zIndexRange:[100,0],className:g,children:e.jsx("div",{className:"transform -translate-y-full mb-1 text-[10px] font-mono font-bold whitespace-nowrap text-cyan-300 opacity-90 px-1 backdrop-blur-[1px]",children:a.size.x.toFixed(4)})}),e.jsx(ua,{position:[-d,0,f/2],center:!0,zIndexRange:[100,0],className:g,children:e.jsx("div",{className:"transform -translate-x-full mr-1 text-[10px] font-mono font-bold whitespace-nowrap text-cyan-300 opacity-90 px-1 backdrop-blur-[1px] rotate-90 origin-right",children:a.size.y.toFixed(4)})}),p&&e.jsx(ua,{position:[d,-c,0],center:!0,zIndexRange:[100,0],className:g,children:e.jsx("div",{className:"transform translate-x-1 ml-1 text-[10px] font-mono font-bold whitespace-nowrap text-cyan-300 opacity-90 px-1 backdrop-blur-[1px] -rotate-45 origin-left",children:f.toFixed(4)})}),!o&&e.jsx(ua,{position:[d,c,f/2],center:!0,zIndexRange:[100,0],className:g,children:e.jsx("div",{className:"transform translate-x-1/2 -translate-y-1/2 cursor-pointer flex items-center justify-center w-4 h-4 bg-red-900/80 hover:bg-red-500 text-white rounded-full transition-colors shadow-sm border border-white/20",onClick:m=>{m.stopPropagation(),n()},title:"Delete Shape",children:e.jsx("span",{className:"text-[10px] font-bold leading-none mb-[1px]",children:""})})})]})]})})},qn=()=>{const a=v.useRef(null),t=v.useRef(null),o=Y(),{modulation:r,selectModulation:n,addModulation:i,openContextMenu:s}=o,l=o.audio,[d,c]=v.useState(!0),f=(S,b)=>{o.updateModulation({id:S,update:b})},u=r.rules.filter(S=>S.source==="audio"),p=r.selectedRuleId,h=v.useRef(null),g=(S,b)=>{if(!d)return S*b;const w=1e3,j=Math.log(S*(w-1)+1),T=Math.log(w);return j/T*b},M=(S,b)=>{if(b===0||S<b*.02)return 0;if(S>=b)return 1;const w=S/b;if(!d)return Math.max(0,Math.min(1,w));const j=1e3,T=Math.log(j),L=Math.exp(w*T)-1;return Math.max(0,Math.min(1,L/(j-1)))};v.useEffect(()=>{const S=a.current;if(!S||!(l!=null&&l.isEnabled))return;const b=S.getContext("2d");if(!b)return;let w=0;const j=()=>{if(!(l!=null&&l.isEnabled)){cancelAnimationFrame(w);return}const T=S.width,L=S.height,_=et.getRawData();b.fillStyle="#050505",b.fillRect(0,0,T,L),b.strokeStyle="#222",b.lineWidth=1,b.beginPath(),(d?[0,.1,.25,.5,1]:[0,.25,.5,.75,1]).forEach(E=>{const N=g(E,T);b.moveTo(N,0),b.lineTo(N,L)});for(let E=.1;E<1;E+=.2){const N=E*L;b.moveTo(0,N),b.lineTo(T,N)}if(b.stroke(),_){const N=T/128;b.fillStyle="#334155";for(let P=0;P<128;P++){const $=P/128,O=(P+1)/128,X=d?M($*T,T):$,W=d?M(O*T,T):O,H=Math.floor(X*_.length),A=Math.max(H+1,Math.floor(W*_.length));let F=0;for(let D=H;D<A&&D<_.length;D++)F=Math.max(F,_[D]);F=F/255;const I=F*L;b.fillRect(P*N,L-I,N+1,I)}}[...u].sort((E,N)=>(E.id===p?1:0)-(N.id===p?1:0)).forEach(E=>{const N=E.id===p,P=g(E.freqStart,T),$=g(E.freqEnd,T),O=P,X=Math.max(1,$-P),W=L-E.thresholdMin*L,H=L-E.thresholdMax*L,A=Math.max(2,W-H);Math.min(.8,.2+E.gain/5*.3),b.fillStyle=N?`${E.color}60`:`${E.color}20`,b.fillRect(O,H,X,A),b.strokeStyle=N?"#fff":E.color,b.lineWidth=1,b.strokeRect(O,H,X,A);const F=mt.getRuleValue(E.id);if(F>.01){const I=Math.min(4,X),D=A*F,G=O+X-I,q=W-D;b.fillStyle=E.color,b.fillRect(G,q,I,D)}if(N&&X>10){b.fillStyle="#fff";const I=6,D=I/2;b.fillRect(O-D,H+A/2-D,I,I),b.fillRect(O+X-D,H+A/2-D,I,I),b.fillRect(O+X/2-D,H-D,I,I),b.fillRect(O+X/2-D,W-D,I,I)}if(X>20){b.fillStyle=N?"#fff":"#aaa",b.font="9px monospace";const I=E.target.split(".").pop()||"Param",D=E.gain!==1?` (x${E.gain.toFixed(1)})`:"";b.save(),b.beginPath(),b.rect(O,H,X,A),b.clip(),b.fillText(`${I}${D}`,O+3,H+10),b.restore()}}),w=requestAnimationFrame(j)};return j(),()=>cancelAnimationFrame(w)},[u,p,d,l==null?void 0:l.isEnabled]);const m=S=>{if(S.button===2||!t.current)return;const b=t.current.getBoundingClientRect(),w=S.clientX-b.left,j=S.clientY-b.top,T=b.width,L=b.height,_=8;if(p){const R=u.find(z=>z.id===p);if(R){const z=g(R.freqStart,T),E=g(R.freqEnd,T)-z,N=L-R.thresholdMax*L,P=(R.thresholdMax-R.thresholdMin)*L,$=N+P,O=(X,W)=>Math.abs(w-X)<_&&Math.abs(j-W)<_;if(E>10&&!S.ctrlKey){if(O(z,N+P/2)){h.current={type:"l",ruleId:p,startX:w,startY:j,startRule:{...R}};return}if(O(z+E,N+P/2)){h.current={type:"r",ruleId:p,startX:w,startY:j,startRule:{...R}};return}if(O(z+E/2,N)){h.current={type:"t",ruleId:p,startX:w,startY:j,startRule:{...R}};return}if(O(z+E/2,$)){h.current={type:"b",ruleId:p,startX:w,startY:j,startRule:{...R}};return}}}}for(let R=u.length-1;R>=0;R--){const z=u[R],E=g(z.freqStart,T),N=g(z.freqEnd,T)-E,P=L-z.thresholdMax*L,$=(z.thresholdMax-z.thresholdMin)*L;if(w>=E&&w<=E+N&&j>=P&&j<=P+$){n(z.id);const O=S.ctrlKey?"gain":"move";h.current={type:O,ruleId:z.id,startX:w,startY:j,startRule:{...z}},O==="gain"&&(document.body.style.cursor="ns-resize");return}}n(null)},y=S=>{if(!h.current||!t.current)return;const{type:b,startX:w,startY:j,startRule:T,ruleId:L}=h.current,_=t.current.getBoundingClientRect(),R=_.width,z=_.height,E=S.clientX-_.left-w,N=-(S.clientY-_.top-j)/z,P={};if(b==="move"){const $=g(T.freqStart,R),X=g(T.freqEnd,R)-$,W=$+E,H=W+X;let A=M(W,R),F=M(H,R);A<=0&&(A=0,F=M(g(0,R)+X,R)),F>=1&&(F=1,A=M(g(1,R)-X,R)),P.freqStart=A,P.freqEnd=F;const I=T.thresholdMax-T.thresholdMin;let D=T.thresholdMin+N;D<0&&(D=0),D+I>1&&(D=1-I),P.thresholdMin=D,P.thresholdMax=D+I}else if(b==="gain"){const O=-(S.clientY-_.top-j)*.05;P.gain=Math.max(0,Math.min(10,T.gain+O))}else if(b==="l"){const O=g(T.freqStart,R)+E,X=M(O,R);P.freqStart=Math.max(0,Math.min(T.freqEnd-.001,X))}else if(b==="r"){const O=g(T.freqEnd,R)+E,X=M(O,R);P.freqEnd=Math.min(1,Math.max(T.freqStart+.001,X))}else b==="b"?P.thresholdMin=Math.max(0,Math.min(T.thresholdMax-.05,T.thresholdMin+N)):b==="t"&&(P.thresholdMax=Math.min(1,Math.max(T.thresholdMin+.05,T.thresholdMax+N)));f(L,P)},x=()=>{h.current=null,document.body.style.cursor=""},C=S=>{if(!t.current)return;const b=t.current.getBoundingClientRect(),w=S.clientX-b.left,j=M(w,b.width),T=1-(S.clientY-b.top)/b.height;i({target:"coreMath.paramA",source:"audio"}),setTimeout(()=>{const L=Y.getState().modulation.rules,_=L[L.length-1];if(_){const R=d?.05:.02;f(_.id,{freqStart:Math.max(0,j-R/2),freqEnd:Math.min(1,j+R/2),thresholdMin:Math.max(0,T-.1),thresholdMax:Math.min(1,T+.1)})}},0)},k=S=>{S.preventDefault(),S.stopPropagation();const b=[{label:"Spectrum Scale",action:()=>{},isHeader:!0},{label:"Logarithmic (Bass Focus)",checked:d,action:()=>c(!0)},{label:"Linear",checked:!d,action:()=>c(!1)}];s(S.clientX,S.clientY,b,["panel.audio"])};return e.jsxs("div",{ref:t,className:"w-full h-32 bg-black border border-white/10 rounded overflow-hidden cursor-crosshair relative group",style:{display:l!=null&&l.isEnabled?"block":"none"},onMouseDown:m,onMouseMove:y,onMouseUp:x,onMouseLeave:x,onDoubleClick:C,onContextMenu:k,children:[e.jsx("canvas",{ref:a,width:400,height:150,className:"w-full h-full block"}),e.jsxs("div",{className:"absolute top-1 right-2 flex gap-2 pointer-events-none",children:[e.jsx("div",{className:"text-[8px] font-bold text-gray-500 bg-black/50 px-1 rounded",children:"CTRL+DRAG = GAIN"}),e.jsx("div",{className:"text-[8px] font-bold text-gray-600 uppercase bg-black/50 px-1 rounded",children:d?"LOG":"LIN"})]}),u.length===0&&e.jsx("div",{className:"absolute inset-0 flex items-center justify-center pointer-events-none text-gray-600 text-[10px]",children:"Double-click to add modulator"})]})},ku=new Set(["audio","navigation","drawing","webcam","debugTools","engineSettings","quality","reflections"]),wr=["coreMath","geometry","materials","coloring","atmosphere","lighting","optics"],ju=new Set(["repeats","phase","scale","offset","bias","repeats2","phase2","scale2","offset2","bias2","levelsMin","levelsMax","levelsGamma","saturation"]),Tu=a=>{if(a==="lighting"){const t=[];for(let o=0;o<3;o++)t.push({label:`Light ${o+1} Intensity`,key:`light${o}_intensity`}),t.push({label:`Light ${o+1} Pos X`,key:`light${o}_posX`}),t.push({label:`Light ${o+1} Pos Y`,key:`light${o}_posY`}),t.push({label:`Light ${o+1} Pos Z`,key:`light${o}_posZ`});return t}return[]},Pu=({x:a,y:t,onClose:o,onSelect:r})=>{const[n,i]=v.useState(null),s=v.useRef(null),[l,d]=v.useState({x:a,y:t,maxHeight:300,opacity:0}),c=Y(h=>h.formula),u=[...ve.getAll().filter(h=>!ku.has(h.id)&&(Object.values(h.params).some(g=>g.type==="float"||g.type==="int")||h.id==="lighting")).sort((h,g)=>{const M=wr.indexOf(h.id),m=wr.indexOf(g.id);return M!==-1&&m!==-1?M-m:M!==-1?-1:m!==-1?1:h.name.localeCompare(g.name)}).map(h=>({id:h.id,name:h.name})),{id:"camera",name:"Camera"}];v.useLayoutEffect(()=>{const h=window.innerWidth,g=window.innerHeight,M=10;let m=a;m+330>h-M&&(m=Math.max(M,h-330-M));const y=g-t-M;let x=400,C=t;y<200&&t>y?C+x>g-M&&(C=Math.max(M,g-x-M)):x=Math.min(x,Math.max(150,y)),d({x:m,y:C,maxHeight:x,opacity:1})},[a,t]),v.useEffect(()=>{const h=g=>{s.current&&!s.current.contains(g.target)&&o()};return window.addEventListener("mousedown",h,!0),()=>window.removeEventListener("mousedown",h,!0)},[o]);const p=h=>{if(h==="camera")return[{label:"Camera Pos X",key:"camera.unified.x"},{label:"Camera Pos Y",key:"camera.unified.y"},{label:"Camera Pos Z",key:"camera.unified.z"},{label:"Rotation X",key:"camera.rotation.x"},{label:"Rotation Y",key:"camera.rotation.y"},{label:"Rotation Z",key:"camera.rotation.z"}].map(y=>e.jsx("button",{onClick:()=>{r(y.key),o()},className:"px-3 py-1.5 text-left text-gray-300 hover:bg-cyan-600 hover:text-white transition-colors truncate",children:y.label},y.key));const g=ve.get(h);if(!g)return null;const M=Tu(h),m=Object.entries(g.params).filter(([y,x])=>x.type!=="float"&&x.type!=="int"||x.onUpdate==="compile"?!1:!!(!x.hidden||ju.has(y))).map(([y,x])=>{let C=x.label;if(h==="coreMath"&&c){const k=Le.get(c);if(k){const S=k.parameters.find(b=>(b==null?void 0:b.id)===y);S?C=`${y.replace("param","P-")}: ${S.label}`:y.startsWith("param")&&(C=`(${x.label})`)}}return{key:`${h}.${y}`,label:C,desc:x.description}});return[...M.map(y=>({key:`${h}.${y.key}`,label:y.label,desc:void 0})),...m].map(y=>e.jsx("button",{onClick:()=>{r(y.key),o()},className:"px-3 py-1.5 text-left text-gray-300 hover:bg-cyan-600 hover:text-white transition-colors truncate",title:y.desc||y.label,children:y.label},y.key))};return wt.createPortal(e.jsxs("div",{ref:s,className:"fixed z-[9999] flex text-xs font-mono",style:{left:l.x,top:l.y,opacity:l.opacity,transition:"opacity 0.05s ease-out"},children:[e.jsx("div",{className:"w-32 bg-[#1a1a1a] border border-white/20 rounded-l shadow-[0_10px_30px_rgba(0,0,0,0.5)] flex flex-col py-1 overflow-y-auto custom-scroll",style:{maxHeight:l.maxHeight},children:u.map(h=>e.jsxs("div",{onMouseEnter:()=>i(h.id),className:`px-3 py-1.5 cursor-pointer flex justify-between items-center transition-colors ${n===h.id?"bg-cyan-900/60 text-white":"text-gray-400 hover:text-white hover:bg-white/5"}`,children:[e.jsx("span",{className:`truncate ${h.id==="coreMath"?"font-bold text-cyan-300":""}`,children:h.name}),e.jsx(Xt,{})]},h.id))}),n&&e.jsx("div",{className:"w-48 bg-[#222] border-y border-r border-white/20 rounded-r shadow-[0_10px_30px_rgba(0,0,0,0.5)] flex flex-col py-1 -ml-px overflow-y-auto custom-scroll animate-fade-in-left",style:{maxHeight:l.maxHeight},children:p(n)})]}),document.body)},Xn=({value:a,onChange:t,className:o})=>{var u,p,h;const[r,n]=v.useState(!1),i=v.useRef(null),[s,l]=v.useState({x:0,y:0}),d=Y(g=>g.formula),c=()=>{if(i.current){const g=i.current.getBoundingClientRect();l({x:g.left,y:g.bottom+4}),n(!0)}};let f=a;if(a.includes(".")){const[g,M]=a.split(".");if(g==="lighting"&&M.startsWith("light")){const m=parseInt(((u=M.match(/\d+/))==null?void 0:u[0])||"0"),y=M.includes("intensity")?"Intensity":M.includes("pos")?"Pos":"Param";f=`Light ${m+1} ${y}`}else if(g==="camera")M.includes("unified")?f=`Camera Pos ${(p=M.split(".").pop())==null?void 0:p.toUpperCase()}`:M.includes("rotation")?f=`Camera Rot ${(h=M.split(".").pop())==null?void 0:h.toUpperCase()}`:f="Camera Param";else{const m=ve.get(g);if(m){const y=m.params[M];if(y)if(g==="coreMath"&&d){const x=Le.get(d),C=x==null?void 0:x.parameters.find(k=>(k==null?void 0:k.id)===M);C?f=`${M.replace("param","P-")}: ${C.label}`:f=y.label}else f=`${m.name}: ${y.label}`;else f=`${m.name}: ${M}`}}}return e.jsxs(e.Fragment,{children:[e.jsx("button",{ref:i,onClick:c,className:`text-left px-2 py-1 bg-black/40 border border-white/10 rounded text-[10px] text-cyan-400 hover:bg-white/5 truncate ${o}`,title:f,children:f}),r&&e.jsx(Pu,{x:s.x,y:s.y,onClose:()=>n(!1),onSelect:t})]})},Yn=()=>{const a=Y(),{modulation:t,removeModulation:o,addModulation:r,openContextMenu:n}=a,i=(p,h)=>{a.updateModulation({id:p,update:h})},s=t.selectedRuleId,l=t.rules.find(p=>p.id===s),d=()=>{r({target:"coreMath.paramA",source:"audio"})},c=p=>{const h=Oe(p.currentTarget);h.length>0&&(p.preventDefault(),p.stopPropagation(),n(p.clientX,p.clientY,[],h))};if(!l)return e.jsxs("div",{className:"flex flex-col items-center justify-center py-6 text-gray-500 gap-3 border-t border-white/5",children:[e.jsx("span",{className:"text-xs italic",children:"Select a box to edit params"}),e.jsx("button",{onClick:d,className:"px-4 py-2 bg-cyan-900/50 border border-cyan-500/30 rounded text-xs font-bold text-cyan-300 hover:bg-cyan-900 transition-colors",children:"+ ADD NEW LINK"})]});const f=l.source==="audio",u=(p,h)=>{i(l.id,{freqStart:p,freqEnd:h})};return e.jsxs("div",{className:"flex flex-col gap-3 border-t border-white/5 pt-3 animate-fade-in-up","data-help-id":"audio.links",onContextMenu:c,children:[e.jsxs("div",{className:"flex justify-between items-center bg-white/5 p-2 rounded border border-white/5",children:[e.jsxs("div",{className:"flex-1 mr-2",children:[e.jsx("label",{className:"text-[9px] text-gray-500 font-bold uppercase block mb-1",children:"Target Parameter"}),e.jsx(Xn,{value:l.target,onChange:p=>i(l.id,{target:p}),className:"w-full"})]}),e.jsx("div",{className:"flex flex-col items-end gap-1",children:e.jsx("button",{onClick:()=>o(l.id),className:"p-2 text-red-500 hover:text-red-300 hover:bg-red-900/20 rounded border border-transparent hover:border-red-900/50 transition-colors",title:"Remove Rule",children:e.jsx(St,{})})})]}),e.jsxs("div",{className:"flex gap-2 items-center",children:[e.jsx("label",{className:"text-[9px] text-gray-500 font-bold uppercase",children:"Source:"}),e.jsxs("select",{value:l.source,onChange:p=>i(l.id,{source:p.target.value}),className:"bg-black border border-white/10 text-[9px] text-cyan-300 rounded px-2 py-1",children:[e.jsx("option",{value:"audio",children:"Audio Spectrum"}),e.jsx("option",{value:"lfo-1",children:"LFO 1"}),e.jsx("option",{value:"lfo-2",children:"LFO 2"}),e.jsx("option",{value:"lfo-3",children:"LFO 3"})]})]}),f&&e.jsxs("div",{children:[e.jsx("label",{className:"text-[9px] text-gray-500 font-bold uppercase block mb-1",children:"Quick Frequency Bands"}),e.jsxs("div",{className:"flex gap-1",children:[e.jsx("button",{onClick:()=>u(0,.1),className:"flex-1 py-1.5 bg-white/5 hover:bg-white/10 text-[9px] uppercase font-bold text-gray-400 rounded border border-white/5",children:"Bass"}),e.jsx("button",{onClick:()=>u(.1,.5),className:"flex-1 py-1.5 bg-white/5 hover:bg-white/10 text-[9px] uppercase font-bold text-gray-400 rounded border border-white/5",children:"Mids"}),e.jsx("button",{onClick:()=>u(.5,1),className:"flex-1 py-1.5 bg-white/5 hover:bg-white/10 text-[9px] uppercase font-bold text-gray-400 rounded border border-white/5",children:"Treble"}),e.jsx("button",{onClick:()=>u(0,1),className:"flex-1 py-1.5 bg-white/5 hover:bg-white/10 text-[9px] uppercase font-bold text-gray-400 rounded border border-white/5",children:"Full"})]})]}),e.jsxs("div",{className:"bg-black/30 rounded border border-white/10 p-3",children:[e.jsxs("div",{className:"grid grid-cols-5 gap-1",children:[e.jsx("div",{className:"flex flex-col items-center",children:e.jsx(Ot,{label:"Attack",value:l.attack,min:.01,max:.99,onChange:p=>i(l.id,{attack:p}),size:40,color:"#fbbf24"})}),e.jsx("div",{className:"flex flex-col items-center",children:e.jsx(Ot,{label:"Decay",value:l.decay,min:.01,max:.99,onChange:p=>i(l.id,{decay:p}),size:40,color:"#fbbf24"})}),e.jsx("div",{className:"flex flex-col items-center",children:e.jsx(Ot,{label:"Smooth",value:l.smoothing??0,min:0,max:.99,onChange:p=>i(l.id,{smoothing:p}),size:40,color:"#a855f7"})}),e.jsx("div",{className:"flex flex-col items-center",children:e.jsx(Ot,{label:"Gain",value:l.gain,min:0,max:10,onChange:p=>i(l.id,{gain:p}),size:40,color:"#22d3ee",unconstrained:!0})}),e.jsx("div",{className:"flex flex-col items-center",children:e.jsx(Ot,{label:"Offset",value:l.offset,min:-5,max:5,onChange:p=>i(l.id,{offset:p}),size:40,color:"#22d3ee",unconstrained:!0})})]}),e.jsxs("div",{className:"grid grid-cols-5 text-[8px] text-gray-500 text-center mt-1 uppercase font-bold",children:[e.jsx("div",{children:"Rise"}),e.jsx("div",{children:"Fall"}),e.jsx("div",{children:"Lerp"}),e.jsx("div",{children:"Mult"}),e.jsx("div",{children:"Add"})]})]}),f&&e.jsxs("div",{className:"flex justify-between text-[9px] text-gray-600 px-1",children:[e.jsxs("span",{children:["Freq: ",Math.round(l.freqStart*100),"% - ",Math.round(l.freqEnd*100),"%"]}),e.jsxs("span",{children:["Threshold: ",Math.round(l.thresholdMin*100),"% - ",Math.round(l.thresholdMax*100),"%"]})]})]})},Sr=({index:a,label:t,onClose:o,isActive:r})=>{const n=v.useRef(null),[i,s]=v.useState({duration:1,currentTime:0,hasTrack:!1,fileName:null}),[l,d]=v.useState(!1);v.useEffect(()=>{if(!r)return;const h=setInterval(()=>{const g=et.getTrackInfo(a);s(g),g.currentTime>=g.duration&&l&&d(!1)},100);return()=>clearInterval(h)},[a,r,l]);const c=h=>{h.target.files&&h.target.files[0]&&(et.loadTrack(a,h.target.files[0]),setTimeout(()=>{et.play(a),d(!0)},100)),h.target.value=""},f=()=>{l?et.pause(a):et.play(a),d(!l)},u=h=>{et.seek(a,h)},p=i.currentTime/Math.max(.1,i.duration)*100;return r?e.jsxs("div",{className:"flex flex-col bg-white/5 border border-white/10 rounded overflow-hidden relative group",children:[e.jsx("div",{className:"absolute inset-0 bg-cyan-900/20 origin-left pointer-events-none transition-transform duration-200 ease-linear",style:{transform:`scaleX(${p/100})`}}),e.jsxs("div",{className:"flex items-center p-1 gap-2 relative z-10",children:[e.jsx("button",{onClick:f,disabled:!i.hasTrack,className:`w-6 h-6 flex items-center justify-center rounded transition-colors ${l?"text-green-400 bg-green-900/30":"text-gray-400 hover:text-white bg-white/5"}`,children:l?e.jsx(xo,{}):e.jsx(ia,{})}),e.jsxs("div",{className:"flex-1 flex flex-col justify-center min-w-0 h-8 relative",children:[e.jsxs("div",{className:"flex justify-between items-baseline",children:[e.jsx("span",{className:"text-[9px] font-bold text-gray-400 truncate pr-2",title:i.fileName||"No File",children:i.fileName||t}),e.jsxs("span",{className:"text-[8px] font-mono text-cyan-500",children:[Math.floor(i.currentTime/60),":",Math.floor(i.currentTime%60).toString().padStart(2,"0")]})]}),e.jsx("input",{type:"range",min:0,max:i.duration,step:.1,value:i.currentTime,onChange:h=>u(parseFloat(h.target.value)),disabled:!i.hasTrack,className:"absolute inset-0 w-full h-full opacity-0 cursor-ew-resize",title:"Drag to Seek"})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("button",{onClick:()=>{var h;return(h=n.current)==null?void 0:h.click()},className:"p-1 text-gray-500 hover:text-cyan-400 transition-colors",title:"Load File",children:e.jsx(mo,{})}),o&&e.jsx("button",{onClick:()=>{et.stop(a),d(!1),o()},className:"p-1 text-gray-500 hover:text-red-400 transition-colors",title:"Remove Track",children:e.jsx(Vt,{})})]}),e.jsx("input",{type:"file",ref:n,className:"hidden",accept:"audio/*",onChange:c})]})]}):null},Ru=({className:a="-m-3"})=>{const{audio:t,setAudio:o}=Y(),{isEnabled:r,gain:n,smoothing:i}=t,s=Y(m=>m.openContextMenu),[l,d]=v.useState(!1),[c,f]=v.useState(!1),[u,p]=v.useState(.5),h=m=>{const y=Oe(m.currentTarget);y.length>0&&(m.preventDefault(),m.stopPropagation(),s(m.clientX,m.clientY,[],y))},g=m=>{p(m),et.setCrossfade(m)},M=m=>{o({smoothing:m}),et.setSmoothing(m)};return e.jsxs("div",{className:`flex flex-col h-full select-none ${a}`,"data-help-id":"panel.audio",onContextMenu:h,children:[e.jsxs("div",{className:"p-2 bg-black/40 border-b border-white/5",children:[e.jsxs("div",{className:"flex justify-between items-center mb-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:`w-1.5 h-1.5 rounded-full ${r?"bg-green-500 animate-pulse":"bg-red-900"}`}),e.jsx("h3",{className:"text-[10px] font-black text-gray-300 uppercase tracking-[0.2em]",children:"Audio Engine"})]}),e.jsx(Me,{label:"FFT Smooth",value:i||.8,min:0,max:.99,step:.01,onChange:M,className:"w-36"})]}),e.jsxs("div",{className:"flex gap-1 mb-2","data-help-id":"audio.sources",children:[e.jsx("button",{onClick:()=>et.connectMicrophone(),className:"flex-1 py-1.5 bg-gray-800 hover:bg-white/10 text-[9px] font-bold text-gray-400 hover:text-white rounded border border-white/5 uppercase transition-all",children:"Microphone"}),e.jsx("button",{onClick:()=>et.connectSystemAudio(),className:"flex-1 py-1.5 bg-gray-800 hover:bg-white/10 text-[9px] font-bold text-gray-400 hover:text-white rounded border border-white/5 uppercase transition-all",children:"System Audio"})]}),e.jsxs("div",{className:"flex flex-col gap-1",children:[!l&&!c&&e.jsx("button",{onClick:()=>d(!0),className:"w-full py-2 border border-dashed border-white/10 rounded text-[9px] text-gray-500 hover:text-cyan-400 hover:border-cyan-500/30 transition-all uppercase font-bold",children:"+ Load Audio File"}),e.jsx(Sr,{index:0,label:"Track A",isActive:l,onClose:()=>d(!1)}),l&&!c&&e.jsx("div",{className:"flex justify-center -my-1 z-10",children:e.jsx("button",{onClick:()=>f(!0),className:"bg-black border border-white/20 rounded-full w-5 h-5 flex items-center justify-center text-gray-400 hover:text-white hover:bg-gray-800 transition-colors",title:"Add 2nd Track",children:e.jsx(sa,{})})}),e.jsx(Sr,{index:1,label:"Track B",isActive:c,onClose:()=>f(!1)}),c&&e.jsx("div",{className:"px-2 pt-1",children:e.jsx(Me,{label:"Crossfade",value:u,min:0,max:1,step:.01,onChange:g})})]})]}),e.jsxs("div",{className:"flex-1 overflow-y-auto custom-scroll p-1",children:[e.jsx(qn,{}),e.jsx(Yn,{featureId:"audio",sliceState:{},actions:{}})]})]})},zu=({state:a,actions:t})=>{const o=Y(s=>s.setHistogramLayer),r=a.texturing,n=a.coloring,i=t.setTexturing;return v.useEffect(()=>{o(0)},[o]),!r||!n?null:e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"p-2 bg-gray-900/50 border-b border-white/5",children:e.jsx(Ge,{value:r.active,onChange:s=>i({active:s}),options:[{label:"Gradient",value:!1},{label:"Image Texture",value:!0}]})}),r.active?e.jsxs("div",{className:"p-1 space-y-2","data-help-id":"grad.texture",children:[e.jsx("div",{className:"p-1",children:e.jsx(Ce,{featureId:"texturing",groupFilter:"main"})}),e.jsx("div",{className:"bg-gray-900/20 px-1 py-2 rounded",children:e.jsx(Ce,{featureId:"texturing",groupFilter:"mapping"})}),e.jsx("div",{className:"px-1 pb-2",children:e.jsx(Ce,{featureId:"texturing",groupFilter:"transform"})}),e.jsx(Ce,{featureId:"coloring",groupFilter:"layer1_bottom",excludeParams:["twist"]})]}):e.jsxs("div",{className:"flex flex-col",children:[e.jsx(Ce,{featureId:"coloring",groupFilter:"layer1_grad"}),e.jsx(Ce,{featureId:"coloring",groupFilter:"layer1_top"}),e.jsx("div",{className:"mb-2",children:e.jsx(Ce,{featureId:"coloring",groupFilter:"layer1_hist"})}),e.jsx(Ce,{featureId:"coloring",groupFilter:"layer1_bottom"})]})]})},Fu=({state:a,actions:t})=>{const o=Y(i=>i.setHistogramLayer),r=a.coloring,n=r==null?void 0:r.mode2;return v.useEffect(()=>{o(1)},[o]),r?e.jsxs("div",{className:"flex flex-col","data-help-id":"grad.layer2",children:[e.jsx(Ce,{featureId:"coloring",groupFilter:"layer2_grad"}),e.jsx(Ce,{featureId:"coloring",groupFilter:"layer2_top"}),e.jsx("div",{className:"mb-2",children:e.jsx(Ce,{featureId:"coloring",groupFilter:"layer2_hist"})}),(n===6||n===8)&&e.jsx("div",{className:"mb-1",children:e.jsx(Ce,{featureId:"coloring",whitelistParams:["escape"]})}),e.jsx(Ce,{featureId:"coloring",groupFilter:"layer2_bottom"})]}):null},Iu=({state:a,actions:t})=>{const o=Y(n=>n.openContextMenu),r=n=>{const i=Oe(n.currentTarget);i.length>0&&(n.preventDefault(),n.stopPropagation(),o(n.clientX,n.clientY,[],i))};return e.jsxs("div",{className:"flex flex-col","data-help-id":"grad.noise",children:[e.jsx("div",{className:"t-section-header",onContextMenu:r,children:e.jsxs("div",{children:[e.jsx("label",{className:"text-[10px] text-green-400 font-bold uppercase tracking-widest block mb-1",children:"Procedural 3d noise"}),e.jsx("p",{className:"text-[9px] text-gray-500 font-normal normal-case tracking-normal",children:"Adds texture and surface detail."})]})}),e.jsx("div",{className:"p-1",children:e.jsx(Ce,{featureId:"coloring",groupFilter:"noise"})})]})},Eu=({state:a,actions:t})=>{const[o,r]=v.useState("Layer 1"),n=Y(s=>s.openContextMenu),i=s=>{const l=Oe(s.currentTarget);l.length>0&&(s.preventDefault(),s.stopPropagation(),n(s.clientX,s.clientY,[],l))};return e.jsxs("div",{className:"animate-fade-in -mx-4 -mt-4","data-help-id":"panel.gradient",children:[e.jsx("div",{className:"flex bg-black/40 border-b border-white/10 mb-0",onContextMenu:i,children:["Layer 1","Layer 2","Noise"].map(s=>e.jsxs("button",{onClick:()=>r(s),className:`flex-1 py-2.5 text-[10px] font-bold uppercase tracking-widest transition-all relative ${o===s?"text-cyan-400 bg-white/5":"text-gray-500 hover:text-gray-300 hover:bg-white/5"}`,children:[s,o===s&&e.jsx("div",{className:"absolute bottom-[-1px] left-0 right-0 h-0.5 bg-cyan-500 shadow-[0_0_8px_rgba(34,211,238,0.5)]"})]},s))}),e.jsxs("div",{className:"flex flex-col",children:[o==="Layer 1"&&e.jsx(zu,{state:a,actions:t}),o==="Layer 2"&&e.jsx(Fu,{state:a,actions:t}),o==="Noise"&&e.jsx(Iu,{state:a,actions:t})]})]})},Mr=["TAB","CTRL","ALT","SHIFT","SPACE","LMB","MMB","RMB","SCROLL UP","SCROLL DOWN","Z","Y","H","T","1","2","3","4","5","6"],Cr={Q:{x:0,y:0,label:"Q "},W:{x:1,y:0,label:"W "},E:{x:2,y:0,label:"E "},A:{x:0,y:1,label:"A "},S:{x:1,y:1,label:"S "},D:{x:2,y:1,label:"D "},C:{x:1,y:2,label:"C "}},Nu={KeyW:"W",KeyA:"A",KeyS:"S",KeyD:"D",KeyQ:"Q",KeyE:"E",KeyC:"C",Space:"SPACE",ShiftLeft:"SHIFT",ShiftRight:"SHIFT",ControlLeft:"CTRL",ControlRight:"CTRL",AltLeft:"ALT",AltRight:"ALT",Tab:"TAB",KeyZ:"Z",KeyY:"Y",KeyH:"H",KeyT:"T",Digit1:"1",Digit2:"2",Digit3:"3",Digit4:"4",Digit5:"5",Digit6:"6"},Du={0:"LMB",1:"MMB",2:"RMB"},Lu=()=>e.jsxs("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("circle",{cx:"12",cy:"12",r:"3"}),e.jsx("path",{d:"M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"})]}),Au=["normal","screen","overlay","lighten","difference"],_u=({sliceState:a,actions:t})=>{const r=66.66666666666667,n=.7,{isEnabled:i,opacity:s,posX:l,posY:d,width:c,height:f,cropL:u,cropR:p,cropT:h,cropB:g,blendMode:M,crtMode:m,tilt:y,fontSize:x}=a,C=t.setWebcam,k=v.useRef(null),S=v.useRef(null),[b,w]=v.useState(!1),[j,T]=v.useState(null),L=v.useRef(0),_=v.useRef(null),R=v.useRef(new Set),z=v.useRef(new Map),E=v.useRef(null),[N,P]=v.useState(!1);v.useEffect(()=>{if(!i){k.current&&k.current.srcObject&&k.current.srcObject.getTracks().forEach(re=>re.stop());return}T(null);const I=document.createElement("video");I.autoplay=!0,I.muted=!0,I.playsInline=!0,k.current=I,(async()=>{try{const J=await navigator.mediaDevices.getUserMedia({video:{width:640,height:480,frameRate:{ideal:24}}});k.current&&(k.current.srcObject=J,k.current.play().catch(re=>{console.error("Webcam play error",re),T("Video blocked. Check browser privacy settings.")}))}catch(J){console.error("Webcam access denied:",J),J.name==="NotAllowedError"||J.name==="PermissionDeniedError"?T("Camera Blocked: Check browser permissions or HTTPS."):J.name==="NotFoundError"?T("No camera found."):T("Camera Error: "+J.message)}})();const G=J=>{const re=Nu[J.code];re&&(J.type==="keydown"?R.current.add(re):R.current.delete(re))},q=J=>{const re=Du[J.button];re&&(J.type==="mousedown"?R.current.add(re):R.current.delete(re))},Q=J=>{const re=J.deltaY<0?"SCROLL UP":"SCROLL DOWN";z.current.set(re,1)};return window.addEventListener("keydown",G),window.addEventListener("keyup",G),window.addEventListener("mousedown",q),window.addEventListener("mouseup",q),window.addEventListener("wheel",Q,{passive:!0}),()=>{k.current&&k.current.srcObject&&k.current.srcObject.getTracks().forEach(re=>re.stop()),window.removeEventListener("keydown",G),window.removeEventListener("keyup",G),window.removeEventListener("mousedown",q),window.removeEventListener("mouseup",q),window.removeEventListener("wheel",Q)}},[i]);const $=v.useCallback(I=>{const D=(I-(L.current||I))/1e3;if([...Mr,...Object.keys(Cr)].forEach(G=>{let q=z.current.get(G)||0;R.current.has(G)?q=1:q-=D/n,q=Math.max(0,Math.min(1,q)),z.current.set(G,q)}),I-L.current>r){const G=S.current,q=k.current;if(G){const Q=G.getContext("2d",{alpha:!1});if(Q){if(L.current=I,(G.width!==c||G.height!==f)&&(G.width=c,G.height=f),Q.fillStyle="#000000",Q.fillRect(0,0,c,f),!j&&q&&q.readyState===q.HAVE_ENOUGH_DATA){const J=q.videoWidth,re=q.videoHeight,U=J*u,V=re*h,te=J*(1-u-p),K=re*(1-h-g);te>0&&K>0&&(Q.save(),Q.translate(c,0),Q.scale(-1,1),Q.drawImage(q,U,V,te,K,0,0,c,f),Q.restore())}else j&&(Q.fillStyle="#330000",Q.fillRect(0,0,c,f),Q.fillStyle="#ff5555",Q.font=`bold ${Math.max(10,x)}px monospace`,Q.textAlign="center",Q.textBaseline="middle",j.split(" "),Q.fillText(j,c/2,f/2));O(Q,c,f),X(Q)}}}_.current=requestAnimationFrame($)},[u,p,h,g,c,f,x,i,j]);v.useEffect(()=>{if(i)return _.current=requestAnimationFrame($),()=>{_.current&&cancelAnimationFrame(_.current)}},[$,i]);const O=(I,D,G)=>{I.font=`bold ${x}px monospace`,I.textAlign="left",I.textBaseline="bottom";let q=10;const Q=G-10,J=x*1.6+4;Mr.forEach(re=>{const U=z.current.get(re)||0;if(U<=.01)return;const V=I.measureText(re),te=x,K=V.width+te;q+K>D||(I.fillStyle=`rgba(0, 0, 0, ${.8*U})`,I.fillRect(q,Q-J,K,J),I.fillStyle=`rgba(255, 255, 255, ${U})`,I.fillText(re,q+te/2,Q-J*.25),q+=K+4)})},X=I=>{const D=x*2.8,G=3,q=10,Q=10;I.font=`bold ${x}px monospace`,I.textAlign="center",I.textBaseline="middle",Object.entries(Cr).forEach(([J,re])=>{const U=z.current.get(J)||0;if(U<=.01)return;const V=q+re.x*(D+G),te=Q+re.y*(D+G);I.fillStyle=`rgba(0, 0, 0, ${.8*U})`,I.fillRect(V,te,D,D),I.fillStyle=`rgba(255, 255, 255, ${U})`,I.fillText(re.label,V+D/2,te+D/2+1)})},W=(I,D)=>{I.preventDefault(),I.stopPropagation(),E.current={type:D,startX:I.clientX,startY:I.clientY,startPos:{x:l,y:d},startSize:{w:c,h:f},startCrop:{l:u,r:p,t:h,b:g}},window.addEventListener("mousemove",H),window.addEventListener("mouseup",A)},H=v.useCallback(I=>{var he,de;if(!E.current)return;const{type:D,startX:G,startY:q,startPos:Q,startSize:J,startCrop:re}=E.current,U=I.clientX-G,V=I.clientY-q,te=((he=k.current)==null?void 0:he.videoWidth)||640,K=((de=k.current)==null?void 0:de.videoHeight)||480,ae=te*(1-re.l-re.r),se=K*(1-re.t-re.b),ee=J.w/Math.max(1,ae),ne=J.h/Math.max(1,se);if(D==="move")C({posX:Q.x+U,posY:Q.y+V});else if(D==="scale"){const oe=J.w/J.h,ye=Math.max(100,J.w+U);C({width:ye,height:ye/oe})}else if(D==="crop-l"){const oe=Math.max(50,J.w-U),ye=Q.x+(J.w-oe),pe=(J.w-oe)/ee/te;C({posX:ye,width:oe,cropR:Math.min(.9,Math.max(0,re.r+pe))})}else if(D==="crop-r"){const oe=Math.max(50,J.w+U),ye=(J.w-oe)/ee/te;C({width:oe,cropL:Math.min(.9,Math.max(0,re.l+ye))})}else if(D==="crop-t"){const oe=Math.max(50,J.h-V),ye=Q.y+(J.h-oe),pe=(J.h-oe)/ne/K;C({posY:ye,height:oe,cropT:Math.min(.9,Math.max(0,re.t+pe))})}else if(D==="crop-b"){const oe=Math.max(50,J.h+V),ye=(J.h-oe)/ne/K;C({height:oe,cropB:Math.min(.9,Math.max(0,re.b+ye))})}},[C]),A=()=>{E.current=null,window.removeEventListener("mousemove",H),window.removeEventListener("mouseup",A)};if(!i)return null;const F=Au[Math.floor(M)]||"normal";return e.jsxs("div",{className:"absolute select-none",style:{left:l,top:d,width:c,height:f,cursor:"move",pointerEvents:"auto"},onMouseDown:I=>{I.target.closest(".settings-panel")||W(I,"move")},onMouseEnter:()=>P(!0),onMouseLeave:()=>{P(!1),w(!1)},children:[e.jsx("div",{className:"absolute inset-0 w-full h-full pointer-events-none",style:{mixBlendMode:F,perspective:"1000px"},children:e.jsxs("div",{className:"w-full h-full",style:{opacity:Math.min(1,s),filter:s>1?`brightness(${s})`:"none",transform:`rotateY(${y}deg)`,transformStyle:"preserve-3d"},children:[e.jsx("canvas",{ref:S,className:"w-full h-full block"}),m&&e.jsx("div",{className:"absolute inset-0 opacity-40 mix-blend-overlay",style:{background:"linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06))",backgroundSize:"100% 4px, 6px 100%"}})]})}),e.jsxs("div",{className:"absolute inset-0 w-full h-full",children:[e.jsx("div",{className:`absolute top-2 right-2 transition-opacity duration-200 z-50 ${N?"opacity-100":"opacity-0 pointer-events-none"}`,children:e.jsx("button",{onClick:I=>{I.stopPropagation(),w(!b)},className:"p-1.5 rounded bg-black/60 text-gray-400 hover:text-white hover:bg-black/80 border border-white/10 shadow-lg backdrop-blur-sm",children:e.jsx(Lu,{})})}),b&&e.jsx("div",{className:"settings-panel absolute top-10 right-2 w-48 bg-[#151515] border border-white/20 rounded p-2 shadow-2xl z-50 animate-fade-in",onMouseDown:I=>I.stopPropagation(),children:e.jsxs("div",{className:"space-y-2 text-[10px]",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-gray-500 font-bold uppercase block mb-1",children:"Blend Mode"}),e.jsxs("select",{value:Math.floor(M),onChange:I=>C({blendMode:Number(I.target.value)}),className:"w-full bg-black border border-gray-700 rounded px-1 py-1 text-white outline-none cursor-pointer",children:[e.jsx("option",{value:0,children:"Normal"}),e.jsx("option",{value:1,children:"Screen"}),e.jsx("option",{value:2,children:"Overlay"}),e.jsx("option",{value:3,children:"Lighten"}),e.jsx("option",{value:4,children:"Difference"})]})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex justify-between text-gray-500 font-bold uppercase mb-1",children:[e.jsx("span",{children:"Opacity"}),e.jsxs("span",{children:[Math.round(s*100),"%"]})]}),e.jsx("input",{type:"range",min:"0",max:"3",step:"0.05",value:s,onChange:I=>C({opacity:parseFloat(I.target.value)}),className:"w-full h-1 bg-gray-700 rounded-lg appearance-none cursor-pointer"})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex justify-between text-gray-500 font-bold uppercase mb-1",children:[e.jsx("span",{children:"3D Tilt"}),e.jsxs("span",{children:[y,""]})]}),e.jsx("input",{type:"range",min:"-45",max:"45",step:"1",value:y,onChange:I=>C({tilt:parseInt(I.target.value)}),className:"w-full h-1 bg-gray-700 rounded-lg appearance-none cursor-pointer"})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex justify-between text-gray-500 font-bold uppercase mb-1",children:[e.jsx("span",{children:"Font Size"}),e.jsxs("span",{children:[x,"px"]})]}),e.jsx("input",{type:"range",min:"8",max:"32",step:"1",value:x,onChange:I=>C({fontSize:parseInt(I.target.value)}),className:"w-full h-1 bg-gray-700 rounded-lg appearance-none cursor-pointer"})]}),e.jsxs("label",{className:"flex items-center gap-2 cursor-pointer mt-1 pt-1 border-t border-white/10",children:[e.jsx("input",{type:"checkbox",checked:m,onChange:I=>C({crtMode:I.target.checked}),className:"cursor-pointer"}),e.jsx("span",{className:"text-gray-400 font-bold uppercase",children:"CRT Scanlines"})]})]})}),e.jsxs("div",{className:`transition-opacity duration-200 ${N?"opacity-100":"opacity-0 pointer-events-none"}`,children:[e.jsx("div",{className:"absolute bottom-[-6px] right-[-6px] w-6 h-6 bg-cyan-500/50 cursor-nwse-resize hover:bg-cyan-400 z-20 rounded-full border-2 border-black",onMouseDown:I=>W(I,"scale")}),e.jsx("div",{className:"absolute top-4 bottom-4 left-[-4px] w-3 cursor-e-resize group/l z-10 flex items-center justify-center",onMouseDown:I=>W(I,"crop-l"),children:e.jsx("div",{className:"w-1 h-8 bg-red-500/50 group-hover/l:bg-red-400 rounded-full"})}),e.jsx("div",{className:"absolute top-4 bottom-4 right-[-4px] w-3 cursor-w-resize group/r z-10 flex items-center justify-center",onMouseDown:I=>W(I,"crop-r"),children:e.jsx("div",{className:"w-1 h-8 bg-red-500/50 group-hover/r:bg-red-400 rounded-full"})}),e.jsx("div",{className:"absolute left-4 right-4 top-[-4px] h-3 cursor-s-resize group/t z-10 flex items-center justify-center",onMouseDown:I=>W(I,"crop-t"),children:e.jsx("div",{className:"h-1 w-8 bg-red-500/50 group-hover/t:bg-red-400 rounded-full"})}),e.jsx("div",{className:"absolute left-4 right-4 bottom-[-4px] h-3 cursor-n-resize group/b z-10 flex items-center justify-center",onMouseDown:I=>W(I,"crop-b"),children:e.jsx("div",{className:"h-1 w-8 bg-red-500/50 group-hover/b:bg-red-400 rounded-full"})})]})]})]})},Bu=()=>{const a=Y(r=>{var n;return(n=r.debugTools)==null?void 0:n.shaderDebuggerOpen}),t=Y.getState().setDebugTools,o=r=>{t&&t({shaderDebuggerOpen:r})};return v.useEffect(()=>{window.openShaderDebugger=()=>o(!0)},[]),a?e.jsx(Yt,{title:"GLSL Debugger",initialPos:{x:20,y:window.innerHeight-400},onClose:()=>o(!1),initialSize:{width:640,height:480},zIndex:600,children:e.jsx(Ou,{onClose:()=>o(!1)})}):null},Ou=({onClose:a})=>{const[t,o]=v.useState(B.lastGeneratedFrag||"// Waiting for compilation..."),[r,n]=v.useState("Generator"),i=v.useRef(null),[s,l]=v.useState("");v.useEffect(()=>{if(r==="Generator")return le.on("shader_code",M=>o(M))},[r]);const d=v.useMemo(()=>{const g=t.split(`
`).length,M=t.length,m=/for\s*\(|while\s*\(|loop\s*\{/i.test(t),y=g>5e3;let x="Good",C="Structure looks optimized.";return r==="Translated"&&(y?(x="Critical",C="CRITICAL: Excessive code size. Loop likely unrolled."):m||(x="Warn",C="Warning: No loop instructions found in output.")),{lines:g,size:M,health:x,message:C}},[t,r]),c=()=>{const g=`
You are an expert GLSL Fractal shader engineer. 
Below is the current raw GLSL fragment shader from my engine. 
The engine uses Raymarching with a Distance Estimator (DE).

I want you to modify this code. 
- Maintain the existing uniforms and function signatures.
- Focus on the 'formula_' function or the 'DE' function.
- Do not remove the 'DE_MASTER' structure.

Here is the code:

\`\`\`glsl
${t}
\`\`\`

My Request: 
`;navigator.clipboard&&(navigator.clipboard.writeText(g).catch(()=>{}),l("Copied Context!"),setTimeout(()=>l(""),2e3))},f=()=>{const g=new Blob([t],{type:"text/plain"}),M=URL.createObjectURL(g),m=document.createElement("a");m.href=M,m.download=`fractal_${r.toLowerCase()}_${Date.now()}.glsl`,document.body.appendChild(m),m.click(),document.body.removeChild(m),URL.revokeObjectURL(M)},u=()=>{console.log("ShaderDebugger: Fetching compiled GLSL...");const g=B.getCompiledFragmentShader();g?(o(g),n("GLSL")):alert("Could not fetch compiled source. Is the renderer active?")},p=()=>{console.log("ShaderDebugger: Fetching translated source (ANGLE)...");const g=B.getTranslatedFragmentShader();g?(o(g),n("Translated")):alert(`Could not fetch translated source.

Possible reasons:
1. Browser doesn't support WEBGL_debug_shaders
2. Privacy settings block debug extensions
3. Not on Windows (DirectX/ANGLE)`)},h=()=>{o(B.lastGeneratedFrag),n("Generator")};return e.jsxs("div",{className:"flex flex-col h-full w-full",children:[e.jsxs("div",{className:"flex flex-col gap-2 mb-2 bg-black/20 p-2 rounded",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("div",{className:"flex gap-1",children:[e.jsx("button",{onClick:h,className:`px-3 py-1.5 text-[10px] font-bold uppercase tracking-wide rounded border transition-colors ${r==="Generator"?"bg-cyan-900/40 border-cyan-600 text-cyan-200":"bg-gray-800 border-gray-600 text-gray-400"}`,children:"Generator"}),e.jsx("button",{onClick:u,className:`px-3 py-1.5 text-[10px] font-bold uppercase tracking-wide rounded border transition-colors ${r==="GLSL"?"bg-green-900/40 border-green-600 text-green-200":"bg-gray-800 border-gray-600 text-gray-400"}`,children:"Driver GLSL"}),e.jsx("button",{onClick:p,className:`px-3 py-1.5 text-[10px] font-bold uppercase tracking-wide rounded border transition-colors ${r==="Translated"?"bg-amber-900/40 border-amber-600 text-amber-200":"bg-gray-800 border-gray-600 text-gray-400"}`,title:"View ANGLE/HLSL output to check loop unrolling",children:"Translated (ANGLE)"})]}),e.jsxs("div",{className:"flex gap-2 items-center",children:[s&&e.jsx("span",{className:"text-[9px] text-green-400 font-bold animate-fade-in",children:s}),e.jsxs("button",{onClick:c,className:"px-2 py-1 bg-purple-900/30 hover:bg-purple-800 text-purple-300 text-[10px] rounded border border-purple-800 transition-colors flex items-center gap-1",title:"Copy code wrapped in a prompt for ChatGPT/Claude",children:[e.jsx("span",{children:""})," Copy for AI"]}),e.jsx("button",{onClick:f,className:"px-2 py-1 bg-gray-800 hover:bg-gray-700 text-gray-300 text-[10px] rounded border border-gray-600 transition-colors",children:"Save"})]})]}),e.jsxs("div",{className:"flex items-center justify-between border-t border-white/5 pt-2 mt-1",children:[e.jsxs("div",{className:"flex gap-4 text-[10px] font-mono text-gray-400",children:[e.jsxs("span",{children:["Lines: ",e.jsx("span",{className:"text-white",children:d.lines.toLocaleString()})]}),e.jsxs("span",{children:["Size: ",e.jsxs("span",{className:"text-white",children:[(d.size/1024).toFixed(1)," KB"]})]})]}),e.jsxs("div",{className:`text-[10px] font-bold uppercase tracking-wider px-2 py-0.5 rounded border flex items-center gap-2 ${d.health==="Good"?"bg-green-900/20 text-green-400 border-green-500/30":d.health==="Warn"?"bg-yellow-900/20 text-yellow-400 border-yellow-500/30":"bg-red-900/20 text-red-400 border-red-500/30"}`,children:[e.jsx("div",{className:`w-2 h-2 rounded-full ${d.health==="Good"?"bg-green-500":d.health==="Warn"?"bg-yellow-500 animate-pulse":"bg-red-500 animate-ping"}`}),d.message]})]})]}),e.jsxs("div",{className:"relative flex-1 min-h-0",children:[r!=="Generator"&&e.jsx("div",{className:"absolute top-2 right-4 pointer-events-none bg-amber-500/10 text-amber-500 px-2 py-1 rounded text-[8px] font-bold border border-amber-500/20 backdrop-blur-sm z-10",children:"READ ONLY (GPU MEMORY)"}),e.jsx("textarea",{ref:i,className:`w-full h-full font-mono text-[10px] p-2 resize-none outline-none border rounded custom-scroll whitespace-pre ${r==="Translated"?"bg-[#0f0b00] text-amber-200/80 border-amber-900/30":r==="GLSL"?"bg-[#000f05] text-green-200/80 border-green-900/30":"bg-[#080808] text-gray-300 border-white/10"}`,value:t,readOnly:!0,spellCheck:!1})]})]})},$u=()=>{const a=Y(m=>{var y;return(y=m.debugTools)==null?void 0:y.stateDebuggerOpen}),t=Y.getState().setDebugTools,o=m=>{t&&t({stateDebuggerOpen:m})},r=Y(m=>m.loadPreset),n=Y(m=>m.getPreset),[i,s]=v.useState(""),[l,d]=v.useState(""),[c,f]=v.useState(null),[u,p]=v.useState(null),h=()=>{p(null),f(null);let m=i.trim();if(m.includes("#s=")&&(m=m.split("#s=")[1]),!m){p("Empty string");return}const y=fo(m);y?(d(JSON.stringify(y,null,2)),f(y)):p("Decoder returned null. String might be malformed or incompatible.")},g=()=>{c&&(r(c),o(!1))},M=()=>{const m=n({includeScene:!0});d(JSON.stringify(m,null,2)),s(""),f(null)};return a?e.jsx(Yt,{title:"State & URL Debugger",initialPos:{x:100,y:100},initialSize:{width:500,height:600},onClose:()=>o(!1),zIndex:600,children:e.jsxs("div",{className:"flex flex-col h-full gap-3",children:[e.jsxs("div",{className:"flex flex-col gap-1",children:[e.jsx("label",{className:"text-[10px] font-bold text-gray-500 uppercase",children:"Input (URL Hash or Base64)"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("input",{type:"text",className:"flex-1 bg-black/40 border border-white/10 rounded px-2 py-1 text-xs text-white font-mono outline-none focus:border-cyan-500",placeholder:"Paste #s=... string here",value:i,onChange:m=>s(m.target.value)}),e.jsx("button",{onClick:h,className:"px-3 py-1 bg-cyan-900/50 hover:bg-cyan-800 text-cyan-300 text-xs font-bold rounded border border-cyan-500/30",children:"Decode"})]})]}),e.jsxs("div",{className:"flex gap-2 border-b border-white/10 pb-2",children:[e.jsx("button",{onClick:M,className:"px-3 py-1.5 bg-gray-800 hover:bg-gray-700 text-gray-300 text-[10px] font-bold uppercase rounded border border-white/10",children:"Dump Current State"}),c&&e.jsx("button",{onClick:g,className:"px-3 py-1.5 bg-green-900/50 hover:bg-green-800 text-green-300 text-[10px] font-bold uppercase rounded border border-green-500/30 ml-auto",children:"Apply Decoded to Scene"})]}),u&&e.jsx("div",{className:"p-2 bg-red-900/30 border border-red-500/30 text-red-200 text-xs font-mono rounded",children:u}),e.jsxs("div",{className:"flex-1 flex flex-col min-h-0",children:[e.jsx("label",{className:"text-[10px] font-bold text-gray-500 uppercase mb-1",children:"State Inspector (JSON)"}),e.jsx("textarea",{className:"flex-1 bg-[#0a0a0a] border border-white/10 rounded p-2 text-[10px] font-mono text-green-400/80 resize-none outline-none custom-scroll",value:l,readOnly:!0})]})]})}):null},Hu=({sliceState:a,actions:t})=>e.jsxs(e.Fragment,{children:[e.jsx(Bu,{}),e.jsx($u,{})]}),Uu=({className:a="-m-4"})=>{const t=Y(),[o,r]=v.useState({}),[n,i]=v.useState(null),[s,l]=v.useState(!1),d=v.useMemo(()=>{const m={};return["lighting","ao","geometry","reflections","quality","atmosphere"].forEach(x=>{t[x]&&(m[x]={...t[x]})}),Object.entries(o).forEach(([x,C])=>{const[k,S]=x.split(".");m[k]&&(m[k][S]=C)}),m},[t,o]),c=lo(d),f=c.charAt(0).toUpperCase()+c.slice(1),u=ve.getEngineFeatures();v.useEffect(()=>{const m=le.on("compile_time",x=>{i(`Compiled (${x.toFixed(2)}s)`),l(!1),setTimeout(()=>i(null),3e3)}),y=le.on("is_compiling",x=>{l(!!x)});return()=>{m(),y()}},[]);const p=(m,y,x)=>{var T,L;const C=ve.get(m),k=C==null?void 0:C.params[y],S=((T=C==null?void 0:C.engineConfig)==null?void 0:T.toggleParam)===y,b=(L=C==null?void 0:C.engineConfig)==null?void 0:L.mode,w=(k==null?void 0:k.onUpdate)==="compile";if(S&&b==="compile"||w){const _=`${m}.${y}`,R=t[m];if(R&&R[y]===x){const z={...o};delete z[_],r(z)}else r(z=>({...z,[_]:x}));i(null)}else{const _=`set${m.charAt(0).toUpperCase()+m.slice(1)}`,R=t[_];R&&R({[y]:x});const z=`${m}.${y}`;if(o[z]!==void 0){const E={...o};delete E[z],r(E)}}},h=()=>{le.emit("is_compiling","Compiling Shaders...");const m={};Object.entries(o).forEach(([y,x])=>{const[C,k]=y.split(".");m[C]||(m[C]={}),m[C][k]=x}),setTimeout(()=>{Object.entries(m).forEach(([y,x])=>{const C=`set${y.charAt(0).toUpperCase()+y.slice(1)}`,k=t[C];k&&k(x)}),r({})},100)},g=m=>{if(m==="Custom")return;const y=Lt[m];if(!y)return;const x={};Object.entries(y).forEach(([C,k])=>{Object.entries(k).forEach(([S,b])=>{var T;const w=(T=t[C])==null?void 0:T[S];let j=w!==b;typeof b=="number"&&typeof w=="number"&&(j=Math.abs(b-w)>.001),j&&(x[`${C}.${S}`]=b)})}),r(x),i(null)},M=m=>{const y=t[m];if(!y)return{};const x={...y};return Object.entries(o).forEach(([C,k])=>{const[S,b]=C.split(".");S===m&&(x[b]=k)}),x};return e.jsxs("div",{className:`flex flex-col h-full bg-[#080808] min-h-0 overflow-hidden ${a}`,"data-help-id":"panel.engine",children:[e.jsxs("div",{className:"px-3 py-2 bg-black/60 border-b border-white/10 flex items-center justify-between shrink-0",children:[e.jsx("span",{className:"text-[10px] font-bold text-gray-400 uppercase tracking-wider",children:"Engine Configuration"}),e.jsx("div",{className:"w-32",children:e.jsx(vt,{value:f,options:[{label:"Fastest (Bare)",value:"Fastest"},{label:"Lite (Fast)",value:"Lite"},{label:"Balanced",value:"Balanced"},{label:"Ultra",value:"Ultra"},{label:"Custom",value:"Custom"}],onChange:m=>g(m.toLowerCase())})})]}),e.jsxs("div",{className:"flex-1 overflow-y-auto custom-scroll p-0 min-h-0",children:[e.jsxs("div",{className:"flex gap-2 items-center px-3 py-2 bg-blue-900/10 border-b border-white/5 mb-1 shrink-0",children:[e.jsx("div",{className:"text-blue-400",children:e.jsx(ho,{})}),e.jsxs("p",{className:"text-[9px] text-blue-200/80 leading-tight",children:[e.jsx("span",{className:"text-green-400",children:""})," Compiled ",e.jsx("span",{className:"text-amber-400",children:""})," Pending ",e.jsx("span",{className:"text-blue-400",children:""})," Instant"]})]}),e.jsx("div",{className:"flex flex-col",children:u.map(m=>{const y=m.engineConfig,x=M(m.id),C=y.toggleParam,k=x[C],S=`${m.id}.${C}`,w=o[S]!==void 0?"pending":"synced";return e.jsxs("div",{className:"group",children:[e.jsx(ao,{label:y.label,description:y.description,isActive:k,onToggle:j=>p(m.id,C,j),status:w}),k&&y.groupFilter&&e.jsx("div",{className:"ml-4 pl-2 border-l border-white/10 my-0.5",children:e.jsx(Ce,{featureId:m.id,groupFilter:y.groupFilter,excludeParams:[y.toggleParam],variant:"dense",forcedState:x,onChangeOverride:(j,T)=>p(m.id,j,T),pendingChanges:o})})]},m.id)})})]}),e.jsx("div",{className:"px-3 py-2 bg-[#1a1a1a] border-t border-white/10 flex items-center justify-between min-h-[40px] shrink-0 z-10",children:s?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex items-center gap-2 text-cyan-400 text-[10px] font-bold uppercase tracking-wider",children:[e.jsx(jn,{className:"animate-spin h-3 w-3"}),e.jsx("span",{children:"Compiling..."})]}),e.jsx("div",{className:"text-[9px] text-gray-500",children:"Please wait"})]}):Object.keys(o).length>0?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex items-center gap-2 text-amber-500 text-[10px] font-bold uppercase tracking-wider animate-pulse",children:[e.jsx(Zt,{}),e.jsx("span",{children:"Changes Pending"})]}),e.jsxs("button",{onClick:h,disabled:s,className:"px-4 py-1 bg-amber-600 hover:bg-amber-500 disabled:bg-gray-600 disabled:cursor-not-allowed text-black font-bold uppercase text-[10px] rounded transition-colors flex items-center gap-1",children:[e.jsx(xt,{})," Apply"]})]}):e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"text-[10px] text-gray-600 font-medium",children:"System Ready"}),n&&e.jsxs("div",{className:"text-[10px] text-green-400 font-bold uppercase animate-fade-in flex items-center gap-1",children:[e.jsx(xt,{})," ",n]})]})})]})};class Gu{constructor(){Z(this,"ctx",null);Z(this,"masterGainNode",null);Z(this,"oscillators",[]);Z(this,"gains",[]);Z(this,"harmonicRatios",[1,19/9,15/9]);Z(this,"nextNoteTime",0);Z(this,"patternIndex",0);Z(this,"isInitialized",!1)}init(){if(this.ctx)return;const t=window.AudioContext||window.webkitAudioContext;this.ctx=new t,this.masterGainNode=this.ctx.createGain(),this.masterGainNode.gain.value=0,this.masterGainNode.connect(this.ctx.destination);for(let o=0;o<3;o++){const r=this.ctx.createOscillator(),n=this.ctx.createGain();r.type=o===0?"sine":"triangle",r.frequency.value=100,n.gain.value=0,r.connect(n),n.connect(this.masterGainNode),r.start(),this.oscillators.push(r),this.gains.push(n)}this.isInitialized=!0,this.nextNoteTime=this.ctx.currentTime}resume(){this.ctx&&this.ctx.state==="suspended"&&this.ctx.resume()}setMasterGain(t){this.masterGainNode&&this.masterGainNode.gain.setTargetAtTime(t,this.ctx.currentTime,.1)}update(t,o,r){if(!this.ctx||!this.isInitialized)return;const n=this.ctx.currentTime,i=Math.max(.1,Math.min(10,t));this.oscillators.forEach((d,c)=>{const f=this.harmonicRatios[c],u=Math.min(12e3,o*i*f);d.frequency.setTargetAtTime(u,n,.1)});const s=.05,l=.1;for(this.nextNoteTime<n&&(this.nextNoteTime=n);this.nextNoteTime<n+l;)r.forEach((d,c)=>{const f=d[this.patternIndex%d.length],u=this.gains[c],h=f===1?c===0?.8:.4:0;u.gain.setValueAtTime(h,this.nextNoteTime),f===1&&u.gain.exponentialRampToValueAtTime(.01,this.nextNoteTime+s)}),this.nextNoteTime+=s,this.patternIndex++}stop(){this.masterGainNode&&this.masterGainNode.gain.setTargetAtTime(0,this.ctx.currentTime,.1)}}const kt=new Gu,Wu=.007297,qu=[{label:"ln3/ln2",val:Math.log(3)/Math.log(2)},{label:"ln4/ln3",val:Math.log(4)/Math.log(3)},{label:"ln5/ln3",val:Math.log(5)/Math.log(3)},{label:"Golden",val:1.61803},{label:"Sqrt(2)",val:1.41421},{label:"ln(2)",val:Math.log(2*Math.PI)}],Xu=({sliceState:a})=>{const t=a,o=t.lastDimension||0;At.useEffect(()=>{kt.isInitialized||kt.init()},[]);const r=()=>{const l=Y.getState().setSonification;l({active:!t.active}),t.active||kt.resume()};let n=!1,i="",s=1/0;return qu.forEach(l=>{const d=Math.abs(o-l.val);d<s&&(s=d),d<Wu&&(n=!0,i=l.label)}),e.jsxs("div",{className:"-m-3 flex flex-col h-full","data-help-id":"panel.sonification",children:[e.jsxs("div",{className:"p-3 bg-black/40 border-b border-white/5",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx("span",{className:"w-2 h-2 rounded-full bg-purple-500 shadow-[0_0_5px_purple]"}),e.jsx("h3",{className:"text-[10px] font-black text-gray-300 uppercase tracking-[0.2em]",children:"FHBT Audio"})]}),e.jsx(gt,{onClick:r,variant:t.active?"success":"danger",label:t.active?"AUDIO ACTIVE":"MUTED",className:"mb-2"}),e.jsxs("div",{className:`mt-2 p-2 rounded border transition-all duration-300 ${n?"bg-green-900/30 border-green-500/50 shadow-[0_0_15px_rgba(34,197,94,0.2)]":"bg-black/40 border-white/10"}`,children:[e.jsxs("div",{className:"flex justify-between items-baseline mb-1",children:[e.jsx("span",{className:"text-[9px] font-bold text-gray-400 uppercase tracking-widest",children:"Dimension D"}),e.jsx("span",{className:`font-mono font-bold text-xs ${n?"text-green-400":"text-cyan-400"}`,children:o.toFixed(4)})]}),e.jsx("div",{className:"flex justify-between items-center h-4",children:n?e.jsxs("span",{className:"text-[9px] font-black text-green-300 uppercase tracking-wider animate-pulse",children:["LOCK: ",i]}):e.jsxs("div",{className:"w-full flex items-center gap-1",children:[e.jsx("div",{className:"h-1 flex-1 bg-gray-800 rounded-full overflow-hidden",children:e.jsx("div",{className:"h-full bg-cyan-600 transition-all duration-200",style:{width:`${Math.max(0,1-s/.1)*100}%`}})}),e.jsx("span",{className:"text-[8px] text-gray-600 font-mono",children:s.toFixed(3)})]})})]})]}),e.jsx("div",{className:"p-1",children:e.jsx(Ce,{featureId:"sonification",groupFilter:"controls"})}),e.jsx("div",{className:"p-3 text-[9px] text-gray-500 leading-relaxed italic border-t border-white/5 mt-auto",children:"Transforms fractal complexity into polyrhythms (9:19:15) using logarithmic spiral sampling."})]})},Ma=256,Va=3,Yu=[9,19,15],Vu=()=>{const a=Y(r=>r.sonification),t=Y.getState().setSonification,o=v.useRef(null);return v.useEffect(()=>{const r=new bt,n=new Pt(-1,1,1,-1,0,1),i=new ft(Ma,Va,{minFilter:ct,magFilter:ct,format:at,type:Wt}),s=new Float32Array(Ma*Va*4),l=new jt(new Tt(2,2),B.physicsMaterial);return l.frustumCulled=!1,r.add(l),o.current={scene:r,camera:n,renderTarget:i,pixelBuffer:s,mesh:l,scratchMatrix:new We,camRight:new ie,camUp:new ie,camForward:new ie},()=>{i.dispose()}},[]),v.useEffect(()=>{if(!(a!=null&&a.active)||!(a!=null&&a.isEnabled)){kt.stop();return}let r=0,n=0;const i=()=>{if(!o.current||!B.renderer||!B.activeCamera){r=requestAnimationFrame(i);return}if(n++,n%2!==0){r=requestAnimationFrame(i);return}const{scene:s,camera:l,renderTarget:d,pixelBuffer:c,scratchMatrix:f,camRight:u,camUp:p,camForward:h}=o.current,g=B.renderer,M=B.activeCamera;o.current.mesh.material!==B.physicsMaterial&&(o.current.mesh.material=B.physicsMaterial);const m=a.scanArea||.1;f.makeRotationFromQuaternion(M.quaternion);const y=f.elements;u.set(y[0],y[1],y[2]),p.set(y[4],y[5],y[6]),h.set(-y[8],-y[9],-y[10]);const x=Math.tan(Ze.degToRad(M.fov)*.5);u.multiplyScalar(x*M.aspect*m),p.multiplyScalar(x*m);const C=B.physicsMaterial.uniforms;C.uTime&&(C.uTime.value=performance.now()/1e3),C[ce.CamBasisX].value.copy(u),C[ce.CamBasisY].value.copy(p),C[ce.CamForward].value.copy(h),B.virtualSpace.updateShaderUniforms(M.position,C[ce.SceneOffsetHigh].value,C[ce.SceneOffsetLow].value),C[ce.CameraPosition].value.set(0,0,0);const k=g.getRenderTarget();g.setRenderTarget(d),g.clear(),g.render(s,l),g.readRenderTargetPixels(d,0,0,Ma,Va,c),g.setRenderTarget(k);const S=Ma,b=[[],[],[]],w=[0,0,0],j=E=>{const N=c[E],P=c[E+1];return N>1e-4&&P>=0};for(let E=0;E<3;E++){const N=E*S*4,P=Yu[E],$=Math.floor(S/P);let O=0;for(let X=0;X<P;X++){let W=0;const H=X*$,A=H+$;for(let I=H;I<A;I++)j(N+I*4)&&(W++,O++);const F=W/$;b[E].push(F>.5?1:0)}w[E]=O/S}const T=Math.max(.001,w[0]),L=Math.max(.001,w[1]),_=Math.max(.001,w[2]),R=Math.cbrt(T*L*_),z=Math.pow(2,R);kt.resume(),kt.setMasterGain(a.masterGain),kt.update(z,a.baseFrequency,b),n%20===0&&t&&t({lastDimension:z}),r=requestAnimationFrame(i)};return i(),()=>{cancelAnimationFrame(r),kt.stop()}},[a==null?void 0:a.active,a==null?void 0:a.isEnabled,a==null?void 0:a.baseFrequency,a==null?void 0:a.masterGain,a==null?void 0:a.scanArea]),null},Zu=a=>{const t=new Be(a.x,a.y,a.z,a.w),o=new ie(0,0,-1).applyQuaternion(t),r=.98;return o.y>r?"Bottom View":o.y<-r?"Top View":o.x>r?"Left View":o.x<-r?"Right View":o.z>r?"Back View":o.z<-r?"Front View":null},Ku=(a,t)=>{let r=ot.getUnifiedFromEngine().length();r<.001&&(r=3.5);const n=new ie(0,0,0),i=new Be;let s=!0;switch(a){case"Front":i.setFromEuler(new qe(0,0,0));break;case"Back":i.setFromEuler(new qe(0,Math.PI,0));break;case"Left":i.setFromEuler(new qe(0,-Math.PI/2,0));break;case"Right":i.setFromEuler(new qe(0,Math.PI/2,0));break;case"Top":i.setFromEuler(new qe(-Math.PI/2,0,0));break;case"Bottom":i.setFromEuler(new qe(Math.PI/2,0,0));break;case"Isometric":s=!1;const h=Ze.degToRad(-35.264),g=Ze.degToRad(45);i.setFromEuler(new qe(h,g,0,"YXZ"));break}const l=new ie(0,0,-1).applyQuaternion(i),d=n.clone().sub(l.multiplyScalar(r)),c=s?1:0;let f=t?t.orthoScale:2,u=t?t.dofStrength:0,p;return s&&((!t||t.camType<.5)&&(f=r),u=0,p={camType:c,orthoScale:f,dofStrength:u}),{position:d,rotation:{x:i.x,y:i.y,z:i.z,w:i.w},targetDistance:r,optics:p}},kr=[{type:"none",label:"None"},{type:"thirds",label:"Rule of Thirds"},{type:"golden",label:"Golden Ratio"},{type:"grid",label:"Grid"},{type:"center",label:"Center Mark"},{type:"diagonal",label:"Diagonal"},{type:"spiral",label:"Spiral"},{type:"safearea",label:"Safe Areas"}],Qu=({className:a="-m-3"})=>{var _;const{savedCameras:t,activeCameraId:o,addCamera:r,deleteCamera:n,selectCamera:i,updateCamera:s,resetCamera:l}=Y(),d=Y(R=>R.optics),c=Y(R=>R.compositionOverlay),f=Y(R=>R.setCompositionOverlay),u=Y(R=>R.compositionOverlaySettings),p=Y(R=>R.setCompositionOverlaySettings),h=Y.getState().setOptics,[g,M]=v.useState(null),[m,y]=v.useState(""),[x,C]=v.useState(!1),k=R=>{M(R.id),y(R.label)},S=()=>{g&&(s(g,{label:m}),M(null))},b=R=>{R.key==="Enter"&&S(),R.key==="Escape"&&M(null)},w=()=>{i(null)},j=R=>{const z=Ku(R,d);ot.teleportPosition(z.position,z.rotation,z.targetDistance),z.optics&&h&&h(z.optics),i(null)},T=()=>{const R=ot.getRotationFromEngine();let z=`Camera ${t.length+1}`;const E=Y.getState().optics;if(E&&Math.abs(E.camType-1)<.1){const N=Zu(R);N&&(z=N)}r(z)},L=()=>{l(),h&&h({camType:0,camFov:60,orthoScale:2})};return e.jsxs("div",{className:`flex flex-col bg-[#080808] ${a}`,children:[e.jsxs("div",{className:"p-2 border-b border-white/10 bg-black/40 grid grid-cols-4 gap-1",children:[e.jsx("button",{onClick:()=>j("Front"),className:"bg-white/5 hover:bg-white/10 text-[9px] text-gray-400 rounded py-1",children:"FRONT"}),e.jsx("button",{onClick:()=>j("Back"),className:"bg-white/5 hover:bg-white/10 text-[9px] text-gray-400 rounded py-1",children:"BACK"}),e.jsx("button",{onClick:()=>j("Left"),className:"bg-white/5 hover:bg-white/10 text-[9px] text-gray-400 rounded py-1",children:"LEFT"}),e.jsx("button",{onClick:()=>j("Right"),className:"bg-white/5 hover:bg-white/10 text-[9px] text-gray-400 rounded py-1",children:"RIGHT"}),e.jsx("button",{onClick:()=>j("Top"),className:"bg-white/5 hover:bg-white/10 text-[9px] text-gray-400 rounded py-1",children:"TOP"}),e.jsx("button",{onClick:()=>j("Bottom"),className:"bg-white/5 hover:bg-white/10 text-[9px] text-gray-400 rounded py-1",children:"BTM"}),e.jsx("button",{onClick:()=>j("Isometric"),className:"bg-white/5 hover:bg-white/10 text-[9px] text-gray-400 rounded py-1",children:"ISO"}),e.jsx("button",{onClick:L,className:"bg-white/5 hover:bg-white/10 text-[9px] text-gray-400 rounded py-1",children:"RESET"}),e.jsxs("button",{onClick:T,className:"col-span-4 bg-cyan-900/40 hover:bg-cyan-800 text-cyan-300 border border-cyan-500/30 rounded py-1 text-[9px] font-bold uppercase flex items-center justify-center gap-1 mt-1",children:[e.jsx(sa,{})," New Camera"]})]}),e.jsxs("div",{className:"p-2 space-y-1",children:[t.length===0&&e.jsx("div",{className:"text-center text-gray-600 text-[10px] italic py-4",children:"No saved cameras"}),t.map(R=>{const z=o===R.id;return e.jsxs("div",{className:`flex items-center justify-between p-2 rounded border transition-all group ${z?"bg-cyan-900/20 border-cyan-500/50":"bg-white/5 border-transparent hover:border-white/10"}`,onClick:()=>i(R.id),children:[e.jsxs("div",{className:"flex items-center gap-2 flex-1 min-w-0",children:[e.jsx("div",{className:`w-2 h-2 rounded-full ${z?"bg-cyan-400 shadow-[0_0_5px_cyan]":"bg-gray-600"}`}),g===R.id?e.jsx("input",{type:"text",value:m,onChange:E=>y(E.target.value),onBlur:S,onKeyDown:b,autoFocus:!0,className:"bg-black border border-white/20 text-xs text-white px-1 py-0.5 rounded w-full outline-none",onClick:E=>E.stopPropagation()}):e.jsx("span",{className:`text-xs font-bold truncate cursor-text ${z?"text-white":"text-gray-400 group-hover:text-gray-300"}`,onDoubleClick:E=>{E.stopPropagation(),k(R)},title:"Double-click to rename",children:R.label})]}),e.jsx("button",{onClick:E=>{E.stopPropagation(),n(R.id)},className:"p-1.5 text-gray-600 hover:text-red-400 opacity-0 group-hover:opacity-100 transition-opacity",title:"Delete",children:e.jsx(St,{})})]},R.id)})]}),e.jsxs("div",{className:"border-t border-white/10 bg-black/40 p-2 space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-[10px] font-bold text-gray-500 uppercase tracking-wider",children:o?"Active Settings":"Free Camera"}),o&&e.jsx("button",{onClick:w,className:"text-[9px] text-gray-500 hover:text-white px-2 py-0.5 rounded border border-white/10 hover:bg-white/5 transition-colors",children:"Deselect"})]}),e.jsx("div",{className:"bg-white/5 rounded p-1",children:e.jsx(Ce,{featureId:"optics"})}),e.jsxs("div",{className:"border-t border-white/10 pt-2",children:[e.jsxs("button",{onClick:()=>C(!x),className:"w-full flex items-center justify-between hover:bg-white/5 transition-colors rounded",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[x?e.jsx(Rt,{}):e.jsx(Xt,{}),e.jsx("span",{className:"text-[9px] font-bold text-gray-500 uppercase tracking-wider",children:"Composition Guide"})]}),c!=="none"&&e.jsx("span",{className:"text-[8px] text-cyan-400 uppercase",children:(_=kr.find(R=>R.type===c))==null?void 0:_.label})]}),x&&e.jsxs("div",{className:"mt-2 space-y-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("label",{className:"text-[9px] text-gray-500 w-16",children:"Type"}),e.jsx("select",{value:c,onChange:R=>f(R.target.value),className:"flex-1 bg-black/40 border border-white/10 rounded px-2 py-1 text-[10px] text-gray-300 outline-none focus:border-cyan-500/50",children:kr.map(R=>e.jsx("option",{value:R.type,children:R.label},R.type))})]}),c!=="none"&&e.jsxs(e.Fragment,{children:[e.jsx(Me,{label:"Opacity",value:u.opacity,min:.1,max:1,step:.1,onChange:R=>p({opacity:R})}),e.jsx(Me,{label:"Line Width",value:u.lineThickness,min:.5,max:3,step:.5,onChange:R=>p({lineThickness:R})}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("label",{className:"text-[9px] text-gray-500 w-16",children:"Color"}),e.jsx(Ra,{color:u.color,onChange:R=>p({color:R})})]}),c==="grid"&&e.jsxs(e.Fragment,{children:[e.jsx(Me,{label:"Divisions X",value:u.gridDivisionsX,min:2,max:16,step:1,onChange:R=>p({gridDivisionsX:R})}),e.jsx(Me,{label:"Divisions Y",value:u.gridDivisionsY,min:2,max:16,step:1,onChange:R=>p({gridDivisionsY:R})})]}),c==="spiral"&&e.jsxs(e.Fragment,{children:[e.jsx(Me,{label:"Rotation",value:u.spiralRotation,min:0,max:360,step:15,onChange:R=>p({spiralRotation:R})}),e.jsx(Me,{label:"Position X",value:u.spiralPositionX,min:0,max:1,step:.05,onChange:R=>p({spiralPositionX:R})}),e.jsx(Me,{label:"Position Y",value:u.spiralPositionY,min:0,max:1,step:.05,onChange:R=>p({spiralPositionY:R})}),e.jsx(Me,{label:"Scale",value:u.spiralScale,min:.5,max:2,step:.1,onChange:R=>p({spiralScale:R})}),e.jsx(Me,{label:"Ratio (Phi)",value:u.spiralRatio,min:1,max:2,step:.01,onChange:R=>p({spiralRatio:R})})]}),e.jsxs("div",{className:"flex items-center gap-3 pt-1",children:[e.jsxs("label",{className:"flex items-center gap-1 cursor-pointer",children:[e.jsx("input",{type:"checkbox",checked:u.showCenterMark,onChange:R=>p({showCenterMark:R.target.checked}),className:"w-3 h-3 accent-cyan-500 bg-gray-800 border-gray-600 rounded"}),e.jsx("span",{className:"text-[9px] text-gray-400",children:"Center"})]}),e.jsxs("label",{className:"flex items-center gap-1 cursor-pointer",children:[e.jsx("input",{type:"checkbox",checked:u.showSafeAreas,onChange:R=>p({showSafeAreas:R.target.checked}),className:"w-3 h-3 accent-cyan-500 bg-gray-800 border-gray-600 rounded"}),e.jsx("span",{className:"text-[9px] text-gray-400",children:"Safe Areas"})]})]})]})]})]})]})]})},Ju=`
  /* 
   * --- GMT SHADER API REFERENCE ---
   * 
   * Available Uniforms:
   * float uParamA, uParamB, uParamC, uParamD, uParamE, uParamF; // The 6 Sliders
   * int uIterations;      // Iteration count
   * float uTime;          // Elapsed time in seconds
   * vec3 uJulia;          // Julia coordinates (if Julia mode active)
   * float uJuliaMode;     // 1.0 if active, 0.0 if not
   * 
   * Helper Functions:
   * void sphereFold(inout vec3 z, inout float dz, float minR, float fixedR);
   * void boxFold(inout vec3 z, inout float dz, float limit);
   * void dodecaFold(inout vec3 z);
   * vec3 bulbPow(vec3 z, float power);        // Spherical Power function
   * vec4 quatPow(vec4 q, float p);            // Quaternion Power
   * vec4 quatMult(vec4 q1, vec4 q2);          // Quaternion Multiplication
   * float snoise(vec3 v);                     // Simplex Noise (-1.0 to 1.0)
   * 
   * Input/Output:
   * z    : Current coordinate (vec4). .xyz is position, .w is auxiliary.
   * dr   : Running derivative (float). Used for distance estimation.
   * trap : Orbit trap accumulator (float). Used for coloring.
   * c    : The constant for the fractal (Julia value or Pixel position).
   */
`,ef=(a,t)=>{const{shader:o,...r}=a,n={...r,defaultPreset:t},i=l=>JSON.stringify(l,null,2).replace(/\{\n\s+"label":[\s\S]+?\}/g,d=>d.includes('"id": "param')?d.replace(/\n\s+/g," "):d).replace(/"(cameraPos|cameraRot|sceneOffset|julia|position)": \{\n\s+"[xyz]":[\s\S]+?\}/g,d=>d.replace(/\n\s+/g," ")).replace(/"params": \{\n\s+"A":[\s\S]+?\}/g,d=>d.replace(/\n\s+/g," "));let s=`<!-- 
  GMF: GPU Mandelbulb Format v1.0 
  A proprietary container for Fractal math definitions + default presets.
  You can edit the GLSL blocks below directly.
-->
${Ju}
`;return s+=`<Metadata>
${i(n)}
</Metadata>

`,o.loopInit&&(s+=`<!-- Code executed once before the loop (Setup) -->
`,s+=`<Shader_Init>
${o.loopInit.trim()}
</Shader_Init>

`),s+=`<!-- Main Distance Estimator Function -->
`,s+=`<Shader_Function>
${o.function.trim()}
</Shader_Function>

`,s+=`<!-- The Iteration Loop Body -->
`,s+=`<Shader_Loop>
${o.loopBody.trim()}
</Shader_Loop>

`,o.getDist&&(s+=`<!-- Optional: Custom Distance/Iteration Smoothing -->
`,s+=`<Shader_Dist>
${o.getDist.trim()}
</Shader_Dist>

`),s},tf=a=>{const t=c=>{const f=new RegExp(`<${c}>([\\s\\S]*?)<\\/${c}>`),u=a.match(f);return u?u[1].trim():null},o=t("Metadata");if(!o){try{const c=JSON.parse(a);if(c.id&&c.shader)return c}catch{}throw new Error("Invalid GMF: Missing Metadata tag")}const r=JSON.parse(o),n=t("Shader_Function"),i=t("Shader_Loop"),s=t("Shader_Init"),l=t("Shader_Dist");if(!n||!i)throw new Error("Invalid GMF: Missing essential shader blocks (<Shader_Function> or <Shader_Loop>)");return{...r,shader:{function:n,loopBody:i,loopInit:s||void 0,getDist:l||void 0}}},af=At.memo(({id:a,label:t})=>{const[o,r]=v.useState(!1),[n,i]=v.useState(!1),s=v.useRef(null);return v.useEffect(()=>{const l=s.current;if(!l)return;const d=new IntersectionObserver(c=>{c[0].isIntersecting&&(r(!0),d.disconnect())},{rootMargin:"50px"});return d.observe(l),()=>d.disconnect()},[]),n?null:e.jsx("div",{ref:s,className:"w-full h-full",children:o&&e.jsx("img",{src:`thumbnails/fractal_${a}.jpg`,alt:t,className:"w-full h-full object-cover",onError:()=>i(!0),loading:"lazy"})})}),of=({rect:a,onClose:t,onSelect:o,currentValue:r,onImport:n,showImport:i})=>{var M;const[s,l]=v.useState(null),[d,c]=v.useState({opacity:0,pointerEvents:"none"}),[f,u]=v.useState({}),[p,h]=v.useState(!1),g=v.useMemo(()=>{const m=Le.getAll(),y=new Set(m.map(C=>C.id)),x=[];for(const C of ol){const k=C.match.filter(S=>y.has(S)?(y.delete(S),!0):!1);k.length>0&&x.push({name:C.name,items:k})}return y.size>0&&x.push({name:"Custom / Imported",items:Array.from(y)}),x},[]);return v.useLayoutEffect(()=>{const m=window.innerHeight,y=window.innerWidth,x=12,C=340,k=y<768;h(k);let S=a.left;S+C>y-x&&(S=y-C-x),S=Math.max(x,S);const b=m-a.bottom,w=a.top,j=b<300&&w>b;let T=j?w-x:b-x;const L=Math.min(600,Math.max(150,T)),_={position:"fixed",left:`${S}px`,width:`${C}px`,maxHeight:`${L}px`,maxWidth:`calc(100vw - ${x*2}px)`,zIndex:9999,display:"flex",flexDirection:"column",opacity:1,pointerEvents:"auto"},R=j?{bottom:`${m-a.top+4}px`,top:"auto",transformOrigin:"bottom left"}:{top:`${a.bottom+4}px`,bottom:"auto",transformOrigin:"top left"};c({..._,...R}),k||(y-(S+C)>260+20?u({left:"100%",marginLeft:"10px",top:j?"auto":0,bottom:j?0:"auto"}):u({right:"100%",marginRight:"10px",top:j?"auto":0,bottom:j?0:"auto"}))},[a]),v.useEffect(()=>{const m=()=>t(),y=C=>{C.target.closest(".portal-dropdown-content")||t()},x=C=>{C.target.closest(".portal-dropdown-content")||t()};return window.addEventListener("resize",m),window.addEventListener("mousedown",y,!0),window.addEventListener("wheel",x,!0),()=>{window.removeEventListener("resize",m),window.removeEventListener("mousedown",y,!0),window.removeEventListener("wheel",x,!0)}},[t]),wt.createPortal(e.jsxs("div",{style:d,children:[e.jsxs("div",{className:"portal-dropdown-content bg-[#121212] border border-white/10 rounded-lg shadow-[0_10px_40px_rgba(0,0,0,0.8)] overflow-y-auto custom-scroll animate-fade-in-down w-full flex-1",onMouseLeave:()=>l(null),children:[i&&e.jsx("div",{className:"p-1 border-b border-white/5 sticky top-0 bg-[#121212] z-50",children:e.jsxs("button",{onClick:()=>{n(),t()},className:"w-full flex items-center justify-center gap-2 px-3 py-2 bg-cyan-900/20 hover:bg-cyan-900/40 text-cyan-400 text-[10px] font-black uppercase tracking-wider rounded border border-cyan-500/20 hover:border-cyan-500/50 transition-colors",children:[e.jsx(mo,{}),"Import Formula (.GMF)"]})}),g.map(m=>e.jsxs("div",{className:"py-1",children:[e.jsx("div",{className:`px-3 py-1.5 text-[9px] font-black text-gray-500 uppercase tracking-widest bg-[#121212] border-y border-white/5 sticky z-40 shadow-sm ${i?"top-[38px]":"top-0"}`,children:m.name}),m.items.map(y=>{const x=y==="Modular",C=Le.get(y),k=C?C.name:y,S=r===y;return e.jsxs("button",{onClick:()=>o(y),onMouseEnter:()=>l(y),className:`w-full text-left px-3 py-2.5 transition-all flex gap-3 group relative border-b border-white/5 last:border-b-0 ${S?"bg-cyan-900/20":"hover:bg-white/5"}`,children:[e.jsxs("div",{className:"w-16 h-10 shrink-0 bg-black rounded border border-white/10 overflow-hidden relative group-hover:border-cyan-500/50 transition-colors",children:[e.jsx("div",{className:"absolute inset-0 flex items-center justify-center text-gray-800 bg-gray-900 z-0",children:x?e.jsx(Pn,{}):e.jsx(la,{})}),!x&&e.jsx("div",{className:"relative z-10 w-full h-full",children:e.jsx(af,{id:y,label:k})}),S&&e.jsx("div",{className:"absolute inset-0 z-20 bg-cyan-500/20 flex items-center justify-center",children:e.jsx("div",{className:"w-4 h-4 bg-white rounded-full flex items-center justify-center text-cyan-900 shadow-lg",children:e.jsx(xt,{})})})]}),e.jsxs("div",{className:"flex flex-col min-w-0 flex-1 justify-center",children:[e.jsx("div",{className:"flex items-center gap-2 mb-0.5",children:e.jsx("span",{className:`text-[11px] font-bold tracking-tight truncate ${S?"text-cyan-400":"text-gray-200 group-hover:text-white"} ${x?"text-transparent bg-clip-text bg-gradient-to-r from-cyan-300 to-purple-300 font-black":""}`,children:k})}),(C==null?void 0:C.shortDescription)&&e.jsx("p",{className:"text-[9px] text-gray-500 line-clamp-2 leading-tight group-hover:text-gray-400",children:C.shortDescription})]})]},y)})]},m.name))]}),s&&s!=="Modular"&&!p&&e.jsxs("div",{className:"absolute w-[256px] h-[256px] bg-black border border-cyan-500/50 rounded-lg shadow-[0_0_50px_rgba(0,0,0,1),0_0_20px_rgba(34,211,238,0.2)] overflow-hidden animate-fade-in pointer-events-none z-[10000]",style:f,children:[e.jsx("img",{src:`thumbnails/fractal_${s}.jpg`,className:"w-full h-full object-cover",alt:"Preview",onError:m=>m.currentTarget.parentElement.style.display="none"}),e.jsx("div",{className:"absolute inset-0 bg-[linear-gradient(rgba(18,16,16,0)_50%,rgba(0,0,0,0.1)_50%),linear-gradient(90deg,rgba(255,0,0,0.03),rgba(0,255,0,0.01),rgba(0,0,255,0.03))] bg-[length:100%_4px,4px_100%] pointer-events-none"}),e.jsx("div",{className:"absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black to-transparent p-4",children:e.jsx("div",{className:"text-[10px] font-black text-cyan-400 uppercase tracking-[0.2em] drop-shadow-md",children:((M=Le.get(s))==null?void 0:M.name)||s})})]})]}),document.body)},rf=({value:a,onChange:t})=>{const[o,r]=v.useState(!1),n=v.useRef(null),i=v.useRef(null),[s,l]=v.useState(null),d=Y(k=>k.openContextMenu),c=Y(k=>k.setExportIncludeScene),f=Y(k=>k.exportIncludeScene),u=Y(k=>k.advancedMode),p=()=>{!o&&n.current?(l(n.current.getBoundingClientRect()),r(!0)):r(!1)},h=k=>{const S=Le.get(a);if(!S)return;const b=Y.getState().getPreset({includeScene:k}),w=ef(S,b),j=new Blob([w],{type:"text/plain"}),T=URL.createObjectURL(j),L=document.createElement("a");L.href=T,L.download=`${S.id}${k?"_Full":""}.gmf`,L.click(),URL.revokeObjectURL(T)},g=k=>{k.stopPropagation(),h(f)},M=k=>{k.preventDefault(),k.stopPropagation();const S=[{label:"Export Options",action:()=>{},isHeader:!0},{label:"Include Scene Data",checked:f,action:()=>c(!f)},{label:"Actions",action:()=>{},isHeader:!0},{label:"Export Formula Only",action:()=>h(!1)},{label:"Export Full Package",action:()=>h(!0)}];d(k.clientX,k.clientY,S,[])},m=k=>{var w;const S=(w=k.target.files)==null?void 0:w[0];if(!S)return;const b=new FileReader;b.onload=j=>{var T;try{const L=(T=j.target)==null?void 0:T.result,_=tf(L);Le.register(_),t(_.id),i.current&&(i.current.value="")}catch(L){console.error("Failed to import formula:",L),alert("Invalid formula file. Ensure it is a valid .gmf or .json definition.")}},b.readAsText(S)},y=Le.get(a),x=y?y.name:a,C=a==="Modular";return e.jsxs("div",{className:"flex gap-2",children:[e.jsx("input",{ref:i,type:"file",accept:".json,.gmf",className:"hidden",onChange:m}),e.jsxs("button",{ref:n,onClick:p,className:`flex-1 flex items-center justify-between bg-gray-900 border text-xs text-white rounded p-2 outline-none transition-all group ${o?"border-cyan-500 ring-1 ring-cyan-900":C?"border-purple-500/50 shadow-[inset_0_0_10px_rgba(168,85,247,0.1)]":"border-gray-700 hover:border-gray-500"}`,children:[e.jsxs("div",{className:"flex items-center gap-2",children:[C&&e.jsx("span",{className:"flex w-1.5 h-1.5 rounded-full bg-purple-500 animate-pulse shadow-[0_0_5px_#a855f7]"}),e.jsx("span",{className:`font-bold tracking-wide ${C?"text-transparent bg-clip-text bg-gradient-to-r from-cyan-300 to-purple-300":""}`,children:x})]}),e.jsx("div",{className:`w-3 h-3 text-gray-500 transition-transform ${o?"rotate-180":""}`,children:e.jsx(Rt,{})})]}),!C&&u&&e.jsx("button",{onClick:g,onContextMenu:M,className:"w-8 flex items-center justify-center bg-gray-900 border border-gray-700 hover:border-white/50 hover:bg-white/5 text-gray-400 hover:text-white rounded transition-colors",title:f?"Export Full Preset (Right-click for options)":"Export Formula Only (Right-click for options)",children:e.jsx(kn,{})}),o&&s&&e.jsx(of,{rect:s,currentValue:a,onClose:()=>r(!1),onSelect:k=>{t(k),r(!1)},onImport:()=>{var k;return(k=i.current)==null?void 0:k.click()},showImport:u})]})},nf=({shape:a,period:t,phase:o,amplitude:r,enabled:n})=>{const i=v.useRef(null);return v.useEffect(()=>{const s=i.current;if(!s)return;const l=s.getContext("2d");if(!l)return;const d=s.width,c=s.height;if(l.clearRect(0,0,d,c),l.strokeStyle="#222",l.lineWidth=1,l.beginPath(),l.moveTo(0,c/2),l.lineTo(d,c/2),l.stroke(),!n)return;l.strokeStyle="#8b5cf6",l.lineWidth=2,l.beginPath();const f=120,u=5;for(let p=0;p<=f;p++){const h=p/f,g=(h*u/t+o)%1;let M=0;a==="Sine"?M=Math.sin(g*Math.PI*2):a==="Triangle"?M=1-Math.abs(g*2-1)*2:a==="Sawtooth"?M=g*2-1:a==="Pulse"?M=g<.5?1:-1:a==="Noise"&&(M=Math.sin(g*50)*Math.cos(g*12));const m=c/2-M*Math.min(1.5,r)*(c/4);p===0?l.moveTo(h*d,m):l.lineTo(h*d,m)}l.stroke()},[a,t,o,r,n]),e.jsxs("div",{className:"relative h-12 bg-black/40 rounded border border-white/5 mb-3 overflow-hidden",children:[e.jsx("canvas",{ref:i,width:280,height:48,className:"w-full h-full"}),e.jsx("div",{className:"absolute top-1 left-2 text-[7px] font-black text-purple-400/50 uppercase tracking-widest pointer-events-none",children:"Signal (5 second window)"})]})},sf=({state:a,actions:t})=>{const o=()=>{if(a.animations.length>=3)return;const i={id:tt(),enabled:!0,target:"coreMath.paramA",shape:"Sine",period:5,amplitude:1,baseValue:a.coreMath.paramA,phase:0,smoothing:.5};t.setAnimations([...a.animations,i])},r=i=>{t.setAnimations(a.animations.filter(s=>s.id!==i))},n=(i,s)=>{t.setAnimations(a.animations.map(l=>l.id===i?{...l,...s}:l))};return e.jsxs("div",{className:"flex flex-col border-t border-white/5 bg-purple-900/10","data-help-id":"lfo.system",children:[e.jsxs("div",{className:"flex items-center justify-between px-3 py-2 border-b border-purple-500/20",children:[e.jsx("label",{className:"text-[10px] font-bold text-purple-300 uppercase tracking-wider",children:"LFO Modulators"}),e.jsx("button",{onClick:o,disabled:a.animations.length>=3,className:"w-5 h-5 flex items-center justify-center rounded bg-purple-500/20 border border-purple-500/50 text-purple-300 hover:bg-purple-500 hover:text-white disabled:opacity-30 transition-all",title:"Add LFO (Max 3)",children:e.jsx(sa,{})})]}),e.jsx("div",{className:"space-y-1 p-2",children:a.animations.map((i,s)=>e.jsxs("div",{className:`bg-black/40 rounded border border-purple-500/10 animate-fade-in relative transition-all ${i.enabled,"p-2"}`,children:[e.jsxs("div",{className:"flex items-center justify-between mb-2 min-h-[26px]",children:[e.jsxs("span",{className:"text-[9px] font-black text-purple-400/50 uppercase tracking-[0.2em]",children:["LFO ",s+1]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("button",{onClick:()=>r(i.id),className:"text-red-500 hover:text-white transition-colors opacity-50 hover:opacity-100",title:"Delete LFO",children:e.jsx(St,{})}),e.jsx("div",{className:"w-[60px]",children:e.jsx(Ge,{value:i.enabled,onChange:l=>n(i.id,{enabled:l}),color:"bg-purple-600"})})]})]}),i.enabled&&e.jsxs("div",{className:"animate-fade-in",children:[e.jsx(nf,{...i}),e.jsxs("div",{className:"grid grid-cols-2 gap-1 mb-1",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-[9px] text-gray-500 uppercase font-bold block mb-0.5",children:"Target"}),e.jsx(Xn,{value:i.target,onChange:l=>{let d=0;if(l.includes(".")){const[c,f]=l.split("."),u=a[c];u&&u[f]!==void 0&&(d=u[f])}n(i.id,{target:l,baseValue:d})},className:"w-full"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-[9px] text-gray-500 uppercase font-bold block mb-0.5",children:"Shape"}),e.jsxs("select",{value:i.shape,onChange:l=>n(i.id,{shape:l.target.value}),className:"w-full bg-gray-900 border border-gray-700 text-[9px] text-white rounded p-1 outline-none focus:border-purple-500",children:[e.jsx("option",{value:"Sine",children:"Sine"}),e.jsx("option",{value:"Triangle",children:"Triangle"}),e.jsx("option",{value:"Sawtooth",children:"Sawtooth"}),e.jsx("option",{value:"Pulse",children:"Pulse"}),e.jsx("option",{value:"Noise",children:"Noise"})]})]})]}),e.jsxs("div",{className:"space-y-0",children:[e.jsx(Me,{label:"Period (Sec)",value:i.period,min:.1,max:30,step:.1,hardMin:.01,onChange:l=>n(i.id,{period:l})}),e.jsx(Me,{label:"Strength",value:i.amplitude,min:.001,max:10,step:.001,onChange:l=>n(i.id,{amplitude:l}),customMapping:{min:0,max:100,toSlider:l=>(Math.log10(Math.max(.001,l))+3)/4*100,fromSlider:l=>Math.pow(10,l/100*4-3)},overrideInputText:i.amplitude<.1?i.amplitude.toFixed(3):i.amplitude.toFixed(2)}),a.advancedMode&&e.jsx(Me,{label:"Phase Offset",value:i.phase,min:0,max:1,step:.01,onChange:l=>n(i.id,{phase:l}),customMapping:{min:0,max:360,toSlider:l=>l*360,fromSlider:l=>l/360},overrideInputText:`${(i.phase*360).toFixed(0)}`}),e.jsx(Me,{label:"Smoothing",value:i.smoothing,min:0,max:1,step:.01,onChange:l=>n(i.id,{smoothing:l})})]})]})]},i.id))})]})},lf=({state:a,actions:t,onSwitchTab:o})=>{var S;const r=Y(b=>b.openContextMenu),[n,i]=v.useState(null),{isRecording:s,currentFrame:l,addKeyframe:d,addTrack:c,sequence:f}=xe();v.useEffect(()=>{const b=le.on("compile_time",w=>{i(`Loaded in ${w.toFixed(2)}s`),setTimeout(()=>i(null),5e3)});return B.lastCompileDuration>0&&(i(`Loaded in ${B.lastCompileDuration.toFixed(2)}s`),setTimeout(()=>i(null),3e3)),b},[]),a.debugMobileLayout||typeof window<"u"&&window.innerWidth<768;const u=a.coreMath;if(!u||!a.formula)return null;const p=(b,w)=>{s&&Object.entries(w).forEach(([j,T])=>{const L=`${b}.${j}`;if(!f.tracks[L]){let _=j;if(b==="coreMath"){const R=Le.get(a.formula),z=R==null?void 0:R.parameters.find(E=>(E==null?void 0:E.id)===j);z&&(_=z.label)}else b==="geometry"&&(j==="juliaX"?_="Julia X":j==="juliaY"?_="Julia Y":j==="juliaZ"?_="Julia Z":j==="hybridScale"&&(_="Box Scale"));c(L,_)}d(L,l,T)})},h=()=>{const b={};if(a.formula==="Modular"){const j=()=>Math.random()*4-2;b.paramA=j(),b.paramB=j(),b.paramC=j(),b.paramD=j(),b.paramE=j(),b.paramF=j(),t.setCoreMath(b),p("coreMath",b);return}const w=Le.get(a.formula);w&&(w.parameters.forEach(j=>{if(!j)return;const T=j.max-j.min,L=Math.random()*T+j.min,_=j.step>0?Math.round(L/j.step)*j.step:L;b[j.id]=_}),t.setCoreMath(b),p("coreMath",b))},g=()=>{t.handleInteractionStart("param"),h(),t.handleInteractionEnd()},M=()=>{t.handleInteractionStart("param"),h();const b={};a.geometry.hybridMode&&(b.hybridScale=1.5+Math.random()*1.5,b.hybridMinR=Math.random()*1,b.hybridFixedR=.5+Math.random()*1.5,b.hybridFoldLimit=.5+Math.random()*1.5),a.geometry.juliaMode&&(b.juliaX=Math.random()*4-2,b.juliaY=Math.random()*4-2,b.juliaZ=Math.random()*4-2),Object.keys(b).length>0&&(t.setGeometry(b),p("geometry",b)),t.handleInteractionEnd()},m=b=>{b.preventDefault(),b.stopPropagation();const w=Oe(b.target),j=[];if(w.includes("formula.active")&&(j.push({label:"Import Options",action:()=>{},isHeader:!0},{label:"Lock Scene Settings",checked:a.lockSceneOnSwitch,action:()=>t.setLockSceneOnSwitch(!a.lockSceneOnSwitch)}),a.formula)){const T=`formula.${a.formula.toLowerCase()}`;w.includes(T)||w.unshift(T)}j.push({label:"Randomize",action:()=>{},isHeader:!0},{label:"Parameters (A-F)",icon:e.jsx(Jl,{}),action:g,keepOpen:!0},{label:"Full (inc. Box/Julia)",icon:e.jsx(ec,{}),action:M,keepOpen:!0}),r(b.clientX,b.clientY,j,w)},x=(()=>{if(a.formula==="Modular"){const w=["ParamA","ParamB","ParamC","ParamD","ParamE","ParamF"],j={};return a.pipeline.forEach(T=>{if(!T.enabled||!T.bindings)return;const L=Ie.get(T.type);Object.entries(T.bindings).forEach(([_,R])=>{if(R&&w.includes(R)){j[R]||(j[R]={labels:[],min:-5,max:5,step:.01});const z=L==null?void 0:L.inputs.find(E=>E.id===_);z?j[R].labels.push(`${T.type}: ${z.label}`):j[R].labels.push(`${T.type}: ${_}`)}})}),w.map(T=>{const L=j[T],_=T.charAt(0).toLowerCase()+T.slice(1);if(!L)return null;const R=L.labels.length>1?`${T} (Mixed)`:L.labels[0]||T;let z=0,E=N=>{};switch(_){case"paramA":z=u.paramA,E=N=>t.setCoreMath({paramA:N});break;case"paramB":z=u.paramB,E=N=>t.setCoreMath({paramB:N});break;case"paramC":z=u.paramC,E=N=>t.setCoreMath({paramC:N});break;case"paramD":z=u.paramD,E=N=>t.setCoreMath({paramD:N});break;case"paramE":z=u.paramE,E=N=>t.setCoreMath({paramE:N});break;case"paramF":z=u.paramF,E=N=>t.setCoreMath({paramF:N});break}return{label:R,val:z,set:E,min:-5,max:5,step:.01,def:0,id:_,trackId:`coreMath.${_}`,scale:"linear"}})}const b=Le.get(a.formula);return b?b.parameters.map(w=>{if(!w)return null;let j=0,T=L=>{};switch(w.id){case"paramA":j=u.paramA,T=L=>t.setCoreMath({paramA:L});break;case"paramB":j=u.paramB,T=L=>t.setCoreMath({paramB:L});break;case"paramC":j=u.paramC,T=L=>t.setCoreMath({paramC:L});break;case"paramD":j=u.paramD,T=L=>t.setCoreMath({paramD:L});break;case"paramE":j=u.paramE,T=L=>t.setCoreMath({paramE:L});break;case"paramF":j=u.paramF,T=L=>t.setCoreMath({paramF:L});break}return{label:w.label,val:j,set:T,min:w.min,max:w.max,step:w.step,def:w.default,id:w.id,trackId:`coreMath.${w.id}`,scale:w.scale,options:w.options}}):[{label:"Power (N)",val:u.paramA,set:w=>t.setCoreMath({paramA:w}),min:2,max:16,step:.001,def:8,id:"paramA",trackId:"coreMath.paramA"},null,null,null]})(),C=b=>{if(!b)return null;if(b.options)return e.jsx("div",{className:"mb-1",children:e.jsx(vt,{label:b.label,value:b.val,options:b.options,onChange:T=>b.set(T),fullWidth:!0})},b.id);const w=a.liveModulations[b.trackId]??a.liveModulations[b.id],j=a.animations.some(T=>T.enabled&&(T.target===b.trackId||T.target===b.id));return b.scale==="pi"?e.jsx(Me,{label:b.label,value:b.val,min:b.min,max:b.max,step:.01,onChange:b.set,defaultValue:b.def,highlight:j||b.id==="paramA"&&!j,trackId:b.trackId,liveValue:w,customMapping:{min:b.min/Math.PI,max:b.max/Math.PI,toSlider:T=>T/Math.PI,fromSlider:T=>T*Math.PI},mapTextInput:!0,overrideInputText:`${(b.val/Math.PI).toFixed(2)}`},b.id):e.jsx(Me,{label:b.label,value:b.val,min:b.min,max:b.max,step:b.step,onChange:b.set,defaultValue:b.def,highlight:j||b.id==="paramA"&&!j,trackId:b.trackId,liveValue:w},b.id)},k=b=>{t.setFormula(b),b==="Modular"&&o&&o("Graph")};return e.jsxs("div",{className:"animate-fade-in -mx-4 -mt-4 min-h-full",onContextMenu:m,children:[e.jsxs("div",{className:"bg-gray-800/20 border-b border-white/5 p-4 mb-2","data-help-id":"formula.active",children:[e.jsxs("div",{className:"flex justify-between items-baseline mb-1",children:[e.jsx("label",{className:"text-[10px] text-gray-500 uppercase font-bold",children:"Active Formula"}),n&&e.jsx("span",{className:"text-[9px] text-gray-500 animate-fade-in",children:n})]}),e.jsx(rf,{value:a.formula,onChange:k})]}),e.jsxs("div",{className:"flex flex-col","data-help-id":`panel.formula formula.${((S=a.formula)==null?void 0:S.toLowerCase())||"mandelbulb"}`,children:[e.jsx(Me,{label:"Iterations",value:u.iterations,min:1,max:500,step:1,onChange:b=>t.setCoreMath({iterations:Math.round(b)}),highlight:!0,defaultValue:32,customMapping:{min:0,max:100,toSlider:b=>100*Math.pow((b-1)/499,1/3),fromSlider:b=>1+499*Math.pow(b/100,3)},trackId:"coreMath.iterations",liveValue:a.liveModulations["coreMath.iterations"]}),e.jsx(e.Fragment,{children:x.map(b=>C(b))})]}),e.jsx("div",{className:"border-t border-white/5 mt-2 pt-2","data-help-id":"formula.transform",children:e.jsx("div",{className:"bg-gray-800/10",children:e.jsx(Ce,{featureId:"geometry",groupFilter:"transform"})})}),e.jsx("div",{className:"border-t border-white/5","data-help-id":"julia.mode",children:e.jsxs("div",{className:"bg-gray-800/10",children:[e.jsx(Ce,{featureId:"geometry",groupFilter:"julia"}),e.jsx(Ce,{featureId:"geometry",groupFilter:"julia_params"})]})}),e.jsx("div",{className:"border-t border-white/5","data-help-id":"hybrid.mode",children:e.jsx("div",{className:"bg-gray-800/10",children:e.jsx(Ce,{featureId:"geometry",groupFilter:"hybrid"})})}),e.jsx(sf,{state:a,actions:t}),a.showHints&&e.jsx("div",{className:"text-[9px] text-gray-600 text-center mt-6 pb-2 opacity-50 font-mono tracking-wide",children:"PRESS 'H' TO HIDE HINTS"})]})},cf=({label:a,featureId:t,toggleParam:o,children:r,description:n})=>{var p,h;const i=Y(),s=ve.get(t),l=o||((p=s==null?void 0:s.engineConfig)==null?void 0:p.toggleParam),d=i[t],c=l?!!d[l]:!0;(h=s==null?void 0:s.engineConfig)==null||h.toggleParam;const f=g=>{var y;const M=`set${t.charAt(0).toUpperCase()+t.slice(1)}`,m=i[M];m&&l&&(((y=s==null?void 0:s.engineConfig)==null?void 0:y.mode)==="compile"?(le.emit("is_compiling","Updating Engine..."),setTimeout(()=>{m({[l]:g})},50)):m({[l]:g}))},u=`flex flex-col border-t border-white/5 transition-all duration-500 ease-in-out ${c?"":"grayscale opacity-50 bg-black/20"}`;return e.jsxs("div",{className:u,children:[e.jsxs("div",{className:`flex items-center justify-between px-3 py-2 transition-colors ${c?"bg-cyan-950/20":"bg-transparent"}`,children:[e.jsxs("div",{className:"flex flex-col",children:[e.jsx("span",{className:`text-[10px] font-black uppercase tracking-[0.15em] transition-colors ${c?"text-cyan-400":"text-gray-600"}`,children:a}),!c&&e.jsx("span",{className:"text-[8px] font-bold text-amber-600/80 uppercase tracking-tighter animate-pulse",children:"Disabled in Engine"})]}),e.jsx("div",{className:"w-12",children:e.jsx(Ge,{value:c,onChange:f,color:c?"bg-cyan-600 shadow-[0_0_8px_rgba(34,211,238,0.4)]":"bg-gray-800"})})]}),e.jsx("div",{className:`overflow-hidden transition-all duration-500 ${c?"max-h-[2000px] opacity-100 pb-2":"max-h-0 opacity-0"}`,children:e.jsxs("div",{className:"px-1 pointer-events-auto",children:[n&&c&&e.jsxs("div",{className:"px-3 py-1 flex gap-2 items-start opacity-60 mb-2",children:[e.jsx("div",{className:"mt-0.5 text-cyan-500",children:e.jsx(ho,{})}),e.jsx("p",{className:"text-[9px] text-gray-400 leading-tight italic",children:n})]}),r]})}),!c&&e.jsx("div",{className:"absolute inset-0 z-10 cursor-not-allowed",title:"Enable this feature in the Engine tab to edit",onClick:g=>{g.stopPropagation()}})]})},df=({state:a,actions:t})=>{const o=Y(l=>l.openContextMenu),r=a.droste;a.colorGrading;const n=a.optics,i=a.waterPlane,s=l=>{const d=Oe(l.currentTarget);d.length>0&&(l.preventDefault(),l.stopPropagation(),o(l.clientX,l.clientY,[],d))};return e.jsxs("div",{className:"animate-fade-in -mx-4 -mt-4 flex flex-col",children:[a.advancedMode&&e.jsxs("div",{className:"flex flex-col","data-help-id":"panel.scene",children:[e.jsx("div",{className:"t-section-header",onContextMenu:s,"data-help-id":"panel.scene",children:e.jsx("h3",{className:"t-section-title",children:"Camera & navigation"})}),e.jsx("div",{className:"bg-gray-800/10 py-3 px-3","data-help-id":"cam.mode",children:e.jsx(Ce,{featureId:"navigation",groupFilter:"controls"})})]}),e.jsx("div",{className:"flex flex-col border-t border-white/5","data-help-id":"fog.settings",children:e.jsx("div",{className:"bg-gray-800/5 py-1 flex flex-col gap-px",children:e.jsx(Ce,{featureId:"atmosphere",groupFilter:"fog"})})}),i&&i.waterEnabled&&e.jsx("div",{className:"flex flex-col border-t border-white/5 pt-2","data-help-id":"water.settings",children:e.jsxs(cf,{label:"Water Plane",featureId:"waterPlane",description:"Infinite ocean plane at height Y.",children:[e.jsx("div",{className:"mb-2",children:e.jsx(Ce,{featureId:"waterPlane",groupFilter:"main"})}),e.jsxs("div",{className:"bg-black/20 p-2 rounded border border-white/5 mb-2",children:[e.jsx(Ce,{featureId:"waterPlane",groupFilter:"geometry"}),e.jsx(Ce,{featureId:"waterPlane",groupFilter:"material"})]}),e.jsxs("div",{className:"bg-black/20 p-2 rounded border border-white/5",children:[e.jsx("div",{className:"text-[9px] font-bold text-gray-500 uppercase tracking-widest mb-2",children:"Waves"}),e.jsx(Ce,{featureId:"waterPlane",groupFilter:"waves"})]})]})}),e.jsx("div",{className:"flex flex-col bg-gray-900/40 border-t border-white/5","data-help-id":"dof.settings",children:n&&e.jsxs("div",{className:"flex flex-col",children:[e.jsx("div",{children:e.jsx(Ce,{featureId:"optics",groupFilter:"dof"})}),e.jsx("div",{children:e.jsx(Ce,{featureId:"optics",groupFilter:"projection"})})]})}),e.jsx("div",{className:"flex flex-col border-t border-white/5 pt-2","data-help-id":"scene.grading",children:e.jsx("div",{className:"bg-gray-800/10 p-2",children:e.jsx(Ce,{featureId:"colorGrading",groupFilter:"grading"})})}),r&&e.jsxs("div",{className:"flex flex-col bg-gray-900/40 border-t border-white/5 pt-2","data-help-id":"effect.droste",children:[e.jsx("div",{className:"bg-gray-800/10 p-2",children:e.jsx(Ce,{featureId:"droste",groupFilter:"main"})}),r.active&&e.jsxs("div",{className:"animate-fade-in flex flex-col",children:[e.jsx("div",{className:"bg-white/5 p-2","data-help-id":"droste.geometry",children:e.jsx(Ce,{featureId:"droste",groupFilter:"geometry"})}),e.jsxs("div",{className:"bg-black/20 p-2 border-y border-white/5","data-help-id":"droste.structure",children:[e.jsx("div",{className:"text-[9px] text-gray-500 font-bold uppercase tracking-wider mb-2 px-1",children:"Spiral Structure"}),e.jsx(Ce,{featureId:"droste",groupFilter:"structure"})]}),e.jsxs("div",{className:"p-2","data-help-id":"droste.transform",children:[e.jsx("div",{className:"text-[9px] text-gray-500 font-bold uppercase tracking-wider mb-2 px-1",children:"Transform"}),e.jsx(Ce,{featureId:"droste",groupFilter:"transform"})]})]})]})]})},uf=({state:a,actions:t})=>{const[o,r]=v.useState(0),n=a.lighting,i=a.liveModulations;v.useEffect(()=>{o>=n.lights.length&&n.lights.length>0&&r(n.lights.length-1)},[n.lights.length,o]);const s=Dt(n,o),l=Y(x=>x.openContextMenu),d=x=>{const C=Oe(x.currentTarget);C.length>0&&(x.preventDefault(),x.stopPropagation(),l(x.clientX,x.clientY,[],C))},c=()=>{n.lights.length<He&&(t.addLight(),r(n.lights.length))},f=x=>{x.stopPropagation(),n.lights.length>1&&(t.removeLight(o),r(Math.max(0,o-1)))},u=()=>{if(!B.activeCamera)return;const x=Dt(a.lighting,o),C=x.fixed;let k=x.position,S=x.rotation;x.type==="Point"?k=B.virtualSpace.resolveRealWorldPosition(x.position,C,B.activeCamera):S=B.virtualSpace.resolveRealWorldRotation(x.rotation,C,B.activeCamera),t.updateLight({index:o,params:{fixed:!C,position:k,rotation:S}})},p=x=>{if(!B.activeCamera){t.updateLight({index:o,params:{type:x}});return}const C=Dt(a.lighting,o),k=B.activeCamera;let S=new ie(0,0,0);if(!C.fixed){const b=new ie(0,0,-1).applyQuaternion(k.quaternion);S.copy(k.position).addScaledVector(b,2);const w=B.sceneOffset;S.add(new ie(w.x+w.xL,w.y+w.yL,w.z+w.zL))}if(x==="Directional"){const b=new ie(C.position.x,C.position.y,C.position.z),w=new ie().subVectors(S,b).normalize();w.lengthSq()<.001&&w.set(0,-1,0);const j=new Be().setFromUnitVectors(new ie(0,0,-1),w),T=new qe().setFromQuaternion(j,"YXZ");t.updateLight({index:o,params:{type:x,rotation:{x:T.x,y:T.y,z:T.z}}})}else{const b=new Be().setFromEuler(new qe(C.rotation.x,C.rotation.y,C.rotation.z,"YXZ")),w=new ie(0,0,-1).applyQuaternion(b),T=S.clone().sub(w.multiplyScalar(5));t.updateLight({index:o,params:{type:x,position:{x:T.x,y:T.y,z:T.z}}})}};if(!s)return null;const h=(s.fixed,10),g=`lighting.light${o}`,M={x:i[`${g}_rotX`]??s.rotation.x,y:i[`${g}_rotY`]??s.rotation.y,z:i[`${g}_rotZ`]??s.rotation.z},m={x:i[`${g}_posX`]??s.position.x,y:i[`${g}_posY`]??s.position.y,z:i[`${g}_posZ`]??s.position.z},y=new ie(m.x,m.y,m.z);return e.jsxs("div",{className:"animate-fade-in",children:[e.jsx("div",{className:"mb-4",children:e.jsxs("div",{className:"flex flex-wrap gap-1 bg-black/40 p-1 rounded border border-white/5",children:[n.lights.map((x,C)=>e.jsxs("button",{onClick:()=>r(C),className:`flex-1 min-w-[60px] py-1.5 px-2 text-[9px] font-bold uppercase rounded border transition-all relative ${o===C?"bg-cyan-900/50 border-cyan-500/50 text-cyan-200 shadow-sm":"bg-transparent border-transparent text-gray-500 hover:bg-white/5 hover:text-gray-300"}`,children:["Light ",C+1,x.visible&&e.jsx("div",{className:"absolute top-1 right-1 w-1 h-1 rounded-full bg-cyan-400"})]},C)),n.lights.length<He&&e.jsx("button",{onClick:c,className:"w-8 flex items-center justify-center text-gray-500 hover:text-cyan-400 hover:bg-white/5 rounded transition-colors",title:"Add Light",children:e.jsx(sa,{})})]})}),e.jsxs("div",{className:"mb-4 space-y-3","data-help-id":"panel.light",children:[e.jsxs("div",{className:"flex items-center justify-between p-3 bg-gray-800/50 rounded-lg border border-white/5",children:[e.jsx(Ge,{label:"Enabled",value:s.visible,onChange:()=>t.updateLight({index:o,params:{visible:!s.visible}}),color:"bg-green-500"}),n.lights.length>1&&e.jsx("button",{onClick:f,className:"p-1.5 text-red-500 hover:text-red-300 hover:bg-red-900/20 rounded ml-2 transition-colors",title:"Delete Light",children:e.jsx(St,{})})]}),e.jsxs("div",{className:`transition-opacity duration-200 ${s.visible?"opacity-100":"opacity-40 pointer-events-none"}`,children:[e.jsxs("div",{className:"mb-4 p-3 bg-gray-800/50 rounded-lg","data-help-id":"light.mode",onContextMenu:d,children:[e.jsx("div",{className:"flex gap-1 mb-2","data-help-id":"light.type",children:e.jsx(Ge,{value:s.type,onChange:x=>p(x),options:[{label:"Point",value:"Point"},{label:"Directional (Sun)",value:"Directional"}]})}),e.jsx(Ge,{label:"Attachment Mode",value:s.fixed,onChange:u,options:[{label:"Headlamp",value:!0},{label:"World",value:!1}],helpId:"light.mode"})]}),s.type==="Point"?e.jsx("div",{"data-help-id":"light.pos",children:e.jsx(za,{label:s.fixed?"Offset XYZ":"World Position",value:y,onChange:x=>t.updateLight({index:o,params:{position:{x:x.x,y:x.y,z:x.z}}}),min:-h,max:h,step:.01,interactionMode:"param",trackKeys:[`lighting.light${o}_posX`,`lighting.light${o}_posY`,`lighting.light${o}_posZ`],trackLabels:[`Light ${o+1} Pos X`,`Light ${o+1} Pos Y`,`Light ${o+1} Pos Z`]})}):e.jsx("div",{"data-help-id":"light.rot",children:e.jsx(An,{index:o,value:M,onChange:x=>t.updateLight({index:o,params:{rotation:x}}),isFixed:s.fixed,width:200,height:130})}),e.jsx(Me,{label:"Intensity",value:s.intensity,min:0,max:100,step:.1,onChange:x=>t.updateLight({index:o,params:{intensity:x}}),customMapping:{min:0,max:100,toSlider:x=>Math.sqrt(x/100)*100,fromSlider:x=>x*x/100},overrideInputText:ff(s.intensity),dataHelpId:"light.intensity",trackId:`${g}_intensity`,liveValue:i[`${g}_intensity`]}),s.type==="Point"&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"mt-2 mb-1 px-3","data-help-id":"light.falloff",onContextMenu:d,children:e.jsx(Ge,{label:"Falloff Type",value:s.falloffType,onChange:x=>t.updateLight({index:o,params:{falloffType:x}}),options:[{label:"Quad",value:"Quadratic"},{label:"Linear",value:"Linear"}],helpId:"light.falloff"})}),e.jsx(Me,{label:"Falloff (Decay)",value:s.falloff,min:0,max:500,step:.1,onChange:x=>t.updateLight({index:o,params:{falloff:x}}),customMapping:{min:0,max:100,toSlider:x=>Math.log10(x+1)/Math.log10(501)*100,fromSlider:x=>Math.pow(501,x/100)-1},overrideInputText:s.falloff<.01?"Infinite":s.falloff.toFixed(2),dataHelpId:"light.falloff",trackId:`${g}_falloff`,liveValue:i[`${g}_falloff`]}),e.jsx("p",{className:"text-[9px] text-gray-500 mb-2 -mt-2",children:"0 = No decay (Sun). Higher = shorter range."})]}),e.jsxs("div",{className:"mt-4 pt-3 border-t border-white/10 space-y-2",children:[e.jsx("label",{className:"text-xs text-gray-400 font-bold mb-2 block",children:"Color"}),e.jsx(da,{color:s.color,onColorChange:x=>t.updateLight({index:o,params:{color:x}})}),e.jsxs("div",{className:"flex items-center justify-between pt-1",children:[e.jsx("label",{className:"text-xs text-gray-400 font-medium",children:"Cast Shadows"}),e.jsx("input",{type:"checkbox",checked:s.castShadow,onChange:x=>{t.handleInteractionStart("param"),t.updateLight({index:o,params:{castShadow:x.target.checked}}),t.handleInteractionEnd()},className:"w-3 h-3 accent-cyan-500 bg-gray-800 border-gray-600 rounded cursor-pointer"})]})]})]})]}),e.jsx("div",{className:"h-px bg-gray-800 my-4"}),e.jsx("div",{className:"flex items-center justify-between mb-4 p-3 bg-gray-800/50 rounded-lg",children:e.jsx(Ge,{label:"Show 3d helpers",value:a.showLightGizmo,onChange:t.setShowLightGizmo,color:"bg-cyan-600"})}),n&&e.jsxs("div",{className:"mt-4 p-3 bg-gray-800/50 rounded-lg","data-help-id":"shadows",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("label",{className:"text-[10px] font-bold text-gray-400 uppercase tracking-wider",children:"Shadows (Global)"}),e.jsx("div",{className:"w-[60px]",children:e.jsx(Ge,{value:n.shadows,onChange:x=>t.setLighting({shadows:x}),color:"bg-yellow-500"})})]}),n.shadows&&e.jsx("div",{className:"pl-2 mt-2 border-l-2 border-yellow-500/30",children:e.jsx(Ce,{featureId:"lighting",groupFilter:"shadows"})})]})]})},ff=a=>{if(a===0)return"0";if(Math.abs(a)<1)return a.toFixed(3);const t=a.toPrecision(5);return t.includes(".")?t.replace(/\.?0+$/,""):t},pf=({state:a,actions:t})=>{v.useRef(null),Y(n=>n.openContextMenu),a.debugMobileLayout||typeof window<"u"&&window.innerWidth<768;const o=a.materials,r=a.atmosphere;return a.lighting,!o||!r?null:e.jsxs("div",{className:"animate-fade-in -mx-4 -mt-4 flex flex-col","data-help-id":"panel.render",children:[e.jsx("div",{className:"flex flex-col","data-help-id":"mat.diffuse",children:e.jsx(Ce,{featureId:"materials",groupFilter:"surface"})}),e.jsx("div",{className:"flex flex-col","data-help-id":"mat.env",children:e.jsx(Ce,{featureId:"materials",groupFilter:"env"})}),e.jsx("div",{className:"flex flex-col border-t border-white/5","data-help-id":"mat.reflection",children:e.jsx(Ce,{featureId:"reflections",groupFilter:"shading"})}),e.jsx("div",{className:"flex flex-col","data-help-id":"mat.glow",children:e.jsx(Ce,{featureId:"atmosphere",groupFilter:"glow"})}),e.jsx("div",{className:"flex flex-col","data-help-id":"mat.emission",children:e.jsx(Ce,{featureId:"materials",groupFilter:"emission"})}),e.jsx("div",{className:"flex flex-col border-t border-white/5","data-help-id":"mat.ao",children:e.jsx(Ce,{featureId:"ao",groupFilter:"shading"})})]})},hf=({state:a,actions:t})=>{const o=Y(y=>y.openContextMenu),r=a.quality,n=a.lighting;a.ao;const[i,s]=a.fixedResolution,[l,d]=v.useState("Free");a.debugMobileLayout||typeof window<"u"&&window.innerWidth<768;const c=(n==null?void 0:n.ptEnabled)!==!1,f=t.setLighting,u=v.useMemo(()=>{const y=`${i}x${s}`;return["800x600","1280x720","1920x1080","2560x1440","3840x2160","1080x1080","1080x1350","1080x1920","2048x1024","4096x2048"].includes(y)?y:"Custom"},[i,s]),p=y=>{const x=Oe(y.currentTarget);x.length>0&&(y.preventDefault(),y.stopPropagation(),o(y.clientX,y.clientY,[],x))},h=async y=>{a.renderMode!==y&&(le.emit("is_compiling","Switching Engine..."),await new Promise(x=>setTimeout(x,50)),t.setRenderMode(y))},g=(y,x)=>{const C=Math.max(64,Math.round(y/8)*8),k=Math.max(64,Math.round(x/8)*8);t.setFixedResolution(C,k)},M=(y,x)=>{l==="Free"?g(y==="w"?x:i,y==="h"?x:s):y==="w"?g(x,x/l):g(x*l,x)},m=[.25,.5,1,1.5,2];return e.jsxs("div",{className:"animate-fade-in -mx-4 -mt-4 flex flex-col",children:[e.jsxs("div",{className:"bg-gray-900 border-b border-white/5 py-3 px-3","data-help-id":"render.engine",children:[e.jsx("label",{className:"text-[10px] text-gray-400 font-bold uppercase tracking-wider block mb-1",children:"Render Engine"}),e.jsxs("div",{className:"flex bg-black/40 rounded p-0.5 border border-white/10",children:[e.jsx("button",{onClick:()=>h("Direct"),className:`flex-1 py-1.5 text-[10px] font-bold uppercase tracking-wide rounded transition-colors ${a.renderMode==="Direct"?"bg-cyan-700 text-white":"text-gray-500 hover:text-gray-300"}`,children:"Direct (Fast)"}),e.jsx("button",{onClick:()=>c&&h("PathTracing"),disabled:!c,className:`flex-1 py-1.5 text-[10px] font-bold uppercase tracking-wide rounded transition-colors ${c?a.renderMode==="PathTracing"?"bg-purple-700 text-white":"text-gray-500 hover:text-gray-300":"text-gray-700 cursor-not-allowed opacity-50 bg-transparent"}`,title:c?"Switch to Path Tracer (GI)":"Path Tracer Disabled in Engine Panel",children:"Path Tracer (GI)"})]}),a.renderMode==="PathTracing"&&n&&e.jsxs("div",{className:"mt-3 pt-2 border-t border-white/5 animate-fade-in","data-help-id":"pt.global",children:[e.jsxs("div",{className:"flex items-center justify-between mb-1.5",children:[e.jsx("label",{className:"text-[9px] text-gray-500 font-bold uppercase tracking-wider",children:"Max Bounces"}),e.jsx("div",{className:"w-12 h-4 bg-black/40 rounded border border-white/10 relative",children:e.jsx(_e,{value:n.ptBounces,min:1,max:8,step:1,onChange:y=>f({ptBounces:Math.round(y)}),highlight:!0})})]}),e.jsx(Me,{label:"GI Brightness",value:n.ptGIStrength,min:0,max:5,step:.01,onChange:y=>f({ptGIStrength:y}),trackId:"lighting.ptGIStrength"})]})]}),e.jsxs("div",{className:"bg-gray-800/20 border-b border-white/5 py-3 px-3",onContextMenu:p,"data-help-id":"panel.quality",children:[e.jsx(Ge,{label:"Resolution",value:a.resolutionMode,onChange:t.setResolutionMode,options:[{label:"Fill Screen",value:"Full"},{label:"Fixed",value:"Fixed"}]}),e.jsxs("div",{className:"mt-3 bg-black/20 rounded border border-white/5 p-2","data-help-id":"quality.scale",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("label",{className:"text-[10px] text-gray-400 font-bold uppercase tracking-wider",children:"Internal Scale"}),e.jsx("span",{className:"text-[10px] font-mono text-cyan-400 font-bold",children:`${a.aaLevel.toFixed(2)}x`})]}),e.jsx("div",{className:"grid grid-cols-5 gap-px bg-white/5 border border-white/5 rounded overflow-hidden",children:m.map(y=>e.jsx("button",{onClick:()=>t.setAALevel(y),className:`py-1.5 text-[9px] font-black transition-all ${a.aaLevel===y?"bg-cyan-600/40 text-cyan-300 shadow-[inset_0_0_10px_rgba(34,211,238,0.1)]":"bg-transparent text-gray-500 hover:text-gray-300 hover:bg-white/5"}`,children:y},y))}),e.jsx("div",{className:"mt-2 pt-2 border-t border-white/5",children:e.jsx(Ce,{featureId:"quality",groupFilter:"performance"})})]}),a.resolutionMode==="Fixed"&&e.jsxs("div",{className:"flex flex-col gap-2 mt-3 pt-3 border-t border-white/5 animate-fade-in",children:[e.jsx(vt,{label:"Preset",value:u,options:[{label:"SVGA (800 x 600)",value:"800x600"},{label:"HD (1280 x 720)",value:"1280x720"},{label:"FHD (1920 x 1080)",value:"1920x1080"},{label:"QHD (2560 x 1440)",value:"2560x1440"},{label:"4K (3840 x 2160)",value:"3840x2160"},{label:"Square 1:1 (1080p)",value:"1080x1080"},{label:"Portrait 4:5 (1080p)",value:"1080x1350"},{label:"Vertical 9:16 (1080p)",value:"1080x1920"},{label:"Skybox Low (2048 x 1024)",value:"2048x1024"},{label:"Skybox High (4096 x 2048)",value:"4096x2048"},{label:"Custom",value:"Custom"}],onChange:y=>{if(y!=="Custom"){const[x,C]=y.split("x").map(Number);g(x,C)}},fullWidth:!0}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("label",{className:"text-[9px] text-gray-500 font-bold block mb-0.5",children:"Width"}),e.jsx("div",{className:"h-6 bg-black/40 rounded border border-white/10 relative",children:e.jsx(_e,{value:i,onChange:y=>M("w",y),step:8,min:64,max:8192,overrideText:`${i}`})})]}),e.jsxs("div",{className:"flex-1",children:[e.jsx("label",{className:"text-[9px] text-gray-500 font-bold block mb-0.5",children:"Height"}),e.jsx("div",{className:"h-6 bg-black/40 rounded border border-white/10 relative",children:e.jsx(_e,{value:s,onChange:y=>M("h",y),step:8,min:64,max:8192,overrideText:`${s}`})})]}),e.jsxs("div",{className:"w-[35%]",children:[e.jsx("label",{className:"text-[9px] text-gray-500 font-bold block mb-0.5",children:"Ratio"}),e.jsx("div",{className:"h-6",children:e.jsx(vt,{value:l,options:[{label:"Free",value:"Free"},{label:"16:9",value:1.7777},{label:"4:3",value:1.3333},{label:"1:1",value:1},{label:"4:5 (Portrait)",value:.8},{label:"9:16 (Vertical)",value:.5625},{label:"2:1 (Sky)",value:2}],onChange:y=>{d(y),y!=="Free"&&g(i,i/y)},fullWidth:!0,className:"!px-1"})})]})]})]})]}),e.jsxs("div",{className:"bg-gray-800/10 border-b border-white/5 py-3 px-3","data-help-id":"quality.tss",children:[e.jsx(Ge,{label:"Temporal AA (Remove Noise)",value:a.accumulation,onChange:t.setAccumulation,color:"bg-green-500",helpId:"quality.tss"}),c&&e.jsx("div",{className:"mt-2 pt-2 border-t border-white/5",children:e.jsx(Ge,{label:"Area Lights (Soft Shadows)",value:n.ptStochasticShadows,onChange:y=>f&&f({ptStochasticShadows:y}),helpId:"pt.global"})})]}),(n==null?void 0:n.shadowsCompile)&&(n==null?void 0:n.shadows)&&e.jsx("div",{className:"bg-gray-800/10 border-b border-white/5 py-2 px-3","data-help-id":"shadows",children:e.jsx(Ce,{featureId:"lighting",groupFilter:"shadow_quality"})}),e.jsx("div",{className:"flex flex-col",children:r&&e.jsx(Ce,{featureId:"quality",groupFilter:"kernel"})})]})},mf=v.memo(({label:a,val:t,min:o,max:r,step:n,binding:i,onToggle:s,onChange:l,hardMin:d,hardMax:c})=>e.jsxs("div",{className:"flex gap-2 items-start mb-1",children:[e.jsx("div",{className:"flex-1",children:e.jsx(Me,{label:i?`${a} (Bound to ${i})`:a,value:t,min:o,max:r,step:n,hardMin:d,hardMax:c,onChange:l,highlight:!!i})}),e.jsx("button",{onClick:s,className:`mt-6 p-1 rounded border transition-colors ${i?"bg-cyan-900/50 border-cyan-500/50":"bg-transparent border-transparent hover:bg-white/5"}`,title:i?`Bound to ${i}. Click to cycle.`:"Click to link to global parameter",children:e.jsx(na,{active:!!i})})]})),gf=({node:a,index:t,updateParams:o,toggleBinding:r,updateNode:n})=>{var f,u,p;const[i,s]=v.useState(!1),l=()=>{var g;((g=a.condition)==null?void 0:g.active)?n(t,{condition:{...a.condition,active:!1}}):(n(t,{condition:{active:!0,mod:2,rem:0}}),s(!0))},d=(h,g)=>{a.condition&&n(t,{condition:{...a.condition,[h]:g}})},c=Ie.get(a.type);return a.type==="Note"?e.jsx("textarea",{className:"w-full bg-black/20 text-gray-300 text-xs p-2 rounded border border-white/5 focus:border-cyan-500 outline-none resize-none font-sans leading-relaxed",rows:3,value:a.text||"",onChange:h=>n(t,{text:h.target.value}),placeholder:"Type a note..."}):e.jsxs("div",{children:[c?c.inputs.map(h=>{var g;return e.jsx(mf,{label:h.label,val:a.params[h.id]??h.default,min:h.min,max:h.max,step:h.step,hardMin:h.hardMin,hardMax:h.hardMax,binding:(g=a.bindings)==null?void 0:g[h.id],onToggle:()=>r(t,h.id),onChange:M=>o(t,{[h.id]:M})},h.id)}):e.jsxs("div",{className:"text-red-500 text-[10px]",children:["Unknown Node Type: ",a.type]}),e.jsxs("div",{className:"mt-2 border-t border-white/10 pt-2",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("button",{onClick:()=>s(!i),className:"flex items-center gap-1 text-[10px] text-gray-500 hover:text-white uppercase tracking-widest font-bold",children:[e.jsx(Ql,{active:!!((f=a.condition)!=null&&f.active)}),"Logic / Condition"]}),e.jsx("input",{type:"checkbox",checked:!!((u=a.condition)!=null&&u.active),onChange:l,className:"cursor-pointer"})]}),i&&((p=a.condition)==null?void 0:p.active)&&e.jsxs("div",{className:"mt-2 bg-amber-900/10 p-2 rounded border border-amber-500/20",children:[e.jsxs("div",{className:"text-[9px] text-amber-200 mb-2",children:["Execute only on specific iterations:",e.jsx("br",{}),e.jsx("code",{children:"if (iter % Mod == Rem)"})]}),e.jsx(Me,{label:"Modulo (Every N iters)",value:a.condition.mod,min:1,max:10,step:1,onChange:h=>d("mod",Math.round(h))}),e.jsx(Me,{label:"Remainder (On index)",value:a.condition.rem,min:0,max:a.condition.mod-1,step:1,onChange:h=>d("rem",Math.round(h))})]})]})]})},xf=v.memo(({data:a,id:t,selected:o})=>{const r=a.node,{updateParams:n,toggleBinding:i,updateNode:s,removeNode:l}=a.actions,d=a.index,c=Ie.get(r.type);let f="text-gray-400",u=o?"border-cyan-500":"border-gray-700",p="";const h=(c==null?void 0:c.category)==="Combiners (CSG)";return r.type==="Mandelbulb"&&(f="text-pink-400"),(c==null?void 0:c.category)==="Folds"&&(f="text-amber-400"),((c==null?void 0:c.category)==="Transforms"||(c==null?void 0:c.category)==="Distortion")&&(f="text-blue-400"),h&&(f="text-green-400",p="bg-green-900/20"),e.jsxs("div",{className:`w-64 bg-gray-900/90 backdrop-blur-md rounded-lg border shadow-xl transition-all ${u}`,children:[h?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"absolute -top-3 left-8 text-[9px] text-gray-500 font-bold uppercase",children:"A"}),e.jsx(Ht,{type:"target",position:Ut.Top,id:"a",className:"!bg-cyan-500 !w-3 !h-3 !border-none -mt-1.5 !left-8"}),e.jsx("div",{className:"absolute -top-3 right-8 text-[9px] text-gray-500 font-bold uppercase",children:"B"}),e.jsx(Ht,{type:"target",position:Ut.Top,id:"b",className:"!bg-cyan-500 !w-3 !h-3 !border-none -mt-1.5 !left-auto !right-8"})]}):e.jsx(Ht,{type:"target",position:Ut.Top,className:"!bg-cyan-500 !w-3 !h-3 !border-none -mt-1.5"}),e.jsxs("div",{className:`flex items-center justify-between px-3 py-2 border-b border-white/10 bg-white/5 rounded-t-lg handle cursor-move ${p}`,children:[e.jsx("div",{className:"flex items-center gap-2",children:e.jsx("span",{className:`text-xs font-bold uppercase tracking-wider ${f}`,children:(c==null?void 0:c.label)||r.type})}),e.jsx("button",{onClick:g=>{g.stopPropagation(),l(t)},className:"text-gray-600 hover:text-red-400 transition-colors",children:e.jsx(Vt,{})})]}),e.jsx("div",{className:"p-3",children:e.jsx(gf,{node:r,index:d,updateParams:(g,M)=>n(t,M),toggleBinding:(g,M)=>i(t,M),updateNode:(g,M)=>s(t,M)})}),e.jsx(Ht,{type:"source",position:Ut.Bottom,className:"!bg-cyan-500 !w-3 !h-3 !border-none -mb-1.5"})]})}),yf=v.memo(()=>e.jsxs("div",{className:"px-4 py-2 bg-green-900/20 border border-green-500/50 rounded-full shadow-[0_0_15px_rgba(34,197,94,0.2)]",children:[e.jsx("span",{className:"text-xs font-bold text-green-400 uppercase tracking-widest",children:"Input (Z)"}),e.jsx(Ht,{type:"source",position:Ut.Bottom,className:"!bg-green-500 !w-3 !h-3 !border-none -mb-1.5"})]})),bf=v.memo(()=>e.jsxs("div",{className:"px-4 py-2 bg-pink-900/20 border border-pink-500/50 rounded-full shadow-[0_0_15px_rgba(236,72,153,0.2)]",children:[e.jsx(Ht,{type:"target",position:Ut.Top,className:"!bg-pink-500 !w-3 !h-3 !border-none -mt-1.5"}),e.jsx("span",{className:"text-xs font-bold text-pink-400 uppercase tracking-widest",children:"Output (Distance)"})]})),vf=({menu:a,onClose:t,onAdd:o})=>{const r=v.useRef(null),[n,i]=v.useState(""),s=v.useRef(null),[l,d]=v.useState({x:0,y:0,visible:!1});v.useLayoutEffect(()=>{if(r.current){const p=r.current.getBoundingClientRect(),h=window.innerWidth,g=window.innerHeight,M=10;let m=a.x,y=a.y;m+p.width>h-M&&(m=h-p.width-M),y+p.height>g-M&&(y=g-p.height-M),m=Math.max(M,m),y=Math.max(M,y),d({x:m,y,visible:!0}),s.current&&requestAnimationFrame(()=>{var x;return(x=s.current)==null?void 0:x.focus()})}},[a.x,a.y]),v.useEffect(()=>{const p=h=>{r.current&&!r.current.contains(h.target)&&t()};return document.addEventListener("mousedown",p,!0),()=>document.removeEventListener("mousedown",p,!0)},[t]);const c=Ie.getGrouped(),f=Ie.getAll(),u=n?f.filter(p=>p.id.toLowerCase().includes(n.toLowerCase())||p.label.toLowerCase().includes(n.toLowerCase())):null;return wt.createPortal(e.jsxs("div",{ref:r,className:"fixed w-48 bg-[#1a1a1a] border border-gray-600 rounded-lg shadow-2xl flex flex-col text-xs overflow-hidden animate-pop-in",style:{left:l.x,top:l.y,opacity:l.visible?1:0,visibility:l.visible?"visible":"hidden",zIndex:9999},onKeyDown:p=>p.stopPropagation(),children:[e.jsx("div",{className:"p-2 border-b border-white/10 bg-gray-800/50",children:e.jsx("input",{ref:s,type:"text",placeholder:"Search node...",className:"w-full bg-black/50 border border-gray-600 rounded px-2 py-1 text-gray-200 outline-none focus:border-cyan-500",value:n,onChange:p=>i(p.target.value),onKeyDown:p=>{if(p.key==="Enter"){const h=u?u[0]:f[0];h&&(o(h.id,{x:a.paneX,y:a.paneY}),t())}}})}),e.jsxs("div",{className:"max-h-64 overflow-y-auto custom-scroll py-1",children:[u?u.map(p=>e.jsx(jr,{type:p.id,label:p.label,desc:p.description,onClick:()=>{o(p.id,{x:a.paneX,y:a.paneY}),t()}},p.id)):Object.entries(c).map(([p,h])=>e.jsxs("div",{className:"mb-1",children:[e.jsx("div",{className:"px-3 py-1 text-[9px] font-bold text-gray-500 uppercase tracking-wider bg-white/5",children:p}),h.map(g=>{const M=Ie.get(g);return e.jsx(jr,{type:g,label:(M==null?void 0:M.label)||g,desc:M==null?void 0:M.description,onClick:()=>{o(g,{x:a.paneX,y:a.paneY}),t()}},g)})]},p)),u&&u.length===0&&e.jsx("div",{className:"p-3 text-gray-500 text-center italic",children:"No matches"})]})]}),document.body)},jr=({type:a,label:t,desc:o,onClick:r})=>e.jsxs("button",{className:"w-full text-left px-3 py-1.5 hover:bg-cyan-900/50 hover:text-white text-gray-300 transition-colors flex items-center justify-between group",onClick:r,title:o,children:[e.jsx("span",{children:t}),e.jsx("span",{className:"text-[9px] text-gray-600 group-hover:text-cyan-400 opacity-0 group-hover:opacity-100 transition-opacity",children:"+"})]}),Tr=[{name:"Empty Scene",nodes:[]},{name:"Mandelbulb (Standard)",nodes:[{id:"mod-1",type:"Mod",enabled:!0,params:{x:0,y:0,z:0}},{id:"rot-1",type:"Rotate",enabled:!0,params:{x:0,y:0,z:0}},{id:"mb-1",type:"Mandelbulb",enabled:!0,params:{power:8}},{id:"add-c",type:"AddConstant",enabled:!0,params:{scale:1}}]},{name:"Amazing Box (Classic)",nodes:[{id:"box-1",type:"BoxFold",enabled:!0,params:{limit:1}},{id:"sph-1",type:"SphereFold",enabled:!0,params:{minR:.5,fixedR:1}},{id:"scl-1",type:"Scale",enabled:!0,params:{scale:2}},{id:"add-c",type:"AddConstant",enabled:!0,params:{scale:1}}]},{name:"MixPinski (IFS)",nodes:[{id:"mix-1",type:"SierpinskiFold",enabled:!0,params:{}},{id:"mix-2",type:"Rotate",enabled:!0,params:{x:0,y:0,z:0},bindings:{z:"ParamC"}},{id:"mix-3",type:"IFSScale",enabled:!0,params:{scale:2,offset:1}}]},{name:"Menger Sponge",nodes:[{id:"meng-1",type:"Abs",enabled:!0,params:{}},{id:"meng-2",type:"MengerFold",enabled:!0,params:{}},{id:"meng-3",type:"Rotate",enabled:!0,params:{x:0,y:0,z:0}},{id:"meng-4",type:"IFSScale",enabled:!0,params:{scale:3,offset:1}}]},{name:"Kleinian",nodes:[{id:"klein-1",type:"BoxFold",enabled:!0,params:{limit:1}},{id:"klein-2",type:"SphereFold",enabled:!0,params:{minR:.5,fixedR:1}},{id:"klein-3",type:"IFSScale",enabled:!0,params:{scale:1.8,offset:0}},{id:"klein-4",type:"Translate",enabled:!0,params:{x:1,y:0,z:0}}]},{name:"Marble Marcher",nodes:[{id:"marb-1",type:"Abs",enabled:!0,params:{}},{id:"marb-2",type:"Rotate",enabled:!0,params:{x:0,y:0,z:0},bindings:{z:"ParamC"}},{id:"marb-3",type:"MengerFold",enabled:!0,params:{}},{id:"marb-4",type:"Rotate",enabled:!0,params:{x:0,y:0,z:0},bindings:{x:"ParamD"}},{id:"marb-5",type:"IFSScale",enabled:!0,params:{scale:2,offset:2}}]}],wf={shaderNode:xf,start:yf,end:bf},Sf=({state:a,actions:t})=>{const[o,r,n]=bi([]),[i,s,l]=vi([]),[d,c]=v.useState(!1),[f,u]=v.useState(null),p=Y(H=>H.openContextMenu),{getNodes:h,getEdges:g,project:M}=wi(),m=v.useRef(a.pipelineRevision),y=v.useRef(!1),x=v.useRef(null),C=Ie.getGrouped(),k=H=>{const A=[],F=[];A.push({id:"root-start",type:"start",position:{x:250,y:50},data:{},selectable:!1,draggable:!1}),H.nodes.forEach(D=>{A.push({id:D.id,type:"shaderNode",position:D.position||{x:0,y:0},data:{node:D,actions:{updateParams:T,toggleBinding:L,updateNode:_,removeNode:R}},dragHandle:".handle"})});let I=50;return H.nodes.forEach(D=>{var G;((G=D.position)==null?void 0:G.y)>I&&(I=D.position.y)}),A.push({id:"root-end",type:"end",position:{x:250,y:I+200},data:{},selectable:!1,draggable:!1}),H.edges.forEach(D=>{F.push({id:D.id,source:D.source,target:D.target,sourceHandle:D.sourceHandle,targetHandle:D.targetHandle,animated:!0,style:{stroke:"#555",strokeWidth:2}})}),{nodes:A,edges:F}};v.useEffect(()=>{if(y.current){y.current=!1,m.current=a.pipelineRevision;return}if(!d||a.pipelineRevision!==m.current){const{nodes:H,edges:A}=k(a.graph);r(H),s(A),m.current=a.pipelineRevision,c(!0)}},[a.pipelineRevision,a.graph]);const S=v.useCallback((H,A)=>{const F=H.filter(D=>D.type==="shaderNode").map(D=>({...D.data.node,position:D.position})),I=A.map(D=>({id:D.id,source:D.source,target:D.target,sourceHandle:D.sourceHandle,targetHandle:D.targetHandle}));y.current=!0,t.setGraph({nodes:F,edges:I})},[t]),b=v.useCallback(H=>{r(A=>(s(F=>{const I=[...F,{...H,id:"temp"}],D=A.map(q=>q.data.node).filter(q=>!!q);if(Pl(D,I))return console.warn("Cycle detected!"),F;const G=Si({...H,animated:!0,style:{stroke:"#555",strokeWidth:2}},F);return S(A,G),G}),A))},[r,s,S]),w=v.useCallback(()=>{setTimeout(()=>{S(h(),g())},0)},[S,h,g]),j=v.useCallback(()=>{setTimeout(()=>{S(h(),g())},0)},[S,h,g]),T=v.useCallback((H,A)=>{r(F=>{const I=F.map(D=>D.id===H?{...D,data:{...D.data,node:{...D.data.node,params:{...D.data.node.params,...A}}}}:D);return s(D=>(S(I,D),D)),I})},[S,s]),L=v.useCallback((H,A)=>{r(F=>{const I=F.map(D=>{if(D.id===H){const G=D.data.node.bindings||{};let q=G[A],Q=q?q==="ParamA"?"ParamB":q==="ParamB"?"ParamC":q==="ParamC"?"ParamD":void 0:"ParamA";return{...D,data:{...D.data,node:{...D.data.node,bindings:{...G,[A]:Q}}}}}return D});return s(D=>(S(I,D),D)),I})},[S,s]),_=v.useCallback((H,A)=>{r(F=>{const I=F.map(D=>D.id===H?{...D,data:{...D.data,node:{...D.data.node,...A}}}:D);return s(D=>(S(I,D),D)),I})},[S,s]),R=v.useCallback(H=>{r(A=>{const F=A.filter(I=>I.id!==H);return s(I=>{const D=I.filter(G=>G.source!==H&&G.target!==H);return S(F,D),D}),F})},[S,s]),z=v.useCallback(H=>{s(A=>{const F=A.filter(I=>I.id!==H);return S(h(),F),F})},[S,h,s]),E=v.useCallback(()=>{S(h(),g())},[S,h,g]),N=(H,A)=>{const F=tt(),I=Ie.get(H),D={};I&&I.inputs.forEach(Q=>D[Q.id]=Q.default);const G={id:F,type:H,enabled:!0,params:D,position:A||{x:250,y:150}},q={id:F,type:"shaderNode",position:G.position,data:{node:G,actions:{updateParams:T,toggleBinding:L,updateNode:_,removeNode:R}},dragHandle:".handle"};r(Q=>{const J=[...Q,q];return S(J,g()),J})},P=H=>{const A=Tr.find(F=>F.name===H);if(A){const F=A.nodes.map(I=>({...I,id:tt(),params:{...I.params}}));t.setPipeline(F)}},$=v.useCallback(H=>{H.preventDefault(),H.stopPropagation();const A=M({x:H.clientX,y:H.clientY});u({type:"pane",x:H.clientX,y:H.clientY,paneX:A.x,paneY:A.y})},[M]),O=v.useCallback((H,A)=>{if(H.preventDefault(),H.stopPropagation(),A.type==="start"||A.type==="end")return;const F=[{label:"Node Actions",action:()=>{},isHeader:!0},{label:"Delete Node",danger:!0,action:()=>R(A.id)}],I=`formula.${A.data.node.type.toLowerCase()}`;p(H.clientX,H.clientY,F,[I,"ui.graph"])},[R,p]),X=v.useCallback((H,A)=>{H.preventDefault(),H.stopPropagation();const F=[{label:"Remove Connection",danger:!0,action:()=>z(A.id)}];p(H.clientX,H.clientY,F,["ui.graph"])},[z,p]),W=v.useCallback(()=>u(null),[]);return e.jsxs("div",{ref:x,className:"w-full h-[600px] flex flex-col relative","data-help-id":"ui.graph",children:[e.jsxs(Mi,{nodes:o,edges:i,onNodesChange:n,onEdgesChange:l,onNodesDelete:w,onEdgesDelete:j,onConnect:b,onNodeDragStop:E,onPaneContextMenu:$,onNodeContextMenu:O,onEdgeContextMenu:X,onPaneClick:W,onMoveStart:W,nodeTypes:wf,fitView:!0,minZoom:.1,maxZoom:4,deleteKeyCode:["Backspace","Delete"],selectionKeyCode:"Shift",multiSelectionKeyCode:["Control","Meta"],children:[e.jsx(Ci,{color:"#222",gap:20,size:1}),e.jsx(ki,{}),e.jsx(ji,{style:{height:100,backgroundColor:"#111"},nodeColor:"#333"}),e.jsxs("div",{className:"absolute top-4 left-4 z-10 flex flex-wrap gap-2 max-w-[90%]",children:[e.jsxs("div",{className:"flex items-center bg-gray-900 border border-gray-700 rounded shadow-lg overflow-hidden",children:[e.jsx("span",{className:"px-2 text-[10px] text-gray-500 font-bold uppercase select-none",children:"Add:"}),e.jsxs("select",{onChange:H=>{H.target.value&&N(H.target.value),H.target.value=""},className:"bg-gray-900 text-xs text-white px-2 py-1.5 outline-none cursor-pointer hover:text-cyan-400 border-l border-gray-800",children:[e.jsx("option",{value:"",className:"bg-gray-900 text-gray-500",children:"Select Node..."}),Object.entries(C).map(([H,A])=>H==="Utils"&&A.length===1&&A[0]==="Note"?null:e.jsx("optgroup",{label:H,className:"bg-gray-900 text-gray-400 font-bold",children:A.map(F=>{const I=Ie.get(F);return e.jsx("option",{value:F,className:"bg-gray-900 text-white font-normal",children:(I==null?void 0:I.label)||F},F)})},H)),e.jsx("option",{value:"Note",className:"bg-gray-900 text-white",children:"Comment / Note"})]})]}),e.jsxs("div",{className:"flex items-center bg-gray-900 border border-gray-700 rounded shadow-lg overflow-hidden",children:[e.jsx("span",{className:"px-2 text-[10px] text-gray-500 font-bold uppercase select-none",children:"Load:"}),e.jsxs("select",{onChange:H=>{H.target.value&&P(H.target.value),H.target.value=""},className:"bg-gray-900 text-xs text-white px-2 py-1.5 outline-none cursor-pointer hover:text-purple-400 border-l border-gray-800",children:[e.jsx("option",{value:"",className:"bg-gray-900 text-gray-500",children:"Select Preset..."}),Tr.map(H=>e.jsx("option",{value:H.name,className:"bg-gray-900 text-white",children:H.name},H.name))]})]}),e.jsxs("label",{className:"flex items-center gap-1.5 bg-gray-900 border border-gray-700 rounded px-2 shadow-lg cursor-pointer text-[10px] text-gray-400 font-bold uppercase hover:border-gray-500 hover:text-gray-300 transition-colors select-none",children:[e.jsx("input",{type:"checkbox",checked:a.autoCompile,onChange:H=>t.setAutoCompile(H.target.checked),className:"cursor-pointer accent-cyan-500"}),"Auto Compile"]}),e.jsxs("label",{className:`flex items-center gap-1.5 rounded px-2 shadow-lg cursor-pointer text-[10px] font-bold uppercase border transition-colors select-none ${a.previewMode?"bg-amber-900/40 border-amber-500/50 text-amber-300":"bg-gray-900 border-gray-700 text-gray-400 hover:border-gray-500"}`,children:[e.jsx("input",{type:"checkbox",checked:a.previewMode,onChange:H=>t.setPreviewMode(H.target.checked),className:"cursor-pointer accent-amber-500"}),"Preview Mode"]}),e.jsx("button",{onClick:t.refreshPipeline,className:`text-[10px] font-bold px-3 py-1.5 rounded border shadow-lg transition-all ${a.autoCompile?"bg-gray-800 text-gray-600 border-gray-700":"bg-purple-600 hover:bg-purple-500 text-white border-purple-400 animate-pulse"}`,title:"Force Recompile Shader",children:"COMPILE"})]})]}),f&&e.jsx(vf,{menu:f,onClose:()=>u(null),onAdd:(H,A)=>N(H,A)})]})},Mf=a=>e.jsx(yi,{children:e.jsx(Sf,{...a})}),Vn=(a,t)=>{if(!a)return null;let o=1/0,r=-1/0;const n=[];for(let h=0;h<a.length;h+=4){const g=a[h];g>-.9&&(t||(g<o&&(o=g),g>r&&(r=g)),n.push(g))}let i,s;if(t)i=t.min,s=t.max;else{if(o===1/0)return null;const h=r-o;h<1e-4?(i=o-.1,s=r+.1):(i=o-h*.05,s=r+h*.05)}const l=128,d=new Array(l).fill(0),c=s-i,f=Math.max(c,1e-6);for(const h of n){const g=(h-i)/f,M=Math.floor(g*l);M>=0&&M<l&&d[M]++}const u=Math.max(...d);return{buckets:d.map(h=>h>0?Math.log(h+1)/Math.log(u+1):0),min:i,max:s}},Zn=(a,t,o)=>{if(!a||a.length<10)return null;const r=a.length,n=a.map((x,C)=>C===0||C===r-1?0:x);let i=0;if(n.forEach(x=>i+=x),i<.01)return{start:t,end:o};const s=i*.02,l=i*.98;let d=0,c=0,f=r-1,u=!1;for(let x=0;x<r;x++)if(d+=n[x],!u&&d>=s&&(c=x,u=!0),d>=l){f=x;break}const p=.05;for(;c>1&&a[c-1]>p&&!(a[c-1]>a[c]*2);)c--;for(;f<r-2&&a[f+1]>p&&!(a[f+1]>a[f]*2);)f++;const h=(o-t)/r;let g=t+c*h,M=t+f*h;const y=(M-g)*.05;return g=Math.max(t,g-y),M=Math.min(o,M+y),{start:g,end:M}},Kn=({data:a,min:t,max:o,gamma:r,repeats:n=1,phase:i=0,gradientStops:s,onChange:l,autoUpdate:d,onToggleAuto:c,onRefresh:f,isStale:u=!1,height:p=48,labelTitle:h="Levels",labelLeft:g="Black",labelMid:M="Gamma",labelRight:m="White",fixedRange:y})=>{const x=v.useRef(null),[C,k]=v.useState(y||{min:0,max:1}),S=Y(F=>F.openContextMenu),b=v.useMemo(()=>{const F=Vn(a,y);return F?(k({min:F.min,max:F.max}),F.buckets):(y&&k(y),[])},[a,y]),w=Math.pow(.5,1/r)*100;v.useEffect(()=>{const F=x.current;if(!F)return;const I=F.getContext("2d");if(!I||(I.clearRect(0,0,F.width,F.height),b.length===0))return;const D=F.width,G=F.height,q=D/b.length;I.fillStyle="#666",b.forEach((Q,J)=>{const re=Q*G;I.fillRect(J*q,G-re,q,re)})},[b]);const j=F=>{const I=C.max-C.min;return I<1e-5?50:(F-C.min)/I*100},T=b.length>0||y,L=T?j(t):0,_=T?j(o):100,R=_-L,z=L+w/100*R,E=v.useRef(null),N=(F,I)=>{F.preventDefault(),F.stopPropagation(),E.current={type:I,startX:F.clientX,startMin:t,startMax:o,startGamma:r},window.addEventListener("mousemove",P),window.addEventListener("mouseup",$)},P=F=>{if(!E.current||!x.current)return;const{type:I,startX:D,startMin:G,startMax:q,startGamma:Q}=E.current,J=x.current.getBoundingClientRect(),re=F.clientX-D,U=C.max-C.min,V=b.length>0||y?U:1,te=re/J.width*V;let K=G,ae=q,se=Q;if(I==="min")K+=te;else if(I==="max")ae+=te;else if(I==="pan")K+=te,ae+=te;else if(I==="gamma"){const ee=J.width*Math.abs(q-G)/V,he=Math.pow(.5,1/Q)*ee,oe=Math.max(1,Math.min(ee-1,he+re))/ee;se=Math.log(.5)/Math.log(oe),se=Math.max(.1,Math.min(10,se))}K>=ae&&(I==="min"&&(K=ae-.001),I==="max"&&(ae=K+.001)),l({min:K,max:ae,gamma:se})},$=()=>{E.current=null,window.removeEventListener("mousemove",P),window.removeEventListener("mouseup",$)},O=()=>{if(b.length===0)return;const F=Zn(b,C.min,C.max);F&&l({min:F.start,max:F.end,gamma:1})},X=F=>{F.preventDefault(),F.stopPropagation(),l({min:0,max:1,gamma:1})},W=F=>{const I=Oe(F.currentTarget);I.length>0&&(F.preventDefault(),F.stopPropagation(),S(F.clientX,F.clientY,[],I))},H=v.useMemo(()=>ja(s||[{id:"b",position:0,color:"#000000"},{id:"w",position:1,color:"#ffffff"}],r),[s,r]),A={left:`${L}%`,width:`${Math.max(0,_-L)}%`,backgroundImage:H,backgroundSize:`${100/Math.max(.1,n)}% 100%`,backgroundPosition:`${i*100}% 0%`,backgroundRepeat:"repeat-x"};return e.jsxs("div",{className:"py-2 bg-gray-900/40","data-help-id":"ui.histogram",onContextMenu:W,children:[e.jsxs("div",{className:"flex justify-between items-center mb-2 px-3",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("label",{className:"text-[10px] text-gray-500 font-bold uppercase tracking-wider",children:h}),u&&!d&&e.jsx("span",{className:"text-[8px] text-amber-400 bg-amber-900/30 px-1.5 py-0.5 rounded border border-amber-500/30",children:"STALE"}),c&&e.jsx("div",{className:"flex items-center justify-center w-4 h-4 cursor-pointer group rounded hover:bg-white/10",onClick:c,title:"Auto-update histogram (Live)",children:e.jsx("div",{className:`w-2 h-2 rounded-full transition-all duration-300 ${d?"bg-green-500 shadow-[0_0_5px_rgba(34,197,94,0.8)]":"bg-gray-600"}`})}),f&&!d&&e.jsx("button",{onClick:f,className:"text-[9px] text-cyan-500 hover:text-white ml-1",children:"REFRESH"})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("button",{onClick:()=>l({min:0,max:1,gamma:1}),className:"px-2 py-0.5 bg-gray-800/50 hover:bg-gray-700 text-gray-400 hover:text-white text-[8px] rounded border border-gray-600 transition-colors uppercase font-bold",title:"Reset to 0-1 range",children:"0-1"}),c&&e.jsx("button",{onClick:O,className:"px-2 py-0.5 bg-cyan-900/40 hover:bg-cyan-700 text-cyan-400 text-[9px] rounded border border-cyan-800 transition-colors uppercase font-bold",title:"Fit range to current data",children:"Fit"})]})]}),e.jsxs("div",{className:`relative w-full bg-black/60 overflow-hidden select-none border-y border-white/5 transition-colors group/hist ${f&&!d?"cursor-pointer hover:bg-black/40":""}`,style:{height:p},onClick:f&&!d?f:void 0,children:[e.jsxs("div",{className:"absolute inset-0 right-4 left-3 mx-2",children:[e.jsx("canvas",{ref:x,width:320,height:p,className:"w-full h-full opacity-40 absolute inset-0"}),e.jsx("div",{className:"absolute top-0 bottom-0 opacity-40 pointer-events-none",style:A}),e.jsxs("div",{className:"absolute top-0 bottom-0 w-4 -ml-2 cursor-ew-resize z-20 group/min flex justify-center",style:{left:`${L}%`},onMouseDown:F=>N(F,"min"),children:[e.jsx("div",{className:"w-px h-full bg-white/60 group-hover/min:bg-white group-hover/min:w-0.5 transition-all shadow-[0_0_5px_rgba(0,0,0,0.8)]"}),e.jsx("div",{className:"absolute top-0 w-0 h-0 border-l-[4px] border-r-[4px] border-t-[6px] border-l-transparent border-r-transparent border-t-white"})]}),e.jsxs("div",{className:"absolute top-0 bottom-0 w-4 -ml-2 cursor-ew-resize z-20 group/max flex justify-center",style:{left:`${_}%`},onMouseDown:F=>N(F,"max"),children:[e.jsx("div",{className:"w-px h-full bg-white/60 group-hover/max:bg-white group-hover/max:w-0.5 transition-all shadow-[0_0_5px_rgba(0,0,0,0.8)]"}),e.jsx("div",{className:"absolute bottom-0 w-0 h-0 border-l-[4px] border-r-[4px] border-b-[6px] border-l-transparent border-r-transparent border-b-white"})]}),R>5&&e.jsx("div",{className:"absolute top-1/2 -translate-y-1/2 w-4 h-4 -ml-2 cursor-ew-resize z-30 group/gamma flex items-center justify-center",style:{left:`${z}%`},onMouseDown:F=>N(F,"gamma"),children:e.jsx("div",{className:"w-2 h-2 rotate-45 bg-gray-400 border border-black group-hover/gamma:bg-white group-hover/gamma:scale-125 transition-transform shadow-md"})}),e.jsx("div",{className:"absolute top-0 bottom-0 cursor-grab active:cursor-grabbing z-10",style:{left:`${L}%`,width:`${Math.max(0,_-L)}%`},onMouseDown:F=>N(F,"pan")})]}),e.jsxs("button",{onClick:X,className:"absolute top-0 bottom-0 right-0 w-4 bg-red-900/50 hover:bg-red-700/80 border-l border-white/10 z-40 opacity-0 group-hover/hist:opacity-100 transition-opacity flex items-center justify-center",title:"Reset Range",children:[e.jsx("div",{className:"w-px h-2 bg-white/80 rotate-45 transform origin-center absolute"}),e.jsx("div",{className:"w-px h-2 bg-white/80 -rotate-45 transform origin-center absolute"})]})]}),e.jsxs("div",{className:"flex justify-between items-center mt-2 px-3",children:[e.jsxs("div",{className:"flex flex-col items-start w-16",children:[e.jsx("span",{className:"text-[8px] text-gray-600 uppercase tracking-widest",children:g}),e.jsx(_e,{value:t,onChange:F=>l({min:F,max:o,gamma:r}),step:.01,min:-1/0,max:1/0,highlight:!0})]}),e.jsxs("div",{className:"flex flex-col items-center w-16",children:[e.jsx("span",{className:"text-[8px] text-gray-600 uppercase tracking-widest",children:M}),e.jsx(_e,{value:r,onChange:F=>l({min:t,max:o,gamma:F}),step:.01,min:.1,max:10,overrideText:r.toFixed(2)})]}),e.jsxs("div",{className:"flex flex-col items-end w-16",children:[e.jsx("span",{className:"text-[8px] text-gray-600 uppercase tracking-widest",children:m}),e.jsx(_e,{value:o,onChange:F=>l({min:t,max:F,gamma:r}),step:.01,min:-1/0,max:1/0,highlight:!0})]})]})]})},Cf=({layer:a,state:t,histogramData:o,onChange:r,onRefresh:n,autoUpdate:i,onToggleAuto:s,liveModulations:l})=>{const d=v.useRef(!1),c=a===1?t.repeats:t.repeats2,f=a===1?t.phase:t.phase2,u=a===1?t.scale:t.scale2,p=a===1?t.offset:t.offset2,h=a===1?t.bias:t.bias2,g=a===1?t.gradient:t.gradient2,M=a===1?t.mode:t.mode2,m=a===1?"scale":"scale2",y=a===1?"offset":"offset2",x=a===1?"repeats":"repeats2",C=a===1?"phase":"phase2",k=a===1?"bias":"bias2",S=v.useRef(c),b=v.useRef(f),w=v.useRef(u),j=v.useRef(p),T=v.useRef(M);v.useEffect(()=>{if(M!==T.current){const R=Math.abs(u-w.current)>.001,z=Math.abs(p-j.current)>.001;!R&&!z&&(d.current=!0,i||n()),T.current=M}},[M,u,p,i,n]),v.useEffect(()=>{if(d.current&&o){const R=Vn(o);if(R){const z=Zn(R.buckets,R.min,R.max);if(z){const E=z.end-z.start,N=Math.abs(E)<1e-4?1e-4:E,P=c/N,$=f-z.start*P;r({[m]:P,[y]:$}),d.current=!1}}}},[o,c,f,m,y,r]),v.useEffect(()=>{const R=Math.abs(c-S.current)>.001,z=Math.abs(f-b.current)>.001,E=Math.abs(u-w.current)>.001,N=Math.abs(p-j.current)>.001;if((R||z)&&!E&&!N){const P=Math.max(1e-4,u),O=Math.max(1e-4,S.current)/P,X=(b.current-p)/P,W=c/O,H=f-X*W;r({[m]:W,[y]:H})}S.current=c,b.current=f,w.current=u,j.current=p},[c,f,u,p,m,y,r]);const L=(f-p)/u,_=L+c/u;return e.jsxs("div",{className:"flex flex-col gap-1",children:[e.jsx(Kn,{data:o,min:L,max:_,gamma:h,repeats:c,phase:f,gradientStops:g,labelTitle:"Range",labelLeft:"Min",labelMid:"Bias",labelRight:"Max",onChange:({min:R,max:z,gamma:E})=>{const N=z-R,P=Math.abs(N)<1e-4?1e-4:N,$=c/P,O=f-R*$,X={[m]:$,[y]:O,[k]:E};r(X)},autoUpdate:i,onToggleAuto:s,onRefresh:n}),e.jsx(Me,{label:"Repeats",value:c,min:.1,max:100,step:.1,onChange:R=>r({[x]:R}),trackId:`coloring.${x}`,liveValue:l==null?void 0:l[`coloring.${x}`]}),e.jsx(Me,{label:"Phase",value:f,min:-1,max:1,step:.01,onChange:R=>r({[C]:R}),trackId:`coloring.${C}`,liveValue:l==null?void 0:l[`coloring.${C}`]})]})},kf=({sliceState:a,actions:t})=>{const o=a,r=o.hybridComplex,[n,i]=v.useState(!1),s=t.setGeometry,l=c=>{c.stopPropagation(),le.emit("is_compiling","Optimizing Shader..."),setTimeout(()=>{s({hybridComplex:!0}),i(!1)},50)},d=c=>{c.preventDefault(),c.stopPropagation(),i(!0)};return e.jsxs("div",{className:"relative mt-2 pt-2 border-t border-white/5",children:[e.jsxs("div",{className:`transition-all duration-300 ${r?"":"opacity-30 blur-[0.5px] pointer-events-none grayscale"}`,children:[e.jsx("div",{className:"flex items-center gap-1 mb-1",children:e.jsx("span",{className:"text-[9px] font-bold text-gray-500 uppercase tracking-widest",children:"Advanced Mixing"})}),e.jsx(Me,{label:"Box Skip (Mod)",value:o.hybridSkip,min:1,max:8,step:1,onChange:c=>s({hybridSkip:c}),overrideInputText:Math.round(o.hybridSkip)<=1?"Consecutive":Math.round(o.hybridSkip)===2?"Every 2nd":`Every ${Math.round(o.hybridSkip)}th`,trackId:"geometry.hybridSkip"}),e.jsxs("div",{className:"grid grid-cols-2 gap-1 mt-1",children:[e.jsx(Ge,{label:"Protect Folds",value:o.hybridProtect,onChange:c=>s({hybridProtect:c})}),e.jsx(Ge,{label:"Swap Order",value:o.hybridSwap,onChange:c=>s({hybridSwap:c})})]})]}),!r&&!n&&e.jsx("div",{className:"absolute inset-0 cursor-pointer z-10 bg-gray-900/50 hover:bg-gray-800/40 transition-colors flex items-center justify-center group rounded",onClick:d,title:"Click to enable Advanced Hybrid Mode",children:e.jsx("div",{className:"text-gray-400 opacity-0 group-hover:opacity-100 transition-opacity transform scale-75",children:e.jsxs("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("rect",{x:"3",y:"11",width:"18",height:"11",rx:"2",ry:"2"}),e.jsx("path",{d:"M7 11V7a5 5 0 0 1 10 0v4"})]})})}),n&&e.jsxs("div",{className:"absolute top-[-20px] left-0 right-0 z-50 animate-pop-in",children:[e.jsxs("div",{className:"bg-black/95 border border-white/20 rounded-lg shadow-[0_10px_40px_rgba(0,0,0,0.9)] backdrop-blur-md overflow-hidden cursor-pointer hover:border-cyan-500/50 transition-colors",onClick:l,children:[e.jsxs("div",{className:"flex items-start justify-between p-2 border-b border-white/10 bg-white/5",children:[e.jsxs("div",{className:"flex items-center gap-2 text-gray-300",children:[e.jsx(Zt,{}),e.jsx("span",{className:"text-[10px] font-bold uppercase tracking-wider",children:"Advanced Shader"})]}),e.jsx("button",{onClick:c=>{c.stopPropagation(),i(!1)},className:"text-gray-500 hover:text-white -mt-0.5 -mr-0.5 p-1",children:e.jsx(Vt,{})})]}),e.jsxs("div",{className:"p-3",children:[e.jsxs("p",{className:"text-[10px] text-gray-400 leading-relaxed mb-3",children:["Enable Advanced Hybrid Integration?",e.jsx("br",{}),"This allows ",e.jsx("strong",{children:"alternating formulas"})," between Box Folds and the Main Fractal.",e.jsx("br",{}),e.jsx("br",{}),e.jsx("span",{className:"text-orange-300",children:"Compilation may take 30-60 seconds."})]}),e.jsx("div",{className:"flex items-center justify-center p-1.5 bg-white/5 rounded border border-white/10 text-cyan-400 text-[9px] font-bold uppercase tracking-widest group-hover:bg-cyan-900/30 group-hover:text-cyan-200 group-hover:border-cyan-500/30 transition-all",children:"Click to Load"})]})]}),e.jsx("div",{className:"fixed inset-0 z-[-1]",onClick:c=>{c.stopPropagation(),i(!1)}})]})]})},jf=({actions:a,targetMode:t,label:o,activeLabel:r,helpText:n,variant:i="primary"})=>{const s=Y(f=>f.interactionMode),{setInteractionMode:l}=a,d=s===t,c=()=>{l(d?"none":t)};return e.jsxs("div",{className:"flex flex-col mb-2 animate-fade-in",children:[d&&n&&e.jsx("div",{className:"mb-2 p-2 bg-green-900/30 border border-green-500/30 rounded text-[9px] text-green-200 animate-pulse text-center leading-tight",children:n}),e.jsx(gt,{onClick:c,label:d?r||"Cancel":o,variant:d?"success":i,fullWidth:!0}),e.jsx("div",{className:"h-px bg-white/10 my-2"})]})},Tf=({sliceState:a,actions:t})=>{const o=Y(p=>p.sceneHistogramData);Y(p=>p.sceneHistogramTrigger);const r=Y(p=>p.refreshSceneHistogram),n=Y(p=>p.liveModulations),{levelsMin:i,levelsMax:s,levelsGamma:l}=a,d=t.setColorGrading,c=(n==null?void 0:n["colorGrading.levelsMin"])??i,f=(n==null?void 0:n["colorGrading.levelsMax"])??s,u=(n==null?void 0:n["colorGrading.levelsGamma"])??l;return e.jsx("div",{className:"mt-2 pt-2 border-t border-white/5",children:e.jsx(Kn,{data:o,min:c??0,max:f??1,gamma:u??1,onChange:({min:p,max:h,gamma:g})=>{d({levelsMin:p,levelsMax:h,levelsGamma:g})},onRefresh:r,height:40,fixedRange:{min:0,max:1}})})},Pf=({sliceState:a,actions:t})=>{const{camFov:o,camType:r,dofStrength:n}=a,i=t.setOptics,s=Y(y=>y.interactionMode),l=Y(y=>y.setInteractionMode),d=s==="picking_focus",[c,f]=v.useState(!0),u=v.useRef(null),p=Math.abs((r??0)-0)<.1,h=()=>{B.lastMeasuredDistance>0&&i({dofFocus:B.lastMeasuredDistance})},g=()=>{if(!B.activeCamera)return;const y=Y.getState();let x=3.5;if(y.cameraMode==="Orbit"){const S=B.activeCamera.position.length();S>.001?x=S:x=y.targetDistance||3.5}else{const S=B.lastMeasuredDistance;S>1e-4&&S<900?x=S:x=y.targetDistance||3.5}x=Math.max(.001,x);const C=ot.getUnifiedFromEngine(),k=new ie(0,0,-1).applyQuaternion(B.activeCamera.quaternion);u.current={fov:o,dist:x,unifiedPos:{x:C.x,y:C.y,z:C.z},forward:k,quat:B.activeCamera.quaternion.clone()}},M=y=>{const x={camFov:y};if(c&&u.current){const{fov:L,dist:_,unifiedPos:R,forward:z,quat:E}=u.current,N=Ze.degToRad(L),P=Ze.degToRad(y),$=Math.tan(N/2)/Math.tan(P/2),O=_*$,X=_-O,W=z.clone().multiplyScalar(X);x.dofFocus=O;const H=new ie(R.x,R.y,R.z).add(W);ot.teleportPosition(H,{x:E.x,y:E.y,z:E.z,w:E.w},O),Y.setState({targetDistance:O})}i(x);const{isRecording:C,captureCameraFrame:k,addKeyframe:S,addTrack:b,currentFrame:w,sequence:j,isPlaying:T}=xe.getState();if(C){const L=T?"Linear":"Bezier";if(x.dofFocus!==void 0){const _="optics.dofFocus";j.tracks[_]||b(_,"Focus Distance"),S(_,w,x.dofFocus,L)}c&&k(w,!0,L)}},m=()=>{if(c){const{currentFrame:y,captureCameraFrame:x,isPlaying:C}=xe.getState();x(y,!0,C?"Linear":"Bezier")}};return e.jsxs("div",{className:"flex flex-col gap-2",children:[n>1e-6&&e.jsxs("div",{className:"grid grid-cols-2 gap-2 mb-2",children:[e.jsx(gt,{onClick:h,label:"Auto-Centre"}),e.jsx(gt,{active:d,onClick:()=>l(d?"none":"picking_focus"),label:d?"Picking...":"Pick Focus",variant:"success"})]}),p&&e.jsxs("div",{children:[e.jsx(Me,{label:"Field of View",value:o??60,min:10,max:150,step:1,onChange:M,onDragStart:g,overrideInputText:`${Math.round(o??60)}`,trackId:"optics.camFov",onKeyToggle:m}),e.jsx("div",{children:e.jsx(Ge,{label:"Dolly Link",icon:e.jsx(na,{active:c}),value:c,onChange:y=>f(y)})})]})]})},Rf=()=>{const a=Y(c=>c.cameraMode),t=Y(c=>c.sceneOffset),o=Y(c=>c.cameraPos),r=Y(c=>c.cameraRot),n=Y(c=>c.setCameraMode),i=Y(c=>c.optics),s=i&&Math.abs(i.camType-1)<.1,l=ot.getUnifiedPosition(o,t),d=ot.getRotationDegrees(r);return e.jsxs("div",{className:"flex flex-col gap-3",children:[e.jsxs("div",{className:s?"opacity-50 pointer-events-none":"",children:[e.jsx(Ge,{value:a,onChange:c=>n(c),options:[{label:"Orbit",value:"Orbit"},{label:"Fly",value:"Fly"}]}),s&&e.jsx("p",{className:"text-[9px] text-gray-500 mt-1 text-center",children:"Fly Mode disabled in Orthographic view"})]}),a==="Fly"&&e.jsx(Ce,{featureId:"navigation",groupFilter:"movement"}),e.jsx("div",{"data-help-id":"cam.position",children:e.jsx(za,{label:"Absolute Position",value:l,onChange:c=>ot.teleportPosition(c),step:.1,min:-1/0,max:1/0,interactionMode:"camera",trackKeys:["camera.unified.x","camera.unified.y","camera.unified.z"],trackLabels:["Position X","Position Y","Position Z"]})}),e.jsx("div",{"data-help-id":"cam.rotation",children:e.jsx(za,{label:"Rotation (Degrees)",value:d,onChange:ot.teleportRotation,step:1,min:-180,max:180,interactionMode:"camera",trackKeys:["camera.rotation.x","camera.rotation.y","camera.rotation.z"],trackLabels:["Rotation X","Rotation Y","Rotation Z"],convertRadToDeg:!0})})]})},zf=a=>{const t=Y(c=>c.histogramData),o=Y(c=>c.histogramAutoUpdate),r=Y(c=>c.setHistogramAutoUpdate),n=Y(c=>c.refreshHistogram),i=Y(c=>c.liveModulations),s=Y(c=>c.registerHistogram),l=Y(c=>c.unregisterHistogram);v.useEffect(()=>(s(),()=>l()),[s,l]);const d=c=>{const f=Y.getState().setColoring;f&&f(c)};return e.jsx(Cf,{layer:a.layer,state:a.sliceState,histogramData:t,onChange:d,onRefresh:n,autoUpdate:o,onToggleAuto:()=>r(!o),liveModulations:i})},Ff=a=>{const t=Y(r=>r.registerSceneHistogram),o=Y(r=>r.unregisterSceneHistogram);return v.useEffect(()=>(t(),()=>o()),[t,o]),e.jsx(Tf,{...a})},If=()=>{Ne.register("panel-drawing",Su),Ne.register("overlay-drawing",Mu),Ne.register("panel-audio",Ru),Ne.register("overlay-lighting",Xd),Ne.register("overlay-webcam",_u),Ne.register("overlay-debug-tools",Hu),Ne.register("panel-engine",Uu),Ne.register("panel-sonification",Xu),Ne.register("probe-sonification",Vu),Ne.register("panel-cameramanager",Qu),Ne.register("panel-formula",lf),Ne.register("panel-scene",df),Ne.register("panel-light",uf),Ne.register("panel-shading",pf),Ne.register("panel-gradients",Eu),Ne.register("panel-quality",hf),Ne.register("panel-graph",Mf),Ne.register("coloring-histogram",zf),Ne.register("hybrid-advanced-lock",kf),Ne.register("interaction-picker",jf),Ne.register("audio-spectrum",qn),Ne.register("audio-link-controls",Yn),Ne.register("scene-histogram",Ff),Ne.register("optics-controls",Pf),Ne.register("navigation-controls",Rf),console.log(" UI Registry: Components registered.")};if("serviceWorker"in navigator)try{navigator.serviceWorker.getRegistrations().then(a=>{for(let t of a)t.unregister().then(()=>console.log("SW Unregistered"))}).catch(()=>{})}catch{console.debug("SW cleanup skipped")}If();const Qn=document.getElementById("root");if(!Qn)throw new Error("Could not find root element to mount to");const Ef=ii.createRoot(Qn);Ef.render(e.jsx(At.StrictMode,{children:e.jsx(wu,{})}));
