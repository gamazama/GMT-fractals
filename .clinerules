# GMT Project - AI Development Context Rules

## ðŸš¨ MANDATORY: Read Documentation First

Before making ANY code changes to this project, you MUST:

1. **Read the Documentation Index**: Start with `docs/DOCS_INDEX.md`
2. **Read Relevant Architecture Docs**: Consult the specific documentation sections related to your task
3. **Check Existing Patterns**: Look for similar implementations in the codebase before creating new ones
4. **Update Documentation**: If you discover new patterns, quirks, or undocumented behavior while working, document them in the appropriate doc file

## ðŸ“š Documentation is the Single Source of Truth

The `docs/` folder contains comprehensive architecture documentation that MUST be used as the authoritative reference:

| File | Purpose |
|------|---------|
| `docs/DOCS_INDEX.md` | **START HERE** - Master index and quick reference |
| `docs/01_System_Architecture.md` | Engine-Bridge pattern, DDFS, render loop |
| `docs/02_Rendering_Internals.md` | Raymarching, precision math, path tracing |
| `docs/03_Modular_System.md` | Node graph to GLSL compilation |
| `docs/04_Animation_Engine.md` | Timeline, keyframes, interpolation |
| `docs/05_Data_and_Export.md` | Video export, GMF format, presets |
| `docs/06_Troubleshooting_and_Quirks.md` | Known issues, GLSL limits, browser quirks |
| `docs/07_Code_Health.md` | Technical debt, refactoring status |
| `docs/08_File_Structure.md` | Complete file map and responsibilities |

## Context Files for AI Sessions

These files provide condensed context for new AI sessions:
- `docs/context.md` - Architecture overview and key concepts
- `docs/context2.md` - Current state, DDFS status, and code health notes
- `README.md` - Project overview and quick start

## Key Architecture Concepts

### 1. The Hybrid Engine Pattern
- **React Layer**: UI, Zustand state, event-driven
- **Engine Layer**: WebGL, continuous 60Hz render loop
- **Bridge**: `FractalEvents` event bus for communication
- **Rule**: NEVER bind React state directly in `useFrame` - use the bridge pattern

### 2. Data-Driven Feature System (DDFS)
- Features are defined in `engine/FeatureSystem.ts` registry
- UI, state, and shaders are auto-generated from feature definitions
- **Rule**: Adding a feature usually requires editing only ONE file

### 3. State Management
- Zustand store with slices: `cameraSlice`, `uiSlice`, `rendererSlice`, `historySlice`
- Dynamic slices generated by `createFeatureSlice.ts`
- **Rule**: Use the store for state, emit events for engine updates

## Code Modification Guidelines

### Before Making Changes
1. Identify which system your change affects (UI, Engine, or Bridge)
2. Read the relevant documentation section
3. Check `docs/07_Code_Health.md` for known issues in that area
4. Look for existing patterns in similar features

### When Adding New Features
1. Define the feature in the DDFS registry first
2. Let the system auto-generate UI and state
3. Only create custom components if absolutely necessary
4. Document any new patterns in the appropriate doc file

### When Fixing Bugs
1. Check `docs/06_Troubleshooting_and_Quirks.md` for known issues
2. Document the fix if it reveals new patterns or quirks
3. Update code health status if it resolves technical debt

## Documentation Improvement Protocol (MANDATORY)

### When You MUST Update Documentation
You MUST update documentation when:
- You struggled to understand a code section â†’ document it for the next developer
- You discovered a pattern not documented â†’ add it to the relevant doc
- You fixed a bug that had non-obvious causes â†’ document the fix and root cause
- You added a new feature or system â†’ write comprehensive docs
- You refactored existing code â†’ update the architecture docs
- You found a quirk, workaround, or browser-specific issue â†’ add to `06_Troubleshooting_and_Quirks.md`

### How to Update Documentation
1. Identify the most relevant doc file in `docs/`
2. Add or update the section with clear explanations
3. Include code examples for complex patterns
4. Update `docs/DOCS_INDEX.md` if adding new major sections
5. Cross-reference related sections

### Documentation Style Guide
- Use clear, technical language
- Include file paths with backticks: `engine/FractalEngine.ts`
- Use code blocks for examples
- Add "Rule:" prefixes for important guidelines
- Include "Why:" explanations for non-obvious decisions

## Quick Reference: Critical Files

| File | Purpose | Read Before |
|------|---------|-------------|
| `engine/FractalEngine.ts` | Main render loop singleton | Any engine changes |
| `engine/FeatureSystem.ts` | DDFS feature definitions | Adding/modifying features |
| `store/fractalStore.ts` | Main Zustand store | State changes |
| `engine/ShaderFactory.ts` | GLSL assembly | Shader modifications |
| `engine/AnimationEngine.ts` | Timeline playback | Animation features |
| `components/AutoFeaturePanel.tsx` | Auto-generated UI | UI for new features |

## Forbidden Actions

- DO NOT bind React state directly in render loops
- DO NOT create new state slices manually - use DDFS
- DO NOT hardcode UI for features - use AutoFeaturePanel
- DO NOT skip reading docs before making changes
- DO NOT leave documentation outdated after changes

---

**Remember**: Good documentation prevents bugs. When in doubt, document it.

*Last updated: February 2026*
